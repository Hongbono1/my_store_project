<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>전통시장 상세</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-50">

    <!-- 헤더 -->
    <div id="header-container"></div>

    <!-- 메인 컨텐츠 -->
    <main class="max-w-3xl mx-auto bg-white rounded-2xl shadow-lg p-8 my-10">
        <div id="market-detail">
            <!-- JS로 채워집니다 -->
        </div>
    </main>

    <!-- 푸터 -->
    <div id="footer-container"></div>

    <script>
        // 1) 헤더/푸터 로드
        ['header', 'footer'].forEach(name => {
            fetch(`/components/${name}.html`)
                .then(res => res.text())
                .then(html => document.getElementById(`${name}-container`).innerHTML = html);
        });

        // 2) 질문목록 고정 배열(고정질문 모드에서 사용)
        const fixedQuestions = [
            '이 시장의 가장 오래된 가게는 어디인가요?',
            '특별히 추천하는 대표 먹거리나 특산물은?',
            '이 시장을 방문할 때 꼭 경험해야 할 맛집은 어디인가요?',
            '시장 내 숨겨진 명소나 포토존이 있나요?',
            '지역 주민들이 추천하는 장보기 팁은 무엇인가요?',
            '시장 주변의 역사적·문화적 이야기가 있나요?',
            '계절마다 달라지는 시장의 매력은 무엇인가요?',
            '미래에 시장에 추가되었으면 하는 시설이나 서비스가 있나요?'
        ];

        // 3) URL에서 id 파싱
        const params = new URLSearchParams(location.search);
        const marketId = params.get('id');
        if (!marketId) {
            document.getElementById('market-detail').innerHTML = '<p class="text-red-500">잘못된 접근입니다. ID가 없습니다.</p>';
            throw new Error('No id');
        }

        // 4) 데이터 fetch 및 렌더링
        fetch(`/api/market/${marketId}`)
            .then(res => res.json())
            .then(data => {
                if (!data) throw new Error('데이터 없음');

                const container = document.getElementById('market-detail');
                let html = `
          <!-- 대표 이미지 -->
          ${data.main_img ? `<img src="${data.main_img}" alt="대표 이미지" class="w-full h-64 object-cover rounded-lg mb-6">` : ''}

          <!-- 기본 정보 -->
          <h1 class="text-3xl font-bold text-indigo-700 mb-4">${data.market_name}</h1>
          <div class="space-y-2 text-gray-700">
            <p><strong>주소:</strong> ${data.address}</p>
            ${data.phone ? `<p><strong>전화번호:</strong> ${data.phone}</p>` : ''}
            <p><strong>운영시간:</strong> ${data.opening_hours}</p>
            <p><strong>주요 품목·특산물:</strong> ${data.main_products}</p>
            ${data.event_info ? `<p><strong>이벤트/축제:</strong> ${data.event_info}</p>` : ''}
            ${data.facilities ? `<p><strong>편의 시설:</strong> ${data.facilities}</p>` : ''}
            <p><strong>주차장:</strong> ${data.parking_available}</p>
          </div>
          <!-- 주차장 이미지 -->
          ${data.parking_img ? `<img src="${data.parking_img}" alt="주차장 사진" class="w-full mt-4 rounded-lg">` : ''}
          <!-- 대중교통 안내 -->
          ${data.transport_info ? `<p class="mt-4"><strong>대중교통 안내:</strong> ${data.transport_info}</p>` : ''}
          <!-- 약도 이미지 -->
          ${data.transport_img ? `<img src="${data.transport_img}" alt="대중교통 약도" class="w-full mt-2 rounded-lg">` : ''}

          <!-- Q&A 섹션 -->
          <section class="mt-8">
            <h2 class="text-2xl font-bold mb-4">질문 & 답변</h2>
        `;

                // 고정질문 모드
                if (data.qa_mode === 'fixed') {
                    fixedQuestions.forEach((q, i) => {
                        const ans = data[`q${i + 1}_answer`];
                        const img = data[`q${i + 1}_image_url`];
                        if (ans) {
                            html += `
                <div class="border rounded-lg bg-gray-50 p-4 mb-4">
                  <p class="font-semibold mb-2">Q${i + 1}. ${q}</p>
                  <p class="mb-2">${ans}</p>
                  ${img ? `<img src="${img}" alt="Q${i + 1} 이미지" class="w-full rounded-md">` : ''}
                </div>
              `;
                        }
                    });
                }
                // 자유질문 모드
                else if (data.qa_mode === 'custom' && Array.isArray(data.custom_qas)) {
                    data.custom_qas.forEach((item, idx) => {
                        html += `
              <div class="border rounded-lg bg-gray-50 p-4 mb-4">
                <p class="font-semibold mb-2">자유질문 ${idx + 1}. ${item.question}</p>
                <p class="mb-2">${item.answer}</p>
                ${item.image_url ? `<img src="${item.image_url}" alt="자유질문${idx + 1} 이미지" class="w-full rounded-md">` : ''}
              </div>
            `;
                    });
                } else {
                    html += `<p class="text-gray-500">작성된 질문/답변이 없습니다.</p>`;
                }

                html += `</section>`;

                // 운영자 한마디
                if (data.free_pr) {
                    html += `
            <section class="mt-8">
              <h2 class="text-2xl font-bold mb-2">운영자 한마디</h2>
              <p class="bg-gray-100 p-4 rounded-lg whitespace-pre-line">${data.free_pr}</p>
            </section>
          `;
                }

                container.innerHTML = html;
            })
            .catch(err => {
                console.error(err);
                document.getElementById('market-detail').innerHTML = '<p class="text-red-500">데이터를 불러오는 중 오류가 발생했습니다.</p>';
            });
    </script>

</body>

</html>