<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>스토어 · 업종별 전체 보기</title>

  <!-- Tailwind CSS -->
  <link rel="stylesheet" href="/assets/css/tailwind.css" />

  <style>
    .nav-links a { transition: color 0.3s ease; }
    footer p      { font-size: 0.875rem; }
  </style>
</head>

<body class="bg-gray-50">
  <!-- ───── 헤더 (JSP 인클루드) ───── -->
  <jsp:include page="components/header.html"/>

  <!-- ───── 모달 컨테이너 (동적 로드) ───── -->
  <div id="modal-container"></div>

  <!-- ───── 메인 ───── -->
  <main class="w-full max-w-screen-xl mx-auto px-4 sm:px-8 mt-10">

    <!-- 상단 타이틀 -->
    <section class="bg-gradient-to-r from-gray-800 to-blue-500 text-white p-6 rounded-lg shadow mb-12">
      <h1 class="text-4xl sm:text-5xl font-bold mb-2">업종별 스토어 한눈에 보기</h1>
      <p class="text-lg sm:text-xl">등록된 모든 업종을 한 번에 살펴보세요</p>
    </section>

    <!-- 업종 구분 스크롤 버튼 -->
    <section id="categoryBar" class="bg-white p-4 rounded-lg shadow border border-gray-300 mb-12"></section>

    <!-- 파워 광고 (최대 4개) -->
    <section id="powerAdsSection" class="bg-yellow-50 border-4 border-yellow-400 shadow-lg rounded-lg p-6 mb-16 hidden">
      <h2 class="text-2xl font-bold mb-4">파워 광고</h2>
      <div id="powerAdsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6"></div>
    </section>

    <!-- 업종별 섹션이 이곳에 동적으로 삽입 -->
    <div id="dynamicSections"></div>
  </main>

  <!-- ───── 푸터 (JSP 인클루드) ───── -->
  <jsp:include page="components/footer.html"/>

  <!-- ───── 모달 HTML/JS 동적 로드 ───── -->
  <script>
    fetch("modal/modal.html")
      .then(r => r.text())
      .then(html => {
        document.querySelector("#modal-container").innerHTML = html;
        const s = document.createElement("script");
        s.src = "modal/modal.js";
        document.body.appendChild(s);
      })
      .catch(err => console.error("modal 로드 실패:", err));
  </script>

  <!-- ───── 메인 스크립트 ───── -->
  <script>
    /* 1) 데이터 요청 ───────────────────── */
    async function fetchCategories() {
      const res = await fetch('/store-categories');          // [{ business_category: "한식" }, ...]
      if (!res.ok) throw new Error('업종 구분 조회 실패');
      return (await res.json()).map(c => c.business_category);
    }
    async function fetchStores() {
      const res = await fetch('/stores');                    // [{ id, businessName, business_category, thumbnailUrl, phone, powerAd, ...}]
      if (!res.ok) throw new Error('스토어 조회 실패');
      return await res.json();
    }

    /* 2) 유틸 ─────────────────────────── */
    const slug = str => 'cat-' + str.replace(/\s+/g,'').replace(/[^\w가-힣]/g,'');
    const createEl = (tag, cls, html='') => {
      const el = document.createElement(tag);
      if (cls) el.className = cls;
      el.innerHTML = html;
      return el;
    };

    /* 3) 카드 템플릿 ───────────────────── */
    function cardHTML(item, isPower) {
      return `
        ${isPower ? '<div class="absolute top-2 right-2 bg-red-500 text-white px-2 py-1 text-xs rounded">파워광고</div>' : ''}
        <img src="${item.thumbnailUrl}" alt="${item.businessName}" class="h-40 w-full object-cover rounded mb-4" />
        <h2 class="text-xl font-bold text-center mb-1">${item.businessName}</h2>
        <p class="text-gray-600 text-center mb-4">${item.phone || ''}</p>
        <a href="#" class="open-modal bg-blue-500 text-white py-1.5 px-4 rounded shadow hover:bg-blue-600 block mx-auto w-max">바로가기</a>
      `;
    }

    function makeCard(item, isPower=false) {
      const box = createEl('div',
        isPower
          ? 'relative bg-yellow-50 border-4 border-yellow-400 shadow-lg rounded-lg p-6 flex flex-col transform transition duration-300 hover:-translate-y-2 hover:shadow-2xl'
          : 'bg-white border-2 border-gray-300 shadow-lg rounded-lg p-6 flex flex-col transform transition duration-300 hover:-translate-y-2 hover:shadow-2xl'
      );
      box.dataset.title     = item.businessName;
      box.dataset.phone     = item.phone || '';
      box.dataset.img       = item.thumbnailUrl;
      box.dataset.category  = item.business_category;
      box.innerHTML = cardHTML(item, isPower);
      return box;
    }

    /* 4) 모달 연결 ─────────────────────── */
    function attachModalHandlers(root=document) {
      root.querySelectorAll('.open-modal').forEach(btn => {
        btn.addEventListener('click', e => {
          e.preventDefault();
          const card = btn.closest('.ad-card, .bg-white, .relative');
          if (!card) return;
          const data = {
            title: card.dataset.title,
            phone: card.dataset.phone,
            image: card.dataset.img,
            category: card.dataset.category
          };
          if (window.populateModal) {
            window.populateModal(data);
            document.getElementById('modalOverlay').classList.remove('hidden');
            document.getElementById('commonModal').classList.remove('hidden');
          }
        });
      });
    }

    /* 5) 초기화 ─────────────────────────── */
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        /* 5-1. 데이터 */
        const [categories, stores] = await Promise.all([fetchCategories(), fetchStores()]);

        /* 5-2. 카테고리 버튼 */
        const catBar = document.getElementById('categoryBar');
        const btnWrap = createEl('div', 'flex overflow-x-auto space-x-3 py-3');
        categories.forEach(cat => {
          const btn = createEl('button',
            'cat-btn bg-white text-[#2C3E50] font-medium px-5 py-2 text-lg rounded-full border border-[#748CAB] shadow-md hover:bg-[#7F9BBF] transition whitespace-nowrap',
            cat
          );
          btn.dataset.target = slug(cat);
          btnWrap.appendChild(btn);
        });
        catBar.appendChild(createEl('h2','text-2xl font-bold mb-6','업종 선택'));
        catBar.appendChild(btnWrap);

        /* 5-3. 동적 섹션 */
        const sectionWrap = document.getElementById('dynamicSections');
        categories.forEach(cat => {
          const sec = createEl('section','mb-16','');
          sec.id = slug(cat);
          sec.innerHTML = `
            <div class="flex items-center justify-between mb-6">
              <h2 class="text-2xl font-bold">${cat}</h2>
              <a href="#" class="home-link text-blue-500 hover:underline font-bold text-lg">🏠 맨위로</a>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6"></div>
          `;
          sectionWrap.appendChild(sec);
        });

        /* 5-4. 파워 광고 */
        const powerAds = stores.filter(s => s.powerAd);
        if (powerAds.length) {
          document.getElementById('powerAdsSection').classList.remove('hidden');
          const container = document.getElementById('powerAdsContainer');
          powerAds.slice(0,4).forEach(item => container.appendChild(makeCard(item,true)));
        }

        /* 5-5. 업종별 카드 채우기 */
        categories.forEach(cat => {
          const targetGrid = document.querySelector(`#${slug(cat)} .grid`);
          stores.filter(s => s.business_category === cat).forEach(item => {
            targetGrid.appendChild(makeCard(item,false));
          });
        });

        /* 5-6. 버튼 스크롤 / 홈 이동 */
        document.querySelectorAll('.cat-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            document.getElementById(btn.dataset.target)
                    .scrollIntoView({ behavior:'smooth' });
          });
        });
        document.querySelectorAll('.home-link').forEach(a => {
          a.addEventListener('click', e => {
            e.preventDefault();
            catBar.scrollIntoView({ behavior:'smooth' });
          });
        });

        /* 5-7. 모달 핸들러 연결 */
        attachModalHandlers(document);

      } catch (err) {
        console.error(err);
      }
    });
  </script>
</body>
</html>
