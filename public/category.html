<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>광고 홈페이지 - 식사</title>

  <!-- Tailwind v2 CDN -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />

  <style>
    /* ol 기본 번호 제거 (JS에서 직접 “1. 내용” 붙임) */
    #rankingList {
      list-style: none;
    }
  </style>
</head>

<body class="bg-gray-50">
  <!-- ───── 헤더 ───── -->
  <div id="header-placeholder"></div>

  <!-- 모달 자리표시 -->
  <div id="modal" class="hidden"></div>

  <!-- ───── 메인 ───── -->
  <main class="w-full max-w-screen-xl mx-auto px-4 sm:px-8 mt-8 mb-8 flex flex-col gap-8">

    <!-- ▣ 타이틀 + 북마크 -->
    <section>
      <div class="p-6 mb-6 text-center">
        <h1 class="text-4xl sm:text-5xl font-bold mb-2 text-gray-900">식사</h1>
        <p class="text-lg sm:text-xl text-gray-600">우리동네 식당 정보를 소개합니다</p>
      </div>

      <div class="bg-white p-4 rounded-lg shadow border border-gray-300">
        <div class="bg-blue-100 p-6 rounded-lg">
          <h2 class="text-2xl font-bold mb-6">북마크</h2>
          <div id="bookmarkContainer" class="flex flex-wrap gap-3 justify-start"></div>
        </div>
      </div>
    </section>

    <!-- ▣ 하단 콘텐츠 -->
    <div class="flex flex-col lg:flex-row gap-8 items-stretch">

      <!-- ▶ 좌측 광고 목록 -->
      <section class="flex-1 border-2 border-gray-300 rounded-lg p-6">
        <div id="emergencyAdsContainer" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
        </div>
        <div id="pagination" class="mt-6 flex justify-center gap-4"></div>
      </section>

      <!-- ▶ 우측 사이드바 -->
      <aside class="w-full lg:w-1/4 xl:w-1/5 flex flex-col gap-6 self-start">

        <!-- MVP -->
        <div class="bg-white shadow border border-gray-300 rounded-lg p-4">
          <h2 class="text-2xl font-extrabold text-yellow-500 mb-4 text-center">우리동네 인기명소</h2>
          <div id="mvpBox"
            class="relative bg-cover bg-center h-64 rounded-lg shadow-2xl cursor-pointer border-4 border-yellow-500"
            style="background-image:url('https://source.unsplash.com/random/1200x400/?luxury,architecture');">
            <div class="absolute inset-0 bg-gradient-to-b from-black via-transparent to-black opacity-60 rounded-lg">
            </div>
            <div class="absolute inset-0 flex items-center justify-center">
              <h2 id="mvpName" class="text-5xl font-extrabold text-white drop-shadow-2xl tracking-wider">VIP 병원</h2>
            </div>
          </div>
        </div>

        <!-- 검색어 -->
        <div class="bg-white shadow border border-gray-300 rounded-lg p-6" style="min-height:310px;">
          <h2 class="text-2xl font-bold mb-6 text-center">검색어</h2>
          <ol id="rankingList" class="pl-0 text-gray-700 space-y-3 text-2xl leading-snug"></ol>
        </div>

        <!-- 독립 광고 -->
        <div class="mt-auto space-y-6">
          <a href="https://example.com/ad1" target="_blank">
            <img src="https://source.unsplash.com/random/400x200/?advertisement" alt="광고"
              class="w-full h-64 object-cover rounded shadow" />
          </a>
          <a href="https://example.com/ad2" target="_blank">
            <img src="https://source.unsplash.com/random/400x200/?advertisement" alt="광고"
              class="w-full h-64 object-cover rounded shadow" />
          </a>
        </div>
      </aside>
    </div>
  </main>

  <!-- ───── 푸터 ───── -->
  <div id="footer-placeholder"></div>

  <!-- ───── 스크립트 ───── -->
  <script>
    // 헤더 fetch로 연결
    fetch('/components/header.html')
      .then(res => res.text())
      .then(data => {
        document.getElementById('header-placeholder').innerHTML = data;
      });

    // 푸터 fetch로 연결
    fetch('/components/footer.html')
      .then(res => res.text())
      .then(data => {
        document.getElementById('footer-placeholder').innerHTML = data;
      });

    /* 0. 카테고리 버튼 공통 클래스 */
    document.querySelectorAll('.category-btn').forEach(btn => {
      btn.classList.add(
        'px-4', 'py-2',
        'rounded-full', 'border', 'border-gray-300',
        'bg-white', 'text-gray-800',
        'hover:bg-blue-500', 'hover:text-white',
        'transition'
      );
    });

    /* 1. 설정 */
    const pageSize = 12;
    let current = 1;
    let adsData = [];

    /* 쿼리스트링에서 id 추출 */
    const rawId = new URLSearchParams(location.search).get('id');
    const categoryId = isNaN(Number(rawId))
      ? decodeURIComponent(rawId || '')
      : document.querySelector('section h1').textContent;

    /* 2. 서버에서 데이터 수신 */
    const API_BASE_URL = 'https://www.hongbono1.com';

    async function fetchMealStores() {
      const res = await fetch(
        `${API_BASE_URL}/category/${encodeURIComponent(categoryId)}/stores`
      );

      if (!res.ok) throw new Error('카테고리 데이터를 불러오지 못했습니다');

      const data = await res.json();
      return data.map(store => {
        const rawPath = store.image1 || '';
        const fileName = rawPath.startsWith('/uploads/') ? rawPath.slice('/uploads/'.length) : rawPath;
        const thumbnail = fileName ? `/uploads/${fileName}` : '/images/no-image.png';

        return {
          businessName: store.businessName,
          businessCategory: store.businessCategory || store.business_category || '',
          phone: store.phone || '전화번호 없음',
          thumbnailUrl: thumbnail,
          address: store.address || ''
        };
      });
    }

    /* 3. 카드 생성 */
    function createAdCard(ad) {
      /* 래퍼 */
      const wrap = document.createElement('div');
      wrap.className = 'ad-card group w-full flex flex-col gap-3 cursor-pointer';

      wrap.dataset.title = ad.businessName;
      wrap.dataset.phone = ad.phone;
      wrap.dataset.img = ad.thumbnailUrl;
      wrap.dataset.address = ad.address;
      wrap.dataset.category = ad.businessCategory;
      wrap.dataset.id = ad.id;

      /* 이미지 */
      const imgBox = document.createElement('div');
      imgBox.className = ` 
        relative rounded-xl overflow-hidden w-full h-60
        transform transition duration-300
        group-hover:scale-105 group-hover:-translate-y-2 group-hover:shadow-lg
        `.trim();
      const img = document.createElement('img');
      img.src = ad.thumbnailUrl;
      img.alt = ad.businessName;
      img.className = 'w-full h-full object-cover transition duration-300';
      imgBox.appendChild(img);

      /* 텍스트 */
      const txt = document.createElement('div');
      txt.className = 'flex flex-col items-center gap-1 mt-2 text-center';

      const cat = document.createElement('p');
      cat.className = 'text-sm font-semibold text-blue-600';
      cat.textContent = ad.businessCategory;

      const name = document.createElement('p');
      name.className = 'text-xl font-bold text-gray-900';
      name.textContent = ad.businessName;

      const phone = document.createElement('p');
      phone.className = 'text-lg text-gray-600';
      phone.textContent =
        (ad.phone || '').replace(/[^0-9]/g, '').replace(/(\d{3})(\d{3,4})(\d{4})/, '$1 $2 $3');

      txt.append(cat, name, phone);
      wrap.append(imgBox, txt);

      return wrap;
    }

    /* 4. 페이지 렌더 */
    function renderPage(page) {
      const box = document.getElementById('emergencyAdsContainer');
      box.innerHTML = '';
      const start = (page - 1) * pageSize;
      adsData.slice(start, start + pageSize).forEach(ad => box.appendChild(createAdCard(ad)));
    }

    /* 5. 페이지네이션 */
    function renderPagination() {
      const pag = document.getElementById('pagination');
      pag.innerHTML = '';
      const total = Math.ceil(adsData.length / pageSize);

      const btn = (txt, dis, fn, extra = '') => {
        const b = document.createElement('button');
        b.textContent = txt;
        b.disabled = dis;
        b.className = `
          px-3 py-1 rounded ${extra} ${dis ? 'bg-gray-200 opacity-40' : 'bg-gray-100 hover:bg-gray-200'}
        `.trim();
        b.onclick = fn;
        return b;
      };

      pag.append(btn('이전', current === 1, () => { current--; renderPage(current); renderPagination(); }));

      for (let i = 1; i <= total; i++) {
        pag.append(btn(i, false, () => { current = i; renderPage(i); renderPagination(); },
          i === current ? 'bg-blue-500 text-white font-bold' : ''));
      }

      pag.append(btn('다음', current === total, () => { current++; renderPage(current); renderPagination(); }));
    }

    /* 6. 모달 */
    function openModalWithCard(card) {
      if (!window.populateModal) return console.warn('populateModal 함수 없음');
      window.populateModal({
        title: card.dataset.title,
        phone: card.dataset.phone,
        image: card.dataset.img,
        address: card.dataset.address,
        category: card.dataset.category,
        sliderImages: [card.dataset.img]
      });
      document.getElementById('modal').classList.remove('hidden');
    }

    /* 7. 초기화 */
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        adsData = await fetchMealStores();
        renderPage(current);
        renderPagination();
      } catch (err) {
        console.error(err);
        document.getElementById('emergencyAdsContainer').innerHTML =
          '<p class="w-full text-center text-red-600">데이터를 불러오지 못했습니다.</p>';
      }

      document.getElementById('emergencyAdsContainer')
        .addEventListener('click', e => {
          const card = e.target.closest('.ad-card');
          if (card) openModalWithCard(card);
        });
    });
  </script>
</body>

</html>