<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>정보 입력</title>
    <!-- Tailwind CSS CDN (개발 중에는 괜찮지만, 프로덕션에서는 빌드된 CSS 사용 권장) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 다음 우편번호 검색 API -->
    <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <!-- 카카오 지도 API (YOUR_APP_KEY를 실제 키로 교체) -->
    <script
      type="text/javascript"
      src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=YOUR_APP_KEY&libraries=services"
    ></script>
  </head>

  <body class="bg-gray-200 flex flex-col min-h-screen">
    <div id="header-placeholder"></div>
    <!-- 메인 영역 -->
    <main class="flex-grow container mx-auto px-4 py-8">
      <div
        class="bg-white w-full max-w-4xl p-6 rounded-lg shadow-lg border-2 border-gray-300 mx-auto"
      >
        <!-- 제목 -->
        <div class="flex justify-center items-center mb-6">
          <h2 class="text-3xl font-bold text-gray-800">정보 입력</h2>
        </div>

        <!-- 입력 폼 -->
        <form id="businessForm" enctype="multipart/form-data" class="space-y-6">
          <!-- 기본 정보 -->
          <div class="border rounded p-4 bg-gray-50">
            <h2 class="text-xl font-semibold mb-4">기본 정보</h2>
            <div class="flex flex-col md:flex-row md:items-center mb-3">
              <label for="businessName" class="w-32 font-medium">상호</label>
              <input
                type="text"
                id="businessName"
                name="businessName"
                placeholder="ex) OO 식당, 카페 XX 등"
                class="flex-1 border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring focus:ring-blue-200"
              />
            </div>
            <div class="flex flex-col md:flex-row md:items-center mb-3">
              <label for="businessType" class="w-32 font-medium">업종</label>
              <input
                type="text"
                id="businessType"
                name="businessType"
                placeholder="ex) 음식점, 카페, 기타"
                class="flex-1 border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring focus:ring-blue-200"
              />
            </div>
            <div class="flex flex-col md:flex-row md:items-center mb-3">
              <label for="deliveryOption" class="w-32 font-medium"
                >배송/테이크아웃</label
              >
              <select
                id="deliveryOption"
                name="deliveryOption"
                class="mt-1 md:mt-0 flex-1 border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring focus:ring-blue-200"
              >
                <option value="가능">가능</option>
                <option value="불가능">불가능</option>
              </select>
            </div>
            <div class="flex flex-col md:flex-row md:items-center">
              <label for="businessHours" class="w-32 font-medium"
                >영업시간</label
              >
              <input
                type="text"
                id="businessHours"
                name="businessHours"
                placeholder="ex) 09:00 ~ 22:00"
                class="flex-1 border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring focus:ring-blue-200"
              />
            </div>
          </div>

          <!-- 서비스 내용 -->
          <div class="border rounded p-4 bg-gray-50">
            <h2 class="text-xl font-semibold mb-4">서비스 내용</h2>
            <textarea
              id="serviceDetails"
              name="serviceDetails"
              placeholder="서비스 관련 상세 설명, 메뉴, 예약 정보 등을 입력하세요."
              class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring focus:ring-blue-200"
              rows="4"
            ></textarea>
          </div>

          <!-- 고객 이벤트 -->
          <div class="border rounded p-4 bg-gray-50">
            <h2 class="text-xl font-semibold mb-4">고객 이벤트</h2>
            <div class="mb-3">
              <label for="event1" class="block font-medium mb-1"
                >이벤트 내용 1</label
              >
              <input
                type="text"
                id="event1"
                name="event1"
                placeholder="이벤트 내용 1"
                class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring focus:ring-blue-200"
              />
            </div>
            <div>
              <label for="event2" class="block font-medium mb-1"
                >이벤트 내용 2</label
              >
              <input
                type="text"
                id="event2"
                name="event2"
                placeholder="이벤트 내용 2"
                class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring focus:ring-blue-200"
              />
            </div>
          </div>

          <!-- 기타 정보 -->
          <div class="border rounded p-4 bg-gray-50">
            <h2 class="text-xl font-semibold mb-4">기타 정보</h2>
            <div class="flex flex-col md:flex-row md:items-center mb-3">
              <label for="facility" class="w-32 font-medium"
                >장애인 편의시설</label
              >
              <input
                type="text"
                id="facility"
                name="facility"
                placeholder="예: 있음 / 없음 / 간단 설명"
                class="flex-1 border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring focus:ring-blue-200"
              />
            </div>
            <div class="flex flex-col md:flex-row md:items-center mb-3">
              <label for="pets" class="w-32 font-medium">반려동물 출입</label>
              <input
                type="text"
                id="pets"
                name="pets"
                placeholder="예: 가능(소형견만) / 불가능 등"
                class="flex-1 border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring focus:ring-blue-200"
              />
            </div>
            <div class="flex flex-col md:flex-row md:items-center">
              <label for="parking" class="w-32 font-medium">주차정보</label>
              <input
                type="text"
                id="parking"
                name="parking"
                placeholder="예: 전용주차장 / 유료주차 / 불가능 등"
                class="flex-1 border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring focus:ring-blue-200"
              />
            </div>
          </div>

          <!-- 품목 입력 (최대 20개) -->
          <div class="border rounded p-4 bg-gray-50">
            <h2 class="text-xl font-semibold mb-4">품목 입력 (최대 20개)</h2>
            <div id="itemList" class="space-y-4"></div>
            <button
              type="button"
              class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded"
              onclick="addItem()"
            >
              +
            </button>
          </div>

          <!-- 연락처 -->
          <div class="border rounded p-4 bg-gray-50">
            <h2 class="text-xl font-semibold mb-4">연락처</h2>
            <div class="flex flex-col md:flex-row md:items-center mb-3">
              <label for="phoneNumber" class="w-32 font-medium">대표전화</label>
              <input
                type="text"
                id="phoneNumber"
                name="phoneNumber"
                placeholder="ex) 02-123-4567"
                class="flex-1 border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring focus:ring-blue-200"
              />
            </div>
            <div class="flex flex-col md:flex-row md:items-center mb-3">
              <label for="homepage" class="w-32 font-medium"
                >홈페이지/블로그</label
              >
              <input
                type="text"
                id="homepage"
                name="homepage"
                placeholder="URL을 입력하세요"
                class="flex-1 border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring focus:ring-blue-200"
              />
            </div>
            <!-- 인스타그램 주소 입력 -->
            <div class="flex flex-col md:flex-row md:items-center mb-3">
              <label for="instagram" class="w-32 font-medium">인스타그램</label>
              <input
                type="text"
                id="instagram"
                name="instagram"
                placeholder="인스타그램 URL"
                class="flex-1 border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring focus:ring-blue-200"
              />
            </div>
            <!-- 페이스북 주소 입력 -->
            <div class="flex flex-col md:flex-row md:items-center">
              <label for="facebook" class="w-32 font-medium">페이스북</label>
              <input
                type="text"
                id="facebook"
                name="facebook"
                placeholder="페이스북 URL"
                class="flex-1 border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring focus:ring-blue-200"
              />
            </div>
          </div>

          <!-- 추가 설명 -->
          <div class="border rounded p-4 bg-gray-50">
            <h2 class="text-xl font-semibold mb-4">추가 설명</h2>
            <textarea
              id="additionalDesc"
              name="additionalDesc"
              placeholder="추가 설명을 입력하세요."
              class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring focus:ring-blue-200"
              rows="4"
            ></textarea>
          </div>

          <!-- 이미지 등록 (최대 3장) : 가게 대표 이미지 -->
          <div class="border rounded p-4 bg-gray-50">
            <h2 class="text-xl font-semibold mb-4">이미지 등록 (최대 3장)</h2>
            <input
              type="file"
              id="imagesInput"
              name="images[]"
              accept="image/*"
              multiple
              class="block w-full mb-3 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:bg-blue-100 file:text-blue-700 hover:file:bg-blue-200"
            />
            <div id="imagesPreview" class="flex gap-3"></div>
          </div>

          <!-- 주소 입력 -->
          <div class="border rounded p-4 bg-gray-50">
            <h2 class="text-xl font-semibold mb-4">주소 입력</h2>
            <!-- 우편번호 및 주소 검색 버튼 -->
            <div class="flex flex-col md:flex-row md:items-center gap-2 mb-3">
              <label for="postalCode" class="w-32 font-medium">우편번호</label>
              <input
                type="text"
                id="postalCode"
                name="postalCode"
                placeholder="우편번호"
                readonly
                class="flex-1 border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring focus:ring-blue-200"
              />
              <button
                type="button"
                onclick="openDaumPostcode()"
                class="bg-blue-500 hover:bg-blue-600 text-white font-semibold px-4 py-2 rounded"
              >
                주소 찾기
              </button>
            </div>
            <!-- 도로명 주소 -->
            <div class="flex flex-col md:flex-row md:items-center gap-2 mb-3">
              <label for="roadAddress" class="w-32 font-medium"
                >도로명 주소</label
              >
              <input
                type="text"
                id="roadAddress"
                name="roadAddress"
                placeholder="도로명 주소"
                readonly
                class="flex-1 border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring focus:ring-blue-200"
              />
            </div>
            <!-- 상세 주소 -->
            <div class="flex flex-col md:flex-row md:items-center gap-2">
              <label for="detailAddress" class="w-32 font-medium"
                >상세 주소</label
              >
              <input
                type="text"
                id="detailAddress"
                name="detailAddress"
                placeholder="상세 주소를 입력하세요"
                class="flex-1 border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring focus:ring-blue-200"
              />
            </div>
            <!-- 지도 영역 -->
            <div
              id="map"
              class="mt-4 w-full h-64 border border-gray-300 rounded"
            ></div>
          </div>

          <!-- 제출 및 수정 버튼 -->
          <div class="text-center space-x-4">
            <!-- 입력 완료 버튼 -->
            <button
              type="submit"
              class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded"
            >
              입력 완료
            </button>
            <!-- 수정 버튼 -->
            <button
              type="button"
              class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded"
              onclick="updateData()"
            >
              수정
            </button>
          </div>
        </form>
      </div>
    </main>

    <div id="footer-placeholder"></div>

    <!-- 자바스크립트 -->
    <script>
      // 이미지 미리보기 (최대 3장)
      const imagesInput = document.getElementById("imagesInput");
      const imagesPreview = document.getElementById("imagesPreview");
      imagesInput.addEventListener("change", () => {
        imagesPreview.innerHTML = "";
        const files = Array.from(imagesInput.files).slice(0, 3);
        files.forEach((file) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            const img = document.createElement("img");
            img.src = e.target.result;
            img.className =
              "w-32 h-20 object-cover border border-gray-300 rounded";
            imagesPreview.appendChild(img);
          };
          reader.readAsDataURL(file);
        });
      });

      // 주소 검색 (다음 우편번호)
      function openDaumPostcode() {
        new daum.Postcode({
          oncomplete: function (data) {
            document.getElementById("postalCode").value = data.zonecode;
            document.getElementById("roadAddress").value = data.roadAddress;
            updateMap(data.roadAddress);
            document.getElementById("detailAddress").focus();
          },
        }).open({
          autoClose: true,
        });
      }

      // 지도 표시
      let map;
      let marker;
      function updateMap(address) {
        const mapContainer = document.getElementById("map");
        if (!map) {
          map = new kakao.maps.Map(mapContainer, {
            center: new kakao.maps.LatLng(37.5665, 126.978),
            level: 3,
          });
        }
        const geocoder = new kakao.maps.services.Geocoder();
        geocoder.addressSearch(address, function (result, status) {
          if (status === kakao.maps.services.Status.OK) {
            const coords = new kakao.maps.LatLng(result[0].y, result[0].x);
            map.setCenter(coords);
            if (marker) {
              marker.setPosition(coords);
            } else {
              marker = new kakao.maps.Marker({
                map: map,
                position: coords,
              });
            }
          }
        });
      }

      // 상세주소 입력 시 지도 갱신
      document
        .getElementById("detailAddress")
        .addEventListener("blur", function () {
          const baseAddr = document.getElementById("roadAddress").value.trim();
          const detailAddr = this.value.trim();
          if (baseAddr !== "" || detailAddr !== "") {
            updateMap(baseAddr + " " + detailAddr);
          }
        });

      // 가격 입력: 숫자, 콤마, 소수점 정리
      function formatCurrency(input) {
        let val = input.value;
        val = val.replace(/[^0-9.]/g, "");
        const parts = val.split(".");
        if (parts.length > 2) {
          val = parts[0] + "." + parts.slice(1).join("");
        }
        let intPart = parts[0] || "";
        let decPart = parts[1] || "";
        if (decPart.length > 2) {
          decPart = decPart.slice(0, 2);
        }
        if (!intPart) intPart = "0";
        intPart = intPart.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        input.value = decPart ? intPart + "." + decPart : intPart;
      }

      // 품목 추가
      let itemCount = 0;
      function addItem() {
        if (itemCount >= 20) {
          alert("최대 20개까지 입력할 수 있습니다.");
          return;
        }
        itemCount++;
        const itemList = document.getElementById("itemList");
        const itemDiv = document.createElement("div");
        itemDiv.className =
          "flex flex-col md:flex-row md:items-center gap-2 border p-2 rounded";
        const menuImageInput = document.createElement("input");
        menuImageInput.type = "file";
        menuImageInput.accept = "image/*";
        menuImageInput.name = "menuImage[]";
        menuImageInput.className =
          "border border-gray-300 rounded px-2 py-1";
        const nameInput = document.createElement("input");
        nameInput.type = "text";
        nameInput.placeholder = "품목 이름";
        nameInput.name = "menuName[]";
        nameInput.className =
          "flex-1 border border-gray-300 rounded px-2 py-1";
        const priceInput = document.createElement("input");
        priceInput.type = "text";
        priceInput.placeholder = "가격";
        priceInput.name = "menuPrice[]";
        priceInput.className =
          "w-32 border border-gray-300 rounded px-2 py-1";
        priceInput.setAttribute("oninput", "formatCurrency(this)");
        const removeBtn = document.createElement("button");
        removeBtn.type = "button";
        removeBtn.textContent = "삭제";
        removeBtn.className =
          "bg-red-500 hover:bg-red-600 text-white font-semibold px-3 py-1 rounded";
        removeBtn.onclick = function () {
          itemDiv.remove();
          itemCount--;
        };
        itemDiv.appendChild(menuImageInput);
        itemDiv.appendChild(nameInput);
        itemDiv.appendChild(priceInput);
        itemDiv.appendChild(removeBtn);
        itemList.appendChild(itemDiv);
      }

      // 헤더/푸터 삽입
      fetch("/components/header.html")
        .then((res) => res.text())
        .then((data) => {
          document.getElementById("header-placeholder").innerHTML = data;
        });
      fetch("/components/footer.html")
        .then((res) => res.text())
        .then((data) => {
          document.getElementById("footer-placeholder").innerHTML = data;
        });

      // ✅ 최종 submit 핸들러 (이것만 하나 있어야 함)
      const form = document.getElementById("businessForm");
      form.addEventListener("submit", async (event) => {
        event.preventDefault();

        try {
          const formData = new FormData(form);

          // 가격 정제: menuPrice[] 콤마 제거
          const priceInputs = form.querySelectorAll('input[name="menuPrice[]"]');
          priceInputs.forEach((input) => {
            const raw = input.value.replace(/,/g, "");
            formData.append("menuPrice[]", raw);
          });

          const response = await fetch("/store", {
            method: "POST",
            body: formData,
          });

          if (!response.ok) throw new Error("서버 응답 에러");

          const result = await response.json();
          console.log("서버 응답", result);
          alert("등록이 완료되었습니다!");
        } catch (error) {
          console.error("에러 발생:", error);
          alert("데이터 전송 중 에러가 발생했습니다!");
        }
      });
    </script>
  </body>
</html>
