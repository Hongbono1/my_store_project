<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ìŠ¤í† ì–´ Â· ì—…ì¢…ë³„ ì „ì²´ ë³´ê¸°</title>

  <!-- Tailwind CSS -->
  <link rel="stylesheet" href="/assets/css/tailwind.css" />

  <style>
    .nav-links a { transition: color 0.3s ease; }
    footer p      { font-size: 0.875rem; }
  </style>
</head>

<body class="bg-gray-50">
  <!-- â”€â”€â”€â”€â”€ í—¤ë” (JSP ì¸í´ë£¨ë“œ) â”€â”€â”€â”€â”€ -->
  <jsp:include page="components/header.html"/>

  <!-- â”€â”€â”€â”€â”€ ëª¨ë‹¬ ì»¨í…Œì´ë„ˆ (ë™ì  ë¡œë“œ) â”€â”€â”€â”€â”€ -->
  <div id="modal-container"></div>

  <!-- â”€â”€â”€â”€â”€ ë©”ì¸ â”€â”€â”€â”€â”€ -->
  <main class="w-full max-w-screen-xl mx-auto px-4 sm:px-8 mt-10">

    <!-- ìƒë‹¨ íƒ€ì´í‹€ -->
    <section class="bg-gradient-to-r from-gray-800 to-blue-500 text-white p-6 rounded-lg shadow mb-12">
      <h1 class="text-4xl sm:text-5xl font-bold mb-2">ì—…ì¢…ë³„ ìŠ¤í† ì–´ í•œëˆˆì— ë³´ê¸°</h1>
      <p class="text-lg sm:text-xl">ë“±ë¡ëœ ëª¨ë“  ì—…ì¢…ì„ í•œ ë²ˆì— ì‚´í´ë³´ì„¸ìš”</p>
    </section>

    <!-- ì—…ì¢… êµ¬ë¶„ ìŠ¤í¬ë¡¤ ë²„íŠ¼ -->
    <section id="categoryBar" class="bg-white p-4 rounded-lg shadow border border-gray-300 mb-12"></section>

    <!-- íŒŒì›Œ ê´‘ê³  (ìµœëŒ€ 4ê°œ) -->
    <section id="powerAdsSection" class="bg-yellow-50 border-4 border-yellow-400 shadow-lg rounded-lg p-6 mb-16 hidden">
      <h2 class="text-2xl font-bold mb-4">íŒŒì›Œ ê´‘ê³ </h2>
      <div id="powerAdsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6"></div>
    </section>

    <!-- ì—…ì¢…ë³„ ì„¹ì…˜ì´ ì´ê³³ì— ë™ì ìœ¼ë¡œ ì‚½ì… -->
    <div id="dynamicSections"></div>
  </main>

  <!-- â”€â”€â”€â”€â”€ í‘¸í„° (JSP ì¸í´ë£¨ë“œ) â”€â”€â”€â”€â”€ -->
  <jsp:include page="components/footer.html"/>

  <!-- â”€â”€â”€â”€â”€ ëª¨ë‹¬ HTML/JS ë™ì  ë¡œë“œ â”€â”€â”€â”€â”€ -->
  <script>
    fetch("modal/modal.html")
      .then(r => r.text())
      .then(html => {
        document.querySelector("#modal-container").innerHTML = html;
        const s = document.createElement("script");
        s.src = "modal/modal.js";
        document.body.appendChild(s);
      })
      .catch(err => console.error("modal ë¡œë“œ ì‹¤íŒ¨:", err));
  </script>

  <!-- â”€â”€â”€â”€â”€ ë©”ì¸ ìŠ¤í¬ë¦½íŠ¸ â”€â”€â”€â”€â”€ -->
  <script>
    /* 1) ë°ì´í„° ìš”ì²­ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    async function fetchCategories() {
      const res = await fetch('/store-categories');          // [{ business_category: "í•œì‹" }, ...]
      if (!res.ok) throw new Error('ì—…ì¢… êµ¬ë¶„ ì¡°íšŒ ì‹¤íŒ¨');
      return (await res.json()).map(c => c.business_category);
    }
    async function fetchStores() {
      const res = await fetch('/stores');                    // [{ id, businessName, business_category, thumbnailUrl, phone, powerAd, ...}]
      if (!res.ok) throw new Error('ìŠ¤í† ì–´ ì¡°íšŒ ì‹¤íŒ¨');
      return await res.json();
    }

    /* 2) ìœ í‹¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    const slug = str => 'cat-' + str.replace(/\s+/g,'').replace(/[^\wê°€-í£]/g,'');
    const createEl = (tag, cls, html='') => {
      const el = document.createElement(tag);
      if (cls) el.className = cls;
      el.innerHTML = html;
      return el;
    };

    /* 3) ì¹´ë“œ í…œí”Œë¦¿ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function cardHTML(item, isPower) {
      return `
        ${isPower ? '<div class="absolute top-2 right-2 bg-red-500 text-white px-2 py-1 text-xs rounded">íŒŒì›Œê´‘ê³ </div>' : ''}
        <img src="${item.thumbnailUrl}" alt="${item.businessName}" class="h-40 w-full object-cover rounded mb-4" />
        <h2 class="text-xl font-bold text-center mb-1">${item.businessName}</h2>
        <p class="text-gray-600 text-center mb-4">${item.phone || ''}</p>
        <a href="#" class="open-modal bg-blue-500 text-white py-1.5 px-4 rounded shadow hover:bg-blue-600 block mx-auto w-max">ë°”ë¡œê°€ê¸°</a>
      `;
    }

    function makeCard(item, isPower=false) {
      const box = createEl('div',
        isPower
          ? 'relative bg-yellow-50 border-4 border-yellow-400 shadow-lg rounded-lg p-6 flex flex-col transform transition duration-300 hover:-translate-y-2 hover:shadow-2xl'
          : 'bg-white border-2 border-gray-300 shadow-lg rounded-lg p-6 flex flex-col transform transition duration-300 hover:-translate-y-2 hover:shadow-2xl'
      );
      box.dataset.title     = item.businessName;
      box.dataset.phone     = item.phone || '';
      box.dataset.img       = item.thumbnailUrl;
      box.dataset.category  = item.business_category;
      box.innerHTML = cardHTML(item, isPower);
      return box;
    }

    /* 4) ëª¨ë‹¬ ì—°ê²° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function attachModalHandlers(root=document) {
      root.querySelectorAll('.open-modal').forEach(btn => {
        btn.addEventListener('click', e => {
          e.preventDefault();
          const card = btn.closest('.ad-card, .bg-white, .relative');
          if (!card) return;
          const data = {
            title: card.dataset.title,
            phone: card.dataset.phone,
            image: card.dataset.img,
            category: card.dataset.category
          };
          if (window.populateModal) {
            window.populateModal(data);
            document.getElementById('modalOverlay').classList.remove('hidden');
            document.getElementById('commonModal').classList.remove('hidden');
          }
        });
      });
    }

    /* 5) ì´ˆê¸°í™” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        /* 5-1. ë°ì´í„° */
        const [categories, stores] = await Promise.all([fetchCategories(), fetchStores()]);

        /* 5-2. ì¹´í…Œê³ ë¦¬ ë²„íŠ¼ */
        const catBar = document.getElementById('categoryBar');
        const btnWrap = createEl('div', 'flex overflow-x-auto space-x-3 py-3');
        categories.forEach(cat => {
          const btn = createEl('button',
            'cat-btn bg-white text-[#2C3E50] font-medium px-5 py-2 text-lg rounded-full border border-[#748CAB] shadow-md hover:bg-[#7F9BBF] transition whitespace-nowrap',
            cat
          );
          btn.dataset.target = slug(cat);
          btnWrap.appendChild(btn);
        });
        catBar.appendChild(createEl('h2','text-2xl font-bold mb-6','ì—…ì¢… ì„ íƒ'));
        catBar.appendChild(btnWrap);

        /* 5-3. ë™ì  ì„¹ì…˜ */
        const sectionWrap = document.getElementById('dynamicSections');
        categories.forEach(cat => {
          const sec = createEl('section','mb-16','');
          sec.id = slug(cat);
          sec.innerHTML = `
            <div class="flex items-center justify-between mb-6">
              <h2 class="text-2xl font-bold">${cat}</h2>
              <a href="#" class="home-link text-blue-500 hover:underline font-bold text-lg">ğŸ  ë§¨ìœ„ë¡œ</a>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6"></div>
          `;
          sectionWrap.appendChild(sec);
        });

        /* 5-4. íŒŒì›Œ ê´‘ê³  */
        const powerAds = stores.filter(s => s.powerAd);
        if (powerAds.length) {
          document.getElementById('powerAdsSection').classList.remove('hidden');
          const container = document.getElementById('powerAdsContainer');
          powerAds.slice(0,4).forEach(item => container.appendChild(makeCard(item,true)));
        }

        /* 5-5. ì—…ì¢…ë³„ ì¹´ë“œ ì±„ìš°ê¸° */
        categories.forEach(cat => {
          const targetGrid = document.querySelector(`#${slug(cat)} .grid`);
          stores.filter(s => s.business_category === cat).forEach(item => {
            targetGrid.appendChild(makeCard(item,false));
          });
        });

        /* 5-6. ë²„íŠ¼ ìŠ¤í¬ë¡¤ / í™ˆ ì´ë™ */
        document.querySelectorAll('.cat-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            document.getElementById(btn.dataset.target)
                    .scrollIntoView({ behavior:'smooth' });
          });
        });
        document.querySelectorAll('.home-link').forEach(a => {
          a.addEventListener('click', e => {
            e.preventDefault();
            catBar.scrollIntoView({ behavior:'smooth' });
          });
        });

        /* 5-7. ëª¨ë‹¬ í•¸ë“¤ëŸ¬ ì—°ê²° */
        attachModalHandlers(document);

      } catch (err) {
        console.error(err);
      }
    });
  </script>
</body>
</html>
