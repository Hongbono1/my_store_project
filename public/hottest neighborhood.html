<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>가장 핫한 우리동네(모달 연결)</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-50">
  <!-- Header (JSP 인클루드) -->
  <jsp:include page="components/header.html" />

  <!-- 모달 HTML (정적 인클루드) -->
  <jsp:include page="modal/modal.html" />

  <!-- 전체 컨테이너 -->
  <div class="max-w-screen-xl mx-auto px-4 sm:px-8 mt-10">
    <!-- 가장 핫한 우리동네 섹션 -->
    <section class="bg-white shadow-lg rounded-lg p-6 border-2 border-gray-300 mb-12">
      <h2 class="text-3xl font-bold mb-6 text-center text-gray-800">가장 핫한 우리동네</h2>
      <!-- 트윈테일 구조로 광고 박스 -->
      <div id="hotNeighborhoodBoxes" class="flex flex-col gap-6"></div>
    </section>

    <!-- 슬라이드 영역 (그대로) -->
    <section
      class="relative w-full max-w-screen-lg mx-auto overflow-hidden border border-gray-300 rounded-lg mt-8 px-4 mb-9">
      <div id="sliderContainer" class="flex transition-transform duration-500 h-48 items-center"></div>
      <button id="prevBtn"
        class="absolute left-4 top-1/2 transform -translate-y-1/2 bg-gray-700 text-white p-3 rounded-full hover:bg-gray-900 transition z-[9999]">
        &lt;
      </button>
      <button id="nextBtn"
        class="absolute right-4 top-1/2 transform -translate-y-1/2 bg-gray-700 text-white p-3 rounded-full hover:bg-gray-900 transition z-[9999]">
        &gt;
      </button>
    </section>

    <!-- 추천 가게 섹션 -->
    <section class="bg-white shadow-lg rounded-lg p-6 border-2 border-gray-300">
      <h2 class="text-3xl font-bold mb-6 text-center text-gray-800">추천 가게</h2>
      <div class="grid grid-cols-1 lg:grid-cols-5 gap-6 items-stretch">
        <!-- 좌측 만화 이미지 -->
        <div class="lg:col-span-1 flex flex-col gap-6 h-full">
          <div class="flex-1 overflow-hidden border-2 border-gray-300 rounded-lg shadow-lg">
            <img src="https://via.placeholder.com/300x400?text=만화1" alt="만화 이미지 상단"
              class="w-full h-full object-cover" />
          </div>
          <div class="flex-1 overflow-hidden border-2 border-gray-300 rounded-lg shadow-lg">
            <img src="https://via.placeholder.com/300x400?text=만화2" alt="만화 이미지 하단"
              class="w-full h-full object-cover" />
          </div>
        </div>
        <!-- 우측 광고 트윈테일 -->
        <div id="recommendedStoreContainer" class="lg:col-span-4 flex flex-col gap-6"></div>
      </div>
    </section>
  </div>

  <!-- Footer (JSP 인클루드) -->
  <jsp:include page="components/footer.html" />

  <!-- 모달 JS (정적 포함) -->
  <script src="modal/modal.js"></script>

  <script>
    /* ────────── 광고 카드 ────────── */
    function makeCard(ad) {
      const c = document.createElement("div");
      c.className =
        "bg-white border-2 border-gray-300 rounded-lg p-6 flex flex-col items-center text-center shadow transition hover:shadow-lg flex-1";
      if (ad) {
        c.innerHTML = `
      <img src="${ad.thumb || ad.img || ''}" alt="${ad.businessName || ad.title || ''}"
           class="h-28 w-full object-cover rounded mb-3 cursor-pointer">
      <h3 class="font-semibold mb-1">${ad.businessName || ad.title || '제목없음'}</h3>
      <p class="text-sm text-gray-500 mb-4">${ad.phone ?? ad?.phone ?? ""}</p>
      <button class="mt-auto bg-blue-500 text-white py-1.5 w-full rounded hover:bg-blue-600">
        바로가기
      </button>`;
        c.querySelectorAll("img,button,h3").forEach(el =>
          el.addEventListener("click",
            () => window.location.href = `/detail.html?id=${ad.id ?? ''}`));
      } else {
        // 빈 자리 플레이스홀더
        c.innerHTML = `
      <div class="h-28 w-full bg-gray-100 rounded mb-3 animate-pulse"></div>
      <h3 class="font-semibold text-gray-400 mb-1">정보 없음</h3>`;
      }
      return c;
    }

    /* ────────── 트윈테일(2개씩 묶는) 렌더링 ────────── */
    function renderTwinTailBoxes(rootId, ads, itemsPerBox = 2, totalBoxes = 4) {
      const root = document.getElementById(rootId);
      root.innerHTML = "";

      // 총 필요한 카드 수 (부족하면 placeholder)
      const needCards = itemsPerBox * totalBoxes;
      // 실제 카드 배열에 부족한만큼 null로 채움
      const cards = [...ads];
      while (cards.length < needCards) cards.push(null);

      // 2개씩 그룹핑 → 큰 박스(div)로 감싼다
      for (let i = 0; i < needCards; i += itemsPerBox) {
        const box = document.createElement("div");
        box.className = "bg-gray-50 border-2 border-gray-300 rounded-lg p-4 flex flex-col md:flex-row gap-4";
        for (let j = i; j < i + itemsPerBox; j++) {
          box.appendChild(makeCard(cards[j]));
        }
        root.appendChild(box);
      }
    }

    /* ────────── 안전 fetch ────────── */
    const safeFetch = async url => {
      try { const r = await fetch(url); if (r.ok) return r.json(); }
      catch (e) { console.error(url, e); }
      return [];
    };

    /* ────────── 페이지 로드 ────────── */
    document.addEventListener("DOMContentLoaded", async () => {
      // 1) 가장 핫한 우리동네 트윈테일
      renderTwinTailBoxes("hotNeighborhoodBoxes", await safeFetch("/hot/api"));

      // 2) 추천 가게 트윈테일 (이미지 제외 오른쪽에만)
      renderTwinTailBoxes("recommendedStoreContainer", await safeFetch("/recommend/api"));

      // 3) 슬라이더 & 모달
      initSlider?.();
      bindModal?.();
    });
  </script>
</body>
</html>
