<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>상세 페이지</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- 다음 우편번호 API (나중에 연동 예정) -->
  <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js" defer></script>
  <!-- 카카오 지도 API (실제 앱 키로 교체 필요) -->
  <script
    src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=6286d4d9bc1d503495b03f46622b5dc8&libraries=services"
    defer
  ></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">
  <div id="header-placeholder"></div>

  <!-- 메인 -->
  <main class="container mx-auto px-4 py-8 flex-1">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 h-full items-stretch">
      <!-- 왼쪽 섹션 -->
      <section class="bg-white p-6 rounded shadow flex flex-col gap-6 h-full">
        <!-- 이미지 슬라이더 -->
        <div class="relative">
          <img id="sliderImage" alt="가게 이미지" class="w-full h-64 object-cover rounded shadow mb-2" />
          <button
            id="prevBtn"
            class="absolute left-2 top-1/2 -translate-y-1/2 bg-black bg-opacity-50 text-white rounded px-3 py-1"
          >
            이전
          </button>
          <button
            id="nextBtn"
            class="absolute right-2 top-1/2 -translate-y-1/2 bg-black bg-opacity-50 text-white rounded px-3 py-1"
          >
            다음
          </button>
        </div>

        <!-- 지도 영역 -->
        <div class="bg-gray-200 border border-gray-400 rounded-lg p-4">
          <h2 class="text-lg font-semibold mb-2">가게 위치</h2>
          <p id="addressText" class="text-sm text-gray-700 mb-2">주소 없음</p>
          <div id="map" class="w-full h-40 bg-gray-300 flex items-center justify-center text-gray-700">
            지도 로드 중...
          </div>
          <button id="openKakaoBtn" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition">
            카카오맵으로 보기
          </button>
        </div>

        <!-- 메뉴 박스 -->
        <div
          id="menuBox"
          class="bg-gray-50 border border-gray-300 rounded p-4 overflow-hidden transition-all duration-300 max-h-[13rem] hover:max-h-[2000px]"
        >
          <h2 class="text-lg font-bold mb-4">메뉴</h2>
          <ul id="menuList" class="space-y-2"></ul>
        </div>
      </section>

      <!-- 오른쪽 섹션 -->
      <section class="bg-white p-6 rounded shadow flex flex-col gap-4 h-full">
        <h2 id="businessNameHeader" class="text-3xl font-bold text-gray-800 border-b pb-3">상호명</h2>
        <div>
          <p id="businessType" class="text-lg"><strong>업종:</strong></p>
          <p id="deliveryOption" class="text-lg"><strong>배달:</strong></p>
          <p id="businessHours" class="text-lg"><strong>영업시간:</strong></p>
        </div>
        <div class="bg-gray-50 p-4 rounded border">
          <h3 class="text-xl font-bold mb-2">서비스 내용</h3>
          <p id="serviceDetails" class="text-gray-700"></p>
        </div>
        <div class="bg-gray-50 p-4 rounded border">
          <h3 class="text-xl font-bold mb-2">이벤트</h3>
          <ul id="eventsList" class="list-disc pl-6 space-y-1"></ul>
        </div>
        <div class="bg-gray-50 p-4 rounded border">
          <h3 class="text-xl font-bold mb-2">추가 정보</h3>
          <ul id="additionalInfoList" class="list-disc pl-6 space-y-1"></ul>
        </div>
        <div class="bg-gray-50 p-4 rounded border">
          <h3 class="text-xl font-bold mb-2">연락처</h3>
          <p id="contactPhone"></p>
          <p id="contactHomepage"></p>
        </div>
        <div class="bg-gray-50 p-4 rounded border">
          <h3 class="text-xl font-bold mb-2">추가 설명</h3>
          <p id="additionalDesc" class="text-gray-700"></p>
        </div>
        <div id="cartBox" class="bg-gray-50 p-4 rounded border hidden">
          <h3 class="text-xl font-bold mb-2">🛒 장바구니</h3>
          <ul id="cartList" class="space-y-2"></ul>
          <div class="border-t mt-3 pt-3 text-right">
            <p class="font-semibold">총합: <span id="totalPrice">0</span>원</p>
            <button
              id="checkoutBtn"
              class="mt-2 w-full bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded"
            >
              결제하기
            </button>
          </div>
        </div>
      </section>
    </div>
  </main>

  <div id="footer-placeholder"></div>

  <script>
    window.addEventListener("DOMContentLoaded", () => {
      // 헤더/푸터 로딩
      fetch("https://www.hongbono1.com/components/header.html")
        .then((res) => res.text())
        .then((html) => {
          document.getElementById("header-placeholder").innerHTML = html;
        });

      fetch("https://www.hongbono1.com/components/footer.html")
        .then((res) => res.text())
        .then((html) => {
          document.getElementById("footer-placeholder").innerHTML = html;
        });

      // 공통 변수
      let images = [];
      let currentIndex = 0;
      let cart = [];

      const sliderImage = document.getElementById("sliderImage");
      const prevBtn = document.getElementById("prevBtn");
      const nextBtn = document.getElementById("nextBtn");
      const openKakaoBtn = document.getElementById("openKakaoBtn");

      // 슬라이더 버튼
      prevBtn.addEventListener("click", () => {
        currentIndex = (currentIndex - 1 + images.length) % images.length;
        sliderImage.src = images[currentIndex];
      });
      nextBtn.addEventListener("click", () => {
        currentIndex = (currentIndex + 1) % images.length;
        sliderImage.src = images[currentIndex];
      });

      // 카카오맵 새 창
      openKakaoBtn.addEventListener("click", () => {
        const addr = document.getElementById("addressText").textContent || "";
        window.open(`https://map.kakao.com/?q=${encodeURIComponent(addr)}`, "_blank");
      });

      // 데이터 로드
      const params = new URLSearchParams(window.location.search);
      const id = params.get("id") || 1;
      const baseUrl = "https://www.hongbono1.com";

      fetch(`${baseUrl}/store/${id}`)
        .then((res) => res.json())
        .then(({ store, menu }) => {
          if (!store) {
            alert("가게 정보를 불러오지 못했습니다.");
            return;
          }

          // 1) 가게 정보 렌더링
          document.getElementById("businessNameHeader").textContent =
            store.businessName || "";
          document.getElementById("businessType").innerHTML = `<strong>업종:</strong> ${
            store.businessType || ""
          }`;
          document.getElementById("deliveryOption").innerHTML = `<strong>배달:</strong> ${
            store.deliveryOption || ""
          }`;
          document.getElementById("businessHours").innerHTML = `<strong>영업시간:</strong> ${
            store.businessHours || ""
          }`;
          document.getElementById("serviceDetails").textContent =
            store.serviceDetails || "";
          document.getElementById("additionalDesc").textContent =
            store.additionalDesc || "";
          document.getElementById("contactPhone").textContent = store.phone || "";
          document.getElementById("contactHomepage").textContent =
            store.homepage || "";
          document.getElementById("addressText").textContent = store.address || "";

          // 지도 렌더링
          kakao.maps.load(() => {
            const container = document.getElementById("map");
            const map = new kakao.maps.Map(container, {
              center: new kakao.maps.LatLng(37.5665, 126.978),
              level: 3,
            });
            const geocoder = new kakao.maps.services.Geocoder();
            geocoder.addressSearch(store.address, (result, status) => {
              if (status === kakao.maps.services.Status.OK) {
                const coords = new kakao.maps.LatLng(result[0].y, result[0].x);
                new kakao.maps.Marker({ map, position: coords });
                map.setCenter(coords);
              }
            });
          });

          // 2) 이미지 세팅
          images =
            Array.isArray(store.images) && store.images.length
              ? store.images.map((src) =>
                  src.startsWith("http") ? src : `${baseUrl}${src}`
                )
              : ["https://via.placeholder.com/600x400?text=NO+IMAGE"];
          currentIndex = 0;
          sliderImage.src = images[currentIndex];

          // 3) 메뉴 렌더링
          const menuList = document.getElementById("menuList");
          menuList.innerHTML = "";
          if (!Array.isArray(menu) || !menu.length) {
            menuList.innerHTML = "<li>메뉴가 없습니다.</li>";
          } else {
            const byCat = {};
            menu.forEach((m) => {
              const cat = m.category || "기타";
              (byCat[cat] = byCat[cat] || []).push(m);
            });
            Object.entries(byCat).forEach(([cat, items]) => {
              const h = document.createElement("li");
              h.className = "font-bold text-blue-600 pt-4";
              h.textContent = cat;
              menuList.appendChild(h);
              items.forEach((item) => {
                const li = document.createElement("li");
                li.className = "relative group flex items-center gap-3 border-b pb-2 cursor-pointer";
                li.dataset.name = item.menuName;
                li.dataset.price = item.menuPrice;
                li.innerHTML = `
                  <img src="${item.menuImageUrl ||
                    "https://via.placeholder.com/80?text=NOIMAGE"}"
                       alt="${item.menuName}"
                       class="w-16 h-16 object-cover rounded border">
                  <span class="font-semibold text-gray-800">${item.menuName}</span>
                  <span class="ml-auto text-gray-600">${Number(item.menuPrice).toLocaleString()}원</span>
                `;
                li.addEventListener("click", () => {
                  const found = cart.find((c) => c.name === item.menuName);
                  if (found) found.quantity++;
                  else cart.push({ name: item.menuName, price: +item.menuPrice, quantity: 1 });
                  updateCart();
                });
                menuList.appendChild(li);
              });
            });
          }

          function updateCart() {
            const cartBox = document.getElementById("cartBox");
            const cartListEl = document.getElementById("cartList");
            const totalEl = document.getElementById("totalPrice");
            cartListEl.innerHTML = "";
            let total = 0;
            cart.forEach((c, i) => {
              total += c.price * c.quantity;
              const div = document.createElement("div");
              div.className = "flex items-center justify-between border-b pb-2";
              div.innerHTML = `
                <div>
                  <span class="font-semibold">${c.name}</span>
                  <span class="ml-2 text-gray-600">${c.price.toLocaleString()}원</span>
                </div>
                <div class="flex items-center">
                  <button data-idx="${i}" data-op="-" class="border px-2">-</button>
                  <span class="mx-2">${c.quantity}</span>
                  <button data-idx="${i}" data-op="+" class="border px-2">+</button>
                  <button data-idx="${i}" data-op="del" class="border px-2 ml-2 text-red-500">삭제</button>
                </div>
              `;
              cartListEl.appendChild(div);
            });
            cartListEl.querySelectorAll("button").forEach((btn) => {
              btn.addEventListener("click", () => {
                const i = +btn.dataset.idx, op = btn.dataset.op;
                if (op === "+") cart[i].quantity++;
                else if (op === "-") {
                  cart[i].quantity--;
                  if (cart[i].quantity < 1) cart.splice(i, 1);
                } else cart.splice(i, 1);
                updateCart();
              });
            });
            totalEl.textContent = total.toLocaleString();
            cartBox.classList.toggle("hidden", cart.length === 0);
          }

          document.getElementById("checkoutBtn").addEventListener("click", () => {
            if (!cart.length) return alert("장바구니가 비어 있습니다.");
            alert(`총 ${document.getElementById("totalPrice").textContent}원 결제 진행`);
          });
        })
        .catch((err) => {
          console.error("데이터 로딩 실패", err);
          alert("서버에서 데이터를 가져오는 데 실패했습니다.");
        });
    });
  </script>
</body>
</html>
