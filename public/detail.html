<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>상세 페이지</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- 다음 우편번호 API (나중에 연동 예정) -->
  <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js" defer></script>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col">
  <div id="header-placeholder"></div>

  <!-- ───────── 메인 ───────── -->
  <main class="container mx-auto px-4 py-8 flex-1">
    <div class="flex flex-col lg:flex-row gap-8 h-full">
      <!-- 왼쪽 섹션 -->
      <section class="bg-white p-6 rounded shadow flex flex-col gap-6 w-full lg:w-1/2">
        <!-- 이미지 슬라이더 -->
        <div class="relative">
          <img id="sliderImage" alt="가게 이미지"
               class="w-full h-64 object-cover rounded shadow mb-2" />

          <!-- ★ 변경: 다운로드 버튼 -->
          <a id="downloadLink" download
             class="absolute right-2 bottom-2 bg-black/50 text-white rounded px-3 py-1 text-sm">
            다운로드
          </a>

          <button id="prevBtn"
                  class="absolute left-2 top-1/2 -translate-y-1/2 bg-black/50 text-white rounded px-3 py-1">
            이전
          </button>
          <button id="nextBtn"
                  class="absolute right-2 top-1/2 -translate-y-1/2 bg-black/50 text-white rounded px-3 py-1">
            다음
          </button>
        </div>

        <!-- ★ 변경: 썸네일 바 -->
        <div id="thumbBar" class="flex gap-2 overflow-x-auto mt-2"></div>

        <!-- 지도 영역 -->
        <div class="bg-gray-200 border border-gray-400 rounded-lg p-4">
          <h2 class="text-lg font-semibold mb-2">가게 위치</h2>
          <p id="addressText" class="text-sm text-gray-700 mb-2">주소 없음</p>
          <div id="map" class="w-full h-40 bg-gray-300 flex items-center justify-center text-gray-700">
            지도 로드 중...
          </div>
        </div>

        <!-- 메뉴 박스 -->
        <div id="menuBox"
             class="bg-gray-50 border border-gray-300 rounded p-4 overflow-hidden transition-all duration-300 max-h-[13rem] hover:max-h-[2000px]">
          <h2 class="text-lg font-bold mb-4">메뉴</h2>
          <ul id="menuList" class="space-y-2"></ul>
        </div>
      </section>

      <!-- 오른쪽 섹션 (생략: 이전과 동일) -->
      <section class="bg-white p-6 rounded shadow flex flex-col gap-4 w-full lg:w-1/2">
        <!-- … (기존 내용 동일) … -->
        <h2 id="businessNameHeader" class="text-3xl font-bold text-gray-800 border-b pb-3">상호명</h2>
        <div>
          <p id="businessType"    class="text-lg"><strong>업종:</strong></p>
          <p id="deliveryOption"  class="text-lg"><strong>배달:</strong></p>
          <p id="businessHours"   class="text-lg"><strong>영업시간:</strong></p>
        </div>
        <div class="bg-gray-50 p-4 rounded border">
          <h3 class="text-xl font-bold mb-2">서비스 내용</h3>
          <p id="serviceDetails" class="text-gray-700"></p>
        </div>
        <!-- … (이하 생략, 기존과 동일) … -->
      </section>
    </div>
  </main>

  <div id="footer-placeholder"></div>

  <!-- ───────── JS ───────── -->
  <script>
    window.addEventListener("DOMContentLoaded", () => {
      let store;
      const params = new URLSearchParams(window.location.search);
      const id = params.get("id") || 1;

      fetch(`https://www.hongbono1.com/store/${id}`)
        .then(res => {
          if (!res.ok) throw new Error("가게 정보를 찾을 수 없습니다.");
          return res.json();
        })
        .then(data => {
          store = data.store;

          /* ---------- 이미지 슬라이더 (무제한 지원) ---------- */
          const images = (Array.isArray(store.images) && store.images.length)
            ? store.images
            : ["https://via.placeholder.com/600x400?text=NO+IMAGE"];

          const sliderImage = document.getElementById("sliderImage");
          const prevBtn      = document.getElementById("prevBtn");
          const nextBtn      = document.getElementById("nextBtn");
          const downloadLink = document.getElementById("downloadLink");
          const thumbBar     = document.getElementById("thumbBar");

          let currentIndex   = 0;

          // ★ 변경: 썸네일 생성
          images.forEach((src, idx) => {
            const thumb = document.createElement("img");
            thumb.src = src;
            thumb.className =
              "h-14 w-20 object-cover rounded cursor-pointer opacity-80 hover:opacity-100";
            thumb.addEventListener("click", () => {
              currentIndex = idx;
              showImage(currentIndex);
            });
            thumbBar.appendChild(thumb);
          });

          function showImage(idx) {
            sliderImage.src = images[idx];
            downloadLink.href = images[idx];               // ★ 변경: 다운로드 링크 갱신
          }

          prevBtn.addEventListener("click", () => {
            currentIndex = (currentIndex - 1 + images.length) % images.length;
            showImage(currentIndex);
          });

          nextBtn.addEventListener("click", () => {
            currentIndex = (currentIndex + 1) % images.length;
            showImage(currentIndex);
          });

          showImage(currentIndex);

          /* ---------- (나머지 텍스트, 지도 바인딩 코드는 기존과 동일) ---------- */
          document.getElementById("businessNameHeader").textContent = store.businessName;
          document.getElementById("businessType").innerHTML   = `<strong>업종:</strong> ${store.businessType}`;
          document.getElementById("deliveryOption").innerHTML = `<strong>배달:</strong> ${store.deliveryOption}`;
          document.getElementById("businessHours").innerHTML  = `<strong>영업시간:</strong> ${store.businessHours}`;
          document.getElementById("serviceDetails").textContent = store.serviceDetails;
          document.getElementById("addressText").textContent     = store.address;

          /* ---------- 지도 SDK 로딩 ---------- */
          loadKakaoMapSDK().then(initMap).catch(err => {
            console.error("Kakao 지도 SDK 로드 실패:", err);
            document.getElementById("map").textContent = "지도를 불러오지 못했습니다.";
          });
        })
        .catch(err => {
          console.error("데이터 로딩 오류:", err);
          document.getElementById("sliderImage").src =
            "https://via.placeholder.com/600x400?text=NO+IMAGE";
        });

      /* ---------- Kakao 지도 SDK 유틸 ---------- */
      function loadKakaoMapSDK() {
        return fetch("/config/kakao")
          .then(res => res.json())
          .then(({ key }) => new Promise((resolve, reject) => {
            if (!key) return reject("KAKAO_MAP_KEY 없음");
            const script = document.createElement("script");
            script.src =
              `https://dapi.kakao.com/v2/maps/sdk.js?appkey=${key}&autoload=false&libraries=services`;
            script.onload  = resolve;
            script.onerror = () => reject("SDK 로드 에러");
            document.head.appendChild(script);
          }));
      }

      function initMap() {
        if (!window.kakao || !store) return;
        kakao.maps.load(() => {
          const geocoder = new kakao.maps.services.Geocoder();
          geocoder.addressSearch(store.address, (result, status) => {
            if (status !== kakao.maps.services.Status.OK || !result[0]) {
              document.getElementById("map").textContent = "좌표를 찾을 수 없습니다.";
              return;
            }
            const coords = new kakao.maps.LatLng(result[0].y, result[0].x);
            const map = new kakao.maps.Map(document.getElementById("map"), {
              center: coords, level: 3
            });
            new kakao.maps.Marker({ map, position: coords });
          });
        });
      }
    });
  </script>
</body>
</html>
