<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>가게 상세 · 3-섹션 레이아웃</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js" defer></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">
  <div id="header-placeholder"></div>

  <main class="container mx-auto px-4 py-8 flex-1">
    <div class="flex flex-col lg:flex-row gap-6">

      <!-- ▣ 1. 왼쪽 : 슬라이더 + 지도 -->
      <section class="flex-1 bg-white p-6 rounded shadow flex flex-col gap-6">
        <div class="relative">
          <img id="sliderImage" class="w-full h-64 object-cover rounded shadow" />
          <button id="prevBtn" class="absolute left-2 top-1/2 -translate-y-1/2 bg-black/50 text-white rounded px-3 py-1">‹</button>
          <button id="nextBtn" class="absolute right-2 top-1/2 -translate-y-1/2 bg-black/50 text-white rounded px-3 py-1">›</button>
        </div>
        <div class="bg-gray-50 border rounded-lg p-4 flex-1">
          <h2 class="text-lg font-semibold mb-2">가게 위치</h2>
          <p id="addressText" class="text-sm text-gray-700 mb-2"></p>
          <div id="map" class="w-full h-40 bg-gray-200 flex items-center justify-center text-gray-600">지도 로드 중…</div>
        </div>
      </section>

      <!-- ▣ 2. 가운데 : 상호 · 정보 · 설명 -->
      <section class="flex-1 bg-white p-6 rounded shadow flex flex-col gap-4">
        <h2 id="businessNameHeader" class="text-3xl font-bold border-b pb-3"></h2>
        <div>
          <p id="businessType" class="text-lg"></p>
          <p id="deliveryOption" class="text-lg"></p>
          <p id="businessHours" class="text-lg"></p>
        </div>
        <div class="bg-gray-50 p-4 rounded border">
          <h3 class="text-xl font-bold mb-2">서비스 내용</h3>
          <p id="serviceDetails" class="text-gray-700"></p>
        </div>
        <div class="bg-gray-50 p-4 rounded border">
          <h3 class="text-xl font-bold mb-2">이벤트</h3>
          <ul id="eventsList" class="list-disc pl-6 space-y-1"></ul>
        </div>
        <div class="bg-gray-50 p-4 rounded border">
          <h3 class="text-xl font-bold mb-2">추가 정보</h3>
          <ul id="additionalInfoList" class="list-disc pl-6 space-y-1"></ul>
        </div>
        <div class="bg-gray-50 p-4 rounded border">
          <h3 class="text-xl font-bold mb-2">연락처</h3>
          <p id="contactPhone"></p>
          <p id="contactHomepage"></p>
        </div>
        <div class="bg-gray-50 p-4 rounded border">
          <h3 class="text-xl font-bold mb-2">추가 설명</h3>
          <p id="additionalDesc" class="text-gray-700"></p>
        </div>
      </section>

      <!-- ▣ 3. 오른쪽 : 메뉴 + 장바구니 -->
      <section class="w-full lg:w-1/3 flex flex-col gap-4">
        <div id="menuBox" class="flex-1 bg-white border rounded p-4 shadow overflow-auto">
          <h2 class="text-xl font-bold mb-4">메뉴</h2>
          <ul id="menuList" class="space-y-2"></ul>
        </div>
        <div id="cartBox" class="bg-white border rounded p-4 shadow">
          <h3 class="text-xl font-bold mb-2">🛒 장바구니</h3>
          <ul id="cartList" class="space-y-2 max-h-60 overflow-auto"></ul>
          <div class="border-t mt-3 pt-3 text-right">
            <p class="font-semibold">총합: <span id="totalPrice">0</span>원</p>
            <button id="checkoutBtn" class="mt-2 w-full bg-blue-500 hover:bg-blue-600 text-white py-2 rounded">결제하기</button>
          </div>
        </div>
      </section>

    </div>
  </main>

  <div id="footer-placeholder"></div>

  <script type="module">
    const $ = id => document.getElementById(id);
    const params = new URLSearchParams(location.search);
    const storeId = params.get("id") || 1;

    window.addEventListener("DOMContentLoaded", () => {
      fetch("/components/header.html").then(r => r.text()).then(h => $("header-placeholder").innerHTML = h);
      fetch("/components/footer.html").then(r => r.text()).then(h => $("footer-placeholder").innerHTML = h);
    });

    function loadKakaoSdk() {
      return fetch("/kakao-key")
        .then(r => r.json())
        .then(({ key }) => new Promise((resolve, reject) => {
          if (!key) return reject("Kakao key missing");
          const s = document.createElement("script");
          s.src = `https://dapi.kakao.com/v2/maps/sdk.js?appkey=${key}&autoload=false&libraries=services,clusterer`;
          s.defer = true;
          s.onload = () => kakao.maps.load(resolve);
          s.onerror = () => reject("Kakao SDK load error");
          document.head.appendChild(s);
        }));
    }

    const slider = {
      imgs: [], idx: 0,
      init(arr) {
        this.imgs = arr.length ? arr : ["https://via.placeholder.com/600x400?text=NO+IMAGE"];
        $("sliderImage").src = this.imgs[0];
        $("prevBtn").onclick = () => this.move(-1);
        $("nextBtn").onclick = () => this.move(1);
      },
      move(step) {
        this.idx = (this.idx + step + this.imgs.length) % this.imgs.length;
        $("sliderImage").src = this.imgs[this.idx];
      }
    };

    const cart = [];
    function addToCart(it) { cart.push(it); renderCart(); }
    function renderCart() {
      let sum = 0; const ul = $("cartList"); ul.innerHTML = "";
      cart.forEach(({ menuName, menuPrice }) => {
        sum += Number(menuPrice);
        const li = document.createElement("li");
        li.className = "flex justify-between text-sm";
        li.innerHTML = `<span>${menuName}</span><span>${Number(menuPrice).toLocaleString()}원</span>`;
        ul.appendChild(li);
      });
      $("totalPrice").textContent = sum.toLocaleString();
    }

    const setList = (wrapId, arr = []) => {
      const ul = $(wrapId); ul.innerHTML = "";
      arr.forEach(t => { const li = document.createElement("li"); li.textContent = t; ul.appendChild(li); });
    };

    (async () => {
      try {
        await loadKakaoSdk();
        const res = await fetch(`/store/${storeId}`);
        if (!res.ok) throw new Error("Store API error");
        const { store, menu = [] } = await res.json();
        slider.init(store.images || []);
        $("businessNameHeader").textContent = store.businessName ?? "상호명 없음";
        $("businessType").innerHTML = `<strong>업종:</strong> ${store.businessType ?? ""}`;
        $("deliveryOption").innerHTML = `<strong>배달:</strong> ${store.deliveryOption ?? ""}`;
        $("businessHours").innerHTML = `<strong>영업시간:</strong> ${store.businessHours ?? ""}`;
        $("serviceDetails").textContent = store.serviceDetails ?? "";
        setList("eventsList", store.events);
        setList("additionalInfoList", store.additionalInfo);
        $("contactPhone").textContent = store.contactPhone ?? "";
        $("contactHomepage").innerHTML = store.contactHomepage
          ? `<a href="${store.contactHomepage}" class="text-blue-600 underline" target="_blank">${store.contactHomepage}</a>` : "";
        $("additionalDesc").textContent = store.additionalDesc ?? "";

        const menuBox = $("menuList"); menuBox.innerHTML = "";
        menu.forEach(it => {
          const li = document.createElement("li");
          li.className = "flex items-center gap-4 border p-2 rounded hover:shadow cursor-pointer";
          li.innerHTML = `
            <img src="${it.menuImageUrl || "https://via.placeholder.com/80"}" class="w-20 h-20 object-cover rounded">
            <div>
              <p class="text-lg font-semibold">${it.menuName}</p>
              <p class="text-gray-600">${Number(it.menuPrice).toLocaleString()}원</p>
            </div>`;
          li.onclick = () => addToCart(it);
          menuBox.appendChild(li);
        });

        const geocoder = new kakao.maps.services.Geocoder();
        geocoder.addressSearch(store.address, (res, status) => {
          if (status !== kakao.maps.services.Status.OK) return;
          const p = new kakao.maps.LatLng(res[0].y, res[0].x);
          const map = new kakao.maps.Map($("map"), { center: p, level: 3 });
          new kakao.maps.Marker({ map, position: p });
          new kakao.maps.InfoWindow({ map, position: p, content: `<div style="padding:5px">${store.businessName}</div>` });
          $("addressText").textContent = store.address;
        });
      } catch (e) {
        console.error("로드 오류:", e);
        $("sliderImage").src = "https://via.placeholder.com/600x400?text=NO+IMAGE";
      }
    })();
  </script>
</body>
</html>
