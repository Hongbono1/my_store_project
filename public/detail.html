<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>가게 상세 · 3분할 레이아웃</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Kakao Maps (동적 로딩은 JS에서) -->
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">
  <!-- (헤더) -->
  <div id="header-placeholder"></div>
  <main class="container mx-auto px-4 py-8 flex flex-col lg:flex-row min-h-screen gap-8">
    <!-- ▣ 1. 왼쪽 : 이미지, 지도, 위치 -->
    <section class="flex flex-col flex-1 min-h-0 bg-blue-900 rounded-3xl shadow-2xl px-6 py-10 items-center text-white">
      <div class="w-full flex flex-col items-center gap-4">
        <div class="w-full">
          <div class="text-lg font-bold text-center mb-2">가게 이미지</div>
          <!-- 이미지 슬라이더 -->
          <div class="relative w-full rounded-2xl overflow-hidden mb-4 shadow">
            <div id="sliderWrapper" class="w-full h-64 relative">
              <div id="sliderImages" class="flex transition-transform duration-500 ease-in-out h-full"></div>
              <button id="prevBtn" class="absolute left-2 top-1/2 -translate-y-1/2 bg-black/70 text-white rounded-full px-3 py-1 opacity-80 hover:opacity-100 z-10">‹</button>
              <button id="nextBtn" class="absolute right-2 top-1/2 -translate-y-1/2 bg-black/70 text-white rounded-full px-3 py-1 opacity-80 hover:opacity-100 z-10">›</button>
            </div>
            <div id="thumbBox" class="flex gap-2 justify-center mt-3"></div>
          </div>
        </div>
        <!-- 지도 + 위치 -->
        <div class="w-full bg-white/90 rounded-xl p-6 text-blue-900 shadow mb-4">
          <div class="font-semibold mb-2">가게 위치</div>
          <div id="addressText" class="mb-2 text-base"></div>
          <div id="map" class="w-full h-48 rounded border"></div>
        </div>
      </div>
    </section>

    <!-- ▣ 2. 중앙 : 가게 정보, 서비스, 이벤트, 연락처 등 -->
    <section class="flex-1 bg-white rounded-3xl shadow-2xl px-6 py-10 flex flex-col gap-6 min-h-[800px]">
      <h1 id="businessNameHeader" class="text-3xl md:text-4xl font-extrabold text-center mb-6"></h1>
      <div class="bg-blue-50 p-4 rounded-xl border text-blue-900">
        <div id="businessType" class="text-lg"></div>
        <div id="businessCategory" class="text-lg"></div>
        <div id="deliveryOption" class="text-lg"></div>
        <div id="businessHours" class="text-lg"></div>
      </div>
      <div class="bg-blue-50 p-4 rounded-xl border">
        <div class="text-lg font-semibold mb-2">서비스 내용</div>
        <div id="serviceDetails" class="text-gray-900"></div>
      </div>
      <div class="bg-blue-50 p-4 rounded-xl border">
        <div class="text-lg font-semibold mb-2">이벤트</div>
        <ul id="eventsList" class="list-disc pl-6 text-lg text-gray-900 leading-relaxed"></ul>
      </div>
      <div class="bg-blue-50 p-4 rounded-xl border">
        <div class="text-lg font-semibold mb-2">기타 정보</div>
        <ul id="infoEtcList" class="list-disc pl-6 text-lg text-gray-900 leading-relaxed"></ul>
      </div>
      <div class="bg-blue-50 p-4 rounded-xl border">
        <div class="text-lg font-semibold mb-2">추가 정보</div>
        <ul id="additionalInfoList" class="list-disc pl-6 text-lg text-gray-900 leading-relaxed"></ul>
      </div>
      <!-- 연락처 -->
      <div class="bg-blue-50 p-4 rounded-xl border">
        <div class="text-lg font-semibold mb-2 border-b pb-1">연락처</div>
        <div id="contactPhone" class="text-lg"></div>
        <div id="contactHomepage" class="text-lg"></div>
        <div id="contactInstagram" class="text-lg"></div>
        <div id="contactFacebook" class="text-lg"></div>
      </div>
    </section>

    <!-- ▣ 3. 오른쪽 : 메뉴, 장바구니 -->
    <section class="flex-1 bg-yellow-50 rounded-3xl shadow-2xl px-6 py-10 flex flex-col min-h-[800px]">
      <div class="flex-1 flex flex-col">
        <h2 class="text-2xl font-bold text-yellow-900 mb-4 text-center">메뉴</h2>
        <div id="menuList" class="flex flex-col gap-4 divide-y overflow-y-auto pr-2 mb-8" style="max-height:480px;"></div>
      </div>
      <!-- 장바구니 -->
      <div id="cartBox" class="shrink-0 bg-white rounded-xl shadow p-6 mt-6">
        <div class="font-bold mb-2">장바구니</div>
        <ul id="cartItems" class="space-y-2 text-base"></ul>
        <div class="flex justify-between items-center mt-4">
          <span class="font-bold text-gray-800">합계:</span>
          <span id="cartTotal" class="text-2xl font-bold text-blue-700">0원</span>
        </div>
        <button class="mt-4 w-full bg-blue-700 text-white py-2 rounded hover:bg-blue-800 font-bold">결제하기</button>
      </div>
    </section>
  </main>
  <!-- (푸터) -->
  <div id="footer-placeholder"></div>

  <!-- 이미지 모달 -->
  <div id="imageModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
    <div class="relative">
      <img id="modalImage" class="w-[600px] h-[400px] object-contain rounded shadow-xl" />
      <button id="closeModal" class="absolute -top-4 -right-4 bg-white text-black rounded-full text-3xl w-10 h-10 flex items-center justify-center z-60 hover:bg-gray-200">
        ×
      </button>
    </div>
  </div>

  <script type="module">
    // 기존 JS와 동일하게 id/class 맞춰서 데이터 자동 매핑!
    const $ = id => document.getElementById(id);
    const params = new URLSearchParams(location.search);
    window.storeId = params.get("id") || 1;
    const storeId = window.storeId;

    // 헤더/푸터 삽입
    window.addEventListener("DOMContentLoaded", () => {
      fetch("/components/header.html")
        .then(r => r.text())
        .then(html => { $("header-placeholder").innerHTML = html; });
      fetch("/components/footer.html")
        .then(r => r.text())
        .then(html => { $("footer-placeholder").innerHTML = html; });
    });

    // Kakao Maps SDK 동적 로드
    function loadKakaoSdk() {
      return fetch("/kakao-key")
        .then(r => r.json())
        .then(({ key }) => new Promise((resolve, reject) => {
          if (!key) return reject("Kakao key not found");
          const s = document.createElement("script");
          s.src = `https://dapi.kakao.com/v2/maps/sdk.js?appkey=${key}&autoload=false&libraries=services,clusterer`;
          s.defer = true;
          s.onload = () => kakao.maps.load(resolve);
          s.onerror = () => reject("Kakao SDK load error");
          document.head.appendChild(s);
        }));
    }

    async function initMap(storeAddress, storeName = "") {
      try {
        await loadKakaoSdk();
        const geocoder = new kakao.maps.services.Geocoder();
        const cleanedAddress = storeAddress.replace(/^\d{5}\s*/, "").replace(/\s+\d+$/, "").trim();
        geocoder.addressSearch(cleanedAddress, (result, status) => {
          if (status !== kakao.maps.services.Status.OK) return;
          const coords = new kakao.maps.LatLng(result[0].y, result[0].x);
          const map = new kakao.maps.Map($("map"), { center: coords, level: 3 });
          const marker = new kakao.maps.Marker({ map, position: coords });
          if (storeName) {
            const ovContent = `
              <div style="padding:4px 8px;background:#fff;border:1px solid #666;border-radius:4px;font-size:13px;white-space:nowrap;">
                ${storeName}
              </div>`;
            const overlay = new kakao.maps.CustomOverlay({
              position: marker.getPosition(),
              content: ovContent,
              yAnchor: 1
            });
            overlay.setMap(map);
          }
        });
      } catch (error) { }
    }

    // 이미지 슬라이더
    const slider = {
      imgs: [],
      idx: 0,
      init(arr) {
        this.imgs = (arr || []).filter(src => typeof src === "string" && (src.startsWith("http") || src.startsWith("/"))).map(src => src.trim());
        if (!this.imgs.length) this.imgs = ["/no-image.png"];
        $("sliderImages").innerHTML = this.imgs.map((u, i) => `
          <img src="${u}" data-index="${i}" class="w-full h-full object-cover flex-shrink-0 cursor-pointer" onclick="showModalImage('${u}')"/>
        `).join('');
        $("sliderImages").onclick = (e) => {
          if (e.target.tagName === "IMG") {
            this.idx = Number(e.target.dataset.index);
            this.update();
            openModal(this.imgs[this.idx]);
          }
        };
        this.renderThumbs();
        this.update();
        $("prevBtn").onclick = () => this.move(-1);
        $("nextBtn").onclick = () => this.move(1);
      },
      renderThumbs() {
        const box = $("thumbBox");
        box.innerHTML = "";
        this.imgs.forEach((src, i) => {
          if (!src.startsWith("http") && !src.startsWith("/")) return;
          const t = document.createElement("img");
          t.setAttribute("src", src);
          t.setAttribute("alt", `이미지 ${i + 1}`);
          t.className = "w-14 h-14 object-cover rounded cursor-pointer border hover:opacity-80";
          t.addEventListener("click", () => {
            this.idx = i;
            this.update();
            openModal(src);
          });
          box.appendChild(t);
        });
      },
      move(step) {
        this.idx = (this.idx + step + this.imgs.length) % this.imgs.length;
        this.update();
      },
      update() {
        $("sliderImages").style.transform = `translateX(${-this.idx * 100}%)`;
        [...$("thumbBox").children].forEach((el, i) => {
          el.classList.toggle("ring-2", i === this.idx);
          el.classList.toggle("ring-blue-300", i === this.idx);
        });
      }
    };

    // 모달
    (function enableModalKeys() {
      const modal = $("imageModal");
      modal.addEventListener("click", (e) => {
        if (e.target === modal) closeModal();
      });
      window.addEventListener("keydown", (e) => {
        if (modal.classList.contains("hidden")) return;
        if (e.key === "ArrowLeft") {
          slider.move(-1);
          $("modalImage").src = slider.imgs[slider.idx];
        }
        if (e.key === "ArrowRight") {
          slider.move(1);
          $("modalImage").src = slider.imgs[slider.idx];
        }
        if (e.key === "Escape") closeModal();
      });
      $("closeModal").addEventListener('click', closeModal);
    })();
    function openModal(src) {
      $("modalImage").src = src;
      $("imageModal").classList.remove("hidden");
    }
    function closeModal() {
      $("imageModal").classList.add("hidden");
    }

    // 장바구니
    const cart = [];
    function addToCart(item) {
      const found = cart.find(c => c.menuName === item.menuName);
      if (found) found.quantity += item.quantity;
      else cart.push({ ...item });
      renderCart();
    }
    function renderCart() {
      const ul = $("cartItems");
      if (!ul) return;
      ul.innerHTML = "";
      let sum = 0;
      cart.forEach((item, index) => {
        const price = Number(item.menuPrice) || 0;
        const qty = Number(item.quantity) || 1;
        const total = price * qty;
        sum += total;
        const li = document.createElement("li");
        li.className = "flex justify-between items-center text-lg py-2";
        li.innerHTML = `
          <span>${item.menuName} × ${qty}</span>
          <span class="text-xl font-bold">${total.toLocaleString()}원</span>
          <button class="removeBtn bg-red-100 text-red-600 px-2 py-1 rounded text-sm ml-2" data-index="${index}">삭제</button>
        `;
        ul.appendChild(li);
      });
      ul.querySelectorAll(".removeBtn").forEach(btn => {
        btn.onclick = () => {
          const idx = btn.dataset.index;
          cart.splice(idx, 1);
          renderCart();
        };
      });
      $("cartTotal").textContent = sum.toLocaleString();
    }
    const setList = (wrapId, arr = []) => {
      const ul = $(wrapId); ul.innerHTML = "";
      arr.forEach(t => {
        const li = document.createElement("li");
        li.textContent = t;
        ul.appendChild(li);
      });
    };

    // 데이터 fetch 및 출력
    await loadKakaoSdk();
    const res = await fetch(`/store/${storeId}`);
    if (!res.ok) throw new Error("Store API error");
    const { store, menus = [] } = await res.json();
    window.menuDebug = menus;
    window.store = store;

    slider.init(store.images || [store.image1, store.image2, store.image3].filter(Boolean));
    $("businessNameHeader").textContent = store.businessName ?? "상호명 없음";
    $("businessCategory").innerHTML = `<strong>구분:</strong> ${store.category || "선택되지 않음"}`;
    $("businessType").innerHTML = `<strong>업종:</strong> ${store.businessType || "없음"}`;
    $("deliveryOption").innerHTML = `<strong>배달:</strong> ${store.deliveryOption || "없음"}`;
    $("businessHours").innerHTML = `<strong>영업시간:</strong> ${store.businessHours || "없음"}`;
    $("serviceDetails").textContent = store.serviceDetails ?? "없음";
    setList("eventsList", [store.event1, store.event2].filter(Boolean));
    const infoList = $("infoEtcList");
    if (infoList) {
      infoList.innerHTML = `
        <li>장애인 편의시설: ${store.facility ?? "정보 없음"}</li>
        <li>반려동물 출입:   ${store.pets ?? "정보 없음"}</li>
        <li>주차 정보:       ${store.parking ?? "정보 없음"}</li>
      `;
    }
    const addList = $("additionalInfoList");
    if (addList) {
      addList.innerHTML = `
        <li>서비스 내용: ${store.serviceDetails ?? "없음"}</li>
      `;
    }
    $("contactPhone").textContent = store.contactPhone ?? "";
    $("contactHomepage").innerHTML = store.homepage
      ? `<strong>홈페이지:</strong> <a href="${store.homepage}" class="text-blue-600 underline" target="_blank">${store.homepage}</a>`
      : "";
    $("contactInstagram").innerHTML = store.instagram
      ? `<strong>인스타그램:</strong> <a href="${store.instagram}" class="text-blue-600 underline" target="_blank">${store.instagram}</a>`
      : "";
    $("contactFacebook").innerHTML = store.facebook
      ? `<strong>페이스북:</strong> <a href="${store.facebook}" class="text-blue-600 underline" target="_blank">${store.facebook}</a>`
      : "";

    // 메뉴 출력
    const menuList = $("menuList");
    menuList.innerHTML = "";
    menuList.className = [
      "flex", "flex-col",
      "gap-4",
      "flex-1", "min-h-0",
      "overflow-y-auto"
    ].join(" ");
    const menuByCategory = {};
    menus.forEach(it => {
      const raw = it.category ?? it.menu_category ?? it.cat ?? '';
      const category = raw.replace(/\u3000/g, '').trim() || '기타';
      if (!menuByCategory[category]) menuByCategory[category] = [];
      menuByCategory[category].push(it);
    });
    Object.entries(menuByCategory).forEach(([category, items]) => {
      const group = document.createElement("div");
      const title = document.createElement("h3");
      title.textContent = "🍱 " + category;
      title.className = "text-xl font-bold mt-6 mb-2 text-gray-800";
      group.appendChild(title);
      items.forEach(it => {
        const box = document.createElement("div");
        box.className = "flex items-center gap-4 p-4 bg-white rounded-lg shadow-sm border";
        box.innerHTML = `
          <img src="${(it.menu_image && it.menu_image.trim()) ? it.menu_image : '/assets/images/no-thumb.png'}"
            class="w-24 h-24 object-cover rounded-md"/>
          <div class="flex-1 flex flex-col justify-center">
            <div class="text-lg font-bold mb-1 truncate">${it.menuName}</div>
            <div class="text-base font-medium text-gray-700">
              ${Number(it.menuPrice).toLocaleString()}원
            </div>
          </div>
          <div class="flex flex-col items-center justify-center gap-1 shrink-0">
            <div class="flex items-center gap-1">
              <button class="decrease px-2 py-1 bg-gray-200 rounded">－</button>
              <span class="quantity w-6 text-center">1</span>
              <button class="increase px-2 py-1 bg-gray-200 rounded">＋</button>
            </div>
            <button class="addBtn px-3 py-1 bg-blue-600 text-white text-sm rounded">담기</button>
          </div>
        `;
        let qty = 1;
        const qtySpan = box.querySelector(".quantity");
        box.querySelector(".decrease").onclick = () => { if (qty > 1) qtySpan.textContent = --qty; };
        box.querySelector(".increase").onclick = () => { qtySpan.textContent = ++qty; };
        box.querySelector(".addBtn").onclick = () => { addToCart({ ...it, quantity: qty }); };
        group.appendChild(box);
      });
      menuList.appendChild(group);
    });

    // 지도
    (() => {
      try {
        const fullAddress = store.address;
        const cleanedAddress = cleanAddress(fullAddress);
        $("addressText").textContent = `📍 ${cleanedAddress}`;
        initMap(cleanedAddress, store.businessName);
        window.kakaoReady = () => {
          kakao.maps.load(() => {
            initMap(cleanedAddress, store.businessName);
          });
        };
        if (window.kakao && window.kakao.maps) {
          kakao.maps.load(() => {
            initMap(cleanedAddress, store.businessName);
          });
        } else if (window.kakaoReady) {
          window.kakaoReady();
        }
        function cleanAddress(fullAddress) {
          const parts = fullAddress.replace(/^\d{5}\s*/, "").split(/\s+/);
          return parts.filter((_, i) => i < 3).join(" ");
        }
      } catch (err) {
        const sliderImages = $("sliderImages");
        if (sliderImages) {
          sliderImages.innerHTML = `<img src="/images/no-image.png" class="w-full h-64 flex-shrink-0 object-cover"/>`;
        }
      }
    })();
  </script>
</body>
</html>
