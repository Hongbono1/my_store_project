<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>오픈예정 등록</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=6286d4d9bc1d503495b03f46622b5dc8&autoload=false&libraries=services"></script>
</head>
<body class="bg-gray-50">

    <!-- 타이틀 + 등록 버튼 (flex) -->
    <div class="max-w-3xl mx-auto px-4 mt-10">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-3xl font-bold text-gray-800">오픈예정</h2>
            <button id="toggleFormBtn"
                class="bg-blue-600 text-white font-bold px-5 py-2 rounded-lg shadow hover:bg-blue-700 transition">
                등록
            </button>
        </div>

        <!-- 등록 폼 (처음에는 숨김) -->
        <section id="openFormSection" class="hidden mb-8">
            <form id="openForm" class="bg-white border-2 border-gray-200 p-6 rounded-lg flex flex-col gap-4">
                <!-- 상호명 -->
                <div>
                    <label class="block font-medium mb-1">상호명 <span class="text-red-500">*</span></label>
                    <input name="name" type="text" class="w-full border rounded px-3 py-2" required>
                </div>
                <!-- 오픈일 -->
                <div>
                    <label class="block font-medium mb-1">오픈일 <span class="text-red-500">*</span></label>
                    <input name="openDate" type="date" class="w-full border rounded px-3 py-2" required>
                </div>
                <!-- 업종(카테고리) -->
                <div>
                    <label class="block font-medium mb-1">업종(카테고리)</label>
                    <input name="category" type="text" class="w-full border rounded px-3 py-2">
                </div>
                <!-- 전화번호 -->
                <div>
                    <label class="block font-medium mb-1">전화번호 <span class="text-red-500">*</span></label>
                    <input name="phone" type="text" class="w-full border rounded px-3 py-2" required>
                </div>
                <!-- 설명 -->
                <div>
                    <label class="block font-medium mb-1">설명</label>
                    <textarea name="desc" class="w-full border rounded px-3 py-2"></textarea>
                </div>
                <!-- 주소 -->
                <div>
                    <label class="block font-medium mb-1">주소</label>
                    <div class="flex gap-2">
                        <input id="address" name="addr" type="text" class="flex-1 border rounded px-3 py-2" readonly>
                        <button type="button" onclick="searchAddress()"
                            class="px-3 py-2 bg-blue-500 text-white rounded w-24">
                            검색
                        </button>
                    </div>
                </div>
                <!-- 지도 미리보기 -->
                <div id="map" class="block mx-auto rounded my-4"
                    style="width:100%; min-width:180px; height:260px; max-width:480px;"></div>
                <!-- 좌표 hidden input -->
                <input type="hidden" id="lat" name="lat">
                <input type="hidden" id="lng" name="lng">
                <!-- 대표 이미지 -->
                <div>
                    <label class="block font-medium mb-1">대표 이미지</label>
                    <input name="img" type="file" accept="image/*" class="w-full border rounded px-3 py-2">
                </div>
                <button type="submit"
                    class="mt-3 py-2 rounded bg-blue-600 text-white font-bold hover:bg-blue-700 shadow">등록</button>
            </form>
        </section>
    </div>

    <!-- 등록된 카드 리스트 출력 -->
    <div id="cardList" class="max-w-5xl mx-auto grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-10"></div>

    <script>
        // (1) 등록 폼 show/hide + 지도 relayout
        document.getElementById('toggleFormBtn').onclick = function () {
            document.getElementById('openFormSection').classList.toggle('hidden');
            setTimeout(function () {
                if (window.map) window.map.relayout();
            }, 250);
        };

        // (2) 등록 카드 데이터 (메모리 임시)
        const cards = [];

        // (3) 폼 제출 이벤트
        document.getElementById('openForm').onsubmit = async function (e) {
            e.preventDefault();
            const fd = new FormData(this);

            // 이미지 미리보기 처리
            let imgURL = '';
            const file = fd.get('img');
            if (file && file.size) {
                imgURL = await new Promise(res => {
                    const reader = new FileReader();
                    reader.onload = e => res(e.target.result);
                    reader.readAsDataURL(file);
                });
            }

            // 카드 데이터 생성
            const card = {
                name: fd.get('name') || '',
                category: fd.get('category') || '',
                desc: fd.get('desc') || '',
                addr: fd.get('addr') || '',
                phone: fd.get('phone') || '',
                openDate: fd.get('openDate') || '',
                img: imgURL
            };
            cards.unshift(card); // 최신순
            this.reset();
            renderCards();
            document.getElementById('openFormSection').classList.add('hidden'); // 등록 후 폼 닫기
        };

        // (4) 카드리스트 출력 함수 (디자인/배치만 바꿔서 반영)
        function renderCards() {
            const list = document.getElementById('cardList');
            // 카드가 없으면 더미 6개 출력
            const showCards = (cards.length ? cards : [
                {
                    name: "상호명1", category: "식당", addr: "서울 강남구 테헤란로", phone: "010-1234-5678", openDate: "2025-01-05", desc: "신메뉴 출시, 휠체어 가능", img: "https://via.placeholder.com/110x70?text=1"
                },
                {
                    name: "상호명2", category: "카페", addr: "서울 종로구", phone: "010-2345-6789", openDate: "2025-02-15", desc: "커피 시음 행사", img: "https://via.placeholder.com/110x70?text=2"
                },
                {
                    name: "상호명3", category: "편의점", addr: "서울 동작구", phone: "010-3456-7890", openDate: "2025-03-22", desc: "신규 오픈 이벤트", img: "https://via.placeholder.com/110x70?text=3"
                },
                {
                    name: "상호명4", category: "헬스장", addr: "경기 성남시", phone: "010-4567-8901", openDate: "2025-04-10", desc: "회원 할인 이벤트", img: "https://via.placeholder.com/110x70?text=4"
                },
                {
                    name: "상호명5", category: "PC방", addr: "부산 해운대구", phone: "010-5678-9012", openDate: "2025-05-30", desc: "게임 토너먼트", img: "https://via.placeholder.com/110x70?text=5"
                },
                {
                    name: "상호명6", category: "마트", addr: "대구 중구", phone: "010-6789-0123", openDate: "2025-06-25", desc: "신선식품 할인", img: "https://via.placeholder.com/110x70?text=6"
                }
            ]);

            list.innerHTML = showCards.map(card => `
                <div class="bg-yellow-100 text-black p-5 rounded-xl shadow-lg relative overflow-hidden flex flex-col hover:scale-105 transition duration-200">
                  <div class="flex-1 flex flex-col gap-3">
                    <div class="flex items-center gap-3 mb-2">
                      <img src="${card.img || 'https://placehold.co/110x70?text=No+Image'}"
                        alt="${card.name}" class="w-[110px] h-[70px] object-cover rounded-md border flex-shrink-0" />
                      <div>
                        <div class="flex items-center gap-2 mb-1">
                          <span class="text-lg font-bold">${card.name}</span>
                          <span class="text-xs bg-yellow-400 rounded px-2 py-1 font-semibold">${card.category}</span>
                        </div>
                        <div class="flex items-center text-xs text-gray-700 mb-1">
                          <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"></path>
                          </svg>
                          ${card.addr}
                        </div>
                      </div>
                    </div>
                    <div class="text-xs flex items-center gap-2 text-gray-600">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="10"/><path d="M12 8v4l3 3"/>
                      </svg>
                      오픈일 <span class="text-gray-900 font-bold ml-1">${(card.openDate || '').replace(/-/g, ".")}</span>
                    </div>
                    <div class="text-xs flex items-center gap-2 text-gray-600">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M3 10v6a2 2 0 002 2h3l3 3V7l-3 3H5a2 2 0 00-2 2z"/>
                      </svg>
                      전화 <span class="ml-1">${card.phone}</span>
                    </div>
                    <div class="text-xs text-gray-500 mt-2">${card.desc}</div>
                  </div>
                </div>
            `).join('');
        }
        renderCards(); // 최초 호출

        // 지도 및 마커 전역 변수!
        window.map = null;
        window.marker = null;

        // SDK가 로드된 뒤에만 kakaoInit 호출!
        document.addEventListener('DOMContentLoaded', function () {
            kakao.maps.load(function () {
                const mapContainer = document.getElementById('map');
                if (!mapContainer) return;
                window.map = new kakao.maps.Map(mapContainer, {
                    center: new kakao.maps.LatLng(37.5665, 126.9780), // 서울시청
                    level: 3
                });
                window.marker = new kakao.maps.Marker({ map: window.map });
            });
        });

        function searchAddress() {
            const width = 500;
            const height = 600;
            const left = Math.ceil((window.screen.width - width) / 2);
            const top = Math.ceil((window.screen.height - height) / 2);

            new daum.Postcode({
                oncomplete: function (data) {
                    document.getElementById('address').value = data.address;
                    updateMapByAddress(data.address);
                }
            }).open({
                left,
                top
            });
        }

        function updateMapByAddress(address) {
            if (!window.map || !window.marker) return;
            const geocoder = new kakao.maps.services.Geocoder();
            geocoder.addressSearch(address, function (result, status) {
                if (status === kakao.maps.services.Status.OK) {
                    const lat = result[0].y;
                    const lng = result[0].x;
                    const loc = new kakao.maps.LatLng(lat, lng);
                    window.map.setCenter(loc);
                    window.marker.setPosition(loc);
                    document.getElementById('lat').value = lat;
                    document.getElementById('lng').value = lng;
                }
            });
        }

        // 지도 리셋(등록 후, 필요시 사용)
        function resetMap() {
            if (!window.map || !window.marker) return;
            window.map.setCenter(new kakao.maps.LatLng(37.5665, 126.9780));
            window.marker.setPosition(new kakao.maps.LatLng(37.5665, 126.9780));
            document.getElementById('lat').value = '';
            document.getElementById('lng').value = '';
            document.getElementById('address').value = '';
        }
    </script>
</body>
</html>
