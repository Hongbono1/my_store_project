<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>공연·예술·축제 상세</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gradient-to-r from-indigo-100 via-blue-50 to-blue-200 min-h-screen">
  <!-- 헤더 -->
  <div id="header"></div>

  <main class="max-w-2xl mx-auto bg-white/95 p-0 sm:p-8 mt-12 mb-20 rounded-3xl shadow-2xl border border-indigo-200">
    <!-- 1. 제목 (맨 위!) -->
    <div class="bg-gradient-to-r from-indigo-200 via-sky-100 to-blue-100 py-7 rounded-t-3xl shadow text-center border-b border-indigo-100">
      <h1 id="title" class="text-4xl font-extrabold text-indigo-800 mb-1 tracking-tight drop-shadow">제목</h1>
      <span id="typeBadge" class="inline-block text-xs bg-indigo-50 text-indigo-600 px-3 py-1 rounded-full mt-1 mb-0">타입</span>
    </div>

    <!-- 2. 이미지 영역 (슬라이드/썸네일) -->
    <div id="mainImageWrap" class="flex flex-col items-center px-4 py-5 gap-3 bg-white">
      <img id="mainImg" src="/assets/images/no-thumb.png" alt="대표이미지"
        class="w-full max-w-lg rounded-xl shadow mb-1 border-2 border-indigo-200 bg-white object-cover aspect-video">
      <div id="thumbs" class="flex gap-2"></div>
    </div>

    <!-- 3. 정보 박스 -->
    <section class="px-6 py-5 border-b border-indigo-50">
      <div class="flex flex-col gap-2">
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
          <div>
            <div class="text-xs text-gray-400">일정</div>
            <div id="date" class="font-bold text-indigo-700">-</div>
          </div>
          <div>
            <div class="text-xs text-gray-400">시간</div>
            <div id="time" class="font-bold text-indigo-700">-</div>
          </div>
          <div>
            <div class="text-xs text-gray-400">장소명</div>
            <div id="venue" class="font-bold text-indigo-700">-</div>
          </div>
          <div>
            <div class="text-xs text-gray-400">주소</div>
            <div id="address" class="font-bold text-indigo-700 truncate">-</div>
          </div>
        </div>
      </div>
    </section>

    <!-- 4. 상세 소개 (카드) -->
    <section class="px-6 py-6 border-b border-indigo-50">
      <h2 class="text-lg font-bold text-indigo-700 mb-2">상세 소개</h2>
      <p id="description" class="text-gray-800 whitespace-pre-line leading-relaxed bg-indigo-50/40 rounded-xl p-4 shadow-sm">
        상세 설명이 여기에 표시됩니다.
      </p>
    </section>

    <!-- 5. 추가 정보 -->
    <section class="px-6 py-6 border-b border-indigo-50 bg-white/60">
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-y-2">
        <div id="priceWrap" class="hidden"><span class="font-bold">참가비: </span><span id="price"></span></div>
        <div id="hostWrap" class="hidden"><span class="font-bold">주최/주관: </span><span id="host"></span></div>
        <div id="ageWrap" class="hidden"><span class="font-bold">관람 등급: </span><span id="age_limit"></span></div>
        <div id="capWrap" class="hidden"><span class="font-bold">정원: </span><span id="capacity"></span></div>
        <div id="phoneWrap" class="hidden"><span class="font-bold">연락처: </span><span id="phone"></span></div>
        <div id="tagsWrap" class="hidden"><span class="font-bold">태그: </span><span id="tags"></span></div>
        <div id="bookingWrap" class="hidden"><span class="font-bold">예매: </span>
          <a id="booking_url" class="text-indigo-600 underline" target="_blank" rel="noopener">바로가기</a>
        </div>
        <div id="socialWrap" class="hidden flex flex-col gap-1">
          <span class="font-bold">공식/소셜</span>
          <div id="socialLinks" class="flex flex-col text-indigo-600 underline"></div>
        </div>
      </div>
    </section>

    <!-- 6. 지도 -->
    <section class="px-6 py-6">
      <h2 class="text-base font-bold text-indigo-700 mb-2">
        지도 : <span id="mapVenue" class="font-bold text-indigo-700"></span>
      </h2>
      <div id="kakaoMap" class="w-full h-60 rounded-xl border"></div>
    </section>
  </main>

  <script>
    // 헤더 로드
    fetch("/components/header.html")
      .then(res => res.text())
      .then(html => { document.getElementById("header").innerHTML = html; });

    // URL ?id= 추출
    const getParam = (name) => new URL(location.href).searchParams.get(name);
    const artId = getParam('id');
    if (!artId) {
      alert('잘못된 접근입니다.');
      location.href = '/';
    }

    // 상세 로드
    async function loadArtDetail() {
      try {
        const res = await fetch(`/art/${artId}`);
        if (!res.ok) throw new Error('데이터 없음');
        const data = await res.json();

        // 1. 제목/타입
        document.getElementById('title').textContent = data.title || '-';
        document.getElementById('typeBadge').textContent = data.type || '-';

        // 2. 이미지 (image1~3)
        const imgs = [data.image1, data.image2, data.image3].filter(Boolean);
        const mainImgEl = document.getElementById('mainImg');
        if (imgs.length > 0) {
          mainImgEl.src = `/uploads/${imgs[0]}`;
        }
        const thumbs = document.getElementById('thumbs');
        thumbs.innerHTML = '';
        imgs.forEach((f, i) => {
          const el = document.createElement('img');
          el.src = `/uploads/${f}`;
          el.className = "w-16 h-16 object-cover rounded border cursor-pointer";
          el.onclick = () => mainImgEl.src = `/uploads/${f}`;
          thumbs.appendChild(el);
        });

        // 3. 정보
        const sd = data.start_date ? data.start_date : '';
        const ed = data.end_date ? data.end_date : '';
        const dateText = sd && ed ? `${sd} ~ ${ed}` : (sd || ed || '-');
        document.getElementById('date').textContent = dateText;
        document.getElementById('time').textContent = data.time || '-';
        document.getElementById('venue').textContent = data.venue || '-';
        document.getElementById('address').textContent = data.address || '-';

        // 지도 : 공연장명
        document.getElementById('mapVenue').textContent = data.venue || '-';

        // 4. 상세 설명
        document.getElementById('description').textContent = data.description || '-';

        // 5. 추가 정보
        showIf('priceWrap', 'price', data.price);
        showIf('hostWrap', 'host', data.host);
        showIf('ageWrap', 'age_limit', data.age_limit);
        showIf('capWrap', 'capacity', data.capacity);
        showIf('phoneWrap', 'phone', data.phone);
        if (data.booking_url) {
          document.getElementById('booking_url').href = data.booking_url;
          document.getElementById('bookingWrap').classList.remove('hidden');
        }
        showIf('tagsWrap', 'tags', data.tags);

        // 소셜
        const socials = [data.social1, data.social2, data.social3].filter(Boolean);
        if (socials.length) {
          const box = document.getElementById('socialLinks');
          box.innerHTML = '';
          socials.forEach(url => {
            const a = document.createElement('a');
            a.href = url;
            a.target = "_blank";
            a.rel = "noopener";
            a.textContent = url;
            box.appendChild(a);
          });
          document.getElementById('socialWrap').classList.remove('hidden');
        }

        // 6. 지도
        if (window.kakao && window.kakao.maps && data.address) {
          kakao.maps.load(() => showKakaoMap(data.address));
        } else {
          window.kakaoReady = () => showKakaoMap(data.address);
        }

      } catch (e) {
        alert('상세 정보가 없습니다.');
        location.href = '/';
      }
    }

    function showIf(wrapId, valueId, value) {
      if (value !== undefined && value !== null && value !== '') {
        document.getElementById(wrapId).classList.remove('hidden');
        document.getElementById(valueId).textContent = value;
      }
    }

    // KakaoMap
    function showKakaoMap(address) {
      if (!address) return;
      const container = document.getElementById('kakaoMap');
      const map = new kakao.maps.Map(container, {
        center: new kakao.maps.LatLng(37.5665, 126.9780),
        level: 3
      });
      const geocoder = new kakao.maps.services.Geocoder();
      geocoder.addressSearch(address, (result, status) => {
        if (status === kakao.maps.services.Status.OK) {
          const coords = new kakao.maps.LatLng(result[0].y, result[0].x);
          map.setCenter(coords);
          new kakao.maps.Marker({ map, position: coords });
        }
      });
    }

    // Kakao SDK 동적 로드 (키 입력!)
    (function () {
      if (window.kakao && window.kakao.maps) return;
      const script = document.createElement("script");
      script.src = "//dapi.kakao.com/v2/maps/sdk.js?appkey=카카오API키&autoload=false&libraries=services";
      script.onload = () => { kakao.maps.load(() => window.kakaoReady && window.kakaoReady()); };
      document.head.appendChild(script);
    })();

    loadArtDetail();
  </script>
</body>
</html>
