<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>사장님 페이지</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .hidden-section {
            display: none;
        }

        .active-link {
            background: linear-gradient(to right, #60a5fa, #8b5cf6);
            color: white !important;
        }
    </style>
</head>

<body class="bg-gray-100 text-gray-800 font-sans">
    <div class="flex min-h-screen">

        <!-- ✅ 사이드바 -->
        <aside class="w-64 bg-white/60 backdrop-blur-xl border-r border-gray-200 
      shadow-[8px_8px_20px_rgba(0,0,0,0.1),-8px_-8px_20px_rgba(255,255,255,0.7)] flex flex-col">
            <div
                class="p-6 text-center font-extrabold text-2xl bg-gradient-to-r from-blue-500 to-purple-500 bg-clip-text text-transparent">
                사장님 메뉴
            </div>
            <nav id="sidebarMenu" class="flex-1 px-4 py-6 space-y-4">
                <a href="#" data-section="dashboard"
                    class="nav-link block px-4 py-2 rounded-xl bg-white hover:bg-blue-50 transition shadow">
                    대시보드
                </a>

                <a href="#" data-section="store"
                    class="nav-link block px-4 py-2 rounded-xl bg-white hover:bg-blue-50 transition shadow">
                    가게 관리
                </a>

                <a href="#" data-section="menu"
                    class="nav-link block px-4 py-2 rounded-xl bg-white hover:bg-blue-50 transition shadow">
                    메뉴 관리
                </a>

                <a href="#" data-section="promotion"
                    class="nav-link block px-4 py-2 rounded-xl bg-white hover:bg-blue-50 transition shadow">
                    광고/홍보 관리
                </a>

                <a href="#" data-section="event"
                    class="nav-link block px-4 py-2 rounded-xl bg-white hover:bg-blue-50 transition shadow">
                    이벤트 관리
                </a>

                <!-- ✅ 등록 관리 (리뷰 관리 대신) -->
                <a href="#" data-section="register"
                    class="nav-link flex items-center justify-between px-4 py-2 rounded-xl bg-white hover:bg-blue-50 transition shadow">
                    <span>등록 관리</span>
                    <svg xmlns="http://www.w3.org/2000/svg"
                        class="h-4 w-4 text-gray-500 transition-transform duration-300" id="registerArrow" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </a>

                <!-- ✅ 하위 메뉴 -->
                <div id="subRegisterMenu" class="submenu hidden pl-6 space-y-2">
                    <a href="#" data-target="foodregister"
                        class="sub-link block px-4 py-2 rounded-lg bg-gray-50 text-gray-700 hover:bg-blue-100 hover:text-blue-700 transition">
                        🍜 음식점 등록
                    </a>
                    <a href="#" data-target="ncombinedregister"
                        class="sub-link block px-4 py-2 rounded-lg bg-gray-50 text-gray-700 hover:bg-purple-100 hover:text-purple-700 transition">
                        🏪 통합 가게 등록
                    </a>
                    <a href="#" data-target="hotblogregister"
                        class="sub-link block px-4 py-2 rounded-lg bg-gray-50 text-gray-700 hover:bg-pink-100 hover:text-pink-700 transition">
                        📰 홍보 블로그 등록
                    </a>
                </div>

                <a href="#" data-section="settings"
                    class="nav-link block px-4 py-2 rounded-xl bg-white hover:bg-blue-50 transition shadow">
                    설정
                </a>
            </nav>
        </aside>

        <!-- ✅ 메인 -->
        <main class="flex-1 p-8">
            <!-- 상단 헤더 -->
            <header class="flex justify-between items-center mb-8">
                <h1 class="text-3xl font-bold drop-shadow-sm">사장님 페이지</h1>
                <button
                    class="px-4 py-2 rounded-full bg-gradient-to-r from-blue-500 to-purple-500 text-white shadow hover:opacity-90 transition">로그아웃</button>
            </header>

            <!-- 📊 대시보드 -->
            <section id="dashboard" class="content-section">
                <h2 class="text-xl font-bold mb-4">📊 오늘의 요약</h2>

                <!-- ✅ 통계 카드 -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-6 mb-10">
                    <div class="p-6 rounded-2xl bg-white shadow text-center hover:-translate-y-1 transition">
                        <p class="text-gray-500 text-sm">오늘 방문자</p>
                        <p class="text-2xl font-extrabold text-blue-600">120</p>
                    </div>
                    <div class="p-6 rounded-2xl bg-white shadow text-center hover:-translate-y-1 transition">
                        <p class="text-gray-500 text-sm">즐겨찾기 수</p>
                        <p class="text-2xl font-extrabold text-green-600">45</p>
                    </div>
                    <div class="p-6 rounded-2xl bg-white shadow text-center hover:-translate-y-1 transition">
                        <p class="text-gray-500 text-sm">주문 건수</p>
                        <p class="text-2xl font-extrabold text-purple-600">32</p>
                    </div>
                    <div class="p-6 rounded-2xl bg-white shadow text-center hover:-translate-y-1 transition">
                        <p class="text-gray-500 text-sm">리뷰 수</p>
                        <p class="text-2xl font-extrabold text-pink-600">12</p>
                    </div>
                    <div class="p-6 rounded-2xl bg-white shadow text-center hover:-translate-y-1 transition">
                        <p class="text-gray-500 text-sm">오늘 매출</p>
                        <p class="text-2xl font-extrabold text-orange-500">₩320,000</p>
                    </div>
                </div>

                <!-- 📈 그래프 -->
                <div class="bg-white rounded-2xl shadow p-6 mb-10">
                    <h3 class="text-lg font-bold mb-4">📅 최근 7일간 추이</h3>
                    <canvas id="statsChart" height="100"></canvas>
                </div>

                <!-- ✅ 기간 선택 버튼 -->
                <div class="flex flex-wrap gap-2 justify-end mb-4">
                    <button class="period-btn px-3 py-1 bg-blue-100 text-blue-700 rounded-full hover:bg-blue-200"
                        data-period="daily">일간</button>
                    <button class="period-btn px-3 py-1 bg-blue-100 text-blue-700 rounded-full hover:bg-blue-200"
                        data-period="weekly">주간</button>
                    <button class="period-btn px-3 py-1 bg-blue-100 text-blue-700 rounded-full hover:bg-blue-200"
                        data-period="monthly">월간</button>
                    <button class="period-btn px-3 py-1 bg-blue-100 text-blue-700 rounded-full hover:bg-blue-200"
                        data-period="quarterly">분기</button>
                    <button class="period-btn px-3 py-1 bg-blue-100 text-blue-700 rounded-full hover:bg-blue-200"
                        data-period="half">반기</button>
                    <button class="period-btn px-3 py-1 bg-blue-100 text-blue-700 rounded-full hover:bg-blue-200"
                        data-period="yearly">연간</button>
                </div>

                <!-- 📦 최근 주문 내역 -->
                <div class="bg-white rounded-2xl shadow p-6">
                    <h3 class="text-lg font-bold mb-4">🧾 최근 주문 내역</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-sm text-gray-700">
                            <thead>
                                <tr class="border-b bg-gray-50">
                                    <th class="text-left py-2 px-3">주문번호</th>
                                    <th class="text-left py-2 px-3">메뉴</th>
                                    <th class="text-left py-2 px-3">가격</th>
                                    <th class="text-left py-2 px-3">주문시간</th>
                                    <th class="text-left py-2 px-3">상태</th>
                                </tr>
                            </thead>
                            <tbody id="recent-orders-body">
                                <tr>
                                    <td colspan="5" class="py-6 text-center text-gray-400">로딩 중...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- 🏪 가게 관리 (수정 버전) -->
            <section id="store" class="content-section hidden-section">
                <h2 class="text-xl font-bold mb-6">🏪 가게 등록 / 관리</h2>

                <form id="registerForm" enctype="multipart/form-data" class="space-y-6 bg-white p-6 rounded-2xl shadow">

                    <!-- ✅ 사업자 정보 (읽기 전용) -->
                    <div>
                        <label class="block font-bold mb-2">사업자 등록번호</label>
                        <input type="text" name="businessNumber" value="000-00-00000"
                            class="w-full p-2 border rounded bg-gray-100 text-gray-600" readonly>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block font-bold mb-2">대표자 이름</label>
                            <input type="text" name="ownerName" value="홍길동"
                                class="w-full p-2 border rounded bg-gray-100 text-gray-600" readonly>
                        </div>
                        <div>
                            <label class="block font-bold mb-2">연락처</label>
                            <input type="text" name="ownerPhone" value="010-1234-5678"
                                class="w-full p-2 border rounded">
                            <!-- 연락처는 수정 가능 -->
                        </div>
                    </div>

                    <div>
                        <label class="block font-bold mb-2">가게명</label>
                        <input type="text" name="storeName" value="홍길동 식당"
                            class="w-full p-2 border rounded bg-gray-100 text-gray-600" readonly>
                    </div>

                    <!-- ✅ 가게 정보 입력 (사장이 직접 관리) -->
                    <div>
                        <label class="block font-bold mb-2">주소</label>
                        <input type="text" name="storeAddress" class="w-full p-2 border rounded">
                    </div>
                    <div>
                        <label class="block font-bold mb-2">영업시간</label>
                        <input type="text" name="openHours" class="w-full p-2 border rounded"
                            placeholder="예: 10:00 ~ 22:00">
                    </div>
                    <div>
                        <label class="block font-bold mb-2">가게 설명</label>
                        <textarea name="description" rows="3" class="w-full p-2 border rounded"></textarea>
                    </div>

                    <!-- 가게 이미지 업로드 -->
                    <div>
                        <label class="block font-bold mb-2">가게 대표 이미지</label>
                        <input type="file" name="storeImages" multiple class="w-full p-2 border rounded">
                    </div>

                    <button type="submit" class="px-6 py-2 bg-green-500 text-white rounded-full shadow">
                        등록하기
                    </button>
                </form>
            </section>

            <!-- 🍜 메뉴 관리 -->
            <section id="menu" class="content-section hidden-section">
                <h2 class="text-xl font-bold mb-4">🍜 메뉴 관리</h2>
                <button class="mb-4 px-4 py-2 bg-green-500 text-white rounded-full shadow">메뉴 추가</button>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="p-4 bg-white rounded-xl shadow">
                        <h3 class="font-bold">김치찌개</h3>
                        <p class="text-gray-500">₩8,000</p>
                        <div class="mt-2 flex space-x-2">
                            <button class="px-3 py-1 bg-yellow-400 rounded">수정</button>
                            <button class="px-3 py-1 bg-red-500 text-white rounded">삭제</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 📢 광고/홍보 관리 -->
            <section id="promotion" class="content-section hidden-section">
                <h2 class="text-xl font-bold mb-4">📢 광고/홍보 관리</h2>
                <button class="mb-4 px-4 py-2 bg-purple-500 text-white rounded-full shadow">홍보 추가</button>
            </section>

            <!-- 🎉 이벤트 관리 -->
            <section id="event" class="content-section hidden-section">
                <h2 class="text-xl font-bold mb-4">🎉 이벤트 관리</h2>
                <button class="mb-4 px-4 py-2 bg-pink-500 text-white rounded-full shadow">이벤트 등록</button>
            </section>

            <!-- 💬 리뷰 관리 -->
            <section id="review" class="content-section hidden-section">
                <h2 class="text-xl font-bold mb-4">💬 리뷰 관리</h2>
                <p class="text-gray-600">리뷰 내역이 표시됩니다.</p>
            </section>

            <!-- ⚙️ 설정 -->
            <section id="settings" class="content-section hidden-section">
                <h2 class="text-xl font-bold mb-4">⚙️ 설정</h2>
                <form class="space-y-4 bg-white p-6 rounded-xl shadow">
                    <div>
                        <label class="block text-gray-700">이메일</label>
                        <input type="email" class="w-full p-2 border rounded" placeholder="email@example.com">
                    </div>
                    <div>
                        <label class="block text-gray-700">비밀번호</label>
                        <input type="password" class="w-full p-2 border rounded">
                    </div>
                    <button class="px-4 py-2 bg-blue-600 text-white rounded-full shadow">저장</button>
                </form>
            </section>
        </main>
    </div>

    <!-- ✅ Chart.js 라이브러리 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- ✅ JS: 메뉴 전환 + 그래프 -->
    <script>

        // ✅ 1. 대시보드 정보 불러오기
        async function loadDashboard() {
            const res = await fetch(`/owner/dashboard?store_id=${storeId}`);
            const data = await res.json();
            if (data.ok) {
                document.querySelector("#today-visitors").textContent = data.today_visitors || 0;
                document.querySelector("#favorites").textContent = data.favorites || 0;
                document.querySelector("#orders").textContent = data.order_count || 0;
                document.querySelector("#reviews").textContent = data.reviews || 0;
                document.querySelector("#today-sales").textContent = `₩${Number(data.today_sales || 0).toLocaleString()}`;
            }
        }

        // ✅ 공통 유틸 + loadRecentOrders
        const storeId =
            new URLSearchParams(location.search).get("store_id") ||
            localStorage.getItem("store_id") ||
            "1"; // 로그인 후 실제 store_id로 바꿀 예정

        function formatPrice(value) {
            return "₩" + Number(value || 0).toLocaleString();
        }

        function formatTime(isoString) {
            const date = new Date(isoString);
            return date.toLocaleTimeString("ko-KR", {
                hour: "2-digit",
                minute: "2-digit",
                hour12: false,
            });
        }

        function formatStatus(status) {
            switch (status) {
                case "pending":
                    return `<span class="text-gray-600 font-semibold">대기중</span>`;
                case "preparing":
                    return `<span class="text-yellow-600 font-semibold">조리중</span>`;
                case "delivering":
                    return `<span class="text-blue-600 font-semibold">배달중</span>`;
                case "completed":
                    return `<span class="text-green-600 font-semibold">완료</span>`;
                case "canceled":
                    return `<span class="text-red-600 font-semibold">취소</span>`;
                default:
                    return `<span class="text-gray-600 font-semibold">${status}</span>`;
            }
        }

        // ✅ 실제 DB 주문 데이터를 가져와 테이블에 반영
        async function loadRecentOrders() {
            const tbody = document.getElementById("recent-orders-body");
            tbody.innerHTML =
                `<tr><td colspan="5" class="py-6 text-center text-gray-400">로딩 중...</td></tr>`;

            try {
                const res = await fetch(`/owner/orders?store_id=${storeId}`);
                const json = await res.json();

                if (!json.ok || !json.orders.length) {
                    tbody.innerHTML =
                        `<tr><td colspan="5" class="py-6 text-center text-gray-400">최근 주문이 없습니다.</td></tr>`;
                    return;
                }

                tbody.innerHTML = json.orders.map(o => `
          <tr class="border-b hover:bg-gray-50">
            <td class="py-2 px-3">#A${String(o.id).padStart(5, "0")}</td>
            <td class="py-2 px-3">${o.menu_label}</td>
            <td class="py-2 px-3">${formatPrice(o.total_price)}</td>
            <td class="py-2 px-3">${formatTime(o.created_at)}</td>
            <td class="py-2 px-3">${formatStatus(o.status)}</td>
          </tr>
        `).join("");
            } catch (err) {
                console.error("[loadRecentOrders]", err);
                tbody.innerHTML =
                    `<tr><td colspan="5" class="py-6 text-center text-red-500">주문 불러오기 실패</td></tr>`;
            }
        }

        // ✅ 페이지 로드시 실행
        window.addEventListener("DOMContentLoaded", async () => {
            await loadDashboard();
            await loadStats("weekly");
            await loadStoreInfo();
            await loadMenuList();
            await loadRecentOrders(); // ✅ 이 줄이 핵심
        });

        // ✅ 2. 기간별 그래프 불러오기
        async function loadStats(period = "weekly") {
            const res = await fetch(`/owner/stats?store_id=${storeId}&period=${period}`);
            const data = await res.json();
            if (data.ok) updateChart(data.data);
        }

        // ✅ Chart.js 차트 업데이트
        let chartInstance;
        function updateChart(rows) {
            const ctx = document.getElementById("statsChart");
            if (chartInstance) chartInstance.destroy();

            const labels = rows.map(r => r.label);
            const values = rows.map(r => r.total_sales);

            chartInstance = new Chart(ctx, {
                type: "line",
                data: {
                    labels,
                    datasets: [{
                        label: "매출 (천원)",
                        data: values,
                        borderColor: "#3B82F6",
                        backgroundColor: "rgba(59,130,246,0.15)",
                        tension: 0.4,
                        fill: true,
                    }]
                },
                options: { responsive: true, scales: { y: { beginAtZero: true } } }
            });
        }

        // ✅ 3. 가게 정보 불러오기
        async function loadStoreInfo() {
            const res = await fetch(`/owner/store?store_id=${storeId}`);
            const data = await res.json();
            if (data.ok && data.store) {
                document.querySelector("[name='storeAddress']").value = data.store.address || "";
                document.querySelector("[name='openHours']").value = data.store.open_hours || "";
                document.querySelector("[name='description']").value = data.store.description || "";
            }
        }

        // ✅ 4. 메뉴 목록 불러오기
        async function loadMenuList() {
            const res = await fetch(`/owner/menu?store_id=${storeId}`);
            const data = await res.json();
            const container = document.getElementById("menu-list");
            container.innerHTML = "";
            if (data.ok && data.menus.length) {
                data.menus.forEach(m => {
                    const div = document.createElement("div");
                    div.className = "p-4 bg-white rounded-xl shadow";
                    div.innerHTML = `
        <h3 class="font-bold">${m.name}</h3>
        <p class="text-gray-500">₩${Number(m.price).toLocaleString()}</p>
      `;
                    container.appendChild(div);
                });
            }
        }

        // ✅ 5. 기간 버튼 이벤트 연결
        document.querySelectorAll(".period-btn").forEach(btn => {
            btn.addEventListener("click", () => loadStats(btn.dataset.period));
        });

        // ✅ 메뉴 전환
        const links = document.querySelectorAll(".nav-link");
        const sections = document.querySelectorAll(".content-section");

        links.forEach(link => {
            link.addEventListener("click", (e) => {
                e.preventDefault();
                links.forEach(l => l.classList.remove("active-link"));
                link.classList.add("active-link");
                sections.forEach(sec => sec.classList.add("hidden-section"));
                document.getElementById(link.dataset.section).classList.remove("hidden-section");
            });
        });
        document.querySelector('[data-section="dashboard"]').classList.add("active-link");

        // ✅ 등록 관리 클릭 시 하위 메뉴 표시/숨기기
        document.querySelector('[data-section="register"]').addEventListener("click", (e) => {
            e.preventDefault();
            const submenu = document.getElementById("subRegisterMenu");
            submenu.classList.toggle("hidden");
        });

        // ✅ 하위 등록 메뉴 클릭 시 각 페이지로 이동
        const subLinks = document.querySelectorAll(".sub-link");
        subLinks.forEach(sub => {
            sub.addEventListener("click", e => {
                e.preventDefault();
                const target = sub.dataset.target;
                if (target === "foodregister") {
                    window.location.href = "/public2/foodregister.html";
                } else if (target === "ncombinedregister") {
                    window.location.href = "/public2/ncombinedregister.html";
                } else if (target === "hotblogregister") {
                    window.location.href = "/public2/hotblogregister.html";
                }
            });
        });



    </script>

</body>

</html>