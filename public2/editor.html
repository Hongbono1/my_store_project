<!doctype html>
<html lang="ko">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ì˜¤í”ˆ ë ˆì§€ìŠ¤í„° â€” ì—ë””í„° í¬í•¨</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* ê°„ë‹¨í•œ ì—ë””í„° ìŠ¤íƒ€ì¼ */
    .editor-toolbar button {
      @apply px-2 py-1 rounded hover:bg-gray-100;
    }

    .editor-toolbar .active {
      box-shadow: inset 0 -2px 0 0 #111827;
    }

    .editor-area {
      min-height: 220px;
      max-height: 700px;
      overflow: auto;
      padding: 1rem;
      border-radius: .5rem;
      border: 1px solid rgba(0, 0, 0, 0.08);
      background: white;
    }

    .editor-area img {
      max-width: 100%;
      height: auto;
      display: block;
      margin: .5rem 0;
    }

    /* ëª¨ë°”ì¼ì—ì„œ íˆ´ë°” ìŠ¤í¬ë¡¤ */
    .toolbar-scroll {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
  </style>
</head>

<body class="bg-slate-50 text-slate-800 p-6">
  <div class="max-w-4xl mx-auto">
    <h1 class="text-2xl font-semibold mb-4">ì˜¤í”ˆ ë ˆì§€ìŠ¤í„° â€” ì„¤ëª…(ì—ë””í„°)</h1>

    <!-- ê°„ë‹¨í•œ ì˜ˆì‹œ í¼: ê¸°ì¡´ register í¼ ì•ˆì— ì´ ë¶€ë¶„ì„ ë¼ì›Œë„£ìœ¼ì‹œë©´ ë©ë‹ˆë‹¤ -->
    <form id="openForm" class="space-y-4 bg-white p-6 rounded shadow-sm" method="post" action="/store"
      enctype="multipart/form-data">
      <!-- ë‹¤ë¥¸ ì…ë ¥ë“¤(ìƒí˜¸ëª…/ì£¼ì†Œ ë“±)ì€ ì›ë˜ëŒ€ë¡œ ìœ ì§€) -->
      <div>
        <label class="block text-sm font-medium mb-1">ìƒí˜¸ëª…</label>
        <input name="businessName" class="w-full border rounded px-3 py-2" placeholder="ê°€ê²Œëª…ì„ ì…ë ¥í•˜ì„¸ìš”" />
      </div>

      <!-- ---- ì„¤ëª… ì—ë””í„° ì„¹ì…˜ ---- -->
      <div>
        <label class="block text-sm font-medium mb-2">ê°€ê²Œ ì„¤ëª… / ì†Œê°œ</label>

        <!-- íˆ´ë°” -->
        <div class="editor-toolbar toolbar-scroll flex gap-1 items-center mb-2 border rounded bg-white p-2">
          <!-- ìŠ¤íƒ€ì¼ -->
          <button type="button" data-cmd="bold" title="êµµê²Œ (Ctrl+B)">B</button>
          <button type="button" data-cmd="italic" title="ê¸°ìš¸ì„ (Ctrl+I)"><em>I</em></button>
          <button type="button" data-cmd="underline" title="ë°‘ì¤„ (Ctrl+U)"><u>U</u></button>
          <button type="button" data-cmd="strikeThrough" title="ì·¨ì†Œì„ ">SÌ¶</button>

          <div class="border-l h-6 mx-2"></div>

          <!-- ì •ë ¬ -->
          <button type="button" data-cmd="justifyLeft" title="ì™¼ìª½ ì •ë ¬">âŸµ</button>
          <button type="button" data-cmd="justifyCenter" title="ê°€ìš´ë° ì •ë ¬">â‰¡</button>
          <button type="button" data-cmd="justifyRight" title="ì˜¤ë¥¸ìª½ ì •ë ¬">âŸ¶</button>

          <div class="border-l h-6 mx-2"></div>

          <!-- ë¦¬ìŠ¤íŠ¸ -->
          <button type="button" data-cmd="insertUnorderedList" title="ê¸€ë¨¸ë¦¬í‘œ">â€¢ ëª©ë¡</button>
          <button type="button" data-cmd="insertOrderedList" title="ë²ˆí˜¸ ëª©ë¡">1. ëª©ë¡</button>

          <div class="border-l h-6 mx-2"></div>

          <!-- í¬ê¸° -->
          <select id="fontSizeSelect" class="border rounded px-2 py-1 text-sm" title="ê¸€ì í¬ê¸°">
            <option value="">í¬ê¸°</option>
            <option value="14">ì‘ê²Œ (14px)</option>
            <option value="16">ê¸°ë³¸ (16px)</option>
            <option value="18">ì•½ê°„ í¼ (18px)</option>
            <option value="22">í¬ê²Œ (22px)</option>
            <option value="28">ì•„ì£¼ í¬ê²Œ (28px)</option>
          </select>

          <!-- ìƒ‰ìƒ -->
          <input id="colorPicker" type="color" class="w-9 h-9 p-0 border rounded ml-2" title="ê¸€ì ìƒ‰ìƒ" />

          <div class="border-l h-6 mx-2"></div>

          <!-- ë§í¬ -->
          <button type="button" id="createLinkBtn" title="ë§í¬ ì‚½ì…">ğŸ”— ë§í¬</button>

          <!-- ì´ë¯¸ì§€ ì—…ë¡œë“œ (íŒŒì¼ ì…ë ¥) -->
          <label class="flex items-center gap-2 cursor-pointer bg-gray-50 px-2 py-1 rounded border">
            <input id="imageInput" type="file" accept="image/*" multiple style="display:none" />
            <span>ğŸ–¼ ì´ë¯¸ì§€ ì¶”ê°€</span>
          </label>

          <div class="ml-auto text-xs text-gray-500">ì‘ì„± ì™„ë£Œ í›„ ì œì¶œ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì„¤ëª… HTMLê³¼ ì´ë¯¸ì§€ íŒŒì¼ì´ í•¨ê»˜ ì „ì†¡ë©ë‹ˆë‹¤.</div>
        </div>

        <!-- ì—ë””í„° ì˜ì—­ -->
        <div id="editor" class="editor-area" contenteditable="true" spellcheck="true"
          placeholder="ê°€ê²Œ ì†Œê°œê¸€ì„ ì‘ì„±í•˜ì„¸ìš”. (ì´ë¯¸ì§€ ì‚½ì… ê°€ëŠ¥)"></div>

        <!-- ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°(ì„ íƒ íŒŒì¼ ëª©ë¡) -->
        <div id="imageList" class="mt-2 grid grid-cols-3 gap-2"></div>

        <!-- ìˆ¨ì€ input: ì„œë²„ë¡œ ë³´ë‚¼ ì„¤ëª… HTML -->
        <textarea id="description" name="description" class="hidden"></textarea>
      </div>

      <!-- ë²„íŠ¼ -->
      <div class="flex gap-2">
        <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded shadow">ì €ì¥(ì œì¶œ)</button>
        <button type="button" id="clearBtn" class="px-4 py-2 bg-gray-100 rounded">ì´ˆê¸°í™”</button>
      </div>
    </form>
  </div>

  <script>
    (function () {
      const editor = document.getElementById('editor');
      const form = document.getElementById('openForm');
      const descriptionInput = document.getElementById('description');
      const imageInput = document.getElementById('imageInput');
      const imageList = document.getElementById('imageList');
      const fontSizeSelect = document.getElementById('fontSizeSelect');
      const colorPicker = document.getElementById('colorPicker');
      const createLinkBtn = document.getElementById('createLinkBtn');
      const clearBtn = document.getElementById('clearBtn');

      // ì„ íƒëœ ì´ë¯¸ì§€ íŒŒì¼ë“¤(íŒŒì¼ ê°ì²´)ì„ ì €ì¥í•´ì„œ submit ì‹œ FormDataì— ì¶”ê°€
      const selectedImages = [];

      // íˆ´ë°” ë²„íŠ¼ ì²˜ë¦¬ (data-cmd ì‚¬ìš©)
      document.querySelectorAll('[data-cmd]').forEach(btn => {
        btn.addEventListener('click', () => {
          const cmd = btn.getAttribute('data-cmd');
          // ì¼ë¶€ ëª…ë ¹ì€ value í•„ìš” ì—†ìŒ
          document.execCommand(cmd, false, null);
          editor.focus();
        });
      });

      // font size: ì§ì ‘ spanìœ¼ë¡œ ê°ì‹¸ì„œ ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ ì ìš©
      fontSizeSelect.addEventListener('change', e => {
        const size = e.target.value;
        if (!size) return;
        const html = `<span style="font-size: ${size}px;">` + getSelectionHtml() + '</span>';
        document.execCommand('insertHTML', false, html);
        fontSizeSelect.value = '';
        editor.focus();
      });

      // color picker
      colorPicker.addEventListener('input', e => {
        const color = e.target.value;
        if (!color) return;
        document.execCommand('foreColor', false, color);
        editor.focus();
      });

      // ë§í¬ ì‚½ì…
      createLinkBtn.addEventListener('click', () => {
        const url = prompt('ë§í¬ URLì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: https://example.com)');
        if (!url) return;
        // ì„ íƒ ì˜ì—­ì„ aíƒœê·¸ë¡œ ê°ì‹¸ê¸°
        document.execCommand('createLink', false, url);
        editor.focus();
      });

      // ì´ë¯¸ì§€ íŒŒì¼ ì„ íƒ -> ë¸Œë¼ìš°ì € ë¯¸ë¦¬ë³´ê¸° + ì—ë””í„°ì— ì´ë¯¸ì§€ ì‚½ì… + selectedImages ë°°ì—´ì— ì¶”ê°€
      imageInput.addEventListener('change', async (e) => {
        const files = Array.from(e.target.files || []);
        if (files.length === 0) return;
        for (const file of files) {
          // íŒŒì¼ìœ í˜• í™•ì¸
          if (!file.type.startsWith('image/')) continue;
          // ì¶”ê°€ ì €ì¥
          selectedImages.push(file);

          // ë¯¸ë¦¬ë³´ê¸° ì—˜ë¦¬ë¨¼íŠ¸
          const url = URL.createObjectURL(file);
          // ì—ë””í„°ì— ì´ë¯¸ì§€ ì‚½ì…
          document.execCommand('insertHTML', false, `<img src="${url}" alt="${escapeHtml(file.name)}" />`);

          // ë¦¬ìŠ¤íŠ¸ì— ì¸ë„¤ì¼(ì‚­ì œ ë²„íŠ¼ í¬í•¨)
          const card = document.createElement('div');
          card.className = 'relative border rounded overflow-hidden';
          card.innerHTML = `
            <img src="${url}" class="w-full h-24 object-cover" />
            <button type="button" class="absolute top-1 right-1 bg-white/80 rounded px-1 text-xs">ì‚­ì œ</button>
          `;
          const delBtn = card.querySelector('button');
          delBtn.addEventListener('click', () => {
            // ì—ë””í„° ë‚´ì— ê°™ì€ blob src ì´ë¯¸ì§€ ì œê±° (ê°„ë‹¨: ëª¨ë“  <img> ì¤‘ src===urlì´ë©´ ì œê±°)
            document.querySelectorAll('#editor img').forEach(img => {
              if (img.src === url) img.remove();
            });
            // selectedImagesì—ì„œ ì œê±°
            const idx = selectedImages.indexOf(file);
            if (idx > -1) selectedImages.splice(idx, 1);
            card.remove();
            URL.revokeObjectURL(url);
          });
          imageList.appendChild(card);
        }
        // reset input so same file can be reselected if needed
        e.target.value = '';
      });

      // Submit ì²˜ë¦¬: ì—ë””í„° HTMLì„ ìˆ¨ì€ textareaì— ë„£ê³  FormDataì— ì´ë¯¸ì§€ íŒŒì¼ë“¤ì„ ì¶”ê°€
      form.addEventListener('submit', (ev) => {
        // ê¸°ë³¸ ì œì¶œì„ ë§‰ê³  fetchë¡œ ë³´ë‚´ëŠ” ì˜ˆì‹œ(ì„ íƒ). í˜„ì¬ëŠ” í¼ ì œì¶œìœ¼ë¡œ ë™ì‘í•˜ì§€ë§Œ
        // FormDataì— descriptionImages[]ë¥¼ ì¶”ê°€í•˜ë ¤ë©´ fetchë¡œ ë³´ë‚´ëŠ” í¸ì´ ë‚«ìŠµë‹ˆë‹¤.
        // ì—¬ê¸°ì„œëŠ” ê¸°ë³¸ ë™ì‘ì„ ì‚¬ìš©í•˜ë˜, ì„¤ëª… HTMLì„ ë„£ê³ , 
        // ë§Œì•½ ì„œë²„ê°€ multipart/form-dataë¥¼ ê¸°ëŒ€í•˜ë©´ ì•„ë˜ ì˜ˆì‹œ fetch ì½”ë“œ ì£¼ì„ í•´ì œ í›„ ì‚¬ìš©í•˜ì„¸ìš”.

        // (1) description ì±„ìš°ê¸°
        descriptionInput.value = editor.innerHTML;

        // Option A: ê¸°ë³¸ í¼ ì œì¶œ(ë¸Œë¼ìš°ì €ê°€ FormData ìƒì„±í•´ì„œ ë³´ë‚¼ ë•Œ textarea í¬í•¨ë¨)
        // ë‹¨, ì´ë¯¸ ì„ íƒí•œ ì´ë¯¸ì§€ íŒŒì¼ë“¤ì„ ê¸°ë³¸ HTML form submitìœ¼ë¡œ ê°™ì´ ë³´ë‚´ë ¤ë©´
        // <input type="file" name="descriptionImages[]" multiple> ê°€ í•„ìš”í•©ë‹ˆë‹¤.
        // ìš°ë¦¬ëŠ” JSë¡œ íŒŒì¼ë“¤ì„ ë™ì ìœ¼ë¡œ ì¶”ê°€í•´ì„œ ë³´ë‚´ëŠ” ë°©ì‹(fetch ì‚¬ìš©)ì„ ê¶Œì¥í•©ë‹ˆë‹¤.
        // ì—¬ê¸°ì„œëŠ” fetch ë°©ì‹ìœ¼ë¡œ ë³´ë‚´ëŠ” ì½”ë“œë¡œ ëŒ€ì²´í•˜ì—¬ ì•ˆì „í•˜ê²Œ íŒŒì¼ ì „ì†¡í•©ë‹ˆë‹¤.

        ev.preventDefault();
        const fd = new FormData(form); // formì˜ ë‹¤ë¥¸ í•„ë“œë“¤ í¬í•¨
        // description ì´ë¯¸ ë“¤ì–´ ìˆìŒ (textarea)
        // add images
        selectedImages.forEach((file, idx) => {
          fd.append('descriptionImages[]', file, file.name);
        });

        // ì˜ˆì‹œ: fetchë¡œ ì „ì†¡
        fetch(form.action, {
          method: form.method || 'POST',
          body: fd
        })
          .then(async r => {
            if (!r.ok) {
              const text = await r.text();
              alert('ì „ì†¡ ì‹¤íŒ¨: ' + r.status + '\n' + text);
              console.error('ì„œë²„ ì‘ë‹µ', r, text);
            } else {
              alert('ì €ì¥ ì™„ë£Œ');
              // í•„ìš”ì‹œ ë¦¬ë‹¤ì´ë ‰íŠ¸
              // location.href = '/somewhere'
            }
          })
          .catch(err => {
            console.error(err);
            alert('ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          });
      });

      // ì´ˆê¸°í™” ë²„íŠ¼
      clearBtn.addEventListener('click', () => {
        if (!confirm('ì—ë””í„° ë‚´ìš©ì„ ì´ˆê¸°í™”í• ê¹Œìš”?')) return;
        editor.innerHTML = '';
        descriptionInput.value = '';
        selectedImages.length = 0;
        imageList.innerHTML = '';
      });

      // ìœ í‹¸: ì„ íƒëœ HTML ì–»ê¸°
      function getSelectionHtml() {
        let sel = window.getSelection();
        if (sel && sel.rangeCount) {
          let container = document.createElement("div");
          for (let i = 0, len = sel.rangeCount; i < len; ++i) {
            container.appendChild(sel.getRangeAt(i).cloneContents());
          }
          return container.innerHTML;
        }
        return '';
      }

      // escape HTML for alt text ì•ˆì „ ì²˜ë¦¬
      function escapeHtml(str) {
        return str.replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;').replaceAll('"', '&quot;');
      }

      // placeholder ë™ì‘ (ê°„ë‹¨)
      editor.addEventListener('focus', () => editor.classList.remove('placeholder'));
      editor.addEventListener('blur', () => editor.classList.remove('placeholder'));
    })();
  </script>
</body>

</html>