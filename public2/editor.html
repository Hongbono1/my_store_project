<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì•ˆì •í˜• í…ìŠ¤íŠ¸ ì—ë””í„° | MALL HANKOOK</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: Pretendard, system-ui, sans-serif;
    }

    .editor-toolbar button {
      @apply w-10 h-10 flex items-center justify-center border rounded-md bg-white shadow-sm hover:bg-gray-100 transition;
    }

    .editor-toolbar button.active {
      background-color: #2563eb;
      /* íŒŒë‘ */
      color: white;
    }

    .editor-area {
      min-height: 250px;
      border: 1px solid #ddd;
      border-radius: 0.5rem;
      padding: 1rem;
      background: white;
      overflow-y: auto;
    }

    .editor-area img {
      max-width: 100%;
      margin: 0.5rem 0;
    }

    /* ë°‘ì¤„ í•´ì œ ê°•í™” */
    .editor-area span[style*="text-decoration: none"] {
      text-decoration: none !important;
      text-decoration-line: none !important;
    }
  </style>
</head>

<body class="bg-slate-50 text-gray-800 p-6">
  <div class="max-w-3xl mx-auto bg-white p-5 rounded-lg shadow">
    <h1 class="text-2xl font-semibold mb-4 text-center">ì•ˆì •í˜• í…ìŠ¤íŠ¸ ì—ë””í„°</h1>

    <!-- íˆ´ë°” -->
    <div
      class="editor-toolbar flex flex-wrap items-center justify-center gap-4 mb-4 border p-3 rounded bg-gray-50 shadow-sm">
      <button id="boldBtn" title="êµµê²Œ"><span class="font-bold text-lg">B</span></button>
      <button id="underlineBtn" title="ë°‘ì¤„"><span class="underline text-lg">U</span></button>

      <div class="border-l h-6"></div>

      <select id="fontSizeSelect" class="border rounded px-2 py-1 text-sm">
        <option value="">ê¸€ì í¬ê¸°</option>
        <option value="14px">ì‘ê²Œ</option>
        <option value="16px">ë³´í†µ</option>
        <option value="20px">í¬ê²Œ</option>
        <option value="26px">ì•„ì£¼ í¬ê²Œ</option>
      </select>

      <input type="color" id="fontColor" class="border rounded w-8 h-8 p-0 cursor-pointer" title="ê¸€ì ìƒ‰ìƒ ì„ íƒ" />

      <div class="border-l h-6"></div>

      <label
        class="flex items-center gap-1 cursor-pointer bg-gray-100 border px-3 py-2 rounded-md hover:bg-gray-200 shadow-sm">
        <input id="imageInput" type="file" accept="image/*" hidden />
        <span>ğŸ–¼ ì´ë¯¸ì§€ ì‚½ì…</span>
      </label>

      <div class="flex items-center gap-2">
        <span class="text-xs text-gray-600">ë¬¸ë‹¨</span>
        <button data-textalign="left" title="ë¬¸ë‹¨ ì™¼ìª½ ì •ë ¬">â¬…ï¸</button>
        <button data-textalign="center" title="ë¬¸ë‹¨ ê°€ìš´ë° ì •ë ¬">â†”ï¸</button>
        <button data-textalign="right" title="ë¬¸ë‹¨ ì˜¤ë¥¸ìª½ ì •ë ¬">â¡ï¸</button>
      </div>

      <div class="border-l h-6"></div>

      <!-- ì´ë¯¸ì§€ ì •ë ¬ ì „ìš© ê·¸ë£¹ (ìƒˆë¡œ ì¶”ê°€) -->
      <div class="flex items-center gap-2">
        <span class="text-xs text-gray-600">ì´ë¯¸ì§€</span>
        <button data-imgalign="left" title="ì´ë¯¸ì§€ ì™¼ìª½ ì •ë ¬" class="w-8 h-8 flex items-center justify-center border rounded-md bg-white hover:bg-gray-100 shadow-sm">â¬…ï¸</button>
        <button data-imgalign="center" title="ì´ë¯¸ì§€ ê°€ìš´ë° ì •ë ¬" class="w-8 h-8 flex items-center justify-center border rounded-md bg-white hover:bg-gray-100 shadow-sm">â†”ï¸</button>
        <button data-imgalign="right" title="ì´ë¯¸ì§€ ì˜¤ë¥¸ìª½ ì •ë ¬" class="w-8 h-8 flex items-center justify-center border rounded-md bg-white hover:bg-gray-100 shadow-sm">â¡ï¸</button>
      </div>
    </div>

    <!-- ì—ë””í„° -->
    <div id="editor" class="editor-area" contenteditable="true" spellcheck="true">
    </div>

    <button id="saveBtn" class="mt-4 bg-indigo-600 text-white px-4 py-2 rounded">ì €ì¥</button>
    <textarea id="result" class="w-full mt-3 border rounded p-2 text-sm" rows="5"
      placeholder="ì €ì¥ëœ HTML ë¯¸ë¦¬ë³´ê¸°"></textarea>
  </div>

  <script>

    const editor = document.getElementById("editor");

    // 1) íˆ´ë°” í´ë¦­ ì‹œ ë²„íŠ¼ì— í•œí•´ì„œë§Œ í¬ì»¤ìŠ¤ ì´ë™ ë°©ì§€
    const toolbar = document.querySelector('.editor-toolbar');
    toolbar.addEventListener('mousedown', (e) => {
      const btn = e.target.closest('button');
      if (btn) e.preventDefault(); // select, input[color]ì—ëŠ” ì ìš© X
    });

    // íˆ´ë°” ë²„íŠ¼ì´ í¬ì»¤ìŠ¤ë¥¼ ë¹¼ì•—ì§€ ëª»í•˜ê²Œ(ìƒ‰ ì„ íƒê¸°ëŠ” ì˜ˆì™¸)
    document.querySelectorAll('.editor-toolbar button').forEach(btn => {
      btn.addEventListener('mousedown', e => e.preventDefault());
    });

    // 2) Selectionì´ ì—ë””í„° ë‚´ë¶€ì¼ ë•Œë§Œ ì €ì¥/ë³µì›
    // ì—ë””í„° ë‚´ë¶€ì¸ì§€ íŒë³„
    function isInEditor(node) {
      if (!node) return false;
      return node === editor || editor.contains(node);
    }

    // ì»¤ì„œ ì €ì¥
    let savedRange = null;
    function saveSelection() {
      const sel = window.getSelection();
      if (sel.rangeCount > 0) {
        const r = sel.getRangeAt(0);
        if (isInEditor(r.commonAncestorContainer)) {
          savedRange = r.cloneRange();
        }
      }
    }

    // ì»¤ì„œ ë³µì› (ì‹¤íŒ¨ ì‹œ ì—ë””í„° ëìœ¼ë¡œ ì´ë™)
    function restoreSelection() {
      const sel = window.getSelection();
      if (savedRange && isInEditor(savedRange.commonAncestorContainer)) {
        sel.removeAllRanges();
        sel.addRange(savedRange);
        return true;
      }
      placeCaretAtEnd(editor);
      return false;
    }

    function placeCaretAtEnd(el) {
      el.focus();
      const r = document.createRange();
      r.selectNodeContents(el);
      r.collapse(false);
      const s = window.getSelection();
      s.removeAllRanges();
      s.addRange(r);
      savedRange = r.cloneRange();
    }

    // B/U ë²„íŠ¼ ì‹œê°ì  í† ê¸€ì„ ìœ„í•œ ìƒíƒœ ê³„ì‚° í•¨ìˆ˜ë“¤
    function inEditor(node) {
      if (!node) return false;
      return node === editor || editor.contains(node);
    }
    function contextEl() {
      const sel = window.getSelection();
      if (!sel.rangeCount) return editor;
      
      const n = sel.anchorNode;
      if (!n) return editor;
      
      let el = (n.nodeType === 1) ? n : n.parentElement;
      
      // ì—ë””í„° ë‚´ë¶€ì˜ ê°€ì¥ ê°€ê¹Œìš´ ìŠ¤íƒ€ì¼ ìš”ì†Œ ì°¾ê¸°
      while (el && el !== editor) {
        if (el.style && (el.style.fontWeight || el.style.textDecoration)) {
          return el;
        }
        el = el.parentElement;
      }
      
      return editor;
    }
    function isBoldActiveAtCaret() {
      const el = getActualStyledElement();
      if (!el || el === editor) return false; // ì‹¤ì œ ìŠ¤íƒ€ì¼ ìš”ì†Œê°€ ì—†ìœ¼ë©´ false
      
      // ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ ë¨¼ì € í™•ì¸
      if (el.style.fontWeight) {
        const inlineWeight = el.style.fontWeight;
        return inlineWeight === 'bold' || parseInt(inlineWeight, 10) >= 600;
      }
      
      // ê³„ì‚°ëœ ìŠ¤íƒ€ì¼ í™•ì¸ (ë‹¨, ì‹¤ì œ ë‚´ìš©ì´ ìˆëŠ” ê²½ìš°ë§Œ)
      if (el.textContent.trim()) {
        const fw = window.getComputedStyle(el).fontWeight;
        const numWeight = parseInt(fw, 10);
        return fw === 'bold' || numWeight >= 600;
      }
      
      return false;
    }
    function isUnderlineActiveAtCaret() {
      const el = getActualStyledElement();
      if (!el || el === editor) return false; // ì‹¤ì œ ìŠ¤íƒ€ì¼ ìš”ì†Œê°€ ì—†ìœ¼ë©´ false
      
      // ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ ë¨¼ì € í™•ì¸
      if (el.style.textDecoration || el.style.textDecorationLine) {
        const inlineDecor = el.style.textDecoration || el.style.textDecorationLine || '';
        return inlineDecor.includes('underline');
      }
      
      // ê³„ì‚°ëœ ìŠ¤íƒ€ì¼ í™•ì¸ (ë‹¨, ì‹¤ì œ ë‚´ìš©ì´ ìˆëŠ” ê²½ìš°ë§Œ)
      if (el.textContent.trim()) {
        const td = window.getComputedStyle(el).textDecorationLine || '';
        return td.includes('underline');
      }
      
      return false;
    }
    function refreshToolbarState() {
      // ì‹¤ì œ í…ìŠ¤íŠ¸ê°€ ì„ íƒë˜ì—ˆê±°ë‚˜, ìŠ¤íƒ€ì¼ì´ ì ìš©ëœ ìš”ì†Œ ë‚´ë¶€ì— ì»¤ì„œê°€ ìˆì„ ë•Œë§Œ ìƒíƒœ ì—…ë°ì´íŠ¸
      const sel = window.getSelection();
      const boldBtn = document.getElementById('boldBtn');
      const underlineBtn = document.getElementById('underlineBtn');
      
      // ì„ íƒëœ í…ìŠ¤íŠ¸ê°€ ìˆê±°ë‚˜, ì‹¤ì œ ìŠ¤íƒ€ì¼ ìš”ì†Œ ë‚´ë¶€ì— ìˆì„ ë•Œë§Œ í™œì„±í™”
      if (sel.rangeCount > 0 && !sel.getRangeAt(0).collapsed) {
        // í…ìŠ¤íŠ¸ê°€ ì„ íƒëœ ê²½ìš°ì—ë§Œ ìƒíƒœ í™•ì¸
        isBoldActiveAtCaret() ? boldBtn.classList.add('active') : boldBtn.classList.remove('active');
        isUnderlineActiveAtCaret() ? underlineBtn.classList.add('active') : underlineBtn.classList.remove('active');
      } else {
        // ì»¤ì„œë§Œ ìˆëŠ” ê²½ìš°: ì‹¤ì œ ìŠ¤íƒ€ì¼ ìš”ì†Œ ë‚´ë¶€ì¸ì§€ í™•ì¸
        const contextEl = getActualStyledElement();
        if (contextEl && contextEl !== editor) {
          isBoldActiveAtCaret() ? boldBtn.classList.add('active') : boldBtn.classList.remove('active');
          isUnderlineActiveAtCaret() ? underlineBtn.classList.add('active') : underlineBtn.classList.remove('active');
        } else {
          // ë¹ˆ ì˜ì—­ì´ë©´ ë²„íŠ¼ ë¹„í™œì„±í™”
          boldBtn.classList.remove('active');
          underlineBtn.classList.remove('active');
        }
      }
    }
    
    // ì‹¤ì œ ìŠ¤íƒ€ì¼ì´ ì ìš©ëœ ìš”ì†Œë§Œ ë°˜í™˜ (ë¹ˆ ì˜ì—­ ì œì™¸)
    function getActualStyledElement() {
      const sel = window.getSelection();
      if (!sel.rangeCount) return null;
      
      const n = sel.anchorNode;
      if (!n) return null;
      
      let el = (n.nodeType === 1) ? n : n.parentElement;
      
      // ì‹¤ì œ ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ì´ë‚˜ ë‚´ìš©ì´ ìˆëŠ” ìš”ì†Œë§Œ ë°˜í™˜
      while (el && el !== editor) {
        if (el.style && (el.style.fontWeight || el.style.textDecoration) && el.textContent.trim()) {
          return el;
        }
        el = el.parentElement;
      }
      
      return null;
    }

    // selectionì´ ë°”ë€” ë•Œë§ˆë‹¤ ì €ì¥ & ìƒíƒœ ì—…ë°ì´íŠ¸ (ë””ë°”ìš´ìŠ¤ ì ìš©)
    let toolbarUpdateTimeout = null;
    document.addEventListener('selectionchange', () => {
      const sel = window.getSelection();
      if (document.activeElement === editor || inEditor(sel.anchorNode)) {
        saveSelection();
        
        // ë””ë°”ìš´ìŠ¤: ì—°ì†ëœ ì„ íƒ ë³€ê²½ ì‹œ ë§ˆì§€ë§‰ ê²ƒë§Œ ì²˜ë¦¬
        clearTimeout(toolbarUpdateTimeout);
        toolbarUpdateTimeout = setTimeout(() => {
          refreshToolbarState();
        }, 50); // 50ms ì§€ì—°
      }
    });

    // ì—ë””í„° ì´ë²¤íŠ¸ì— ì €ì¥ ì¶”ê°€
    editor.addEventListener('keyup', saveSelection);
    editor.addEventListener('mouseup', saveSelection);
    editor.addEventListener('input', saveSelection);
    editor.addEventListener('focus', saveSelection);

    // ì´ˆê¸° í¬ì»¤ìŠ¤ ë° íˆ´ë°” ìƒíƒœ ì„¤ì •
    window.addEventListener('load', () => {
      editor.focus();
      refreshToolbarState();
    });

    // 3) ì„ íƒì´ ì—†ì–´ë„(ì»¤ì„œë§Œ) ìŠ¤íƒ€ì¼ ì ìš©ë˜ê²Œ wrapSelection êµì²´
    function wrapSelection(styleObj = {}) {
      editor.focus();
      restoreSelection();

      const sel = window.getSelection();
      if (!sel.rangeCount) return;
      let range = sel.getRangeAt(0);

      // ì„ íƒì´ ì—†ì„ ë•Œ: ìŠ¤íƒ€ì¼ spanì„ ë§Œë“¤ê³  ì»¤ì„œë¥¼ ê·¸ ì•ˆìœ¼ë¡œ ì´ë™
      if (range.collapsed) {
        const span = document.createElement('span');
        Object.assign(span.style, styleObj);
        
        // ë°‘ì¤„ í•´ì œì˜ ê²½ìš° ë” ê°•ë ¥í•œ ì²˜ë¦¬
        if (styleObj.textDecoration === 'none') {
          span.style.textDecoration = 'none';
          span.style.textDecorationLine = 'none';
        }
        
        const zwsp = document.createTextNode('\u200B'); // zero-width space
        span.appendChild(zwsp);
        range.insertNode(span);

        // ì»¤ì„œë¥¼ span ë‚´ë¶€(zwsp ë’¤)ë¡œ ì´ë™ â†’ ì´í›„ íƒ€ì´í•‘ì— ìŠ¤íƒ€ì¼ ìœ ì§€
        range = document.createRange();
        range.setStart(zwsp, 1);
        range.collapse(true);
        sel.removeAllRanges();
        sel.addRange(range);
        savedRange = range.cloneRange();
        return;
      }

      // ì„ íƒì´ ìˆì„ ë•Œ: ì„ íƒ ë‚´ìš©ì„ ê°ì‹¸ê¸°
      const span = document.createElement('span');
      Object.assign(span.style, styleObj);
      
      // ë°‘ì¤„ í•´ì œì˜ ê²½ìš° ë” ê°•ë ¥í•œ ì²˜ë¦¬
      if (styleObj.textDecoration === 'none') {
        span.style.textDecoration = 'none';
        span.style.textDecorationLine = 'none';
      }
      
      const content = range.extractContents();
      span.appendChild(content);
      range.insertNode(span);

      // ì»¤ì„œë¥¼ span ë’¤ë¡œ ì´ë™
      range.setStartAfter(span);
      range.collapse(true);
      sel.removeAllRanges();
      sel.addRange(range);
      savedRange = range.cloneRange();
    }

    // Bold í† ê¸€: ë²„íŠ¼ í´ë¦­ ì‹œì—ë§Œ ì‘ë™ (ìë™ ì ìš© ë°©ì§€)
    document.getElementById("boldBtn").addEventListener("click", (e) => {
      // ì‹¤ì œ ì‚¬ìš©ì í´ë¦­ì¸ì§€ í™•ì¸ (ìë™ ì‹¤í–‰ ë°©ì§€)
      if (e.isTrusted) {
        if (isBoldActiveAtCaret()) {
          // í•´ì œ: ìƒì†ëœ boldë¥¼ ìƒì‡„
          wrapSelection({ fontWeight: "normal" });
        } else {
          // ì ìš©
          wrapSelection({ fontWeight: "bold" });
        }
        setTimeout(() => refreshToolbarState(), 10); // ì•½ê°„ì˜ ì§€ì—°ìœ¼ë¡œ ì•ˆì •ì„± í™•ë³´
      }
      editor.focus();
    });



    document.getElementById("underlineBtn").addEventListener("click", () => {
      // í˜„ì¬ ì»¤ì„œ/ì„ íƒ ìœ„ì¹˜ ê¸°ì¤€ìœ¼ë¡œ í† ê¸€
      if (isUnderlineActiveAtCaret()) {
        // í•´ì œ: ìƒì†ëœ underlineì„ ìƒì‡„
        wrapSelection({ textDecoration: "none" });
      } else {
        // ì ìš©
        wrapSelection({ textDecoration: "underline" });
      }
      refreshToolbarState();
      editor.focus();
    });

    // 4) í°íŠ¸/ìƒ‰/ì´ë¯¸ì§€ ì ìš© ì „ì— ë°˜ë“œì‹œ ë³µì›
    document.getElementById('fontSizeSelect').addEventListener('change', (e) => {
      const size = e.target.value;
      if (size) wrapSelection({ fontSize: size });
      e.target.value = '';
      editor.focus();
    });

    // í—¬í¼: ì„ íƒ/ì»¤ì„œì— ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ ì ìš© (ì„ íƒ ì—†ìœ¼ë©´ ì»¤ì„œì— span ìƒì„±)
    function applyInlineStyle(styleObj = {}) {
      editor.focus();
      restoreSelection();
      const sel = window.getSelection();
      if (!sel.rangeCount) return;
      let range = sel.getRangeAt(0);

      if (range.collapsed) {
        const span = document.createElement('span');
        Object.assign(span.style, styleObj);
        
        // ë°‘ì¤„ í•´ì œì˜ ê²½ìš° ë” ê°•ë ¥í•œ ì²˜ë¦¬
        if (styleObj.textDecoration === 'none') {
          span.style.textDecoration = 'none';
          span.style.textDecorationLine = 'none';
        }
        
        const zw = document.createTextNode('\u200B');
        span.appendChild(zw);
        range.insertNode(span);
        // ì»¤ì„œë¥¼ span ì•ˆì— ìœ ì§€ â†’ ì´í›„ íƒ€ì´í•‘ë„ ê°™ì€ ìŠ¤íƒ€ì¼
        range = document.createRange();
        range.setStart(zw, 1);
        range.collapse(true);
        sel.removeAllRanges(); sel.addRange(range);
        savedRange = range.cloneRange();
      } else {
        const span = document.createElement('span');
        Object.assign(span.style, styleObj);
        
        // ë°‘ì¤„ í•´ì œì˜ ê²½ìš° ë” ê°•ë ¥í•œ ì²˜ë¦¬
        if (styleObj.textDecoration === 'none') {
          span.style.textDecoration = 'none';
          span.style.textDecorationLine = 'none';
        }
        
        const frag = range.extractContents();
        span.appendChild(frag);
        range.insertNode(span);
        range.setStartAfter(span);
        range.collapse(true);
        sel.removeAllRanges(); sel.addRange(range);
        savedRange = range.cloneRange();
      }
    }

    // âœ… ê¸€ì ìƒ‰ìƒ: ì¦‰ì‹œ ì ìš©
    document.getElementById("fontColor").addEventListener("input", (e) => {
      applyInlineStyle({ color: e.target.value });
    });

    const imageInput = document.getElementById('imageInput');
    imageInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const url = URL.createObjectURL(file);
      const img = document.createElement('img');
      img.src = url;
      img.alt = file.name;
      img.style.display = 'block';
      img.style.margin = 'auto';

      editor.focus();
      restoreSelection();
      const sel = window.getSelection();
      if (!sel.rangeCount) return;
      const range = sel.getRangeAt(0);
      range.insertNode(img);

      // ì»¤ì„œë¥¼ ì´ë¯¸ì§€ ë’¤ë¡œ
      range.setStartAfter(img);
      range.collapse(true);
      sel.removeAllRanges();
      sel.addRange(range);
      savedRange = range.cloneRange();
    });

    // ë¬¸ë‹¨ ì •ë ¬ ë¡œì§
    function closestBlock(node) {
      if (!node) return editor;
      let el = (node.nodeType === 1 ? node : node.parentElement);
      while (el && el !== editor) {
        const disp = window.getComputedStyle(el).display;
        if (disp === 'block' || disp === 'list-item' || el.tagName === 'P' || el.tagName === 'DIV') return el;
        el = el.parentElement;
      }
      return editor; // ëª» ì°¾ìœ¼ë©´ ì—ë””í„°ì— ì ìš©
    }

    document.querySelectorAll("[data-textalign]").forEach(btn => {
      btn.addEventListener("click", () => {
        editor.focus();
        restoreSelection();
        const sel = window.getSelection();
        if (!sel.rangeCount) return;
        const range = sel.getRangeAt(0);
        const block = closestBlock(range.startContainer);
        block.style.textAlign = btn.dataset.textalign; // 'left' | 'center' | 'right'
      });
    });

    // ì´ë¯¸ì§€ ì„ íƒ ë° ì •ë ¬ ë¡œì§
    let selectedImage = null;

    // ì—ë””í„°ì—ì„œ ì´ë¯¸ì§€ í´ë¦­ ì‹œ í˜„ì¬ ì„ íƒ ì´ë¯¸ì§€ë¡œ ë“±ë¡
    editor.addEventListener('click', (e) => {
      selectedImage = (e.target && e.target.tagName === 'IMG') ? e.target : null;
    });

    // ì´ë¯¸ì§€ ì •ë ¬ ë²„íŠ¼ ë™ì‘
    document.querySelectorAll("[data-imgalign]").forEach(btn => {
      btn.addEventListener("click", () => {
        if (!selectedImage) return; // ì´ë¯¸ì§€ ì„ íƒ ì•ˆ í–ˆìœ¼ë©´ ë¬´ì‹œ
        const a = btn.dataset.imgalign;

        if (a === 'left') {
          selectedImage.style.float   = 'left';
          selectedImage.style.display = 'inline-block';
          selectedImage.style.margin  = '0 12px 8px 0';
        } else if (a === 'right') {
          selectedImage.style.float   = 'right';
          selectedImage.style.display = 'inline-block';
          selectedImage.style.margin  = '0 0 8px 12px';
        } else { // center
          selectedImage.style.float   = 'none';
          selectedImage.style.display = 'block';
          selectedImage.style.margin  = '8px auto';
        }
      });
    });

    // ì €ì¥
    document.getElementById("saveBtn").addEventListener("click", () => {
      document.getElementById("result").value = editor.innerHTML;
      alert("ì €ì¥ ì™„ë£Œ");
    });
  </script>
</body>

</html>