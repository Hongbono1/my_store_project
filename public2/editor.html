<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì•ˆì •í˜• ì—ë””í„° (ë¦¬ì…‹-ë¯¸ë‹ˆ)</title>
  <!-- ì›¹í°íŠ¸ ë¡œë“œ -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
  <link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@400;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: Pretendard, system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans KR', sans-serif
    }

    .editor {
      min-height: 360px
    }

    .editor:focus {
      outline: none
    }

    .btn {
      min-width: 2.25rem;
      height: 2.25rem
    }

    /* ë ˆì´ì•„ì›ƒ í”ë“¤ë¦¼ ë°©ì§€: outline ëŒ€ì‹  inset box-shadow */
    .btn.active {
      box-shadow: inset 0 0 0 2px rgb(59 130 246);
      background: #eff6ff !important;
      border-color: rgb(59 130 246) !important;
    }

    .swatch {
      width: 1.25rem;
      height: 1.25rem;
      border: 1px solid #e5e7eb;
      border-radius: .375rem;
      cursor: pointer;
      transition: transform 0.1s ease;
    }
    
    .swatch:hover {
      transform: scale(1.1);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .sep {
      width: 1px;
      height: 1.75rem;
      background: #e5e7eb
    }
  </style>
</head>

<body class="bg-slate-50 min-h-screen">
  <div class="max-w-4xl mx-auto p-4">
    <h1 class="text-xl font-bold mb-3">ì•ˆì •í˜• ì—ë””í„° (ë¦¬ì…‹-ë¯¸ë‹ˆ)</h1>

    <!-- Toolbar -->
    <div id="toolbar"
      class="sticky top-0 z-10 bg-white/80 backdrop-blur border rounded-xl shadow-sm p-2 flex flex-wrap items-center gap-2">
      <!-- í°íŠ¸/í¬ê¸° -->
      <div class="flex items-center gap-2">
        <label class="text-xs text-slate-500">ê¸€ê¼´</label>
        <div class="relative">
          <button id="fontNameBtn" class="h-9 px-3 border rounded-md bg-white hover:bg-slate-50 flex items-center gap-2">
            <span id="fontNameLabel">ê¸°ë³¸</span>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </button>
          <div id="fontNameMenu" class="absolute top-full left-0 mt-1 bg-white border rounded-md shadow-lg z-20 min-w-[160px] hidden">
            <button data-font="" class="w-full px-3 py-2 text-left hover:bg-slate-50 border-b border-slate-100">ê¸°ë³¸</button>
            <button data-font="Pretendard, sans-serif" class="w-full px-3 py-2 text-left hover:bg-slate-50 border-b border-slate-100" style="font-family: Pretendard, sans-serif">Pretendard</button>
            <button data-font="'Malgun Gothic', sans-serif" class="w-full px-3 py-2 text-left hover:bg-slate-50 border-b border-slate-100" style="font-family: 'Malgun Gothic', sans-serif">ë§‘ì€ ê³ ë”•</button>
            <button data-font="'Nanum Gothic', sans-serif" class="w-full px-3 py-2 text-left hover:bg-slate-50 border-b border-slate-100" style="font-family: 'Nanum Gothic', sans-serif">ë‚˜ëˆ”ê³ ë”•</button>
            <button data-font="Arial, sans-serif" class="w-full px-3 py-2 text-left hover:bg-slate-50 border-b border-slate-100" style="font-family: Arial, sans-serif">Arial</button>
            <button data-font="'Times New Roman', serif" class="w-full px-3 py-2 text-left hover:bg-slate-50" style="font-family: 'Times New Roman', serif">Times New Roman</button>
          </div>
        </div>
        <label class="text-xs text-slate-500">í¬ê¸°</label>
        <div class="relative">
          <button id="fontSizeBtn" class="h-9 px-3 border rounded-md bg-white hover:bg-slate-50 flex items-center gap-2">
            <span id="fontSizeLabel">ê¸°ë³¸(3)</span>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </button>
          <div id="fontSizeMenu" class="absolute top-full left-0 mt-1 bg-white border rounded-md shadow-lg z-20 min-w-[120px] hidden">
            <button data-size="1" class="w-full px-3 py-2 text-left hover:bg-slate-50 border-b border-slate-100 text-xs">1 (ë§¤ìš° ì‘ê²Œ)</button>
            <button data-size="2" class="w-full px-3 py-2 text-left hover:bg-slate-50 border-b border-slate-100 text-sm">2 (ì‘ê²Œ)</button>
            <button data-size="3" class="w-full px-3 py-2 text-left hover:bg-slate-50 border-b border-slate-100 text-base">3 (ê¸°ë³¸)</button>
            <button data-size="4" class="w-full px-3 py-2 text-left hover:bg-slate-50 border-b border-slate-100 text-lg">4 (í¬ê²Œ)</button>
            <button data-size="5" class="w-full px-3 py-2 text-left hover:bg-slate-50 border-b border-slate-100 text-xl">5 (ë” í¬ê²Œ)</button>
            <button data-size="6" class="w-full px-3 py-2 text-left hover:bg-slate-50 border-b border-slate-100 text-2xl">6 (ë§¤ìš° í¬ê²Œ)</button>
            <button data-size="7" class="w-full px-3 py-2 text-left hover:bg-slate-50 text-3xl">7 (ìµœëŒ€)</button>
          </div>
        </div>
      </div>

      <div class="sep" aria-hidden="true"></div>

      <!-- B I U S -->
      <div class="flex items-center gap-2">
        <button data-cmd="bold" class="btn border rounded-md bg-white hover:bg-slate-50 font-bold">B</button>
        <button data-cmd="italic" class="btn border rounded-md bg-white hover:bg-slate-50 italic">I</button>
        <button data-cmd="underline" class="btn border rounded-md bg-white hover:bg-slate-50 underline">U</button>
        <button data-cmd="strikeThrough"
          class="btn border rounded-md bg-white hover:bg-slate-50 line-through">S</button>
      </div>

      <div class="sep" aria-hidden="true"></div>

      <!-- Align / list / indent -->
      <div class="flex items-center gap-2">
        <button data-cmd="justifyLeft" class="btn border rounded-md bg-white hover:bg-slate-50">âŸ¸</button>
        <button data-cmd="justifyCenter" class="btn border rounded-md bg-white hover:bg-slate-50">â‡”</button>
        <button data-cmd="justifyRight" class="btn border rounded-md bg-white hover:bg-slate-50">âŸ¹</button>
        <button data-cmd="insertUnorderedList" class="btn border rounded-md bg-white hover:bg-slate-50">â€¢</button>
        <button data-cmd="insertOrderedList" class="btn border rounded-md bg-white hover:bg-slate-50">1.</button>
        <button data-cmd="outdent" class="btn border rounded-md bg-white hover:bg-slate-50">â‡¤</button>
        <button data-cmd="indent" class="btn border rounded-md bg-white hover:bg-slate-50">â‡¥</button>
      </div>

      <div class="sep" aria-hidden="true"></div>

      <!-- Color (simple palette) -->
      <div class="flex items-center gap-2">
        <span class="text-xs text-slate-500">ê¸€ì</span>
        <div id="forePalette" class="flex gap-1">
          <button class="swatch border-2" data-fore="remove" style="background:#ffffff; position:relative;" title="ê¸€ììƒ‰ ì œê±°">
            <span style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); color:#ef4444; font-weight:bold; font-size:10px;">Ã—</span>
          </button>
          <button class="swatch" data-fore="#000000" style="background:#000000" title="ê²€ì€ìƒ‰"></button>
          <button class="swatch" data-fore="#ef4444" style="background:#ef4444" title="ë¹¨ê°„ìƒ‰"></button>
          <button class="swatch" data-fore="#f59e0b" style="background:#f59e0b" title="ì£¼í™©ìƒ‰"></button>
          <button class="swatch" data-fore="#10b981" style="background:#10b981" title="ì´ˆë¡ìƒ‰"></button>
          <button class="swatch" data-fore="#3b82f6" style="background:#3b82f6" title="íŒŒë€ìƒ‰"></button>
          <button class="swatch" data-fore="#8b5cf6" style="background:#8b5cf6" title="ë³´ë¼ìƒ‰"></button>
          <button class="swatch" data-fore="#ec4899" style="background:#ec4899" title="ë¶„í™ìƒ‰"></button>
        </div>
        <span class="text-xs text-slate-500 ml-2">ë°°ê²½</span>
        <div id="backPalette" class="flex gap-1">
          <button class="swatch border-2" data-back="remove" style="background:#ffffff; position:relative;" title="ë°°ê²½ìƒ‰ ì œê±°">
            <span style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); color:#ef4444; font-weight:bold; font-size:10px;">Ã—</span>
          </button>
          <button class="swatch" data-back="#ffffff" style="background:#ffffff; border:1px solid #ccc;" title="í°ìƒ‰"></button>
          <button class="swatch" data-back="#fef3c7" style="background:#fef3c7" title="ì—°í•œ ë…¸ë€ìƒ‰"></button>
          <button class="swatch" data-back="#fee2e2" style="background:#fee2e2" title="ì—°í•œ ë¹¨ê°„ìƒ‰"></button>
          <button class="swatch" data-back="#dcfce7" style="background:#dcfce7" title="ì—°í•œ ì´ˆë¡ìƒ‰"></button>
          <button class="swatch" data-back="#e0e7ff" style="background:#e0e7ff" title="ì—°í•œ íŒŒë€ìƒ‰"></button>
          <button class="swatch" data-back="#f3e8ff" style="background:#f3e8ff" title="ì—°í•œ ë³´ë¼ìƒ‰"></button>
          <button class="swatch" data-back="#fdf2f8" style="background:#fdf2f8" title="ì—°í•œ ë¶„í™ìƒ‰"></button>
          <button class="swatch" data-back="#f0fdf4" style="background:#f0fdf4" title="ì—°í•œ ë¯¼íŠ¸ìƒ‰"></button>
        </div>
      </div>

      <div class="ml-auto flex items-center gap-2">
        <button id="linkBtn" class="btn border rounded-md bg-white hover:bg-slate-50" title="ë§í¬">ğŸ”—</button>
        <button id="clearBtn" class="btn border rounded-md bg-white hover:bg-slate-50" title="ì„œì‹ì œê±°">âš</button>
        <button id="undoBtn" class="btn border rounded-md bg-white hover:bg-slate-50" title="ë˜ëŒë¦¬ê¸°">â†¶</button>
        <button id="redoBtn" class="btn border rounded-md bg-white hover:bg-slate-50" title="ë‹¤ì‹œí•˜ê¸°">â†·</button>
      </div>
    </div>

    <!-- Editor -->
    <div id="editor" class="editor bg-white border rounded-xl shadow-sm p-4 mt-3" contenteditable="true">
      <p>ğŸ“ í•œê¸€ ì…ë ¥ + ìƒ‰ìƒ í…ŒìŠ¤íŠ¸:</p>
      <p>ğŸŒº ë¬´ê¶í™” ì‚¼ì²œë¦¬ í™”ë ¤ê°•ì‚° ëŒ€í•œì‚¬ëŒ ëŒ€í•œìœ¼ë¡œ ê¸¸ì´ ë³´ì „í•˜ì„¸</p>
      <p>1ï¸âƒ£ ìƒ‰ í´ë¦­ â†’ í•œê¸€ ì…ë ¥: <span style="color:#ef4444;">ì•ˆë…•í•˜ì„¸ìš”</span></p>
      <p>2ï¸âƒ£ í•œê¸€ ì…ë ¥ â†’ ì„ íƒ â†’ ìƒ‰ ë³€ê²½: <span style="background-color:#fef3c7;">ë¬´ê¶í™”ê½ƒì´í”¼ì—ˆìŠµë‹ˆë‹¤</span></p>
      <p>3ï¸âƒ£ í•œê¸€ ì…ë ¥ ë„ì¤‘ ìƒ‰ ë³€ê²½: ì•ˆë…•<span style="color:#3b82f6;">í•˜ì„¸ìš”</span></p>
    </div>

    <div id="status" class="mt-2 text-xs text-slate-500">Ready</div>
  </div>

  <script>
    (function () {
      const editor = document.getElementById('editor');
      const toolbar = document.getElementById('toolbar');
      const status = document.getElementById('status');
      const fontNameBtn = document.getElementById('fontNameBtn');
      const fontNameMenu = document.getElementById('fontNameMenu');
      const fontNameLabel = document.getElementById('fontNameLabel');
      const fontSizeBtn = document.getElementById('fontSizeBtn');
      const fontSizeMenu = document.getElementById('fontSizeMenu');
      const fontSizeLabel = document.getElementById('fontSizeLabel');

      // CSS ì¸ë¼ì¸ ì ìš© ê°•ì œ
      try { document.execCommand('styleWithCSS', false, true); } catch (_) { }

      // === Selection Keeper (íˆ´ë°” í´ë¦­ì—ë„ ì„ íƒ ìœ ì§€) ===
      let savedRange = null;
      function saveSelection() {
        const sel = window.getSelection();
        if (!sel.rangeCount) return;
        savedRange = sel.getRangeAt(0);
      }
      function restoreSelection() {
        if (!savedRange) return;
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(savedRange);
      }
      editor.addEventListener('keyup', (e) => {
        // í™”ì‚´í‘œ í‚¤ë¡œ ì»¤ì„œ ì´ë™ ì‹œì—ë§Œ ì˜ˆì•½ëœ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”
        if (['ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown', 'Home', 'End', 'PageUp', 'PageDown'].includes(e.key)) {
          pendingStyles = {};
          console.log('Cursor moved, cleared pending styles');
        }
        // Enter, Space, Backspace ë“±ì€ ìŠ¤íƒ€ì¼ ìœ ì§€
        saveSelection();
      });
      
      editor.addEventListener('mouseup', (e) => {
        // ë§ˆìš°ìŠ¤ í´ë¦­ìœ¼ë¡œ ë‹¤ë¥¸ ìœ„ì¹˜ë¡œ ì´ë™ ì‹œì—ë§Œ ì˜ˆì•½ëœ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”
        // íˆ´ë°” í´ë¦­ì€ ì œì™¸ (ì´ë¯¸ toolbar mousedownì—ì„œ preventDefault ì²˜ë¦¬ë¨)
        if (e.target === editor || editor.contains(e.target)) {
          setTimeout(() => {
            // í´ë¦­ ìœ„ì¹˜ì—ì„œ ê¸°ì¡´ ìŠ¤íƒ€ì¼ì„ ê°ì§€í•´ì„œ pendingStylesì— ë°˜ì˜
            const sel = window.getSelection();
            if (sel.rangeCount > 0) {
              const range = sel.getRangeAt(0);
              const currentElement = range.startContainer.nodeType === Node.TEXT_NODE 
                ? range.startContainer.parentElement 
                : range.startContainer;
              
              // í˜„ì¬ ìœ„ì¹˜ì˜ ìŠ¤íƒ€ì¼ì„ pendingStylesì— ë°˜ì˜
              if (currentElement && currentElement.tagName === 'SPAN') {
                pendingStyles = {};
                if (currentElement.style.color) pendingStyles.color = currentElement.style.color;
                if (currentElement.style.backgroundColor) pendingStyles.backgroundColor = currentElement.style.backgroundColor;
                console.log('Inherited styles from current position:', pendingStyles);
              } else {
                pendingStyles = {};
                console.log('Clicked on unstyled area, cleared pending styles');
              }
            }
          }, 10);
        }
        saveSelection();
      });
      
      document.addEventListener('selectionchange', () => {
        if (document.activeElement === editor || editor.contains(document.activeElement)) {
          saveSelection();
          updateState();
        }
      });

      // íˆ´ë°”ê°€ í¬ì»¤ìŠ¤ë¥¼ ëºì§€ ì•Šë„ë¡
      toolbar.addEventListener('mousedown', (e) => {
        const t = e.target.closest('button,select');
        if (!t) return;
        e.preventDefault();
        restoreSelection();
      });

      // ê³µí†µ ëª…ë ¹
      function doCmd(cmd, value = null) {
        restoreSelection();
        
        // execCommand ì‹¤í–‰
        document.execCommand(cmd, false, value);
        
        // ê°•ì œë¡œ ìƒíƒœ ì—…ë°ì´íŠ¸ (ì§€ì—° ì‹¤í–‰ìœ¼ë¡œ í™•ì‹¤í•˜ê²Œ)
        setTimeout(() => {
          updateState();
        }, 10);
        
        editor.focus();
      }

      // ë²„íŠ¼ í´ë¦­ ì²˜ë¦¬
      toolbar.addEventListener('click', (e) => {
        const btn = e.target.closest('button');
        if (!btn) return;

        const cmd = btn.dataset.cmd;
        if (cmd) { doCmd(cmd); return; }

        if (btn.id === 'linkBtn') {
          const url = prompt('ë§í¬ URL', 'https://');
          if (url) doCmd('createLink', url);
          return;
        }
        if (btn.id === 'clearBtn') {
          doCmd('removeFormat'); doCmd('unlink');
          return;
        }
        if (btn.id === 'undoBtn') { doCmd('undo'); return; }
        if (btn.id === 'redoBtn') { doCmd('redo'); return; }
      });

      // íŒ”ë ˆíŠ¸ (ê¸€ì/ë°°ê²½)
      document.getElementById('forePalette').addEventListener('click', (e) => {
        const target = e.target.closest('[data-fore]');
        if (!target) return;
        
        const color = target.getAttribute('data-fore');
        
        // í´ë¦­ íš¨ê³¼ì™€ ìƒíƒœ í‘œì‹œ
        target.style.transform = 'scale(0.9)';
        target.style.boxShadow = '0 0 0 2px #3b82f6';
        
        setTimeout(() => {
          target.style.transform = 'scale(1)';
          target.style.boxShadow = '';
        }, 150);
        
        if (color === 'remove') {
          // ê¸€ììƒ‰ ì œê±°
          removeInlineStyle('color');
          status.textContent = 'ê¸€ììƒ‰ ì œê±°ë¨';
        } else {
          // ê¸€ììƒ‰ ì ìš©
          applyInlineStyle('color', color);
          status.textContent = `ê¸€ììƒ‰ ì ìš©: ${color}`;
        }
        
        setTimeout(() => {
          updateState();
        }, 200);
      });
      document.getElementById('backPalette').addEventListener('click', (e) => {
        const target = e.target.closest('[data-back]');
        if (!target) return;
        
        const color = target.getAttribute('data-back');
        
        // í´ë¦­ íš¨ê³¼ì™€ ìƒíƒœ í‘œì‹œ
        target.style.transform = 'scale(0.9)';
        target.style.boxShadow = '0 0 0 2px #3b82f6';
        
        setTimeout(() => {
          target.style.transform = 'scale(1)';
          target.style.boxShadow = '';
        }, 150);
        
        if (color === 'remove') {
          // ë°°ê²½ìƒ‰ ì œê±°
          removeInlineStyle('backgroundColor');
          status.textContent = 'ë°°ê²½ìƒ‰ ì œê±°ë¨';
        } else {
          // ë°°ê²½ìƒ‰ ì ìš©
          applyInlineStyle('backgroundColor', color);
          status.textContent = `ë°°ê²½ìƒ‰ ì ìš©: ${color}`;
        }
        
        setTimeout(() => {
          updateState();
        }, 200);
      });

      // ê¸€ê¼´ ë²„íŠ¼ ë“œë¡­ë‹¤ìš´
      fontNameBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        fontNameMenu.classList.toggle('hidden');
      });

      // ê¸€ê¼´ ë©”ë‰´ í•­ëª© í´ë¦­
      fontNameMenu.addEventListener('click', (e) => {
        const fontBtn = e.target.closest('[data-font]');
        if (!fontBtn) return;
        
        const fontValue = fontBtn.getAttribute('data-font');
        const fontDisplay = fontBtn.textContent;
        
        // ë¼ë²¨ ì—…ë°ì´íŠ¸
        fontNameLabel.textContent = fontDisplay;
        
        // ê¸€ê¼´ ì ìš© - ì§ì ‘ì ì¸ ë°©ë²• ì‚¬ìš©
        if (fontValue) {
          // ì„ íƒ ì˜ì—­ ë³µì›
          restoreSelection();
          
          // ë” ê°•ë ¥í•œ í°íŠ¸ ì ìš© ë°©ë²•
          const sel = window.getSelection();
          if (sel.rangeCount > 0) {
            const range = sel.getRangeAt(0);
            
            if (range.collapsed) {
              // ì»¤ì„œë§Œ ìˆì„ ë•Œ: ì´í›„ íƒ€ì´í•‘ì— ì ìš©ë  span ìƒì„±
              const span = document.createElement('span');
              span.style.fontFamily = fontValue;
              span.appendChild(document.createTextNode('\u200B')); // zero-width space
              range.insertNode(span);
              
              // ì»¤ì„œë¥¼ span ì•ˆìœ¼ë¡œ ì´ë™
              const newRange = document.createRange();
              newRange.setStart(span.firstChild, 1);
              newRange.collapse(true);
              sel.removeAllRanges();
              sel.addRange(newRange);
            } else {
              // í…ìŠ¤íŠ¸ê°€ ì„ íƒëœ ê²½ìš°: ì„ íƒëœ í…ìŠ¤íŠ¸ë¥¼ spanìœ¼ë¡œ ê°ì‹¸ê¸°
              const span = document.createElement('span');
              span.style.fontFamily = fontValue;
              
              try {
                range.surroundContents(span);
              } catch {
                const contents = range.extractContents();
                span.appendChild(contents);
                range.insertNode(span);
              }
            }
          }
        } else {
          // ê¸°ë³¸ ê¸€ê¼´ë¡œ ë¦¬ì…‹ - í¬ë§· ì œê±°
          restoreSelection();
          document.execCommand('removeFormat', false, null);
        }
        
        // ë©”ë‰´ ë‹«ê¸°
        fontNameMenu.classList.add('hidden');
      });

      // ë©”ë‰´ ë°”ê¹¥ í´ë¦­ì‹œ ë‹«ê¸°
      document.addEventListener('click', () => {
        fontNameMenu.classList.add('hidden');
        fontSizeMenu.classList.add('hidden');
      });
      // ê¸€ê¼´ í¬ê¸° ë²„íŠ¼ ë“œë¡­ë‹¤ìš´
      fontSizeBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        fontSizeMenu.classList.toggle('hidden');
      });

      // ê¸€ê¼´ í¬ê¸° ë©”ë‰´ í•­ëª© í´ë¦­
      fontSizeMenu.addEventListener('click', (e) => {
        const sizeBtn = e.target.closest('[data-size]');
        if (!sizeBtn) return;
        
        const sizeValue = sizeBtn.getAttribute('data-size');
        const sizeDisplay = sizeBtn.textContent;
        
        // ë¼ë²¨ ì—…ë°ì´íŠ¸
        fontSizeLabel.textContent = sizeDisplay;
        
        // ê¸€ê¼´ í¬ê¸° ì ìš© - ì§ì ‘ì ì¸ ë°©ë²•
        restoreSelection();
        
        const sel = window.getSelection();
        if (sel.rangeCount > 0) {
          const range = sel.getRangeAt(0);
          
          // HTML font sizeë¥¼ í”½ì…€ í¬ê¸°ë¡œ ë³€í™˜ (ëŒ€ëµì ì¸ ë§¤í•‘)
          const sizeMap = {
            '1': '10px',
            '2': '13px', 
            '3': '16px',
            '4': '18px',
            '5': '24px',
            '6': '32px',
            '7': '48px'
          };
          
          const pixelSize = sizeMap[sizeValue] || '16px';
          
          if (range.collapsed) {
            // ì»¤ì„œë§Œ ìˆì„ ë•Œ: ì´í›„ íƒ€ì´í•‘ì— ì ìš©ë  span ìƒì„±
            const span = document.createElement('span');
            span.style.fontSize = pixelSize;
            span.appendChild(document.createTextNode('\u200B')); // zero-width space
            range.insertNode(span);
            
            // ì»¤ì„œë¥¼ span ì•ˆìœ¼ë¡œ ì´ë™
            const newRange = document.createRange();
            newRange.setStart(span.firstChild, 1);
            newRange.collapse(true);
            sel.removeAllRanges();
            sel.addRange(newRange);
          } else {
            // í…ìŠ¤íŠ¸ê°€ ì„ íƒëœ ê²½ìš°: ì„ íƒëœ í…ìŠ¤íŠ¸ë¥¼ spanìœ¼ë¡œ ê°ì‹¸ê¸°
            const span = document.createElement('span');
            span.style.fontSize = pixelSize;
            
            try {
              range.surroundContents(span);
            } catch {
              const contents = range.extractContents();
              span.appendChild(contents);
              range.insertNode(span);
            }
          }
        }
        
        // ë©”ë‰´ ë‹«ê¸°
        fontSizeMenu.classList.add('hidden');
      });

      // ë‹¨ì¶•í‚¤ Ctrl/âŒ˜ + B/I/U
      editor.addEventListener('keydown', (e) => {
        const meta = e.ctrlKey || e.metaKey;
        if (!meta) return;
        const k = e.key.toLowerCase();
        if (k === 'b') { e.preventDefault(); doCmd('bold'); }
        if (k === 'i') { e.preventDefault(); doCmd('italic'); }
        if (k === 'u') { e.preventDefault(); doCmd('underline'); }
      });

      // ì „ì—­ ìŠ¤íƒ€ì¼ ìƒíƒœ (ì»¤ì„œ ìœ„ì¹˜ì—ì„œ ì ìš©í•  ìŠ¤íƒ€ì¼)
      let pendingStyles = {};
      
      // IME ìƒíƒœ ì¶”ì 
      let isComposing = false;

      // ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ ì ìš© - ëª¨ë“  ì‹œë‚˜ë¦¬ì˜¤ ì§€ì›
      function applyInlineStyle(prop, value, allowNull) {
        restoreSelection();
        const sel = window.getSelection();
        if (!sel.rangeCount) return;
        
        const range = sel.getRangeAt(0);
        
        // ì‹œë‚˜ë¦¬ì˜¤ 2: ì„ íƒ ì˜ì—­ì´ ìˆëŠ” ê²½ìš° (íƒ€ì ë‹¤ ì¹˜ê³  ì„ íƒ í›„ ìƒ‰ ë³€ê²½)
        if (!range.collapsed) {
          const frag = range.extractContents();
          const span = document.createElement('span');
          if (value || allowNull) {
            if (value) span.style[prop] = value;
          }
          span.appendChild(frag);
          range.insertNode(span);

          // ì»¤ì„œë¥¼ span ë’¤ë¡œ ì´ë™í•˜ê³  ìŠ¤íƒ€ì¼ ì˜ˆì•½ë„ ì„¤ì •
          sel.removeAllRanges();
          const r = document.createRange();
          r.selectNodeContents(span);
          r.collapse(false);
          sel.addRange(r);
          
          // ì„ íƒ í›„ ìƒ‰ ë³€ê²½ì‹œì—ë„ ì´í›„ ì…ë ¥ì— ê°™ì€ ìƒ‰ ì ìš©ë˜ë„ë¡ ì˜ˆì•½
          if (value) {
            pendingStyles[prop] = value;
          } else if (allowNull) {
            delete pendingStyles[prop];
          }
          
          saveSelection();
          updateState();
          editor.focus();
          return;
        }
        
        // ì‹œë‚˜ë¦¬ì˜¤ 1,3: ì»¤ì„œë§Œ ìˆëŠ” ê²½ìš° (ìƒ‰ í´ë¦­ í›„ íƒ€ì OR íƒ€ì ë„ì¤‘ ìƒ‰ ë³€ê²½)
        if (value) {
          pendingStyles[prop] = value;
        } else if (allowNull) {
          delete pendingStyles[prop];
        }
        
        // í˜„ì¬ ì»¤ì„œê°€ ìŠ¤íƒ€ì¼ ìˆëŠ” span ì•ˆì— ìˆë‹¤ë©´ ê·¸ spanì„ ë¶„í• 
        const currentNode = range.startContainer;
        if (currentNode.nodeType === Node.TEXT_NODE && currentNode.parentElement.tagName === 'SPAN') {
          const span = currentNode.parentElement;
          const offset = range.startOffset;
          
          if (offset > 0) {
            // í…ìŠ¤íŠ¸ê°€ ìˆëŠ” ê²½ìš° ë¶„í• 
            const beforeText = currentNode.textContent.substring(0, offset);
            const afterText = currentNode.textContent.substring(offset);
            
            // ì´ì „ ë¶€ë¶„
            const beforeSpan = span.cloneNode(false);
            beforeSpan.textContent = beforeText;
            
            // ì´í›„ ë¶€ë¶„ì€ ìƒˆë¡œìš´ ìŠ¤íƒ€ì¼ë¡œ
            const afterSpan = document.createElement('span');
            Object.keys(pendingStyles).forEach(key => {
              afterSpan.style[key] = pendingStyles[key];
            });
            afterSpan.textContent = afterText;
            
            // DOM êµì²´
            span.parentNode.insertBefore(beforeSpan, span);
            span.parentNode.insertBefore(afterSpan, span);
            span.parentNode.removeChild(span);
            
            // ì»¤ì„œë¥¼ afterSpanì˜ ì‹œì‘ìœ¼ë¡œ ì´ë™
            const newRange = document.createRange();
            newRange.setStart(afterSpan.firstChild || afterSpan, 0);
            newRange.collapse(true);
            sel.removeAllRanges();
            sel.addRange(newRange);
            saveSelection();
          }
        }
        
        updateState();
        editor.focus();
      }

      // ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ ì œê±°
      function removeInlineStyle(prop) {
        restoreSelection();
        const sel = window.getSelection();
        if (!sel.rangeCount) return;
        
        const range = sel.getRangeAt(0);
        
        // ì„ íƒ ì˜ì—­ì´ ì—†ëŠ” ê²½ìš°: ì˜ˆì•½ëœ ìŠ¤íƒ€ì¼ì—ì„œ ì œê±°
        if (range.collapsed) {
          delete pendingStyles[prop];
          updateState();
          editor.focus();
          return;
        }

        // ì„ íƒëœ í…ìŠ¤íŠ¸ì˜ ë¶€ëª¨ ìš”ì†Œë“¤ì„ ì°¾ì•„ì„œ í•´ë‹¹ ìŠ¤íƒ€ì¼ ì œê±°
        const fragment = range.extractContents();
        const walker = document.createTreeWalker(
          fragment,
          NodeFilter.SHOW_ELEMENT,
          null,
          false
        );

        const elementsToProcess = [];
        let node;
        while (node = walker.nextNode()) {
          elementsToProcess.push(node);
        }

        // ìŠ¤íƒ€ì¼ ì œê±° ì²˜ë¦¬
        elementsToProcess.forEach(el => {
          if (el.style && el.style[prop]) {
            el.style.removeProperty(prop);
            // ìŠ¤íƒ€ì¼ì´ ì—†ìœ¼ë©´ span íƒœê·¸ ì œê±°
            if (el.tagName === 'SPAN' && !el.style.cssText && !el.className) {
              const parent = el.parentNode;
              while (el.firstChild) {
                parent.insertBefore(el.firstChild, el);
              }
              if (parent) parent.removeChild(el);
            }
          }
        });

        range.insertNode(fragment);
        sel.removeAllRanges();
        sel.addRange(range);
        saveSelection();
        updateState();
        editor.focus();
      }

      // ìƒíƒœ/í† ê¸€ ì—…ë°ì´íŠ¸ - ë…ë¦½ì ì¸ ë‹¤ì¤‘ ì„œì‹ ì§€ì›
      function updateState() {
        const sel = window.getSelection();
        let bold = false, italic = false, underline = false, strikeThrough = false;
        
        // 1. queryCommandStateë¡œ ê¸°ë³¸ í™•ì¸
        try {
          bold = document.queryCommandState('bold');
          italic = document.queryCommandState('italic');  
          underline = document.queryCommandState('underline');
          strikeThrough = document.queryCommandState('strikeThrough');
        } catch (e) {
          console.log('queryCommandState error:', e);
        }
        
        // 2. DOM ì§ì ‘ ê²€ì‚¬ë¡œ ë³´ì™„ - ë” ì •í™•í•œ ë‹¤ì¤‘ ì„œì‹ ê°ì§€
        if (sel.rangeCount > 0) {
          const range = sel.getRangeAt(0);
          let node = range.commonAncestorContainer;
          if (node.nodeType === 3) node = node.parentNode; // í…ìŠ¤íŠ¸ ë…¸ë“œë©´ ë¶€ëª¨ë¡œ
          
          // ë¶€ëª¨ ë…¸ë“œë“¤ì„ íƒìƒ‰í•˜ë©´ì„œ ìŠ¤íƒ€ì¼ í™•ì¸
          while (node && node !== editor && node !== document.body) {
            if (node.nodeType === 1) { // ELEMENT_NODE
              const computedStyle = window.getComputedStyle(node);
              const tagName = node.tagName;
              
              // êµµê²Œ ê²€ì‚¬
              if (!bold && (tagName === 'B' || tagName === 'STRONG' || 
                  computedStyle.fontWeight === 'bold' || 
                  parseInt(computedStyle.fontWeight) >= 700)) {
                bold = true;
              }
              
              // ê¸°ìš¸ì„ ê²€ì‚¬  
              if (!italic && (tagName === 'I' || tagName === 'EM' || 
                  computedStyle.fontStyle === 'italic')) {
                italic = true;
              }
              
              // ë°‘ì¤„ ê²€ì‚¬
              if (!underline && (tagName === 'U' || 
                  computedStyle.textDecoration.includes('underline'))) {
                underline = true;
              }
              
              // ì·¨ì†Œì„  ê²€ì‚¬
              if (!strikeThrough && (tagName === 'S' || tagName === 'STRIKE' || 
                  computedStyle.textDecoration.includes('line-through'))) {
                strikeThrough = true;
              }
            }
            node = node.parentNode;
          }
        }

        // 3. ìƒíƒœ ë§µ êµ¬ì„±
        const map = {
          bold, italic, underline, strikeThrough,
          justifyLeft: document.queryCommandState('justifyLeft'),
          justifyCenter: document.queryCommandState('justifyCenter'),
          justifyRight: document.queryCommandState('justifyRight'),
          insertOrderedList: document.queryCommandState('insertOrderedList'),
          insertUnorderedList: document.queryCommandState('insertUnorderedList'),
        };
        
        // 4. ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸ - ì‹œê°ì ìœ¼ë¡œ ëª…í™•í•˜ê²Œ
        toolbar.querySelectorAll('[data-cmd]').forEach(btn => {
          const cmd = btn.dataset.cmd;
          if (map[cmd]) {
            btn.classList.add('active');
            btn.classList.add('bg-blue-200', 'border-blue-400');
            btn.classList.remove('hover:bg-gray-100');
          } else {
            btn.classList.remove('active');
            btn.classList.remove('bg-blue-200', 'border-blue-400');
            btn.classList.add('hover:bg-gray-100');
          }
        });
        
        // 5. ìƒíƒœ í‘œì‹œ - ë‹¤ì¤‘ ì„ íƒ ìƒíƒœë¥¼ ëª…í™•í•˜ê²Œ í‘œì‹œ
        const activeFormats = [];
        if (map.bold) activeFormats.push('êµµê²Œ');
        if (map.italic) activeFormats.push('ê¸°ìš¸ì„');
        if (map.underline) activeFormats.push('ë°‘ì¤„');
        if (map.strikeThrough) activeFormats.push('ì·¨ì†Œì„ ');
        
        // ì˜ˆì•½ëœ ìŠ¤íƒ€ì¼ í‘œì‹œ
        const pendingFormats = [];
        if (pendingStyles.color) pendingFormats.push('ê¸€ì:' + pendingStyles.color);
        if (pendingStyles.backgroundColor) pendingFormats.push('ë°°ê²½:' + pendingStyles.backgroundColor);
        
        let statusText = '';
        if (activeFormats.length > 0) {
          statusText += 'ì„œì‹: ' + activeFormats.join('+');
        }
        if (pendingFormats.length > 0) {
          if (statusText) statusText += ' | ';
          statusText += 'ì…ë ¥ìƒ‰ìƒ: ' + pendingFormats.join('+');
        }
        if (!statusText) {
          statusText = 'ì„œì‹ ì—†ìŒ';
        }
        
        status.textContent = statusText;
      }

      // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ ì§€ì›
      editor.addEventListener('keydown', (e) => {
        if (e.ctrlKey || e.metaKey) {
          switch (e.key.toLowerCase()) {
            case 'b':
              e.preventDefault();
              doCmd('bold');
              break;
            case 'i':
              e.preventDefault();
              doCmd('italic');
              break;
            case 'u':
              e.preventDefault();
              doCmd('underline');
              break;
            case 's':
              e.preventDefault();
              doCmd('strikeThrough');
              break;
            case 'z':
              if (e.shiftKey) {
                e.preventDefault();
                doCmd('redo');
              } else {
                e.preventDefault();
                doCmd('undo');
              }
              break;
          }
        }
      });

      // ì…ë ¥ ì „ ìŠ¤íƒ€ì¼ ì ìš© (beforeinput) - IME í˜¸í™˜ ë²„ì „
      editor.addEventListener('beforeinput', (e) => {
        console.log('beforeinput event:', e.inputType, e.data, 'isComposing:', isComposing, 'pendingStyles:', pendingStyles);
        
        // IME ì¡°í•© ì¤‘ì´ë©´ ì²˜ë¦¬í•˜ì§€ ì•ŠìŒ (í•œê¸€, ì¼ë³¸ì–´, ì¤‘êµ­ì–´ ë“±)
        if (isComposing || e.inputType === 'insertCompositionText') {
          console.log('Skipping beforeinput during IME composition');
          return;
        }
        
        if (e.inputType === 'insertText') {
          // ì˜ˆì•½ëœ ìŠ¤íƒ€ì¼ì´ ìˆê±°ë‚˜, í˜„ì¬ ìœ„ì¹˜ì˜ ìŠ¤íƒ€ì¼ê³¼ ë‹¤ë¥¸ ê²½ìš° ì²˜ë¦¬
          const sel = window.getSelection();
          if (!sel.rangeCount) return;
          
          const range = sel.getRangeAt(0);
          const hasNewStyles = Object.keys(pendingStyles).length > 0;
          
          if (hasNewStyles) {
            e.preventDefault();
            
            // í˜„ì¬ ì»¤ì„œê°€ ì–´ë””ì— ìˆëŠ”ì§€ í™•ì¸
            let insertPoint = range.startContainer;
            let insertOffset = range.startOffset;
            
            // í…ìŠ¤íŠ¸ ë…¸ë“œê°€ ì•„ë‹Œ ê²½ìš° ì²˜ë¦¬
            if (insertPoint.nodeType !== Node.TEXT_NODE) {
              // ë¹ˆ í…ìŠ¤íŠ¸ ë…¸ë“œ ìƒì„±í•´ì„œ ì‚½ì…ì  ë§Œë“¤ê¸°
              const textNode = document.createTextNode('');
              if (insertPoint.childNodes[insertOffset]) {
                insertPoint.insertBefore(textNode, insertPoint.childNodes[insertOffset]);
              } else {
                insertPoint.appendChild(textNode);
              }
              insertPoint = textNode;
              insertOffset = 0;
            }
            
            // ìƒˆë¡œìš´ ìŠ¤íƒ€ì¼ span ìƒì„±
            const span = document.createElement('span');
            Object.keys(pendingStyles).forEach(prop => {
              span.style[prop] = pendingStyles[prop];
              console.log('Applied ' + prop + ': ' + pendingStyles[prop] + ' to new span');
            });
            
            // ì…ë ¥ í…ìŠ¤íŠ¸ë¥¼ spanì— ì¶”ê°€
            span.textContent = e.data || '';
            
            // í˜„ì¬ í…ìŠ¤íŠ¸ ë…¸ë“œë¥¼ ë¶„í• í•˜ê³  span ì‚½ì…
            if (insertPoint.nodeType === Node.TEXT_NODE) {
              const beforeText = insertPoint.textContent.substring(0, insertOffset);
              const afterText = insertPoint.textContent.substring(insertOffset);
              
              // ì´ì „ í…ìŠ¤íŠ¸
              if (beforeText) {
                insertPoint.textContent = beforeText;
                insertPoint.parentNode.insertBefore(span, insertPoint.nextSibling);
              } else {
                insertPoint.parentNode.insertBefore(span, insertPoint);
                insertPoint.parentNode.removeChild(insertPoint);
              }
              
              // ì´í›„ í…ìŠ¤íŠ¸
              if (afterText) {
                const afterNode = document.createTextNode(afterText);
                insertPoint.parentNode.insertBefore(afterNode, span.nextSibling);
              }
            } else {
              range.insertNode(span);
            }
            
            // ì»¤ì„œë¥¼ span ë’¤ë¡œ ì´ë™ (ë‹¤ìŒ ì…ë ¥ë„ ê°™ì€ ìŠ¤íƒ€ì¼ë¡œ ê³„ì†)
            const newRange = document.createRange();
            newRange.setStartAfter(span);
            newRange.collapse(true);
            sel.removeAllRanges();
            sel.addRange(newRange);
            
            saveSelection();
            console.log('Styled text inserted with new system:', span);
          }
        }
      });

      // IME ì¡°í•© ì‹œì‘/ì§„í–‰/ì¢…ë£Œ ì¶”ì 
      editor.addEventListener('compositionstart', () => {
        isComposing = true;
        console.log('IME composition started');
      });
      
      editor.addEventListener('compositionupdate', (e) => {
        isComposing = true;
        console.log('IME composition updating:', e.data);
      });
      
      editor.addEventListener('compositionend', (e) => {
        console.log('IME composition ended:', e.data);
        
        // ì¡°í•© ì™„ë£Œ í›„ ìŠ¤íƒ€ì¼ ì ìš©
        if (Object.keys(pendingStyles).length > 0 && e.data) {
          setTimeout(() => {
            applyPendingStylesToComposedText(e.data);
            isComposing = false; // ìŠ¤íƒ€ì¼ ì ìš© í›„ ìƒíƒœ ë³€ê²½
          }, 10);
        } else {
          isComposing = false;
        }
      });

      // ì…ë ¥ í›„ ìƒíƒœ ì—…ë°ì´íŠ¸
      editor.addEventListener('input', () => {
        setTimeout(updateState, 50);
      });

      // IME ì¡°í•© ì™„ë£Œ í›„ ìŠ¤íƒ€ì¼ ì ìš©
      function applyPendingStylesToComposedText(composedText) {
        const sel = window.getSelection();
        if (!sel.rangeCount || Object.keys(pendingStyles).length === 0) return;
        
        console.log('Applying pending styles to composed text:', composedText, pendingStyles);
        
        // ë°©ê¸ˆ ì…ë ¥ëœ í…ìŠ¤íŠ¸ ì°¾ê¸°
        const range = sel.getRangeAt(0);
        const textLength = composedText.length;
        
        try {
          // ì»¤ì„œ ì•ì˜ í…ìŠ¤íŠ¸ê°€ ì¡°í•©ëœ í…ìŠ¤íŠ¸ì™€ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸
          range.setStart(range.endContainer, Math.max(0, range.endOffset - textLength));
          
          const selectedText = range.toString();
          if (selectedText === composedText) {
            // í…ìŠ¤íŠ¸ë¥¼ ì¶”ì¶œí•˜ê³  ìŠ¤íƒ€ì¼ ì ìš©
            const fragment = range.extractContents();
            const span = document.createElement('span');
            
            Object.keys(pendingStyles).forEach(prop => {
              span.style[prop] = pendingStyles[prop];
            });
            
            span.appendChild(fragment);
            range.insertNode(span);
            
            // ì»¤ì„œë¥¼ span ë’¤ë¡œ ì´ë™
            range.setStartAfter(span);
            range.collapse(true);
            sel.removeAllRanges();
            sel.addRange(range);
            
            saveSelection();
            console.log('Successfully applied styles to composed text');
          }
        } catch (e) {
          console.log('Could not apply styles to composed text:', e);
        }
      }

      // ì´ˆê¸°í™”
      editor.focus();
      saveSelection();
      updateState();
    })();
  </script>
</body>

</html>