<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ë¬¸ì˜ ìƒì„¸ | MALL HANKOOK</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: Pretendard, system-ui, -apple-system, BlinkMacSystemFont,
                "Segoe UI", Roboto, "Noto Sans KR", sans-serif;
        }

        .neo-card {
            background: radial-gradient(circle at 0 0, rgba(255, 255, 255, 0.9), rgba(248, 250, 252, 0.9));
            box-shadow:
                12px 12px 30px rgba(15, 23, 42, 0.18),
                -10px -10px 25px rgba(255, 255, 255, 0.9);
        }

        .glass-badge {
            backdrop-filter: blur(12px);
            background: linear-gradient(135deg, rgba(129, 140, 248, 0.18), rgba(56, 189, 248, 0.18));
            border: 1px solid rgba(255, 255, 255, 0.7);
        }
    </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-slate-50 via-sky-50 to-indigo-100">
    <div class="max-w-5xl mx-auto px-4 py-10">
        <!-- ìƒë‹¨ íƒ€ì´í‹€ -->
        <header class="mb-8">
            <h1 class="text-2xl sm:text-3xl font-extrabold text-slate-900 tracking-tight">
                ë¬¸ì˜ ìƒì„¸
            </h1>
            <p class="text-sm sm:text-base text-slate-500 mt-1">
                ê³ ê°ë‹˜ì´ ë‚¨ê²¨ì£¼ì‹  ë¬¸ì˜ì™€ ë‹µë³€ ë‚´ìš©ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </p>
        </header>

        <!-- ì—ëŸ¬/ì•Œë¦¼ ì˜ì—­ -->
        <div id="messageBox" class="mb-4 hidden">
            <div id="messageInner" class="px-4 py-3 rounded-2xl text-sm font-medium border glass-badge text-slate-800">
            </div>
        </div>

        <!-- ë©”ì¸ ì¹´ë“œ -->
        <main id="detailContainer"
            class="neo-card rounded-3xl border border-white/70 shadow-xl p-6 sm:p-8 flex flex-col gap-6 sm:gap-8">

            <!-- ìƒë‹¨ ë©”íƒ€ ì •ë³´ -->
            <section class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
                <div>
                    <div class="flex items-center gap-2 mb-2">
                        <span id="badgeType"
                            class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold text-indigo-700 bg-indigo-50 border border-indigo-100">
                            ë¬¸ì˜ ìœ í˜•
                        </span>
                        <span id="badgeId"
                            class="inline-flex items-center px-3 py-1 rounded-full text-[11px] font-medium text-slate-500 bg-white/70 border border-slate-100">
                            # -
                        </span>
                    </div>
                    <h2 id="titleText" class="text-xl sm:text-2xl font-bold text-slate-900">
                        ë¡œë”© ì¤‘ì…ë‹ˆë‹¤...
                    </h2>
                    <p id="metaLine" class="text-xs sm:text-sm text-slate-500 mt-1">
                        &nbsp;
                    </p>
                    <div id="subMetaLine"
                        class="flex flex-wrap gap-x-10 gap-y-1 text-sm sm:text-base text-slate-500 mt-4">
                    </div>
                </div>
            </section>

            <hr class="border-slate-200/70" />

            <!-- ë¬¸ì˜ ë‚´ìš© -->
            <section class="flex flex-col gap-4">
                <h3 class="text-sm font-semibold text-slate-500 tracking-wide">
                    ë¬¸ì˜ ë‚´ìš©
                </h3>
                <div id="contentBox"
                    class="rounded-2xl bg-white/80 border border-slate-100 px-4 py-3 sm:px-5 sm:py-4 text-sm sm:text-base text-slate-800 leading-relaxed whitespace-pre-line min-h-[120px]">
                </div>
            </section>

            <!-- ì²¨ë¶€ ì´ë¯¸ì§€ -->
            <section id="imageSection" class="flex flex-col gap-4 hidden">
                <h3 class="text-sm font-semibold text-slate-500 tracking-wide">
                    ì²¨ë¶€ ì´ë¯¸ì§€
                </h3>
                <div id="imageBox" class="rounded-2xl bg-white/80 border border-slate-100 px-3 py-3 sm:px-4 sm:py-4">
                    <div id="imageGrid" class="flex flex-wrap gap-3">
                        <!-- ì´ë¯¸ì§€ë“¤ì´ ê°€ë¡œë¡œ ë°°ì¹˜ë¨ -->
                    </div>
                </div>
            </section>

            <hr class="border-slate-200/70" />

            <!-- ë‹µë³€ ì˜ì—­ -->
            <section class="flex flex-col gap-3">
                <h3 class="text-sm font-semibold text-slate-500 tracking-wide">
                    ë‹µë³€
                </h3>
                <div id="answerBox"
                    class="rounded-2xl bg-slate-900 text-slate-50/95 px-4 py-3 sm:px-5 sm:py-4 text-sm sm:text-base leading-relaxed shadow-lg shadow-slate-900/20">
                    <p id="answerText" class="whitespace-pre-line">
                        ì•„ì§ ë‹´ë‹¹ìê°€ ë‹µë³€ì„ ì‘ì„±í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë¹ ë¥¸ ì‹œì¼ ë‚´ì— ë‹µë³€ë“œë¦´ê²Œìš”.
                    </p>
                    <p id="answeredAtText" class="mt-2 text-[11px] sm:text-xs text-slate-400">
                    </p>
                </div>
            </section>
        </main>
    </div>

    <script>
        // Mall Hankook ì•„í‚¤í…ì²˜: URL íŒŒë¼ë¯¸í„° ì¶”ì¶œ
        function getInquiryIdFromUrl() {
            const params = new URLSearchParams(window.location.search);
            return params.get("id");
        }

        // ì—ëŸ¬/ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
        function showMessage(message, type = "info") {
            const box = document.getElementById("messageBox");
            const inner = document.getElementById("messageInner");
            box.classList.remove("hidden");

            inner.textContent = message;
            if (type === "error") {
                inner.classList.add("border-red-200", "text-red-800");
            } else {
                inner.classList.remove("border-red-200", "text-red-800");
            }
        }

        // ë‚ ì§œ í¬ë§·íŒ… (í•œêµ­ ë¡œì¼€ì¼)
        function formatDateTime(isoString) {
            if (!isoString) return "";
            const d = new Date(isoString);
            if (Number.isNaN(d.getTime())) return isoString;
            return d.toLocaleString("ko-KR", {
                year: "numeric",
                month: "2-digit",
                day: "2-digit",
                hour: "2-digit",
                minute: "2-digit",
            });
        }

        // ë¬¸ì˜ ìœ í˜• í•œê¸€ ë§¤í•‘
        function getInquiryTypeLabel(type) {
            const labels = {
                'general': 'ì¼ë°˜ ë¬¸ì˜',
                'store': 'ë§¤ì¥ ê´€ë ¨',
                'technical': 'ê¸°ìˆ  ì§€ì›',
                'complaint': 'ë¶ˆë§Œ/ì‹ ê³ ',
                'suggestion': 'ê°œì„  ì œì•ˆ'
            };
            return labels[type] || type || 'ì¼ë°˜ ë¬¸ì˜';
        }

        // ì²¨ë¶€ ì´ë¯¸ì§€ ë Œë”ë§
        function renderAttachmentImages(item) {
            console.log("ğŸ“ ì´ë¯¸ì§€ ë Œë”ë§ ì‹œì‘:", {
                image1: item.image1,
                image2: item.image2,
                image3: item.image3
            });
            console.log("ğŸ“‚ file_paths ì›ë³¸:", item.file_paths);

            const imageSection = document.getElementById("imageSection");
            const imageGrid = document.getElementById("imageGrid");

            if (!imageSection || !imageGrid) {
                console.error("âŒ ì´ë¯¸ì§€ ì„¹ì…˜ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            imageGrid.innerHTML = "";

            // 1ï¸âƒ£ ê¸°ë³¸ í•„ë“œ(image1, image2, image3, image*_path) ë¨¼ì € ëª¨ìœ¼ê¸°
            let paths = [];

            const directCandidates = [
                item.image1,
                item.image2,
                item.image3,
                item.image1_path,
                item.image2_path,
                item.image3_path,
            ];

            directCandidates.forEach((p) => {
                if (p && typeof p === "string" && p.trim() !== "") {
                    paths.push(p);
                }
            });

            // 2ï¸âƒ£ file_paths(JSON)ì— ìˆëŠ” ì´ë¯¸ì§€ë„ ì¶”ê°€
            if (item.file_paths) {
                let fileArray = [];

                // PostgreSQL json íƒ€ì…ì´ë©´ ì´ë¯¸ JS ë°°ì—´/ê°ì²´ì¼ ê°€ëŠ¥ì„± í¼
                if (Array.isArray(item.file_paths)) {
                    fileArray = item.file_paths;
                } else if (typeof item.file_paths === "string") {
                    // í˜¹ì‹œ ë¬¸ìì—´(JSON ë¬¸ìì—´)ë¡œ ë“¤ì–´ì˜¨ ê²½ìš°
                    try {
                        const parsed = JSON.parse(item.file_paths);
                        if (Array.isArray(parsed)) {
                            fileArray = parsed;
                        }
                    } catch (e) {
                        console.error("âŒ file_paths JSON íŒŒì‹± ì‹¤íŒ¨:", e);
                    }
                }

                fileArray.forEach((p) => {
                    if (p && typeof p === "string" && p.trim() !== "") {
                        paths.push(p);
                    }
                });
            }

            console.log("ğŸ“Š ìœ íš¨í•œ ì´ë¯¸ì§€ ê²½ë¡œ (file_paths í¬í•¨):", paths);

            if (paths.length === 0) {
                imageSection.classList.add("hidden");
                console.log("â„¹ï¸ ì²¨ë¶€ ì´ë¯¸ì§€ ì—†ìŒ - ì„¹ì…˜ ìˆ¨ê¹€");
                return;
            }

            // âœ… ì²¨ë¶€ íŒŒì¼ì´ ìˆìœ¼ë©´ ì„¹ì…˜ í‘œì‹œ
            imageSection.classList.remove("hidden");
            console.log(`âœ… ${paths.length}ê°œì˜ ì´ë¯¸ì§€ ë Œë”ë§ ì‹œì‘`);

            paths.forEach((src, index) => {
                // âœ… ê²½ë¡œ ì •ê·œí™” (ì¤‘ë³µ ìŠ¬ë˜ì‹œ ì œê±°)
                let normalizedSrc = src;
                if (!src.startsWith("http")) {
                    normalizedSrc = src.replace(/^\/+/, "/");
                }

                console.log(`ğŸ–¼ï¸ ì´ë¯¸ì§€ ${index + 1}: ${normalizedSrc}`);

                const img = document.createElement("img");
                img.src = normalizedSrc;
                img.alt = `ì²¨ë¶€ ì´ë¯¸ì§€ ${index + 1}`;
                img.className =
                    "w-24 h-24 sm:w-28 sm:h-28 object-cover rounded-2xl border border-slate-100 shadow-sm cursor-pointer hover:scale-105 transition-transform";

                // ìƒˆ íƒ­ì—ì„œ ì›ë³¸ ì´ë¯¸ì§€ ì—´ê¸°
                img.addEventListener("click", () => {
                    console.log("ğŸ” ì´ë¯¸ì§€ í´ë¦­:", normalizedSrc);
                    window.open(normalizedSrc, "_blank", "noopener,noreferrer");
                });

                // ì´ë¯¸ì§€ ë¡œë“œ ì„±ê³µ
                img.onload = function () {
                    console.log(`âœ… ì´ë¯¸ì§€ ë¡œë“œ ì„±ê³µ: ${normalizedSrc}`);
                };

                // ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨ ì²˜ë¦¬
                img.onerror = function () {
                    console.error(`âŒ ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨: ${normalizedSrc}`);
                    this.src =
                        "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTMgMTZMOCAxMUwxMyAxNkwxNiAxM0wyMSAxOFY2QzIxIDQuOSAyMC4xIDQgMTkgNEg1QzMuOSA0IDMgNC45IDMgNlYxNloiIGZpbGw9IiNDREQ1REYiLz4KPHN2Zz4K";
                    this.className += " opacity-50";
                    this.title = `ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${normalizedSrc}`;
                };

                imageGrid.appendChild(img);
            });
        }

        // Mall Hankook API: ë¬¸ì˜ ìƒì„¸ ì¡°íšŒ
        async function fetchInquiryDetail() {
            const id = getInquiryIdFromUrl();

            if (!id) {
                showMessage("ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤. ë¬¸ì˜ IDê°€ ì—†ìŠµë‹ˆë‹¤.", "error");
                document.getElementById("titleText").textContent = "ë¬¸ì˜ ë²ˆí˜¸ê°€ ì „ë‹¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
                return;
            }

            try {
                console.log(`ğŸ“‹ Mall Hankook API: ë¬¸ì˜ ìƒì„¸ ì¡°íšŒ ID=${id}`);

                const res = await fetch(`/api/inquiry/${id}`);
                console.log(`ğŸ“¥ ì‘ë‹µ ìƒíƒœ: ${res.status}`);

                if (!res.ok) {
                    if (res.status === 404) {
                        showMessage("í•´ë‹¹ ë¬¸ì˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", "error");
                        document.getElementById("titleText").textContent = "ë¬¸ì˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
                        return;
                    }
                    throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                }

                const data = await res.json();
                console.log("ğŸ“Š ì‘ë‹µ ë°ì´í„°:", data);

                // âœ… Mall Hankook í‘œì¤€ ì‘ë‹µ êµ¬ì¡° ëŒ€ì‘
                const item = data.data || data.item || data;

                if (!item) {
                    throw new Error("ì‘ë‹µ ë°ì´í„°ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                }

                console.log("ğŸ“¦ ë¬¸ì˜ ì•„ì´í…œ:", item);

                // ê¸°ë³¸ ì •ë³´ ë Œë”ë§
                document.getElementById("badgeId").textContent = `#${item.id}`;
                document.getElementById("badgeType").textContent = getInquiryTypeLabel(item.inquiry_type);
                document.getElementById("titleText").textContent = item.title || "(ì œëª© ì—†ìŒ)";

                // ì‘ì„±ì¼ (ìƒë‹¨)
                if (item.created_at) {
                    document.getElementById("metaLine").textContent = `ì‘ì„±ì¼: ${formatDateTime(item.created_at)}`;
                }

                // ì‘ì„±ì ì •ë³´ (í•˜ë‹¨)
                const subMetaData = [];

                const writerName = item.writer_name || item.user_name;
                if (writerName) {
                    subMetaData.push(`ì‘ì„±ì: ${writerName}`);
                }

                if (item.writer_phone) {
                    subMetaData.push(`ì—°ë½ì²˜: ${item.writer_phone}`);
                }

                if (item.writer_email) {
                    subMetaData.push(`ì´ë©”ì¼: ${item.writer_email}`);
                }

                const subMetaLineEl = document.getElementById("subMetaLine");
                subMetaLineEl.innerHTML = "";

                subMetaData.forEach((text) => {
                    const span = document.createElement("span");
                    span.textContent = text;
                    span.className = "text-slate-600";
                    subMetaLineEl.appendChild(span);
                });

                // ë¬¸ì˜ ë‚´ìš©
                document.getElementById("contentBox").textContent = item.content || "(ë‚´ìš© ì—†ìŒ)";

                // âœ… ì²¨ë¶€ ì´ë¯¸ì§€ ë Œë”ë§
                renderAttachmentImages(item);

                // ë‹µë³€ ì²˜ë¦¬
                const answerTextEl = document.getElementById("answerText");
                const answeredAtTextEl = document.getElementById("answeredAtText");

                if (item.answer && item.answer.trim() !== "") {
                    answerTextEl.textContent = item.answer;
                    if (item.answered_at) {
                        answeredAtTextEl.textContent = `ë‹µë³€ì¼: ${formatDateTime(item.answered_at)}`;
                    }
                } else {
                    answerTextEl.textContent = "ì•„ì§ ë‹´ë‹¹ìê°€ ë‹µë³€ì„ ì‘ì„±í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë¹ ë¥¸ ì‹œì¼ ë‚´ì— ë‹µë³€ë“œë¦´ê²Œìš”.";
                    answeredAtTextEl.textContent = "";
                }

            } catch (err) {
                console.error("âŒ fetchInquiryDetail ERROR:", err);
                showMessage(`ë¬¸ì˜ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${err.message}`, "error");
            }
        }

        // DOM ë¡œë“œ ì™„ë£Œ ì‹œ ì‹¤í–‰
        document.addEventListener("DOMContentLoaded", fetchInquiryDetail);
    </script>
</body>

</html>