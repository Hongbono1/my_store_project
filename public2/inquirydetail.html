<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>문의 상세 | MALL HANKOOK</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: Pretendard, system-ui, -apple-system, BlinkMacSystemFont,
                "Segoe UI", Roboto, "Noto Sans KR", sans-serif;
        }

        .neo-card {
            background: radial-gradient(circle at 0 0, rgba(255, 255, 255, 0.9), rgba(248, 250, 252, 0.9));
            box-shadow:
                12px 12px 30px rgba(15, 23, 42, 0.18),
                -10px -10px 25px rgba(255, 255, 255, 0.9);
        }

        .glass-badge {
            backdrop-filter: blur(12px);
            background: linear-gradient(135deg, rgba(129, 140, 248, 0.18), rgba(56, 189, 248, 0.18));
            border: 1px solid rgba(255, 255, 255, 0.7);
        }
    </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-slate-50 via-sky-50 to-indigo-100">
    <div class="max-w-5xl mx-auto px-4 py-10">
        <!-- 상단 타이틀 -->
        <header class="mb-8">
            <a href="javascript:history.back()"
                class="inline-flex items-center text-sm text-slate-500 hover:text-slate-800 mb-3">
                ← 뒤로가기
            </a>
            <h1 class="text-2xl sm:text-3xl font-extrabold text-slate-900 tracking-tight">
                문의 상세
            </h1>
            <p class="text-sm sm:text-base text-slate-500 mt-1">
                고객님이 남겨주신 문의와 답변 내용을 확인할 수 있습니다.
            </p>
        </header>

        <!-- 에러/알림 영역 -->
        <div id="messageBox" class="mb-4 hidden">
            <div id="messageInner" class="px-4 py-3 rounded-2xl text-sm font-medium border glass-badge text-slate-800">
            </div>
        </div>

        <!-- 메인 카드 -->
        <main id="detailContainer"
            class="neo-card rounded-3xl border border-white/70 shadow-xl p-6 sm:p-8 flex flex-col gap-6 sm:gap-8">

            <!-- 상단 메타 정보 -->
            <section class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
                <div>
                    <div class="flex items-center gap-2 mb-2">
                        <span id="badgeType"
                            class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold text-indigo-700 bg-indigo-50 border border-indigo-100">
                            문의 유형
                        </span>
                        <span id="badgeId"
                            class="inline-flex items-center px-3 py-1 rounded-full text-[11px] font-medium text-slate-500 bg-white/70 border border-slate-100">
                            # -
                        </span>
                    </div>
                    <h2 id="titleText" class="text-xl sm:text-2xl font-bold text-slate-900">
                        로딩 중입니다...
                    </h2>
                    <p id="metaLine" class="text-xs sm:text-sm text-slate-500 mt-1">
                        &nbsp;
                    </p>
                    <p id="subMetaLine" class="text-sm sm:text-base text-slate-500 mt-2"></p> &nbsp;

                </div>

            </section>

            <hr class="border-slate-200/70" />

            <!-- ✅ 문의 내용 (전체 폭) -->
            <section class="flex flex-col gap-4">
                <h3 class="text-sm font-semibold text-slate-500 tracking-wide">
                    문의 내용
                </h3>
                <div id="contentBox"
                    class="rounded-2xl bg-white/80 border border-slate-100 px-4 py-3 sm:px-5 sm:py-4 text-sm sm:text-base text-slate-800 leading-relaxed whitespace-pre-line min-h-[120px]">
                </div>
            </section>

            <!-- ✅ 첨부 이미지 (문의 내용 바로 아래) -->
            <section id="imageSection" class="flex flex-col gap-4 hidden">
                <h3 class="text-sm font-semibold text-slate-500 tracking-wide">
                    첨부 이미지
                </h3>
                <div id="imageBox" class="rounded-2xl bg-white/80 border border-slate-100 px-3 py-3 sm:px-4 sm:py-4">
                    <div id="imageGrid" class="flex flex-wrap gap-3">
                        <!-- 이미지들이 가로로 배치됨 -->
                    </div>
                </div>
            </section>

            <hr class="border-slate-200/70" />

            <!-- ✅ 답변 영역 (최하단) -->
            <section class="flex flex-col gap-3">
                <h3 class="text-sm font-semibold text-slate-500 tracking-wide">
                    답변
                </h3>
                <div id="answerBox"
                    class="rounded-2xl bg-slate-900 text-slate-50/95 px-4 py-3 sm:px-5 sm:py-4 text-sm sm:text-base leading-relaxed shadow-lg shadow-slate-900/20">
                    <p id="answerText" class="whitespace-pre-line">
                        아직 담당자가 답변을 작성하지 않았습니다. 빠른 시일 내에 답변드릴게요.
                    </p>
                    <p id="answeredAtText" class="mt-2 text-[11px] sm:text-xs text-slate-400">
                    </p>
                </div>
            </section>
        </main>
    </div>

    <script>
        // URL에서 ?id= 값 가져오기
        function getInquiryIdFromUrl() {
            const params = new URLSearchParams(window.location.search);
            const id = params.get("id");
            return id;
        }

        function showMessage(message, type = "info") {
            const box = document.getElementById("messageBox");
            const inner = document.getElementById("messageInner");
            box.classList.remove("hidden");

            inner.textContent = message;
            if (type === "error") {
                inner.classList.add("border-red-200", "text-red-800");
            } else {
                inner.classList.remove("border-red-200", "text-red-800");
            }
        }

        function formatDateTime(isoString) {
            if (!isoString) return "";
            const d = new Date(isoString);
            if (Number.isNaN(d.getTime())) return isoString;
            return d.toLocaleString("ko-KR", {
                year: "numeric",
                month: "2-digit",
                day: "2-digit",
                hour: "2-digit",
                minute: "2-digit",
            });
        }

        async function fetchInquiryDetail() {
            const id = getInquiryIdFromUrl();

            if (!id) {
                showMessage("잘못된 접근입니다. id가 없습니다.", "error");
                document.getElementById("titleText").textContent = "문의 번호가 전달되지 않았어요.";
                return;
            }

            try {
                const res = await fetch(`/api/inquiry/${id}`);
                if (!res.ok) {
                    if (res.status === 404) {
                        showMessage("해당 문의 내역을 찾을 수 없습니다.", "error");
                        document.getElementById("titleText").textContent = "문의 내역을 찾을 수 없습니다.";
                        return;
                    }
                    showMessage("문의 정보를 불러오는 중 오류가 발생했습니다.", "error");
                    return;
                }

                const data = await res.json();
                if (!data.ok || !data.item) {
                    showMessage("문의 정보를 불러오는 데 실패했습니다.", "error");
                    return;
                }

                const item = data.item;

                // 상단 메타
                document.getElementById("badgeId").textContent = `#${item.id}`;
                document.getElementById("badgeType").textContent = item.inquiry_type
                    ? `문의 유형 · ${item.inquiry_type}`
                    : "문의 유형";

                document.getElementById("titleText").textContent = item.title || "(제목 없음)";

                const metaLine = [];
                if (item.created_at) {
                    metaLine.push(`작성일: ${formatDateTime(item.created_at)}`);
                }
                document.getElementById("metaLine").textContent = metaLine.join(" · ") || "";

                // 작성자/연락처/이메일 - 작성일 아래 한 줄로 표시
                const subMeta = [];
                if (item.writer_name || item.user_name) {
                    subMeta.push(`작성자 ${item.writer_name || item.user_name}`);
                }
                if (item.writer_phone) {
                    subMeta.push(`연락처 ${item.writer_phone}`);
                }
                if (item.writer_email) {
                    subMeta.push(`이메일 ${item.writer_email}`);
                }
                document.getElementById("subMetaLine").textContent = subMeta.join(" · ");


                // 본문
                document.getElementById("contentBox").textContent =
                    item.content || "(내용 없음)";

                // ✅ 첨부 이미지: 세로 배치 + 가로 그리드
                const paths = [
                    item.image1_path,
                    item.image2_path,
                    item.image3_path,
                    item.image1,
                    item.image2,
                    item.image3,
                ].filter((p) => typeof p === "string" && p.trim() !== "");

                const imageSection = document.getElementById("imageSection");
                const imageGrid = document.getElementById("imageGrid");
                imageGrid.innerHTML = "";

                if (paths.length > 0) {
                    imageSection.classList.remove("hidden");
                    paths.forEach((src, index) => {
                        const img = document.createElement("img");
                        img.src = src;
                        img.alt = `첨부 이미지 ${index + 1}`;
                        img.className =
                            "w-24 h-24 sm:w-28 sm:h-28 object-cover rounded-2xl border border-slate-100 shadow-sm cursor-pointer hover:scale-105 transition-transform";

                        // 이미지 클릭 시 새 탭에서 원본 열기
                        img.addEventListener("click", () => {
                            window.open(src, "_blank");
                        });

                        // 이미지 로드 오류 처리
                        img.onerror = function () {
                            this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTMgMTZMOCAxMUwxMyAxNkwxNiAxM0wyMSAxOFY2QzIxIDQuOSAyMC4xIDQgMTkgNEg1QzMuOSA0IDMgNC45IDMgNlYxNloiIGZpbGw9IiNDREQ1REYiLz4KPHN2Zz4K';
                            this.className += ' opacity-50';
                        };

                        imageGrid.appendChild(img);
                    });
                } else {
                    imageSection.classList.add("hidden");
                }

                // 답변
                const answerTextEl = document.getElementById("answerText");
                const answeredAtTextEl = document.getElementById("answeredAtText");

                if (item.answer && item.answer.trim() !== "") {
                    answerTextEl.textContent = item.answer;
                    answeredAtTextEl.textContent = item.answered_at
                        ? `답변일: ${formatDateTime(item.answered_at)}`
                        : "";
                } else {
                    answerTextEl.textContent =
                        "아직 담당자가 답변을 작성하지 않았습니다. 빠른 시일 내에 답변드릴게요.";
                    answeredAtTextEl.textContent = "";
                }
            } catch (err) {
                console.error("❌ fetchInquiryDetail ERROR:", err);
                showMessage("문의 정보를 불러오는 중 알 수 없는 오류가 발생했습니다.", "error");
            }
        }

        document.addEventListener("DOMContentLoaded", fetchInquiryDetail);
    </script>
</body>

</html>