<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì„œë¸Œ ì¹´í…Œê³ ë¦¬ í˜ì´ì§€</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-white text-gray-800 min-h-screen flex flex-col">
    <div id="header-placeholder"></div>

    <section class="relative h-[70vh] max-h-[400px] flex items-center justify-between px-8 bg-gray-50">
        <div class="flex-1 flex justify-center">
            <img id="heroImage" src="/uploads/sample-banner-product.png" alt="ë°°ë„ˆ" class="h-[280px] object-contain">
        </div>
        <div class="flex-1 text-left">
            <h1 id="heroTitle" class="text-3xl md:text-4xl font-bold mb-4">ì¹´í…Œê³ ë¦¬ ì œëª©</h1>
            <p id="heroSubtitle" class="text-gray-600 mb-6">ì¹´í…Œê³ ë¦¬ ì„¤ëª…</p>
            <button id="btnMore" class="px-5 py-2.5 bg-black text-white font-semibold rounded-lg">MORE VIEW</button>
        </div>
    </section>

    <section id="aboutSection" class="max-w-6xl mx-auto py-12 px-4 w-full">
        <div class="flex items-center justify-center relative mb-6">
            <h2 class="text-xl md:text-2xl font-bold text-center">All of the items</h2>

            <div class="absolute right-0">
                <button id="btnMoreItems"
                    class="px-4 py-2 rounded-full bg-black text-white text-sm font-semibold hover:opacity-90 transition">
                    ë”ë³´ê¸°
                </button>
            </div>
        </div>

        <div id="filterContainer" class="flex justify-center flex-wrap gap-3 mb-8"></div>

        <div id="lineGrid" class="grid grid-cols-1 sm:grid-cols-3 gap-4"></div>

        <div class="mt-8 flex flex-col items-center gap-3">
            <div id="pageInfo" class="text-sm text-gray-600 font-semibold"></div>

            <div class="flex items-center gap-2 flex-wrap justify-center">
                <button id="btnPrevPage"
                    class="px-3 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold transition">
                    ì´ì „
                </button>

                <div id="pageNumbers" class="flex items-center gap-2 flex-wrap justify-center"></div>

                <button id="btnNextPage"
                    class="px-3 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold transition">
                    ë‹¤ìŒ
                </button>
            </div>
        </div>
    </section>

    <section class="max-w-6xl mx-auto py-12 px-4">
        <h2 class="text-xl md:text-2xl font-bold text-center mb-8">Best Seller</h2>
        <div id="bestGrid" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
    </section>

    <section class="max-w-6xl mx-auto py-12 px-4">
        <h2 class="text-xl md:text-2xl font-bold text-center mb-8">New registration</h2>
        <div id="newGrid" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
    </section>

    <div id="footer-placeholder"></div>

    <div class="fixed bottom-6 right-6 flex flex-col items-center gap-4 z-50">
        <div class="flex flex-col items-center">
            <button onclick="goBack()"
                class="w-14 h-14 flex items-center justify-center rounded-full bg-gradient-to-br from-gray-100 to-gray-200 text-gray-700 shadow hover:from-gray-200 hover:to-gray-300 transition">â†</button>
            <span class="text-xs mt-1 text-gray-600 font-semibold">ì´ì „</span>
        </div>

        <div class="flex flex-col items-center">
            <button onclick="goNext()"
                class="w-14 h-14 flex items-center justify-center rounded-full bg-gradient-to-br from-gray-100 to-gray-200 text-gray-700 shadow hover:from-gray-200 hover:to-gray-300 transition">â†’</button>
            <span class="text-xs mt-1 text-gray-600 font-semibold">ë‹¤ìŒ</span>
        </div>

        <div class="flex flex-col items-center">
            <a href="/index.html"
                class="w-14 h-14 flex items-center justify-center rounded-full bg-gradient-to-br from-blue-500 to-blue-600 text-white shadow hover:from-blue-600 hover:to-blue-700 transition">ğŸ </a>
            <span class="text-xs mt-1 text-gray-600 font-semibold">í™ˆ</span>
        </div>
    </div>

    <script>
        fetch("/components/header.html").then(r => r.text()).then(d => (document.getElementById("header-placeholder").innerHTML = d));
        fetch("/components/footer.html").then(r => r.text()).then(d => (document.getElementById("footer-placeholder").innerHTML = d));

        const params = new URLSearchParams(window.location.search);
        const TYPE = (params.get("type") || "combined").toLowerCase(); // âœ… ê¸°ë³¸ì€ í†µí•©
        const CATEGORY = (params.get("category") || "").trim();
        const RAW_SUB = (params.get("sub") || "").trim();

        const ITEMS_PER_PAGE = 12;
        const FALLBACK_SUB = "ê¸°íƒ€";

        let ALL_STORES = [];
        let CURRENT_SUB = RAW_SUB;
        let CURRENT_PAGE = 1;

        const DEFAULT_DATA = {
            hero: { title: "ì¹´í…Œê³ ë¦¬", subtitle: "ì¹´í…Œê³ ë¦¬ë³„ ê°€ê²Œë¥¼ í™•ì¸í•˜ì„¸ìš”.", image: "/uploads/sample-banner-product.png" },
            filters: [],
            stores: [],
            best: [],
            new: []
        };
        let DATA = { ...DEFAULT_DATA };

        function escapeHtml(input) {
            const s = input == null ? "" : String(input);
            return s.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;").replace(/'/g, "&#39;");
        }

        function normalizeSrc(src) {
            if (!src) return "/uploads/no-image.png";
            if (/^https?:\/\//i.test(src)) return src;
            return src.startsWith("/") ? src : "/" + src;
        }

        async function fetchJson(url) {
            const res = await fetch(url);
            return await res.json();
        }

        // âœ… í•µì‹¬: â€œë“±ë¡ê°’ ê¸°ë°˜â€ í†µí•© í•„ë“œ ì½ê¸°
        function getStoreCategory(store) {
            return (store.business_category ?? store.category ?? store.businessCategory ?? "").toString().trim();
        }

        function getStoreSubcategory(store) {
            const sub = (
                store.business_subcategory ??
                store.businessSubcategory ??
                store.subcategory ??
                store.business_sub ??
                store.detail_category ??
                store.detailCategory ??
                ""
            ).toString().trim();

            return sub ? sub : FALLBACK_SUB;
        }

        function getStoreDisplayName(store) {
            return (store.name ?? store.business_name ?? store.businessName ?? store.title ?? "-").toString().trim() || "-";
        }

        function getStoreImage(store) {
            const imgSrc = store.image ?? store.image_url ?? store.url ?? store.main_image_url ?? "";
            return normalizeSrc(imgSrc);
        }

        function getStoreCreatedAt(store) {
            const v = store.created_at ?? store.createdAt ?? store.created_date ?? store.createdDate ?? store.reg_date ?? store.regDate ?? null;
            if (!v) return null;
            const d = new Date(v);
            return Number.isFinite(d.getTime()) ? d : null;
        }

        function getStoreScoreForBest(store) {
            const cand = [
                store.view_count, store.views, store.like_count, store.likes,
                store.rating, store.score, store.sales, store.order_count, store.orders
            ].map(x => {
                const n = Number(x);
                return Number.isFinite(n) ? n : null;
            }).find(v => v !== null);

            return cand ?? null;
        }

        function shuffle(arr) {
            const a = arr.slice();
            for (let i = a.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [a[i], a[j]] = [a[j], a[i]];
            }
            return a;
        }

        function pickBestSeller(stores, limit = 8) {
            if (!stores || !stores.length) return [];
            const withScore = stores.map(s => ({ s, sc: getStoreScoreForBest(s) })).filter(x => x.s);
            const hasAnyScore = withScore.some(x => x.sc !== null);

            if (hasAnyScore) {
                return withScore.sort((a, b) => (b.sc ?? -1) - (a.sc ?? -1)).slice(0, limit).map(x => x.s);
            }
            return shuffle(stores).slice(0, limit);
        }

        function pickNewRegistration(stores, limit = 8) {
            if (!stores || !stores.length) return [];
            const now = new Date();
            const cutoff = new Date(now.getTime() - (30 * 24 * 60 * 60 * 1000));

            const recent = stores
                .map(s => ({ s, d: getStoreCreatedAt(s) }))
                .filter(x => x.d && x.d >= cutoff)
                .sort((a, b) => b.d - a.d)
                .map(x => x.s);

            if (recent.length) {
                const picked = recent.slice(0, limit);
                if (picked.length < limit) {
                    const rest = stores.filter(s => !picked.includes(s));
                    return picked.concat(shuffle(rest).slice(0, limit - picked.length));
                }
                return picked;
            }
            return shuffle(stores).slice(0, limit);
        }

        function buildDynamicFiltersFromStores(stores) {
            const set = new Set();
            (stores || []).forEach(s => set.add(getStoreSubcategory(s)));

            let arr = Array.from(set);
            arr.sort((a, b) => {
                if (a === FALLBACK_SUB && b !== FALLBACK_SUB) return 1;
                if (b === FALLBACK_SUB && a !== FALLBACK_SUB) return -1;
                return a.localeCompare(b, "ko");
            });
            return arr;
        }

        function bindHero() {
            const title = CATEGORY ? CATEGORY : (DATA.hero?.title || "ì¹´í…Œê³ ë¦¬");
            document.getElementById("heroTitle").innerHTML = escapeHtml(title).replace(/\n/g, "<br>");
            document.getElementById("heroSubtitle").textContent = (DATA.hero?.subtitle || "ì¹´í…Œê³ ë¦¬ë³„ ê°€ê²Œë¥¼ í™•ì¸í•˜ì„¸ìš”.");
            document.getElementById("heroImage").src = (DATA.hero?.image || "/uploads/sample-banner-product.png");
        }

        // âœ… ì„œë²„ â€œí†µí•©â€ ì¡°íšŒ: ìš°ì„  unified ì—”ë“œí¬ì¸íŠ¸ë¥¼ ë¨¼ì € ì‹œë„í•˜ê³ , ì—†ìœ¼ë©´ ê¸°ì¡´ APIë¡œ í´ë°±
        async function fetchUnifiedStores() {
            // 1) í†µí•© APIê°€ ìˆìœ¼ë©´ ì œì¼ ì¢‹ìŒ
            try {
                const q = new URLSearchParams();
                q.set("category", CATEGORY);
                q.set("type", TYPE);
                const json = await fetchJson(`/api/subcategory/unified?${q.toString()}`);
                if (json && Array.isArray(json.stores)) return json.stores;
            } catch (_) { }

            // 2) í´ë°±: ê¸°ì¡´ ë°©ì‹ (ë„ˆ ì„œë²„ì— ìˆëŠ” ì—”ë“œí¬ì¸íŠ¸)
            //    â€» ì—¬ê¸°ì„œë„ ê²°êµ­ â€œë“±ë¡ëœ ëª¨ë“  ë°ì´í„°ê°€ ë‹¤ ë‚˜ì˜¤ë ¤ë©´â€ ì„œë²„ ìª½ í†µí•©ì´ í•„ìš”í•¨
            if (TYPE === "food") {
                const q = new URLSearchParams();
                q.set("category", CATEGORY);
                const json = await fetchJson(`/api/subcategory/food?${q.toString()}`);
                return json.stores || [];
            } else {
                const json = await fetchJson(`/api/subcategory/beauty?category=${encodeURIComponent(CATEGORY)}`);
                return (json.stores || []).filter(s => getStoreCategory(s) === CATEGORY);
            }
        }

        function applySubFilter(subVal, updateHistory = true) {
            CURRENT_PAGE = 1;
            const sub = (subVal || "").trim();
            CURRENT_SUB = sub;

            if (!sub) {
                DATA.stores = ALL_STORES.slice();
                if (updateHistory) {
                    const q = new URLSearchParams(location.search);
                    q.delete("sub");
                    history.replaceState(null, "", `${location.pathname}?${q.toString()}`);
                }
                return;
            }

            const filtered = ALL_STORES.filter(s => getStoreSubcategory(s) === sub);

            if (!filtered.length && ALL_STORES.length) {
                CURRENT_SUB = "";
                DATA.stores = ALL_STORES.slice();
                if (updateHistory) {
                    const q = new URLSearchParams(location.search);
                    q.delete("sub");
                    history.replaceState(null, "", `${location.pathname}?${q.toString()}`);
                }
                return;
            }

            DATA.stores = filtered;

            if (updateHistory) {
                const q = new URLSearchParams(location.search);
                q.set("sub", sub);
                history.replaceState(null, "", `${location.pathname}?${q.toString()}`);
            }
        }

        function makeFilterBtn(label, tagVal) {
            const btn = document.createElement("button");
            btn.type = "button";

            const isActive = (CURRENT_SUB || "") === (tagVal || "");
            btn.className = isActive
                ? "px-3 py-1.5 rounded-full bg-black text-white text-sm"
                : "px-3 py-1.5 rounded-full bg-gray-200 hover:bg-gray-300 text-sm";

            btn.textContent = label;

            btn.onclick = () => {
                applySubFilter(tagVal || "", true);
                renderFilters();
                renderPagedAdStores(DATA.stores || []);
                renderPagination();
            };
            return btn;
        }

        function renderFilters() {
            const wrap = document.getElementById("filterContainer");
            wrap.innerHTML = "";

            const list = DATA.filters || [];
            if (!list.length) return;

            wrap.appendChild(makeFilterBtn("All", ""));
            list.forEach(tag => wrap.appendChild(makeFilterBtn(tag, tag)));
        }

        function goDetail(store) {
            const bt = (store.business_type ?? store.businessType ?? "").toString().trim();
            const type = (bt === "ìŒì‹ì " || bt === "ìŒì‹") ? "food" : "combined";
            const id = store.id ?? store.store_id ?? store.storeId ?? "";
            if (!id) return;
            window.location.href = `/ndetail.html?id=${encodeURIComponent(id)}&type=${encodeURIComponent(type)}`;
        }

        function makeStoreCard(store) {
            const card = document.createElement("div");
            card.className = "rounded-2xl cursor-pointer hover:shadow-lg transition overflow-hidden flex flex-col bg-white";

            const dispName = getStoreDisplayName(store);
            const dispCategory = getStoreCategory(store);
            const imgNorm = getStoreImage(store);

            card.innerHTML = `
        <div class="relative h-[260px]">
          <img src="${imgNorm}" alt="${escapeHtml(dispName)}" class="w-full h-full object-cover rounded-t-2xl">
          <div class="absolute left-0 right-0 bottom-0 bg-white/90 backdrop-blur px-4 py-2 text-center rounded-b-2xl">
            <div class="font-bold text-lg text-gray-800 leading-tight truncate">${escapeHtml(dispName)}</div>
            <div class="text-sm text-gray-600">${escapeHtml(dispCategory)}</div>
          </div>
        </div>
      `;
            card.addEventListener("click", () => goDetail(store));
            return card;
        }

        function getTotalPages() {
            const len = (DATA.stores || []).length;
            return Math.max(1, Math.ceil(len / ITEMS_PER_PAGE));
        }

        function clampPage(p) {
            const total = getTotalPages();
            if (p < 1) return 1;
            if (p > total) return total;
            return p;
        }

        function setPage(page) {
            CURRENT_PAGE = clampPage(page);
            renderPagedAdStores(DATA.stores || []);
            renderPagination();
            document.getElementById("aboutSection").scrollIntoView({ behavior: "smooth", block: "start" });
        }

        function renderPagedAdStores(stores) {
            const grid = document.getElementById("lineGrid");
            grid.innerHTML = "";

            if (!stores || !stores.length) {
                grid.innerHTML = `
          <div class="col-span-full flex justify-center items-center py-16">
            <div class="p-8 text-center max-w-md">
              <h3 class="text-lg font-semibold text-gray-700 mb-2">ë“±ë¡ëœ ê°€ê²Œê°€ ì—†ìŠµë‹ˆë‹¤</h3>
              <p class="text-sm text-gray-500">ë¹ ë¥¸ ì‹œì¼ ë‚´ì— ìƒˆë¡œìš´ ê°€ê²Œê°€ ì¶”ê°€ë  ì˜ˆì •ì…ë‹ˆë‹¤.</p>
            </div>
          </div>`;
                document.getElementById("pageInfo").textContent = "";
                return;
            }

            const totalPages = getTotalPages();
            CURRENT_PAGE = clampPage(CURRENT_PAGE);

            const start = (CURRENT_PAGE - 1) * ITEMS_PER_PAGE;
            const end = start + ITEMS_PER_PAGE;
            const pageItems = stores.slice(start, end);

            const wrapper = document.createElement("div");
            wrapper.className = "col-span-full grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6";

            pageItems.forEach(store => wrapper.appendChild(makeStoreCard(store)));
            grid.appendChild(wrapper);

            const totalCount = stores.length;
            const from = start + 1;
            const to = Math.min(end, totalCount);
            document.getElementById("pageInfo").textContent = `${from} - ${to} / ${totalCount}ê°œ Â· ${CURRENT_PAGE} / ${totalPages} í˜ì´ì§€`;
        }

        function renderPagination() {
            const totalPages = getTotalPages();

            const btnPrev = document.getElementById("btnPrevPage");
            const btnNext = document.getElementById("btnNextPage");
            const nums = document.getElementById("pageNumbers");

            btnPrev.disabled = (CURRENT_PAGE <= 1);
            btnNext.disabled = (CURRENT_PAGE >= totalPages);

            btnPrev.className = btnPrev.disabled
                ? "px-3 py-2 rounded-lg bg-gray-100 text-gray-300 font-semibold cursor-not-allowed"
                : "px-3 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold transition";

            btnNext.className = btnNext.disabled
                ? "px-3 py-2 rounded-lg bg-gray-100 text-gray-300 font-semibold cursor-not-allowed"
                : "px-3 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold transition";

            btnPrev.onclick = () => setPage(CURRENT_PAGE - 1);
            btnNext.onclick = () => setPage(CURRENT_PAGE + 1);

            nums.innerHTML = "";

            const makeNumBtn = (p) => {
                const b = document.createElement("button");
                const isActive = (p === CURRENT_PAGE);
                b.type = "button";
                b.textContent = String(p);
                b.className = isActive
                    ? "min-w-[40px] px-3 py-2 rounded-lg bg-black text-white font-bold"
                    : "min-w-[40px] px-3 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold transition";
                b.onclick = () => setPage(p);
                return b;
            };

            const addDots = () => {
                const d = document.createElement("span");
                d.className = "px-2 text-gray-400 font-bold";
                d.textContent = "â€¦";
                nums.appendChild(d);
            };

            if (totalPages <= 7) {
                for (let p = 1; p <= totalPages; p++) nums.appendChild(makeNumBtn(p));
                return;
            }

            nums.appendChild(makeNumBtn(1));
            const left = Math.max(2, CURRENT_PAGE - 2);
            const right = Math.min(totalPages - 1, CURRENT_PAGE + 2);

            if (left > 2) addDots();
            for (let p = left; p <= right; p++) nums.appendChild(makeNumBtn(p));
            if (right < totalPages - 1) addDots();

            nums.appendChild(makeNumBtn(totalPages));
        }

        function renderSmallGrid(gridId, items) {
            const grid = document.getElementById(gridId);
            grid.innerHTML = "";

            if (!items || !items.length) {
                grid.innerHTML = `<div class="col-span-full text-center text-gray-500">ë“±ë¡ëœ ê°€ê²Œê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
                return;
            }

            items.forEach(item => {
                const name = getStoreDisplayName(item);
                const img = getStoreImage(item);

                const card = document.createElement("div");
                card.className = "block rounded-2xl overflow-hidden bg-white hover:shadow-lg transition cursor-pointer";
                card.innerHTML = `
          <div class="h-40">
            <img src="${img}" alt="${escapeHtml(name)}" class="w-full h-full object-cover">
          </div>
          <div class="p-3 text-sm font-semibold truncate">${escapeHtml(name)}</div>
        `;
                card.addEventListener("click", () => goDetail(item));
                grid.appendChild(card);
            });
        }

        async function loadData() {
            try {
                DATA = { ...DEFAULT_DATA };
                CURRENT_PAGE = 1;

                ALL_STORES = await fetchUnifiedStores();

                // âœ… ì¹´í…Œê³ ë¦¬ ë°©ì–´ í•„í„°(ì„œë²„ê°€ ì™„ë²½íˆ í•„í„° ëª»í•˜ë©´ ì—¬ê¸°ì„œ í•œ ë²ˆ ë”)
                if (CATEGORY) {
                    ALL_STORES = ALL_STORES.filter(s => getStoreCategory(s) === CATEGORY);
                }

                DATA.filters = buildDynamicFiltersFromStores(ALL_STORES);
                applySubFilter(CURRENT_SUB, false);

                // âœ… Best/New: â€œí˜„ì¬ ì¹´í…Œê³ ë¦¬ ë²”ìœ„(ALL_STORES)â€ ì•ˆì—ì„œë§Œ
                DATA.best = pickBestSeller(ALL_STORES, 8);
                DATA.new = pickNewRegistration(ALL_STORES, 8);

            } catch (e) {
                console.error("ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", e);
                ALL_STORES = [];
                DATA = { ...DEFAULT_DATA };
            }

            init();
        }

        function init() {
            bindHero();
            renderFilters();
            renderPagedAdStores(DATA.stores || []);
            renderPagination();
            renderSmallGrid("bestGrid", DATA.best || []);
            renderSmallGrid("newGrid", DATA.new || []);

            document.getElementById("btnMore").onclick = () => {
                document.getElementById("aboutSection").scrollIntoView({ behavior: "smooth", block: "start" });
            };

            document.getElementById("btnMoreItems").onclick = () => {
                const totalPages = getTotalPages();
                if (CURRENT_PAGE < totalPages) setPage(CURRENT_PAGE + 1);
                else setPage(1);
            };
        }

        document.addEventListener("DOMContentLoaded", loadData);

        function goBack() {
            if (document.referrer && document.referrer !== location.href) window.history.back();
            else window.location.href = "/category.html";
        }
        function goNext() { window.history.forward(); }
    </script>
</body>

</html>