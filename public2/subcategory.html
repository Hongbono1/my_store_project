<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì„œë¸Œ ì¹´í…Œê³ ë¦¬ í˜ì´ì§€</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-white text-gray-800 min-h-screen flex flex-col">
    <div id="header-placeholder"></div>

    <!-- HERO -->
    <section class="relative h-[70vh] max-h-[400px] flex items-center justify-between px-8 bg-gray-50">
        <div class="flex-1 flex justify-center">
            <img id="heroImage" src="/uploads/sample-banner-product.png" alt="ë°°ë„ˆ" class="h-[280px] object-contain">
        </div>
        <div class="flex-1 text-left">
            <h1 id="heroTitle" class="text-3xl md:text-4xl font-bold mb-4">ì¹´í…Œê³ ë¦¬ ì œëª©</h1>
            <p id="heroSubtitle" class="text-gray-600 mb-6">ì¹´í…Œê³ ë¦¬ ì„¤ëª…</p>
            <button id="btnMoreHero" class="px-5 py-2.5 bg-black text-white font-semibold rounded-lg">MORE VIEW</button>
        </div>
    </section>

    <!-- All of the items -->
    <section id="aboutSection" class="max-w-6xl mx-auto py-12 px-4 w-full">
        <div class="flex items-center justify-center relative mb-6">
            <h2 class="text-xl md:text-2xl font-bold text-center">All of the items</h2>

            <div class="absolute right-0">
                <button id="btnToggleAll"
                    class="px-4 py-2 rounded-full bg-black text-white text-sm font-semibold hover:opacity-90 transition">
                    ë”ë³´ê¸°
                </button>
            </div>
        </div>

        <div id="filterContainer" class="flex justify-center flex-wrap gap-3 mb-8"></div>

        <div id="lineGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-6"></div>

        <!-- All pagination (í™•ì¥ ìƒíƒœ + 12ê°œ ì´ˆê³¼ì¼ ë•Œë§Œ í‘œì‹œ) -->
        <div id="allPager" class="mt-8 hidden flex-col items-center gap-3">
            <div id="allPageInfo" class="text-sm text-gray-600 font-semibold"></div>
            <div class="flex items-center gap-2 flex-wrap justify-center">
                <button id="allPrev"
                    class="px-3 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold transition">ì´ì „</button>
                <div id="allNums" class="flex items-center gap-2 flex-wrap justify-center"></div>
                <button id="allNext"
                    class="px-3 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold transition">ë‹¤ìŒ</button>
            </div>
        </div>
    </section>

    <!-- Best Seller -->
    <section class="max-w-6xl mx-auto py-12 px-4 w-full">
        <div class="flex items-center justify-center relative mb-8">
            <h2 class="text-xl md:text-2xl font-bold text-center">Best Seller</h2>
            <div class="absolute right-0">
                <button id="btnToggleBest"
                    class="px-4 py-2 rounded-full bg-black text-white text-sm font-semibold hover:opacity-90 transition">
                    ë”ë³´ê¸°
                </button>
            </div>
        </div>

        <div id="bestGrid" class="grid grid-cols-2 md:grid-cols-4 gap-6"></div>

        <div id="bestPager" class="mt-8 hidden flex-col items-center gap-3">
            <div id="bestPageInfo" class="text-sm text-gray-600 font-semibold"></div>
            <div class="flex items-center gap-2 flex-wrap justify-center">
                <button id="bestPrev"
                    class="px-3 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold transition">ì´ì „</button>
                <div id="bestNums" class="flex items-center gap-2 flex-wrap justify-center"></div>
                <button id="bestNext"
                    class="px-3 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold transition">ë‹¤ìŒ</button>
            </div>
        </div>
    </section>

    <!-- New registration -->
    <section class="max-w-6xl mx-auto py-12 px-4 w-full">
        <div class="flex items-center justify-center relative mb-8">
            <h2 class="text-xl md:text-2xl font-bold text-center">New registration</h2>
            <div class="absolute right-0">
                <button id="btnToggleNew"
                    class="px-4 py-2 rounded-full bg-black text-white text-sm font-semibold hover:opacity-90 transition">
                    ë”ë³´ê¸°
                </button>
            </div>
        </div>

        <div id="newGrid" class="grid grid-cols-2 md:grid-cols-4 gap-6"></div>

        <div id="newPager" class="mt-8 hidden flex-col items-center gap-3">
            <div id="newPageInfo" class="text-sm text-gray-600 font-semibold"></div>
            <div class="flex items-center gap-2 flex-wrap justify-center">
                <button id="newPrev"
                    class="px-3 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold transition">ì´ì „</button>
                <div id="newNums" class="flex items-center gap-2 flex-wrap justify-center"></div>
                <button id="newNext"
                    class="px-3 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold transition">ë‹¤ìŒ</button>
            </div>
        </div>
    </section>

    <div id="footer-placeholder"></div>

    <!-- ìš°ì¸¡ í•˜ë‹¨ ë„¤ë¹„ -->
    <div class="fixed bottom-6 right-6 flex flex-col items-center gap-4 z-50">
        <div class="flex flex-col items-center">
            <button onclick="goBack()"
                class="w-14 h-14 flex items-center justify-center rounded-full bg-gradient-to-br from-gray-100 to-gray-200 text-gray-700 shadow hover:from-gray-200 hover:to-gray-300 transition">â†</button>
            <span class="text-xs mt-1 text-gray-600 font-semibold">ì´ì „</span>
        </div>

        <div class="flex flex-col items-center">
            <button onclick="goNext()"
                class="w-14 h-14 flex items-center justify-center rounded-full bg-gradient-to-br from-gray-100 to-gray-200 text-gray-700 shadow hover:from-gray-200 hover:to-gray-300 transition">â†’</button>
            <span class="text-xs mt-1 text-gray-600 font-semibold">ë‹¤ìŒ</span>
        </div>

        <div class="flex flex-col items-center">
            <a href="/index.html"
                class="w-14 h-14 flex items-center justify-center rounded-full bg-gradient-to-br from-blue-500 to-blue-600 text-white shadow hover:from-blue-600 hover:to-blue-700 transition">ğŸ </a>
            <span class="text-xs mt-1 text-gray-600 font-semibold">í™ˆ</span>
        </div>
    </div>

    <script>
        // header/footer
        fetch("/components/header.html").then(r => r.text()).then(d => (document.getElementById("header-placeholder").innerHTML = d));
        fetch("/components/footer.html").then(r => r.text()).then(d => (document.getElementById("footer-placeholder").innerHTML = d));

        // URL params
        const params = new URLSearchParams(window.location.search);
        const TYPE = (params.get("type") || "food").toLowerCase(); // food / combined
        const CATEGORY = (params.get("category") || "").trim();
        const RAW_SUB = (params.get("sub") || "").trim();

        // âœ… í•œì‹ í•˜ìœ„êµ¬ë¶„(ê³ ì •)
        const HANSIK_SUBS = ["ë°¥", "ì°Œê°œíƒ•", "ê³ ê¸°êµ¬ì´", "ìƒì„ ", "ì¡±ë°œë³´ìŒˆ", "êµ­ë°¥", "ë°˜ì°¬", "ê¸°íƒ€í•œì‹"];

        // âœ… ê·œì¹™
        const COLLAPSE_COUNT = 8; // ê¸°ë³¸(í•œ ì¤„)
        const PAGE_SIZE = 12;     // í™•ì¥ ì‹œ 12ê°œ(4x3ì¤„)

        // âœ… New registration: 60ì¼ (1~2ë‹¬)
        const NEW_DAYS = 60;

        let ALL_STORES = [];
        let CURRENT_SUB = RAW_SUB;

        // ê° ì„¹ì…˜ ìƒíƒœ(ìƒˆë¡œê³ ì¹¨/ì´ˆê¸°í™” ì‹œ ì›ìœ„ì¹˜)
        const state = {
            all: { expanded: false, page: 1 },
            best: { expanded: false, page: 1 },
            nw: { expanded: false, page: 1 }
        };

        // ë°ì´í„°(í•„í„° ì ìš© ê²°ê³¼)
        let DATA = {
            hero: { title: "ì¹´í…Œê³ ë¦¬", subtitle: "ì¹´í…Œê³ ë¦¬ë³„ ê°€ê²Œë¥¼ í™•ì¸í•˜ì„¸ìš”.", image: "/uploads/sample-banner-product.png" },
            filters: [],
            stores: []
        };

        function escapeHtml(input) {
            const s = input == null ? "" : String(input);
            return s.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;").replace(/'/g, "&#39;");
        }

        function normalizeSrc(src) {
            if (!src) return "/uploads/no-image.png";
            if (/^https?:\/\//i.test(src)) return src;
            return src.startsWith("/") ? src : "/" + src;
        }

        async function fetchJson(url) {
            const res = await fetch(url);
            return await res.json();
        }

        function getStoreName(store) {
            return (store.name ?? store.business_name ?? store.businessName ?? store.title ?? "-").toString().trim() || "-";
        }
        function getStoreCategory(store) {
            return (store.category ?? store.business_category ?? store.businessCategory ?? "").toString().trim();
        }
        function getStoreImage(store) {
            const imgSrc = store.image ?? store.image_url ?? store.url ?? store.main_image_url ?? "";
            return normalizeSrc(imgSrc || "/uploads/no-image.png");
        }

        // Best Sellerìš© í´ë¦­/ì¡°íšŒ ìˆ˜
        function getStoreClicks(store) {
            const cand = [store.click_count, store.clicks, store.view_count, store.views, store.hit, store.hits];
            for (const v of cand) {
                const n = Number(v);
                if (Number.isFinite(n)) return n;
            }
            return 0;
        }

        // New registrationìš© ë“±ë¡ì¼
        function getStoreCreatedAt(store) {
            const v = store.created_at ?? store.createdAt ?? store.created_date ?? store.createdDate ?? store.reg_date ?? store.regDate ?? null;
            if (!v) return null;
            const d = new Date(v);
            return Number.isFinite(d.getTime()) ? d : null;
        }

        // í•œì‹ detail_category
        function getDetailCategory(store) {
            const raw = (store.detail_category ?? store.detailCategory ?? "").toString().trim();
            return raw ? raw : "ê¸°íƒ€í•œì‹";
        }

        // í†µí•©/ê¸°íƒ€ ì¹´í…Œê³ ë¦¬ í•˜ìœ„êµ¬ë¶„(ë“±ë¡ê°’ ê¸°ë°˜)
        function getBusinessSubcategory(store) {
            const raw = (
                store.business_subcategory ??
                store.businessSubcategory ??
                store.subcategory ??
                store.business_sub ??
                ""
            ).toString().trim();
            return raw ? raw : "ê¸°íƒ€";
        }

        function setHansikHero(subVal) {
            const titleBase = "í•œì‹";
            const subLabel = subVal ? ` Â· ${subVal}` : "";
            DATA.hero = {
                title: `${titleBase}${subLabel}`,
                subtitle:
                    subVal === "ë°¥" ? "ë¹„ë¹”ë°¥ Â· ë®ë°¥ Â· ë°±ë°˜ ë“± ë“ ë“ í•œ í•œ ë¼ ëª¨ìŒ"
                        : subVal === "ì°Œê°œíƒ•" ? "ë”°ëˆí•œ ì°Œê°œì™€ ì–¼í°í•œ íƒ• ìš”ë¦¬ë¥¼ ëª¨ì•˜ì–´ìš”"
                            : subVal === "ê³ ê¸°êµ¬ì´" ? "ì‚¼ê²¹ì‚´, ê°ˆë¹„, ìˆ¯ë¶ˆêµ¬ì´ ë“± ê³ ê¸° ì¢‹ì•„í•˜ëŠ” ë‚ ì— ë”±!"
                                : subVal === "ìƒì„ " ? "êµ¬ì´ Â· ì¡°ë¦¼ Â· íšŒ ë“± ë‹¤ì–‘í•œ ìƒì„  ìš”ë¦¬"
                                    : subVal === "ì¡±ë°œë³´ìŒˆ" ? "ì¡±ë°œ Â· ë³´ìŒˆ Â· ìˆ˜ìœ¡ê¹Œì§€ í‘¸ì§í•˜ê²Œ"
                                        : subVal === "êµ­ë°¥" ? "ëœ¨ëˆí•œ êµ­ë°¥ í•œ ê·¸ë¦‡ìœ¼ë¡œ ë“ ë“ í•˜ê²Œ"
                                            : subVal === "ë°˜ì°¬" ? "ì§‘ë°¥ ëŠë‚Œ ë‚˜ëŠ” ë°˜ì°¬/ë„ì‹œë½ ê°€ê²Œ ëª¨ìŒ"
                                                : subVal === "ê¸°íƒ€í•œì‹" ? "í•œì‹ ë¶„ë¥˜ì— ë“¤ì–´ê°€ì§€ ì•ŠëŠ” ë‹¤ì–‘í•œ ë©”ë‰´ ëª¨ìŒ"
                                                    : "ìš°ë¦¬ë™ë„¤ í•œì‹ ë§›ì§‘ë“¤ì„ ëª¨ì•˜ìŠµë‹ˆë‹¤.",
                image: "/uploads/sample-banner-product.png"
            };
        }

        function setDefaultHero() {
            DATA.hero = {
                title: CATEGORY || "ì¹´í…Œê³ ë¦¬",
                subtitle: "ì¹´í…Œê³ ë¦¬ë³„ ê°€ê²Œë¥¼ í™•ì¸í•˜ì„¸ìš”.",
                image: "/uploads/sample-banner-product.png"
            };
        }

        function bindHero() {
            document.getElementById("heroTitle").innerHTML = escapeHtml(DATA.hero?.title || "ì¹´í…Œê³ ë¦¬").replace(/\n/g, "<br>");
            document.getElementById("heroSubtitle").textContent = DATA.hero?.subtitle || "ì¹´í…Œê³ ë¦¬ë³„ ê°€ê²Œë¥¼ í™•ì¸í•˜ì„¸ìš”.";
            document.getElementById("heroImage").src = DATA.hero?.image || "/uploads/sample-banner-product.png";
        }

        function uniqueNonEmpty(arr) {
            const set = new Set();
            arr.forEach(v => {
                const s = (v ?? "").toString().trim();
                if (s) set.add(s);
            });
            return Array.from(set);
        }

        // âœ… í•„í„° ë²„íŠ¼ ëª©ë¡ ë§Œë“¤ê¸°
        function buildFilters() {
            if (TYPE === "food" && CATEGORY === "í•œì‹") {
                DATA.filters = HANSIK_SUBS.slice();
                return;
            }

            // í†µí•© + í•œì‹ ì™¸ food: business_subcategory ê¸°ë°˜ ìë™ ìƒì„±
            const subs = uniqueNonEmpty(ALL_STORES.map(s => getBusinessSubcategory(s)));

            subs.sort((a, b) => {
                if (a === "ê¸°íƒ€" && b !== "ê¸°íƒ€") return 1;
                if (b === "ê¸°íƒ€" && a !== "ê¸°íƒ€") return -1;
                return a.localeCompare(b, "ko");
            });

            if (subs.length <= 1) DATA.filters = [];
            else DATA.filters = subs;
        }

        function makeFilterBtn(label, tagVal) {
            const btn = document.createElement("button");
            btn.type = "button";

            const isActive = (CURRENT_SUB || "") === (tagVal || "");
            btn.className = isActive
                ? "px-3 py-1.5 rounded-full bg-black text-white text-sm"
                : "px-3 py-1.5 rounded-full bg-gray-200 hover:bg-gray-300 text-sm";

            btn.textContent = label;
            btn.onclick = () => applyFilter(tagVal || "", true);
            return btn;
        }

        function renderFilters() {
            const wrap = document.getElementById("filterContainer");
            wrap.innerHTML = "";

            // í•œì‹: detail_category
            if (TYPE === "food" && CATEGORY === "í•œì‹") {
                wrap.appendChild(makeFilterBtn("All", ""));
                HANSIK_SUBS.forEach(tag => wrap.appendChild(makeFilterBtn(tag, tag)));
                return;
            }

            // ê·¸ ì™¸: business_subcategory
            if (!DATA.filters.length) return;
            wrap.appendChild(makeFilterBtn("All", ""));
            DATA.filters.forEach(tag => wrap.appendChild(makeFilterBtn(tag, tag)));
        }

        function resetSectionStatesToDefault() {
            state.all.expanded = false; state.all.page = 1;
            state.best.expanded = false; state.best.page = 1;
            state.nw.expanded = false; state.nw.page = 1;

            document.getElementById("btnToggleAll").textContent = "ë”ë³´ê¸°";
            document.getElementById("btnToggleBest").textContent = "ë”ë³´ê¸°";
            document.getElementById("btnToggleNew").textContent = "ë”ë³´ê¸°";
        }

        function applyFilter(subVal, updateHistory = true) {
            // âœ… í•„í„° ë°”ë€Œë©´ ë¬´ì¡°ê±´ ì›ìœ„ì¹˜(ìš”êµ¬ì‚¬í•­)
            resetSectionStatesToDefault();

            CURRENT_SUB = (subVal || "").trim();

            let filtered = ALL_STORES.slice();

            // í•œì‹: detail_category
            if (TYPE === "food" && CATEGORY === "í•œì‹") {
                if (CURRENT_SUB) filtered = ALL_STORES.filter(s => getDetailCategory(s) === CURRENT_SUB);
                setHansikHero(CURRENT_SUB || "");
            } else {
                // í†µí•©/í•œì‹ ì™¸ food: business_subcategory í•„í„°(í•„í„°ê°€ ìˆì„ ë•Œë§Œ)
                if (DATA.filters.length && CURRENT_SUB) {
                    filtered = ALL_STORES.filter(s => getBusinessSubcategory(s) === CURRENT_SUB);
                }
                setDefaultHero();
            }

            // âœ… subë¡œ ê±¸ë €ëŠ”ë° 0ê°œë©´ All ë³µêµ¬
            if (!filtered.length && ALL_STORES.length) {
                CURRENT_SUB = "";
                filtered = ALL_STORES.slice();
                if (TYPE === "food" && CATEGORY === "í•œì‹") setHansikHero("");
            }

            DATA.stores = filtered;

            if (updateHistory) {
                const q = new URLSearchParams(location.search);
                if (CURRENT_SUB) q.set("sub", CURRENT_SUB);
                else q.delete("sub");
                history.replaceState(null, "", `${location.pathname}?${q.toString()}`);
            }

            bindHero();
            renderFilters();

            renderAll();
            renderBest();
            renderNew();
        }

        // ====== ë¦¬ìŠ¤íŠ¸ ê³„ì‚°(í•„í„° ê¸°ì¤€) ======
        function getAllList() {
            return (DATA.stores || []).slice();
        }

        function getBestList() {
            return (DATA.stores || [])
                .slice()
                .sort((a, b) => getStoreClicks(b) - getStoreClicks(a));
        }

        function getNewList() {
            const now = new Date();
            const cutoff = new Date(now.getTime() - NEW_DAYS * 24 * 60 * 60 * 1000);

            return (DATA.stores || [])
                .map(s => ({ s, d: getStoreCreatedAt(s) }))
                .filter(x => x.d && x.d >= cutoff)
                .sort((a, b) => b.d - a.d)
                .map(x => x.s);
        }

        // ====== ê³µí†µ: ë Œë” ìœ í‹¸ ======
        function goDetail(store) {
            const bt = (store.business_type ?? store.businessType ?? "").toString().trim();
            const type = (bt === "ìŒì‹ì " || bt === "ìŒì‹") ? "food" : "combined";
            const id = store.id ?? store.store_id ?? store.storeId ?? "";
            if (!id) return;
            window.location.href = `/ndetail.html?id=${encodeURIComponent(id)}&type=${encodeURIComponent(type)}`;
        }

        function makeStoreCard(store) {
            const card = document.createElement("div");
            card.className = "rounded-2xl cursor-pointer hover:shadow-lg transition overflow-hidden flex flex-col bg-white";

            const name = getStoreName(store);
            const cat = getStoreCategory(store);
            const img = getStoreImage(store);

            card.innerHTML = `
        <div class="relative h-[260px]">
          <img src="${img}" alt="${escapeHtml(name)}" class="w-full h-full object-cover rounded-t-2xl">
          <div class="absolute left-0 right-0 bottom-0 bg-white/90 backdrop-blur px-4 py-2 text-center rounded-b-2xl">
            <div class="font-bold text-lg text-gray-800 leading-tight truncate">${escapeHtml(name)}</div>
            <div class="text-sm text-gray-600">${escapeHtml(cat)}</div>
          </div>
        </div>
      `;
            card.addEventListener("click", () => goDetail(store));
            return card;
        }

        // ====== ê³µí†µ: "4ê°œ(ê¸°ë³¸) / 12ê°œ(í™•ì¥) + í˜ì´ì§€ë„¤ì´ì…˜" ======
        function computeVisible(list, expanded, page) {
            const total = list.length;
            if (!expanded) {
                return {
                    items: list.slice(0, COLLAPSE_COUNT),
                    total,
                    showPager: false,
                    page: 1,
                    totalPages: 1
                };
            }

            const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
            const p = Math.min(Math.max(1, page), totalPages);
            const start = (p - 1) * PAGE_SIZE;
            const end = start + PAGE_SIZE;

            return {
                items: list.slice(start, end),
                total,
                showPager: total > PAGE_SIZE,
                page: p,
                totalPages
            };
        }

        function renderPager(pagerElId, infoElId, prevId, nextId, numsId, vis, onPageChange) {
            const pager = document.getElementById(pagerElId);
            const info = document.getElementById(infoElId);
            const prev = document.getElementById(prevId);
            const next = document.getElementById(nextId);
            const nums = document.getElementById(numsId);

            if (!vis.showPager) {
                pager.classList.add("hidden");
                nums.innerHTML = "";
                info.textContent = "";
                return;
            }

            pager.classList.remove("hidden");

            const from = (vis.page - 1) * PAGE_SIZE + 1;
            const to = Math.min(vis.page * PAGE_SIZE, vis.total);
            info.textContent = `${from} - ${to} / ${vis.total}ê°œ Â· ${vis.page} / ${vis.totalPages} í˜ì´ì§€`;

            prev.disabled = (vis.page <= 1);
            next.disabled = (vis.page >= vis.totalPages);

            prev.className = prev.disabled
                ? "px-3 py-2 rounded-lg bg-gray-100 text-gray-300 font-semibold cursor-not-allowed"
                : "px-3 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold transition";

            next.className = next.disabled
                ? "px-3 py-2 rounded-lg bg-gray-100 text-gray-300 font-semibold cursor-not-allowed"
                : "px-3 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold transition";

            prev.onclick = () => onPageChange(vis.page - 1);
            next.onclick = () => onPageChange(vis.page + 1);

            nums.innerHTML = "";

            const makeNumBtn = (p) => {
                const b = document.createElement("button");
                const isActive = (p === vis.page);
                b.type = "button";
                b.textContent = String(p);
                b.className = isActive
                    ? "min-w-[40px] px-3 py-2 rounded-lg bg-black text-white font-bold"
                    : "min-w-[40px] px-3 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold transition";
                b.onclick = () => onPageChange(p);
                return b;
            };

            const addDots = () => {
                const d = document.createElement("span");
                d.className = "px-2 text-gray-400 font-bold";
                d.textContent = "â€¦";
                nums.appendChild(d);
            };

            if (vis.totalPages <= 7) {
                for (let p = 1; p <= vis.totalPages; p++) nums.appendChild(makeNumBtn(p));
                return;
            }

            nums.appendChild(makeNumBtn(1));
            const left = Math.max(2, vis.page - 2);
            const right = Math.min(vis.totalPages - 1, vis.page + 2);

            if (left > 2) addDots();
            for (let p = left; p <= right; p++) nums.appendChild(makeNumBtn(p));
            if (right < vis.totalPages - 1) addDots();

            nums.appendChild(makeNumBtn(vis.totalPages));
        }

        // ====== ì„¹ì…˜ë³„ ë Œë” ======
        function renderAll() {
            const list = getAllList();
            const vis = computeVisible(list, state.all.expanded, state.all.page);
            state.all.page = vis.page;

            const grid = document.getElementById("lineGrid");
            grid.innerHTML = "";

            if (!list.length) {
                grid.innerHTML = `
          <div class="col-span-full flex justify-center items-center py-16">
            <div class="p-8 text-center max-w-md">
              <h3 class="text-lg font-semibold text-gray-700 mb-2">ë“±ë¡ëœ ê°€ê²Œê°€ ì—†ìŠµë‹ˆë‹¤</h3>
              <p class="text-sm text-gray-500">ë¹ ë¥¸ ì‹œì¼ ë‚´ì— ìƒˆë¡œìš´ ê°€ê²Œê°€ ì¶”ê°€ë  ì˜ˆì •ì…ë‹ˆë‹¤.</p>
            </div>
          </div>`;
            } else {
                vis.items.forEach(s => grid.appendChild(makeStoreCard(s)));
            }

            renderPager("allPager", "allPageInfo", "allPrev", "allNext", "allNums", vis, (p) => {
                state.all.page = p;
                renderAll();
                document.getElementById("aboutSection").scrollIntoView({ behavior: "smooth", block: "start" });
            });
        }

        function renderBest() {
            const list = getBestList();
            const vis = computeVisible(list, state.best.expanded, state.best.page);
            state.best.page = vis.page;

            const grid = document.getElementById("bestGrid");
            grid.innerHTML = "";

            if (!list.length) {
                grid.innerHTML = `<div class="col-span-full text-center text-gray-500">ë“±ë¡ëœ ê°€ê²Œê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
            } else {
                vis.items.forEach(s => grid.appendChild(makeStoreCard(s)));
            }

            renderPager("bestPager", "bestPageInfo", "bestPrev", "bestNext", "bestNums", vis, (p) => {
                state.best.page = p;
                renderBest();
            });
        }

        function renderNew() {
            const list = getNewList();
            const vis = computeVisible(list, state.nw.expanded, state.nw.page);
            state.nw.page = vis.page;

            const grid = document.getElementById("newGrid");
            grid.innerHTML = "";

            if (!list.length) {
                grid.innerHTML = `<div class="col-span-full text-center text-gray-500">ë“±ë¡ëœ ê°€ê²Œê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
            } else {
                vis.items.forEach(s => grid.appendChild(makeStoreCard(s)));
            }

            renderPager("newPager", "newPageInfo", "newPrev", "newNext", "newNums", vis, (p) => {
                state.nw.page = p;
                renderNew();
            });
        }

        // ====== ë”ë³´ê¸° í† ê¸€ ======
        function bindToggles() {
            const btnAll = document.getElementById("btnToggleAll");
            const btnBest = document.getElementById("btnToggleBest");
            const btnNew = document.getElementById("btnToggleNew");

            btnAll.onclick = () => {
                state.all.expanded = !state.all.expanded;
                state.all.page = 1;
                btnAll.textContent = state.all.expanded ? "ì ‘ê¸°" : "ë”ë³´ê¸°";
                renderAll();
                document.getElementById("aboutSection").scrollIntoView({ behavior: "smooth", block: "start" });
            };

            btnBest.onclick = () => {
                state.best.expanded = !state.best.expanded;
                state.best.page = 1;
                btnBest.textContent = state.best.expanded ? "ì ‘ê¸°" : "ë”ë³´ê¸°";
                renderBest();
            };

            btnNew.onclick = () => {
                state.nw.expanded = !state.nw.expanded;
                state.nw.page = 1;
                btnNew.textContent = state.nw.expanded ? "ì ‘ê¸°" : "ë”ë³´ê¸°";
                renderNew();
            };
        }

        // ====== ë°ì´í„° ë¡œë“œ ======
        async function loadData() {
            try {
                ALL_STORES = [];
                DATA.stores = [];
                CURRENT_SUB = RAW_SUB;

                // âœ… ì´ˆê¸° ìƒíƒœëŠ” ë¬´ì¡°ê±´ ì›ìœ„ì¹˜(ìš”êµ¬ì‚¬í•­)
                resetSectionStatesToDefault();

                if (TYPE === "food") {
                    const q = new URLSearchParams();
                    q.set("category", CATEGORY);
                    const json = await fetchJson(`/api/subcategory/food?${q.toString()}`);
                    ALL_STORES = (json.stores || []);
                } else {
                    // âœ… í†µí•©: /api/subcategory/combined ì‹œë„ â†’ ì—†ìœ¼ë©´ beautyë¡œ í´ë°±
                    try {
                        const json = await fetchJson(`/api/subcategory/combined?category=${encodeURIComponent(CATEGORY)}`);
                        ALL_STORES = (json.stores || []);
                    } catch (e) {
                        const json = await fetchJson(`/api/subcategory/beauty?category=${encodeURIComponent(CATEGORY)}`);
                        ALL_STORES = (json.stores || []);
                    }
                    ALL_STORES = ALL_STORES.filter(s => getStoreCategory(s) === CATEGORY);
                }

                buildFilters();

                if (TYPE === "food" && CATEGORY === "í•œì‹") setHansikHero(CURRENT_SUB || "");
                else setDefaultHero();

                bindHero();
                renderFilters();

                // âœ… ìµœì´ˆ ì ìš©(ë§í¬ì— subê°€ ìˆìœ¼ë©´ ë°˜ì˜)
                applyFilter(CURRENT_SUB || "", false);

            } catch (e) {
                console.error("ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", e);
                ALL_STORES = [];
                DATA.filters = [];
                DATA.stores = [];

                setDefaultHero();
                bindHero();
                renderFilters();

                resetSectionStatesToDefault();
                renderAll();
                renderBest();
                renderNew();
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            bindToggles();

            document.getElementById("btnMoreHero").onclick = () => {
                document.getElementById("aboutSection").scrollIntoView({ behavior: "smooth", block: "start" });
            };

            loadData();
        });

        function goBack() {
            if (document.referrer && document.referrer !== location.href) window.history.back();
            else window.location.href = "/foodcategory.html";
        }
        function goNext() { window.history.forward(); }
    </script>
</body>

</html>