<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì„œë¸Œ ì¹´í…Œê³ ë¦¬ í˜ì´ì§€</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-white text-gray-800 min-h-screen flex flex-col">
    <div id="header-placeholder"></div>

    <section class="relative h-[70vh] max-h-[400px] flex items-center justify-between px-8 bg-gray-50">
        <div class="flex-1 flex justify-center">
            <img id="heroImage" src="/uploads/no-image.png" alt="ë°°ë„ˆ" class="h-[280px] object-contain">
        </div>
        <div class="flex-1 text-left">
            <h1 id="heroTitle" class="text-3xl md:text-4xl font-bold mb-4">ì¹´í…Œê³ ë¦¬ ì œëª©</h1>
            <p id="heroSubtitle" class="text-gray-600 mb-6">ì¹´í…Œê³ ë¦¬ ì„¤ëª…</p>
            <!-- íˆì–´ë¡œ MOREëŠ” "All of the items ë”ë³´ê¸°" í† ê¸€ë¡œ ì‚¬ìš© -->
            <button id="btnMoreHero" class="px-5 py-2.5 bg-black text-white font-semibold rounded-lg">MORE VIEW</button>
        </div>
    </section>

    <!-- All of the items -->
    <section id="aboutSection" class="max-w-6xl mx-auto py-12 px-4 w-full">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl md:text-2xl font-bold">All of the items</h2>
            <button id="btnMoreItems"
                class="px-4 py-2 rounded-lg bg-gray-900 text-white text-sm font-semibold">ë”ë³´ê¸°</button>
        </div>
        <div id="filterContainer" class="flex justify-center flex-wrap gap-3 mb-8"></div>
        <div id="lineGrid" class="grid grid-cols-1 gap-4"></div>

        <!-- pagination -->
        <div id="itemsPager" class="mt-8 flex justify-center items-center gap-3 hidden">
            <button id="itemsPrev" class="px-3 py-2 rounded bg-gray-200 hover:bg-gray-300 text-sm">ì´ì „</button>
            <div id="itemsPageInfo" class="text-sm font-semibold text-gray-700"></div>
            <button id="itemsNext" class="px-3 py-2 rounded bg-gray-200 hover:bg-gray-300 text-sm">ë‹¤ìŒ</button>
        </div>
    </section>

    <!-- Best Seller -->
    <section class="max-w-6xl mx-auto py-12 px-4 w-full">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl md:text-2xl font-bold">Best Seller</h2>
            <button id="btnMoreBest"
                class="px-4 py-2 rounded-lg bg-gray-900 text-white text-sm font-semibold">ë”ë³´ê¸°</button>
        </div>
        <div id="bestGrid" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>

        <div id="bestPager" class="mt-8 flex justify-center items-center gap-3 hidden">
            <button id="bestPrev" class="px-3 py-2 rounded bg-gray-200 hover:bg-gray-300 text-sm">ì´ì „</button>
            <div id="bestPageInfo" class="text-sm font-semibold text-gray-700"></div>
            <button id="bestNext" class="px-3 py-2 rounded bg-gray-200 hover:bg-gray-300 text-sm">ë‹¤ìŒ</button>
        </div>
    </section>

    <!-- New registration -->
    <section class="max-w-6xl mx-auto py-12 px-4 w-full">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl md:text-2xl font-bold">New registration</h2>
            <button id="btnMoreNew"
                class="px-4 py-2 rounded-lg bg-gray-900 text-white text-sm font-semibold">ë”ë³´ê¸°</button>
        </div>
        <div id="newGrid" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>

        <div id="newPager" class="mt-8 flex justify-center items-center gap-3 hidden">
            <button id="newPrev" class="px-3 py-2 rounded bg-gray-200 hover:bg-gray-300 text-sm">ì´ì „</button>
            <div id="newPageInfo" class="text-sm font-semibold text-gray-700"></div>
            <button id="newNext" class="px-3 py-2 rounded bg-gray-200 hover:bg-gray-300 text-sm">ë‹¤ìŒ</button>
        </div>
    </section>

    <div id="footer-placeholder"></div>

    <div class="fixed bottom-6 right-6 flex flex-col items-center gap-4 z-50">
        <div class="flex flex-col items-center">
            <button onclick="goBack()"
                class="w-14 h-14 flex items-center justify-center rounded-full bg-gradient-to-br from-gray-100 to-gray-200 text-gray-700 shadow hover:from-gray-200 hover:to-gray-300 transition">â†</button>
            <span class="text-xs mt-1 text-gray-600 font-semibold">ì´ì „</span>
        </div>

        <div class="flex flex-col items-center">
            <button onclick="goNext()"
                class="w-14 h-14 flex items-center justify-center rounded-full bg-gradient-to-br from-gray-100 to-gray-200 text-gray-700 shadow hover:from-gray-200 hover:to-gray-300 transition">â†’</button>
            <span class="text-xs mt-1 text-gray-600 font-semibold">ë‹¤ìŒ</span>
        </div>

        <div class="flex flex-col items-center">
            <a href="/index.html"
                class="w-14 h-14 flex items-center justify-center rounded-full bg-gradient-to-br from-blue-500 to-blue-600 text-white shadow hover:from-blue-600 hover:to-blue-700 transition">ğŸ </a>
            <span class="text-xs mt-1 text-gray-600 font-semibold">í™ˆ</span>
        </div>
    </div>

    <script>
        // header/footer
        fetch("/components/header.html").then(r => r.text()).then(d => (document.getElementById("header-placeholder").innerHTML = d));
        fetch("/components/footer.html").then(r => r.text()).then(d => (document.getElementById("footer-placeholder").innerHTML = d));

        // URL params
        const params = new URLSearchParams(window.location.search);
        const TYPE = (params.get("type") || "food").toLowerCase();

        // âœ… category/subcategory (ë‘˜ ë‹¤ ì§€ì›)
        const RAW_CATEGORY = (params.get("category") || "").trim();
        const RAW_SUB = (params.get("sub") || params.get("subcategory") || "").trim();

        let CATEGORY = RAW_CATEGORY;
        let SUB = RAW_SUB;

        // í•œì‹ ì†Œì œëª©(ê³ ì •)
        const HANSIK_SUBS = ["ë°¥", "ì°Œê°œíƒ•", "ê³ ê¸°êµ¬ì´", "ìƒì„ ", "ì¡±ë°œë³´ìŒˆ", "êµ­ë°¥", "ë°˜ì°¬", "ê¸°íƒ€í•œì‹"];

        // âœ… ë¯¸ìš©/ì´ë°œ ë²„íŠ¼(í•„í„°)
        const BEAUTY_TYPE_FILTERS = ["ë¯¸ìš©", "ì´ë°œ", "ê¸°íƒ€"];

        // ì „ì²´ ë°ì´í„°ë¥¼ 1ë²ˆë§Œ ë°›ì•„ë‘ê³ , í™”ë©´ì€ ì—¬ê¸°ì„œ í•„í„°ë§
        let ALL_STORES = [];
        let CURRENT_SUB = SUB;

        const DEFAULT_DATA = {
            hero: { title: "ìƒ˜í”Œ ì¹´í…Œê³ ë¦¬", subtitle: "ê¸°ë³¸ ì„¤ëª… í…ìŠ¤íŠ¸", image: "/uploads/no-image.png" },
            filters: [],
            stores: [],
            best: [],
            new: []
        };
        let DATA = { ...DEFAULT_DATA };

        // âœ… ë”ë³´ê¸°/í˜ì´ì§€ë„¤ì´ì…˜ ìƒíƒœ (ìš”êµ¬ì‚¬í•­: ê¸°ë³¸ 8ê°œ, ë”ë³´ê¸° ì‹œ 12ê°œ + í˜ì´ì§€ë„¤ì´ì…˜)
        const COLLAPSED_COUNT = 8;
        const PAGE_SIZE = 12;

        const sectionState = {
            items: { expanded: false, page: 1 },
            best: { expanded: false, page: 1 },
            newly: { expanded: false, page: 1 }
        };

        function escapeHtml(input) {
            const s = input == null ? "" : String(input);
            return s.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;").replace(/'/g, "&#39;");
        }

        function normalizeSrc(src) {
            if (!src) return "/uploads/no-image.png";
            if (/^https?:\/\//i.test(src)) return src;
            return src.startsWith("/") ? src : "/" + src;
        }

        function pickImage(store) {
            // combined_store_info ê¸°ì¤€: main_image_url
            const cand = store.main_image_url || store.image_url || store.image || store.url || "";
            return normalizeSrc(cand);
        }

        function getDetailCategory(store) {
            const raw = (store.detail_category ?? store.detailCategory ?? "").toString().trim();
            return raw ? raw : "ê¸°íƒ€í•œì‹";
        }

        function getCombinedSubcategory(store) {
            return (store.business_subcategory ?? store.businessSubcategory ?? "").toString().trim();
        }

        function getBeautyType(store) {
            // DBì— business_typeì´ "ë¯¸ìš©"/"ì´ë°œ"ë¡œ ì €ì¥ë¨(ë„ˆê°€ ë ˆì§€ìŠ¤í„°ì—ì„œ ìë™ì„¤ì •í•´ë‘ )
            const t = (store.business_type ?? store.businessType ?? "").toString().trim();
            if (t === "ë¯¸ìš©") return "ë¯¸ìš©";
            if (t === "ì´ë°œ") return "ì´ë°œ";
            return "ê¸°íƒ€";
        }

        function setHero(title, subtitle) {
            DATA.hero = {
                title: title || "ì¹´í…Œê³ ë¦¬",
                subtitle: subtitle || "ì¹´í…Œê³ ë¦¬ë³„ ê°€ê²Œë¥¼ í™•ì¸í•˜ì„¸ìš”.",
                image: "/uploads/no-image.png"
            };
        }

        function setHansikHero(subVal) {
            const titleBase = "í•œì‹";
            const subLabel = subVal ? ` Â· ${subVal}` : "";
            DATA.hero = {
                title: `${titleBase}${subLabel}`,
                subtitle:
                    subVal === "ë°¥" ? "ë¹„ë¹”ë°¥ Â· ë®ë°¥ Â· ë°±ë°˜ ë“± ë“ ë“ í•œ í•œ ë¼ ëª¨ìŒ"
                        : subVal === "ì°Œê°œíƒ•" ? "ë”°ëˆí•œ ì°Œê°œì™€ ì–¼í°í•œ íƒ• ìš”ë¦¬ë¥¼ ëª¨ì•˜ì–´ìš”"
                            : subVal === "ê³ ê¸°êµ¬ì´" ? "ì‚¼ê²¹ì‚´, ê°ˆë¹„, ìˆ¯ë¶ˆêµ¬ì´ ë“± ê³ ê¸° ì¢‹ì•„í•˜ëŠ” ë‚ ì— ë”±!"
                                : subVal === "ìƒì„ " ? "êµ¬ì´ Â· ì¡°ë¦¼ Â· íšŒ ë“± ë‹¤ì–‘í•œ ìƒì„  ìš”ë¦¬"
                                    : subVal === "ì¡±ë°œë³´ìŒˆ" ? "ì¡±ë°œ Â· ë³´ìŒˆ Â· ìˆ˜ìœ¡ê¹Œì§€ í‘¸ì§í•˜ê²Œ"
                                        : subVal === "êµ­ë°¥" ? "ëœ¨ëˆí•œ êµ­ë°¥ í•œ ê·¸ë¦‡ìœ¼ë¡œ ë“ ë“ í•˜ê²Œ"
                                            : subVal === "ë°˜ì°¬" ? "ì§‘ë°¥ ëŠë‚Œ ë‚˜ëŠ” ë°˜ì°¬/ë„ì‹œë½ ê°€ê²Œ ëª¨ìŒ"
                                                : subVal === "ê¸°íƒ€í•œì‹" ? "í•œì‹ ë¶„ë¥˜ì— ë“¤ì–´ê°€ì§€ ì•ŠëŠ” ë‹¤ì–‘í•œ ë©”ë‰´ ëª¨ìŒ"
                                                    : "ìš°ë¦¬ë™ë„¤ í•œì‹ ë§›ì§‘ë“¤ì„ ëª¨ì•˜ìŠµë‹ˆë‹¤.",
                image: "/uploads/no-image.png"
            };
        }

        async function fetchJson(url) {
            const res = await fetch(url);
            const json = await res.json();
            if (!res.ok) {
                // 500ì¼ ë•Œë„ jsonì´ ë‚´ë ¤ì˜¤ë©´ ê°™ì´ ë¡œê·¸ì— ë‚¨ê¸°ì
                console.error("âŒ fetchJson not ok:", res.status, url, json);
            }
            return json;
        }

        // âœ… ë§¤ë‹ˆì € API í˜¸ì¶œ í—¬í¼
        const GRID_API_BASE = "/subcategorymanager/ad";

        function sectionKeyToManagerSection(key) {
            if (key === "items") return "all_items";
            if (key === "best") return "best_seller";
            if (key === "newly") return "new_registration";
            return "all_items";
        }

        async function fetchManagerGrid(sectionKey, pageNo) {
            const section = sectionKeyToManagerSection(sectionKey);
            const qs = new URLSearchParams();
            qs.set("page", "subcategory");
            qs.set("section", section);
            qs.set("mode", TYPE);          // "food" | "combined"
            qs.set("pageNo", String(pageNo || 1));
            if (CATEGORY) qs.set("category", CATEGORY);
            if (CURRENT_SUB) qs.set("subcategory", CURRENT_SUB);

            return await fetchJson(`${GRID_API_BASE}/grid?${qs.toString()}`);
        }

        function gridItemsToStores(items, limit) {
            const stores = (items || [])
                .filter((it) => it && it.occupied) // empty ì œì™¸
                .map((it) => ({
                    id: it.store_id,
                    business_number: it.business_no || "",
                    business_name: it.business_name || "",
                    business_type: it.store_type || "",
                    image_url: it.image_url || "",
                    // í•„ìš”í•˜ë©´ source/positionë„ ë³´ê´€ ê°€ëŠ¥(í™”ë©´ ë…¸ì¶œ X)
                    _source: it.source,
                    _position: it.position,
                }));

            return typeof limit === "number" ? stores.slice(0, limit) : stores;
        }

        function buildDynamicFiltersFromStores(stores) {
            // business_subcategory ê¸°ë°˜ìœ¼ë¡œ unique ìƒì„±
            const set = new Set();
            (stores || []).forEach(s => {
                const sub = getCombinedSubcategory(s);
                if (sub) set.add(sub);
            });
            const list = Array.from(set);
            // ë³´ê¸° ì¢‹ê²Œ ì •ë ¬(í•œê¸€/ì˜ë¬¸ ì„ì—¬ë„ OK)
            list.sort((a, b) => a.localeCompare(b, "ko"));
            return list;
        }

        function buildBestFromStores(stores) {
            // Best = view_count/viewCount ê¸°ì¤€ ë‚´ë¦¼ì°¨ìˆœ
            const arr = (stores || []).slice();
            arr.sort((a, b) => {
                const av = Number(a.view_count ?? a.viewCount ?? 0);
                const bv = Number(b.view_count ?? b.viewCount ?? 0);
                return bv - av;
            });
            return arr;
        }

        function buildNewFromStores(stores) {
            // New = ìµœê·¼ 60ì¼(ì•½ 2ë‹¬) + created_at ê¸°ì¤€ ìµœì‹ ìˆœ
            const now = Date.now();
            const limitMs = 60 * 24 * 60 * 60 * 1000;

            const arr = (stores || []).filter(s => {
                const t = Date.parse(s.created_at ?? s.createdAt ?? "");
                if (!Number.isFinite(t)) return false;
                return (now - t) <= limitMs;
            });

            arr.sort((a, b) => {
                const at = Date.parse(a.created_at ?? a.createdAt ?? "") || 0;
                const bt = Date.parse(b.created_at ?? b.createdAt ?? "") || 0;
                return bt - at;
            });

            return arr;
        }

        function resetPagingAll() {
            sectionState.items.page = 1;
            sectionState.best.page = 1;
            sectionState.newly.page = 1;
        }

        function applySubFilter(subVal, updateHistory = true) {
            const sub = (subVal || "").trim();
            CURRENT_SUB = sub;

            // âœ… í•œì‹ì—ì„œë§Œ detail_categoryë¡œ ë¶„ë¦¬
            if (TYPE === "food" && CATEGORY === "í•œì‹") {
                if (!sub) {
                    DATA.stores = ALL_STORES.slice();
                    setHansikHero("");
                    if (updateHistory) {
                        const q = new URLSearchParams(location.search);
                        q.delete("sub");
                        q.delete("subcategory");
                        history.replaceState(null, "", `${location.pathname}?${q.toString()}`);
                    }
                    return;
                }

                DATA.stores = ALL_STORES.filter(s => getDetailCategory(s) === sub);
                setHansikHero(sub);

                if (updateHistory) {
                    const q = new URLSearchParams(location.search);
                    q.set("subcategory", sub); // âœ… í‘œì¤€ì€ subcategoryë¡œ ìœ ì§€
                    q.delete("sub");
                    history.replaceState(null, "", `${location.pathname}?${q.toString()}`);
                }
                return;
            }

            // âœ… combined: ë¯¸ìš©/ì´ë°œë§Œ business_typeìœ¼ë¡œ ë¶„ë¦¬
            if (TYPE === "combined" && CATEGORY === "ë¯¸ìš©/ì´ë°œ") {
                if (!sub) {
                    DATA.stores = ALL_STORES.slice();
                    setHero("ë¯¸ìš©/ì´ë°œ", "ë¯¸ìš©/ì´ë°œ ì¹´í…Œê³ ë¦¬ ê°€ê²Œë¥¼ í™•ì¸í•˜ì„¸ìš”.");
                    if (updateHistory) {
                        const q = new URLSearchParams(location.search);
                        q.delete("sub");
                        q.delete("subcategory");
                        history.replaceState(null, "", `${location.pathname}?${q.toString()}`);
                    }
                    return;
                }

                DATA.stores = ALL_STORES.filter(s => getBeautyType(s) === sub);
                setHero(`ë¯¸ìš©/ì´ë°œ Â· ${sub}`, "ì„ íƒí•œ ë¶„ë¥˜ì˜ ê°€ê²Œë¥¼ í™•ì¸í•˜ì„¸ìš”.");

                if (updateHistory) {
                    const q = new URLSearchParams(location.search);
                    q.set("category", "ë¯¸ìš©/ì´ë°œ");
                    q.set("subcategory", sub);
                    q.delete("sub");
                    history.replaceState(null, "", `${location.pathname}?${q.toString()}`);
                }
                return;
            }

            // âœ… combined: ê·¸ ì™¸ëŠ” business_subcategoryë¡œ ë¶„ë¦¬
            if (TYPE === "combined" && DATA.filters && DATA.filters.length) {
                if (!sub) {
                    DATA.stores = ALL_STORES.slice();
                    setHero(CATEGORY, "ì¹´í…Œê³ ë¦¬ë³„ ê°€ê²Œë¥¼ í™•ì¸í•˜ì„¸ìš”.");
                    if (updateHistory) {
                        const q = new URLSearchParams(location.search);
                        q.delete("sub");
                        q.delete("subcategory");
                        history.replaceState(null, "", `${location.pathname}?${q.toString()}`);
                    }
                    return;
                }

                DATA.stores = ALL_STORES.filter(s => getCombinedSubcategory(s) === sub);
                setHero(`${CATEGORY} Â· ${sub}`, "ì„ íƒí•œ ì„œë¸Œì¹´í…Œê³ ë¦¬ì˜ ê°€ê²Œë¥¼ í™•ì¸í•˜ì„¸ìš”.");

                if (updateHistory) {
                    const q = new URLSearchParams(location.search);
                    q.set("subcategory", sub);
                    q.delete("sub");
                    history.replaceState(null, "", `${location.pathname}?${q.toString()}`);
                }
                return;
            }

            // ê·¸ ì™¸ëŠ” í•„í„° ì—†ìŒ
            DATA.stores = ALL_STORES.slice();
            setHero(CATEGORY, "ì¹´í…Œê³ ë¦¬ë³„ ê°€ê²Œë¥¼ í™•ì¸í•˜ì„¸ìš”.");
        }

        function renderStoresGrid(stores, gridEl) {
            gridEl.innerHTML = "";

            if (!stores || !stores.length) {
                gridEl.innerHTML = `
          <div class="col-span-full flex justify-center items-center py-16">
            <div class="p-8 text-center max-w-md">
              <h3 class="text-lg font-semibold text-gray-700 mb-2">ë“±ë¡ëœ ê°€ê²Œê°€ ì—†ìŠµë‹ˆë‹¤</h3>
              <p class="text-sm text-gray-500">ë¹ ë¥¸ ì‹œì¼ ë‚´ì— ìƒˆë¡œìš´ ê°€ê²Œê°€ ì¶”ê°€ë  ì˜ˆì •ì…ë‹ˆë‹¤.</p>
            </div>
          </div>`;
                return;
            }

            const wrapper = document.createElement("div");
            wrapper.className = "col-span-full grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6";

            stores.forEach(store => {
                const card = document.createElement("div");
                card.className = "rounded-2xl cursor-pointer hover:shadow-lg transition overflow-hidden flex flex-col h-auto bg-white";

                const dispName = store.business_name ?? store.name ?? store.businessName ?? store.title ?? "-";
                const dispCategory = store.business_category ?? store.category ?? store.businessCategory ?? "";
                const imgNorm = pickImage(store);

                card.innerHTML = `
          <div class="relative h-[260px]">
            <img src="${imgNorm}" alt="${escapeHtml(dispName)}" class="w-full h-full object-cover rounded-t-2xl">
            <div class="absolute left-0 right-0 bottom-0 bg-white/90 backdrop-blur px-4 py-2 text-center rounded-b-2xl">
              <div class="font-bold text-lg text-gray-800 leading-tight truncate">${escapeHtml(dispName)}</div>
              <div class="text-sm text-gray-600">${escapeHtml(dispCategory)}</div>
            </div>
          </div>`;

                card.addEventListener("click", () => {
                    const bt = store.business_type ?? store.businessType ?? "";
                    const type = (bt === "ìŒì‹ì " || bt === "ìŒì‹") ? "food" : "combined";
                    window.location.href = `/ndetail.html?id=${store.id}&type=${type}`;
                });

                wrapper.appendChild(card);
            });

            gridEl.appendChild(wrapper);
        }

        function renderSmallGrid(gridId, items) {
            const grid = document.getElementById(gridId);
            grid.innerHTML = "";

            if (!items || !items.length) {
                grid.innerHTML = `<div class="col-span-full text-center text-gray-500">ë“±ë¡ëœ ê°€ê²Œê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
                return;
            }

            items.forEach(item => {
                const name = item.business_name ?? item.name ?? "-";
                const img = pickImage(item);

                const card = document.createElement("a");
                card.href = "#";
                card.className = "block rounded-2xl overflow-hidden bg-white hover:shadow-lg transition";
                card.innerHTML = `
          <div class="h-40">
            <img src="${img}" alt="${escapeHtml(name)}" class="w-full h-full object-cover">
          </div>
          <div class="p-3 text-sm font-semibold truncate">${escapeHtml(name)}</div>
        `;
                grid.appendChild(card);
            });
        }

        function bindHero() {
            document.getElementById("heroTitle").innerHTML = (DATA.hero?.title || "").replace(/\n/g, "<br>");
            document.getElementById("heroSubtitle").textContent = DATA.hero?.subtitle || "";
            document.getElementById("heroImage").src = DATA.hero?.image || "/uploads/no-image.png";
        }

        function makeFilterBtn(label, tagVal) {
            const btn = document.createElement("button");
            btn.type = "button";

            const isActive = (CURRENT_SUB || "") === (tagVal || "");
            btn.className = isActive
                ? "px-3 py-1.5 rounded-full bg-black text-white text-sm"
                : "px-3 py-1.5 rounded-full bg-gray-200 hover:bg-gray-300 text-sm";

            btn.textContent = label;

            btn.onclick = async () => {
                resetPagingAll();
                applySubFilter(tagVal || "", true);
                bindHero();
                renderFilters();
                await renderItemsSection(); // âœ… All items ê°±ì‹ 
                renderBestSection();
                renderNewSection();
            };
            return btn;
        }

        function renderFilters() {
            const wrap = document.getElementById("filterContainer");
            wrap.innerHTML = "";

            // âœ… í•œì‹: ê³ ì • ì†Œì œëª©
            if (TYPE === "food" && CATEGORY === "í•œì‹") {
                wrap.appendChild(makeFilterBtn("All", ""));
                HANSIK_SUBS.forEach(tag => wrap.appendChild(makeFilterBtn(tag, tag)));
                return;
            }

            // âœ… combined + ë¯¸ìš©/ì´ë°œ: ë¯¸ìš©/ì´ë°œ/ê¸°íƒ€ ë²„íŠ¼
            if (TYPE === "combined" && CATEGORY === "ë¯¸ìš©/ì´ë°œ") {
                wrap.appendChild(makeFilterBtn("All", ""));
                BEAUTY_TYPE_FILTERS.forEach(tag => wrap.appendChild(makeFilterBtn(tag, tag)));
                return;
            }

            // âœ… combined: ë™ì  ì„œë¸Œì¹´í…Œê³ ë¦¬ ë²„íŠ¼
            if (TYPE === "combined" && DATA.filters && DATA.filters.length) {
                wrap.appendChild(makeFilterBtn("All", ""));
                DATA.filters.forEach(tag => wrap.appendChild(makeFilterBtn(tag, tag)));
                return;
            }

            // ê·¸ ì™¸: ë²„íŠ¼ ì—†ìŒ
        }

        function getVisible(list, stateObj) {
            const listArr = (list || []);
            if (!stateObj.expanded) {
                return { slice: listArr.slice(0, COLLAPSED_COUNT), totalPages: 1 };
            }
            const totalPages = Math.max(1, Math.ceil(listArr.length / PAGE_SIZE));
            const page = Math.min(Math.max(1, stateObj.page), totalPages);
            stateObj.page = page;
            const start = (page - 1) * PAGE_SIZE;
            return { slice: listArr.slice(start, start + PAGE_SIZE), totalPages };
        }

        async function renderItemsSection() {
            const grid = document.getElementById("lineGrid");
            const pager = document.getElementById("itemsPager");
            const prev = document.getElementById("itemsPrev");
            const next = document.getElementById("itemsNext");
            const info = document.getElementById("itemsPageInfo");

            const pageNo = sectionState.items.expanded ? sectionState.items.page : 1;

            // âœ… ì„œë²„ ì„¹ì…˜ëª…ì€ all_items ê³ ì •
            const json = await fetchManagerGrid("all_items", pageNo);

            // âœ… ì ‘í˜ì´ë©´ 4ê°œë§Œ
            const stores = gridItemsToStores(
                json.items,
                sectionState.items.expanded ? undefined : 4
            );

            renderStoresGrid(stores, grid);

            // âœ… gridëŠ” í•­ìƒ 12ì¹¸ ë°°ì—´ì„ ì£¼ê¸° ë•Œë¬¸ì— totalPages ê³„ì‚°ì€ ì˜ë¯¸ê°€ ì—†ìŒ(í•­ìƒ 1)
            // ì¼ë‹¨ â€œë”ë³´ê¸°â€ í¼ì³¤ì„ ë•Œ prev/next ë²„íŠ¼ë§Œ ë³´ì´ê²Œ í•˜ë ¤ë©´ ì´ë ‡ê²Œ ì²˜ë¦¬
            if (!sectionState.items.expanded) {
                pager.classList.add("hidden");
            } else {
                pager.classList.remove("hidden");
                info.textContent = `page ${sectionState.items.page}`;
                prev.disabled = sectionState.items.page <= 1;

                // âœ… ë í˜ì´ì§€ë¥¼ ì„œë²„ê°€ ì•ˆ ë‚´ë ¤ì£¼ë¯€ë¡œ nextëŠ” ì¼ë‹¨ í•­ìƒ í—ˆìš©(ì›í•˜ë©´ ì„œë²„ì—ì„œ total_pages ë‚´ë ¤ì£¼ê²Œ ê°œì„  ê°€ëŠ¥)
                next.disabled = false;
            }
        }

        async function renderBestSection() {
            const pager = document.getElementById("bestPager");
            const prev = document.getElementById("bestPrev");
            const next = document.getElementById("bestNext");
            const info = document.getElementById("bestPageInfo");

            const pageNo = sectionState.best.expanded ? sectionState.best.page : 1;
            const json = await fetchManagerGrid("best", pageNo);
            const items = gridItemsToStores(json.items, sectionState.best.expanded ? undefined : 8);

            renderSmallGrid("bestGrid", items);

            const totalPages = Math.ceil((json.items?.length || 0) / 12);
            if (!sectionState.best.expanded || totalPages <= 1) {
                pager.classList.add("hidden");
            } else {
                pager.classList.remove("hidden");
                info.textContent = `${sectionState.best.page} / ${totalPages}`;
                prev.disabled = sectionState.best.page <= 1;
                next.disabled = sectionState.best.page >= totalPages;
            }
        }

        async function renderNewSection() {
            const pager = document.getElementById("newPager");
            const prev = document.getElementById("newPrev");
            const next = document.getElementById("newNext");
            const info = document.getElementById("newPageInfo");

            const pageNo = sectionState.newly.expanded ? sectionState.newly.page : 1;
            const json = await fetchManagerGrid("newly", pageNo);
            const items = gridItemsToStores(json.items, sectionState.newly.expanded ? undefined : 8);

            renderSmallGrid("newGrid", items);

            const totalPages = Math.ceil((json.items?.length || 0) / 12);
            if (!sectionState.newly.expanded || totalPages <= 1) {
                pager.classList.add("hidden");
            } else {
                pager.classList.remove("hidden");
                info.textContent = `${sectionState.newly.page} / ${totalPages}`;
                prev.disabled = sectionState.newly.page <= 1;
                next.disabled = sectionState.newly.page >= totalPages;
            }
        }

        function syncMoreButtonLabels() {
            document.getElementById("btnMoreItems").textContent = sectionState.items.expanded ? "ì ‘ê¸°" : "ë”ë³´ê¸°";
            document.getElementById("btnMoreBest").textContent = sectionState.best.expanded ? "ì ‘ê¸°" : "ë”ë³´ê¸°";
            document.getElementById("btnMoreNew").textContent = sectionState.newly.expanded ? "ì ‘ê¸°" : "ë”ë³´ê¸°";

            // íˆì–´ë¡œ MOREëŠ” items í† ê¸€ê³¼ ë™ì¼í•˜ê²Œ ë™ì‘
            document.getElementById("btnMoreHero").textContent = sectionState.items.expanded ? "CLOSE VIEW" : "MORE VIEW";
        }

        function bindMoreAndPagerEvents() {
            // Items
            document.getElementById("btnMoreItems").onclick = () => {
                sectionState.items.expanded = !sectionState.items.expanded;
                sectionState.items.page = 1; // âœ… ë”ë³´ê¸° ë‹¤ì‹œ ëˆ„ë¥´ë©´ ì›ìœ„ì¹˜
                syncMoreButtonLabels();
                renderItemsSection();
            };
            document.getElementById("btnMoreHero").onclick = () => {
                document.getElementById("btnMoreItems").click();
            };
            document.getElementById("itemsPrev").onclick = () => {
                sectionState.items.page = Math.max(1, sectionState.items.page - 1);
                renderItemsSection();
            };
            document.getElementById("itemsNext").onclick = () => {
                sectionState.items.page += 1;
                renderItemsSection();
            };

            // Best
            document.getElementById("btnMoreBest").onclick = async (e) => {
                e?.preventDefault?.();
                const keepY = window.scrollY;

                sectionState.best.expanded = !sectionState.best.expanded;
                sectionState.best.page = 1;
                syncMoreButtonLabels();
                await renderBestSection();

                requestAnimationFrame(() => window.scrollTo({ top: keepY, behavior: "auto" }));
            };
            document.getElementById("bestPrev").onclick = () => {
                sectionState.best.page = Math.max(1, sectionState.best.page - 1);
                renderBestSection();
            };
            document.getElementById("bestNext").onclick = () => {
                sectionState.best.page += 1;
                renderBestSection();
            };

            // New
            document.getElementById("btnMoreNew").onclick = async (e) => {
                e?.preventDefault?.();
                const keepY = window.scrollY;

                sectionState.newly.expanded = !sectionState.newly.expanded;
                sectionState.newly.page = 1;
                syncMoreButtonLabels();
                await renderNewSection();

                requestAnimationFrame(() => window.scrollTo({ top: keepY, behavior: "auto" }));
            };
            document.getElementById("newPrev").onclick = () => {
                sectionState.newly.page = Math.max(1, sectionState.newly.page - 1);
                renderNewSection();
            };
            document.getElementById("newNext").onclick = () => {
                sectionState.newly.page += 1;
                renderNewSection();
            };
        }

        async function loadData() {
            try {
                DATA = { ...DEFAULT_DATA };
                ALL_STORES = [];

                // ìƒíƒœ ë¦¬ì…‹(ìƒˆë¡œê³ ì¹¨/ì¬ì§„ì… ë™ì¼)
                sectionState.items.expanded = false; sectionState.items.page = 1;
                sectionState.best.expanded = false; sectionState.best.page = 1;
                sectionState.newly.expanded = false; sectionState.newly.page = 1;

                // âœ… TYPE=food
                if (TYPE === "food") {
                    const q = new URLSearchParams();
                    q.set("category", CATEGORY);

                    const json = await fetchJson(`/api/subcategory/food?${q.toString()}`);
                    ALL_STORES = json.stores || [];

                    if (CATEGORY === "í•œì‹") {
                        DATA.filters = HANSIK_SUBS.slice();
                        applySubFilter(CURRENT_SUB, false);
                    } else {
                        DATA.filters = [];
                        setHero(CATEGORY, "ì¹´í…Œê³ ë¦¬ë³„ ê°€ê²Œë¥¼ í™•ì¸í•˜ì„¸ìš”.");
                        DATA.stores = ALL_STORES.slice();
                    }

                    // best/newëŠ” ê¸°ì¡´ APIê°€ ìˆìœ¼ë©´ ì‚¬ìš©(ì—†ìœ¼ë©´ ë¹ˆ ë°°ì—´ ìœ ì§€)
                    try {
                        const best = await fetchJson(`/api/subcategory/food/best`);
                        DATA.best = best.stores || [];
                    } catch (_) { }
                    try {
                        const nw = await fetchJson(`/api/subcategory/food/new`);
                        DATA.new = nw.stores || [];
                    } catch (_) { }

                }
                // âœ… TYPE=combined
                else if (TYPE === "combined") {
                    const json = await fetchJson(`/api/subcategory/combined?category=${encodeURIComponent(CATEGORY)}`);
                    ALL_STORES = json.stores || [];

                    // âœ… í†µí•©: ê¸°ë³¸ì€ business_subcategory ê¸°ë°˜ í•„í„° ë²„íŠ¼ ìë™ ìƒì„±
                    if (CATEGORY === "ë¯¸ìš©/ì´ë°œ") {
                        // ë¯¸ìš©/ì´ë°œë§Œ ì˜ˆì™¸(ë¯¸ìš©/ì´ë°œ/ê¸°íƒ€)
                        DATA.filters = BEAUTY_TYPE_FILTERS.slice();
                        applySubFilter(CURRENT_SUB, false);
                    } else {
                        DATA.filters = buildDynamicFiltersFromStores(ALL_STORES);
                        // URLë¡œ subcategoryê°€ ì™”ìœ¼ë©´ ì ìš©, ì•„ë‹ˆë©´ ì „ì²´
                        applySubFilter(CURRENT_SUB, false);
                        if (!CURRENT_SUB) setHero(CATEGORY, "ì¹´í…Œê³ ë¦¬ë³„ ê°€ê²Œë¥¼ í™•ì¸í•˜ì„¸ìš”.");
                    }

                    // âœ… combined Best/NewëŠ” ì§€ê¸ˆ ë‹¹ì¥ ì„œë²„ API ì—†ì–´ë„ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ë§Œë“¤ ìˆ˜ ìˆìŒ
                    // - Best: view_count desc
                    // - New: ìµœê·¼ 60ì¼
                    DATA.best = buildBestFromStores(ALL_STORES);
                    DATA.new = buildNewFromStores(ALL_STORES);
                }
                else {
                    ALL_STORES = [];
                    DATA = { ...DEFAULT_DATA };
                }

            } catch (e) {
                console.error("ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", e);
                ALL_STORES = [];
                DATA = { ...DEFAULT_DATA };
            }

            await init();
        }

        async function init() {
            bindHero();
            renderFilters();
            syncMoreButtonLabels();
            bindMoreAndPagerEvents();

            // ê° ì„¹ì…˜ ë Œë”
            await renderItemsSection();
            await renderBestSection();
            await renderNewSection();
        }

        document.addEventListener("DOMContentLoaded", loadData);

        function goBack() {
            if (document.referrer && document.referrer !== location.href) window.history.back();
            else window.location.href = "/category.html";
        }
        function goNext() { window.history.forward(); }
    </script>
</body>

</html>