<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì˜¤í”ˆ ì˜ˆì • | MALL HANKOOK</title>
  <meta name="color-scheme" content="light" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: Pretendard, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans KR",
        sans-serif;
    }

    .page-bg {
      background:
        radial-gradient(circle at top left, rgba(129, 140, 248, 0.18), transparent 55%),
        radial-gradient(circle at bottom right, rgba(45, 212, 191, 0.18), transparent 55%),
        linear-gradient(135deg, #f9fafb, #eef2ff);
    }

    .neo-section {
      background: rgba(255, 255, 255, 0.82);
      backdrop-filter: blur(18px);
      border-radius: 1.75rem;
      border: 1px solid rgba(255, 255, 255, 0.8);
      box-shadow:
        10px 18px 40px rgba(15, 23, 42, 0.12),
        -8px -10px 30px rgba(255, 255, 255, 0.9);
      overflow: hidden;
    }

    .neo-card {
      background: radial-gradient(circle at top left, rgba(129, 140, 248, 0.12), transparent 45%),
        rgba(255, 255, 255, 0.9);
      border-radius: 1.5rem;
      border: 1px solid rgba(255, 255, 255, 0.9);
      box-shadow:
        6px 10px 26px rgba(15, 23, 42, 0.08),
        -6px -6px 16px rgba(255, 255, 255, 0.9);
      transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease, background 0.2s ease;
    }

    .neo-card:hover {
      transform: translateY(-6px);
      box-shadow:
        10px 16px 38px rgba(15, 23, 42, 0.14),
        -6px -8px 22px rgba(255, 255, 255, 0.95);
      border-color: rgba(129, 140, 248, 0.4);
      background: radial-gradient(circle at top left, rgba(129, 140, 248, 0.18), transparent 45%),
        rgba(255, 255, 255, 0.96);
    }

    .gradient-text {
      background: linear-gradient(110deg, #2563eb, #7c3aed, #06b6d4);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      color: transparent;
    }

    .badge-soft {
      border-radius: 9999px;
      font-size: 0.75rem;
      padding: 0.35rem 0.8rem;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: rgba(248, 250, 252, 0.9);
      color: #475569;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      font-weight: 600;
    }

    .dday-pill {
      border-radius: 9999px;
      font-size: 0.7rem;
      padding: 0.15rem 0.7rem;
      font-weight: 700;
      letter-spacing: 0.03em;
    }

    .dday-soon {
      background: rgba(244, 63, 94, 0.09);
      color: #be123c;
      border: 1px solid rgba(248, 113, 113, 0.65);
    }

    .dday-today {
      background: rgba(34, 197, 94, 0.08);
      color: #166534;
      border: 1px solid rgba(74, 222, 128, 0.7);
    }

    .dday-opened {
      background: rgba(59, 130, 246, 0.08);
      color: #1d4ed8;
      border: 1px solid rgba(96, 165, 250, 0.7);
    }

    .dday-far {
      background: rgba(148, 163, 184, 0.12);
      color: #475569;
      border: 1px solid rgba(148, 163, 184, 0.5);
    }

    .btn-primary-neo {
      border-radius: 9999px;
      background: linear-gradient(135deg, #2563eb, #7c3aed);
      color: #f9fafb;
      font-weight: 700;
      padding: 0.65rem 1.4rem;
      font-size: 0.9rem;
      box-shadow:
        0 10px 22px rgba(37, 99, 235, 0.35),
        inset 0 1px 0 rgba(255, 255, 255, 0.25);
      border: 1px solid rgba(191, 219, 254, 0.6);
      transition: transform 0.12s ease, box-shadow 0.12s ease, filter 0.12s ease;
    }

    .btn-primary-neo:hover {
      transform: translateY(-1px);
      box-shadow:
        0 14px 26px rgba(79, 70, 229, 0.45),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
      filter: brightness(1.02);
    }

    .btn-primary-neo:active {
      transform: translateY(0);
      box-shadow:
        0 8px 18px rgba(79, 70, 229, 0.35),
        inset 0 1px 0 rgba(255, 255, 255, 0.25);
    }

    .page-stat-card {
      border-radius: 1rem;
      border: 1px solid rgba(226, 232, 240, 0.9);
      background: rgba(255, 255, 255, 0.9);
      box-shadow:
        0 10px 24px rgba(15, 23, 42, 0.06),
        0 0 0 1px rgba(255, 255, 255, 0.8);
    }
  </style>
</head>

<body class="page-bg min-h-screen text-slate-900">
  <!-- í—¤ë” -->
  <div id="header-container"></div>

  <main class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 pt-8 pb-16">
    <!-- íˆì–´ë¡œ ì˜ì—­ -->
    <section class="mb-8 sm:mb-10">
      <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-6">
        <div>
          <p class="text-xs font-semibold tracking-[0.25em] text-indigo-500 uppercase mb-2">
            OPEN SOON
          </p>
          <h1 class="text-3xl sm:text-4xl md:text-5xl font-extrabold gradient-text leading-tight">
            ìš°ë¦¬ë™ë„¤ ì˜¤í”ˆ ì˜ˆì • ê°€ê²Œ
          </h1>
          <p class="mt-3 text-sm sm:text-base text-slate-600 max-w-xl">
            ê³§ ë¬¸ì„ ì—´ ê°€ê²Œë“¤ì„ ë¯¸ë¦¬ í™•ì¸í•˜ê³ , ì˜¤í”ˆ ë‚  ë°©ë¬¸ì„ ì¤€ë¹„í•´ ë³´ì„¸ìš”.
            MALL HANKOOKì´ ìš°ë¦¬ë™ë„¤ ìƒˆ ì‹œì‘ì„ í•œëˆˆì— ëª¨ì•„ë“œë¦½ë‹ˆë‹¤.
          </p>
        </div>

        <div class="flex gap-3 sm:gap-4">
          <div class="page-stat-card px-4 py-3 flex flex-col items-center min-w-[84px]">
            <span class="text-[11px] uppercase tracking-wide text-slate-500">ì „ì²´</span>
            <span id="totalCount" class="mt-1 text-xl font-extrabold text-slate-900">0</span>
            <span class="text-[11px] text-slate-400">ê³³</span>
          </div>
          <div class="page-stat-card px-4 py-3 flex flex-col items-center min-w-[84px]">
            <span class="text-[11px] uppercase tracking-wide text-slate-500">ì´ë²ˆ ë‹¬</span>
            <span id="thisMonthCount" class="mt-1 text-xl font-extrabold text-sky-700">0</span>
            <span class="text-[11px] text-slate-400">ì˜¤í”ˆ</span>
          </div>
        </div>
      </div>
    </section>

    <!-- ë¦¬ìŠ¤íŠ¸ ì„¹ì…˜ -->
    <section class="neo-section px-4 sm:px-6 lg:px-8 py-6 sm:py-8">
      <!-- ìƒë‹¨ ë°”: íƒ€ì´í‹€ + ë“±ë¡ ë²„íŠ¼ -->
      <div class="mb-5 sm:mb-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
        <div>
          <h2 class="text-xl sm:text-2xl font-bold text-slate-900 flex items-center gap-2">
            <span class="text-2xl">ğŸ‰</span>
            <span>ê³§ ë¬¸ì„ ì—´ ê°€ê²Œë“¤</span>
          </h2>
          <p class="mt-1 text-xs sm:text-sm text-slate-500">
            ì˜¤í”ˆ ì˜ˆì •ì¼ê³¼ ìœ„ì¹˜ë¥¼ í™•ì¸í•˜ê³ , ë§ˆìŒì— ë“œëŠ” ê°€ê²ŒëŠ” ë¯¸ë¦¬ ì¦ê²¨ì°¾ê¸°í•´ ë‘ì„¸ìš”.
          </p>
        </div>
        <button id="toggleFormBtn" class="btn-primary-neo self-start">
          + ì˜¤í”ˆ ì˜ˆì • ë“±ë¡
        </button>
      </div>

      <!-- ì¹´ë“œ ê·¸ë¦¬ë“œ -->
      <div id="cardContainer"
        class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5 sm:gap-6 place-items-stretch mb-6">
        <!-- JSë¡œ ì¹´ë“œ ì‚½ì… -->
      </div>

      <!-- ë¹ˆ ìƒíƒœ -->
      <div id="emptyState" class="hidden text-center py-14 text-slate-400 text-sm">
        ì•„ì§ ë“±ë¡ëœ ì˜¤í”ˆ ì˜ˆì • ê°€ê²Œê°€ ì—†ìŠµë‹ˆë‹¤.<br />
        <span class="text-slate-500">ê°€ê²Œ ì‚¬ì¥ë‹˜ì´ë¼ë©´ ì§€ê¸ˆ ë°”ë¡œ ì²« ë²ˆì§¸ ì˜¤í”ˆ ì˜ˆì • ê°€ê²Œë¥¼ ë“±ë¡í•´ ë³´ì„¸ìš”!</span>
      </div>

      <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
      <div id="paginationWrapper" class="mt-4 sm:mt-6 flex justify-center">
        <div id="pagination" class="flex gap-1 sm:gap-2 flex-wrap justify-center"></div>
      </div>
    </section>
  </main>

  <!-- í‘¸í„° -->
  <div id="footer-container"></div>

  <script>
    // ---------- ìœ í‹¸ ----------
    function formatOpenDate(dateStr) {
      if (!dateStr) return "";
      const base = dateStr.split("T")[0] || dateStr;
      const [year, month, day] = base.split("-");
      if (!year || !month || !day) return dateStr;
      return `${year}. ${parseInt(month, 10)}. ${parseInt(day, 10)}`;
    }

    function shortAddress(addr) {
      if (!addr) return "";
      const tokens = addr.trim().replace(/\s+/g, " ").split(" ");
      // ì‹œ/êµ°/êµ¬ ì´í›„ 2~3ê°œ ì •ë„ë§Œ ë…¸ì¶œ
      return tokens.slice(1, 4).join(" ");
    }

    function getDDayLabel(dateStr) {
      if (!dateStr) return { label: "", className: "dday-far" };
      const today = new Date();
      const target = new Date(dateStr);
      if (isNaN(target.getTime())) return { label: "", className: "dday-far" };

      // ì‹œì°¨ ë³´ì •: ë‚ ì§œë§Œ ë¹„êµ
      const t = new Date(today.getFullYear(), today.getMonth(), today.getDate());
      const d = new Date(target.getFullYear(), target.getMonth(), target.getDate());
      const diff = Math.round((d - t) / (1000 * 60 * 60 * 24)); // ì¼ìˆ˜

      if (diff === 0) return { label: "D-DAY", className: "dday-today" };
      if (diff > 0 && diff <= 7) return { label: `D-${diff}`, className: "dday-soon" };
      if (diff > 7) return { label: `D-${diff}`, className: "dday-far" };
      // ì´ë¯¸ ì˜¤í”ˆ
      return { label: "OPEN", className: "dday-opened" };
    }

    async function loadComponent(url, containerId) {
      try {
        const response = await fetch(url);
        if (!response.ok) throw new Error("HTTP error! status: " + response.status);
        const html = await response.text();
        document.getElementById(containerId).innerHTML = html;
      } catch (error) {
        console.error("Error loading " + url + ":", error);
      }
    }

    // ---------- ìƒíƒœ ----------
    let data = [];
    const ITEMS_PER_PAGE = 9;
    let currentPage = 1;
    let totalItems = 0;
    let totalPages = 1;

    const cardContainer = document.getElementById("cardContainer");
    const paginationContainer = document.getElementById("pagination");
    const paginationWrapper = document.getElementById("paginationWrapper");
    const emptyStateEl = document.getElementById("emptyState");

    // ---------- ë°ì´í„° ë¡œë“œ (/api/open) ----------
    async function fetchOpenStores() {
      try {
        const res = await fetch("/api/open");
        if (!res.ok) throw new Error("ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨");
        const response = await res.json();

        if (!response.success) {
          throw new Error(response.error || "ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨");
        }

        const rows = response.data || [];
        console.log("ğŸ“¥ /api/open ì‘ë‹µ:", rows);

        return rows.map((row) => ({
          id: row.id,
          store_name: row.store_name,
          open_date: row.open_date,
          category: row.category,
          phone: row.phone,
          description: row.description,
          address: row.address,
          detail_address: row.detail_address,
          thumbnail: row.image_path,
          lat: row.lat,
          lng: row.lng,
        }));
      } catch (e) {
        console.error("âŒ ì˜¤í”ˆì˜ˆì • ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:", e);
        return [];
      }
    }

    // ---------- í†µê³„ ë°°ì§€ ì—…ë°ì´íŠ¸ ----------
    function updateStats() {
      const totalEl = document.getElementById("totalCount");
      const monthEl = document.getElementById("thisMonthCount");
      if (!totalEl || !monthEl) return;

      totalEl.textContent = String(totalItems || 0);

      const now = new Date();
      const y = now.getFullYear();
      const m = now.getMonth();

      const thisMonthCount = data.filter((item) => {
        if (!item.open_date) return false;
        const d = new Date(item.open_date);
        if (isNaN(d.getTime())) return false;
        return d.getFullYear() === y && d.getMonth() === m;
      }).length;

      monthEl.textContent = String(thisMonthCount);
    }

    // ---------- ì¹´ë“œ ìƒì„± ----------
    function createCard(item, globalIndex) {
      if (!item) {
        const none = document.createElement("div");
        none.className =
          "neo-card flex flex-col items-center justify-center p-6 text-slate-500 rounded-3xl shadow-inner min-h-[260px]";
        none.innerHTML = `
          <img src="https://placehold.co/400x200?text=ì •ë³´+ì—†ìŒ" 
               class="w-full h-40 object-cover rounded-2xl mb-3 opacity-70" 
               alt="ì •ë³´ ì—†ìŒ">
          <div class="text-lg font-bold mb-2">ë“±ë¡ëœ ì •ë³´ ì—†ìŒ</div>
          <p class="text-sm text-slate-500">ì˜¤í”ˆì˜ˆì • ê°€ê²Œê°€ ì•„ì§ ì—†ìŠµë‹ˆë‹¤.</p>
        `;
        return none;
      }

      const { label: ddayLabel, className: ddayClass } = getDDayLabel(item.open_date);
      const prettyDate = item.open_date ? formatOpenDate(item.open_date) : "";
      const shortAddr = shortAddress(item.address || "");

      const cardDiv = document.createElement("button");
      cardDiv.type = "button";
      cardDiv.className = `
        neo-card w-full h-full p-4 sm:p-5 flex flex-col text-left cursor-pointer
        focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-400 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-50
      `;

      cardDiv.innerHTML = `
        <div class="relative w-full h-40 sm:h-44 rounded-2xl overflow-hidden mb-3">
          <img
            src="${item.thumbnail || "https://placehold.co/400x220?text=No+Image"}"
            alt="${item.store_name || "-"} ì´ë¯¸ì§€"
            class="w-full h-full object-cover transition-transform duration-500 hover:scale-105"
            onerror="this.src='https://placehold.co/400x220?text=Image+Not+Found'; this.onerror=null;"
          />
          <div class="absolute top-3 left-3 flex flex-col gap-2">
            ${ddayLabel
          ? `<span class="dday-pill ${ddayClass} shadow-sm">${ddayLabel}</span>`
          : ""
        }
            ${prettyDate
          ? `<span class="badge-soft bg-white/85 text-slate-700 border-slate-200/80">
                     <span class="text-xs">ğŸ“… ì˜¤í”ˆ</span>
                     <span class="text-xs font-semibold">${prettyDate}</span>
                   </span>`
          : ""
        }
          </div>
        </div>

        <div class="flex-1 flex flex-col justify-between">
          <div class="space-y-1.5">
            <h3 class="text-lg sm:text-xl font-extrabold gradient-text leading-snug break-words">
              ${item.store_name || "-"}
            </h3>
            <p class="text-xs sm:text-sm text-slate-500 flex items-center gap-1">
              <span class="inline-flex h-6 w-6 items-center justify-center rounded-full bg-slate-900 text-[0.7rem] text-white shadow-sm">
                ${item.category ? (item.category[0] || "ì—…") : "ì—…"}
              </span>
              <span class="font-medium">${item.category || "ì—…ì¢… ë¯¸ë“±ë¡"}</span>
            </p>
            ${shortAddr
          ? `<p class="text-xs sm:text-sm text-slate-500 flex items-center gap-1.5">
                     <span class="text-base">ğŸ“</span>
                     <span class="truncate" title="${item.address || ""}">${shortAddr}</span>
                   </p>`
          : ""
        }
          </div>

          <div class="mt-3 flex items-center justify-between text-xs sm:text-[0.8rem] text-slate-500">
            <div class="flex items-center gap-1.5">
              <span class="text-base">ğŸ“</span>
              <span class="font-medium">${item.phone || "-"}</span>
            </div>
            <span class="inline-flex items-center gap-1 text-indigo-600 font-semibold">
              ìƒì„¸ë³´ê¸°
              <span class="text-xs">â†—</span>
            </span>
          </div>
        </div>
      `;

      cardDiv.addEventListener("click", () => {
        const itemId = item.id;
        console.log("ğŸ” ì˜¤í”ˆ ì¹´ë“œ í´ë¦­:", { item, itemId, globalIndex });
        if (!itemId) {
          console.error("âŒ IDê°€ ì—†ìŠµë‹ˆë‹¤:", item);
          alert("í•´ë‹¹ ë§¤ì¥ì˜ ìƒì„¸ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }
        window.location.href = `/opendetail.html?id=${itemId}`;
      });

      return cardDiv;
    }

    // ---------- í˜ì´ì§€ ë Œë”ë§ ----------
    function renderPage(page) {
      if (!cardContainer) return;
      cardContainer.innerHTML = "";

      const startIndex = (page - 1) * ITEMS_PER_PAGE;
      const pageData = data.slice(startIndex, startIndex + ITEMS_PER_PAGE);

      if (!pageData.length) {
        if (emptyStateEl) emptyStateEl.classList.remove("hidden");
        return;
      } else {
        if (emptyStateEl) emptyStateEl.classList.add("hidden");
      }

      pageData.forEach((item, i) => {
        const card = createCard(item, startIndex + i);
        cardContainer.appendChild(card);
      });
    }

    function renderPagination() {
      if (!paginationContainer) return;
      paginationContainer.innerHTML = "";

      if (totalPages <= 1) {
        if (paginationWrapper) paginationWrapper.classList.add("hidden");
        return;
      } else if (paginationWrapper) {
        paginationWrapper.classList.remove("hidden");
      }

      for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement("button");
        btn.textContent = i;
        btn.className = `
          px-3 py-1.5 rounded-full text-xs sm:text-sm font-semibold
          border border-slate-200/80 bg-white/90 text-slate-600
          hover:bg-slate-900 hover:text-white hover:border-slate-900
          transition-colors duration-150
        `;
        if (i === currentPage) {
          btn.classList.add(
            "bg-slate-900",
            "text-white",
            "border-slate-900",
            "shadow",
            "shadow-slate-400/40"
          );
        }

        btn.addEventListener("click", () => {
          currentPage = i;
          renderPage(currentPage);
          renderPagination();
          // í˜ì´ì§€ ì´ë™ ì‹œ ìƒë‹¨ìœ¼ë¡œ ì‚´ì§ ìŠ¤í¬ë¡¤
          window.scrollTo({ top: 0, behavior: "smooth" });
        });

        paginationContainer.appendChild(btn);
      }
    }

    function init() {
      totalItems = data.length;
      totalPages = Math.max(1, Math.ceil(Math.max(0, totalItems) / ITEMS_PER_PAGE));
      updateStats();
      renderPage(currentPage);
      renderPagination();
    }

    // ---------- DOM ë¡œë“œ ----------
    document.addEventListener("DOMContentLoaded", async () => {
      await loadComponent("components/header.html", "header-container");
      await loadComponent("components/footer.html", "footer-container");

      data = await fetchOpenStores();
      totalItems = data.length;
      totalPages = Math.max(1, Math.ceil(Math.max(0, totalItems) / ITEMS_PER_PAGE));

      init();

      const toggleBtn = document.getElementById("toggleFormBtn");
      if (toggleBtn) {
        toggleBtn.onclick = function () {
          location.href = "/openregister.html";
        };
      }
    });
  </script>
</body>

</html>