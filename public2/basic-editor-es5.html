<!-- public2/basic-editor-es5.html -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>Basic Editor (ES5 safe)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bar:#f7f7fa; --line:#e5e7eb; }
    * { box-sizing: border-box; }
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans KR',sans-serif; margin:0; }
    .toolbar { position:sticky; top:0; z-index:10; display:flex; flex-wrap:wrap; gap:6px; align-items:center; padding:8px; background:var(--bar); border-bottom:1px solid var(--line); }
    .toolbar button,.toolbar select,.toolbar input[type="color"]{ padding:6px 10px; border:1px solid var(--line); border-radius:6px; background:#fff; cursor:pointer; }
    .toolbar button:hover{ background:#f3f4f6; }
    .editor{ padding:16px; min-height:50vh; outline:none; line-height:1.6; word-break:break-word; }
    .editor:empty:before{ content:attr(data-placeholder); color:#9ca3af; }
    .editor img{ max-width:100%; height:auto; border:1px solid #e5e7eb; border-radius:6px; }
    pre{ white-space:pre-wrap; background:#fafafa; border:1px solid var(--line); border-radius:6px; padding:12px; margin-top:8px; }
  </style>
</head>
<body>
  <div class="toolbar" id="tb">
    <button data-cmd="bold"><b>굵게</b></button>
    <button data-cmd="italic"><i>기울임</i></button>
    <button data-cmd="underline"><u>밑줄</u></button>

    <button data-cmd="justifyLeft">좌</button>
    <button data-cmd="justifyCenter">중</button>
    <button data-cmd="justifyRight">우</button>

    <button data-cmd="insertUnorderedList">● 목록</button>
    <button data-cmd="insertOrderedList">1. 목록</button>

    <select id="fs">
      <option value="">글자 크기</option>
      <option value="14px">14</option>
      <option value="16px">16</option>
      <option value="18px">18</option>
      <option value="20px">20</option>
      <option value="24px">24</option>
      <option value="28px">28</option>
    </select>

    <input type="color" id="fc" title="글자색" />
    <input type="file" id="img" accept="image/*" style="display:none" />
    <button id="btnImg">이미지</button>
  </div>

  <div id="ed" class="editor" contenteditable="true" data-placeholder="여기에 글을 입력하세요…"></div>

  <div style="padding:16px; border-top:1px solid var(--line);">
    <button id="dumpBtn" style="padding:8px 12px; border:1px solid var(--line); border-radius:6px;">현재 HTML 보기</button>
    <pre id="dumpBox"></pre>
  </div>

  <script>
  (function(){
    'use strict';

    var ed = document.getElementById('ed');
    var tb = document.getElementById('tb');
    var fs = document.getElementById('fs');
    var fc = document.getElementById('fc');
    var img = document.getElementById('img');
    var btnImg = document.getElementById('btnImg');
    var dumpBtn = document.getElementById('dumpBtn');
    var dumpBox = document.getElementById('dumpBox');

    var composing = false;
    var typingSpan = null;
    var ZWSP = '\u200B';

    function getSel(){ return window.getSelection ? window.getSelection() : null; }
    function newRange(){ return document.createRange ? document.createRange() : null; }

    function placeCaretInside(node, atEnd){
      if (atEnd === void 0) atEnd = true;
      if (!node) return;
      var r = newRange(); if (!r) return;
      var s = getSel(); if (!s) return;

      var target = (node.nodeType === 3) ? node : (node.lastChild || node.firstChild || node);
      if (!target) return;
      var len = 0;
      if (target.nodeType === 3 && target.nodeValue) len = target.nodeValue.length;

      try{
        r.setStart(target, atEnd ? len : 0);
        r.collapse(true);
        s.removeAllRanges();
        s.addRange(r);
      }catch(e){}
    }

    function caretToTailOfEditor(){
      var s = getSel(); if (!s) return;
      var r = newRange(); if (!r) return;
      var node = ed;
      while (node && node.lastChild) node = node.lastChild;

      if (!node || node === ed) {
        var br = document.createElement('br');
        ed.appendChild(br);
        node = br;
      }

      if (node.nodeType === 3) {
        var len = (node.nodeValue && node.nodeValue.length) ? node.nodeValue.length : 0;
        r.setStart(node, len);
      } else {
        r.setStartAfter(node);
      }
      r.collapse(true);
      s.removeAllRanges();
      s.addRange(r);
    }

    function applyInlineStyle(styleObj){
      if (!styleObj) styleObj = {};
      ed.focus();
      var s = getSel(); if (!s || s.rangeCount === 0) return;

      if (!s.isCollapsed) {
        var r = s.getRangeAt(0);
        var span = document.createElement('span');
        var k;
        for (k in styleObj) if (styleObj.hasOwnProperty(k)) span.style[k] = styleObj[k];
        try { r.surroundContents(span); }
        catch (e) {
          var frag = r.extractContents();
          span.appendChild(frag);
          r.insertNode(span);
        }
        var after = newRange(); if (!after) return;
        after.setStartAfter(span);
        after.collapse(true);
        s.removeAllRanges();
        s.addRange(after);
        typingSpan = span;
        return;
      }

      if (typingSpan && ed.contains(typingSpan)) {
        var k2;
        for (k2 in styleObj) if (styleObj.hasOwnProperty(k2)) typingSpan.style[k2] = styleObj[k2];
        var endNode = typingSpan.lastChild || typingSpan;
        placeCaretInside(endNode, true);
        return;
      }

      caretToTailOfEditor();
      s = getSel(); if (!s || s.rangeCount === 0) return;
      var r2 = s.getRangeAt(0);

      var marker = document.createElement('span');
      marker.style.display = 'inline-block';
      marker.style.width = '0';
      marker.style.height = '0';
      marker.appendChild(document.createTextNode('\uFEFF'));
      r2.insertNode(marker);

      var span2 = document.createElement('span');
      span2.setAttribute('data-typing-span', 'true');
      var k3;
      for (k3 in styleObj) if (styleObj.hasOwnProperty(k3)) span2.style[k3] = styleObj[k3];
      var tn = document.createTextNode(ZWSP);
      span2.appendChild(tn);

      if (marker.parentNode) marker.parentNode.insertBefore(span2, marker.nextSibling);
      if (marker.parentNode) marker.parentNode.removeChild(marker);

      placeCaretInside(tn, true);
      typingSpan = span2;
    }

    tb.addEventListener('mousedown', function(e){
      var t = e.target || e.srcElement;
      if (t && t.tagName === 'BUTTON') { e.preventDefault(); ed.focus(); }
    });

    ed.addEventListener('compositionstart', function(){ composing = true; });
    ed.addEventListener('compositionend', function(){
      composing = false;
      if (typingSpan && ed.contains(typingSpan)) {
        var t = typingSpan.lastChild || typingSpan.firstChild;
        if (t && t.nodeType === 3) {
          var v = t.nodeValue || '';
          if (v.indexOf(ZWSP) === 0) t.nodeValue = v.replace(/\u200B/g, '');
          placeCaretInside(t, true);
        } else {
          var tn2 = document.createTextNode('');
          typingSpan.appendChild(tn2);
          placeCaretInside(tn2, true);
        }
      }
    });

    ed.addEventListener('input', function(){
      if (!typingSpan) return;
      var t = typingSpan.firstChild;
      if (t && t.nodeType === 3 && t.nodeValue && t.nodeValue.indexOf(ZWSP) === 0) {
        t.nodeValue = t.nodeValue.replace(ZWSP, '');
      }
    });

    tb.addEventListener('click', function(e){
      var t = e.target || e.srcElement; if (!t) return;
      var cmd = t.getAttribute('data-cmd'); if (!cmd) return;
      if (composing) return;
      try { document.execCommand('styleWithCSS', false, true); } catch(e){}
      document.execCommand(cmd, false, null);
      ed.focus();
    });

    fs.addEventListener('change', function(){
      if (composing) return;
      var val = fs.value;
      if (!val) return;
      applyInlineStyle({ fontSize: val });
      ed.focus();
    });

    fc.addEventListener('input', function(){
      if (composing) return;
      var val = fc.value;
      if (!val) return;
      applyInlineStyle({ color: val });
      ed.focus();
    });

    btnImg.addEventListener('click', function(){ img.click(); });
    img.addEventListener('change', function(e){
      if (composing) return;
      var file = (e.target && e.target.files && e.target.files[0]) ? e.target.files[0] : null;
      if (!file) return;
      var url = (window.URL && window.URL.createObjectURL) ? window.URL.createObjectURL(file) : null;
      if (!url) return;
      insertImage(url);
      img.value = '';
    });

    dumpBtn.addEventListener('click', function(){
      dumpBox.textContent = ed.innerHTML.replace(/\s+$/,'');
    });

    function insertImage(src){
      ed.focus();
      var s = getSel(); if (!s || s.rangeCount === 0) caretToTailOfEditor();
      s = getSel(); if (!s || s.rangeCount === 0) return;
      var r = s.getRangeAt(0);

      var image = document.createElement('img');
      image.src = src;
      image.alt = 'image';
      image.style.margin = '8px 0';

      r.insertNode(image);
      r.setStartAfter(image);
      r.collapse(true);
      s.removeAllRanges();
      s.addRange(r);
    }
  })();
  </script>
</body>
</html>
