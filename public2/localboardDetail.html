<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ì§€ì—­ ê²Œì‹œê¸€ ìƒì„¸</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100">

<div id="header"></div>

<div class="max-w-3xl mx-auto bg-white mt-10 p-6 rounded-2xl shadow-lg">

  <div class="flex justify-end mb-4">
    <button onclick="location.href='/localboard.html'" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
      â† ëª©ë¡ìœ¼ë¡œ
    </button>
  </div>

  <h1 id="title" class="text-3xl font-bold mb-2"></h1>
  <div id="info" class="text-gray-500 mb-4"></div>

  <div id="images" class="grid grid-cols-3 gap-3 my-4"></div>

  <div id="content" class="whitespace-pre-line mb-10 text-lg"></div>

  <div class="flex justify-end gap-2 mb-6">
    <button onclick="likePost()" class="px-3 py-1.5 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 text-sm flex items-center gap-1.5">
      ğŸ‘ ì¶”ì²œ <span id="likeCount" class="font-bold">0</span>
    </button>
    <button onclick="report()" class="px-3 py-1.5 bg-white border border-red-300 text-red-600 rounded-lg hover:bg-red-50 text-sm">
      ğŸš¨ ì‹ ê³ 
    </button>
  </div>

  <h2 class="text-xl font-bold mt-10 mb-3">ğŸ’¬ ëŒ“ê¸€</h2>

  <div id="comments" class="mb-6 space-y-3"></div>

  <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
    <div class="mb-2">
      <span class="text-sm font-medium text-gray-700">ì‘ì„±ì: </span>
      <span id="commentNickname" class="text-sm font-bold text-indigo-600">-</span>
      <button onclick="location.href='/nicknameSettings.html'" class="ml-2 text-xs text-blue-500 underline">ë³€ê²½</button>
    </div>
    <textarea 
      id="commentText" 
      class="w-full border border-gray-300 p-3 rounded-lg resize-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent" 
      placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..."
      rows="3"
    ></textarea>
    <div class="flex justify-end mt-2">
      <button onclick="submitComment()" class="px-5 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-medium">
        ëŒ“ê¸€ ë“±ë¡
      </button>
    </div>
  </div>

</div>

<div id="footer"></div>

<!-- ì´ì „/í™ˆ/ë‹¤ìŒ ë²„íŠ¼ -->
<div class="fixed bottom-6 right-6 flex flex-col gap-3 z-50">
  <button onclick="goBack()" class="w-12 h-12 bg-white border-2 border-indigo-600 text-indigo-600 rounded-full hover:bg-indigo-600 hover:text-white shadow-lg flex items-center justify-center font-bold">
    â†
  </button>
  <button onclick="goHome()" class="w-12 h-12 bg-white border-2 border-indigo-600 text-indigo-600 rounded-full hover:bg-indigo-600 hover:text-white shadow-lg flex items-center justify-center text-xl">
    ğŸ 
  </button>
  <button onclick="goForward()" class="w-12 h-12 bg-white border-2 border-indigo-600 text-indigo-600 rounded-full hover:bg-indigo-600 hover:text-white shadow-lg flex items-center justify-center font-bold">
    â†’
  </button>
</div>

<script>
fetch('components/header.html').then(r => r.text()).then(h => header.innerHTML = h);
fetch('components/footer.html').then(r => r.text()).then(f => footer.innerHTML = f);

// ë„¤ë¹„ê²Œì´ì…˜ í•¨ìˆ˜
function goBack() {
  window.history.back();
}

function goHome() {
  window.location.href = '/index.html';
}

function goForward() {
  window.history.forward();
}

const id = new URLSearchParams(location.search).get("id");

// ì¶”ì²œ/ì‹ ê³  ì—¬ë¶€ ì²´í¬
function hasLiked() {
  const liked = localStorage.getItem(`post_${id}_liked`);
  return liked === 'true';
}

function hasReported() {
  const reported = localStorage.getItem(`post_${id}_reported`);
  return reported === 'true';
}

function setLiked() {
  localStorage.setItem(`post_${id}_liked`, 'true');
}

function setReported() {
  localStorage.setItem(`post_${id}_reported`, 'true');
}

async function loadDetail() {
  const res = await fetch(`/api/localboard/${id}`);
  const post = await res.json();

  title.textContent = post.title;
  info.textContent = `${post.region} Â· ì¡°íšŒ ${post.views}`;

  // ì¶”ì²œ ìˆ˜ í‘œì‹œ
  document.getElementById('likeCount').textContent = post.likes || 0;

  // ì´ë¯¸ ì¶”ì²œí–ˆìœ¼ë©´ ë²„íŠ¼ ë¹„í™œì„±í™”
  if (hasLiked()) {
    const likeBtn = document.querySelector('button[onclick="likePost()"]');
    likeBtn.disabled = true;
    likeBtn.classList.add('opacity-50', 'cursor-not-allowed');
    likeBtn.innerHTML = 'ğŸ‘ ì¶”ì²œì™„ë£Œ <span id="likeCount" class="font-bold">' + (post.likes || 0) + '</span>';
  }

  // ì´ë¯¸ ì‹ ê³ í–ˆìœ¼ë©´ ë²„íŠ¼ ë¹„í™œì„±í™”
  if (hasReported()) {
    const reportBtn = document.querySelector('button[onclick="report()"]');
    reportBtn.disabled = true;
    reportBtn.classList.add('opacity-50', 'cursor-not-allowed');
    reportBtn.textContent = 'ğŸš¨ ì‹ ê³ ì™„ë£Œ';
  }

  images.innerHTML = post.images
    .map(img => `<img src="${img.image_url}" class="rounded-lg shadow">`)
    .join("");

  content.textContent = post.content;
}
loadDetail();

// ëŒ“ê¸€ ì‘ì„±ì ë‹‰ë„¤ì„ í‘œì‹œ
function loadCommentNickname() {
  const nickname = localStorage.getItem('userNickname');
  if (nickname) {
    document.getElementById('commentNickname').textContent = nickname;
  } else {
    document.getElementById('commentNickname').textContent = 'ë¯¸ì„¤ì •';
  }
}
loadCommentNickname();

async function loadComments() {
  const res = await fetch(`/api/localboard/${id}/comments`);
  const data = await res.json();

  comments.innerHTML = data
    .map(c => `
      <div class="bg-white p-3 rounded-lg border border-gray-200">
        <div class="flex items-center gap-2 mb-1">
          <span class="font-bold text-sm text-gray-800">${c.writer}</span>
          <span class="text-xs text-gray-400">${new Date(c.created_at).toLocaleString('ko-KR')}</span>
        </div>
        <p class="text-gray-700">${c.comment}</p>
      </div>
    `)
    .join("");
}
loadComments();

async function submitComment() {
  const nickname = localStorage.getItem('userNickname');
  const commentText = document.getElementById('commentText').value.trim();

  if (!nickname) {
    alert('ë‹‰ë„¤ì„ì„ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”.');
    location.href = '/nicknameSettings.html';
    return;
  }

  if (!commentText) {
    alert('ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    return;
  }

  await fetch(`/api/localboard/${id}/comment`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      writer: nickname,
      comment: commentText
    })
  });

  document.getElementById('commentText').value = "";
  loadComments();
}

async function report() {
  const nickname = localStorage.getItem('userNickname');
  
  if (!nickname) {
    alert('ë‹‰ë„¤ì„ì„ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”.');
    return;
  }

  if (hasReported()) {
    alert('ì´ë¯¸ ì‹ ê³ í•œ ê²Œì‹œê¸€ì…ë‹ˆë‹¤.');
    return;
  }

  if (!confirm('ì´ ê²Œì‹œê¸€ì„ ì‹ ê³ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
    return;
  }
  
  const res = await fetch(`/api/localboard/${id}/report`, { 
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ nickname })
  });
  
  const data = await res.json();
  
  if (data.alreadyReported) {
    alert('ì´ë¯¸ ì‹ ê³ í•œ ê²Œì‹œê¸€ì…ë‹ˆë‹¤.');
    return;
  }
  
  if (data.success) {
    setReported();
    alert("ì‹ ê³ ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ìê°€ í™•ì¸ í›„ ì¡°ì¹˜í•˜ê² ìŠµë‹ˆë‹¤.");
    
    // ë²„íŠ¼ ë¹„í™œì„±í™”
    const reportBtn = document.querySelector('button[onclick="report()"]');
    reportBtn.disabled = true;
    reportBtn.classList.add('opacity-50', 'cursor-not-allowed');
    reportBtn.textContent = 'ğŸš¨ ì‹ ê³ ì™„ë£Œ';
  } else {
    alert(data.error || 'ì‹ ê³  ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  }
}

async function likePost() {
  const nickname = localStorage.getItem('userNickname');
  
  if (!nickname) {
    alert('ë‹‰ë„¤ì„ì„ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”.');
    return;
  }

  if (hasLiked()) {
    alert('ì´ë¯¸ ì¶”ì²œí•œ ê²Œì‹œê¸€ì…ë‹ˆë‹¤.');
    return;
  }

  const res = await fetch(`/api/localboard/${id}/like`, { 
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ nickname })
  });
  const data = await res.json();
  
  if (data.alreadyLiked) {
    alert('ì´ë¯¸ ì¶”ì²œí•œ ê²Œì‹œê¸€ì…ë‹ˆë‹¤.');
    return;
  }
  
  if (data.success) {
    setLiked();
    document.getElementById('likeCount').textContent = data.likes;
    
    // ë²„íŠ¼ ë¹„í™œì„±í™”
    const likeBtn = document.querySelector('button[onclick="likePost()"]');
    likeBtn.disabled = true;
    likeBtn.classList.add('opacity-50', 'cursor-not-allowed');
    likeBtn.innerHTML = 'ğŸ‘ ì¶”ì²œì™„ë£Œ <span id="likeCount" class="font-bold">' + data.likes + '</span>';
  } else {
    alert(data.error || 'ì¶”ì²œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  }
}

</script>

</body>
</html>
