<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ì§€ì—­ ê²Œì‹œê¸€ ìƒì„¸</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100">

<div id="header"></div>

<div class="max-w-3xl mx-auto bg-white mt-10 p-6 rounded-2xl shadow-lg">

  <h1 id="title" class="text-3xl font-bold mb-2"></h1>
  <div id="info" class="text-gray-500 mb-4"></div>

  <div id="images" class="grid grid-cols-3 gap-3 my-4"></div>

  <div id="content" class="whitespace-pre-line mb-10 text-lg"></div>

  <div class="flex justify-end gap-2 mb-6">
    <button onclick="likePost()" class="px-3 py-1.5 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 text-sm flex items-center gap-1.5">
      ğŸ‘ ì¶”ì²œ <span id="likeCount" class="font-bold">0</span>
    </button>
    <button onclick="report()" class="px-3 py-1.5 bg-white border border-red-300 text-red-600 rounded-lg hover:bg-red-50 text-sm">
      ğŸš¨ ì‹ ê³ 
    </button>
  </div>

  <h2 class="text-xl font-bold mt-10 mb-3">ğŸ’¬ ëŒ“ê¸€</h2>

  <div id="comments" class="mb-5"></div>

  <div class="flex gap-2">
    <input id="commentWriter" class="border p-2 flex-1" placeholder="ì‘ì„±ì">
    <input id="commentText" class="border p-2 flex-1" placeholder="ëŒ“ê¸€ ë‚´ìš©">
    <button onclick="submitComment()" class="px-4 bg-indigo-600 text-white rounded-lg">ë“±ë¡</button>
  </div>

</div>

<div id="footer"></div>

<script>
fetch('components/header.html').then(r => r.text()).then(h => header.innerHTML = h);
fetch('components/footer.html').then(r => r.text()).then(f => footer.innerHTML = f);

const id = new URLSearchParams(location.search).get("id");

// ì¶”ì²œ/ì‹ ê³  ì—¬ë¶€ ì²´í¬
function hasLiked() {
  const liked = localStorage.getItem(`post_${id}_liked`);
  return liked === 'true';
}

function hasReported() {
  const reported = localStorage.getItem(`post_${id}_reported`);
  return reported === 'true';
}

function setLiked() {
  localStorage.setItem(`post_${id}_liked`, 'true');
}

function setReported() {
  localStorage.setItem(`post_${id}_reported`, 'true');
}

async function loadDetail() {
  const res = await fetch(`/api/localboard/${id}`);
  const post = await res.json();

  title.textContent = post.title;
  info.textContent = `${post.region} Â· ì¡°íšŒ ${post.views}`;

  // ì¶”ì²œ ìˆ˜ í‘œì‹œ
  document.getElementById('likeCount').textContent = post.likes || 0;

  // ì´ë¯¸ ì¶”ì²œí–ˆìœ¼ë©´ ë²„íŠ¼ ë¹„í™œì„±í™”
  if (hasLiked()) {
    const likeBtn = document.querySelector('button[onclick="likePost()"]');
    likeBtn.disabled = true;
    likeBtn.classList.add('opacity-50', 'cursor-not-allowed');
    likeBtn.innerHTML = 'ğŸ‘ ì¶”ì²œì™„ë£Œ <span id="likeCount" class="font-bold">' + (post.likes || 0) + '</span>';
  }

  // ì´ë¯¸ ì‹ ê³ í–ˆìœ¼ë©´ ë²„íŠ¼ ë¹„í™œì„±í™”
  if (hasReported()) {
    const reportBtn = document.querySelector('button[onclick="report()"]');
    reportBtn.disabled = true;
    reportBtn.classList.add('opacity-50', 'cursor-not-allowed');
    reportBtn.textContent = 'ğŸš¨ ì‹ ê³ ì™„ë£Œ';
  }

  images.innerHTML = post.images
    .map(img => `<img src="${img.image_url}" class="rounded-lg shadow">`)
    .join("");

  content.textContent = post.content;
}
loadDetail();

async function loadComments() {
  const res = await fetch(`/api/localboard/${id}/comments`);
  const data = await res.json();

  comments.innerHTML = data
    .map(c => `<div class="border-b py-2"><b>${c.writer}</b> ${c.comment}</div>`)
    .join("");
}
loadComments();

async function submitComment() {
  await fetch(`/api/localboard/${id}/comment`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      writer: commentWriter.value,
      comment: commentText.value
    })
  });

  commentWriter.value = "";
  commentText.value = "";
  loadComments();
}

async function report() {
  const nickname = localStorage.getItem('userNickname');
  
  if (!nickname) {
    alert('ë‹‰ë„¤ì„ì„ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”.');
    return;
  }

  if (hasReported()) {
    alert('ì´ë¯¸ ì‹ ê³ í•œ ê²Œì‹œê¸€ì…ë‹ˆë‹¤.');
    return;
  }

  if (!confirm('ì´ ê²Œì‹œê¸€ì„ ì‹ ê³ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
    return;
  }
  
  const res = await fetch(`/api/localboard/${id}/report`, { 
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ nickname })
  });
  
  const data = await res.json();
  
  if (data.alreadyReported) {
    alert('ì´ë¯¸ ì‹ ê³ í•œ ê²Œì‹œê¸€ì…ë‹ˆë‹¤.');
    return;
  }
  
  if (data.success) {
    setReported();
    alert("ì‹ ê³ ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ìê°€ í™•ì¸ í›„ ì¡°ì¹˜í•˜ê² ìŠµë‹ˆë‹¤.");
    
    // ë²„íŠ¼ ë¹„í™œì„±í™”
    const reportBtn = document.querySelector('button[onclick="report()"]');
    reportBtn.disabled = true;
    reportBtn.classList.add('opacity-50', 'cursor-not-allowed');
    reportBtn.textContent = 'ğŸš¨ ì‹ ê³ ì™„ë£Œ';
  } else {
    alert(data.error || 'ì‹ ê³  ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  }
}

async function likePost() {
  const nickname = localStorage.getItem('userNickname');
  
  if (!nickname) {
    alert('ë‹‰ë„¤ì„ì„ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”.');
    return;
  }

  if (hasLiked()) {
    alert('ì´ë¯¸ ì¶”ì²œí•œ ê²Œì‹œê¸€ì…ë‹ˆë‹¤.');
    return;
  }

  const res = await fetch(`/api/localboard/${id}/like`, { 
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ nickname })
  });
  const data = await res.json();
  
  if (data.alreadyLiked) {
    alert('ì´ë¯¸ ì¶”ì²œí•œ ê²Œì‹œê¸€ì…ë‹ˆë‹¤.');
    return;
  }
  
  if (data.success) {
    setLiked();
    document.getElementById('likeCount').textContent = data.likes;
    
    // ë²„íŠ¼ ë¹„í™œì„±í™”
    const likeBtn = document.querySelector('button[onclick="likePost()"]');
    likeBtn.disabled = true;
    likeBtn.classList.add('opacity-50', 'cursor-not-allowed');
    likeBtn.innerHTML = 'ğŸ‘ ì¶”ì²œì™„ë£Œ <span id="likeCount" class="font-bold">' + data.likes + '</span>';
  } else {
    alert(data.error || 'ì¶”ì²œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  }
}

</script>

</body>
</html>
