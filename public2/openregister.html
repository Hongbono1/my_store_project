<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>오픈예정 등록 | MALL HANKOOK</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <script
        src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=6286d4d9bc1d503495b03f46622b5dc8&autoload=false&libraries=services"></script>

    <style>
        body {
            font-family: Pretendard, system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans KR', sans-serif;
            background: linear-gradient(135deg, #f8fafc, #e0e7ff);
            color: #111827;
            min-height: 100vh
        }

        .neo-card {
            background: rgba(255, 255, 255, .65);
            backdrop-filter: blur(14px);
            border: 1px solid rgba(255, 255, 255, .45);
            border-radius: 1.25rem;
            box-shadow: 8px 8px 24px rgba(0, 0, 0, .07)
        }

        .toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: .5rem;
            padding: .75rem;
            border: 1px solid #e5e7eb;
            border-radius: .75rem;
            background: rgba(255, 255, 255, .6)
        }

        .tbtn {
            padding: .5rem .75rem;
            border-radius: .6rem;
            border: 1px solid #e5e7eb;
            background: #fff;
            box-shadow: 0 1px 2px rgba(0, 0, 0, .04);
            font-weight: 600
        }

        .tbtn:hover {
            background: #f3f4f6
        }

        .editor {
            min-height: 320px;
            padding: 1rem;
            border: 1px solid #e5e7eb;
            border-radius: .75rem;
            background: #fff
        }

        .editor:focus {
            outline: 3px solid rgba(59, 130, 246, .25)
        }

        .img-thumb {
            max-width: 100%;
            height: auto;
            border-radius: .75rem;
            box-shadow: 0 6px 18px rgba(0, 0, 0, .08)
        }

        .gradient-text {
            background: linear-gradient(90deg, #60a5fa, #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent
        }
    </style>
</head>

<body class="flex flex-col items-center py-10">

    <main class="w-full max-w-3xl p-8 neo-card mt-10">
        <h1 class="text-3xl font-extrabold text-center mb-8 gradient-text">오픈 매장 등록</h1>

        <form id="openForm" class="space-y-6" enctype="multipart/form-data">
            <!-- 기본정보 -->
            <div>
                <label class="block font-semibold mb-1">상호명</label>
                <input name="store_name" type="text" required
                    class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-400" />
            </div>

            <div>
                <label class="block font-semibold mb-1">오픈일</label>
                <input name="open_date" type="date" required
                    class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-400" />
            </div>

            <div>
                <label class="block font-semibold mb-1">업종(카테고리)</label>
                <input name="category" type="text" placeholder="예: 한식, 카페, 병원 등"
                    class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-400" />
            </div>

            <div>
                <label class="block font-semibold mb-1">전화번호</label>
                <input name="phone" type="text" required placeholder="010-0000-0000"
                    class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-400" />
            </div>

            <!-- 주소 -->
            <div>
                <label class="block font-semibold mb-1">주소</label>
                <div class="flex gap-2">
                    <input id="address" name="address" type="text" readonly
                        class="flex-1 border rounded px-3 py-2 focus:ring-2 focus:ring-blue-400" />
                    <button type="button" onclick="searchAddress()"
                        class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">검색</button>
                </div>
            </div>

            <!-- 상세 주소 -->
            <div>
                <label class="block font-semibold mb-1">상세 주소</label>
                <input id="detailAddress" name="detail_address" type="text" placeholder="예: 2층, 203호"
                    class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-400" />
            </div>

            <!-- 지도 -->
            <div class="flex justify-center">
                <div id="map" class="rounded border border-gray-300 my-4 shadow-sm"
                    style="width:100%; min-width:180px; height:260px; max-width:480px;"></div>
            </div>

            <!-- 대표 이미지 -->
            <div>
                <label class="block font-semibold mb-1">대표 이미지</label>
                <input name="img" type="file" accept="image/*" class="w-full border rounded px-3 py-2 text-gray-700" />
                <p class="text-xs text-gray-500 mt-1">한 장만 업로드합니다.</p>
            </div>

            <!-- 자체 에디터 -->
            <div>
                <label class="block font-semibold mb-2">설명 (사진 포함, 자유 배치 가능)</label>

                <!-- 툴바 -->
                <div class="toolbar mb-3">
                    <button class="tbtn" type="button" onclick="fmt('bold')">굵게</button>
                    <button class="tbtn" type="button" onclick="fmt('underline')">밑줄</button>
                    <input id="fontPx" type="number" min="10" max="60" step="1" placeholder="글자 px"
                        class="w-24 border px-2 py-1 rounded" />
                    <button class="tbtn" type="button" onclick="applyFontSize()">적용</button>
                    <button class="tbtn" type="button" onclick="insertHR()">구분선</button>
                    <button class="tbtn" type="button" onclick="fmt('insertUnorderedList')">글머리기호</button>

                    <!-- 이미지 관련 -->
                    <button class="tbtn" type="button" onclick="triggerImagePick('normal')">일반 삽입</button>
                    <button class="tbtn" type="button" onclick="triggerImagePick('left')">좌측 이미지</button>
                    <button class="tbtn" type="button" onclick="triggerImagePick('double')">2장 나란히</button>

                    <input id="hiddenImage" type="file" accept="image/*" class="hidden" />
                </div>

                <div id="editor" class="editor" contenteditable="true" aria-label="설명 입력"></div>
                <textarea id="descHtml" name="description" class="hidden"></textarea>
            </div>

            <button type="submit" class="mt-2 py-2 px-6 bg-blue-600 text-white rounded font-semibold hover:bg-blue-700">
                등록
            </button>
        </form>
    </main>

    <script>
        /* ==== 주소검색 + 지도 ==== */
        function searchAddress() {
            new daum.Postcode({
                oncomplete: function (data) {
                    const addr = data.address;
                    document.getElementById("address").value = addr;
                    updateMapByAddress(addr);
                    document.getElementById("detailAddress").focus();
                }
            }).open();
        }
        window.map = null; window.marker = null;
        kakao.maps.load(function () {
            const mapContainer = document.getElementById("map");
            const pos = new kakao.maps.LatLng(37.5665, 126.9780);
            window.map = new kakao.maps.Map(mapContainer, { center: pos, level: 3 });
            window.marker = new kakao.maps.Marker({ map: window.map, position: pos });
        });
        function updateMapByAddress(address) {
            const geocoder = new kakao.maps.services.Geocoder();
            geocoder.addressSearch(address, function (result, status) {
                if (status === kakao.maps.services.Status.OK) {
                    const lat = result[0].y, lng = result[0].x;
                    const loc = new kakao.maps.LatLng(lat, lng);
                    window.map.setCenter(loc);
                    window.marker.setPosition(loc);
                }
            });
        }

        /* ==== 에디터 기능 ==== */
        function fmt(cmd) { document.execCommand(cmd, false, null); }
        function insertHR() {
            const hr = document.createElement('hr');
            hr.style.border = 'none'; hr.style.borderTop = '1px solid #e5e7eb'; hr.style.margin = '16px 0';
            insertNodeAtCaret(hr);
        }
        function insertNodeAtCaret(node) {
            const sel = window.getSelection();
            if (!sel || !sel.rangeCount) { document.getElementById('editor').appendChild(node); return; }
            const range = sel.getRangeAt(0); range.deleteContents(); range.insertNode(node);
            range.setStartAfter(node); range.setEndAfter(node); sel.removeAllRanges(); sel.addRange(range);
        }
        function applyFontSize() {
            const px = document.getElementById('fontPx').value;
            if (!px) return alert('크기를 입력하세요.');
            wrapSelectionWithStyle('font-size', px + 'px');
            document.getElementById('fontPx').value = '';
        }
        function wrapSelectionWithStyle(key, value) {
            const sel = window.getSelection();
            if (!sel || sel.isCollapsed) {
                const span = document.createElement('span'); span.style[key] = value; span.textContent = '텍스트';
                insertNodeAtCaret(span); return;
            }
            const range = sel.getRangeAt(0);
            const span = document.createElement('span'); span.style[key] = value;
            span.appendChild(range.extractContents()); range.insertNode(span);
            sel.removeAllRanges(); const r = document.createRange(); r.selectNodeContents(span); sel.addRange(r);
        }

        /* ==== 이미지 관련 ==== */
        let currentMode = 'normal';
        function triggerImagePick(mode) {
            currentMode = mode;
            document.getElementById('hiddenImage').click();
        }
        document.getElementById('hiddenImage').addEventListener('change', async (e) => {
            const file = e.target.files?.[0]; if (!file) return;
            try {
                const fd = new FormData(); fd.append('image', file);
                const res = await fetch('/upload/image', { method: 'POST', body: fd });
                const json = await res.json();
                if (!json?.url) return alert('이미지 업로드 실패');
                if (currentMode === 'normal') {
                    const img = document.createElement('img'); img.src = json.url; img.className = 'img-thumb'; insertNodeAtCaret(img);
                } else if (currentMode === 'left') {
                    const box = document.createElement('div');
                    box.className = 'flex gap-4 items-start my-4';
                    box.innerHTML = `<img src="${json.url}" class="w-1/2 rounded-lg shadow"><div class="w-1/2 text-gray-800">여기에 글을 작성하세요.</div>`;
                    insertNodeAtCaret(box);
                } else if (currentMode === 'double') {
                    const box = document.createElement('div');
                    box.className = 'grid grid-cols-2 gap-2 my-4';
                    box.innerHTML = `<img src="${json.url}" class="rounded-lg shadow"><img src="https://placehold.co/400x300?text=두번째+이미지" class="rounded-lg shadow">`;
                    insertNodeAtCaret(box);
                }
            } catch (err) { console.error(err); alert('이미지 업로드 오류'); }
            e.target.value = '';
        });

        /* ==== 제출 ==== */
        document.getElementById('openForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            document.getElementById('descHtml').value = document.getElementById('editor').innerHTML.trim();
            const fd = new FormData(e.target);
            try {
                const res = await fetch('/openregister', { method: 'POST', body: fd });
                const json = await res.json();
                if (json.success) {
                    alert('등록 완료!');
                    e.target.reset(); document.getElementById('editor').innerHTML = '';
                } else alert('등록 실패: ' + (json.message || '서버 오류'));
            } catch (err) { alert('서버 오류: ' + err.message); }
        });
    </script>
</body>

</html>