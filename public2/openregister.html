<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì˜¤í”ˆì˜ˆì • ë“±ë¡ | MALL HANKOOK</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <script
        src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=6286d4d9bc1d503495b03f46622b5dc8&autoload=false&libraries=services"></script>
    <style>
        body {
            font-family: Pretendard, system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans KR', sans-serif;
            background: linear-gradient(135deg, #f8fafc, #e0e7ff);
            color: #111827;
            min-height: 100vh
        }

        .neo-card {
            background: rgba(255, 255, 255, .65);
            backdrop-filter: blur(14px);
            border: 1px solid rgba(255, 255, 255, .45);
            border-radius: 1.25rem;
            box-shadow: 8px 8px 24px rgba(0, 0, 0, .07)
        }

        [contenteditable][data-placeholder]:empty:before {
            content: attr(data-placeholder);
            color: #9ca3af;
            pointer-events: none
        }

        .editor-toolbar {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9)
        }

        .toolbar-btn {
            padding: 6px 12px;
            border: 1px solid #d1d5db;
            background: #fff;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all .2s
        }

        .toolbar-btn:hover {
            background: #e0e7ff;
            border-color: #6366f1
        }

        .toolbar-select {
            padding: 4px 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            background: #fff;
            font-size: 12px;
            cursor: pointer
        }

        .korean-toolbar {
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            border: 1px solid #cbd5e1
        }

        .korean-btn {
            width: 32px;
            height: 32px;
            border: 1px solid #d1d5db;
            background: #fff;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: .2s
        }

        .korean-btn:hover {
            background: #e0e7ff;
            border-color: #6366f1;
            transform: translateY(-1px)
        }

        .korean-select {
            padding: 4px 8px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: #fff;
            font-size: 12px;
            cursor: pointer
        }

        .color-btn {
            width: 24px;
            height: 24px;
            border: 2px solid #d1d5db;
            border-radius: 4px;
            cursor: pointer;
            margin: 0 2px;
            transition: .2s
        }

        .color-btn:hover {
            border-color: #374151;
            transform: scale(1.1)
        }

        /* âœ… í¼ ë°– íˆ´ë°” ìŠ¤íƒ€ì¼ */
        .k-toolbar button {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s ease;
            color: #374151;
            font-weight: 500;
            backdrop-filter: blur(4px);
        }

        .k-toolbar button:hover {
            background: #e0e7ff;
            border-color: #6366f1;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(99, 102, 241, 0.2);
        }

        .k-toolbar select, 
        .k-toolbar input[type="color"] {
            padding: 6px 10px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.9);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            backdrop-filter: blur(4px);
        }

        .k-toolbar select:hover,
        .k-toolbar input[type="color"]:hover {
            border-color: #6366f1;
            box-shadow: 0 2px 4px rgba(99, 102, 241, 0.1);
        }

        /* ì—ë””í„° ë‚´ ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ */
        #customEditor img {
            max-width: 100%;
            height: auto;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin: 8px 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        #customEditor:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .char-btn {
            width: 28px;
            height: 28px;
            border: 1px solid #d1d5db;
            background: #fff;
            border-radius: 4px;
            cursor: pointer;
            margin: 0 1px;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: .2s
        }

        .char-btn:hover {
            background: #dcfce7;
            border-color: #16a34a;
            transform: translateY(-1px)
        }

        .img-full {
            width: 100%;
            max-width: 720px;
            height: auto;
            max-height: 480px;
            object-fit: contain;
            border-radius: .5rem
        }

        .img-side {
            width: 360px;
            max-width: 380px;
            height: auto;
            max-height: 320px;
            object-fit: cover;
            border-radius: .5rem
        }

        .img-thumb {
            width: 240px;
            height: auto;
            max-height: 240px;
            object-fit: cover;
            border-radius: .375rem
        }

        @media (max-width:768px) {
            .img-full {
                max-height: 360px
            }

            .img-side {
                width: min(70%, 320px);
                max-height: 300px
            }

            .img-thumb {
                width: 48%;
                max-height: 200px
            }
        }
    </style>
</head>

<body class="flex flex-col items-center py-10">
    <main class="w-full max-w-3xl p-8 neo-card mt-10">
        <h1
            class="text-3xl font-extrabold text-center mb-8 bg-gradient-to-r from-blue-500 to-indigo-500 text-transparent bg-clip-text">
            ì˜¤í”ˆ ë§¤ì¥ ë“±ë¡
        </h1>

        <!-- âœ… ì—ë””í„° íˆ´ë°” (í¼ ë°–ì— ë°°ì¹˜) -->
        <div class="k-toolbar mb-4" id="k-toolbar" style="display:flex;flex-wrap:wrap;gap:6px;align-items:center;padding:12px;background:#f7f7fa;border:1px solid #e5e7eb;border-radius:12px;">
            <button type="button" id="btn-bold" data-cmd="bold"><b>êµµê²Œ</b></button>
            <button type="button" id="btn-italic" data-cmd="italic"><i>ê¸°ìš¸ì„</i></button>
            <button type="button" id="btn-underline" data-cmd="underline"><u>ë°‘ì¤„</u></button>

            <button type="button" id="btn-justifyLeft" data-cmd="justifyLeft">ì¢Œ</button>
            <button type="button" id="btn-justifyCenter" data-cmd="justifyCenter">ì¤‘</button>
            <button type="button" id="btn-justifyRight" data-cmd="justifyRight">ìš°</button>

            <button type="button" id="btn-unorderedList" data-cmd="insertUnorderedList">â— ëª©ë¡</button>
            <button type="button" id="btn-orderedList" data-cmd="insertOrderedList">1. ëª©ë¡</button>

            <select id="font-size-selector">
              <option value="">ê¸€ì í¬ê¸°</option>
              <option value="14px">14</option>
              <option value="16px">16</option>
              <option value="18px">18</option>
              <option value="20px">20</option>
              <option value="24px">24</option>
              <option value="28px">28</option>
            </select>

            <input type="color" id="font-color-picker" title="ê¸€ììƒ‰" />
            <input type="file" id="image-input" accept="image/*" style="display:none" />
            <button type="button" id="btn-image">ì´ë¯¸ì§€</button>
        </div>

        <form id="openForm" class="space-y-6" enctype="multipart/form-data">
            <!-- ê¸°ë³¸ì •ë³´ -->
            <div>
                <label class="block font-semibold mb-1">ìƒí˜¸ëª…</label>
                <input name="store_name" type="text" required
                    class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-400" />
            </div>

            <div>
                <label class="block font-semibold mb-1">ì˜¤í”ˆì¼</label>
                <input name="open_date" type="date" required
                    class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-400" />
            </div>

            <div>
                <label class="block font-semibold mb-1">ì—…ì¢…(ì¹´í…Œê³ ë¦¬)</label>
                <input name="category" type="text" placeholder="ì˜ˆ: í•œì‹, ì¹´í˜, ë³‘ì› ë“±"
                    class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-400" />
            </div>

            <div>
                <label class="block font-semibold mb-1">ì „í™”ë²ˆí˜¸</label>
                <input name="phone" type="text" required placeholder="010-0000-0000"
                    class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-400" />
            </div>

            <!-- ì£¼ì†Œ -->
            <div>
                <label class="block font-semibold mb-1">ì£¼ì†Œ</label>
                <div class="flex gap-2">
                    <input id="address" name="address" type="text" readonly
                        class="flex-1 border rounded px-3 py-2 focus:ring-2 focus:ring-blue-400" />
                    <button type="button" id="btnSearchAddr"
                        class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">ê²€ìƒ‰</button>
                </div>
            </div>

            <!-- ìƒì„¸ ì£¼ì†Œ -->
            <div>
                <label class="block font-semibold mb-1 mt-2">ìƒì„¸ ì£¼ì†Œ</label>
                <input id="detailAddress" name="detail_address" type="text" placeholder="ì˜ˆ: 2ì¸µ, 203í˜¸"
                    class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-400" />
            </div>

            <!-- ì§€ë„ -->
            <div class="flex justify-center">
                <div id="map" class="rounded border border-gray-300 my-4 shadow-sm"
                    style="width:100%; height:260px; max-width:480px;"></div>
            </div>

            <!-- ëŒ€í‘œ ì´ë¯¸ì§€ -->
            <div>
                <label class="block font-semibold mb-1">ëŒ€í‘œ ì´ë¯¸ì§€</label>
                <input name="img" type="file" accept="image/*" class="w-full border rounded px-3 py-2 text-gray-700" />
            </div>

            <!-- â–¼ ì„¤ëª…(ì†Œê°œ) ì…ë ¥ ì˜ì—­: ì»¤ìŠ¤í…€ ì—ë””í„° -->
            <div class="mt-6">
              <label for="customEditor" class="block font-semibold mb-2">ì„¤ëª…(ì†Œê°œ)</label>
              
              <!-- ì—ë””í„° (íˆ´ë°”ëŠ” í¼ ë°–ì— ìˆìŒ) -->
              <div id="customEditor"
                   contenteditable="true"
                   data-placeholder="ê°€ê²Œ ì†Œê°œë¥¼ ì…ë ¥í•˜ì„¸ìš”â€¦"
                   style="padding:12px;min-height:220px;border:1px solid #e5e7eb;border-radius:8px;line-height:1.6;word-break:break-word;outline:none;background:#fff;">
              </div>

              <!-- ì œì¶œìš© íˆë“  í•„ë“œ (ì„œë²„ë¡œ ì „ì†¡ë¨) -->
              <input type="hidden" name="descHtml" id="descHtml" />
            </div>
            <!-- â–² ì„¤ëª…(ì†Œê°œ) ì…ë ¥ ì˜ì—­ ë -->

            <!-- ë“±ë¡ ë²„íŠ¼ -->
            <div class="flex justify-center">
                <button type="submit"
                    class="mt-4 py-3 px-12 bg-blue-600 text-white rounded-xl text-lg font-semibold hover:bg-blue-700 transition">
                    ë“±ë¡
                </button>
            </div>
        </form>
    </main>

    <!-- í˜ì´ì§€ ì „ìš© ìŠ¤í¬ë¦½íŠ¸ -->
    <script>
        // 1) ì£¼ì†Œ ê²€ìƒ‰ + ì§€ë„
        const btnSearchAddr = document.getElementById("btnSearchAddr");
        btnSearchAddr.addEventListener("click", () => {
            new daum.Postcode({
                oncomplete(data) {
                    const addr = data.address;
                    document.getElementById("address").value = addr;
                    updateMapByAddress(addr);
                    const detail = document.getElementById("detailAddress");
                    if (detail) detail.focus();
                }
            }).open();
        });

        window.map = null;
        window.marker = null;
        kakao.maps.load(function () {
            const mapContainer = document.getElementById("map");
            const pos = new kakao.maps.LatLng(37.5665, 126.9780);
            window.map = new kakao.maps.Map(mapContainer, { center: pos, level: 3 });
            window.marker = new kakao.maps.Marker({ map: window.map, position: pos });
        });

        function updateMapByAddress(address) {
            const geocoder = new kakao.maps.services.Geocoder();
            geocoder.addressSearch(address, function (result, status) {
                if (status === kakao.maps.services.Status.OK) {
                    const lat = result[0].y, lng = result[0].x;
                    const loc = new kakao.maps.LatLng(lat, lng);
                    window.map.setCenter(loc);
                    window.marker.setPosition(loc);
                }
            });
        }

        // 3) ì œì¶œ ì‹œ HTML ì‹±í¬
        document.getElementById("openForm").addEventListener("submit", async (e) => {
            e.preventDefault();

            console.log("ğŸ“ í¼ ì œì¶œ ì‹œì‘");
            // ì»¤ìŠ¤í…€ ì—ë””í„° ë‚´ìš© í™•ì¸
            const editorHtml = document.getElementById("descHtml").value;
            console.log("ğŸ“„ ì—ë””í„° ë‚´ìš©:", (editorHtml || "").substring(0, 120) + "...");

            const baseAddr = document.getElementById("address").value || "";
            const detailAddr = document.getElementById("detailAddress").value || "";
            console.log("ğŸ  ê¸°ë³¸ ì£¼ì†Œ:", baseAddr);
            console.log("ğŸ  ìƒì„¸ ì£¼ì†Œ:", detailAddr);

            const formData = new FormData(e.target);
            formData.set("address", baseAddr);
            formData.set("detail_address", detailAddr);

            console.log("ğŸ“¤ ì „ì†¡ ë°ì´í„°:");
            for (let [k, v] of formData.entries()) {
                if (k === "descHtml") {
                    console.log(`${k}: ${typeof v === "string" ? v.substring(0, 100) + "..." : v}`);
                } else {
                    console.log(`${k}: ${v}`);
                }
            }

            try {
                console.log("ğŸš€ ì„œë²„ë¡œ ì „ì†¡ ì¤‘...");
                const response = await fetch("/openregister", { method: "POST", body: formData });
                const result = await response.json();
                console.log("ğŸ“¥ ì„œë²„ ì‘ë‹µ:", result);

                if (result.success) {
                    alert("ë“±ë¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
                    console.log("âœ… ë“±ë¡ ì„±ê³µ - ID:", result.id);
                    window.location.href = "/open.html";
                } else {
                    alert("ë“±ë¡ ì‹¤íŒ¨: " + (result.error || result.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
                    console.error("âŒ ë“±ë¡ ì‹¤íŒ¨:", result);
                }
            } catch (err) {
                console.error("âŒ ì„œë²„ í†µì‹  ì˜¤ë¥˜:", err);
                alert("ì„œë²„ ì˜¤ë¥˜: " + err.message);
            }
        });

    </script>

<script>
// ğŸ”¹ ì»¤ìŠ¤í…€ ì—ë””í„° (íˆ´ë°”ëŠ” í¼ ë°–ì— ë¶„ë¦¬ë¨)
(function(){
  'use strict';

  // DOM ìš”ì†Œ ì°¸ì¡°
  var form = document.getElementById('openForm');
  var editor = document.getElementById('customEditor');
  var toolbar = document.getElementById('k-toolbar');
  var hidden = document.getElementById('descHtml');
  
  // íˆ´ë°” ë²„íŠ¼ë“¤
  var fontSizeSelector = document.getElementById('font-size-selector');
  var fontColorPicker = document.getElementById('font-color-picker');
  var imageInput = document.getElementById('image-input');
  var btnImage = document.getElementById('btn-image');

  var composing = false;
  var typingSpan = null;
  var ZWSP = '\u200B';

  // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
  function getSel(){ return window.getSelection ? window.getSelection() : null; }
  function newRange(){ return document.createRange ? document.createRange() : null; }

  function placeCaretInside(node, atEnd){
    if (atEnd === void 0) atEnd = true;
    if (!node) return;
    var r = newRange(); if (!r) return;
    var s = getSel(); if (!s) return;
    var target = (node.nodeType === 3) ? node : (node.lastChild || node.firstChild || node);
    if (!target) return;
    var len = (target.nodeType === 3 && target.nodeValue) ? target.nodeValue.length : 0;
    try { r.setStart(target, atEnd ? len : 0); r.collapse(true); s.removeAllRanges(); s.addRange(r); } catch(e){}
  }

  function caretToTail(){
    var s = getSel(); if (!s) return;
    var r = newRange(); if (!r) return;
    var node = editor;
    while (node && node.lastChild) node = node.lastChild;
    if (!node || node === editor) { var br = document.createElement('br'); editor.appendChild(br); node = br; }
    if (node.nodeType === 3) {
      var len = node.nodeValue ? node.nodeValue.length : 0;
      r.setStart(node, len);
    } else {
      r.setStartAfter(node);
    }
    r.collapse(true); s.removeAllRanges(); s.addRange(r);
  }

  function applyInlineStyle(styleObj){
    if (!styleObj) styleObj = {};
    editor.focus();
    var s = getSel(); if (!s || s.rangeCount === 0) return;

    if (!s.isCollapsed) {
      var r = s.getRangeAt(0);
      var span = document.createElement('span');
      for (var k in styleObj) if (styleObj.hasOwnProperty(k)) span.style[k] = styleObj[k];
      try { r.surroundContents(span); }
      catch(e){ var frag = r.extractContents(); span.appendChild(frag); r.insertNode(span); }
      var after = newRange(); if (!after) return;
      after.setStartAfter(span); after.collapse(true);
      s.removeAllRanges(); s.addRange(after);
      typingSpan = span;
      return;
    }

    if (typingSpan && editor.contains(typingSpan)) {
      for (var k2 in styleObj) if (styleObj.hasOwnProperty(k2)) typingSpan.style[k2] = styleObj[k2];
      var endNode = typingSpan.lastChild || typingSpan;
      placeCaretInside(endNode, true);
      return;
    }

    caretToTail();
    s = getSel(); if (!s || s.rangeCount === 0) return;
    var r2 = s.getRangeAt(0);

    var marker = document.createElement('span');
    marker.style.display = 'inline-block'; marker.style.width = '0'; marker.style.height = '0';
    marker.appendChild(document.createTextNode('\uFEFF'));
    r2.insertNode(marker);

    var span2 = document.createElement('span');
    span2.setAttribute('data-typing-span', 'true');
    for (var k3 in styleObj) if (styleObj.hasOwnProperty(k3)) span2.style[k3] = styleObj[k3];
    var tn = document.createTextNode(ZWSP); span2.appendChild(tn);
    if (marker.parentNode) marker.parentNode.insertBefore(span2, marker.nextSibling);
    if (marker.parentNode) marker.parentNode.removeChild(marker);
    placeCaretInside(tn, true);
    typingSpan = span2;
  }

  function insertImage(src){
    editor.focus();
    var s = getSel(); if (!s || s.rangeCount === 0) caretToTail();
    s = getSel(); if (!s || s.rangeCount === 0) return;
    var r = s.getRangeAt(0);
    var image = document.createElement('img');
    image.src = src; image.alt = 'image';
    image.style.maxWidth = '100%'; image.style.height = 'auto'; image.style.margin = '8px 0';
    image.style.borderRadius = '6px';
    r.insertNode(image);
    r.setStartAfter(image); r.collapse(true);
    s.removeAllRanges(); s.addRange(r);
  }

  // âœ… íˆ´ë°” ì´ë²¤íŠ¸ (í¼ ë°–ì´ë¯€ë¡œ ì•ˆì „)
  toolbar.addEventListener('mousedown', function(e){
    var target = e.target || e.srcElement;
    if (target && target.tagName === 'BUTTON') { 
      e.preventDefault(); 
      editor.focus(); 
    }
  });

  toolbar.addEventListener('click', function(e){
    var target = e.target || e.srcElement;
    if (!target) return;
    
    var cmd = target.getAttribute('data-cmd');
    if (cmd && !composing) {
      try { document.execCommand('styleWithCSS', false, true); } catch(e){}
      document.execCommand(cmd, false, null);
      editor.focus();
    }
  });

  // IME í•œê¸€ ì¡°í•© ì²˜ë¦¬
  editor.addEventListener('compositionstart', function(){ composing = true; });
  editor.addEventListener('compositionend', function(){
    composing = false;
    if (typingSpan && editor.contains(typingSpan)) {
      var t = typingSpan.lastChild || typingSpan.firstChild;
      if (t && t.nodeType === 3) {
        var v = t.nodeValue || '';
        if (v.indexOf(ZWSP) === 0) t.nodeValue = v.replace(/\u200B/g, '');
        placeCaretInside(t, true);
      } else {
        var tn2 = document.createTextNode('');
        typingSpan.appendChild(tn2);
        placeCaretInside(tn2, true);
      }
    }
  });

  editor.addEventListener('input', function(){
    if (!typingSpan) return;
    var t = typingSpan.firstChild;
    if (t && t.nodeType === 3 && t.nodeValue && t.nodeValue.indexOf(ZWSP) === 0) {
      t.nodeValue = t.nodeValue.replace(ZWSP, '');
    }
  });

  // ê¸€ì í¬ê¸° / ìƒ‰ìƒ
  if (fontSizeSelector) {
    fontSizeSelector.addEventListener('change', function(){
      if (composing) return;
      var val = fontSizeSelector.value;
      if (!val) return;
      applyInlineStyle({ fontSize: val });
      editor.focus();
    });
  }

  if (fontColorPicker) {
    fontColorPicker.addEventListener('input', function(){
      if (composing) return;
      var val = fontColorPicker.value;
      if (!val) return;
      applyInlineStyle({ color: val });
      editor.focus();
    });
  }

  // ì´ë¯¸ì§€ ì‚½ì…
  if (btnImage) {
    btnImage.addEventListener('click', function(){ 
      if (imageInput) imageInput.click(); 
    });
  }

  if (imageInput) {
    imageInput.addEventListener('change', function(e){
      if (composing) return;
      var file = (e.target && e.target.files && e.target.files[0]) ? e.target.files[0] : null;
      if (!file) return;
      var url = (window.URL && window.URL.createObjectURL) ? window.URL.createObjectURL(file) : null;
      if (!url) return;
      insertImage(url);
      imageInput.value = '';
    });
  }

  // âœ… í¼ ì œì¶œ ì§ì „ ë™ê¸°í™” (ì•ˆì „í•œ ë°©ì‹)
  if (form && editor && hidden) {
    form.addEventListener('submit', function(){
      hidden.value = editor.innerHTML.replace(/\u200B/g, '') || '';
    });
  }

  // ì—ë””í„° ì „ì—­ ì ‘ê·¼ìš© (ë””ë²„ê¹…/í™•ì¥ ê°€ëŠ¥)
  window.keditor = {
    getHTML: function() {
      return editor ? editor.innerHTML.replace(/\u200B/g, '') : '';
    },
    setHTML: function(html) {
      if (editor) editor.innerHTML = html || '';
    },
    focus: function() {
      if (editor) editor.focus();
    }
  };

})();
</script>
</body>

</html>