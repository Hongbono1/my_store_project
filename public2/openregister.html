<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì˜¤í”ˆì˜ˆì • ë“±ë¡ | MALL HANKOOK</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <script
        src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=6286d4d9bc1d503495b03f46622b5dc8&autoload=false&libraries=services"></script>
    <style>
        body {
            font-family: Pretendard, system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans KR', sans-serif;
            background: linear-gradient(135deg, #f8fafc, #e0e7ff);
            color: #111827;
            min-height: 100vh
        }

        .neo-card {
            background: rgba(255, 255, 255, .65);
            backdrop-filter: blur(14px);
            border: 1px solid rgba(255, 255, 255, .45);
            border-radius: 1.25rem;
            box-shadow: 8px 8px 24px rgba(0, 0, 0, .07)
        }

        [contenteditable][data-placeholder]:empty:before {
            content: attr(data-placeholder);
            color: #9ca3af;
            pointer-events: none
        }

        .editor-toolbar {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9)
        }

        .toolbar-btn {
            padding: 6px 12px;
            border: 1px solid #d1d5db;
            background: #fff;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all .2s
        }

        .toolbar-btn:hover {
            background: #e0e7ff;
            border-color: #6366f1
        }

        .toolbar-select {
            padding: 4px 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            background: #fff;
            font-size: 12px;
            cursor: pointer
        }

        .korean-toolbar {
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            border: 1px solid #cbd5e1
        }

        .korean-btn {
            width: 32px;
            height: 32px;
            border: 1px solid #d1d5db;
            background: #fff;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: .2s
        }

        .korean-btn:hover {
            background: #e0e7ff;
            border-color: #6366f1;
            transform: translateY(-1px)
        }

        .korean-select {
            padding: 4px 8px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: #fff;
            font-size: 12px;
            cursor: pointer
        }

        .color-btn {
            width: 24px;
            height: 24px;
            border: 2px solid #d1d5db;
            border-radius: 4px;
            cursor: pointer;
            margin: 0 2px;
            transition: .2s
        }

        .color-btn:hover {
            border-color: #374151;
            transform: scale(1.1)
        }

        .char-btn {
            width: 28px;
            height: 28px;
            border: 1px solid #d1d5db;
            background: #fff;
            border-radius: 4px;
            cursor: pointer;
            margin: 0 1px;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: .2s
        }

        .char-btn:hover {
            background: #dcfce7;
            border-color: #16a34a;
            transform: translateY(-1px)
        }

        .img-full {
            width: 100%;
            max-width: 720px;
            height: auto;
            max-height: 480px;
            object-fit: contain;
            border-radius: .5rem
        }

        .img-side {
            width: 360px;
            max-width: 380px;
            height: auto;
            max-height: 320px;
            object-fit: cover;
            border-radius: .5rem
        }

        .img-thumb {
            width: 240px;
            height: auto;
            max-height: 240px;
            object-fit: cover;
            border-radius: .375rem
        }

        @media (max-width:768px) {
            .img-full {
                max-height: 360px
            }

            .img-side {
                width: min(70%, 320px);
                max-height: 300px
            }

            .img-thumb {
                width: 48%;
                max-height: 200px
            }
        }
    </style>
</head>

<body class="flex flex-col items-center py-10">
    <main class="w-full max-w-3xl p-8 neo-card mt-10">
        <h1
            class="text-3xl font-extrabold text-center mb-8 bg-gradient-to-r from-blue-500 to-indigo-500 text-transparent bg-clip-text">
            ì˜¤í”ˆ ë§¤ì¥ ë“±ë¡
        </h1>

        <form id="openForm" class="space-y-6" enctype="multipart/form-data">
            <!-- ê¸°ë³¸ì •ë³´ -->
            <div>
                <label class="block font-semibold mb-1">ìƒí˜¸ëª…</label>
                <input name="store_name" type="text" required
                    class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-400" />
            </div>

            <div>
                <label class="block font-semibold mb-1">ì˜¤í”ˆì¼</label>
                <input name="open_date" type="date" required
                    class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-400" />
            </div>

            <div>
                <label class="block font-semibold mb-1">ì—…ì¢…(ì¹´í…Œê³ ë¦¬)</label>
                <input name="category" type="text" placeholder="ì˜ˆ: í•œì‹, ì¹´í˜, ë³‘ì› ë“±"
                    class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-400" />
            </div>

            <div>
                <label class="block font-semibold mb-1">ì „í™”ë²ˆí˜¸</label>
                <input name="phone" type="text" required placeholder="010-0000-0000"
                    class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-400" />
            </div>

            <!-- ì£¼ì†Œ -->
            <div>
                <label class="block font-semibold mb-1">ì£¼ì†Œ</label>
                <div class="flex gap-2">
                    <input id="address" name="address" type="text" readonly
                        class="flex-1 border rounded px-3 py-2 focus:ring-2 focus:ring-blue-400" />
                    <button type="button" id="btnSearchAddr"
                        class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">ê²€ìƒ‰</button>
                </div>
            </div>

            <!-- ìƒì„¸ ì£¼ì†Œ -->
            <div>
                <label class="block font-semibold mb-1 mt-2">ìƒì„¸ ì£¼ì†Œ</label>
                <input id="detailAddress" name="detail_address" type="text" placeholder="ì˜ˆ: 2ì¸µ, 203í˜¸"
                    class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-400" />
            </div>

            <!-- ì§€ë„ -->
            <div class="flex justify-center">
                <div id="map" class="rounded border border-gray-300 my-4 shadow-sm"
                    style="width:100%; height:260px; max-width:480px;"></div>
            </div>

            <!-- ëŒ€í‘œ ì´ë¯¸ì§€ -->
            <div>
                <label class="block font-semibold mb-1">ëŒ€í‘œ ì´ë¯¸ì§€</label>
                <input name="img" type="file" accept="image/*" class="w-full border rounded px-3 py-2 text-gray-700" />
            </div>

            <!-- ì„¤ëª… (ì—ë””í„°) -->
            <div>
                <label class="block font-semibold mb-2">ì„¤ëª…</label>

                <!-- ê¸°ë³¸ íˆ´ë°” -->
                <div class="editor-toolbar p-3 bg-white border border-gray-300 rounded-t-lg border-b-0">
                    <div class="flex flex-wrap gap-1 items-center">
                        <button type="button" class="toolbar-btn" id="btnBold"><strong>B</strong></button>
                        <button type="button" class="toolbar-btn" id="btnItalic"><em>I</em></button>
                        <button type="button" class="toolbar-btn" id="btnUnderline"><u>U</u></button>

                        <div class="border-l border-gray-300 h-6 mx-2"></div>

                        <select class="toolbar-select" id="selHeading">
                            <option value="">ì¼ë°˜</option>
                            <option value="h1">ì œëª©1</option>
                            <option value="h2">ì œëª©2</option>
                            <option value="h3">ì œëª©3</option>
                        </select>

                        <div class="border-l border-gray-300 h-6 mx-2"></div>

                        <button type="button" class="toolbar-btn" id="btnUL">â€¢ ëª©ë¡</button>
                        <button type="button" class="toolbar-btn" id="btnOL">1. ëª©ë¡</button>

                        <div class="border-l border-gray-300 h-6 mx-2"></div>

                        <button type="button" class="toolbar-btn" id="imageUploadBtn">ğŸ“· ì´ë¯¸ì§€</button>
                        <input type="file" id="imageUploadInput" accept="image/*" style="display:none;" />
                    </div>
                </div>

                <div id="customEditor" class="border border-gray-300 rounded-b-lg border-t-0 p-4" contenteditable="true"
                    data-placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."
                    style="min-height: 400px; font-size: 14px; line-height: 1.6; outline: none; background: white;">
                </div>

                <!-- í•œê¸€ íŠ¹í™” ì¶”ê°€ íˆ´ë°” -->
                <div class="korean-toolbar mt-2 p-3 bg-gray-50 rounded-lg border">
                    <div class="flex flex-wrap gap-2 items-center">
                        <span class="text-sm font-semibold text-gray-700">í•œê¸€ ë„êµ¬:</span>
                        <div class="flex gap-1">
                            <button type="button" class="korean-btn" id="btnAlignLeft">â—€</button>
                            <button type="button" class="korean-btn" id="btnAlignCenter">â—†</button>
                            <button type="button" class="korean-btn" id="btnAlignRight">â–¶</button>
                        </div>

                        <div class="border-l border-gray-300 h-6 mx-2"></div>

                        <select class="korean-select" id="selFontSize">
                            <option value="">ê¸€ì í¬ê¸° ì„ íƒ</option>
                            <option value="reset">ì¼ë°˜ í¬ê¸°ë¡œ ë˜ëŒë¦¬ê¸°</option>
                            <option value="10px">ë§¤ìš° ì‘ê²Œ (10px)</option>
                            <option value="12px">ì‘ê²Œ (12px)</option>
                            <option value="14px">ë³´í†µ (14px)</option>
                            <option value="16px">í¬ê²Œ (16px)</option>
                            <option value="18px">ë” í¬ê²Œ (18px)</option>
                            <option value="20px">ì œëª©ìš© (20px)</option>
                            <option value="24px">í° ì œëª© (24px)</option>
                        </select>

                        <div class="flex items-center gap-1">
                            <span class="text-xs text-gray-600">ìƒ‰ìƒ:</span>
                            <button type="button" class="color-btn" data-color="reset"
                                style="background: linear-gradient(45deg, #000 25%, transparent 25%, transparent 50%, #000 50%, #000 75%, transparent 75%); background-size: 8px 8px;"
                                title="ê¸°ë³¸ìƒ‰"></button>
                            <button type="button" class="color-btn" data-color="#000000" style="background:#000000"
                                title="ê²€ì •"></button>
                            <button type="button" class="color-btn" data-color="#FF0000" style="background:#FF0000"
                                title="ë¹¨ê°•"></button>
                            <button type="button" class="color-btn" data-color="#0066CC" style="background:#0066CC"
                                title="íŒŒë‘"></button>
                            <button type="button" class="color-btn" data-color="#008000" style="background:#008000"
                                title="ì´ˆë¡"></button>
                            <button type="button" class="color-btn" data-color="#FF6600" style="background:#FF6600"
                                title="ì£¼í™©"></button>
                        </div>

                        <div class="border-l border-gray-300 h-6 mx-2"></div>

                        <button type="button" class="korean-btn" id="btnResetAll" title="ëª¨ë“  ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”">ğŸ”„</button>

                        <div class="border-l border-gray-300 h-6 mx-2"></div>

                        <div class="flex items-center gap-1">
                            <span class="text-xs text-gray-600">íŠ¹ìˆ˜ë¬¸ì:</span>
                            <button type="button" class="char-btn" data-char="Â·">Â·</button>
                            <button type="button" class="char-btn" data-char="â€¦">â€¦</button>
                            <button type="button" class="char-btn" data-char="â€»">â€»</button>
                            <button type="button" class="char-btn" data-char="â˜…">â˜…</button>
                            <button type="button" class="char-btn" data-char="â‘ ">â‘ </button>
                            <button type="button" class="char-btn" data-char="â‘¡">â‘¡</button>
                            <button type="button" class="char-btn" data-char="â‘¢">â‘¢</button>
                            <button type="button" class="char-btn" data-char="ã€Œ">ã€Œ</button>
                            <button type="button" class="char-btn" data-char="ã€">ã€</button>
                        </div>
                    </div>
                </div>

                <textarea id="descHtml" name="description" class="hidden"></textarea>
            </div>

            <!-- ë“±ë¡ ë²„íŠ¼ -->
            <div class="flex justify-center">
                <button type="submit"
                    class="mt-4 py-3 px-12 bg-blue-600 text-white rounded-xl text-lg font-semibold hover:bg-blue-700 transition">
                    ë“±ë¡
                </button>
            </div>
        </form>
    </main>

    <!-- í˜ì´ì§€ ì „ìš© ìŠ¤í¬ë¦½íŠ¸ -->
    <script type="module">
        import { createKEditor } from "/k-editor.js";

        // 1) ì£¼ì†Œ ê²€ìƒ‰ + ì§€ë„
        const btnSearchAddr = document.getElementById("btnSearchAddr");
        btnSearchAddr.addEventListener("click", () => {
            new daum.Postcode({
                oncomplete(data) {
                    const addr = data.address;
                    document.getElementById("address").value = addr;
                    updateMapByAddress(addr);
                    const detail = document.getElementById("detailAddress");
                    if (detail) detail.focus();
                }
            }).open();
        });

        window.map = null;
        window.marker = null;
        kakao.maps.load(function () {
            const mapContainer = document.getElementById("map");
            const pos = new kakao.maps.LatLng(37.5665, 126.9780);
            window.map = new kakao.maps.Map(mapContainer, { center: pos, level: 3 });
            window.marker = new kakao.maps.Marker({ map: window.map, position: pos });
        });

        function updateMapByAddress(address) {
            const geocoder = new kakao.maps.services.Geocoder();
            geocoder.addressSearch(address, function (result, status) {
                if (status === kakao.maps.services.Status.OK) {
                    const lat = result[0].y, lng = result[0].x;
                    const loc = new kakao.maps.LatLng(lat, lng);
                    window.map.setCenter(loc);
                    window.marker.setPosition(loc);
                }
            });
        }

        // 2) ì—ë””í„° ì´ˆê¸°í™” (íˆ´ë°” DOM ì—°ê²°)
        const editorRoot = document.getElementById("customEditor");

        // íˆ´ë°” ìš”ì†Œë“¤ "ì°¸ì¡°ë§Œ" ë„˜ê¸´ë‹¤. (click/change í•¸ë“¤ëŸ¬ëŠ” ëª¨ë“ˆì´ ë‹¤ ê±´ë‹¤)
        const toolbar = {
            buttons: {
                bold: document.getElementById("btnBold"),
                italic: document.getElementById("btnItalic"),
                underline: document.getElementById("btnUnderline"),
                ul: document.getElementById("btnUL"),
                ol: document.getElementById("btnOL"),
                alignLeft: document.getElementById("btnAlignLeft"),
                alignCenter: document.getElementById("btnAlignCenter"),
                alignRight: document.getElementById("btnAlignRight"),
            },
            selects: {
                heading: document.getElementById("selHeading"),
                fontSize: document.getElementById("selFontSize"),
            },
            colorButtons: Array.from(document.querySelectorAll(".color-btn")),
            charButtons: Array.from(document.querySelectorAll(".char-btn")),
            imageButton: document.getElementById("imageUploadBtn"),
            imageInput: document.getElementById("imageUploadInput"),
        };

        const ke = createKEditor({
            root: editorRoot,
            toolbar,
            uploadEndpoint: "/upload/image",
        });

        // 3) ì œì¶œ ì‹œ HTML ì‹±í¬
        document.getElementById("openForm").addEventListener("submit", async (e) => {
            e.preventDefault();

            console.log("ğŸ“ í¼ ì œì¶œ ì‹œì‘");
            document.getElementById("descHtml").value = ke.getHTML();
            const editorHtml = ke.getHTML();
            console.log("ğŸ“„ ì—ë””í„° ë‚´ìš©:", editorHtml.substring(0, 120) + "...");

            const baseAddr = document.getElementById("address").value || "";
            const detailAddr = document.getElementById("detailAddress").value || "";
            console.log("ğŸ  ê¸°ë³¸ ì£¼ì†Œ:", baseAddr);
            console.log("ğŸ  ìƒì„¸ ì£¼ì†Œ:", detailAddr);

            const formData = new FormData(e.target);
            formData.set("address", baseAddr);
            formData.set("detail_address", detailAddr);

            console.log("ğŸ“¤ ì „ì†¡ ë°ì´í„°:");
            for (let [k, v] of formData.entries()) {
                if (k === "description") {
                    console.log(`${k}: ${typeof v === "string" ? v.substring(0, 100) + "..." : v}`);
                } else {
                    console.log(`${k}: ${v}`);
                }
            }

            try {
                console.log("ğŸš€ ì„œë²„ë¡œ ì „ì†¡ ì¤‘...");
                const response = await fetch("/openregister", { method: "POST", body: formData });
                const result = await response.json();
                console.log("ğŸ“¥ ì„œë²„ ì‘ë‹µ:", result);

                if (result.success) {
                    alert("ë“±ë¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
                    console.log("âœ… ë“±ë¡ ì„±ê³µ - ID:", result.id);
                    window.location.href = "/open.html";
                } else {
                    alert("ë“±ë¡ ì‹¤íŒ¨: " + (result.error || result.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
                    console.error("âŒ ë“±ë¡ ì‹¤íŒ¨:", result);
                }
            } catch (err) {
                console.error("âŒ ì„œë²„ í†µì‹  ì˜¤ë¥˜:", err);
                alert("ì„œë²„ ì˜¤ë¥˜: " + err.message);
            }
        });

        // ë””ë²„ê¹…ìš© ì „ì—­ ë…¸ì¶œ(ì„ íƒ)
        window.__KEDITOR__ = ke;
    </script>
</body>

</html>