<!DOCTYPE html>

<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>오픈예정 등록 | MALL HANKOOK</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Toast UI Editor -->

    <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css">
    <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>

    <!-- Daum 주소검색 / Kakao 지도 -->

    <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

    <script
        src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=6286d4d9bc1d503495b03f46622b5dc8&autoload=false&libraries=services"></script>

    <style>
        body {
            font-family: 'Pretendard', sans-serif;
            background: linear-gradient(135deg, #f8fafc, #e0e7ff);
            color: #1e293b;
            min-height: 100vh;
        }

        .neo-card {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(14px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 1.5rem;
            box-shadow: 8px 8px 20px rgba(0, 0, 0, 0.08);
        }
    </style>

</head>

<body class="flex flex-col items-center py-10">
    <div id="header-container" class="w-full"></div>

    <main class="w-full max-w-3xl p-8 neo-card mt-10">
        <h1 class="text-3xl font-extrabold mb-8 text-center gradient-text">오픈 매장 등록</h1>
        <form id="openForm" class="space-y-6" enctype="multipart/form-data">
            <div>
                <label class="block font-semibold mb-1">상호명</label>
                <input name="store_name" type="text" required
                    class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-400" />
            </div>

            <div>
                <label class="block font-semibold mb-1">오픈일</label>
                <input name="open_date" type="date" required
                    class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-400" />
            </div>

            <div>
                <label class="block font-semibold mb-1">업종(카테고리)</label>
                <input name="category" type="text"
                    class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-400"
                    placeholder="예: 한식, 카페, 병원 등" />
            </div>

            <div>
                <label class="block font-semibold mb-1">전화번호</label>
                <input name="phone" type="text" required placeholder="010-0000-0000"
                    class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-400" />
            </div>

            <!-- 주소 -->
            <div>
                <label class="block font-semibold mb-1">주소</label>
                <div class="flex gap-2">
                    <input id="address" name="address" type="text" readonly
                        class="flex-1 border rounded px-3 py-2 focus:ring-2 focus:ring-blue-400" />
                    <button type="button" onclick="searchAddress()"
                        class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">검색</button>
                </div>
            </div>

            <!-- 상세주소 -->
            <div>
                <label class="block font-semibold mb-1">상세 주소</label>
                <input id="detailAddress" name="detail_address" type="text" placeholder="예: 2층, ○○호, 매장 내부 등"
                    class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-400" />
            </div>

            <!-- 지도 -->
            <div class="flex justify-center">
                <div id="map" class="rounded border border-gray-300 my-4 shadow-sm"
                    style="width:100%; min-width:180px; height:260px; max-width:480px;"></div>
            </div>

            <input type="hidden" id="lat" name="lat">
            <input type="hidden" id="lng" name="lng">

            <!-- 대표 이미지 -->
            <div>
                <label class="block font-semibold mb-2">대표 이미지</label>
                <input name="img" type="file" accept="image/*" class="w-full border rounded px-3 py-2 text-gray-700" />
            </div>

            <!-- 설명 (Toast UI Editor) -->
            <div>
                <label class="block font-semibold mb-2">설명 (블로그 형식으로 작성 가능)</label>
                <div id="editor" class="border rounded-lg"></div>
            </div>

            <button type="submit" class="mt-4 py-2 px-6 bg-blue-600 text-white rounded font-semibold hover:bg-blue-700">
                등록
            </button>
        </form>
        ```

    </main>

    <div id="footer-container" class="w-full mt-10"></div>

    <script>
        /* ===== Toast UI Editor 초기화 ===== */
        let editor;
        document.addEventListener("DOMContentLoaded", () => {
            editor = new toastui.Editor({
                el: document.querySelector('#editor'),
                height: '400px',
                initialEditType: 'wysiwyg',
                previewStyle: 'vertical',
                hooks: {
                    async addImageBlobHook(blob, callback) {
                        try {
                            const formData = new FormData();
                            formData.append('image', blob);
                            const res = await fetch('/upload/image', { method: 'POST', body: formData });
                            const data = await res.json();
                            if (data.url) callback(data.url, '업로드된 이미지');
                            else alert('이미지 업로드 실패');
                        } catch (err) {
                            console.error(err);
                            alert('이미지 업로드 오류');
                        }
                    }
                }
            });
        });

        /* ===== 주소 검색 ===== */
        function searchAddress() {
            new daum.Postcode({
                oncomplete: function (data) {
                    const addr = data.address;
                    document.getElementById("address").value = addr;
                    updateMapByAddress(addr);
                    document.getElementById("detailAddress").focus();
                }
            }).open();
        }
        window.searchAddress = searchAddress;

        /* ===== Kakao 지도 초기화 ===== */
        window.map = null;
        window.marker = null;
        kakao.maps.load(function () {
            const mapContainer = document.getElementById("map");
            const defaultPos = new kakao.maps.LatLng(37.5665, 126.9780);
            window.map = new kakao.maps.Map(mapContainer, {
                center: defaultPos,
                level: 3
            });
            window.marker = new kakao.maps.Marker({
                map: window.map,
                position: defaultPos
            });
        });

        function updateMapByAddress(address) {
            const geocoder = new kakao.maps.services.Geocoder();
            geocoder.addressSearch(address, function (result, status) {
                if (status === kakao.maps.services.Status.OK) {
                    const lat = result[0].y;
                    const lng = result[0].x;
                    const loc = new kakao.maps.LatLng(lat, lng);
                    window.map.setCenter(loc);
                    window.marker.setPosition(loc);
                    document.getElementById("lat").value = lat;
                    document.getElementById("lng").value = lng;
                }
            });
        }

        /* ===== 폼 제출 ===== */
        document.getElementById("openForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            formData.set("description", editor.getHTML());

            try {
                const res = await fetch("/openregister", {
                    method: "POST",
                    body: formData
                });
                const json = await res.json();
                if (json.success) {
                    alert("등록이 완료되었습니다!");
                    e.target.reset();
                    editor.setHTML("");
                } else {
                    alert("등록 실패: " + (json.message || "서버 오류"));
                }
            } catch (err) {
                console.error(err);
                alert("서버 통신 오류: " + err.message);
            }
        });
    </script>

</body>

</html>