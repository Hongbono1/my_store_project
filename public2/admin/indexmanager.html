<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MALL HANKOOK | Index Layout Manager (indexmanager)</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body {
            font-family: 'Noto Sans KR', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        /* =========================
       ✅ 카드/슬롯 기본 스타일
    ========================== */
        .neo-card {
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid rgba(59, 130, 246, 0.18);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 1rem;
            box-shadow:
                6px 6px 12px rgba(0, 0, 0, 0.08),
                -6px -6px 12px rgba(255, 255, 255, 0.85);
            transition: all 0.22s ease;
        }

        .neo-card:hover {
            transform: translateY(-2px);
            box-shadow:
                10px 10px 18px rgba(0, 0, 0, 0.12),
                -6px -6px 10px rgba(255, 255, 255, 0.95);
        }

        .slot-banner {
            position: relative;
            overflow: hidden;
            cursor: pointer;
            isolation: isolate;
        }

        /* ✅ 슬롯 이미지 안전 규격 */
        .slot-banner .slot-img {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            display: block;
            object-fit: cover;
            z-index: 1;
        }

        .slot-banner .slot-default {
            position: relative;
            z-index: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(107, 114, 128, 0.9);
            font-size: 0.85rem;
            background: linear-gradient(135deg, #f8fafc, #f1f 5f9);
        }

        .slot-img.hidden {
            display: none !important;
        }

        /* =========================
       ✅ 관리자 오버레이 배지
       - label(검정 바탕 이름 배지)은 HTML에서 모두 제거됨
    ========================== */
        .slot-badge {
            position: absolute;
            z-index: 3;
            font-size: 10px;
            line-height: 1;
            padding: 6px 8px;
            border-radius: 9999px;
            background: rgba(15, 23, 42, 0.85);
            color: white;
            backdrop-filter: blur(6px);
            -webkit-backdrop-filter: blur(6px);
            letter-spacing: 0.2px;
        }

        .slot-badge.size {
            bottom: 10px;
            right: 10px;
            background: rgba(37, 99, 235, 0.9);
        }

        .slot-badge.store {
            bottom: 10px;
            left: 10px;
            background: rgba(16, 185, 129, 0.9);
        }

        /* =========================
       ✅ 커서 따라오는 툴팁
    ========================== */
        #hoverTip {
            position: fixed;
            z-index: 9999;
            pointer-events: none;
            transform: translate(12px, 12px);
            padding: 6px 10px;
            font-size: 11px;
            border-radius: 8px;
            background: rgba(2, 6, 23, 0.9);
            color: white;
            opacity: 0;
            transition: opacity 0.08s ease;
            white-space: nowrap;
        }

        #hoverTip.show {
            opacity: 1;
        }

        /* =========================
       ✅ 모달 기본
    ========================== */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(2, 6, 23, 0.65);
            backdrop-filter: blur(6px);
            -webkit-backdrop-filter: blur(6px);
            z-index: 9998;
        }

        .modal-panel {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
            z-index: 9999;
        }

        .modal-card {
            width: min(920px, 96vw);
            max-height: 92vh;
            overflow: auto;
            border-radius: 20px;
            background: white;
            border: 1px solid rgba(148, 163, 184, 0.35);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.25);
        }

        .field {
            width: 100%;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 10px 12px;
            outline: none;
        }

        .field:focus {
            border-color: #60a5fa;
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.25);
        }

        .divider {
            height: 1px;
            background: #eef2f7;
        }

        /* Best Pick 원형 슬롯 */
        .best-circle {
            position: relative;
            border-radius: 9999px;
            overflow: hidden;
        }

        .best-circle .slot-img {
            object-fit: cover;
        }

        .slot-text-body:empty+.slot-hint {
            display: block;
        }

        .slot-text-body:not(:empty)+.slot-hint {
            display: none;
        }
    </style>
</head>

<body class="bg-white text-gray-800">

    <!-- 상단 타이틀 -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 pt-10">
        <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-3">
            <div>
                <h1 class="text-2xl sm:text-3xl font-extrabold tracking-tight">
                    Index 레이아웃 관리자 (indexmanager)
                </h1>
                <p class="text-sm text-gray-500 mt-1">
                    각 박스를 클릭해 이미지 / 가게 연결 / 텍스트 광고를 설정하세요.
                </p>
            </div>
            <div class="flex items-center gap-2">
                <span class="text-xs px-2 py-1 rounded-full bg-blue-50 text-blue-700 border border-blue-100">
                    page = index
                </span>
                <span class="text-xs px-2 py-1 rounded-full bg-slate-50 text-slate-600 border border-slate-100">
                    /manager/ad/slot 연동
                </span>
            </div>
        </div>
    </div>

    <!-- =========================
       ① 상단 띠배너
  ========================== -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 mt-10">
        <div id="slot_index_main_top"
            class="neo-card h-48 flex flex-col items-center justify-center text-center slot-banner"
            data-position="index_main_top" data-label="상단 띠배너" data-size="가로형 (권장 비율 6:1)">
            <img class="slot-img hidden" alt="상단 띠배너">
            <div class="slot-default">
                <div>
                    <p class="text-lg sm:text-xl font-bold">상단 띠배너</p>
                    <p class="text-gray-500 text-xs sm:text-sm">클릭하여 광고 설정</p>
                </div>
            </div>
            <span class="slot-badge size">6:1</span>
            <span class="slot-badge store hidden"></span>
        </div>
    </div>

    <!-- =========================
       ② 메인 비주얼 + ③④⑤ 프로모
  ========================== -->
    <section class="max-w-7xl mx-auto px-4 sm:px-6 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 items-stretch">

            <!-- 메인 비주얼 -->
            <div class="lg:col-span-3">
                <div id="slot_index_main_visual"
                    class="slot-banner rounded-2xl overflow-hidden bg-gray-100 shadow-lg aspect-[21/9] w-full h-full"
                    data-position="index_main_visual" data-label="메인 비주얼" data-size="권장 비율 21:9">
                    <img class="slot-img hidden w-full h-full" alt="메인 비주얼">
                    <div class="slot-default w-full h-full">
                        <div class="text-center">
                            <p class="text-lg sm:text-xl font-bold">메인 비주얼</p>
                            <p class="text-gray-500 text-xs sm:text-sm mt-1">클릭하여 광고 설정</p>
                        </div>
                    </div>
                    <span class="slot-badge size">21:9</span>
                    <span class="slot-badge store hidden"></span>
                </div>
            </div>

            <!-- 프로모 1/2/3 컬럼 -->
            <div class="lg:col-span-1 flex flex-col gap-4 h-full">

                <div id="slot_index_promo_1"
                    class="slot-banner rounded-2xl border border-gray-100 bg-white shadow-sm overflow-hidden flex-1 min-h-[90px] aspect-[4/3]"
                    data-position="index_promo_1" data-label="프로모 1" data-size="권장 비율 4:3">
                    <img class="slot-img hidden" alt="프로모 1">
                    <div class="slot-default">
                        <span>Promo 1</span>
                    </div>
                    <span class="slot-badge size">4:3</span>
                    <span class="slot-badge store hidden"></span>
                </div>

                <div id="slot_index_promo_2"
                    class="slot-banner rounded-2xl border border-gray-100 bg-white shadow-sm overflow-hidden flex-1 min-h-[90px] aspect-[4/3]"
                    data-position="index_promo_2" data-label="프로모 2" data-size="권장 비율 4:3">
                    <img class="slot-img hidden" alt="프로모 2">
                    <div class="slot-default">
                        <span>Promo 2</span>
                    </div>
                    <span class="slot-badge size">4:3</span>
                    <span class="slot-badge store hidden"></span>
                </div>

                <div id="slot_index_promo_3"
                    class="slot-banner rounded-2xl border border-gray-100 bg-white shadow-sm overflow-hidden flex-1 min-h-[90px] aspect-[4/3]"
                    data-position="index_promo_3" data-label="프로모 3" data-size="권장 비율 4:3">
                    <img class="slot-img hidden" alt="프로모 3">
                    <div class="slot-default">
                        <span>Promo 3</span>
                    </div>
                    <span class="slot-badge size">4:3</span>
                    <span class="slot-badge store hidden"></span>
                </div>

            </div>
        </div>
    </section>

    <!-- =========================
       ⑥ 상단 서브 박스
       ✅ 4개는 "텍스트 전용"
  ========================== -->
    <section class="max-w-7xl mx-auto px-4 sm:px-6 py-6">
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 text-center">

            <!-- 1) 검색어 -->
            <div>
                <h3 class="font-extrabold text-2xl sm:text-3xl mb-3">검색어</h3>
                <div id="slot_index_sub_keywords" class="neo-card min-h-[180px] sm:min-h-[220px] p-6 sm:p-7 slot-banner"
                    data-position="index_sub_keywords" data-label="검색어 박스" data-size="텍스트 영역">
                    <img class="slot-img hidden" alt="검색어">

                    <div class="h-full flex flex-col items-center justify-center gap-3">
                        <div
                            class="slot-text-body text-[18px] sm:text-[22px] font-semibold text-gray-800 leading-relaxed whitespace-pre-line">
                        </div>
                        <div class="slot-hint text-base sm:text-lg text-gray-500 font-medium">텍스트 전용</div>
                    </div>

                    <span class="slot-badge size text-sm sm:text-base">Text</span>
                    <span class="slot-badge store hidden"></span>
                </div>
            </div>

            <!-- 2) 최신 소식 -->
            <div>
                <h3 class="font-extrabold text-2xl sm:text-3xl mb-3">최신 소식</h3>
                <div id="slot_index_sub_news" class="neo-card min-h-[180px] sm:min-h-[220px] p-6 sm:p-7 slot-banner"
                    data-position="index_sub_news" data-label="최신 소식 박스" data-size="텍스트 영역">
                    <img class="slot-img hidden" alt="최신 소식">

                    <div class="h-full flex flex-col items-center justify-center gap-3">
                        <div
                            class="slot-text-body text-[18px] sm:text-[22px] font-semibold text-gray-800 leading-relaxed whitespace-pre-line">
                        </div>
                        <div class="slot-hint text-base sm:text-lg text-gray-500 font-medium">텍스트 전용</div>
                    </div>

                    <span class="slot-badge size text-sm sm:text-base">Text</span>
                    <span class="slot-badge store hidden"></span>
                </div>
            </div>

            <!-- 3) 이벤트 정보 -->
            <div>
                <h3 class="font-extrabold text-2xl sm:text-3xl mb-3">이벤트 정보</h3>
                <div id="slot_index_sub_events" class="neo-card min-h-[180px] sm:min-h-[220px] p-6 sm:p-7 slot-banner"
                    data-position="index_sub_events" data-label="이벤트 정보 박스" data-size="텍스트 영역">
                    <img class="slot-img hidden" alt="이벤트 정보">

                    <div class="h-full flex flex-col items-center justify-center gap-3">
                        <div
                            class="slot-text-body text-[18px] sm:text-[22px] font-semibold text-gray-800 leading-relaxed whitespace-pre-line">
                        </div>
                        <div class="slot-hint text-base sm:text-lg text-gray-500 font-medium">텍스트 전용</div>
                    </div>

                    <span class="slot-badge size text-sm sm:text-base">Text</span>
                    <span class="slot-badge store hidden"></span>
                </div>
            </div>

            <!-- 4) 추천 제품 -->
            <div>
                <h3 class="font-extrabold text-2xl sm:text-3xl mb-3">추천 제품</h3>
                <div id="slot_index_sub_recommends"
                    class="neo-card min-h-[180px] sm:min-h-[220px] p-6 sm:p-7 slot-banner"
                    data-position="index_sub_recommends" data-label="추천 제품 박스" data-size="텍스트 영역">
                    <img class="slot-img hidden" alt="추천 제품">

                    <div class="h-full flex flex-col items-center justify-center gap-3">
                        <div
                            class="slot-text-body text-[18px] sm:text-[22px] font-semibold text-gray-800 leading-relaxed whitespace-pre-line">
                        </div>
                        <div class="slot-hint text-base sm:text-lg text-gray-500 font-medium">텍스트 전용</div>
                    </div>

                    <span class="slot-badge size text-sm sm:text-base">Text</span>
                    <span class="slot-badge store hidden"></span>
                </div>
            </div>

        </div>
    </section>

    <!-- =========================
       ⑦ Best Pick (관리자 버전)
  ========================== -->
    <section class="max-w-7xl mx-auto px-4 sm:px-6 py-10">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-2xl sm:text-3xl font-bold">Best Pick</h2>
            <span class="text-xs text-gray-500">최대 18개 슬롯</span>
        </div>

        <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-4">
            <div id="best_pick_grid"></div>
        </div>
    </section>

    <!-- =========================
   ⑧ 우리동네 한마디
========================== -->
    <section class="max-w-7xl mx-auto px-4 sm:px-6 py-6">
        <div class="w-[73%] mx-auto">
            <div id="slot_index_oneword"
                class="neo-card h-28 sm:h-32 rounded-2xl flex flex-col items-center justify-center p-5 shadow-xl border-2 border-blue-400 slot-banner"
                data-position="index_oneword" data-label="우리동네 한마디" data-size="텍스트 영역">

                <img class="slot-img hidden" alt="우리동네 한마디">

                <div class="h-full w-full flex flex-col items-center justify-center gap-2">
                    <div class="text-xl sm:text-2xl font-semibold text-blue-600">📍 우리동네 한마디</div>

                    <div
                        class="slot-text-body text-xl sm:text-2xl md:text-3xl font-extrabold text-gray-800 text-center leading-tight whitespace-pre-line">
                    </div>
                    <div class="slot-hint text-sm sm:text-base text-gray-500 font-medium">텍스트 전용</div>
                </div>

                <span class="slot-badge size text-sm sm:text-base">Text</span>
                <span class="slot-badge store hidden"></span>
            </div>
        </div>
    </section>

    <!-- =========================
       ⑨ 기능 진입 카드들
  ========================== -->
    <section class="max-w-7xl mx-auto px-4 sm:px-6 py-10 grid grid-cols-1 lg:grid-cols-3 gap-6">

        <div class="grid grid-rows-2 gap-4">
            <div id="slot_index_food_delivery"
                class="slot-banner rounded-lg overflow-hidden min-h-28 sm:min-h-40 bg-gray-100"
                data-position="index_food_delivery" data-label="홍보의 배달" data-size="자유 / 권장 16:9">
                <img class="slot-img hidden" alt="홍보의 배달">
                <div class="slot-default">홍보의 배달</div>
                <span class="slot-badge size">16:9</span>
                <span class="slot-badge store hidden"></span>
            </div>

            <div id="slot_index_all_stores"
                class="slot-banner rounded-lg overflow-hidden min-h-28 sm:min-h-40 bg-gray-100"
                data-position="index_all_stores" data-label="우리동네 모든가게" data-size="자유 / 권장 16:9">
                <img class="slot-img hidden" alt="우리동네 모든가게">
                <div class="slot-default">우리동네 모든가게</div>
                <span class="slot-badge size">16:9</span>
                <span class="slot-badge store hidden"></span>
            </div>
        </div>

        <div class="lg:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div id="slot_index_hot_place" class="slot-banner rounded-lg overflow-hidden bg-gray-100 aspect-[4/3]"
                data-position="index_hot_place" data-label="가장 HOT한 우리동네" data-size="권장 4:3">
                <img class="slot-img hidden" alt="가장 HOT한 우리동네">
                <div class="slot-default">가장 HOT한 우리동네</div>
                <span class="slot-badge size">4:3</span>
                <span class="slot-badge store hidden"></span>
            </div>

            <div id="slot_index_suggest" class="slot-banner rounded-lg overflow-hidden bg-gray-100 aspect-[4/3]"
                data-position="index_suggest" data-label="홍보의 추천" data-size="권장 4:3">
                <img class="slot-img hidden" alt="홍보의 추천">
                <div class="slot-default">홍보의 추천</div>
                <span class="slot-badge size">4:3</span>
                <span class="slot-badge store hidden"></span>
            </div>

            <div id="slot_index_open" class="slot-banner rounded-lg overflow-hidden bg-gray-100 aspect-[4/3]"
                data-position="index_open" data-label="오픈 예정" data-size="권장 4:3">
                <img class="slot-img hidden" alt="오픈 예정">
                <div class="slot-default">오픈 예정</div>
                <span class="slot-badge size">4:3</span>
                <span class="slot-badge store hidden"></span>
            </div>

            <div id="slot_index_store_pride" class="slot-banner rounded-lg overflow-hidden bg-gray-100 aspect-[4/3]"
                data-position="index_store_pride" data-label="가게자랑" data-size="권장 4:3">
                <img class="slot-img hidden" alt="가게자랑">
                <div class="slot-default">가게자랑</div>
                <span class="slot-badge size">4:3</span>
                <span class="slot-badge store hidden"></span>
            </div>

            <div id="slot_index_traditional" class="slot-banner rounded-lg overflow-hidden bg-gray-100 aspect-[4/3]"
                data-position="index_traditional" data-label="전통시장" data-size="권장 4:3">
                <img class="slot-img hidden" alt="전통시장">
                <div class="slot-default">전통시장</div>
                <span class="slot-badge size">4:3</span>
                <span class="slot-badge store hidden"></span>
            </div>

            <div id="slot_index_performing" class="slot-banner rounded-lg overflow-hidden bg-gray-100 aspect-[4/3]"
                data-position="index_performing" data-label="공연/예술, 축제" data-size="권장 4:3">
                <img class="slot-img hidden" alt="공연/예술, 축제">
                <div class="slot-default font-bold">공연/예술, 축제</div>
                <span class="slot-badge size">4:3</span>
                <span class="slot-badge store hidden"></span>
            </div>
        </div>
    </section>

    <!-- =========================
       ⑩⑪ 이벤트 / 지역 게시판
  ========================== -->
    <section class="max-w-7xl mx-auto px-4 sm:px-6 py-10 grid grid-cols-1 sm:grid-cols-2 gap-6">
        <div id="slot_index_event" class="slot-banner rounded-lg overflow-hidden bg-yellow-50 min-h-36 sm:min-h-52"
            data-position="index_event" data-label="이벤트" data-size="권장 16:9">
            <img class="slot-img hidden" alt="이벤트">
            <div class="slot-default">
                <span class="text-lg font-bold">이벤트</span>
            </div>
            <span class="slot-badge size">16:9</span>
            <span class="slot-badge store hidden"></span>
        </div>

        <div id="slot_index_localboard" class="slot-banner rounded-lg overflow-hidden bg-blue-50 min-h-36 sm:min-h-52"
            data-position="index_localboard" data-label="지역 게시판" data-size="권장 16:9">
            <img class="slot-img hidden" alt="지역 게시판">
            <div class="slot-default">
                <span class="text-lg font-bold">지역 게시판</span>
            </div>
            <span class="slot-badge size">16:9</span>
            <span class="slot-badge store hidden"></span>
        </div>
    </section>

    <!-- =========================
       ⑫⑬ 계절 테마 / 신규 회원 혜택
  ========================== -->
    <section class="max-w-7xl mx-auto px-4 sm:px-6 py-10 grid grid-cols-1 sm:grid-cols-2 gap-6">
        <div id="slot_index_season" class="slot-banner rounded-lg overflow-hidden bg-gray-100 min-h-36 sm:min-h-52"
            data-position="index_season" data-label="계절테마" data-size="권장 16:9">
            <img class="slot-img hidden" alt="계절테마">
            <div class="slot-default">
                <span class="text-lg font-bold">계절테마</span>
            </div>
            <span class="slot-badge size">16:9</span>
            <span class="slot-badge store hidden"></span>
        </div>

        <div id="slot_index_join" class="slot-banner rounded-lg overflow-hidden bg-gray-100 min-h-36 sm:min-h-52"
            data-position="index_join" data-label="신규 회원 혜택" data-size="권장 16:9">
            <img class="slot-img hidden" alt="신규 회원 혜택">
            <div class="slot-default flex-col">
                <span class="text-lg font-bold">신규 회원 혜택</span>
                <span class="text-xs text-gray-500 mt-1">클릭하여 설정</span>
            </div>
            <span class="slot-badge size">16:9</span>
            <span class="slot-badge store hidden"></span>
        </div>
    </section>

    <!-- ✅ 쇼핑몰(좌 배너 + 우 카드) -->
    <section class="max-w-7xl mx-auto px-4 sm:px-6 py-10">
        <div class="neo-card overflow-hidden flex flex-col md:flex-row">

            <div id="slot_index_d2c_banner" class="slot-banner relative flex-1 min-h-[140px] bg-gray-100"
                data-position="index_d2c_banner" data-label="쇼핑몰 배너" data-size="좌 배너(가로형)">
                <img class="slot-img hidden" alt="쇼핑몰 배너">
                <div class="slot-default">
                    <span class="text-sm sm:text-base font-semibold text-gray-400">쇼핑몰 이미지</span>
                </div>
                <span class="slot-badge size">BANNER</span>
                <span class="slot-badge store hidden"></span>
            </div>

            <div id="slot_index_d2c_shop"
                class="slot-banner bg-white md:w-[300px] border-t md:border-t-0 md:border-l border-slate-100 p-6 flex flex-col justify-center gap-3 cursor-pointer"
                data-position="index_d2c_shop" data-label="쇼핑몰 버튼" data-size="우 버튼">
                <img class="slot-img hidden" alt="쇼핑몰 버튼">
                <div class="slot-default">
                    <div class="flex items-center gap-2">
                        <div
                            class="w-9 h-9 rounded-xl bg-slate-100 flex items-center justify-center text-xs text-slate-400">
                            🛍️</div>
                        <div class="text-xl font-extrabold text-slate-900">쇼핑몰</div>
                    </div>
                    <div class="text-sm text-slate-500">지역 상품/굿즈를 한 번에</div>

                    <div class="mt-1">
                        <span
                            class="inline-flex items-center gap-2 rounded-full bg-blue-600 px-4 py-2 text-white text-sm font-semibold shadow hover:bg-blue-700 select-none">
                            쇼핑몰 들어가기 →
                        </span>
                    </div>

                    <div class="text-[11px] text-slate-400">※ 이 오른쪽 카드도 클릭하면 슬롯 모달이 열립니다.</div>
                </div>
                <span class="slot-badge size">BTN</span>
                <span class="slot-badge store hidden"></span>
            </div>

        </div>
    </section>

    <!-- =========================
       ⑮ 고객지원 3칸
  ========================== -->
    <section class="max-w-7xl mx-auto px-4 sm:px-6 py-10 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        <div id="slot_index_support_review"
            class="slot-banner rounded-lg overflow-hidden bg-gray-100 min-h-28 sm:min-h-40"
            data-position="index_support_review" data-label="리뷰/후기" data-size="권장 16:9">
            <img class="slot-img hidden" alt="리뷰/후기">
            <div class="slot-default">
                <span class="text-lg font-bold">리뷰/후기</span>
            </div>
            <span class="slot-badge size">16:9</span>
            <span class="slot-badge store hidden"></span>
        </div>

        <div id="slot_index_support_empty"
            class="slot-banner rounded-lg overflow-hidden bg-gray-100 min-h-28 sm:min-h-40"
            data-position="index_support_empty" data-label="고객지원 중앙" data-size="자유">
            <img class="slot-img hidden" alt="중앙 박스">
            <div class="slot-default">
                <span class="text-sm text-gray-500">중앙 지원 박스</span>
            </div>
            <span class="slot-badge size">FREE</span>
            <span class="slot-badge store hidden"></span>
        </div>

        <div id="slot_index_support_inquiry"
            class="slot-banner rounded-lg overflow-hidden bg-gray-100 min-h-28 sm:min-h-40"
            data-position="index_support_inquiry" data-label="문의게시판" data-size="권장 16:9">
            <img class="slot-img hidden" alt="문의게시판">
            <div class="slot-default flex-col">
                <span class="text-lg font-bold">문의게시판</span>
                <span class="text-xs text-gray-500 mt-1">클릭하여 설정</span>
            </div>
            <span class="slot-badge size">16:9</span>
            <span class="slot-badge store hidden"></span>
        </div>
    </section>

    <!-- =========================
       툴팁
  ========================== -->
    <div id="hoverTip"></div>

    <!-- =========================
       ✅ 공통 모달 (구조 정상화 완료)
  ========================== -->
    <div id="modalRoot" class="hidden" data-ad-modal="1" data-page="" data-position="">
        <div class="modal-backdrop"></div>

        <div class="modal-panel">
            <div class="modal-card">

                <!-- 헤더 -->
                <div class="p-6 sticky top-0 bg-white/90 backdrop-blur border-b border-slate-100 z-10">
                    <div class="flex items-start justify-between gap-4">
                        <div>
                            <h3 id="modalTitle" class="text-xl sm:text-2xl font-extrabold">슬롯 수정</h3>
                            <p class="text-xs text-gray-500 mt-1">
                                page: <b>index</b> /
                                position: <span id="modalPositionText" class="font-semibold"></span>
                            </p>
                        </div>

                        <div class="flex items-center gap-2">
                            <!-- ✅ 사용법 버튼 -->
                            <div class="relative">
                                <button type="button" id="adHelpBtn"
                                    class="inline-flex items-center gap-2 rounded-xl border border-blue-200 bg-white/80 px-3 py-1.5 text-sm font-semibold text-blue-700 shadow-sm hover:bg-white"
                                    aria-expanded="false" aria-controls="adHelpPopover" title="사용법 보기">
                                    <span
                                        class="inline-flex h-5 w-5 items-center justify-center rounded-full bg-blue-600 text-white text-xs leading-none">?</span>
                                    사용법
                                </button>

                                <div id="adHelpPopover"
                                    class="hidden absolute right-0 mt-2 w-[min(420px,calc(100vw-2rem))] rounded-2xl border border-blue-200 bg-white/95 p-4 shadow-xl backdrop-blur">
                                    <div class="flex items-start justify-between gap-3">
                                        <div class="font-extrabold text-slate-800">✅ 사용 흐름</div>
                                        <button type="button" id="adHelpCloseBtn"
                                            class="rounded-lg px-2 py-1 text-xs font-bold text-slate-500 hover:bg-slate-100">닫기</button>
                                    </div>

                                    <ol class="mt-3 space-y-2 text-sm text-slate-700 leading-relaxed list-decimal pl-5">
                                        <li><b>/admin/indexmanager.html</b> 접속</li>
                                        <li>원하는 슬롯 클릭 → <b>모달 열림</b></li>
                                        <li>모달 상단에서 <b>우선순위 1</b> 선택 → 내용/이미지/기간 입력 → <b>저장</b></li>
                                        <li>다시 같은 슬롯 클릭 → 모달 열기</li>
                                        <li>이번엔 <b>우선순위 2</b> 선택 → 입력 → <b>저장</b></li>
                                        <li><b>우선순위 3</b>도 동일</li>
                                    </ol>

                                    <div class="mt-3 rounded-xl bg-blue-50 px-3 py-2 text-xs text-blue-900">
                                        ※ 실제 노출은 “기간 조건이 맞는 후보들 중 우선순위 숫자가 가장 작은 것(1)”이 선택됩니다.
                                    </div>

                                    <div class="mt-2 rounded-xl bg-slate-50 px-3 py-2 text-xs text-slate-600">
                                        ※ 서버에 우선순위(후보) API가 없으면, 우선순위 기능은 자동으로 비활성화됩니다.
                                    </div>
                                </div>
                            </div>

                            <button id="btnCloseModal"
                                class="px-3 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-slate-700 text-sm">
                                닫기
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 본문 -->
                <div class="p-6 space-y-6">

                    <!-- ✅ 텍스트 전용 안내 -->
                    <div id="textOnlyHint" class="hidden rounded-2xl border border-slate-100 bg-slate-50 p-4">
                        <div class="text-sm font-bold text-slate-800">📝 이 슬롯은 텍스트 전용입니다.</div>
                        <div class="mt-1 text-xs text-slate-500">
                            이미지/가게연결/링크 입력은 숨김 처리됩니다. (글만 작성)
                        </div>
                    </div>

                    <!-- ✅ 모드 선택 (텍스트 전용일 때 숨김) -->
                    <div id="modeBlock" class="rounded-xl border border-slate-100 bg-slate-50 p-4">
                        <p class="text-sm font-semibold mb-3">광고 방식 선택</p>
                        <div class="flex flex-wrap gap-4">
                            <label class="flex items-center gap-2 text-sm">
                                <input type="radio" name="slotMode" value="image" class="accent-blue-600" checked>
                                <span>이미지 입력</span>
                            </label>
                            <label class="flex items-center gap-2 text-sm">
                                <input type="radio" name="slotMode" value="store" class="accent-emerald-600">
                                <span>가게 연결</span>
                            </label>
                            <label class="flex items-center gap-2 text-sm">
                                <input type="radio" name="slotMode" value="text" class="accent-indigo-600">
                                <span>텍스트 입력</span>
                            </label>
                        </div>
                    </div>

                    <!-- ✅ 텍스트 블록 -->
                    <div id="textBlock" class="hidden space-y-2">
                        <label class="text-sm font-semibold">내용 (텍스트)</label>
                        <textarea id="fieldTextContent" class="field mt-2 min-h-[180px] resize-y"
                            placeholder="예) 한 줄당 1개씩 입력&#10;첫번째 줄&#10;두번째 줄&#10;세번째 줄"></textarea>
                        <p class="text-xs text-gray-500">
                            줄바꿈(Enter) 기준으로 표시될 수 있습니다.
                        </p>
                    </div>

                    <!-- ✅ 공통 링크 (텍스트 전용일 때 숨김) -->
                    <div id="linkBlock">
                        <label class="text-sm font-semibold">링크 URL (선택)</label>
                        <input id="fieldLinkUrl" class="field mt-2"
                            placeholder="/ndetail.html?id=123&type=store or https://..." />
                    </div>

                    <div id="dividerAfterLink" class="divider"></div>

                    <!-- 이미지 블록 -->
                    <div id="imageBlock" class="space-y-4">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm font-semibold">이미지 파일</label>
                                <input id="fieldImageFile" type="file" accept="image/*" class="field mt-2 bg-white" />
                                <p class="text-xs text-gray-500 mt-1">
                                    슬롯 비율에 맞게 자동 크롭됩니다.
                                </p>
                            </div>
                            <div>
                                <label class="text-sm font-semibold">현재 이미지 미리보기</label>
                                <div
                                    class="mt-2 rounded-lg border border-gray-100 bg-gray-50 overflow-hidden aspect-[16/9] flex items-center justify-center">
                                    <img id="currentPreviewImg" src="" alt="preview"
                                        class="w-full h-full object-cover hidden" />
                                    <span id="currentPreviewEmpty" class="text-xs text-gray-400">이미지 없음</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 가게 연결 블록 -->
                    <div id="storeBlock" class="space-y-4 hidden">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm font-semibold">사업자번호</label>
                                <input id="fieldBizNo" class="field mt-2" placeholder="예) 2910802895" />
                            </div>
                            <div>
                                <label class="text-sm font-semibold">상호명</label>
                                <input id="fieldBizName" class="field mt-2" placeholder="예) 미례헤어" />
                            </div>
                        </div>

                        <div class="flex items-center gap-2">
                            <button id="btnSearchStore"
                                class="px-4 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white text-sm">
                                가게 검색
                            </button>
                            <span id="storeSearchHint" class="text-xs text-gray-500"></span>
                        </div>

                        <div id="storeResults" class="border border-slate-100 rounded-xl overflow-hidden">
                            <div class="px-4 py-3 bg-slate-50 text-sm font-semibold">
                                검색 결과
                            </div>
                            <div id="storeResultsBody" class="p-4 text-sm text-gray-500">
                                검색어를 입력하고 “가게 검색”을 눌러주세요.
                            </div>
                        </div>

                        <input id="fieldStoreId" type="hidden" />
                        <input id="fieldStoreType" type="hidden" name="storeType" value="" />
                    </div>

                    <div class="divider"></div>

                    <!-- ✅ 우선순위 -->
                    <div class="mt-4 p-3 rounded-xl border border-blue-100 bg-white/70">
                        <div class="flex flex-col md:flex-row md:items-end gap-3">
                            <div class="flex-1">
                                <label class="text-sm font-semibold text-gray-700">우선순위</label>
                                <input name="priority" id="adPriority" type="number" min="1" step="1" value="1"
                                    class="mt-1 w-full rounded-xl border border-gray-200 px-3 py-2 outline-none focus:ring-2 focus:ring-blue-300" />
                                <p class="mt-1 text-xs text-gray-500">1이 가장 먼저 노출됩니다. (1,2,3… 여러 개 등록 가능)</p>
                            </div>

                            <button type="button" id="btnLoadPriority"
                                class="rounded-xl px-4 py-2 border border-blue-200 bg-blue-50 hover:bg-blue-100">
                                이 우선순위 불러오기
                            </button>

                            <button type="button" id="btnDeletePriority"
                                class="rounded-xl px-4 py-2 border border-red-200 bg-red-50 hover:bg-red-100">
                                이 우선순위 삭제
                            </button>
                        </div>

                        <details class="mt-3">
                            <summary class="cursor-pointer text-sm text-gray-700">후보 목록 보기</summary>
                            <div id="candidateList" class="mt-2 grid gap-2"></div>
                        </details>

                        <div id="prioritySupportHint" class="mt-3 text-xs text-slate-500"></div>
                    </div>

                    <!-- 기간 -->
                    <div class="rounded-xl border border-slate-100 p-4">
                        <div class="flex items-center justify-between">
                            <p class="text-sm font-semibold">광고 기간 설정</p>
                            <label class="flex items-center gap-2 text-xs">
                                <input id="fieldNoEnd" type="checkbox" class="accent-blue-600">
                                <span class="text-gray-700">계속 유지 (종료 없음)</span>
                            </label>
                        </div>

                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4">
                            <div>
                                <label class="text-xs font-semibold text-gray-600">시작 일시</label>
                                <input id="fieldStartAt" type="datetime-local" class="field mt-2" />
                            </div>
                            <div>
                                <label class="text-xs font-semibold text-gray-600">종료 일시</label>
                                <input id="fieldEndAt" type="datetime-local" class="field mt-2" />
                            </div>
                        </div>
                    </div>

                    <!-- 요약 표시 -->
                    <div class="rounded-xl border border-slate-100 bg-slate-50 p-4">
                        <p class="text-sm font-semibold mb-2">현재 선택 정보</p>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm">
                            <div class="flex items-center gap-2">
                                <span class="text-gray-500">선택 이미지:</span>
                                <span id="textSelectedImage" class="font-semibold text-slate-800">없음</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-gray-500">연결 가게:</span>
                                <span id="textSelectedStore" class="font-semibold text-slate-800">없음</span>
                            </div>
                        </div>

                        <div class="mt-2 text-xs text-slate-500">
                            텍스트 전용 슬롯은 “선택 이미지/연결 가게”가 표시되지 않습니다.
                        </div>
                    </div>

                    <!-- 저장 버튼 -->
                    <div class="flex flex-col sm:flex-row gap-2 sm:justify-end">
                        <button id="btnResetModal"
                            class="px-4 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-slate-700 text-sm">
                            입력 초기화
                        </button>
                        <button id="btnSaveSlot"
                            class="px-5 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold">
                            슬롯 저장
                        </button>
                    </div>

                </div><!-- /p-6 -->
            </div><!-- /modal-card -->
        </div><!-- /modal-panel -->
    </div><!-- /modalRoot -->

    <script>
        (() => {
            /* ============================================================
               ✅ 기본 상수
            ============================================================ */
            const PAGE = "index";
            const BEST_PICK_MAX = 18;

            /* ============================================================
               ✅ 유틸
            ============================================================ */
            function qs(sel, root = document) { return root.querySelector(sel); }
            function qsa(sel, root = document) { return Array.from(root.querySelectorAll(sel)); }

            function escapeHtml(str) {
                return String(str ?? "").replace(/[&<>"']/g, (m) => ({
                    "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
                }[m]));
            }

            function toAbs(u) {
                if (!u) return "";
                if (/^https?:\/\//i.test(u)) return u;
                return u.startsWith("/") ? u : ("/" + u);
            }

            function withBust(u) {
                if (!u) return "";
                const sep = u.includes("?") ? "&" : "?";
                return `${u}${sep}v=${Date.now()}`;
            }

            function safeSetImage(imgEl, rawUrl, defEl) {
                if (!imgEl) return;

                const url = rawUrl ? withBust(toAbs(rawUrl)) : "";

                const show = () => {
                    imgEl.classList.remove("hidden");
                    if (defEl) defEl.classList.add("hidden");
                };

                const hide = () => {
                    imgEl.classList.add("hidden");
                    imgEl.removeAttribute("src");
                    if (defEl) defEl.classList.remove("hidden");
                };

                imgEl.onload = null;
                imgEl.onerror = null;
                imgEl.classList.add("hidden");
                imgEl.removeAttribute("src");
                if (defEl) defEl.classList.remove("hidden");

                if (!url) return;

                imgEl.onload = () => show();
                imgEl.onerror = () => hide();
                imgEl.src = url;

                if (imgEl.complete) {
                    if (imgEl.naturalWidth > 0) show();
                    else hide();
                }
            }

            function pickOk(json) { return !!(json?.ok || json?.success); }
            function pickSlot(json) { return json?.slot || json?.data || json?.ad || null; }

            function normalizeDateTimeForInput(value) {
                if (!value) return "";
                try {
                    if (typeof value === "string" && value.includes("T") && value.length >= 16) {
                        return value.slice(0, 16);
                    }
                    const d = new Date(value);
                    if (isNaN(d.getTime())) return "";
                    const off = d.getTimezoneOffset();
                    const local = new Date(d.getTime() - off * 60000);
                    return local.toISOString().slice(0, 16);
                } catch {
                    return "";
                }
            }

            async function fetchJson(url, opts = {}) {
                const res = await fetch(url, { cache: "no-store", ...opts });
                const json = await res.json().catch(() => ({}));
                return { res, json };
            }

            /* ============================================================
               ✅ Best Pick 슬롯 생성
            ============================================================ */
            function buildBestPickGrid() {
                const host = document.getElementById("best_pick_grid");
                if (!host) return;

                const frag = document.createDocumentFragment();

                for (let i = 1; i <= BEST_PICK_MAX; i++) {
                    const wrap = document.createElement("div");
                    wrap.innerHTML = `
          <div id="slot_best_pick_${i}"
            class="neo-card slot-banner best-circle aspect-square w-full flex items-center justify-center"
            data-position="best_pick_${i}"
            data-label="Best Pick ${i}"
            data-size="권장 1:1">
            <img class="slot-img hidden" alt="Best Pick ${i}">
            <div class="slot-default flex-col">
              <span class="font-bold text-sm">Best Pick ${i}</span>
              <span class="text-[10px] text-gray-500 mt-1">클릭하여 설정</span>
            </div>
            <span class="slot-badge size">1:1</span>
            <span class="slot-badge store hidden"></span>
          </div>
        `.trim();
                    frag.appendChild(wrap.firstElementChild);
                }

                const nodes = Array.from(frag.childNodes);
                host.replaceWith(...nodes);
            }

            /* ============================================================
               ✅ 슬롯 목록 수집
            ============================================================ */
            function getAllSlotElements() {
                const baseIds = [
                    "slot_index_main_top",
                    "slot_index_main_visual",
                    "slot_index_promo_1",
                    "slot_index_promo_2",
                    "slot_index_promo_3",

                    "slot_index_sub_keywords",
                    "slot_index_sub_news",
                    "slot_index_sub_events",
                    "slot_index_sub_recommends",

                    "slot_index_oneword",

                    "slot_index_food_delivery",
                    "slot_index_all_stores",
                    "slot_index_hot_place",
                    "slot_index_suggest",
                    "slot_index_open",
                    "slot_index_store_pride",
                    "slot_index_traditional",
                    "slot_index_performing",
                    "slot_index_event",
                    "slot_index_localboard",
                    "slot_index_season",
                    "slot_index_join",

                    "slot_index_d2c_banner",
                    "slot_index_d2c_shop",

                    "slot_index_support_review",
                    "slot_index_support_empty",
                    "slot_index_support_inquiry",
                ];

                const bestIds = [];
                for (let i = 1; i <= BEST_PICK_MAX; i++) bestIds.push(`slot_best_pick_${i}`);

                return [...baseIds, ...bestIds]
                    .map(id => document.getElementById(id))
                    .filter(Boolean);
            }

            /* ============================================================
               ✅ 서버 통신
            ============================================================ */
            async function fetchSlot(position, priority = null) {
                let url = `/manager/ad/slot?page=${encodeURIComponent(PAGE)}&position=${encodeURIComponent(position)}`;
                if (priority !== null && priority !== undefined && priority !== "") {
                    url += `&priority=${encodeURIComponent(priority)}`;
                }
                const { res, json } = await fetchJson(url);
                if (!res.ok || !pickOk(json)) return null;
                return pickSlot(json);
            }

            async function fetchCandidates(position) {
                const url = `/manager/ad/slot-items?page=${encodeURIComponent(PAGE)}&position=${encodeURIComponent(position)}`;
                const { res, json } = await fetchJson(url);
                if (!res.ok || !json?.success || !Array.isArray(json.items)) {
                    return { ok: false, items: [], status: res.status };
                }
                return { ok: true, items: json.items, status: res.status };
            }

            function renderTextPreview(defEl, rawText) {
                if (!defEl) return;
                const text = (rawText ?? "").toString().trim();
                const lines = text ? text.split(/\r?\n/).map(s => s.trim()).filter(Boolean) : [];
                const previewLines = lines.slice(0, 6);
                const more = lines.length > 6 ? `\n… (+${lines.length - 6}줄)` : "";
                const finalText = (previewLines.join("\n") + more) || "내용 없음";

                defEl.innerHTML = `
        <div class="w-full p-3 text-left">
          <div class="text-[11px] font-extrabold text-slate-600 mb-1">텍스트</div>
          <div class="text-[12px] leading-relaxed text-slate-900 whitespace-pre-line">
            ${escapeHtml(finalText)}
          </div>
        </div>
      `;
            }

            function renderTextBox(slotEl, text) {
                const body = slotEl.querySelector(".slot-text-body");
                const hint = slotEl.querySelector(".slot-hint");
                const t = (text || "").trim();

                if (body) body.textContent = t;
                if (hint) hint.classList.toggle("hidden", !!t);
            }

            /* ============================================================
               ✅ 박스에 적용 (모드별 미리보기)
               - 이제 "텍스트 전용 슬롯" 개념 없음
               - slot_type === "text" 인 경우만 텍스트 렌더
            ============================================================ */
            function applySlotToBox(box, slot) {
                const img = qs(".slot-img", box);
                const def = qs(".slot-default", box);
                const storeBadge = qs(".slot-badge.store", box);

                const slotType = slot?.slot_type || slot?.slotType || "";
                const textContent = slot?.text_content || slot?.textContent || "";

                const isTextSlot = (slotType === "text");

                // 텍스트 슬롯이면 텍스트만 렌더(이미지/가게 뱃지 숨김)
                if (isTextSlot) {
                    if (img) {
                        img.classList.add("hidden");
                        img.removeAttribute("src");
                    }
                    if (def) {
                        def.classList.remove("hidden");
                        renderTextPreview(def, textContent);
                    }
                    if (storeBadge) {
                        storeBadge.classList.add("hidden");
                        storeBadge.textContent = "";
                    }
                    renderTextBox(box, textContent);
                    return;
                }

                // 일반(이미지/가게) 슬롯
                const imageUrl =
                    slot?.image_url ||
                    slot?.image ||
                    slot?.img_url ||
                    slot?.banner_url ||
                    slot?.image_path ||
                    "";

                const mode = slot?.slot_mode || slot?.slotMode || ""; // "image" | "store" | "custom"
                const businessName = slot?.business_name || slot?.businessName || "";
                const businessNo = slot?.business_no || slot?.businessNo || "";

                safeSetImage(img, imageUrl, def);

                if (storeBadge) {
                    if (mode === "store" && (businessName || businessNo)) {
                        storeBadge.textContent = businessName ? businessName : businessNo;
                        storeBadge.classList.remove("hidden");
                    } else {
                        storeBadge.classList.add("hidden");
                        storeBadge.textContent = "";
                    }
                }

                // 텍스트 박스(있는 슬롯만) 비워두기
                renderTextBox(box, "");
            }

            async function loadAllSlotsPreview() {
                const boxes = getAllSlotElements();
                await Promise.all(boxes.map(async (box) => {
                    const position = box.dataset.position;
                    if (!position) return;
                    try {
                        const slotP1 = await fetchSlot(position, 1);
                        const slot = slotP1 || await fetchSlot(position);
                        if (slot) applySlotToBox(box, slot);
                    } catch (e) {
                        console.warn("slot preview fail:", position, e);
                    }
                }));
            }

            /* ============================================================
               ✅ 커서 툴팁
            ============================================================ */
            const hoverTip = document.getElementById("hoverTip");
            function bindHoverTooltip(box) {
                const label = box.dataset.label || box.dataset.position || "슬롯";
                box.addEventListener("mouseenter", () => {
                    if (!hoverTip) return;
                    hoverTip.textContent = label;
                    hoverTip.classList.add("show");
                });
                box.addEventListener("mousemove", (e) => {
                    if (!hoverTip) return;
                    hoverTip.style.left = e.clientX + "px";
                    hoverTip.style.top = e.clientY + "px";
                });
                box.addEventListener("mouseleave", () => {
                    if (!hoverTip) return;
                    hoverTip.classList.remove("show");
                });
            }

            /* ============================================================
               ✅ 모달 엘리먼트
            ============================================================ */
            const modalRoot = qs("#modalRoot");
            const modalTitle = qs("#modalTitle");
            const modalPositionText = qs("#modalPositionText");
            const btnCloseModal = qs("#btnCloseModal");
            const btnSaveSlot = qs("#btnSaveSlot");
            const btnResetModal = qs("#btnResetModal");

            const textOnlyHint = qs("#textOnlyHint");

            const modeBlock = qs("#modeBlock");
            const imageBlock = qs("#imageBlock");
            const storeBlock = qs("#storeBlock");

            const textBlock = qs("#textBlock");
            const fieldTextContent = qs("#fieldTextContent");

            const linkBlock = qs("#linkBlock");
            const dividerAfterLink = qs("#dividerAfterLink");

            const fieldLinkUrl = qs("#fieldLinkUrl");
            const fieldImageFile = qs("#fieldImageFile");
            const currentPreviewImg = qs("#currentPreviewImg");
            const currentPreviewEmpty = qs("#currentPreviewEmpty");

            const fieldBizNo = qs("#fieldBizNo");
            const fieldBizName = qs("#fieldBizName");
            const fieldStoreId = qs("#fieldStoreId");
            const btnSearchStore = qs("#btnSearchStore");
            const storeResultsBody = qs("#storeResultsBody");
            const storeSearchHint = qs("#storeSearchHint");

            const fieldNoEnd = qs("#fieldNoEnd");
            const fieldStartAt = qs("#fieldStartAt");
            const fieldEndAt = qs("#fieldEndAt");

            const textSelectedImage = qs("#textSelectedImage");
            const textSelectedStore = qs("#textSelectedStore");

            const adPriority = qs("#adPriority");
            const btnLoadPriority = qs("#btnLoadPriority");
            const btnDeletePriority = qs("#btnDeletePriority");
            const candidateList = qs("#candidateList");

            const radioModes = () => qsa('input[name="slotMode"]');

            let activeBox = null;
            let activePosition = "";
            let activeLabel = "";
            let lastLoadedSlot = null;

            let __localPreviewUrl = null;

            function openModal() {
                modalRoot.classList.remove("hidden");
            }

            function closeModal() {
                modalRoot.classList.add("hidden");
                activeBox = null;
                activePosition = "";
                activeLabel = "";
                lastLoadedSlot = null;
                window.__closeAdHelp?.();
            }

            function setModeUI(mode) {
                if (mode === "store") {
                    storeBlock?.classList.remove("hidden");
                    imageBlock?.classList.add("hidden");
                    textBlock?.classList.add("hidden");
                } else if (mode === "text") {
                    textBlock?.classList.remove("hidden");
                    imageBlock?.classList.add("hidden");
                    storeBlock?.classList.add("hidden");
                } else {
                    imageBlock?.classList.remove("hidden");
                    storeBlock?.classList.add("hidden");
                    textBlock?.classList.add("hidden");
                }
            }

            function getSelectedMode() {
                const r = radioModes().find(x => x.checked);
                return r ? r.value : "image";
            }

            function setSelectedMode(mode) {
                radioModes().forEach(r => r.checked = (r.value === mode));
                setModeUI(mode);
            }

            // ✅ 이제 전부 3모드 선택 가능 (텍스트 전용 없음)
            function setModalTypeForPosition(_position) {
                textOnlyHint?.classList.add("hidden");

                modeBlock?.classList.remove("hidden");
                linkBlock?.classList.remove("hidden");
                dividerAfterLink?.classList.remove("hidden");

                setModeUI(getSelectedMode());
                return false;
            }

            function applyNoEndState() {
                const checked = fieldNoEnd.checked;
                fieldEndAt.disabled = checked;
                if (checked) fieldEndAt.value = "";
            }

            function updateSelectedSummary() {
                const mode = getSelectedMode();

                if (mode === "text") {
                    textSelectedImage.textContent = "텍스트";
                    textSelectedStore.textContent = "사용 안함";
                    return;
                }

                const file = fieldImageFile?.files?.[0];
                textSelectedImage.textContent = file ? file.name : (lastLoadedSlot?.image_url ? "기존 이미지 사용" : "없음");

                const bn = fieldBizName.value?.trim();
                const bno = fieldBizNo.value?.trim();
                if (bn) textSelectedStore.textContent = bn;
                else if (bno) textSelectedStore.textContent = bno;
                else textSelectedStore.textContent = lastLoadedSlot?.business_name || "없음";
            }

            function showLocalPreview(file) {
                if (__localPreviewUrl) {
                    URL.revokeObjectURL(__localPreviewUrl);
                    __localPreviewUrl = null;
                }
                if (!file || !currentPreviewImg) return;

                __localPreviewUrl = URL.createObjectURL(file);
                currentPreviewImg.src = __localPreviewUrl;
                currentPreviewImg.classList.remove("hidden");
                currentPreviewEmpty?.classList.add("hidden");
            }

            function resetModalFields(keepMode = true) {
                if (!keepMode) setSelectedMode("image");

                if (fieldLinkUrl) fieldLinkUrl.value = "";

                if (__localPreviewUrl) {
                    URL.revokeObjectURL(__localPreviewUrl);
                    __localPreviewUrl = null;
                }

                if (fieldImageFile) fieldImageFile.value = "";
                if (currentPreviewImg) {
                    currentPreviewImg.classList.add("hidden");
                    currentPreviewImg.removeAttribute("src");
                }
                if (currentPreviewEmpty) currentPreviewEmpty.classList.remove("hidden");

                if (fieldBizNo) fieldBizNo.value = "";
                if (fieldBizName) fieldBizName.value = "";
                if (fieldStoreId) fieldStoreId.value = "";
                if (storeResultsBody) storeResultsBody.innerHTML = `<div class="text-sm text-gray-500">검색어를 입력하고 “가게 검색”을 눌러주세요.</div>`;
                if (fieldStoreType) fieldStoreType.value = "";
                if (storeSearchHint) storeSearchHint.textContent = "";

                if (fieldStartAt) fieldStartAt.value = "";
                if (fieldEndAt) fieldEndAt.value = "";
                if (fieldNoEnd) fieldNoEnd.checked = false;
                if (fieldEndAt) fieldEndAt.disabled = false;

                if (fieldTextContent) fieldTextContent.value = "";

                if (textSelectedImage) textSelectedImage.textContent = "없음";
                if (textSelectedStore) textSelectedStore.textContent = "없음";
            }

            function fillModalFromSlot(slot) {
                lastLoadedSlot = slot || null;

                if (adPriority) adPriority.value = String(slot?.priority ?? adPriority.value ?? 1);

                const slotType = slot?.slot_type || slot?.slotType || "";
                const modeFromServer = slot?.slot_mode || slot?.slotMode || "image";

                // 텍스트는 항상 채워둠(모드 전환시 바로 보이게)
                if (fieldTextContent) {
                    fieldTextContent.value = (slot?.text_content ?? slot?.textContent ?? slot?.content ?? "") || "";
                }

                if (slotType === "text") setSelectedMode("text");
                else setSelectedMode(modeFromServer === "store" ? "store" : "image");

                const link = slot?.link_url || slot?.linkUrl || slot?.link || slot?.href || "";
                if (fieldLinkUrl) fieldLinkUrl.value = link || "";

                const businessName = slot?.business_name || slot?.businessName || "";
                const businessNo = slot?.business_no || slot?.businessNo || "";
                const storeId = slot?.store_id || slot?.storeId || "";

                if (fieldBizName) fieldBizName.value = businessName || "";
                if (fieldBizNo) fieldBizNo.value = businessNo || "";
                if (fieldStoreId) fieldStoreId.value = storeId ? String(storeId) : "";

                const start = slot?.start_at || slot?.startAt || slot?.start_date || slot?.startDate || "";
                const end = slot?.end_at || slot?.endAt || slot?.end_date || slot?.endDate || "";

                if (fieldStartAt) fieldStartAt.value = normalizeDateTimeForInput(start);
                if (fieldEndAt) fieldEndAt.value = normalizeDateTimeForInput(end);

                const noEnd = !!slot?.no_end || (!fieldEndAt?.value);
                if (fieldNoEnd) fieldNoEnd.checked = noEnd;
                applyNoEndState();

                const imageUrl =
                    slot?.image_url ||
                    slot?.image ||
                    slot?.img_url ||
                    slot?.banner_url ||
                    slot?.image_path ||
                    "";

                if (imageUrl && currentPreviewImg) {
                    safeSetImage(currentPreviewImg, imageUrl, currentPreviewEmpty);
                } else {
                    currentPreviewImg?.classList.add("hidden");
                    currentPreviewImg?.removeAttribute("src");
                    currentPreviewEmpty?.classList.remove("hidden");
                }

                setModalTypeForPosition(activePosition);
                updateSelectedSummary();
            }

            async function refreshCandidates() {
                if (!candidateList) return;
                candidateList.innerHTML = `<div class="text-sm text-gray-500">불러오는 중...</div>`;

                const { ok, items, status } = await fetchCandidates(activePosition);

                if (!ok) {
                    if (status === 404) {
                        candidateList.innerHTML = `<div class="text-sm text-gray-500">후보 목록 API(/manager/ad/slot-items)가 아직 없습니다.</div>`;
                    } else {
                        candidateList.innerHTML = `<div class="text-sm text-gray-500">후보 목록을 불러오지 못했습니다.</div>`;
                    }
                    return;
                }

                if (items.length === 0) {
                    candidateList.innerHTML = `<div class="text-sm text-gray-500">등록된 후보가 없습니다.</div>`;
                    return;
                }

                candidateList.innerHTML = "";
                for (const it of items) {
                    const pr = it.priority ?? "-";
                    const isText = (it.slot_type === "text");

                    const imgHtml = it.image_url
                        ? `<img src="${escapeHtml(toAbs(it.image_url))}" class="w-12 h-12 rounded-lg object-cover border" />`
                        : `<div class="w-12 h-12 rounded-lg bg-gray-100 border"></div>`;

                    const txt = (it.text_content || "").trim();
                    const txtPreview = txt ? txt.split(/\r?\n/).slice(0, 2).join(" / ") : "";

                    const mainLine = isText
                        ? (txtPreview || "(텍스트 없음)")
                        : (it.business_name || it.link_url || "(내용 없음)");

                    const periodLine = (it.start_at_local || it.end_at_local || it.no_end)
                        ? `기간: ${it.start_at_local || "-"} ~ ${it.no_end ? "무기한" : (it.end_at_local || "-")}`
                        : "기간 미설정";

                    const row = document.createElement("button");
                    row.type = "button";
                    row.className = "w-full text-left p-3 rounded-xl border border-gray-200 bg-white hover:bg-gray-50 flex gap-3 items-center";
                    row.innerHTML = `
          ${isText ? `<div class="w-12 h-12 rounded-lg bg-blue-50 border border-blue-100 flex items-center justify-center text-xs font-bold text-blue-700">TXT</div>` : imgHtml}
          <div class="flex-1">
            <div class="text-sm font-semibold text-gray-800">우선순위 ${pr}</div>
            <div class="text-xs text-gray-600">${escapeHtml(mainLine)}</div>
            <div class="text-xs text-gray-500 mt-1">${escapeHtml(periodLine)}</div>
          </div>
        `;
                    row.addEventListener("click", async () => {
                        const p = it.priority ?? 1;
                        if (adPriority) adPriority.value = String(p);
                        const slot = await fetchSlot(activePosition, p);
                        if (slot) fillModalFromSlot(slot);
                    });

                    candidateList.appendChild(row);
                }
            }

            async function searchStores() {
                const bizNo = (fieldBizNo?.value || "").trim();
                const name = (fieldBizName?.value || "").trim();

                if (!bizNo && !name) {
                    if (storeSearchHint) {
                        storeSearchHint.textContent = "사업자번호 또는 상호명을 입력해주세요.";
                        storeSearchHint.className = "text-xs text-red-500";
                    }
                    return;
                }

                if (storeSearchHint) {
                    storeSearchHint.textContent = "검색 중...";
                    storeSearchHint.className = "text-xs text-gray-500";
                }

                const params = new URLSearchParams();
                if (bizNo) params.set("bizNo", bizNo);
                if (name) { params.set("name", name); params.set("businessName", name); }

                try {
                    const { res, json } = await fetchJson(`/manager/ad/store/search?${params.toString()}`);
                    const stores = json?.stores || json?.data || json?.results || [];

                    if (!res.ok || !Array.isArray(stores) || stores.length === 0) {
                        if (storeResultsBody) storeResultsBody.innerHTML = `<div class="text-sm text-gray-500">검색 결과가 없습니다.</div>`;
                        if (storeSearchHint) {
                            storeSearchHint.textContent = "검색 결과 없음";
                            storeSearchHint.className = "text-xs text-gray-500";
                        }
                        return;
                    }

                    if (storeSearchHint) {
                        storeSearchHint.textContent = `${stores.length}건 검색됨`;
                        storeSearchHint.className = "text-xs text-emerald-600";
                    }

                    if (storeResultsBody) {
                        storeResultsBody.innerHTML = `
            <div class="space-y-2">
              ${stores.map((s, idx) => {
                            const id = s.id ?? s.store_id ?? "";
                            const bn = s.business_name ?? s.name ?? s.store_name ?? "";
                            const bno = s.business_no ?? s.biz_no ?? s.bizNo ?? "";
                            const cat = s.business_category ?? s.category ?? s.store_category ?? "";
                            return `
                  <button class="w-full text-left px-3 py-3 rounded-lg border border-slate-100 hover:border-emerald-200 hover:bg-emerald-50 transition"
                    data-store-idx="${idx}">
                    <div class="flex items-center justify-between gap-2">
                      <div class="font-semibold text-slate-800">${escapeHtml(bn || "(상호명 없음)")}</div>
                      <div class="text-[10px] text-slate-500">ID: ${escapeHtml(id || "-")}</div>
                    </div>
                    <div class="mt-1 text-xs text-slate-500">
                      <span class="mr-2">사업자번호: <b>${escapeHtml(bno || "-")}</b></span>
                      <span>업종: ${escapeHtml(cat || "-")}</span>
                    </div>
                  </button>
                `;
                        }).join("")}
            </div>
          `;

                        qsa("button[data-store-idx]", storeResultsBody).forEach(btn => {
                            btn.addEventListener("click", () => {
                                const idx = Number(btn.dataset.storeIdx);
                                const s = stores[idx];
                                if (!s) return;

                                const id = s.id ?? s.store_id ?? "";
                                const st = s.store_type ?? s.detail_type ?? s.type ?? s.storeType ?? "";
                                const bn = s.business_name ?? s.name ?? s.store_name ?? "";
                                const bno = s.business_no ?? s.biz_no ?? s.bizNo ?? "";

                                const fieldStoreType = qs("#fieldStoreType");
                                if (fieldStoreId) fieldStoreId.value = id ? String(id) : "";
                                if (fieldStoreType) fieldStoreType.value = st || "";
                                if (fieldBizName) fieldBizName.value = bn || "";
                                if (fieldBizNo) fieldBizNo.value = bno || "";

                                if (fieldLinkUrl && !fieldLinkUrl.value.trim() && id) {
                                    fieldLinkUrl.value = `/ndetail.html?id=${id}&type=store`;
                                }

                                updateSelectedSummary();
                            });
                        });
                    }
                } catch (e) {
                    if (storeResultsBody) storeResultsBody.innerHTML = `<div class="text-sm text-red-500">검색 중 오류가 발생했습니다.</div>`;
                    if (storeSearchHint) {
                        storeSearchHint.textContent = "검색 실패";
                        storeSearchHint.className = "text-xs text-red-500";
                    }
                }
            }

            async function saveSlot() {
                if (!activePosition) return;

                const mode = getSelectedMode(); // image | store | text

                const linkUrl = (fieldLinkUrl?.value || "").trim();

                const storeId = (fieldStoreId?.value || "").trim();
                const businessNo = (fieldBizNo?.value || "").trim();
                const businessName = (fieldBizName?.value || "").trim();

                const startAt = fieldStartAt?.value || "";
                const endAt = fieldNoEnd?.checked ? "" : (fieldEndAt?.value || "");

                const priority = Number(adPriority?.value || 1) || 1;

                const fd = new FormData();
                fd.append("page", PAGE);
                fd.append("position", activePosition);
                fd.append("priority", String(priority));

                const txt = (fieldTextContent?.value || "").trim();

                if (mode === "text") {
                    fd.append("slotType", "text");
                    fd.append("slot_type", "text");
                    fd.append("slotMode", "custom");
                    fd.append("slot_mode", "custom");
                    fd.append("textContent", txt);
                    fd.append("text_content", txt);
                } else {
                    fd.append("slotType", "banner");
                    fd.append("slot_type", "banner");
                    fd.append("slotMode", mode);   // image | store
                    fd.append("slot_mode", mode);
                }

                // ✅ 링크는 모든 모드에서 저장 허용(원치 않으면 여기 조건 바꿔)
                if (linkUrl) {
                    fd.append("linkUrl", linkUrl);
                    fd.append("link_url", linkUrl);
                    fd.append("link", linkUrl);
                }

                if (mode === "store") {
                    if (storeId) { fd.append("storeId", storeId); fd.append("store_id", storeId); }
                    if (businessNo) {
                        fd.append("businessNo", businessNo);
                        fd.append("business_no", businessNo);
                        fd.append("bizNo", businessNo);
                    }
                    if (businessName) {
                        fd.append("businessName", businessName);
                        fd.append("business_name", businessName);
                    }
                }

                if (startAt) {
                    fd.append("startAt", startAt);
                    fd.append("start_at", startAt);
                    fd.append("startDate", startAt);
                    fd.append("start_date", startAt);
                }
                if (endAt) {
                    fd.append("endAt", endAt);
                    fd.append("end_at", endAt);
                    fd.append("endDate", endAt);
                    fd.append("end_date", endAt);
                }

                fd.append("noEnd", fieldNoEnd?.checked ? "1" : "0");
                fd.append("no_end", fieldNoEnd?.checked ? "1" : "0");

                const file = fieldImageFile?.files?.[0];
                if (mode === "image" && file) {
                    fd.append("image", file);
                    fd.append("slotImage", file);
                    fd.append("imageFile", file);
                    fd.append("adImage", file);
                }

                btnSaveSlot.disabled = true;
                btnSaveSlot.textContent = "저장 중...";

                try {
                    const { res, json } = await fetchJson("/manager/ad/slot", { method: "POST", body: fd });
                    if (!res.ok || !pickOk(json)) {
                        alert("저장 실패: 서버 응답을 확인해주세요.");
                        console.error("save fail:", json);
                        return;
                    }

                    const saved = await fetchSlot(activePosition, priority);
                    if (saved) {
                        fillModalFromSlot(saved);
                        if (activeBox) applySlotToBox(activeBox, saved);
                    }

                    closeModal();
                } catch (e) {
                    console.error("save error:", e);
                    alert("저장 중 오류가 발생했습니다.");
                } finally {
                    btnSaveSlot.disabled = false;
                    btnSaveSlot.textContent = "슬롯 저장";
                }
            }

            async function loadPriority() {
                const p = Number(adPriority?.value || 1) || 1;
                const slot = await fetchSlot(activePosition, p);
                if (!slot) {
                    resetModalFields(true);
                    setModalTypeForPosition(activePosition);
                    updateSelectedSummary();
                    alert(`우선순위 ${p} 후보가 없습니다.`);
                    await refreshCandidates();
                    return;
                }
                fillModalFromSlot(slot);
                await refreshCandidates();
            }

            async function deletePriority() {
                const p = Number(adPriority?.value || 1) || 1;
                if (!confirm(`우선순위 ${p} 후보를 삭제할까요?`)) return;

                const url = `/manager/ad/slot?page=${encodeURIComponent(PAGE)}&position=${encodeURIComponent(activePosition)}&priority=${encodeURIComponent(p)}`;
                const { res, json } = await fetchJson(url, { method: "DELETE" });

                if (!res.ok || !json?.success) {
                    alert(json?.error || "삭제 실패(DELETE API 확인 필요)");
                    return;
                }

                resetModalFields(true);
                setModalTypeForPosition(activePosition);
                updateSelectedSummary();

                await refreshCandidates();

                const slotP1 = await fetchSlot(activePosition, 1);
                const slot = slotP1 || await fetchSlot(activePosition);
                if (slot && activeBox) applySlotToBox(activeBox, slot);
            }

            async function handleBoxClick(box) {
                activeBox = box;
                activePosition = box.dataset.position || "";
                activeLabel = box.dataset.label || activePosition;

                if (!activePosition) return;

                modalRoot.dataset.page = PAGE;
                modalRoot.dataset.position = activePosition;

                modalTitle.textContent = activeLabel || "슬롯 수정";
                modalPositionText.textContent = activePosition;

                resetModalFields(true);
                setModalTypeForPosition(activePosition);

                if (adPriority) adPriority.value = "1";

                try {
                    const slotP1 = await fetchSlot(activePosition, 1);
                    if (slotP1) fillModalFromSlot(slotP1);
                    else {
                        const slot = await fetchSlot(activePosition);
                        if (slot) fillModalFromSlot(slot);
                        else updateSelectedSummary();
                    }
                } catch (e) {
                    console.warn("modal preload fail:", activePosition, e);
                    updateSelectedSummary();
                }

                openModal();
                await refreshCandidates();
            }

            function bindAllBoxes() {
                const boxes = getAllSlotElements();
                boxes.forEach(box => {
                    if (box.dataset.__bound === "1") return;
                    box.dataset.__bound = "1";

                    bindHoverTooltip(box);
                    box.addEventListener("click", () => handleBoxClick(box));
                });
            }

            radioModes().forEach(r => {
                r.addEventListener("change", () => {
                    setModeUI(getSelectedMode());
                    updateSelectedSummary();
                });
            });

            fieldImageFile?.addEventListener("change", () => {
                const file = fieldImageFile?.files?.[0];
                if (file) showLocalPreview(file);
                else {
                    if (__localPreviewUrl) {
                        URL.revokeObjectURL(__localPreviewUrl);
                        __localPreviewUrl = null;
                    }
                    currentPreviewImg?.classList.add("hidden");
                    currentPreviewImg?.removeAttribute("src");
                    currentPreviewEmpty?.classList.remove("hidden");
                }
                updateSelectedSummary();
            });

            [fieldBizNo, fieldBizName].forEach(el => el?.addEventListener("input", updateSelectedSummary));
            fieldNoEnd?.addEventListener("change", () => applyNoEndState());
            btnSearchStore?.addEventListener("click", searchStores);

            btnCloseModal?.addEventListener("click", closeModal);
            qs(".modal-backdrop", modalRoot)?.addEventListener("click", closeModal);

            btnResetModal?.addEventListener("click", () => {
                console.log("초기화 버튼 클릭됨");
                resetModalFields(true);
                alert("입력 필드가 초기화되었습니다.");
            });
            btnSaveSlot?.addEventListener("click", saveSlot);

            btnLoadPriority?.addEventListener("click", loadPriority);
            btnDeletePriority?.addEventListener("click", deletePriority);

            document.addEventListener("keydown", (e) => {
                if (e.key === "Escape" && !modalRoot.classList.contains("hidden")) closeModal();
            });

            (function setupHelpPopover() {
                const btn = document.getElementById("adHelpBtn");
                const pop = document.getElementById("adHelpPopover");
                const closeBtn = document.getElementById("adHelpCloseBtn");
                if (!btn || !pop) return;

                function openHelp() {
                    pop.classList.remove("hidden");
                    btn.setAttribute("aria-expanded", "true");
                }
                function closeHelp() {
                    pop.classList.add("hidden");
                    btn.setAttribute("aria-expanded", "false");
                }
                function toggleHelp(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    if (pop.classList.contains("hidden")) openHelp();
                    else closeHelp();
                }

                btn.addEventListener("click", toggleHelp);
                closeBtn?.addEventListener("click", (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    closeHelp();
                });

                pop.addEventListener("click", (e) => e.stopPropagation());
                document.addEventListener("click", () => closeHelp());
                document.addEventListener("keydown", (e) => { if (e.key === "Escape") closeHelp(); });

                window.__closeAdHelp = closeHelp;
            })();

            /* ============================================================
               ✅ 초기화 (DOMContentLoaded 놓쳐도 실행되게)
            ============================================================ */
            async function init() {
                buildBestPickGrid();
                bindAllBoxes();
                await loadAllSlotsPreview();
            }

            if (document.readyState === "loading") {
                document.addEventListener("DOMContentLoaded", init);
            } else {
                init();
            }
        })();
    </script>


</body>

</html>
