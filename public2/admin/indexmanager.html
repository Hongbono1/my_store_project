<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MALL HANKOOK ë©”ì¸ ë ˆì´ì•„ì›ƒ ê´€ë¦¬ì | indexmanager</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Noto Sans KR', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    .neo-card {
      background: rgba(255, 255, 255, 0.75);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-radius: 1rem;
      box-shadow:
        6px 6px 12px rgba(0, 0, 0, 0.10),
        -6px -6px 12px rgba(255, 255, 255, 0.9);
      transition: all 0.25s ease;
    }

    .neo-card:hover {
      transform: translateY(-2px);
      box-shadow:
        10px 10px 22px rgba(0, 0, 0, 0.14),
        -6px -6px 14px rgba(255, 255, 255, 1);
    }

    .slot-banner {
      position: relative;
      overflow: hidden;
      border-radius: 1rem;
      background: rgba(248, 250, 252, 0.9);
      border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .slot-banner img.slot-img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .slot-default {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
      color: #94a3b8;
      font-weight: 600;
      letter-spacing: -0.02em;
    }

    .field-label {
      font-size: 0.85rem;
      color: #334155;
      font-weight: 600;
      margin-bottom: 0.25rem;
    }

    .input {
      width: 100%;
      border-radius: 0.75rem;
      border: 1px solid rgba(0, 0, 0, 0.08);
      padding: 0.6rem 0.8rem;
      outline: none;
      background: white;
    }

    .input:focus {
      border-color: rgba(37, 99, 235, 0.45);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.12);
    }

    .select {
      width: 100%;
      border-radius: 0.75rem;
      border: 1px solid rgba(0, 0, 0, 0.08);
      padding: 0.6rem 0.8rem;
      background: white;
    }

    .btn {
      border-radius: 0.9rem;
      padding: 0.7rem 1rem;
      font-weight: 700;
      letter-spacing: -0.02em;
      transition: all .2s ease;
    }

    .btn-primary {
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      color: white;
      box-shadow: 0 10px 20px rgba(37, 99, 235, 0.18);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      filter: brightness(1.03);
    }

    .btn-ghost {
      background: white;
      border: 1px solid rgba(0, 0, 0, 0.08);
    }

    .btn-danger {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
      box-shadow: 0 10px 20px rgba(239, 68, 68, 0.18);
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.2rem 0.55rem;
      border-radius: 9999px;
      font-size: 0.72rem;
      font-weight: 700;
      border: 1px solid rgba(0, 0, 0, 0.06);
      background: rgba(255, 255, 255, 0.75);
    }
  </style>
</head>

<body class="bg-slate-50 text-slate-800">

  <!-- ìƒë‹¨ ë°” -->
  <header class="sticky top-0 z-40 bg-white/70 backdrop-blur border-b border-black/5">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-xl bg-blue-600 text-white flex items-center justify-center font-black">M</div>
        <div>
          <div class="text-lg font-extrabold leading-tight">MALL HANKOOK</div>
          <div class="text-xs text-slate-500">ë©”ì¸ ë ˆì´ì•„ì›ƒ ê´‘ê³ /í…ìŠ¤íŠ¸ ê´€ë¦¬ì</div>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <span class="chip">/manager/ad</span>
        <a href="/index.html" class="btn btn-ghost text-sm">ì‚¬ìš©ì í™ˆ</a>
      </div>
    </div>
  </header>

  <!-- ë©”ì‹œì§€ -->
  <div class="max-w-7xl mx-auto px-4 sm:px-6 mt-4">
    <div id="messageBox"
      class="hidden neo-card px-4 py-3 text-sm font-semibold"
      data-type="info"></div>
  </div>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 py-8 space-y-8">

    <!-- 1) ìŠ¬ë¡¯ ë¯¸ë¦¬ë³´ê¸° -->
    <section class="neo-card p-5 sm:p-6">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h2 class="text-xl sm:text-2xl font-extrabold">ì¸ë±ìŠ¤ ìŠ¬ë¡¯ ë¯¸ë¦¬ë³´ê¸°</h2>
          <p class="text-sm text-slate-500 mt-1">ì—…ë¡œë“œ/ì—°ê²° í›„ ìë™ ê°±ì‹ ë©ë‹ˆë‹¤.</p>
        </div>
        <button id="btnRefreshAll" class="btn btn-ghost text-sm">ì „ì²´ ìƒˆë¡œê³ ì¹¨</button>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-4 gap-4">
        <!-- ìƒë‹¨ ë ë°°ë„ˆ -->
        <div class="lg:col-span-4">
          <div class="text-sm font-bold mb-2">index_main_top</div>
          <div class="slot-banner h-24 sm:h-28"
            data-page="index" data-position="index_main_top">
            <img class="slot-img hidden" alt="index_main_top">
            <div class="slot-default">TOP ë ë°°ë„ˆ</div>
          </div>
        </div>

        <!-- ë©”ì¸ ë¹„ì£¼ì–¼ -->
        <div class="lg:col-span-3">
          <div class="text-sm font-bold mb-2">index_main_visual</div>
          <div class="slot-banner aspect-[21/9] w-full"
            data-page="index" data-position="index_main_visual">
            <img class="slot-img hidden" alt="index_main_visual">
            <div class="slot-default">ë©”ì¸ ë¹„ì£¼ì–¼</div>
          </div>
        </div>

        <!-- í”„ë¡œëª¨ 1/2/3 -->
        <div class="lg:col-span-1 flex flex-col gap-3">
          <div>
            <div class="text-sm font-bold mb-2">index_promo_1</div>
            <div class="slot-banner h-24"
              data-page="index" data-position="index_promo_1">
              <img class="slot-img hidden" alt="index_promo_1">
              <div class="slot-default">Promo 1</div>
            </div>
          </div>
          <div>
            <div class="text-sm font-bold mb-2">index_promo_2</div>
            <div class="slot-banner h-24"
              data-page="index" data-position="index_promo_2">
              <img class="slot-img hidden" alt="index_promo_2">
              <div class="slot-default">Promo 2</div>
            </div>
          </div>
          <div>
            <div class="text-sm font-bold mb-2">index_promo_3</div>
            <div class="slot-banner h-24"
              data-page="index" data-position="index_promo_3">
              <img class="slot-img hidden" alt="index_promo_3">
              <div class="slot-default">Promo 3</div>
            </div>
          </div>
        </div>
      </div>

      <hr class="my-6 border-black/5">

      <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3">
        <!-- ê¸°ëŠ¥ ì§„ì… ì¹´ë“œ ë¯¸ë¦¬ë³´ê¸° -->
        <div>
          <div class="text-[11px] font-bold mb-1">index_food_delivery</div>
          <div class="slot-banner h-20"
            data-page="index" data-position="index_food_delivery">
            <img class="slot-img hidden" alt="index_food_delivery">
            <div class="slot-default">í™ë³´ì˜ ë°°ë‹¬</div>
          </div>
        </div>
        <div>
          <div class="text-[11px] font-bold mb-1">index_all_stores</div>
          <div class="slot-banner h-20"
            data-page="index" data-position="index_all_stores">
            <img class="slot-img hidden" alt="index_all_stores">
            <div class="slot-default">ëª¨ë“ ê°€ê²Œ</div>
          </div>
        </div>
        <div>
          <div class="text-[11px] font-bold mb-1">index_hot_place</div>
          <div class="slot-banner h-20"
            data-page="index" data-position="index_hot_place">
            <img class="slot-img hidden" alt="index_hot_place">
            <div class="slot-default">HOT</div>
          </div>
        </div>
        <div>
          <div class="text-[11px] font-bold mb-1">index_suggest</div>
          <div class="slot-banner h-20"
            data-page="index" data-position="index_suggest">
            <img class="slot-img hidden" alt="index_suggest">
            <div class="slot-default">ì¶”ì²œ</div>
          </div>
        </div>
        <div>
          <div class="text-[11px] font-bold mb-1">index_open</div>
          <div class="slot-banner h-20"
            data-page="index" data-position="index_open">
            <img class="slot-img hidden" alt="index_open">
            <div class="slot-default">ì˜¤í”ˆì˜ˆì •</div>
          </div>
        </div>
        <div>
          <div class="text-[11px] font-bold mb-1">index_store_pride</div>
          <div class="slot-banner h-20"
            data-page="index" data-position="index_store_pride">
            <img class="slot-img hidden" alt="index_store_pride">
            <div class="slot-default">ê°€ê²Œìë‘</div>
          </div>
        </div>
      </div>
    </section>

    <!-- 2) ì´ë¯¸ì§€/ë°°ë„ˆ ì—…ë¡œë“œ -->
    <section class="neo-card p-5 sm:p-6">
      <div class="mb-5">
        <h2 class="text-xl sm:text-2xl font-extrabold">ë°°ë„ˆ ìŠ¬ë¡¯ ì—…ë¡œë“œ</h2>
        <p class="text-sm text-slate-500 mt-1">
          ì´ë¯¸ì§€ ì—…ë¡œë“œ + ë§í¬/í…ìŠ¤íŠ¸/ê¸°ê°„/ëª¨ë“œ ì €ì¥
        </p>
      </div>

      <form id="uploadForm" class="grid grid-cols-1 lg:grid-cols-4 gap-4" enctype="multipart/form-data">
        <!-- page -->
        <div>
          <div class="field-label">page</div>
          <select name="page" class="select">
            <option value="index" selected>index</option>
          </select>
        </div>

        <!-- position -->
        <div class="lg:col-span-2">
          <div class="field-label">position</div>
          <select name="position" id="positionSelect" class="select">
            <optgroup label="ë©”ì¸">
              <option value="index_main_top">index_main_top</option>
              <option value="index_main_visual">index_main_visual</option>
              <option value="index_promo_1">index_promo_1</option>
              <option value="index_promo_2">index_promo_2</option>
              <option value="index_promo_3">index_promo_3</option>
            </optgroup>
            <optgroup label="ê¸°ëŠ¥ ì§„ì…">
              <option value="index_food_delivery">index_food_delivery</option>
              <option value="index_all_stores">index_all_stores</option>
              <option value="index_hot_place">index_hot_place</option>
              <option value="index_suggest">index_suggest</option>
              <option value="index_open">index_open</option>
              <option value="index_store_pride">index_store_pride</option>
              <option value="index_traditional">index_traditional</option>
              <option value="index_performing">index_performing</option>
            </optgroup>
            <optgroup label="í•˜ë‹¨/ê¸°íƒ€">
              <option value="index_event">index_event</option>
              <option value="index_localboard">index_localboard</option>
              <option value="index_season">index_season</option>
              <option value="index_join">index_join</option>
              <option value="index_support_review">index_support_review</option>
              <option value="index_support_empty">index_support_empty</option>
              <option value="index_support_inquiry">index_support_inquiry</option>
            </optgroup>
            <optgroup label="Best Pick">
              <option value="best_pick_1">best_pick_1</option>
              <option value="best_pick_2">best_pick_2</option>
              <option value="best_pick_3">best_pick_3</option>
              <option value="best_pick_4">best_pick_4</option>
              <option value="best_pick_5">best_pick_5</option>
              <option value="best_pick_6">best_pick_6</option>
              <option value="best_pick_7">best_pick_7</option>
              <option value="best_pick_8">best_pick_8</option>
              <option value="best_pick_9">best_pick_9</option>
              <option value="best_pick_10">best_pick_10</option>
              <option value="best_pick_11">best_pick_11</option>
              <option value="best_pick_12">best_pick_12</option>
              <option value="best_pick_13">best_pick_13</option>
              <option value="best_pick_14">best_pick_14</option>
              <option value="best_pick_15">best_pick_15</option>
              <option value="best_pick_16">best_pick_16</option>
              <option value="best_pick_17">best_pick_17</option>
              <option value="best_pick_18">best_pick_18</option>
            </optgroup>
          </select>
        </div>

        <!-- slotType -->
        <div>
          <div class="field-label">slotType</div>
          <select name="slotType" class="select">
            <option value="banner" selected>banner</option>
            <option value="text">text</option>
          </select>
        </div>

        <!-- slotMode -->
        <div>
          <div class="field-label">slotMode</div>
          <select name="slotMode" id="slotModeSelect" class="select">
            <option value="custom" selected>custom</option>
            <option value="store">store</option>
          </select>
        </div>

        <!-- image -->
        <div class="lg:col-span-3">
          <div class="field-label">image (optional)</div>
          <input type="file" name="image" accept="image/*" class="input" />
          <div class="text-[11px] text-slate-400 mt-1">
            banner ëª¨ë“œì—ì„œ ì´ë¯¸ì§€ê°€ ì—†ìœ¼ë©´ ê¸°ì¡´/ê¸°ë³¸ê°’ì´ ìœ ì§€ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          </div>
        </div>

        <!-- linkUrl -->
        <div class="lg:col-span-2">
          <div class="field-label">linkUrl</div>
          <input type="text" name="linkUrl" class="input" placeholder="/ndetail.html?id=2&type=food" />
        </div>

        <!-- textContent -->
        <div class="lg:col-span-2">
          <div class="field-label">textContent</div>
          <input type="text" name="textContent" class="input" placeholder="í…ìŠ¤íŠ¸í˜• ì•ˆë‚´ ë¬¸êµ¬(ì„ íƒ)" />
        </div>

        <!-- storeId -->
        <div>
          <div class="field-label">storeId</div>
          <input type="number" name="storeId" class="input" placeholder="ì„ íƒ" />
        </div>

        <!-- businessNo -->
        <div>
          <div class="field-label">businessNo</div>
          <input type="text" name="businessNo" id="businessNoInput" class="input" placeholder="ìˆ«ìë§Œ" />
        </div>

        <!-- businessName -->
        <div class="lg:col-span-2">
          <div class="field-label">businessName</div>
          <input type="text" name="businessName" id="businessNameInput" class="input" placeholder="ìƒí˜¸ëª…" />
        </div>

        <!-- start/end/noEnd -->
        <div>
          <div class="field-label">startDate</div>
          <input type="date" name="startDate" class="input" />
        </div>
        <div>
          <div class="field-label">endDate</div>
          <input type="date" name="endDate" id="endDateInput" class="input" />
        </div>
        <div class="flex items-end">
          <label class="flex items-center gap-2 text-sm font-semibold text-slate-700">
            <input type="checkbox" name="noEnd" id="noEndCheck">
            ì¢…ë£Œ ì—†ìŒ
          </label>
        </div>

        <!-- actions -->
        <div class="lg:col-span-4 flex flex-wrap gap-2 pt-2">
          <button type="submit" class="btn btn-primary">ì—…ë¡œë“œ ì €ì¥</button>
          <button type="button" id="btnQuickDelete" class="btn btn-danger">ì„ íƒ ìŠ¬ë¡¯ ì‚­ì œ</button>
          <button type="button" id="btnLoadSelectedPreview" class="btn btn-ghost">ì„ íƒ ìŠ¬ë¡¯ ë¯¸ë¦¬ë³´ê¸° ê°±ì‹ </button>
        </div>
      </form>
    </section>

    <!-- 3) ì‚¬ì—…ìë²ˆí˜¸ ê¸°ë°˜ ê°€ê²Œ ê²€ìƒ‰ + ë¹ ë¥¸ ì—°ê²° -->
    <section class="neo-card p-5 sm:p-6">
      <div class="mb-5">
        <h2 class="text-xl sm:text-2xl font-extrabold">ê°€ê²Œ ê²€ìƒ‰ & ìŠ¬ë¡¯ ì—°ê²°</h2>
        <p class="text-sm text-slate-500 mt-1">
          /manager/ad/store/search, /manager/ad/store/connect ì‚¬ìš©
        </p>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <!-- search -->
        <div class="lg:col-span-1">
          <div class="field-label">ì‚¬ì—…ìë²ˆí˜¸ë¡œ ê²€ìƒ‰</div>
          <div class="flex gap-2">
            <input id="bizSearchInput" type="text" class="input" placeholder="123-45-67890 ë˜ëŠ” ìˆ«ì" />
            <button id="btnBizSearch" class="btn btn-ghost whitespace-nowrap">ê²€ìƒ‰</button>
          </div>

          <div id="bizSearchResult" class="mt-3 space-y-2">
            <div class="text-xs text-slate-400">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
          </div>
        </div>

        <!-- connect -->
        <div class="lg:col-span-2">
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div>
              <div class="field-label">page</div>
              <select id="connectPage" class="select">
                <option value="index" selected>index</option>
              </select>
            </div>
            <div>
              <div class="field-label">position</div>
              <select id="connectPosition" class="select">
                <option value="index_main_top">index_main_top</option>
                <option value="index_main_visual">index_main_visual</option>
                <option value="index_promo_1">index_promo_1</option>
                <option value="index_promo_2">index_promo_2</option>
                <option value="index_promo_3">index_promo_3</option>
                <option value="best_pick_1">best_pick_1</option>
                <option value="best_pick_2">best_pick_2</option>
                <option value="best_pick_3">best_pick_3</option>
                <option value="best_pick_4">best_pick_4</option>
              </select>
            </div>

            <div>
              <div class="field-label">bizNo</div>
              <input id="connectBizNo" type="text" class="input" placeholder="ê²€ìƒ‰ ê²°ê³¼ í´ë¦­ ì‹œ ìë™ ì…ë ¥" />
            </div>
            <div>
              <div class="field-label">bizName</div>
              <input id="connectBizName" type="text" class="input" placeholder="ê²€ìƒ‰ ê²°ê³¼ í´ë¦­ ì‹œ ìë™ ì…ë ¥" />
            </div>

            <div>
              <div class="field-label">startDate</div>
              <input id="connectStartDate" type="date" class="input" />
            </div>
            <div>
              <div class="field-label">endDate</div>
              <input id="connectEndDate" type="date" class="input" />
            </div>

            <div class="sm:col-span-2">
              <label class="flex items-center gap-2 text-sm font-semibold text-slate-700">
                <input id="connectNoEnd" type="checkbox">
                ì¢…ë£Œ ì—†ìŒ
              </label>
            </div>
          </div>

          <div class="pt-3 flex gap-2">
            <button id="btnConnectStore" class="btn btn-primary">ê°€ê²Œ-ìŠ¬ë¡¯ ì—°ê²° ì €ì¥</button>
            <button id="btnConnectPreview" class="btn btn-ghost">ì—°ê²° ìŠ¬ë¡¯ ë¯¸ë¦¬ë³´ê¸° ê°±ì‹ </button>
          </div>
        </div>
      </div>
    </section>

    <!-- 4) í…ìŠ¤íŠ¸ ìŠ¬ë¡¯ ê´€ë¦¬ -->
    <section class="neo-card p-5 sm:p-6">
      <div class="mb-5">
        <h2 class="text-xl sm:text-2xl font-extrabold">í…ìŠ¤íŠ¸ ìŠ¬ë¡¯ ì €ì¥</h2>
        <p class="text-sm text-slate-500 mt-1">/manager/ad/text/save</p>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-4 gap-4">
        <div>
          <div class="field-label">page</div>
          <select id="textPage" class="select">
            <option value="index" selected>index</option>
          </select>
        </div>
        <div class="lg:col-span-2">
          <div class="field-label">position</div>
          <select id="textPosition" class="select">
            <option value="index_sub_keywords">index_sub_keywords</option>
            <option value="index_sub_news">index_sub_news</option>
            <option value="index_sub_events">index_sub_events</option>
            <option value="index_sub_recommends">index_sub_recommends</option>
            <option value="index_oneword">index_oneword</option>
          </select>
        </div>
        <div class="flex items-end">
          <button id="btnLoadTextSlot" class="btn btn-ghost w-full">ë¶ˆëŸ¬ì˜¤ê¸°</button>
        </div>

        <div class="lg:col-span-4">
          <div class="field-label">content (HTML ê°€ëŠ¥)</div>
          <textarea id="textContentArea" rows="4" class="input"
            placeholder="ì˜ˆ) <p class='text-xl font-bold'>ê²€ìƒ‰ì–´ 1</p>"></textarea>
        </div>

        <div class="lg:col-span-4 flex gap-2">
          <button id="btnSaveTextSlot" class="btn btn-primary">í…ìŠ¤íŠ¸ ì €ì¥</button>
          <button id="btnDeleteTextSlot" class="btn btn-danger">ì´ í…ìŠ¤íŠ¸ ìŠ¬ë¡¯ ì‚­ì œ</button>
        </div>
      </div>
    </section>

  </main>

  <!-- í•˜ë‹¨ -->
  <footer class="py-10 text-center text-xs text-slate-400">
    indexmanager.html | MALL HANKOOK Admin
  </footer>

  <!-- ============================================================
       âœ… ê´€ë¦¬ì HTML ì „ìš© ìŠ¤í¬ë¦½íŠ¸ (ì—…ë¡œë“œ/ê²€ìƒ‰/ì—°ê²°/í…ìŠ¤íŠ¸/ì‚­ì œ)
       - ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ë¶„ë¦¬ëœ í”„ë¡ íŠ¸ ë¡œì§
  ============================================================ -->
  <script>
    // ------------------------------------------------------------
    // tiny utils
    // ------------------------------------------------------------
    const $ = (sel, root = document) => root.querySelector(sel);
    const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));

    // ------------------------------------------------------------
    // message UI
    // ------------------------------------------------------------
    function showMessage(msg, type = "info") {
      const box = $("#messageBox");
      if (!box) {
        console.log(`[${type}]`, msg);
        return;
      }

      box.textContent = msg;
      box.classList.remove("hidden");

      // style by type
      box.classList.remove("text-emerald-700", "text-red-700", "text-blue-700", "bg-emerald-50", "bg-red-50", "bg-blue-50");

      if (type === "success") {
        box.classList.add("text-emerald-700", "bg-emerald-50");
      } else if (type === "error") {
        box.classList.add("text-red-700", "bg-red-50");
      } else {
        box.classList.add("text-blue-700", "bg-blue-50");
      }

      clearTimeout(box.__t);
      box.__t = setTimeout(() => box.classList.add("hidden"), 2000);
    }

    // ------------------------------------------------------------
    // slot preview refresher
    // ------------------------------------------------------------
    async function refreshSlotPreview(page, position) {
      try {
        const res = await fetch(
          `/manager/ad/slot?page=${encodeURIComponent(page)}&position=${encodeURIComponent(position)}`
        );
        if (!res.ok) return;

        const json = await res.json();
        const isOk = !!(json.ok || json.success);
        const slot = json.slot || null;

        const targets = $$(`[data-page="${page}"][data-position="${position}"]`);
        if (!targets.length) return;

        targets.forEach((container) => {
          const img = $(".slot-img", container);
          const def = $(".slot-default", container);

          if (isOk && slot && slot.image_url) {
            if (img) {
              img.src = slot.image_url;
              img.classList.remove("hidden");
            }
            if (def) def.classList.add("hidden");
          } else {
            if (img) img.classList.add("hidden");
            if (def) def.classList.remove("hidden");
          }
        });
      } catch (e) {
        console.warn("refreshSlotPreview failed:", e);
      }
    }

    async function refreshAllPreviews() {
      const nodes = $$("[data-page][data-position]");
      const uniq = new Set(nodes.map(n => `${n.dataset.page}::${n.dataset.position}`));
      await Promise.all(
        Array.from(uniq).map(key => {
          const [page, position] = key.split("::");
          return refreshSlotPreview(page, position);
        })
      );
    }

    // ------------------------------------------------------------
    // upload success handler
    // ------------------------------------------------------------
    async function handleUploadSuccess(data, form) {
      console.log("âœ… ì—…ë¡œë“œ ì„±ê³µ:", data);

      const slot = data?.slot;
      const page = slot?.page;
      const position = slot?.position;

      form.reset();
      showMessage("ì—…ë¡œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.", "success");

      if (page && position) {
        setTimeout(() => refreshSlotPreview(page, position), 250);
      }
    }

    // ------------------------------------------------------------
    // bind upload form (multipart)
    // ------------------------------------------------------------
    function bindUploadForm() {
      const uploadForm = $("#uploadForm");
      if (!uploadForm) return;

      uploadForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const formData = new FormData(uploadForm);
        const submitBtn = $('button[type="submit"]', uploadForm);

        // noEnd ì²´í¬ ì‹œ endDate ë¬´ì‹œí•˜ë„ë¡ UX ë³´ì •
        const noEnd = $("#noEndCheck")?.checked;
        const endDateInput = $("#endDateInput");
        if (noEnd && endDateInput) {
          endDateInput.value = "";
        }

        // Debug
        console.log("ğŸ“¤ ì—…ë¡œë“œ í¼ ë°ì´í„°:");
        for (let [key, value] of formData.entries()) {
          console.log(`  ${key}:`, value instanceof File ? `File(${value.name})` : value);
        }

        try {
          if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.dataset.originalText = submitBtn.textContent;
            submitBtn.textContent = "ì—…ë¡œë“œ ì¤‘...";
          }

          const response = await fetch("/manager/ad/upload", {
            method: "POST",
            body: formData
          });

          const data = await response.json();
          const isOk = !!(data.ok || data.success);

          if (response.ok && isOk) {
            await handleUploadSuccess(data, uploadForm);
          } else {
            throw new Error(data.message || "ì—…ë¡œë“œ ì‹¤íŒ¨");
          }
        } catch (error) {
          console.error("âŒ ì—…ë¡œë“œ ì˜¤ë¥˜:", error);
          showMessage(error.message || "ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "error");
        } finally {
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = submitBtn.dataset.originalText || "ì—…ë¡œë“œ ì €ì¥";
          }
        }
      });
    }

    // ------------------------------------------------------------
    // delete slot (from upload section quick delete)
    // ------------------------------------------------------------
    async function deleteSelectedSlot() {
      const page = $('select[name="page"]')?.value;
      const position = $('#positionSelect')?.value;

      if (!page || !position) {
        showMessage("page/position ì„ íƒì´ í•„ìš”í•©ë‹ˆë‹¤.", "error");
        return;
      }

      try {
        const res = await fetch(
          `/manager/ad/slot?page=${encodeURIComponent(page)}&position=${encodeURIComponent(position)}`,
          { method: "DELETE" }
        );

        const json = await res.json();

        if (res.ok && (json.ok || json.success)) {
          showMessage("ìŠ¬ë¡¯ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.", "success");
          setTimeout(() => refreshSlotPreview(page, position), 200);
        } else {
          throw new Error(json.message || "ì‚­ì œ ì‹¤íŒ¨");
        }
      } catch (e) {
        console.error(e);
        showMessage(e.message || "ì‚­ì œ ì¤‘ ì˜¤ë¥˜", "error");
      }
    }

    // ------------------------------------------------------------
    // store search by bizNo
    // ------------------------------------------------------------
    function renderBizSearchResult(stores = []) {
      const wrap = $("#bizSearchResult");
      if (!wrap) return;

      wrap.innerHTML = "";

      if (!stores.length) {
        wrap.innerHTML = `<div class="text-xs text-slate-400">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</div>`;
        return;
      }

      stores.forEach((s) => {
        const item = document.createElement("button");
        item.type = "button";
        item.className =
          "w-full text-left neo-card px-3 py-2 hover:translate-y-0.5 transition";

        item.innerHTML = `
          <div class="text-sm font-extrabold text-slate-800">${s.business_name || "ì´ë¦„ ì—†ìŒ"}</div>
          <div class="text-[11px] text-slate-500 mt-0.5">
            biz: ${s.business_no || "-"} Â· id: ${s.id || "-"} Â· type: ${s.store_type || "-"}
          </div>
        `;

        item.addEventListener("click", () => {
          // connect form
          const cleanBiz = String(s.business_no || "").trim();
          $("#connectBizNo").value = cleanBiz;
          $("#connectBizName").value = s.business_name || "";

          // upload formì—ë„ ì±„ì›Œì£¼ë©´ ì‘ì—… í¸í•´ì§
          $("#businessNoInput").value = cleanBiz;
          $("#businessNameInput").value = s.business_name || "";
          showMessage("ê²€ìƒ‰ ê²°ê³¼ë¥¼ ì…ë ¥ì¹¸ì— ë°˜ì˜í–ˆìŠµë‹ˆë‹¤.", "success");
        });

        wrap.appendChild(item);
      });
    }

    async function runBizSearch() {
      const input = $("#bizSearchInput");
      const bizNo = input?.value?.trim();

      if (!bizNo) {
        showMessage("ì‚¬ì—…ìë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.", "error");
        return;
      }

      try {
        const res = await fetch(
          `/manager/ad/store/search?bizNo=${encodeURIComponent(bizNo)}`
        );
        const json = await res.json();

        if (res.ok && json.ok) {
          renderBizSearchResult(json.stores || []);
        } else {
          throw new Error(json.message || "ê°€ê²Œ ê²€ìƒ‰ ì‹¤íŒ¨");
        }
      } catch (e) {
        console.error(e);
        showMessage(e.message || "ê°€ê²Œ ê²€ìƒ‰ ì˜¤ë¥˜", "error");
      }
    }

    // ------------------------------------------------------------
    // connect store to slot
    // ------------------------------------------------------------
    async function connectStoreToSlot() {
      const page = $("#connectPage")?.value;
      const position = $("#connectPosition")?.value;
      const bizNo = $("#connectBizNo")?.value?.trim();
      const bizName = $("#connectBizName")?.value?.trim();
      const startDate = $("#connectStartDate")?.value || null;

      const noEnd = $("#connectNoEnd")?.checked;
      const endDate = noEnd ? null : ($("#connectEndDate")?.value || null);

      if (!page || !position) {
        showMessage("page/positionì„ ì„ íƒí•´ì£¼ì„¸ìš”.", "error");
        return;
      }
      if (!bizNo || !bizName) {
        showMessage("bizNo/bizNameì´ í•„ìš”í•©ë‹ˆë‹¤.", "error");
        return;
      }

      try {
        const res = await fetch("/manager/ad/store/connect", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            page,
            position,
            bizNo,
            bizName,
            startDate,
            endDate,
            noEnd: !!noEnd
          })
        });

        const json = await res.json();

        if (res.ok && json.ok) {
          showMessage(
            json.storeConnected
              ? "ê°€ê²Œ ì—°ê²°ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. (store_id ë§¤í•‘ ì„±ê³µ)"
              : "ê°€ê²Œ ì—°ê²°ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. (store_id ë§¤í•‘ ì—†ìŒ)",
            "success"
          );
          setTimeout(() => refreshSlotPreview(page, position), 250);
        } else {
          throw new Error(json.message || "ê°€ê²Œ ì—°ê²° ì €ì¥ ì‹¤íŒ¨");
        }
      } catch (e) {
        console.error(e);
        showMessage(e.message || "ê°€ê²Œ ì—°ê²° ì˜¤ë¥˜", "error");
      }
    }

    // ------------------------------------------------------------
    // text slot load/save/delete
    // ------------------------------------------------------------
    async function loadTextSlotToEditor() {
      const page = $("#textPage")?.value;
      const position = $("#textPosition")?.value;

      if (!page || !position) {
        showMessage("page/position ì„ íƒì´ í•„ìš”í•©ë‹ˆë‹¤.", "error");
        return;
      }

      try {
        const res = await fetch(
          `/manager/ad/text/get?page=${encodeURIComponent(page)}&position=${encodeURIComponent(position)}`
        );
        const json = await res.json();

        const isOk = !!(json.ok || json.success);
        const content =
          json?.text?.content ||
          json?.text?.text_content ||
          json?.slot?.text_content ||
          json?.slot?.content ||
          "";

        if (res.ok && isOk && content) {
          $("#textContentArea").value = content;
          showMessage("í…ìŠ¤íŠ¸ ìŠ¬ë¡¯ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.", "success");
        } else {
          $("#textContentArea").value = "";
          showMessage("ì €ì¥ëœ í…ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.", "info");
        }
      } catch (e) {
        console.error(e);
        showMessage("í…ìŠ¤íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜", "error");
      }
    }

    async function saveTextSlot() {
      const page = $("#textPage")?.value;
      const position = $("#textPosition")?.value;
      const content = $("#textContentArea")?.value?.trim();

      if (!page || !position) {
        showMessage("page/position ì„ íƒì´ í•„ìš”í•©ë‹ˆë‹¤.", "error");
        return;
      }
      if (!content) {
        showMessage("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.", "error");
        return;
      }

      try {
        const res = await fetch("/manager/ad/text/save", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ page, position, content })
        });

        const json = await res.json();

        if (res.ok && json.ok) {
          showMessage("í…ìŠ¤íŠ¸ ì €ì¥ ì™„ë£Œ", "success");
        } else {
          throw new Error(json.message || "í…ìŠ¤íŠ¸ ì €ì¥ ì‹¤íŒ¨");
        }
      } catch (e) {
        console.error(e);
        showMessage(e.message || "í…ìŠ¤íŠ¸ ì €ì¥ ì˜¤ë¥˜", "error");
      }
    }

    async function deleteTextSlot() {
      const page = $("#textPage")?.value;
      const position = $("#textPosition")?.value;

      if (!page || !position) {
        showMessage("page/position ì„ íƒì´ í•„ìš”í•©ë‹ˆë‹¤.", "error");
        return;
      }

      // í…ìŠ¤íŠ¸ë„ admin_ad_slots ì´ë¯€ë¡œ ë™ì¼ delete API ì‚¬ìš©
      try {
        const res = await fetch(
          `/manager/ad/slot?page=${encodeURIComponent(page)}&position=${encodeURIComponent(position)}`,
          { method: "DELETE" }
        );
        const json = await res.json();

        if (res.ok && (json.ok || json.success)) {
          $("#textContentArea").value = "";
          showMessage("í…ìŠ¤íŠ¸ ìŠ¬ë¡¯ ì‚­ì œ ì™„ë£Œ", "success");
        } else {
          throw new Error(json.message || "ì‚­ì œ ì‹¤íŒ¨");
        }
      } catch (e) {
        console.error(e);
        showMessage(e.message || "ì‚­ì œ ì˜¤ë¥˜", "error");
      }
    }

    // ------------------------------------------------------------
    // bind small UI helpers
    // ------------------------------------------------------------
    function bindNoEndUX() {
      const noEnd = $("#noEndCheck");
      const endDate = $("#endDateInput");
      if (!noEnd || !endDate) return;

      function sync() {
        if (noEnd.checked) {
          endDate.value = "";
          endDate.disabled = true;
          endDate.classList.add("opacity-60");
        } else {
          endDate.disabled = false;
          endDate.classList.remove("opacity-60");
        }
      }

      noEnd.addEventListener("change", sync);
      sync();
    }

    // ------------------------------------------------------------
    // init
    // ------------------------------------------------------------
    document.addEventListener("DOMContentLoaded", () => {
      bindUploadForm();
      bindNoEndUX();

      $("#btnQuickDelete")?.addEventListener("click", deleteSelectedSlot);
      $("#btnBizSearch")?.addEventListener("click", runBizSearch);
      $("#btnConnectStore")?.addEventListener("click", connectStoreToSlot);

      $("#btnLoadTextSlot")?.addEventListener("click", loadTextSlotToEditor);
      $("#btnSaveTextSlot")?.addEventListener("click", saveTextSlot);
      $("#btnDeleteTextSlot")?.addEventListener("click", deleteTextSlot);

      $("#btnRefreshAll")?.addEventListener("click", refreshAllPreviews);

      $("#btnLoadSelectedPreview")?.addEventListener("click", () => {
        const page = $('select[name="page"]')?.value;
        const position = $("#positionSelect")?.value;
        if (page && position) refreshSlotPreview(page, position);
      });

      $("#btnConnectPreview")?.addEventListener("click", () => {
        const page = $("#connectPage")?.value;
        const position = $("#connectPosition")?.value;
        if (page && position) refreshSlotPreview(page, position);
      });

      // ìµœì´ˆ ë¯¸ë¦¬ë³´ê¸°
      refreshAllPreviews();

      showMessage("ì¸ë±ìŠ¤ ê´€ë¦¬ì ì¤€ë¹„ ì™„ë£Œ", "success");
      console.log("INDEX MANAGER VERSION 2025-12-07");
    });
  </script>
</body>

</html>
