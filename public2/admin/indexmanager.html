<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MALL HANKOOK | Index Layout Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body {
            font-family: 'Noto Sans KR', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        /* ✅ 카드/슬롯 기본 스타일 */
        .neo-card {
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid rgba(59, 130, 246, 0.18);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 1rem;
            box-shadow:
                8px 8px 20px rgba(0, 0, 0, 0.08),
                -8px -8px 20px rgba(255, 255, 255, 0.6);
            transition: all .2s ease;
        }

        .neo-card:hover {
            transform: translateY(-2px);
            box-shadow:
                10px 10px 26px rgba(0, 0, 0, 0.12),
                -10px -10px 26px rgba(255, 255, 255, 0.7);
        }

        .slot-banner {
            position: relative;
            cursor: pointer;
            overflow: hidden;
        }

        .slot-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .slot-default {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            text-align: center;
        }

        .slot-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 12px;
            font-weight: 800;
            padding: 4px 10px;
            border-radius: 9999px;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(59, 130, 246, 0.25);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
            user-select: none;
        }

        .slot-badge.store {
            right: auto;
            left: 10px;
            background: rgba(37, 99, 235, 0.12);
            border-color: rgba(37, 99, 235, 0.35);
            color: #1d4ed8;
        }

        /* ✅ 모달 */
        #modalBackdrop {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.45);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            padding: 18px;
        }

        #modal {
            width: min(980px, 95vw);
            max-height: 92vh;
            overflow: auto;
            border-radius: 1rem;
            background: rgba(255, 255, 255, 0.97);
            border: 2px solid rgba(59, 130, 246, 0.18);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.25);
            backdrop-filter: blur(12px);
        }

        .tab-btn {
            padding: 10px 14px;
            border-radius: 9999px;
            font-weight: 800;
            border: 1px solid rgba(59, 130, 246, 0.25);
            background: rgba(255, 255, 255, 0.9);
        }

        .tab-btn.active {
            background: rgba(37, 99, 235, 0.12);
            border-color: rgba(37, 99, 235, 0.45);
            color: #1d4ed8;
        }

        .form-label {
            font-weight: 800;
            color: #111827;
            margin-bottom: 6px;
            display: block;
        }

        .input {
            width: 100%;
            border-radius: 12px;
            border: 1px solid rgba(15, 23, 42, 0.12);
            padding: 10px 12px;
            background: rgba(255, 255, 255, 0.95);
            outline: none;
        }

        .input:focus {
            border-color: rgba(37, 99, 235, 0.6);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
        }

        .btn {
            border-radius: 9999px;
            padding: 10px 16px;
            font-weight: 900;
            border: 1px solid rgba(15, 23, 42, 0.12);
            background: white;
        }

        .btn.primary {
            background: linear-gradient(90deg, #60a5fa, #2563eb);
            color: #fff;
            border: none;
            box-shadow: 0 10px 20px rgba(37, 99, 235, 0.18);
        }

        .btn.danger {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.25);
            color: #b91c1c;
        }

        .btn.ghost {
            background: rgba(0, 0, 0, 0.04);
        }
    </style>
</head>

<body class="bg-gradient-to-br from-blue-50 via-white to-blue-100 min-h-screen text-gray-800">
    <!-- ✅ header -->
    <div id="header-placeholder"></div>

    <header class="max-w-7xl mx-auto px-4 sm:px-6 py-8">
        <div class="neo-card p-6">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div>
                    <h1 class="text-3xl font-black text-blue-700">인덱스 레이아웃 관리자</h1>
                    <p class="text-gray-600 mt-1">슬롯을 클릭 → 모달에서 이미지/URL/가게연결/텍스트/기간 저장</p>
                </div>
                <div class="text-sm text-gray-600 font-semibold">
                    API: <span class="font-black text-gray-800">/manager/ad/slot</span>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 pb-10 space-y-8">

        <!-- ✅ (예시) 상단 메인 배너 -->
        <section class="neo-card p-5">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-black text-gray-900">상단 메인 배너</h2>
                <div class="text-xs text-gray-500 font-bold">Banner 슬롯</div>
            </div>

            <div id="slot_index_main_top" class="neo-card slot-banner min-h-[200px] sm:min-h-[260px] p-0"
                data-page="index" data-position="index_main_top" data-label="상단 메인 배너" data-size="가로 대형 배너">
                <img class="slot-img hidden" alt="상단 메인 배너">
                <div class="slot-default">
                    <span class="text-gray-500 font-bold">클릭해서 배너 설정</span>
                </div>
                <span class="slot-badge size">Banner</span>
                <span class="slot-badge store hidden"></span>
            </div>
        </section>

        <!-- ✅ (추가) 이벤트/지역게시판/계절테마/신규회원혜택 -->
        <section class="neo-card p-5">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-black text-gray-900">하단 4칸(이벤트/지역게시판/계절테마/신규회원혜택)</h2>
                <div class="text-xs text-gray-500 font-bold">Banner/Store/Text 모두 가능</div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <div id="slot_index_event" class="neo-card slot-banner min-h-[140px] p-0" data-page="index"
                    data-position="index_event" data-label="이벤트" data-size="카드형">
                    <img class="slot-img hidden" alt="이벤트">
                    <div class="slot-default">
                        <div class="slot-text-wrap px-4 py-6 w-full">
                            <div
                                class="slot-text-body text-xl sm:text-2xl font-black text-gray-800 leading-relaxed whitespace-pre-line">
                            </div>
                            <div class="slot-hint text-base sm:text-lg text-gray-500 font-bold">클릭해서 설정</div>
                        </div>
                    </div>
                    <span class="slot-badge size">Card</span>
                    <span class="slot-badge store hidden"></span>
                </div>

                <div id="slot_index_localboard" class="neo-card slot-banner min-h-[140px] p-0" data-page="index"
                    data-position="index_localboard" data-label="지역 게시판" data-size="카드형">
                    <img class="slot-img hidden" alt="지역 게시판">
                    <div class="slot-default">
                        <div class="slot-text-wrap px-4 py-6 w-full">
                            <div
                                class="slot-text-body text-xl sm:text-2xl font-black text-gray-800 leading-relaxed whitespace-pre-line">
                            </div>
                            <div class="slot-hint text-base sm:text-lg text-gray-500 font-bold">클릭해서 설정</div>
                        </div>
                    </div>
                    <span class="slot-badge size">Card</span>
                    <span class="slot-badge store hidden"></span>
                </div>

                <div id="slot_index_season" class="neo-card slot-banner min-h-[140px] p-0" data-page="index"
                    data-position="index_season" data-label="계절 테마" data-size="카드형">
                    <img class="slot-img hidden" alt="계절 테마">
                    <div class="slot-default">
                        <div class="slot-text-wrap px-4 py-6 w-full">
                            <div
                                class="slot-text-body text-xl sm:text-2xl font-black text-gray-800 leading-relaxed whitespace-pre-line">
                            </div>
                            <div class="slot-hint text-base sm:text-lg text-gray-500 font-bold">클릭해서 설정</div>
                        </div>
                    </div>
                    <span class="slot-badge size">Card</span>
                    <span class="slot-badge store hidden"></span>
                </div>

                <div id="slot_index_newmember" class="neo-card slot-banner min-h-[140px] p-0" data-page="index"
                    data-position="index_newmember" data-label="신규회원 혜택" data-size="카드형">
                    <img class="slot-img hidden" alt="신규회원 혜택">
                    <div class="slot-default">
                        <div class="slot-text-wrap px-4 py-6 w-full">
                            <div
                                class="slot-text-body text-xl sm:text-2xl font-black text-gray-800 leading-relaxed whitespace-pre-line">
                            </div>
                            <div class="slot-hint text-base sm:text-lg text-gray-500 font-bold">클릭해서 설정</div>
                        </div>
                    </div>
                    <span class="slot-badge size">Card</span>
                    <span class="slot-badge store hidden"></span>
                </div>
            </div>
        </section>

        <!-- ✅ 검색어/최신소식/이벤트정보/추천제품 (텍스트 박스 크게) -->
        <section class="neo-card p-5">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-black text-gray-900">상단 서브 박스(텍스트 전용)</h2>
                <div class="text-xs text-gray-500 font-bold">Text 슬롯</div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 text-center">
                <!-- 검색어 -->
                <div>
                    <h3 class="font-black text-2xl sm:text-3xl mb-3">검색어</h3>
                    <div id="slot_index_sub_keywords" class="neo-card slot-banner min-h-[180px] sm:min-h-[220px] p-0"
                        data-page="index" data-position="index_sub_keywords" data-label="검색어" data-size="텍스트 영역">
                        <img class="slot-img hidden" alt="검색어">
                        <div class="slot-default">
                            <div class="slot-text-wrap px-4 py-6 w-full">
                                <div
                                    class="slot-text-body text-xl sm:text-2xl font-black text-gray-800 leading-relaxed whitespace-pre-line">
                                </div>
                                <div class="slot-hint text-base sm:text-lg text-gray-500 font-bold">텍스트 전용</div>
                            </div>
                        </div>
                        <span class="slot-badge size">Text</span>
                        <span class="slot-badge store hidden"></span>
                    </div>
                </div>

                <!-- 최신 소식 -->
                <div>
                    <h3 class="font-black text-2xl sm:text-3xl mb-3">최신 소식</h3>
                    <div id="slot_index_sub_news" class="neo-card slot-banner min-h-[180px] sm:min-h-[220px] p-0"
                        data-page="index" data-position="index_sub_news" data-label="최신 소식" data-size="텍스트 영역">
                        <img class="slot-img hidden" alt="최신 소식">
                        <div class="slot-default">
                            <div class="slot-text-wrap px-4 py-6 w-full">
                                <div
                                    class="slot-text-body text-xl sm:text-2xl font-black text-gray-800 leading-relaxed whitespace-pre-line">
                                </div>
                                <div class="slot-hint text-base sm:text-lg text-gray-500 font-bold">텍스트 전용</div>
                            </div>
                        </div>
                        <span class="slot-badge size">Text</span>
                        <span class="slot-badge store hidden"></span>
                    </div>
                </div>

                <!-- 이벤트 정보 -->
                <div>
                    <h3 class="font-black text-2xl sm:text-3xl mb-3">이벤트 정보</h3>
                    <div id="slot_index_sub_events" class="neo-card slot-banner min-h-[180px] sm:min-h-[220px] p-0"
                        data-page="index" data-position="index_sub_events" data-label="이벤트 정보" data-size="텍스트 영역">
                        <img class="slot-img hidden" alt="이벤트 정보">
                        <div class="slot-default">
                            <div class="slot-text-wrap px-4 py-6 w-full">
                                <div
                                    class="slot-text-body text-xl sm:text-2xl font-black text-gray-800 leading-relaxed whitespace-pre-line">
                                </div>
                                <div class="slot-hint text-base sm:text-lg text-gray-500 font-bold">텍스트 전용</div>
                            </div>
                        </div>
                        <span class="slot-badge size">Text</span>
                        <span class="slot-badge store hidden"></span>
                    </div>
                </div>

                <!-- 추천 제품 -->
                <div>
                    <h3 class="font-black text-2xl sm:text-3xl mb-3">추천 제품</h3>
                    <div id="slot_index_sub_recommends" class="neo-card slot-banner min-h-[180px] sm:min-h-[220px] p-0"
                        data-page="index" data-position="index_sub_recommends" data-label="추천 제품" data-size="텍스트 영역">
                        <img class="slot-img hidden" alt="추천 제품">
                        <div class="slot-default">
                            <div class="slot-text-wrap px-4 py-6 w-full">
                                <div
                                    class="slot-text-body text-xl sm:text-2xl font-black text-gray-800 leading-relaxed whitespace-pre-line">
                                </div>
                                <div class="slot-hint text-base sm:text-lg text-gray-500 font-bold">텍스트 전용</div>
                            </div>
                        </div>
                        <span class="slot-badge size">Text</span>
                        <span class="slot-badge store hidden"></span>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- ✅ footer -->
    <div id="footer-placeholder"></div>

    <!-- =========================
        ✅ 모달
  ========================== -->
    <div id="modalBackdrop">
        <div id="modal" class="p-6">
            <div class="flex items-start justify-between gap-4">
                <div>
                    <h2 class="text-2xl font-black text-gray-900">슬롯 편집</h2>
                    <div id="modalSlotInfo" class="text-sm text-gray-600 font-bold mt-1"></div>
                </div>
                <button id="closeModalBtn" class="btn ghost">닫기 ✕</button>
            </div>

            <div class="mt-5 flex flex-wrap gap-2">
                <button id="tabBanner" class="tab-btn active" type="button" data-tab="banner">Banner</button>
                <button id="tabStore" class="tab-btn" type="button" data-tab="store">Store</button>
                <button id="tabText" class="tab-btn" type="button" data-tab="text">Text</button>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
                <!-- 좌: 입력 -->
                <div class="space-y-5">
                    <input type="hidden" id="f_page" value="index" />
                    <input type="hidden" id="f_position" value="" />
                    <input type="hidden" id="f_slotType" value="banner" />
                    <input type="hidden" id="f_slotMode" value="banner" />

                    <!-- priority (옵션) -->
                    <div>
                        <label class="form-label">우선순위 (priority) - 비우면 기본 저장</label>
                        <input id="f_priority" class="input" type="number" min="1" placeholder="예: 1 (선택)" />
                        <div class="text-xs text-gray-500 font-semibold mt-1">
                            priority 입력 시 후보 테이블 방식(있을 때만)으로 저장될 수 있음
                        </div>
                    </div>

                    <!-- 이미지 -->
                    <div id="panelBanner">
                        <label class="form-label">이미지 업로드</label>
                        <input id="f_image" class="input" type="file" accept="image/*" />
                        <div class="flex items-center gap-3 mt-2">
                            <label class="inline-flex items-center gap-2 text-sm font-bold">
                                <input id="f_keepImage" type="checkbox" class="scale-110"> 기존 이미지 유지
                            </label>
                            <label class="inline-flex items-center gap-2 text-sm font-bold text-red-600">
                                <input id="f_clearImage" type="checkbox" class="scale-110"> 이미지 삭제
                            </label>
                        </div>
                    </div>

                    <!-- 링크 -->
                    <div>
                        <label class="form-label">링크 URL</label>
                        <input id="f_linkUrl" class="input" type="text" placeholder="/somepage.html 또는 https://..." />
                    </div>

                    <!-- 텍스트 -->
                    <div id="panelText" class="hidden">
                        <label class="form-label">텍스트 내용</label>
                        <textarea id="f_textContent" class="input" rows="7"
                            placeholder="여기에 텍스트를 입력하면 슬롯에 크게 표시됩니다."></textarea>
                    </div>

                    <!-- Store -->
                    <div id="panelStore" class="hidden">
                        <div class="neo-card p-4">
                            <div class="font-black text-gray-900 mb-2">가게 연결</div>

                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                <div>
                                    <label class="form-label">사업자번호(bizNo)</label>
                                    <input id="f_bizNoSearch" class="input" type="text" placeholder="예: 2910802895" />
                                </div>
                                <div>
                                    <label class="form-label">가게명 검색</label>
                                    <input id="f_nameSearch" class="input" type="text" placeholder="예: 미례헤어" />
                                </div>
                            </div>

                            <div class="flex gap-2 mt-3">
                                <button id="btnSearchStore" class="btn" type="button">검색</button>
                                <button id="btnClearStore" class="btn ghost" type="button">연결 해제</button>
                            </div>

                            <div id="storeResults" class="mt-3 space-y-2"></div>

                            <div class="mt-3 text-sm text-gray-700 font-bold">
                                선택된 가게:
                                <span id="selectedStoreText" class="font-black text-blue-700">없음</span>
                            </div>

                            <input type="hidden" id="f_storeId" />
                            <input type="hidden" id="f_businessNo" />
                            <input type="hidden" id="f_businessName" />
                        </div>
                    </div>

                    <!-- 기간 -->
                    <div class="neo-card p-4">
                        <div class="font-black text-gray-900 mb-3">광고 기간</div>

                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                            <div>
                                <label class="form-label">시작 (startAt)</label>
                                <input id="f_startAt" class="input" type="datetime-local" />
                            </div>
                            <div>
                                <label class="form-label">종료 (endAt)</label>
                                <input id="f_endAt" class="input" type="datetime-local" />
                            </div>
                        </div>

                        <div class="flex items-center gap-3 mt-3">
                            <label class="inline-flex items-center gap-2 text-sm font-black">
                                <input id="f_noEnd" type="checkbox" class="scale-110"> 종료 없음(noEnd)
                            </label>
                            <span id="noEndHint" class="text-sm text-gray-600 font-semibold"></span>
                        </div>
                    </div>

                    <div class="flex flex-wrap gap-2 pt-2">
                        <button id="btnSave" class="btn primary" type="button">저장</button>
                        <button id="btnDelete" class="btn danger" type="button">삭제</button>
                        <button id="btnReload" class="btn" type="button">다시 불러오기</button>
                    </div>

                    <div id="saveStatus" class="text-sm font-black"></div>
                </div>

                <!-- 우: 프리뷰 -->
                <div class="space-y-3">
                    <div class="font-black text-gray-900">미리보기</div>
                    <div id="previewBox"
                        class="neo-card overflow-hidden min-h-[280px] flex items-stretch justify-stretch">
                        <img id="previewImg" class="w-full h-full object-cover hidden" alt="preview">
                        <div id="previewText" class="w-full h-full p-6 flex items-center justify-center text-center">
                            <div
                                class="text-xl sm:text-2xl font-black text-gray-800 whitespace-pre-line leading-relaxed">
                                (미리보기)
                            </div>
                        </div>
                    </div>

                    <div class="text-xs text-gray-500 font-semibold">
                        - Banner: 이미지가 있으면 이미지 미리보기<br>
                        - Text: 텍스트가 크게 표시됨<br>
                        - Store: 링크/가게연결 저장 가능
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // ✅ header/footer
        fetch("/components/header.html").then(r => r.text()).then(d => {
            const el = document.getElementById("header-placeholder");
            if (el) el.innerHTML = d;
        });
        fetch("/components/footer.html").then(r => r.text()).then(d => {
            const el = document.getElementById("footer-placeholder");
            if (el) el.innerHTML = d;
        });

        /* =========================
           공통 유틸
        ========================== */
        const $ = (s) => document.querySelector(s);
        const $$ = (s) => Array.from(document.querySelectorAll(s));

        function safeTrim(v) { return (v ?? "").toString().trim(); }

        function isTextOnlyPosition(position) {
            return [
                "index_sub_keywords",
                "index_sub_news",
                "index_sub_events",
                "index_sub_recommends"
            ].includes(position);
        }

        function syncNoEndUI() {
            const noEnd = $("#f_noEnd").checked;
            const endAt = $("#f_endAt");
            const hint = $("#noEndHint");
            endAt.disabled = noEnd;
            hint.textContent = noEnd ? "종료일 입력이 비활성화됩니다." : "";
        }

        /* ✅ 텍스트 박스 렌더 (슬롯 내부 글자 크게 표시) */
        function renderTextBox(slotEl, text) {
            const body = slotEl.querySelector(".slot-text-body");
            const hint = slotEl.querySelector(".slot-hint");
            const t = (text || "").trim();

            if (body) body.textContent = t;
            if (hint) hint.classList.toggle("hidden", !!t);
        }

        function setSlotVisual(slotEl, slot) {
            const img = slotEl.querySelector(".slot-img");
            const def = slotEl.querySelector(".slot-default");
            const storeBadge = slotEl.querySelector(".slot-badge.store");

            const imageUrl = safeTrim(slot?.image_url);
            const text = safeTrim(slot?.text_content);
            const mode = safeTrim(slot?.slot_mode).toLowerCase();
            const type = safeTrim(slot?.slot_type).toLowerCase();

            // store badge
            if (storeBadge) {
                if (mode === "store") {
                    storeBadge.classList.remove("hidden");
                    storeBadge.textContent = (slot?.business_name || "STORE");
                } else {
                    storeBadge.classList.add("hidden");
                }
            }

            // ✅ Text 우선 표시 조건:
            // - type/mode가 text 이거나
            // - text-only 포지션이면
            const position = slotEl.dataset.position || "";
            const forceText = isTextOnlyPosition(position);

            const shouldText = forceText || type === "text" || mode === "text";

            if (shouldText) {
                // 이미지 숨김
                if (img) img.classList.add("hidden");
                if (def) def.classList.remove("hidden");

                renderTextBox(slotEl, text);
                return;
            }

            // Banner / Store: 이미지 있으면 이미지, 없으면 기본
            if (imageUrl) {
                if (img) {
                    img.src = imageUrl;
                    img.classList.remove("hidden");
                }
                if (def) def.classList.add("hidden");
            } else {
                if (img) img.classList.add("hidden");
                if (def) def.classList.remove("hidden");
                // 텍스트가 있더라도(간단) 기본영역에 표시하고 싶으면 여기서 renderTextBox 호출 가능
                renderTextBox(slotEl, text);
            }
        }

        function updatePreview() {
            const tab = $("#f_slotType").value;
            const link = $("#f_linkUrl").value;
            const text = $("#f_textContent").value;

            const file = $("#f_image").files?.[0] || null;

            const prevImg = $("#previewImg");
            const prevText = $("#previewText");

            // Text 탭이면 무조건 텍스트 미리보기 크게
            if (tab === "text") {
                prevImg.classList.add("hidden");
                prevText.classList.remove("hidden");
                prevText.innerHTML = `<div class="text-xl sm:text-2xl font-black text-gray-800 whitespace-pre-line leading-relaxed">${(text || "").replace(/</g, "&lt;")}</div>`;
                return;
            }

            // Banner/Store: 파일 있으면 파일 프리뷰
            if (file) {
                const url = URL.createObjectURL(file);
                prevImg.src = url;
                prevImg.classList.remove("hidden");
                prevText.classList.add("hidden");
                return;
            }

            // 파일 없으면 "텍스트" 또는 안내 표시
            prevImg.classList.add("hidden");
            prevText.classList.remove("hidden");
            prevText.innerHTML = `<div class="text-lg font-black text-gray-800 whitespace-pre-line leading-relaxed">(미리보기)\n${safeTrim(link) ? "링크: " + link : ""}</div>`;
        }

        function setActiveTab(tab) {
            // tab: banner | store | text
            $("#f_slotType").value = tab;
            $("#f_slotMode").value = tab;

            $("#tabBanner").classList.toggle("active", tab === "banner");
            $("#tabStore").classList.toggle("active", tab === "store");
            $("#tabText").classList.toggle("active", tab === "text");

            $("#panelBanner").classList.toggle("hidden", tab !== "banner" && tab !== "store");
            $("#panelStore").classList.toggle("hidden", tab !== "store");
            $("#panelText").classList.toggle("hidden", tab !== "text");

            updatePreview();
        }

        /* =========================
           슬롯 클릭 -> 모달 열기
        ========================== */
        const modalBackdrop = $("#modalBackdrop");
        const modalSlotInfo = $("#modalSlotInfo");

        function openModalForSlot(slotEl) {
            const page = slotEl.dataset.page || "index";
            const position = slotEl.dataset.position || "";
            const label = slotEl.dataset.label || position;
            const size = slotEl.dataset.size || "";

            // 기본 초기화
            $("#f_page").value = page;
            $("#f_position").value = position;

            $("#f_priority").value = "";
            $("#f_linkUrl").value = "";
            $("#f_textContent").value = "";

            $("#f_storeId").value = "";
            $("#f_businessNo").value = "";
            $("#f_businessName").value = "";
            $("#selectedStoreText").textContent = "없음";

            $("#f_image").value = "";
            $("#f_keepImage").checked = false;
            $("#f_clearImage").checked = false;

            $("#f_startAt").value = "";
            $("#f_endAt").value = "";
            $("#f_noEnd").checked = false;
            syncNoEndUI();

            modalSlotInfo.textContent = `${label} / position=${position} / ${size}`;

            // ✅ 텍스트 전용 포지션이면 기본 탭을 Text로
            if (isTextOnlyPosition(position)) {
                setActiveTab("text");
            } else {
                setActiveTab("banner");
            }

            modalBackdrop.style.display = "flex";
            updatePreview();

            loadSlotIntoModal(page, position);
        }

        function closeModal() {
            modalBackdrop.style.display = "none";
        }

        $("#closeModalBtn").addEventListener("click", closeModal);
        modalBackdrop.addEventListener("click", (e) => {
            if (e.target === modalBackdrop) closeModal();
        });

        // 탭 버튼
        $("#tabBanner").addEventListener("click", () => setActiveTab("banner"));
        $("#tabStore").addEventListener("click", () => setActiveTab("store"));
        $("#tabText").addEventListener("click", () => setActiveTab("text"));

        // 입력 변화 -> 프리뷰 갱신
        $("#f_image").addEventListener("change", updatePreview);
        $("#f_linkUrl").addEventListener("input", updatePreview);
        $("#f_textContent").addEventListener("input", updatePreview);

        $("#f_noEnd").addEventListener("change", syncNoEndUI);
        $("#f_clearImage").addEventListener("change", () => {
            if ($("#f_clearImage").checked) $("#f_keepImage").checked = false;
        });
        $("#f_keepImage").addEventListener("change", () => {
            if ($("#f_keepImage").checked) $("#f_clearImage").checked = false;
        });

        // 슬롯 클릭 연결
        $$(".slot-banner").forEach(el => {
            el.addEventListener("click", () => openModalForSlot(el));
        });

        /* =========================
           슬롯 불러오기/적용
        ========================== */
        async function fetchSlot(page, position, priority) {
            const qs = new URLSearchParams();
            qs.set("page", page);
            qs.set("position", position);
            if (priority) qs.set("priority", String(priority));

            const r = await fetch(`/manager/ad/slot?${qs.toString()}`);
            return await r.json();
        }

        async function loadSlotIntoModal(page, position) {
            const status = $("#saveStatus");
            status.textContent = "불러오는 중...";
            status.className = "text-sm font-black text-gray-700";

            try {
                const data = await fetchSlot(page, position, null);
                if (!data?.success) throw new Error(data?.error || "load fail");

                const slot = data.slot || {};

                // 탭 결정: slot_type/slot_mode 우선 + text-only 강제
                const forceText = isTextOnlyPosition(position);
                const mode = safeTrim(slot.slot_mode).toLowerCase();
                const type = safeTrim(slot.slot_type).toLowerCase();

                if (forceText) {
                    setActiveTab("text");
                } else if (type === "text" || mode === "text") {
                    setActiveTab("text");
                } else if (mode === "store") {
                    setActiveTab("store");
                } else {
                    setActiveTab("banner");
                }

                // 값 채우기
                $("#f_linkUrl").value = slot.link_url || "";
                $("#f_textContent").value = slot.text_content || "";

                $("#f_storeId").value = slot.store_id || "";
                $("#f_businessNo").value = slot.business_no || "";
                $("#f_businessName").value = slot.business_name || "";
                $("#selectedStoreText").textContent = slot.business_name ? `${slot.business_name} (${slot.business_no || ""})` : "없음";

                $("#f_startAt").value = slot.start_at_local || "";
                $("#f_endAt").value = slot.end_at_local || "";
                $("#f_noEnd").checked = !!slot.no_end;
                syncNoEndUI();

                // 이미지 체크박스 기본: 기존 유지 OFF (사용자가 선택)
                $("#f_keepImage").checked = false;
                $("#f_clearImage").checked = false;

                // 미리보기: image_url 있으면 이미지로 보여주고, text면 텍스트
                const tab = $("#f_slotType").value;
                if (tab !== "text" && safeTrim(slot.image_url)) {
                    $("#previewImg").src = slot.image_url;
                    $("#previewImg").classList.remove("hidden");
                    $("#previewText").classList.add("hidden");
                } else {
                    updatePreview();
                }

                status.textContent = "불러오기 완료";
                status.className = "text-sm font-black text-emerald-600";
            } catch (e) {
                console.error(e);
                status.textContent = "불러오기 실패";
                status.className = "text-sm font-black text-red-600";
            }
        }

        async function refreshAllSlots() {
            // 여기서는 화면에 있는 슬롯들만 각각 GET해서 반영
            const els = $$(".slot-banner");
            for (const el of els) {
                const page = el.dataset.page || "index";
                const position = el.dataset.position || "";
                if (!page || !position) continue;

                try {
                    const data = await fetchSlot(page, position, null);
                    if (data?.success) {
                        setSlotVisual(el, data.slot);
                    }
                } catch (e) {
                    // 조용히 무시
                }
            }
        }

        /* =========================
           저장/삭제
        ========================== */
        async function saveSlot() {
            const status = $("#saveStatus");
            status.textContent = "저장 중...";
            status.className = "text-sm font-black text-gray-700";

            const page = $("#f_page").value;
            const position = $("#f_position").value;

            const slotType = $("#f_slotType").value; // banner|store|text
            const slotMode = $("#f_slotMode").value;

            const priority = safeTrim($("#f_priority").value);
            const linkUrl = $("#f_linkUrl").value;
            const textContent = $("#f_textContent").value;

            const storeId = $("#f_storeId").value;
            const businessNo = $("#f_businessNo").value;
            const businessName = $("#f_businessName").value;

            const startAt = $("#f_startAt").value;
            const endAt = $("#f_endAt").value;
            const noEnd = $("#f_noEnd").checked;

            const keepImage = $("#f_keepImage").checked;
            const clearImage = $("#f_clearImage").checked;

            const file = $("#f_image").files?.[0] || null;

            const fd = new FormData();
            fd.append("page", page);
            fd.append("position", position);
            if (priority) fd.append("priority", priority);

            fd.append("slotType", slotType);
            fd.append("slotMode", slotMode);

            fd.append("linkUrl", linkUrl);
            fd.append("textContent", textContent);

            fd.append("storeId", storeId);
            fd.append("businessNo", businessNo);
            fd.append("businessName", businessName);

            fd.append("startAt", startAt);
            fd.append("endAt", endAt);
            fd.append("noEnd", noEnd ? "true" : "false");

            fd.append("keepImage", keepImage ? "true" : "false");
            fd.append("clearImage", clearImage ? "true" : "false");

            // ✅ multer Unexpected field 방지: 파일 필드명은 image로 통일
            if (file) fd.append("image", file);

            try {
                const r = await fetch("/manager/ad/slot", {
                    method: "POST",
                    body: fd
                });

                const data = await r.json().catch(() => ({}));
                if (!r.ok || !data?.success) {
                    console.error("save fail:", data);
                    status.textContent = `저장 실패: ${data?.error || r.status}`;
                    status.className = "text-sm font-black text-red-600";
                    return;
                }

                status.textContent = "저장 완료";
                status.className = "text-sm font-black text-emerald-600";

                // 저장된 값 화면에 반영
                await refreshAllSlots();

                // 모달 미리보기 동기화
                if (safeTrim(data.slot?.image_url) && $("#f_slotType").value !== "text") {
                    $("#previewImg").src = data.slot.image_url;
                    $("#previewImg").classList.remove("hidden");
                    $("#previewText").classList.add("hidden");
                } else {
                    updatePreview();
                }
            } catch (e) {
                console.error(e);
                status.textContent = "저장 실패(네트워크/서버)";
                status.className = "text-sm font-black text-red-600";
            }
        }

        async function deleteSlot() {
            const page = $("#f_page").value;
            const position = $("#f_position").value;
            const priority = safeTrim($("#f_priority").value);

            const qs = new URLSearchParams();
            qs.set("page", page);
            qs.set("position", position);
            if (priority) qs.set("priority", priority);

            const status = $("#saveStatus");
            status.textContent = "삭제 중...";
            status.className = "text-sm font-black text-gray-700";

            try {
                const r = await fetch(`/manager/ad/slot?${qs.toString()}`, { method: "DELETE" });
                const data = await r.json().catch(() => ({}));

                if (!r.ok || !data?.success) {
                    status.textContent = `삭제 실패: ${data?.error || r.status}`;
                    status.className = "text-sm font-black text-red-600";
                    return;
                }

                status.textContent = "삭제 완료";
                status.className = "text-sm font-black text-emerald-600";

                await refreshAllSlots();
                updatePreview();
            } catch (e) {
                console.error(e);
                status.textContent = "삭제 실패(네트워크/서버)";
                status.className = "text-sm font-black text-red-600";
            }
        }

        $("#btnSave").addEventListener("click", saveSlot);
        $("#btnDelete").addEventListener("click", deleteSlot);
        $("#btnReload").addEventListener("click", () => {
            loadSlotIntoModal($("#f_page").value, $("#f_position").value);
        });

        /* =========================
           Store 검색/선택
        ========================== */
        async function searchStore() {
            const bizNo = safeTrim($("#f_bizNoSearch").value);
            const q = safeTrim($("#f_nameSearch").value);

            const params = new URLSearchParams();
            if (bizNo) params.set("bizNo", bizNo);
            if (!bizNo && q) params.set("q", q);

            const box = $("#storeResults");
            box.innerHTML = `<div class="text-sm font-black text-gray-600">검색 중...</div>`;

            try {
                const r = await fetch(`/manager/ad/store/search?${params.toString()}`);
                const data = await r.json();

                if (!data?.ok) throw new Error(data?.error || "search fail");

                const list = data.stores || [];
                if (!list.length) {
                    box.innerHTML = `<div class="text-sm font-black text-gray-500">검색 결과 없음</div>`;
                    return;
                }

                box.innerHTML = "";
                for (const s of list) {
                    const btn = document.createElement("button");
                    btn.type = "button";
                    btn.className = "w-full text-left neo-card p-3 hover:translate-y-[-1px] transition";
                    btn.innerHTML = `
            <div class="font-black text-gray-900">${s.business_name || "(이름없음)"}</div>
            <div class="text-sm font-bold text-gray-600">biz: ${s.business_no || ""} / id: ${s.id || ""}</div>
          `;
                    btn.addEventListener("click", () => {
                        $("#f_storeId").value = s.id || "";
                        $("#f_businessNo").value = s.business_no || "";
                        $("#f_businessName").value = s.business_name || "";
                        $("#selectedStoreText").textContent = `${s.business_name || ""} (${s.business_no || ""})`;

                        // store 탭이면 링크를 자동으로 /ndetail 같은 형태로 넣고 싶으면 여기서 처리 가능
                        updatePreview();
                    });
                    box.appendChild(btn);
                }
            } catch (e) {
                console.error(e);
                box.innerHTML = `<div class="text-sm font-black text-red-600">검색 실패</div>`;
            }
        }

        $("#btnSearchStore").addEventListener("click", searchStore);
        $("#btnClearStore").addEventListener("click", () => {
            $("#f_storeId").value = "";
            $("#f_businessNo").value = "";
            $("#f_businessName").value = "";
            $("#selectedStoreText").textContent = "없음";
            $("#storeResults").innerHTML = "";
            updatePreview();
        });

        /* =========================
           최초: 슬롯들 불러오기
        ========================== */
        document.addEventListener("DOMContentLoaded", () => {
            syncNoEndUI();
            refreshAllSlots();
        });
    </script>
</body>

</html>