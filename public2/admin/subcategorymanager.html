<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>subcategory ë§¤ë‹ˆì €</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body {
            font-family: 'Noto Sans KR', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        /* ê´€ë¦¬ì í´ë¦­ìš© */
        .admin-slot {
            cursor: pointer;
            position: relative;
        }

        .admin-slot::after {
            content: "ê´€ë¦¬";
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 12px;
            font-weight: 900;
            padding: 6px 10px;
            border-radius: 9999px;
            background: rgba(255, 255, 255, 0.78);
            border: 1px solid rgba(59, 130, 246, 0.25);
            backdrop-filter: blur(8px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.08);
            color: rgba(30, 64, 175, 0.95);
            pointer-events: none;
        }

        /* ncategory2ì™€ ë™ì¼ */
        .neo-card {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 1.2rem;
            box-shadow: 6px 6px 16px #d9e0ec, -6px -6px 16px #ffffff;
            backdrop-filter: blur(16px) saturate(120%);
            transition: all .25s ease;
        }

        .neo-card:hover {
            transform: translateY(-4px);
            box-shadow: 4px 4px 12px #cfd8e6, -4px -4px 12px #ffffff, 0 8px 24px rgba(80, 130, 255, 0.15);
        }

        .btn-3d {
            background: linear-gradient(90deg, #6dd5fa, #2980b9);
            border-radius: 1.3rem;
            padding: .5rem 1.2rem;
            font-weight: bold;
            color: white;
            box-shadow: 0 4px 0 #2393b3, 0 8px 16px rgba(0, 64, 128, 0.14);
            transition: all .15s;
            user-select: none;
            white-space: nowrap;
        }

        .btn-3d:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #2393b3, 0 4px 10px rgba(0, 64, 128, 0.16);
        }

        .sidebar-scroll {
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: transparent transparent;
        }

        .sidebar-scroll:hover {
            scrollbar-color: #cbd5e1 transparent;
        }

        .sidebar-scroll::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar-scroll::-webkit-scrollbar-track {
            background: transparent;
        }

        .sidebar-scroll::-webkit-scrollbar-thumb {
            background: transparent;
            border-radius: 9999px;
        }

        .sidebar-scroll:hover::-webkit-scrollbar-thumb {
            background: #cbd5e1;
        }

        .sidebar-scroll::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* ê´€ë¦¬ì í´ë¦­ìš© */
        .admin-slot {
            cursor: pointer;
            position: relative;
        }

        .admin-slot::after {
            content: "ê´€ë¦¬";
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 12px;
            font-weight: 900;
            padding: 6px 10px;
            border-radius: 9999px;
            background: rgba(255, 255, 255, 0.78);
            border: 1px solid rgba(59, 130, 246, 0.25);
            backdrop-filter: blur(8px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.08);
            color: rgba(30, 64, 175, 0.95);
            pointer-events: none;
        }

        /* âœ… field/divider (ëª¨ë‹¬ ì…ë ¥ ê°€ì‹œì„± ë³´ì¥) */
        .field {
            width: 100%;
            padding: .65rem .85rem;
            border-radius: 1rem;
            border: 1px solid rgba(148, 163, 184, .75);
            background: rgba(255, 255, 255, 0.92);
            outline: none;
        }

        .field:focus {
            border-color: rgba(59, 130, 246, .85);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, .18);
        }

        .divider {
            height: 1px;
            background: rgba(148, 163, 184, 0.25);
            margin: 10px 0;
        }

        /* âœ… ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        #slotModal {
            position: fixed;
            inset: 0;
            z-index: 9999;
        }

        #slotModal .modal-backdrop {
            position: absolute;
            inset: 0;
            background: rgba(15, 23, 42, .55);
        }

        #slotModal .modal-panel {
            position: relative;
            margin: 0 auto;
            width: min(980px, calc(100% - 36px));
            max-height: 88vh;
            overflow: auto;
            top: 50%;
            transform: translateY(-50%);
        }

        #slotModal .modal-card {
            border-radius: 1.25rem;
            background: rgba(255, 255, 255, .96);
            border: 2px solid rgba(59, 130, 246, .18);
            box-shadow: 0 18px 60px rgba(0, 0, 0, .25);
            backdrop-filter: blur(14px);
            overflow: hidden;
        }
    </style>
</head>

<body class="bg-gradient-to-br from-blue-50 via-white to-blue-100 min-h-screen text-gray-800">
    <div id="header-placeholder"></div>

    <header class="py-6 text-center">
        <h1 class="text-3xl font-bold text-blue-700">ì„œë¸Œì¹´í…Œê³ ë¦¬ ë§¤ë‹ˆì €</h1>
        <p class="text-gray-600 mt-1">ìŠ¬ë¡¯ í´ë¦­ â†’ ëª¨ë‹¬ì—ì„œ ì´ë¯¸ì§€/ê°€ê²Œì—°ê²°/í…ìŠ¤íŠ¸/ê¸°ê°„/ìš°ì„ ìˆœìœ„ ì €ì¥</p>
    </header>

    <div class="max-w-6xl mx-auto grid grid-cols-12 gap-6 py-6 px-4">



        <!-- ì¢Œì¸¡ ì‚¬ì´ë“œë°” -->
        <aside class="col-span-3 neo-card p-3 h-full max-h-[1346px] sidebar-scroll">
            <h2 class="font-bold text-2xl mb-4 text-center">SUBCATEGORY</h2>

            <div class="neo-card p-3 mb-4">
                <div class="text-sm font-bold text-slate-700 mb-2">í˜„ì¬ êµ¬ë¶„</div>
                <div class="flex gap-2">
                    <button id="btnSourceCombined" type="button"
                        class="flex-1 rounded-xl px-3 py-2 text-sm font-bold border border-blue-200 bg-blue-600 text-white">
                        í†µí•©
                    </button>
                    <button id="btnSourceFood" type="button"
                        class="flex-1 rounded-xl px-3 py-2 text-sm font-bold border border-blue-200 bg-white text-blue-700 hover:bg-blue-50">
                        í‘¸ë“œ
                    </button>
                </div>
                <div class="text-[11px] text-slate-500 mt-2">
                    â€» ê°™ì€ ìŠ¬ë¡¯ì´ë¼ë„ êµ¬ë¶„(í†µí•©/í‘¸ë“œ)ì— ë”°ë¼ ì €ì¥ í‚¤(position)ê°€ ë¶„ë¦¬ë©ë‹ˆë‹¤.
                </div>
            </div>

            <!-- ì‚¬ì´ë“œ ê´‘ê³  ìŠ¬ë¡¯ -->
            <a href="#" class="neo-card mt-2 p-4 text-center border-2 border-dashed border-blue-300 admin-slot block"
                data-position="subcategory_sidebar_ad" data-label="ì‚¬ì´ë“œ ê´‘ê³ ">
                <h3 class="font-bold text-lg mb-2">ì‚¬ì´ë“œ ê´‘ê³ </h3>
                <p class="text-sm text-gray-600">ì´ê³³ì€ ê´‘ê³  ë°°ë„ˆ/ì´ë¯¸ì§€ê°€ ë“¤ì–´ê°ˆ ë°•ìŠ¤ì…ë‹ˆë‹¤.</p>
                <img data-role="img" src="" alt="ê´‘ê³  ì´ë¯¸ì§€" class="mt-3 w-full h-40 object-cover rounded-xl hidden">
                <div data-role="noimg" class="mt-3 text-xs text-slate-500">NO IMG</div>
            </a>
        </aside>

        <!-- ë©”ì¸ -->
        <main class="col-span-9 space-y-10">

            <!-- âœ… (ë°°ë„ˆ) ì‚¬ì´ë“œ ê´‘ê³  ìŠ¬ë¡¯: í•­ìƒ ë³´ì´ê²Œ ê³ ì • -->
            <a href="#" class="neo-card p-4 text-center border-2 border-dashed border-blue-300 admin-slot block"
                data-position="subcategory_sidebar_ad" data-label="ì‚¬ì´ë“œ ë°°ë„ˆ(ê´‘ê³ )">

                <h3 class="font-bold text-lg mb-2">ì‚¬ì´ë“œ ë°°ë„ˆ(ê´‘ê³ )</h3>
                <p class="text-sm text-gray-600">ì´ê³³ì€ ê´‘ê³  ë°°ë„ˆ/ì´ë¯¸ì§€ê°€ ë“¤ì–´ê°ˆ ë°•ìŠ¤ì…ë‹ˆë‹¤.</p>

                <!-- ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ í‘œì‹œ -->
                <img data-role="img" src="" alt="ê´‘ê³  ì´ë¯¸ì§€" class="mt-3 w-full h-40 object-cover rounded-xl hidden">

                <!-- ì´ë¯¸ì§€ ì—†ìœ¼ë©´ NO IMG -->
                <div data-role="noimg" class="mt-3 text-xs text-slate-500">NO IMG</div>
            </a>

            <!-- âœ… 1) All of the items (ê¸°ë³¸ 8 + ë”ë³´ê¸° 4) -->
            <section class="mt-2">
                <div class="flex items-center justify-between">
                    <h2 class="font-bold text-2xl text-slate-800">All of the items</h2>
                    <button id="btnToggleAllMore" type="button"
                        class="rounded-xl px-4 py-2 border border-slate-200 bg-white/70 hover:bg-white text-sm font-bold">
                        ë”ë³´ê¸° (4)
                    </button>
                </div>

                <div id="allGrid" class="mt-3 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6"></div>

                <div id="allMorePanel" class="mt-3 hidden neo-card p-4">
                    <div class="text-sm font-bold text-slate-700 mb-3">ì¶”ê°€ ìŠ¬ë¡¯(4)</div>
                    <div id="allMoreGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6"></div>
                </div>
            </section>

            <!-- âœ… 2) Best Seller (ê¸°ë³¸ 8 + ë”ë³´ê¸° 4) -->
            <section class="mt-2">
                <div class="flex items-center justify-between">
                    <h2 class="font-bold text-2xl text-amber-700">Best Seller</h2>
                    <button id="btnToggleBestMore" type="button"
                        class="rounded-xl px-4 py-2 border border-amber-200 bg-amber-50 hover:bg-amber-100 text-sm font-bold">
                        ë”ë³´ê¸° (4)
                    </button>
                </div>

                <div id="bestSellerGrid" class="mt-3 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6"></div>

                <div id="bestMorePanel" class="mt-3 hidden neo-card p-4">
                    <div class="text-sm font-bold text-slate-700 mb-3">ì¶”ê°€ ìŠ¬ë¡¯(4)</div>
                    <div id="bestMoreGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6"></div>
                </div>
            </section>

            <!-- âœ… 3) New registration (ê¸°ë³¸ 8 + ë”ë³´ê¸° 4) -->
            <section class="mt-2">
                <div class="flex items-center justify-between">
                    <h2 class="font-bold text-2xl text-emerald-700">New registration</h2>
                    <button id="btnToggleNewMore" type="button"
                        class="rounded-xl px-4 py-2 border border-emerald-200 bg-emerald-50 hover:bg-emerald-100 text-sm font-bold">
                        ë”ë³´ê¸° (4)
                    </button>
                </div>

                <div id="newRegGrid" class="mt-3 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6"></div>

                <div id="newMorePanel" class="mt-3 hidden neo-card p-4">
                    <div class="text-sm font-bold text-slate-700 mb-3">ì¶”ê°€ ìŠ¬ë¡¯(4)</div>
                    <div id="newMoreGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6"></div>
                </div>
            </section>

            <div id="footer-placeholder"></div>

            <!-- âœ… ê³µí†µ ëª¨ë‹¬ -->
            <div id="slotModal" class="hidden" data-page="" data-position="" data-current-image="">
                <div class="modal-backdrop"></div>
                <div class="modal-panel">
                    <div class="modal-card">

                        <!-- í—¤ë” -->
                        <div class="p-6 sticky top-0 bg-white/90 backdrop-blur border-b border-slate-100 z-10">
                            <div class="flex items-start justify-between gap-4">
                                <div>
                                    <h3 id="modalTitle" class="text-xl sm:text-2xl font-extrabold">ìŠ¬ë¡¯ ìˆ˜ì •</h3>
                                    <p class="text-xs text-gray-500 mt-1">
                                        page: <b>subcategory</b> /
                                        position: <span id="modalPositionText" class="font-semibold"></span>
                                    </p>
                                    <p class="text-[11px] text-slate-500 mt-1">
                                        í˜„ì¬ êµ¬ë¶„: <span id="modalSourceText" class="font-bold text-slate-700">í†µí•©</span>
                                    </p>
                                </div>

                                <div class="flex items-center gap-2">
                                    <!-- ì‚¬ìš©ë²• -->
                                    <div class="relative">
                                        <button type="button" id="adHelpBtn"
                                            class="inline-flex items-center gap-2 rounded-xl border border-blue-200 bg-white/80 px-3 py-1.5 text-sm font-semibold text-blue-700 shadow-sm hover:bg-white"
                                            aria-expanded="false" aria-controls="adHelpPopover" title="ì‚¬ìš©ë²• ë³´ê¸°">
                                            <span
                                                class="inline-flex h-5 w-5 items-center justify-center rounded-full bg-blue-600 text-white text-xs leading-none">?</span>
                                            ì‚¬ìš©ë²•
                                        </button>

                                        <div id="adHelpPopover"
                                            class="hidden absolute right-0 mt-2 w-[min(420px,calc(100vw-2rem))] rounded-2xl border border-blue-200 bg-white/95 p-4 shadow-xl backdrop-blur">
                                            <div class="flex items-start justify-between gap-3">
                                                <div class="font-extrabold text-slate-800">âœ… ì‚¬ìš© íë¦„</div>
                                                <button type="button" id="adHelpCloseBtn"
                                                    class="rounded-lg px-2 py-1 text-xs font-bold text-slate-500 hover:bg-slate-100">ë‹«ê¸°</button>
                                            </div>

                                            <ol
                                                class="mt-3 space-y-2 text-sm text-slate-700 leading-relaxed list-decimal pl-5">
                                                <li>ì›í•˜ëŠ” ìŠ¬ë¡¯ í´ë¦­ â†’ <b>ëª¨ë‹¬ ì—´ë¦¼</b></li>
                                                <li><b>ìš°ì„ ìˆœìœ„</b> ì„ íƒ/ì…ë ¥</li>
                                                <li><b>ì´ë¯¸ì§€/ê°€ê²Œì—°ê²°/í…ìŠ¤íŠ¸</b> ì¤‘ íƒ1 â†’ ê¸°ê°„ ì„¤ì •</li>
                                                <li><b>ìŠ¬ë¡¯ ì €ì¥</b></li>
                                            </ol>

                                            <div class="mt-3 rounded-xl bg-blue-50 px-3 py-2 text-xs text-blue-900">
                                                â€» ì‹¤ì œ ë…¸ì¶œì€ â€œê¸°ê°„ ì¡°ê±´ì´ ë§ëŠ” í›„ë³´ ì¤‘ ìš°ì„ ìˆœìœ„ ìˆ«ìê°€ ê°€ì¥ ì‘ì€ ê²ƒâ€ì´ ì„ íƒë©ë‹ˆë‹¤.
                                            </div>
                                        </div>
                                    </div>

                                    <button id="btnCloseModal"
                                        class="px-3 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-slate-700 text-sm">
                                        ë‹«ê¸°
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- ë³¸ë¬¸ -->
                        <div class="p-6 space-y-6">

                            <!-- í†µí•©/í‘¸ë“œ ì„ íƒ -->
                            <div class="rounded-xl border border-slate-100 bg-slate-50 p-4">
                                <p class="text-sm font-semibold mb-3">êµ¬ë¶„ ì„ íƒ (í†µí•© / í‘¸ë“œ)</p>
                                <div class="flex gap-2">
                                    <button id="modalBtnSourceCombined" type="button"
                                        class="flex-1 rounded-xl px-3 py-2 text-sm font-bold border border-blue-200 bg-blue-600 text-white">
                                        í†µí•©
                                    </button>
                                    <button id="modalBtnSourceFood" type="button"
                                        class="flex-1 rounded-xl px-3 py-2 text-sm font-bold border border-blue-200 bg-white text-blue-700 hover:bg-blue-50">
                                        í‘¸ë“œ
                                    </button>
                                </div>
                                <div class="text-[11px] text-slate-500 mt-2">
                                    â€» ì—¬ê¸°ì„œ êµ¬ë¶„ì„ ë°”ê¾¸ë©´ <b>position í‚¤ê°€ ìë™ ë³€ê²½</b>ë˜ì–´ ì €ì¥ì´ ê¼¬ì´ì§€ ì•ŠìŠµë‹ˆë‹¤.
                                </div>
                            </div>

                            <!-- í…ìŠ¤íŠ¸ ì „ìš© ìŠ¬ë¡¯ ì•ˆë‚´ -->
                            <div id="textOnlyHint" class="hidden rounded-2xl border border-slate-100 bg-slate-50 p-4">
                                <div class="text-sm font-bold text-slate-800">ğŸ“ ì´ ìŠ¬ë¡¯ì€ í…ìŠ¤íŠ¸ ì „ìš©ì…ë‹ˆë‹¤.</div>
                                <div class="mt-1 text-xs text-slate-500">
                                    ì´ë¯¸ì§€/ê°€ê²Œì—°ê²°/ë§í¬ ì…ë ¥ì€ ìˆ¨ê¹€ ì²˜ë¦¬ë©ë‹ˆë‹¤. (ê¸€ë§Œ ì‘ì„±)
                                </div>
                            </div>

                            <!-- ëª¨ë“œ ì„ íƒ -->
                            <div id="modeBlock" class="rounded-xl border border-slate-100 bg-slate-50 p-4">
                                <p class="text-sm font-semibold mb-3">ê´‘ê³  ë°©ì‹ ì„ íƒ</p>
                                <div class="flex flex-wrap gap-4">
                                    <label class="flex items-center gap-2 text-sm">
                                        <input type="radio" name="slotMode" value="image" class="accent-blue-600"
                                            checked>
                                        <span>ì´ë¯¸ì§€ ë°°ë„ˆ</span>
                                    </label>
                                    <label class="flex items-center gap-2 text-sm">
                                        <input type="radio" name="slotMode" value="store" class="accent-emerald-600">
                                        <span>ê°€ê²Œ ì—°ê²°</span>
                                    </label>
                                    <label class="flex items-center gap-2 text-sm">
                                        <input type="radio" name="slotMode" value="text" class="accent-indigo-600">
                                        <span>í…ìŠ¤íŠ¸ ì „ìš©</span>
                                    </label>
                                </div>
                            </div>

                            <!-- í…ìŠ¤íŠ¸ ì…ë ¥ -->
                            <div id="textBlock" class="hidden space-y-2">
                                <label class="text-sm font-semibold">ë‚´ìš© (í…ìŠ¤íŠ¸)</label>
                                <textarea id="fieldTextContent" class="field mt-2 min-h-[180px] resize-y"
                                    placeholder="ì˜ˆ) í•œ ì¤„ë‹¹ 1ê°œì”© ì…ë ¥&#10;ì²«ë²ˆì§¸ ì¤„&#10;ë‘ë²ˆì§¸ ì¤„&#10;ì„¸ë²ˆì§¸ ì¤„"></textarea>
                                <p class="text-xs text-gray-500">
                                    ì¤„ë°”ê¿ˆ(Enter) ê¸°ì¤€ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.
                                </p>
                            </div>

                            <!-- ë§í¬ -->
                            <div id="linkBlock">
                                <label class="text-sm font-semibold">ë§í¬ URL (ì„ íƒ)</label>
                                <input id="fieldLinkUrl" class="field mt-2"
                                    placeholder="/ndetail.html?id=123&type=combined ë˜ëŠ” https://..." />
                            </div>

                            <div id="dividerAfterLink" class="divider"></div>

                            <!-- ì´ë¯¸ì§€ ë¸”ë¡ -->
                            <div id="imageBlock" class="space-y-4">
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div>
                                        <label class="text-sm font-semibold">ì´ë¯¸ì§€ íŒŒì¼</label>
                                        <input id="fieldImageFile" type="file" accept="image/*"
                                            class="field mt-2 bg-white" />
                                        <p class="text-xs text-gray-500 mt-1">
                                            íŒŒì¼ì„ ì„ íƒí•˜ì§€ ì•Šìœ¼ë©´, ê¸°ì¡´ ì´ë¯¸ì§€ë¥¼ ìœ ì§€í•©ë‹ˆë‹¤.
                                        </p>
                                    </div>
                                    <div>
                                        <label class="text-sm font-semibold">í˜„ì¬ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°</label>
                                        <div
                                            class="mt-2 rounded-lg border border-gray-100 bg-gray-50 overflow-hidden aspect-[16/9] flex items-center justify-center">
                                            <img id="currentPreviewImg" src="" alt="preview"
                                                class="w-full h-full object-cover hidden" />
                                            <span id="currentPreviewEmpty" class="text-xs text-gray-400">ì´ë¯¸ì§€ ì—†ìŒ</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- ê°€ê²Œ ì—°ê²° ë¸”ë¡ -->
                            <div id="storeBlock" class="space-y-4 hidden">
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div>
                                        <label class="text-sm font-semibold">ì‚¬ì—…ìë²ˆí˜¸</label>
                                        <input id="fieldBizNo" class="field mt-2" placeholder="ì˜ˆ) 2910802895" />
                                    </div>
                                    <div>
                                        <label class="text-sm font-semibold">ìƒí˜¸ëª…</label>
                                        <input id="fieldBizName" class="field mt-2" placeholder="ì˜ˆ) í•˜ëŠ˜ì‹ë‹¹" />
                                    </div>
                                </div>

                                <div class="flex items-center gap-2">
                                    <button id="btnSearchStore"
                                        class="px-4 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white text-sm">
                                        ê°€ê²Œ ê²€ìƒ‰
                                    </button>
                                    <span id="storeSearchHint" class="text-xs text-gray-500"></span>
                                </div>

                                <div id="storeResults" class="border border-slate-100 rounded-xl overflow-hidden">
                                    <div class="px-4 py-3 bg-slate-50 text-sm font-semibold">ê²€ìƒ‰ ê²°ê³¼</div>
                                    <div id="storeResultsBody" class="p-4 text-sm text-gray-500">
                                        ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ê³  â€œê°€ê²Œ ê²€ìƒ‰â€ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.
                                    </div>
                                </div>

                                <input id="fieldStoreId" type="hidden" />
                                <input id="fieldTableSource" type="hidden" />
                            </div>

                            <div class="divider"></div>

                            <!-- ìš°ì„ ìˆœìœ„ -->
                            <div class="mt-4 p-3 rounded-xl border border-blue-100 bg-white/70">
                                <div class="flex flex-col md:flex-row md:items-end gap-3">
                                    <div class="flex-1">
                                        <label class="text-sm font-semibold text-gray-700">ìš°ì„ ìˆœìœ„</label>
                                        <input id="adPriority" type="number" min="1" step="1" value="1"
                                            class="mt-1 w-full rounded-xl border border-gray-200 px-3 py-2 outline-none focus:ring-2 focus:ring-blue-300" />
                                        <p class="mt-1 text-xs text-gray-500">
                                            1ì´ ê°€ì¥ ë¨¼ì € ë…¸ì¶œë©ë‹ˆë‹¤. (1,2,3â€¦ ì—¬ëŸ¬ ê°œ ë“±ë¡ ê°€ëŠ¥)
                                        </p>
                                    </div>

                                    <button type="button" id="btnLoadPriority"
                                        class="rounded-xl px-4 py-2 border border-blue-200 bg-blue-50 hover:bg-blue-100 text-sm">
                                        ì´ ìš°ì„ ìˆœìœ„ ë¶ˆëŸ¬ì˜¤ê¸°
                                    </button>

                                    <button type="button" id="btnDeletePriority"
                                        class="rounded-xl px-4 py-2 border border-red-200 bg-red-50 hover:bg-red-100 text-sm">
                                        ì´ ìš°ì„ ìˆœìœ„ ì‚­ì œ
                                    </button>
                                </div>

                                <details class="mt-3">
                                    <summary class="cursor-pointer text-sm text-gray-700">ë“±ë¡ëœ í›„ë³´ ëª©ë¡ ë³´ê¸°</summary>
                                    <div id="candidateList" class="mt-2 grid gap-2"></div>
                                </details>

                                <div id="prioritySupportHint" class="mt-3 text-xs text-slate-500"></div>
                            </div>

                            <!-- ê¸°ê°„ -->
                            <div class="rounded-xl border border-slate-100 p-4">
                                <div class="flex items-center justify-between">
                                    <p class="text-sm font-semibold">ê´‘ê³  ê¸°ê°„ ì„¤ì •</p>
                                    <label class="flex items-center gap-2 text-xs">
                                        <input id="fieldNoEnd" type="checkbox" class="accent-blue-600">
                                        <span class="text-gray-700">ê³„ì† ìœ ì§€ (ì¢…ë£Œ ì—†ìŒ)</span>
                                    </label>
                                </div>

                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4">
                                    <div>
                                        <label class="text-xs font-semibold text-gray-600">ì‹œì‘ ì¼ì‹œ</label>
                                        <input id="fieldStartAt" type="datetime-local" class="field mt-2" />
                                    </div>
                                    <div>
                                        <label class="text-xs font-semibold text-gray-600">ì¢…ë£Œ ì¼ì‹œ</label>
                                        <input id="fieldEndAt" type="datetime-local" class="field mt-2" />
                                    </div>
                                </div>
                            </div>

                            <!-- ìš”ì•½ -->
                            <div class="rounded-xl border border-slate-100 bg-slate-50 p-4">
                                <p class="text-sm font-semibold mb-2">í˜„ì¬ ì„ íƒ ì •ë³´</p>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm">
                                    <div class="flex items-center gap-2">
                                        <span class="text-gray-500">ì„ íƒ ì´ë¯¸ì§€:</span>
                                        <span id="textSelectedImage" class="font-semibold text-slate-800">ì—†ìŒ</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="text-gray-500">ì—°ê²° ê°€ê²Œ:</span>
                                        <span id="textSelectedStore" class="font-semibold text-slate-800">ì—†ìŒ</span>
                                    </div>
                                </div>

                                <div id="modalStatus" class="mt-3 text-xs text-slate-600"></div>
                            </div>

                            <!-- ë²„íŠ¼ -->
                            <div class="flex flex-col sm:flex-row gap-2 sm:justify-end">
                                <button id="btnResetModal"
                                    class="px-4 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-slate-700 text-sm">
                                    ì…ë ¥ ì´ˆê¸°í™”(ì‚­ì œ)
                                </button>
                                <button id="btnSaveSlot"
                                    class="px-5 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold">
                                    ìŠ¬ë¡¯ ì €ì¥
                                </button>
                            </div>

                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        // =========================
        // âœ… ê³µí†µ ìœ í‹¸ / í—¤ë”í‘¸í„°
        // =========================
        const el = (id) => document.getElementById(id);
        const clean = (v) => (v == null ? "" : String(v).trim());
        const digitsOnly = (v) => clean(v).replace(/[^\d]/g, "");

        (async () => {
            try {
                const h = await fetch("/components/header.html").then((r) => r.text());
                const hp = el("header-placeholder");
                if (hp) hp.innerHTML = h;
            } catch (_) { }
            try {
                const f = await fetch("/components/footer.html").then((r) => r.text());
                const fp = el("footer-placeholder");
                if (fp) fp.innerHTML = f;
            } catch (_) { }
        })();

        function setImg(imgEl, src) {
            if (!imgEl) return;
            imgEl.src = src || "/uploads/no-image.png";
            imgEl.onerror = () => {
                imgEl.onerror = null;
                imgEl.src = "/uploads/no-image.png";
            };
        }

        // =========================
        // âœ… API ì„¤ì •
        // =========================
        const API_BASE = "/subcategorymanager/ad";
        const PAGE = "subcategory";

        // âœ… í†µí•©/í‘¸ë“œ êµ¬ë¶„: position í‚¤ë¥¼ ë¶„ë¦¬í•´ì„œ ì €ì¥
        let CURRENT_SOURCE = "combined"; // "combined" | "food"

        function sourceLabel(src) {
            return src === "food" ? "í‘¸ë“œ" : "í†µí•©";
        }

        function tableSourceFromSource(src) {
            return src === "food" ? "food_stores" : "combined_store_info";
        }

        function buildPosition(basePosition, src) {
            const s = src || CURRENT_SOURCE || "combined";
            return `${basePosition}__${s}`;
        }

        function buildStoreLink(tableSource, storeId) {
            const t = clean(tableSource);
            const id = clean(storeId);
            if (!id) return "#";
            if (t === "food_stores" || t === "food") return `/ndetail.html?id=${encodeURIComponent(id)}&type=food`;
            return `/ndetail.html?id=${encodeURIComponent(id)}&type=combined`;
        }

        async function fetchJson(url, opt = {}) {
            const r = await fetch(url, opt);
            const data = await r.json().catch(() => ({}));
            if (!r.ok) throw new Error(data?.error || data?.message || `HTTP ${r.status}`);
            return data;
        }

        async function apiGetSlot({ page, position, priority }) {
            const url = new URL(`${API_BASE}/slot`, window.location.origin);
            if (page) url.searchParams.set("page", page);
            if (position) url.searchParams.set("position", position);
            if (priority !== "" && priority != null) url.searchParams.set("priority", String(priority));
            return await fetchJson(url.toString());
        }

        async function apiUpsertSlot(formData) {
            const data = await fetchJson(`${API_BASE}/update`, { method: "POST", body: formData });
            if (!data || data.success !== true) throw new Error(data?.error || "ì €ì¥ ì‹¤íŒ¨");
            return data.slot || null;
        }

        async function apiDeleteSlot({ page, position, priority }) {
            const url = new URL(`${API_BASE}/delete`, window.location.origin);
            if (page) url.searchParams.set("page", page);
            if (position) url.searchParams.set("position", position);
            if (priority !== "" && priority != null) url.searchParams.set("priority", String(priority));
            return await fetchJson(url.toString(), { method: "DELETE" });
        }

        async function apiCandidates({ page, position }) {
            const url = new URL(`${API_BASE}/candidates`, window.location.origin);
            if (page) url.searchParams.set("page", page);
            if (position) url.searchParams.set("position", position);
            const data = await fetchJson(url.toString());
            if (data?.success === true) return data.items || data.candidates || [];
            if (Array.isArray(data?.items)) return data.items;
            if (Array.isArray(data?.candidates)) return data.candidates;
            if (Array.isArray(data)) return data;
            return [];
        }

        // âœ… ì„œë²„ì™€ ë§ì¶°ì„œ mode/pageSizeë¥¼ ë³´ëƒ„
        async function apiSearchStore(q, src, pageSize = 12) {
            const qs = new URLSearchParams();
            qs.set("q", q);
            qs.set("mode", src || CURRENT_SOURCE);
            qs.set("pageSize", String(pageSize));

            const url = `${API_BASE}/search?${qs.toString()}`;
            const res = await fetch(url);
            if (!res.ok) throw new Error(`ê²€ìƒ‰ ì‹¤íŒ¨: HTTP ${res.status}`);
            const data = await res.json().catch(() => ({}));
            return data.stores || data.items || data.results || [];
        }

        // =========================
        // âœ… í˜ì´ì§€ ìŠ¬ë¡¯ DOM (ê° ì„¹ì…˜ 12ê°œ: 8 + ë”ë³´ê¸°4)
        // =========================
        const ALL_POS_BASE = Array.from({ length: 12 }, (_, i) => `subcategory_all_${i + 1}`);
        const BESTSELLER_POS_BASE = Array.from({ length: 12 }, (_, i) => `subcategory_best_seller_${i + 1}`);
        const NEWREG_POS_BASE = Array.from({ length: 12 }, (_, i) => `subcategory_new_registration_${i + 1}`);

        const state = {
            slots: new Map(),
            current: { page: PAGE, basePosition: "", position: "", priority: "1" },
        };

        function makeSlotCard(basePosition, label, imgHClass = "h-40") {
            const wrap = document.createElement("div");
            wrap.className = "neo-card p-0 overflow-hidden relative rounded-2xl border-2 border-blue-200 admin-slot";
            wrap.setAttribute("data-position", basePosition);
            wrap.setAttribute("data-label", label);
            wrap.innerHTML = `
        <div class="w-full ${imgHClass} bg-white/40 flex items-center justify-center">
          <img data-role="img" src="" alt="${label}" class="w-full h-full object-cover hidden">
          <div data-role="noimg" class="text-xs text-slate-500">NO IMG</div>
        </div>
        <div class="px-3 py-3">
          <div class="font-extrabold text-slate-800 truncate" data-role="name">${label}</div>
          <div class="text-xs text-slate-600 mt-1 truncate" data-role="category">ì—…ì¢…:</div>
        </div>
      `;
            return wrap;
        }

        function applySlotToEl(slotEl, slot) {
            if (!slotEl) return;

            const img = slotEl.querySelector('[data-role="img"]');
            const noimg = slotEl.querySelector('[data-role="noimg"]');
            const name = slotEl.querySelector('[data-role="name"]');
            const category = slotEl.querySelector('[data-role="category"]');
            const desc = slotEl.querySelector('[data-role="desc"]');

            const label = clean(slotEl.getAttribute("data-label") || "");
            const hasSlot = !!slot;

            const imageUrl = hasSlot ? clean(slot?.image_url || slot?.imageUrl || "") : "";
            const businessName = hasSlot
                ? (clean(slot?.business_name || slot?.businessName || "") || label)
                : label;

            const cat = hasSlot ? clean(slot?.category || slot?.business_category || slot?.business_type || "") : "";
            const textContent = hasSlot ? clean(slot?.text_content || slot?.textContent || "") : "";

            if (img) {
                const defaultSrc = clean(img.getAttribute("data-default-src") || "");
                const finalSrc = imageUrl || defaultSrc;

                if (finalSrc) {
                    img.src = finalSrc;
                    img.classList.remove("hidden");
                    if (noimg) noimg.classList.add("hidden");
                    img.onerror = () => {
                        img.onerror = null;
                        img.src = "/uploads/no-image.png";
                    };
                } else {
                    img.src = "";
                    img.classList.add("hidden");
                    if (noimg) noimg.classList.remove("hidden");
                }
            }

            if (name) name.textContent = businessName || "";
            if (category) category.textContent = cat ? `ì—…ì¢…: ${cat}` : "ì—…ì¢…:";
            if (desc) desc.textContent = textContent || desc.textContent || "";

            const a = slotEl.closest("a");
            if (a) {
                const link = hasSlot ? clean(slot?.link_url || slot?.linkUrl || "") : "";
                a.href = link || "#";
            }
        }

        function buildGridInto(containerId, basePositions, labelPrefix) {
            const grid = el(containerId);
            if (!grid) return;
            grid.innerHTML = "";
            basePositions.forEach((bp, idx) => {
                const a = document.createElement("a");
                a.href = "#";
                a.className = "block";
                a.appendChild(makeSlotCard(bp, `${labelPrefix} ${idx + 1}`, "h-40"));
                grid.appendChild(a);
            });
        }

        function buildGrids() {
            // ê¸°ë³¸ 8
            buildGridInto("allGrid", ALL_POS_BASE.slice(0, 8), "All");
            buildGridInto("bestSellerGrid", BESTSELLER_POS_BASE.slice(0, 8), "Best");
            buildGridInto("newRegGrid", NEWREG_POS_BASE.slice(0, 8), "New");

            // ë”ë³´ê¸° 4
            buildGridInto("allMoreGrid", ALL_POS_BASE.slice(8, 12), "All+");
            buildGridInto("bestMoreGrid", BESTSELLER_POS_BASE.slice(8, 12), "Best+");
            buildGridInto("newMoreGrid", NEWREG_POS_BASE.slice(8, 12), "New+");
        }

        async function loadAndRender() {
            const els = Array.from(document.querySelectorAll("[data-position]"));
            const basePositions = [...new Set(els.map(x => clean(x.getAttribute("data-position"))).filter(Boolean))];

            const positions = basePositions.map(bp => buildPosition(bp, CURRENT_SOURCE));

            const settled = await Promise.allSettled(
                positions.map(async (pos) => {
                    try {
                        const data = await apiGetSlot({ page: PAGE, position: pos, priority: 1 });
                        const slot = data?.slot ?? data ?? null;
                        return { pos, slot };
                    } catch (_) {
                        return { pos, slot: null };
                    }
                })
            );

            state.slots.clear();
            for (const r of settled) {
                if (r.status === "fulfilled") {
                    const { pos, slot } = r.value;
                    if (slot) state.slots.set(pos, slot);
                }
            }

            els.forEach((slotEl) => {
                const bp = clean(slotEl.getAttribute("data-position"));
                const pos = buildPosition(bp, CURRENT_SOURCE);
                applySlotToEl(slotEl, state.slots.get(pos));
            });
        }

        // =========================
        // âœ… ëª¨ë‹¬ ë¡œì§ (ì›ë³¸ ê·¸ëŒ€ë¡œ)
        // =========================
        function setModalStatus(msg) {
            const s = el("modalStatus");
            if (s) s.textContent = msg || "";
        }

        function setPreview(url) {
            const img = el("currentPreviewImg");
            const empty = el("currentPreviewEmpty");
            if (!img || !empty) return;

            const u = clean(url);
            if (u) {
                img.src = u;
                img.classList.remove("hidden");
                empty.classList.add("hidden");
            } else {
                img.src = "";
                img.classList.add("hidden");
                empty.classList.remove("hidden");
            }
        }

        function setSelectedSummary({ imageUrl, storeText }) {
            if (el("textSelectedImage")) el("textSelectedImage").textContent = imageUrl ? "ìˆìŒ" : "ì—†ìŒ";
            if (el("textSelectedStore")) el("textSelectedStore").textContent = storeText || "ì—†ìŒ";
        }

        function getMode() {
            return document.querySelector('input[name="slotMode"]:checked')?.value || "image";
        }

        function applyModeUI(mode) {
            const textOnlyHint = el("textOnlyHint");
            const textBlock = el("textBlock");
            const linkBlock = el("linkBlock");
            const dividerAfterLink = el("dividerAfterLink");
            const imageBlock = el("imageBlock");
            const storeBlock = el("storeBlock");

            if (mode === "text") {
                if (textOnlyHint) textOnlyHint.classList.remove("hidden");
                if (textBlock) textBlock.classList.remove("hidden");
                if (linkBlock) linkBlock.classList.add("hidden");
                if (dividerAfterLink) dividerAfterLink.classList.add("hidden");
                if (imageBlock) imageBlock.classList.add("hidden");
                if (storeBlock) storeBlock.classList.add("hidden");
            } else if (mode === "store") {
                if (textOnlyHint) textOnlyHint.classList.add("hidden");
                if (textBlock) textBlock.classList.add("hidden");
                if (linkBlock) linkBlock.classList.remove("hidden");
                if (dividerAfterLink) dividerAfterLink.classList.remove("hidden");
                if (imageBlock) imageBlock.classList.remove("hidden");
                if (storeBlock) storeBlock.classList.remove("hidden");
            } else {
                if (textOnlyHint) textOnlyHint.classList.add("hidden");
                if (textBlock) textBlock.classList.add("hidden");
                if (linkBlock) linkBlock.classList.remove("hidden");
                if (dividerAfterLink) dividerAfterLink.classList.remove("hidden");
                if (imageBlock) imageBlock.classList.remove("hidden");
                if (storeBlock) storeBlock.classList.add("hidden");
            }
        }

        function clearModalFields(keepKey = true) {
            setModalStatus("");

            if (el("fieldTextContent")) el("fieldTextContent").value = "";
            if (el("fieldLinkUrl")) el("fieldLinkUrl").value = "";
            if (el("fieldImageFile")) el("fieldImageFile").value = "";

            if (el("fieldBizNo")) el("fieldBizNo").value = "";
            if (el("fieldBizName")) el("fieldBizName").value = "";
            if (el("fieldStoreId")) el("fieldStoreId").value = "";
            if (el("fieldTableSource")) el("fieldTableSource").value = "";

            if (el("fieldStartAt")) el("fieldStartAt").value = "";
            if (el("fieldEndAt")) el("fieldEndAt").value = "";
            if (el("fieldNoEnd")) el("fieldNoEnd").checked = false;
            if (el("fieldEndAt")) el("fieldEndAt").disabled = false;

            const modal = el("slotModal");
            if (modal) modal.dataset.currentImage = "";
            setPreview("");

            if (el("storeResultsBody")) {
                el("storeResultsBody").innerHTML = `ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ê³  â€œê°€ê²Œ ê²€ìƒ‰â€ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.`;
            }

            setSelectedSummary({ imageUrl: "", storeText: "" });

            if (!keepKey) {
                const m = el("slotModal");
                if (m) { m.dataset.page = ""; m.dataset.position = ""; }
                state.current.basePosition = "";
                state.current.position = "";
                state.current.priority = "1";
            }
        }

        function toDatetimeLocal(v) {
            const s = clean(v);
            if (!s) return "";
            const iso = s.includes("T") ? s : s.replace(" ", "T");
            return iso.slice(0, 16);
        }

        function setSourceUI(src) {
            CURRENT_SOURCE = src === "food" ? "food" : "combined";

            const bC = el("btnSourceCombined");
            const bF = el("btnSourceFood");
            if (bC && bF) {
                const onCombined = CURRENT_SOURCE === "combined";
                bC.className = onCombined
                    ? "flex-1 rounded-xl px-3 py-2 text-sm font-bold border border-blue-200 bg-blue-600 text-white"
                    : "flex-1 rounded-xl px-3 py-2 text-sm font-bold border border-blue-200 bg-white text-blue-700 hover:bg-blue-50";
                bF.className = !onCombined
                    ? "flex-1 rounded-xl px-3 py-2 text-sm font-bold border border-blue-200 bg-blue-600 text-white"
                    : "flex-1 rounded-xl px-3 py-2 text-sm font-bold border border-blue-200 bg-white text-blue-700 hover:bg-blue-50";
            }

            const mC = el("modalBtnSourceCombined");
            const mF = el("modalBtnSourceFood");
            if (mC && mF) {
                const onCombined = CURRENT_SOURCE === "combined";
                mC.className = onCombined
                    ? "flex-1 rounded-xl px-3 py-2 text-sm font-bold border border-blue-200 bg-blue-600 text-white"
                    : "flex-1 rounded-xl px-3 py-2 text-sm font-bold border border-blue-200 bg-white text-blue-700 hover:bg-blue-50";
                mF.className = !onCombined
                    ? "flex-1 rounded-xl px-3 py-2 text-sm font-bold border border-blue-200 bg-blue-600 text-white"
                    : "flex-1 rounded-xl px-3 py-2 text-sm font-bold border border-blue-200 bg-white text-blue-700 hover:bg-blue-50";
            }

            if (el("modalSourceText")) el("modalSourceText").textContent = sourceLabel(CURRENT_SOURCE);
        }

        async function refreshCandidateList() {
            const pos = clean(state.current.position);
            if (!pos) return;

            try {
                const items = await apiCandidates({ page: PAGE, position: pos });
                const list = el("candidateList");
                if (!list) return;

                list.innerHTML = "";
                if (!items.length) {
                    list.innerHTML = `<div class="text-xs text-slate-500">ë“±ë¡ëœ í›„ë³´ ì—†ìŒ</div>`;
                    return;
                }

                items
                    .filter(x => x && (x.priority != null || x.ad_priority != null))
                    .map(x => ({ ...x, _p: String(x.priority ?? x.ad_priority ?? "1") }))
                    .sort((a, b) => Number(a._p) - Number(b._p))
                    .slice(0, 12)
                    .forEach((it) => {
                        const p = String(it._p);
                        const mode = clean(it.slot_mode || it.slotMode || it.mode || "");
                        const name = clean(it.business_name || it.businessName || "");
                        const cat = clean(it.category || it.business_category || it.business_type || "");
                        const hasImg = !!clean(it.image_url || it.imageUrl || "");
                        const span = document.createElement("div");
                        span.className = "neo-card px-3 py-2 flex items-center justify-between gap-2";
                        span.innerHTML = `
              <div class="min-w-0">
                <div class="text-xs font-extrabold text-slate-800 truncate">priority ${p} Â· ${mode || "-"}</div>
                <div class="text-[11px] text-slate-500 truncate">${name ? `${name} ${cat ? `(${cat})` : ""}` : (hasImg ? "ì´ë¯¸ì§€ ë°°ë„ˆ" : "í…ìŠ¤íŠ¸/ë§í¬")}</div>
              </div>
              <button class="btn-3d shrink-0" type="button">ë¶ˆëŸ¬ì˜¤ê¸°</button>
            `;
                        span.querySelector("button").addEventListener("click", async () => {
                            el("adPriority").value = p;
                            state.current.priority = p;
                            await loadSlotIntoModal();
                        });
                        list.appendChild(span);
                    });

                if (el("prioritySupportHint")) {
                    el("prioritySupportHint").textContent = "í›„ë³´ëŠ” ì„œë²„ì— ë“±ë¡ëœ ìš°ì„ ìˆœìœ„ ëª©ë¡ ê¸°ì¤€ì…ë‹ˆë‹¤.";
                }
            } catch (e) {
                const list = el("candidateList");
                if (list) list.innerHTML = `<div class="text-xs text-slate-500">í›„ë³´ ëª©ë¡ API ë¯¸ì§€ì›/ì˜¤ë¥˜</div>`;
            }
        }

        async function openSlotModal(basePosition) {
            const modal = el("slotModal");
            if (!modal) return;

            const bp = clean(basePosition);
            const pos = buildPosition(bp, CURRENT_SOURCE);

            state.current.page = PAGE;
            state.current.basePosition = bp;
            state.current.position = pos;
            state.current.priority = clean(el("adPriority")?.value || "1") || "1";

            modal.dataset.page = PAGE;
            modal.dataset.position = pos;

            if (el("modalPositionText")) el("modalPositionText").textContent = pos;
            if (el("modalSourceText")) el("modalSourceText").textContent = sourceLabel(CURRENT_SOURCE);

            clearModalFields(true);

            document.querySelectorAll('input[name="slotMode"]').forEach(r => r.checked = r.value === "image");
            applyModeUI("image");

            if (el("fieldTableSource")) el("fieldTableSource").value = tableSourceFromSource(CURRENT_SOURCE);

            modal.classList.remove("hidden");

            try {
                await loadSlotIntoModal();
            } catch (e) {
                setModalStatus("ìŠ¬ë¡¯ ë¡œë“œ ì‹¤íŒ¨ (ì‹ ê·œ ì…ë ¥ ê°€ëŠ¥)");
            }
            await refreshCandidateList();
        }

        function closeSlotModal() {
            const modal = el("slotModal");
            if (!modal) return;
            modal.classList.add("hidden");
        }

        async function loadSlotIntoModal() {
            setModalStatus("ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...");

            const bp = clean(state.current.basePosition);
            const position = buildPosition(bp, CURRENT_SOURCE);
            state.current.position = position;

            const priority = clean(el("adPriority")?.value || state.current.priority || "1") || "1";
            state.current.priority = priority;

            const data = await apiGetSlot({ page: PAGE, position, priority });
            const slot = data?.slot ?? data;

            if (el("modalPositionText")) el("modalPositionText").textContent = position;
            if (el("modalSourceText")) el("modalSourceText").textContent = sourceLabel(CURRENT_SOURCE);

            if (!slot) {
                setModalStatus("ìŠ¬ë¡¯ ì—†ìŒ(ì‹ ê·œ)");
                setPreview("");
                return;
            }

            const mode = clean(slot.slot_mode || slot.slotMode || "image");
            document.querySelectorAll('input[name="slotMode"]').forEach(r => r.checked = r.value === mode);
            applyModeUI(mode);

            const startAt = clean(slot.start_at || slot.startAt || "");
            const endAt = clean(slot.end_at || slot.endAt || "");
            const noEnd = String(slot.no_end ?? slot.noEnd ?? "").toLowerCase() === "true" || slot.no_end === true || slot.noEnd === true;

            if (el("fieldStartAt")) el("fieldStartAt").value = toDatetimeLocal(startAt);
            if (el("fieldEndAt")) el("fieldEndAt").value = toDatetimeLocal(endAt);
            if (el("fieldNoEnd")) el("fieldNoEnd").checked = !!noEnd;
            if (el("fieldEndAt")) el("fieldEndAt").disabled = !!noEnd;

            if (el("fieldTextContent")) el("fieldTextContent").value = clean(slot.text_content || slot.textContent || "");
            if (el("fieldLinkUrl")) el("fieldLinkUrl").value = clean(slot.link_url || slot.linkUrl || "");

            const imageUrl = clean(slot.image_url || slot.imageUrl || "");
            const modal = el("slotModal");
            if (modal) modal.dataset.currentImage = imageUrl || "";
            setPreview(imageUrl);

            const storeId = clean(slot.store_id || slot.storeId || "");
            const tableSource = clean(slot.table_source || slot.tableSource || tableSourceFromSource(CURRENT_SOURCE));
            const bizNo = clean(slot.business_no || slot.businessNo || "");
            const bizName = clean(slot.business_name || slot.businessName || "");
            const cat = clean(slot.category || slot.business_category || slot.business_type || "");

            if (el("fieldStoreId")) el("fieldStoreId").value = storeId;
            if (el("fieldTableSource")) el("fieldTableSource").value = tableSource;
            if (el("fieldBizNo")) el("fieldBizNo").value = bizNo;
            if (el("fieldBizName")) el("fieldBizName").value = bizName;

            const storeText = bizName ? (cat ? `${bizName} (${cat})` : bizName) : "";
            setSelectedSummary({ imageUrl: imageUrl, storeText });

            setModalStatus("ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ");
        }

        function ensureStoreSelectedOrRevert() {
            const storeId = clean(el("fieldStoreId")?.value);
            if (storeId) return true;

            alert("ê°€ê²Œ ì—°ê²°ì€ ê²€ìƒ‰ ê²°ê³¼ì—ì„œ 'ì„ íƒ'ì„ ëˆŒëŸ¬ì•¼ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");

            document.querySelectorAll('input[name="slotMode"]').forEach(r => {
                r.checked = (r.value === "image");
            });
            applyModeUI("image");

            const hint = el("storeSearchHint");
            if (hint) hint.textContent = "ë¨¼ì € ê°€ê²Œ ê²€ìƒ‰ â†’ 'ì„ íƒ' í›„ ë‹¤ì‹œ ì €ì¥í•˜ì„¸ìš”.";
            return false;
        }

        function isModalEmptyForDelete() {
            const textContent = clean(el("fieldTextContent")?.value);
            const linkUrl = clean(el("fieldLinkUrl")?.value);
            const storeId = clean(el("fieldStoreId")?.value);

            const file = el("fieldImageFile")?.files?.[0];
            const currentImage = clean(el("slotModal")?.dataset.currentImage || "");

            const startAt = clean(el("fieldStartAt")?.value);
            const endAt = clean(el("fieldEndAt")?.value);
            const noEnd = el("fieldNoEnd")?.checked ? true : false;

            return (!textContent && !linkUrl && !storeId && !file && !currentImage && !startAt && !endAt && !noEnd);
        }

        async function resetAndDeleteCurrentSlot() {
            const position = clean(state.current.position);
            const priority = clean(el("adPriority")?.value || state.current.priority || "1") || "1";

            if (!position) {
                alert("ìŠ¬ë¡¯(position)ì´ ì—†ì–´ ì´ˆê¸°í™”ë¥¼ ì§„í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            const ok = confirm("ì…ë ¥ ì´ˆê¸°í™” ì‹œ, ì´ ìš°ì„ ìˆœìœ„ ë°ì´í„°ê°€ DBì—ì„œ ì‚­ì œë©ë‹ˆë‹¤. ì§„í–‰í• ê¹Œìš”?");
            if (!ok) return;

            try {
                setModalStatus("ì´ˆê¸°í™”(ì‚­ì œ) ì¤‘...");
                await apiDeleteSlot({ page: PAGE, position, priority });

                clearModalFields(true);
                await loadAndRender();
                await refreshCandidateList();

                setModalStatus("ì´ˆê¸°í™”(ì‚­ì œ) ì™„ë£Œ âœ…");
                alert("ì´ˆê¸°í™”(ì‚­ì œ) ì™„ë£Œ âœ…");
            } catch (e) {
                setModalStatus(`âŒ ì´ˆê¸°í™”(ì‚­ì œ) ì‹¤íŒ¨: ${e.message || e}`);
                alert(`ì´ˆê¸°í™”(ì‚­ì œ) ì‹¤íŒ¨: ${e.message || e}`);
            }
        }

        // âœ… ê²€ìƒ‰ ê·œì¹™: ì‚¬ì—…ìë²ˆí˜¸ ìš°ì„  / ì•„ë¬´ê²ƒë„ ì—†ìœ¼ë©´ 10ê°œë§Œ
        async function doStoreSearch() {
            const nameQ = clean(el("fieldBizName")?.value);
            const bizDigits = digitsOnly(clean(el("fieldBizNo")?.value));

            const q = bizDigits ? bizDigits : (nameQ ? nameQ : "__all__");
            const pageSize = (q === "__all__") ? 10 : 12;

            const wrap = el("storeResultsBody");
            if (wrap) wrap.innerHTML = `<div class="text-sm text-slate-500">ê²€ìƒ‰ ì¤‘...</div>`;

            try {
                const storesRaw = await apiSearchStore(q, CURRENT_SOURCE, pageSize);
                const stores = (q === "__all__") ? (storesRaw || []).slice(0, 10) : (storesRaw || []);

                if (!Array.isArray(stores) || stores.length === 0) {
                    if (wrap) wrap.innerHTML = `<div class="text-sm text-slate-500">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</div>`;
                    setModalStatus("ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ");
                    return;
                }

                renderStoreResults(stores);
                setModalStatus(bizDigits ? "ì‚¬ì—…ìë²ˆí˜¸ ê²€ìƒ‰ ì™„ë£Œ" : (nameQ ? "ìƒí˜¸ëª… ê²€ìƒ‰ ì™„ë£Œ" : "í†µí•© 10ê°œ í‘œì‹œ"));
            } catch (e) {
                setModalStatus(`ê²€ìƒ‰ ì˜¤ë¥˜: ${e.message || "error"}`);
                if (wrap) wrap.innerHTML = `<div class="text-sm text-rose-600">ê²€ìƒ‰ ì˜¤ë¥˜: ${e.message || "error"}</div>`;
            }
        }

        function renderStoreResults(stores) {
            const wrap = el("storeResultsBody");
            if (!wrap) return;

            wrap.innerHTML = "";
            stores.forEach((s) => {
                const id = clean(s.id || s.store_id || s.storeId);
                const biz = clean(s.business_no || s.businessNo || s.business_number || "");
                const name = clean(s.business_name || s.businessName || s.business_name_kor || "");
                const cat = clean(s.category || s.business_category || s.business_type || "");
                const thumb = clean(s.image_url || s.url || s.thumb_url || s.imageUrl || (Array.isArray(s.images) ? s.images[0] : "")) || "/uploads/no-image.png";

                const tableSource = clean(s.table_source || s.tableSource || tableSourceFromSource(CURRENT_SOURCE));

                const row = document.createElement("div");
                row.className = "neo-card p-3 flex gap-3 items-center mb-2";

                const imgContainer = document.createElement("div");
                imgContainer.className = "w-16 h-12 rounded-xl overflow-hidden bg-white/60 shrink-0";

                if (thumb && thumb !== "/uploads/no-image.png") {
                    const img = document.createElement("img");
                    img.className = "w-full h-full object-cover";
                    setImg(img, thumb);
                    imgContainer.appendChild(img);
                } else {
                    const noImg = document.createElement("div");
                    noImg.className = "w-full h-full flex items-center justify-center text-xs text-slate-400";
                    noImg.textContent = "NO IMG";
                    imgContainer.appendChild(noImg);
                }

                const infoDiv = document.createElement("div");
                infoDiv.className = "flex-1 min-w-0";
                infoDiv.innerHTML = `
          <div class="font-extrabold text-slate-800 truncate">${name || "-"}</div>
          <div class="text-xs text-slate-600 mt-0.5 truncate">${cat ? `(${cat})` : ""} ${biz ? `Â· ${biz}` : ""}</div>
          <div class="text-[11px] text-slate-400 mt-0.5 truncate">${tableSource} Â· id=${id || "-"}</div>
        `;

                const btn = document.createElement("button");
                btn.className = "btn-3d shrink-0";
                btn.type = "button";
                btn.textContent = "ì„ íƒ";
                btn.addEventListener("click", () => {
                    if (!id) {
                        alert("ì‹¤ì œ ê°€ê²Œ ê²°ê³¼ê°€ ì•„ë‹™ë‹ˆë‹¤.");
                        return;
                    }
                    applySelectedStore({
                        id,
                        business_no: biz,
                        business_name: name,
                        category: cat,
                        image_url: thumb,
                        table_source: tableSource,
                    });
                });

                row.appendChild(imgContainer);
                row.appendChild(infoDiv);
                row.appendChild(btn);
                wrap.appendChild(row);
            });
        }

        function applySelectedStore(store) {
            const storeId = clean(store.id);
            const businessNo = clean(store.business_no);
            const businessName = clean(store.business_name);
            const category = clean(store.category);
            const imageUrl = clean(store.image_url);
            const tableSource = clean(store.table_source) || tableSourceFromSource(CURRENT_SOURCE);

            if (el("fieldStoreId")) el("fieldStoreId").value = storeId;
            if (el("fieldTableSource")) el("fieldTableSource").value = tableSource;
            if (el("fieldBizNo")) el("fieldBizNo").value = businessNo;
            if (el("fieldBizName")) el("fieldBizName").value = businessName;

            document.querySelectorAll('input[name="slotMode"]').forEach((r) => (r.checked = r.value === "store"));
            applyModeUI("store");

            if (el("fieldLinkUrl")) el("fieldLinkUrl").value = buildStoreLink(tableSource, storeId);

            const modal = el("slotModal");
            if (modal && imageUrl) modal.dataset.currentImage = imageUrl;
            setPreview(modal?.dataset.currentImage || "");

            const storeText = businessName ? (category ? `${businessName} (${category})` : businessName) : "";
            setSelectedSummary({ imageUrl: modal?.dataset.currentImage || "", storeText });

            setModalStatus("ê°€ê²Œ ì—°ê²° ì™„ë£Œ (ì €ì¥ ëˆ„ë¥´ì„¸ìš”)");
        }

        async function saveSlotFromModal() {
            try {
                setModalStatus("ì €ì¥ ì¤‘...");

                const position = clean(state.current.position);
                if (!position) throw new Error("position(ìŠ¬ë¡¯)ì´ ë¹„ì–´ìˆìŒ");

                if (isModalEmptyForDelete()) {
                    const priority = clean(el("adPriority")?.value || "1") || "1";
                    await apiDeleteSlot({ page: PAGE, position, priority });
                    await loadAndRender();
                    await refreshCandidateList();
                    clearModalFields(true);
                    setModalStatus("ì‚­ì œ ì™„ë£Œ âœ…");
                    alert("ì‚­ì œ ì™„ë£Œ âœ…");
                    return;
                }

                const mode = getMode();
                if (mode === "store") {
                    const ok = ensureStoreSelectedOrRevert();
                    if (!ok) return;
                }

                const priority = clean(el("adPriority")?.value || "1") || "1";
                state.current.priority = priority;

                const fd = new FormData();
                fd.append("page", PAGE);
                fd.append("position", position);
                fd.append("priority", priority);

                const slotType = (mode === "text") ? "text" : "banner";
                fd.append("slot_type", slotType);
                fd.append("slotType", slotType);
                fd.append("slot_mode", mode);
                fd.append("slotMode", mode);

                const startAt = clean(el("fieldStartAt")?.value);
                const endAt = clean(el("fieldEndAt")?.value);
                const noEnd = el("fieldNoEnd")?.checked ? "true" : "false";
                fd.append("start_at", startAt);
                fd.append("startAt", startAt);
                fd.append("end_at", endAt);
                fd.append("endAt", endAt);
                fd.append("no_end", noEnd);
                fd.append("noEnd", noEnd);

                const linkUrl = clean(el("fieldLinkUrl")?.value);
                const textContent = clean(el("fieldTextContent")?.value);
                fd.append("link_url", linkUrl);
                fd.append("linkUrl", linkUrl);
                fd.append("text_content", textContent);
                fd.append("textContent", textContent);

                // âœ… ì´ë¯¸ì§€ í•„ë“œëª…: ë°˜ë“œì‹œ "image"
                const modal = el("slotModal");
                const currentImage = clean(modal?.dataset.currentImage || "");
                const file = el("fieldImageFile")?.files?.[0];

                if (file) {
                    fd.append("image", file);
                } else {
                    if (currentImage) {
                        fd.append("image_url", currentImage);
                        fd.append("imageUrl", currentImage);
                        fd.append("keep_image", "true");
                        fd.append("keepImage", "true");
                    } else {
                        fd.append("clear_image", "true");
                        fd.append("clearImage", "true");
                    }
                }

                if (mode === "store") {
                    const storeId = clean(el("fieldStoreId")?.value);
                    if (!storeId) throw new Error("ê°€ê²Œì—°ê²° ëª¨ë“œì¸ë° store_idê°€ ë¹„ì–´ìˆìŒ(ê°€ê²Œ ì„ íƒ ë¨¼ì €)");

                    const tableSource = clean(el("fieldTableSource")?.value) || tableSourceFromSource(CURRENT_SOURCE);
                    const businessNo = clean(el("fieldBizNo")?.value);
                    const businessName = clean(el("fieldBizName")?.value);

                    fd.append("table_source", tableSource);
                    fd.append("tableSource", tableSource);

                    fd.append("store_id", storeId);
                    fd.append("storeId", storeId);

                    fd.append("business_no", businessNo);
                    fd.append("businessNo", businessNo);

                    fd.append("business_name", businessName);
                    fd.append("businessName", businessName);
                } else {
                    fd.append("table_source", "");
                    fd.append("tableSource", "");
                    fd.append("store_id", "");
                    fd.append("storeId", "");
                    fd.append("business_no", "");
                    fd.append("businessNo", "");
                    fd.append("business_name", "");
                    fd.append("businessName", "");
                }

                await apiUpsertSlot(fd);

                await loadAndRender();
                await refreshCandidateList();

                clearModalFields(true);

                el("adPriority").value = "1";
                state.current.priority = "1";

                setModalStatus("ì €ì¥ ì™„ë£Œ âœ…");
                alert("ì €ì¥ ì™„ë£Œ âœ…");
            } catch (e) {
                setModalStatus(`âŒ ì €ì¥ ì‹¤íŒ¨: ${e.message}`);
                alert(`ì €ì¥ ì‹¤íŒ¨: ${e.message || "ì €ì¥ ì˜¤ë¥˜"}`);
            }
        }

        // =========================
        // âœ… í´ë¦­ ë°”ì¸ë”© (ìŠ¬ë¡¯ í´ë¦­ â†’ ëª¨ë‹¬)
        // =========================
        function bindAdminClicks() {
            document.addEventListener("click", async (e) => {
                if (e.target.closest("#slotModal")) return;

                const target = e.target.closest("[data-position]");
                if (!target) return;

                e.preventDefault();
                e.stopPropagation();

                const basePosition = target.getAttribute("data-position") || "";
                if (!basePosition) return;

                await openSlotModal(basePosition);
            }, true);
        }

        // =========================
        // âœ… ëª¨ë‹¬ ì´ë²¤íŠ¸
        // =========================
        function bindModalEvents() {
            const closeBtn = el("btnCloseModal");
            if (closeBtn) closeBtn.addEventListener("click", (e) => { e.preventDefault(); closeSlotModal(); });

            const modal = el("slotModal");
            if (modal) {
                modal.querySelector(".modal-backdrop")?.addEventListener("click", () => closeSlotModal());
            }

            document.addEventListener("keydown", (e) => {
                if (e.key !== "Escape") return;
                if (!el("slotModal")?.classList.contains("hidden")) closeSlotModal();
            });

            document.querySelectorAll('input[name="slotMode"]').forEach((r) => {
                r.addEventListener("change", () => applyModeUI(getMode()));
            });

            const noEnd = el("fieldNoEnd");
            if (noEnd) {
                noEnd.addEventListener("change", () => {
                    const end = el("fieldEndAt");
                    if (end) end.disabled = !!noEnd.checked;
                });
            }

            const file = el("fieldImageFile");
            if (file) {
                file.addEventListener("change", () => {
                    const f = file.files && file.files[0];
                    if (!f) return;
                    const url = URL.createObjectURL(f);
                    const modal = el("slotModal");
                    if (modal) modal.dataset.currentImage = url;
                    setPreview(url);
                    setSelectedSummary({ imageUrl: url, storeText: clean(el("textSelectedStore")?.textContent) });
                });
            }

            const btnSearch = el("btnSearchStore");
            if (btnSearch) btnSearch.addEventListener("click", (e) => { e.preventDefault(); doStoreSearch(); });

            const btnSave = el("btnSaveSlot");
            if (btnSave) btnSave.addEventListener("click", (e) => { e.preventDefault(); saveSlotFromModal(); });

            const btnReset = el("btnResetModal");
            if (btnReset) btnReset.addEventListener("click", async (e) => {
                e.preventDefault();
                await resetAndDeleteCurrentSlot();
                applyModeUI(getMode());
            });

            const btnLoadP = el("btnLoadPriority");
            if (btnLoadP) btnLoadP.addEventListener("click", async (e) => {
                e.preventDefault();
                await loadSlotIntoModal();
            });

            const btnDelP = el("btnDeletePriority");
            if (btnDelP) btnDelP.addEventListener("click", async (e) => {
                e.preventDefault();
                const ok = confirm("ì •ë§ ì´ ìš°ì„ ìˆœìœ„ë¥¼ ì‚­ì œí• ê¹Œìš”?");
                if (!ok) return;

                const position = clean(state.current.position);
                const priority = clean(el("adPriority")?.value || "1") || "1";
                await apiDeleteSlot({ page: PAGE, position, priority });
                setModalStatus("ì‚­ì œ ì™„ë£Œ");
                await loadAndRender();
                clearModalFields(true);
                await refreshCandidateList();
            });

            // âœ… ëª¨ë‹¬ì—ì„œ í†µí•©/í‘¸ë“œ ë³€ê²½ â†’ position ì¬ê³„ì‚° + ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
            const mC = el("modalBtnSourceCombined");
            const mF = el("modalBtnSourceFood");
            if (mC) mC.addEventListener("click", async () => {
                setSourceUI("combined");
                const bp = clean(state.current.basePosition);
                state.current.position = buildPosition(bp, CURRENT_SOURCE);
                if (el("fieldTableSource")) el("fieldTableSource").value = tableSourceFromSource(CURRENT_SOURCE);
                await loadSlotIntoModal();
                await refreshCandidateList();
            });
            if (mF) mF.addEventListener("click", async () => {
                setSourceUI("food");
                const bp = clean(state.current.basePosition);
                state.current.position = buildPosition(bp, CURRENT_SOURCE);
                if (el("fieldTableSource")) el("fieldTableSource").value = tableSourceFromSource(CURRENT_SOURCE);
                await loadSlotIntoModal();
                await refreshCandidateList();
            });

            // ì‚¬ìš©ë²• íŒì˜¤ë²„
            const helpBtn = el("adHelpBtn");
            const helpPop = el("adHelpPopover");
            const helpClose = el("adHelpCloseBtn");
            if (helpBtn && helpPop) {
                helpBtn.addEventListener("click", (e) => {
                    e.preventDefault();
                    helpPop.classList.toggle("hidden");
                    const open = !helpPop.classList.contains("hidden");
                    helpBtn.setAttribute("aria-expanded", open ? "true" : "false");
                });
            }
            if (helpClose && helpPop) {
                helpClose.addEventListener("click", (e) => {
                    e.preventDefault();
                    helpPop.classList.add("hidden");
                    if (helpBtn) helpBtn.setAttribute("aria-expanded", "false");
                });
            }

            // âœ… ê°€ê²Œëª…/ì‚¬ì—…ìë²ˆí˜¸ ì§ì ‘ ìˆ˜ì •í•˜ë©´ store_id ë¬´íš¨í™”
            ["fieldBizNo", "fieldBizName"].forEach((fid) => {
                const input = el(fid);
                if (!input) return;

                input.addEventListener("input", () => {
                    if (el("fieldStoreId")) el("fieldStoreId").value = "";
                    if (el("fieldTableSource")) el("fieldTableSource").value = tableSourceFromSource(CURRENT_SOURCE);

                    const modal = el("slotModal");
                    if (getMode() === "store") {
                        if (modal) modal.dataset.currentImage = "";
                        setPreview("");
                        setSelectedSummary({ imageUrl: "", storeText: "" });
                    }

                    const hint = el("storeSearchHint");
                    if (hint) hint.textContent = "ê°€ê²Œ ê²€ìƒ‰ í›„ ê²€ìƒ‰ ê²°ê³¼ì—ì„œ â€˜ì„ íƒâ€™ì„ ëˆŒëŸ¬ì•¼ ì €ì¥ë©ë‹ˆë‹¤.";
                });
            });
        }

        // =========================
        // âœ… ìƒë‹¨(í˜ì´ì§€) í†µí•©/í‘¸ë“œ í† ê¸€
        // =========================
        function bindSourceButtons() {
            const c = el("btnSourceCombined");
            const f = el("btnSourceFood");
            if (c) c.addEventListener("click", async () => {
                setSourceUI("combined");
                await loadAndRender();
            });
            if (f) f.addEventListener("click", async () => {
                setSourceUI("food");
                await loadAndRender();
            });
        }

        // =========================
        // âœ… ë”ë³´ê¸° í† ê¸€ 3ê°œ (ê° ì„¹ì…˜ +4)
        // =========================
        function bindMoreToggles() {
            const bind = (btnId, panelId) => {
                const btn = el(btnId);
                const panel = el(panelId);
                if (!btn || !panel) return;
                btn.addEventListener("click", () => {
                    panel.classList.toggle("hidden");
                });
            };

            bind("btnToggleAllMore", "allMorePanel");
            bind("btnToggleBestMore", "bestMorePanel");
            bind("btnToggleNewMore", "newMorePanel");
        }

        // =========================
        // âœ… init
        // =========================
        document.addEventListener("DOMContentLoaded", async () => {
            buildGrids();
            bindMoreToggles();
            bindSourceButtons();
            bindAdminClicks();
            bindModalEvents();

            setSourceUI("combined");
            await loadAndRender();
        });

        // ì „ì—­ ë…¸ì¶œ(í•„ìš” ì‹œ)
        window.openSlotModal = openSlotModal;
        window.closeSlotModal = closeSlotModal;
        window.doStoreSearch = doStoreSearch;
        window.saveSlotFromModal = saveSlotFromModal;
    </script>
</body>

</html>