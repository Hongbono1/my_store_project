<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MALL HANKOOK | SubCategory Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* âœ… ê´€ë¦¬ì í´ë¦­ìš© ë±ƒì§€ (ncategory2ì™€ ë™ì¼ ì»¨ì…‰) */
        .admin-slot {
            cursor: pointer;
            position: relative;
        }

        .admin-slot::after {
            content: "ê´€ë¦¬";
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 12px;
            font-weight: 900;
            padding: 6px 10px;
            border-radius: 9999px;
            background: rgba(255, 255, 255, 0.78);
            border: 1px solid rgba(59, 130, 246, 0.25);
            backdrop-filter: blur(8px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.08);
            color: rgba(30, 64, 175, 0.95);
            pointer-events: none;
            display: none;
            /* ê¸°ë³¸ì€ ìˆ¨ê¹€ */
        }

        body.manager-mode .admin-slot::after {
            display: block;
        }

        /* âœ… field/divider (ëª¨ë‹¬ ì…ë ¥ ê°€ì‹œì„± ë³´ì¥) */
        .field {
            width: 100%;
            padding: .65rem .85rem;
            border-radius: 1rem;
            border: 1px solid rgba(148, 163, 184, .75);
            background: rgba(255, 255, 255, 0.92);
            outline: none;
        }

        .field:focus {
            border-color: rgba(59, 130, 246, .85);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, .18);
        }

        .divider {
            height: 1px;
            background: rgba(148, 163, 184, 0.25);
            margin: 10px 0;
        }

        /* âœ… ëª¨ë‹¬ ìŠ¤íƒ€ì¼ (ncategory2 ë™ì¼) */
        #slotModal {
            position: fixed;
            inset: 0;
            z-index: 9999;
        }

        #slotModal .modal-backdrop {
            position: absolute;
            inset: 0;
            background: rgba(15, 23, 42, .55);
        }

        #slotModal .modal-panel {
            position: relative;
            margin: 0 auto;
            width: min(980px, calc(100% - 36px));
            max-height: 88vh;
            overflow: auto;
            top: 50%;
            transform: translateY(-50%);
        }

        #slotModal .modal-card {
            border-radius: 1.25rem;
            background: rgba(255, 255, 255, .96);
            border: 2px solid rgba(59, 130, 246, .18);
            box-shadow: 0 18px 60px rgba(0, 0, 0, .25);
            backdrop-filter: blur(14px);
            overflow: hidden;
        }
    </style>

    <!-- âœ… ê³µí†µ ëª¨ë‹¬ (ncategory2ì™€ ë™ì¼) -->
    <div id="slotModal" class="hidden" data-page="" data-position="" data-current-image="">
        <div class="modal-backdrop"></div>
        <div class="modal-panel">
            <div class="modal-card">
                <!-- í—¤ë” -->
                <div class="p-6 sticky top-0 bg-white/90 backdrop-blur border-b border-slate-100 z-10">
                    <div class="flex items-start justify-between gap-4">
                        <div>
                            <h3 id="modalTitle" class="text-xl sm:text-2xl font-extrabold">ìŠ¬ë¡¯ ìˆ˜ì •</h3>
                            <p class="text-xs text-gray-500 mt-1">
                                page: <b id="modalPageText">subcategory</b> /
                                position: <span id="modalPositionText" class="font-semibold"></span>
                            </p>
                        </div>

                        <div class="flex items-center gap-2">
                            <div class="relative">
                                <button type="button" id="adHelpBtn"
                                    class="inline-flex items-center gap-2 rounded-xl border border-blue-200 bg-white/80 px-3 py-1.5 text-sm font-semibold text-blue-700 shadow-sm hover:bg-white"
                                    aria-expanded="false" aria-controls="adHelpPopover" title="ì‚¬ìš©ë²• ë³´ê¸°">
                                    <span
                                        class="inline-flex h-5 w-5 items-center justify-center rounded-full bg-blue-600 text-white text-xs leading-none">?</span>
                                    ì‚¬ìš©ë²•
                                </button>

                                <div id="adHelpPopover"
                                    class="hidden absolute right-0 mt-2 w-[min(420px,calc(100vw-2rem))] rounded-2xl border border-blue-200 bg-white/95 p-4 shadow-xl backdrop-blur">
                                    <div class="flex items-start justify-between gap-3">
                                        <div class="font-extrabold text-slate-800">âœ… ì‚¬ìš© íë¦„</div>
                                        <button type="button" id="adHelpCloseBtn"
                                            class="rounded-lg px-2 py-1 text-xs font-bold text-slate-500 hover:bg-slate-100">ë‹«ê¸°</button>
                                    </div>

                                    <ol class="mt-3 space-y-2 text-sm text-slate-700 leading-relaxed list-decimal pl-5">
                                        <li>ì„œë¸Œì¹´í…Œê³ ë¦¬ í˜ì´ì§€ì— <b>?manager=1</b>ë¡œ ì ‘ì†</li>
                                        <li>ë°”ê¾¸ê³  ì‹¶ì€ ì˜ì—­(ê´€ë¦¬ ë±ƒì§€ ìˆëŠ” ìŠ¬ë¡¯) í´ë¦­</li>
                                        <li>ë‚´ìš©/ì´ë¯¸ì§€/ê¸°ê°„ ì…ë ¥ í›„ <b>ìŠ¬ë¡¯ ì €ì¥</b></li>
                                    </ol>

                                    <div class="mt-3 rounded-xl bg-blue-50 px-3 py-2 text-xs text-blue-900">
                                        â€» ê¸°ê°„ ì¡°ê±´ì´ ë§ëŠ” í›„ë³´ ì¤‘ ìš°ì„ ìˆœìœ„ ìˆ«ìê°€ ê°€ì¥ ì‘ì€ ê²ƒì´ ë…¸ì¶œë©ë‹ˆë‹¤.
                                    </div>
                                </div>
                            </div>

                            <button id="btnCloseModal"
                                class="px-3 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-slate-700 text-sm">
                                ë‹«ê¸°
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ë³¸ë¬¸ -->
                <div class="p-6 space-y-6">

                    <div id="textOnlyHint" class="hidden rounded-2xl border border-slate-100 bg-slate-50 p-4">
                        <div class="text-sm font-bold text-slate-800">ğŸ“ ì´ ìŠ¬ë¡¯ì€ í…ìŠ¤íŠ¸ ì „ìš©ì…ë‹ˆë‹¤.</div>
                        <div class="mt-1 text-xs text-slate-500">
                            ì´ë¯¸ì§€/ê°€ê²Œì—°ê²°/ë§í¬ ì…ë ¥ì€ ìˆ¨ê¹€ ì²˜ë¦¬ë©ë‹ˆë‹¤. (ê¸€ë§Œ ì‘ì„±)
                        </div>
                    </div>

                    <div id="modeBlock" class="rounded-xl border border-slate-100 bg-slate-50 p-4">
                        <p class="text-sm font-semibold mb-3">ê´‘ê³  ë°©ì‹ ì„ íƒ</p>
                        <div class="flex flex-wrap gap-4">
                            <label class="flex items-center gap-2 text-sm">
                                <input type="radio" name="slotMode" value="image" class="accent-blue-600" checked>
                                <span>ì´ë¯¸ì§€ ë°°ë„ˆ</span>
                            </label>
                            <label class="flex items-center gap-2 text-sm">
                                <input type="radio" name="slotMode" value="store" class="accent-emerald-600">
                                <span>ê°€ê²Œ ì—°ê²°</span>
                            </label>
                            <label class="flex items-center gap-2 text-sm">
                                <input type="radio" name="slotMode" value="text" class="accent-indigo-600">
                                <span>í…ìŠ¤íŠ¸ ì „ìš©</span>
                            </label>
                        </div>
                    </div>

                    <div id="textBlock" class="hidden space-y-2">
                        <label class="text-sm font-semibold">ë‚´ìš© (í…ìŠ¤íŠ¸)</label>
                        <textarea id="fieldTextContent" class="field mt-2 min-h-[180px] resize-y"
                            placeholder="ì˜ˆ) í•œ ì¤„ë‹¹ 1ê°œì”© ì…ë ¥&#10;ì²«ë²ˆì§¸ ì¤„&#10;ë‘ë²ˆì§¸ ì¤„&#10;ì„¸ë²ˆì§¸ ì¤„"></textarea>
                        <p class="text-xs text-gray-500">ì¤„ë°”ê¿ˆ(Enter) ê¸°ì¤€ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.</p>
                    </div>

                    <div id="linkBlock">
                        <label class="text-sm font-semibold">ë§í¬ URL (ì„ íƒ)</label>
                        <input id="fieldLinkUrl" class="field mt-2"
                            placeholder="/ndetail.html?id=123&type=combined ë˜ëŠ” https://..." />
                    </div>

                    <div id="dividerAfterLink" class="divider"></div>

                    <div id="imageBlock" class="space-y-4">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm font-semibold">ì´ë¯¸ì§€ íŒŒì¼</label>
                                <input id="fieldImageFile" type="file" accept="image/*" class="field mt-2 bg-white" />
                                <p class="text-xs text-gray-500 mt-1">
                                    íŒŒì¼ì„ ì„ íƒí•˜ì§€ ì•Šìœ¼ë©´, ê¸°ì¡´ ì´ë¯¸ì§€ë¥¼ ìœ ì§€í•©ë‹ˆë‹¤.
                                </p>
                            </div>
                            <div>
                                <label class="text-sm font-semibold">í˜„ì¬ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°</label>
                                <div
                                    class="mt-2 rounded-lg border border-gray-100 bg-gray-50 overflow-hidden aspect-[16/9] flex items-center justify-center">
                                    <img id="currentPreviewImg" src="" alt="preview"
                                        class="w-full h-full object-cover hidden" />
                                    <span id="currentPreviewEmpty" class="text-xs text-gray-400">ì´ë¯¸ì§€ ì—†ìŒ</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="storeBlock" class="space-y-4 hidden">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm font-semibold">ì‚¬ì—…ìë²ˆí˜¸</label>
                                <input id="fieldBizNo" class="field mt-2" placeholder="ì˜ˆ) 2910802895" />
                            </div>
                            <div>
                                <label class="text-sm font-semibold">ìƒí˜¸ëª…</label>
                                <input id="fieldBizName" class="field mt-2" placeholder="ì˜ˆ) í•˜ëŠ˜ì‹ë‹¹" />
                            </div>
                        </div>

                        <div class="flex items-center gap-2">
                            <button id="btnSearchStore"
                                class="px-4 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white text-sm">ê°€ê²Œ
                                ê²€ìƒ‰</button>
                            <span id="storeSearchHint" class="text-xs text-gray-500"></span>
                        </div>

                        <div id="storeResults" class="border border-slate-100 rounded-xl overflow-hidden">
                            <div class="px-4 py-3 bg-slate-50 text-sm font-semibold">ê²€ìƒ‰ ê²°ê³¼</div>
                            <div id="storeResultsBody" class="p-4 text-sm text-gray-500">
                                ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ê³  â€œê°€ê²Œ ê²€ìƒ‰â€ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.
                            </div>
                        </div>

                        <input id="fieldStoreId" type="hidden" />
                        <input id="fieldTableSource" type="hidden" />
                    </div>

                    <div class="divider"></div>

                    <div class="mt-4 p-3 rounded-xl border border-blue-100 bg-white/70">
                        <div class="flex flex-col md:flex-row md:items-end gap-3">
                            <div class="flex-1">
                                <label class="text-sm font-semibold text-gray-700">ìš°ì„ ìˆœìœ„</label>
                                <input id="adPriority" type="number" min="1" step="1" value="1"
                                    class="mt-1 w-full rounded-xl border border-gray-200 px-3 py-2 outline-none focus:ring-2 focus:ring-blue-300" />
                                <p class="mt-1 text-xs text-gray-500">1ì´ ê°€ì¥ ë¨¼ì € ë…¸ì¶œë©ë‹ˆë‹¤. (1,2,3â€¦ ì—¬ëŸ¬ ê°œ ë“±ë¡ ê°€ëŠ¥)</p>
                            </div>

                            <button type="button" id="btnLoadPriority"
                                class="rounded-xl px-4 py-2 border border-blue-200 bg-blue-50 hover:bg-blue-100 text-sm">
                                ì´ ìš°ì„ ìˆœìœ„ ë¶ˆëŸ¬ì˜¤ê¸°
                            </button>

                            <button type="button" id="btnDeletePriority"
                                class="rounded-xl px-4 py-2 border border-red-200 bg-red-50 hover:bg-red-100 text-sm">
                                ì´ ìš°ì„ ìˆœìœ„ ì‚­ì œ
                            </button>
                        </div>

                        <details class="mt-3">
                            <summary class="cursor-pointer text-sm text-gray-700">ë“±ë¡ëœ í›„ë³´ ëª©ë¡ ë³´ê¸°</summary>
                            <div id="candidateList" class="mt-2 grid gap-2"></div>
                        </details>

                        <div id="prioritySupportHint" class="mt-3 text-xs text-slate-500"></div>
                    </div>

                    <div class="rounded-xl border border-slate-100 p-4">
                        <div class="flex items-center justify-between">
                            <p class="text-sm font-semibold">ê´‘ê³  ê¸°ê°„ ì„¤ì •</p>
                            <label class="flex items-center gap-2 text-xs">
                                <input id="fieldNoEnd" type="checkbox" class="accent-blue-600">
                                <span class="text-gray-700">ê³„ì† ìœ ì§€ (ì¢…ë£Œ ì—†ìŒ)</span>
                            </label>
                        </div>

                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4">
                            <div>
                                <label class="text-xs font-semibold text-gray-600">ì‹œì‘ ì¼ì‹œ</label>
                                <input id="fieldStartAt" type="datetime-local" class="field mt-2" />
                            </div>
                            <div>
                                <label class="text-xs font-semibold text-gray-600">ì¢…ë£Œ ì¼ì‹œ</label>
                                <input id="fieldEndAt" type="datetime-local" class="field mt-2" />
                            </div>
                        </div>
                    </div>

                    <div class="rounded-xl border border-slate-100 bg-slate-50 p-4">
                        <p class="text-sm font-semibold mb-2">í˜„ì¬ ì„ íƒ ì •ë³´</p>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm">
                            <div class="flex items-center gap-2">
                                <span class="text-gray-500">ì„ íƒ ì´ë¯¸ì§€:</span>
                                <span id="textSelectedImage" class="font-semibold text-slate-800">ì—†ìŒ</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-gray-500">ì—°ê²° ê°€ê²Œ:</span>
                                <span id="textSelectedStore" class="font-semibold text-slate-800">ì—†ìŒ</span>
                            </div>
                        </div>

                        <div id="modalStatus" class="mt-3 text-xs text-slate-600"></div>
                    </div>

                    <div class="flex flex-col sm:flex-row gap-2 sm:justify-end">
                        <button id="btnResetModal"
                            class="px-4 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-slate-700 text-sm">
                            ì…ë ¥ ì´ˆê¸°í™”
                        </button>
                        <button id="btnSaveSlot"
                            class="px-5 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold">
                            ìŠ¬ë¡¯ ì €ì¥
                        </button>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <script>
        // =========================
        // âœ… manager=1 ì¼ ë•Œë§Œ ê´€ë¦¬ì ëª¨ë“œ ON
        // =========================
        const qs = (k) => new URLSearchParams(location.search).get(k) || "";
        const isManager = qs("manager") === "1";

        if (isManager) document.body.classList.add("manager-mode");

        const el = (id) => document.getElementById(id);
        const clean = (v) => (v == null ? "" : String(v).trim());
        const digitsOnly = (v) => clean(v).replace(/[^\d]/g, "");

        // âœ… API_BASE: subcategorymanager/adë¥¼ ìš°ì„  ì‹œë„, ì—†ìœ¼ë©´ ncategory2manager/adë¡œ fallback
        const API_BASE_PRIMARY = "/subcategorymanager/ad";
        const API_BASE_FALLBACK = "/ncategory2manager/ad";
        const PAGE = "subcategory";
        const DEFAULT_TABLE_SOURCE = "combined_store_info";

        async function fetchJson(url, opt = {}) {
            const r = await fetch(url, opt);
            const data = await r.json().catch(() => ({}));
            if (!r.ok) throw new Error(data?.error || data?.message || `HTTP ${r.status}`);
            return data;
        }

        async function fetchJsonWithFallback(path, opt = {}) {
            try {
                return await fetchJson(`${API_BASE_PRIMARY}${path}`, opt);
            } catch (e) {
                // 404/ë¼ìš°í„° ì—†ìŒì´ë©´ fallback
                return await fetchJson(`${API_BASE_FALLBACK}${path}`, opt);
            }
        }

        function buildStoreLink(tableSource, storeId) {
            const t = clean(tableSource) || DEFAULT_TABLE_SOURCE;
            const id = clean(storeId);
            if (!id) return "#";

            if (t === "combined_store_info" || t === "combined") return `/ndetail.html?id=${encodeURIComponent(id)}&type=combined`;
            if (t === "food_stores" || t === "food") return `/ndetail.html?id=${encodeURIComponent(id)}&type=food`;
            if (t === "store_info") return `/detail.html?id=${encodeURIComponent(id)}`;
            return `/ndetail.html?id=${encodeURIComponent(id)}&type=combined`;
        }

        async function apiGetSlot({ page, position, priority }) {
            const url = new URL(location.origin + API_BASE_PRIMARY + "/slot");
            url.searchParams.set("page", page);
            url.searchParams.set("position", position);
            url.searchParams.set("priority", String(priority ?? 1));
            try {
                return await fetchJson(url.toString());
            } catch (_) {
                const url2 = new URL(location.origin + API_BASE_FALLBACK + "/slot");
                url2.searchParams.set("page", page);
                url2.searchParams.set("position", position);
                url2.searchParams.set("priority", String(priority ?? 1));
                return await fetchJson(url2.toString());
            }
        }

        async function apiUpsertSlot(formData) {
            try {
                return await fetchJsonWithFallback("/slot", { method: "POST", body: formData });
            } catch (e) {
                throw new Error(e?.message || "ì €ì¥ ì‹¤íŒ¨");
            }
        }

        async function apiDeleteSlot({ page, position, priority }) {
            const u1 = new URL(location.origin + API_BASE_PRIMARY + "/slot");
            u1.searchParams.set("page", page);
            u1.searchParams.set("position", position);
            u1.searchParams.set("priority", String(priority ?? 1));

            try {
                return await fetchJson(u1.toString(), { method: "DELETE" });
            } catch (_) {
                const u2 = new URL(location.origin + API_BASE_FALLBACK + "/slot");
                u2.searchParams.set("page", page);
                u2.searchParams.set("position", position);
                u2.searchParams.set("priority", String(priority ?? 1));
                return await fetchJson(u2.toString(), { method: "DELETE" });
            }
        }

        async function apiListSlotItems({ page, position }) {
            const u1 = new URL(location.origin + API_BASE_PRIMARY + "/slot-items");
            u1.searchParams.set("page", page);
            u1.searchParams.set("position", position);

            try {
                const data = await fetchJson(u1.toString());
                if (data?.success === true) return data.items || [];
                return data.items || [];
            } catch (_) {
                const u2 = new URL(location.origin + API_BASE_FALLBACK + "/slot-items");
                u2.searchParams.set("page", page);
                u2.searchParams.set("position", position);
                const data = await fetchJson(u2.toString());
                if (data?.success === true) return data.items || [];
                return data.items || [];
            }
        }

        async function apiSearchStore(q, bizNo) {
            const params = new URLSearchParams();
            if (q) params.set("q", q);
            if (bizNo) params.set("bizNo", bizNo);

            // ìš°ì„  primary, ì‹¤íŒ¨í•˜ë©´ fallback
            try {
                const res = await fetch(`${API_BASE_PRIMARY}/search-store?${params.toString()}`);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                return data.stores || [];
            } catch (_) {
                const res2 = await fetch(`${API_BASE_FALLBACK}/search-store?${params.toString()}`);
                if (!res2.ok) throw new Error(`HTTP ${res2.status}`);
                const data2 = await res2.json();
                return data2.stores || [];
            }
        }

        const state = {
            current: { page: PAGE, position: "", priority: "1" },
        };

        function setModalStatus(msg) {
            const s = el("modalStatus");
            if (s) s.textContent = msg || "";
        }

        function setPreview(url) {
            const img = el("currentPreviewImg");
            const empty = el("currentPreviewEmpty");
            if (!img || !empty) return;
            const u = clean(url);
            if (u) {
                img.src = u;
                img.classList.remove("hidden");
                empty.classList.add("hidden");
            } else {
                img.src = "";
                img.classList.add("hidden");
                empty.classList.remove("hidden");
            }
        }

        function setSelectedSummary({ imageUrl, storeText }) {
            if (el("textSelectedImage")) el("textSelectedImage").textContent = imageUrl ? "ìˆìŒ" : "ì—†ìŒ";
            if (el("textSelectedStore")) el("textSelectedStore").textContent = storeText || "ì—†ìŒ";
        }

        function getMode() {
            return document.querySelector('input[name="slotMode"]:checked')?.value || "image";
        }

        function applyModeUI(mode) {
            const textOnlyHint = el("textOnlyHint");
            const textBlock = el("textBlock");
            const linkBlock = el("linkBlock");
            const dividerAfterLink = el("dividerAfterLink");
            const imageBlock = el("imageBlock");
            const storeBlock = el("storeBlock");

            if (mode === "text") {
                textOnlyHint?.classList.remove("hidden");
                textBlock?.classList.remove("hidden");
                linkBlock?.classList.add("hidden");
                dividerAfterLink?.classList.add("hidden");
                imageBlock?.classList.add("hidden");
                storeBlock?.classList.add("hidden");
            } else if (mode === "store") {
                textOnlyHint?.classList.add("hidden");
                textBlock?.classList.add("hidden");
                linkBlock?.classList.remove("hidden");
                dividerAfterLink?.classList.remove("hidden");
                imageBlock?.classList.remove("hidden");
                storeBlock?.classList.remove("hidden");
            } else {
                textOnlyHint?.classList.add("hidden");
                textBlock?.classList.add("hidden");
                linkBlock?.classList.remove("hidden");
                dividerAfterLink?.classList.remove("hidden");
                imageBlock?.classList.remove("hidden");
                storeBlock?.classList.add("hidden");
            }
        }

        function clearModalFields() {
            setModalStatus("");
            el("fieldTextContent") && (el("fieldTextContent").value = "");
            el("fieldLinkUrl") && (el("fieldLinkUrl").value = "");
            el("fieldImageFile") && (el("fieldImageFile").value = "");
            el("fieldBizNo") && (el("fieldBizNo").value = "");
            el("fieldBizName") && (el("fieldBizName").value = "");
            el("fieldStoreId") && (el("fieldStoreId").value = "");
            el("fieldTableSource") && (el("fieldTableSource").value = "");
            el("fieldStartAt") && (el("fieldStartAt").value = "");
            el("fieldEndAt") && (el("fieldEndAt").value = "");
            el("fieldNoEnd") && (el("fieldNoEnd").checked = false);
            el("fieldEndAt") && (el("fieldEndAt").disabled = false);

            const modal = el("slotModal");
            if (modal) modal.dataset.currentImage = "";
            setPreview("");
            el("storeResultsBody") && (el("storeResultsBody").innerHTML = `ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ê³  â€œê°€ê²Œ ê²€ìƒ‰â€ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.`);
            setSelectedSummary({ imageUrl: "", storeText: "" });
        }

        function toDatetimeLocal(v) {
            const s = clean(v);
            if (!s) return "";
            const iso = s.includes("T") ? s : s.replace(" ", "T");
            return iso.slice(0, 16);
        }

        async function refreshCandidateList() {
            const pos = clean(state.current.position);
            if (!pos) return;

            try {
                const items = await apiListSlotItems({ page: PAGE, position: pos });
                const list = el("candidateList");
                if (!list) return;

                list.innerHTML = "";
                if (!items.length) {
                    list.innerHTML = `<div class="text-xs text-slate-500">ë“±ë¡ëœ í›„ë³´ ì—†ìŒ</div>`;
                    return;
                }

                items
                    .filter(x => x && x.priority != null)
                    .sort((a, b) => Number(a.priority) - Number(b.priority))
                    .slice(0, 12)
                    .forEach((it) => {
                        const p = String(it.priority);
                        const mode = clean(it.slot_mode || it.slotMode || "");
                        const name = clean(it.business_name || it.businessName || "");
                        const hasImg = !!clean(it.image_url || it.imageUrl || "");
                        const span = document.createElement("div");
                        span.className = "neo-card px-3 py-2 flex items-center justify-between gap-2";
                        span.innerHTML = `
            <div class="min-w-0">
              <div class="text-xs font-extrabold text-slate-800 truncate">priority ${p} Â· ${mode || "-"}</div>
              <div class="text-[11px] text-slate-500 truncate">${name ? name : (hasImg ? "ì´ë¯¸ì§€ ë°°ë„ˆ" : "í…ìŠ¤íŠ¸/ë§í¬")}</div>
            </div>
            <button class="btn-3d shrink-0" type="button">ë¶ˆëŸ¬ì˜¤ê¸°</button>
          `;
                        span.querySelector("button").addEventListener("click", async () => {
                            el("adPriority").value = p;
                            state.current.priority = p;
                            await loadSlotIntoModal();
                        });
                        list.appendChild(span);
                    });

                el("prioritySupportHint") && (el("prioritySupportHint").textContent = "í›„ë³´ëŠ” ì„œë²„ì— ë“±ë¡ëœ ìš°ì„ ìˆœìœ„ ëª©ë¡ ê¸°ì¤€ì…ë‹ˆë‹¤.");
            } catch (e) {
                const list = el("candidateList");
                if (list) list.innerHTML = `<div class="text-xs text-slate-500">í›„ë³´ ëª©ë¡ API ë¯¸ì§€ì›</div>`;
            }
        }

        async function loadSlotIntoModal() {
            setModalStatus("ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...");

            const position = clean(state.current.position);
            const priority = clean(el("adPriority")?.value || state.current.priority || "1") || "1";
            state.current.priority = priority;

            const data = await apiGetSlot({ page: PAGE, position, priority });
            const slot = data?.slot ?? data;

            if (!slot) {
                setModalStatus("ìŠ¬ë¡¯ ì—†ìŒ(ì‹ ê·œ)");
                setPreview("");
                return;
            }

            const mode = clean(slot.slot_mode || slot.slotMode || "image");
            document.querySelectorAll('input[name="slotMode"]').forEach(r => r.checked = (r.value === mode));
            applyModeUI(mode);

            const startAt = clean(slot.start_at || slot.startAt || "");
            const endAt = clean(slot.end_at || slot.endAt || "");
            const noEnd = String(slot.no_end ?? slot.noEnd ?? "").toLowerCase() === "true" || slot.no_end === true || slot.noEnd === true;

            el("fieldStartAt") && (el("fieldStartAt").value = toDatetimeLocal(startAt));
            el("fieldEndAt") && (el("fieldEndAt").value = toDatetimeLocal(endAt));
            el("fieldNoEnd") && (el("fieldNoEnd").checked = !!noEnd);
            el("fieldEndAt") && (el("fieldEndAt").disabled = !!noEnd);

            el("fieldTextContent") && (el("fieldTextContent").value = clean(slot.text_content || slot.textContent || ""));
            el("fieldLinkUrl") && (el("fieldLinkUrl").value = clean(slot.link_url || slot.linkUrl || ""));

            const imageUrl = clean(slot.image_url || slot.imageUrl || "");
            const modal = el("slotModal");
            if (modal) modal.dataset.currentImage = imageUrl || "";
            setPreview(imageUrl);

            const storeId = clean(slot.store_id || slot.storeId || "");
            const tableSource = clean(slot.table_source || slot.tableSource || DEFAULT_TABLE_SOURCE);
            const bizNo = clean(slot.business_no || slot.businessNo || "");
            const bizName = clean(slot.business_name || slot.businessName || "");

            el("fieldStoreId") && (el("fieldStoreId").value = storeId);
            el("fieldTableSource") && (el("fieldTableSource").value = tableSource);
            el("fieldBizNo") && (el("fieldBizNo").value = bizNo);
            el("fieldBizName") && (el("fieldBizName").value = bizName);

            const storeText = bizName ? bizName : "";
            setSelectedSummary({ imageUrl: imageUrl, storeText });

            setModalStatus("ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ");
        }

        async function openSlotModal(position) {
            const modal = el("slotModal");
            if (!modal) return;

            const pos = clean(position);
            state.current.page = PAGE;
            state.current.position = pos;
            state.current.priority = clean(el("adPriority")?.value || "1") || "1";

            modal.dataset.page = PAGE;
            modal.dataset.position = pos;

            el("modalPageText") && (el("modalPageText").textContent = PAGE);
            el("modalPositionText") && (el("modalPositionText").textContent = pos);

            clearModalFields();

            // ê¸°ë³¸ mode image
            document.querySelectorAll('input[name="slotMode"]').forEach(r => r.checked = (r.value === "image"));
            applyModeUI("image");

            modal.classList.remove("hidden");

            try { await loadSlotIntoModal(); } catch (_) { setModalStatus("ìŠ¬ë¡¯ ë¡œë“œ ì‹¤íŒ¨ (ì‹ ê·œ ì…ë ¥ ê°€ëŠ¥)"); }
            await refreshCandidateList();
        }

        function closeSlotModal() {
            const modal = el("slotModal");
            if (!modal) return;
            modal.classList.add("hidden");
        }

        function isModalEmptyForDelete() {
            const textContent = clean(el("fieldTextContent")?.value);
            const linkUrl = clean(el("fieldLinkUrl")?.value);
            const storeId = clean(el("fieldStoreId")?.value);
            const file = el("fieldImageFile")?.files?.[0];
            const currentImage = clean(el("slotModal")?.dataset.currentImage || "");
            const startAt = clean(el("fieldStartAt")?.value);
            const endAt = clean(el("fieldEndAt")?.value);
            const noEnd = el("fieldNoEnd")?.checked ? true : false;

            return (!textContent && !linkUrl && !storeId && !file && !currentImage && !startAt && !endAt && !noEnd);
        }

        function ensureStoreSelectedOrRevert() {
            const storeId = clean(el("fieldStoreId")?.value);
            if (storeId) return true;

            alert("ê°€ê²Œ ì—°ê²°ì€ ê²€ìƒ‰ ê²°ê³¼ì—ì„œ 'ì„ íƒ'ì„ ëˆŒëŸ¬ì•¼ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            document.querySelectorAll('input[name="slotMode"]').forEach(r => r.checked = (r.value === "image"));
            applyModeUI("image");
            el("storeSearchHint") && (el("storeSearchHint").textContent = "ë¨¼ì € ê°€ê²Œ ê²€ìƒ‰ â†’ 'ì„ íƒ' í›„ ë‹¤ì‹œ ì €ì¥í•˜ì„¸ìš”.");
            return false;
        }

        async function saveSlotFromModal() {
            try {
                setModalStatus("ì €ì¥ ì¤‘...");

                const position = clean(state.current.position);
                if (!position) throw new Error("position(ìŠ¬ë¡¯)ì´ ë¹„ì–´ìˆìŒ");

                if (isModalEmptyForDelete()) {
                    const priority = clean(el("adPriority")?.value || "1") || "1";
                    setModalStatus("ë¹ˆ ê°’ ê°ì§€ â†’ ì‚­ì œ ì²˜ë¦¬ ì¤‘...");
                    await apiDeleteSlot({ page: PAGE, position, priority });
                    clearModalFields();
                    setModalStatus("ì‚­ì œ ì™„ë£Œ âœ…");
                    alert("ì‚­ì œ ì™„ë£Œ âœ…");
                    return;
                }

                const mode = getMode();
                if (mode === "store") {
                    const ok = ensureStoreSelectedOrRevert();
                    if (!ok) return;
                }

                const priority = clean(el("adPriority")?.value || "1") || "1";
                state.current.priority = priority;

                const fd = new FormData();
                fd.append("page", PAGE);
                fd.append("position", position);
                fd.append("priority", priority);

                const slotType = (mode === "text") ? "text" : "banner";
                fd.append("slot_type", slotType);
                fd.append("slotType", slotType);
                fd.append("slot_mode", mode);
                fd.append("slotMode", mode);

                const startAt = clean(el("fieldStartAt")?.value);
                const endAt = clean(el("fieldEndAt")?.value);
                const noEnd = el("fieldNoEnd")?.checked ? "true" : "false";
                fd.append("start_at", startAt);
                fd.append("startAt", startAt);
                fd.append("end_at", endAt);
                fd.append("endAt", endAt);
                fd.append("no_end", noEnd);
                fd.append("noEnd", noEnd);

                const linkUrl = clean(el("fieldLinkUrl")?.value);
                const textContent = clean(el("fieldTextContent")?.value);
                fd.append("link_url", linkUrl);
                fd.append("linkUrl", linkUrl);
                fd.append("text_content", textContent);
                fd.append("textContent", textContent);

                const modal = el("slotModal");
                const currentImage = clean(modal?.dataset.currentImage || "");
                const file = el("fieldImageFile")?.files?.[0];

                if (file) {
                    fd.append("image", file);
                } else {
                    if (currentImage) {
                        fd.append("image_url", currentImage);
                        fd.append("imageUrl", currentImage);
                        fd.append("keep_image", "true");
                        fd.append("keepImage", "true");
                    } else {
                        fd.append("clear_image", "true");
                        fd.append("clearImage", "true");
                    }
                }

                if (mode === "store") {
                    const storeId = clean(el("fieldStoreId")?.value);
                    if (!storeId) throw new Error("ê°€ê²Œì—°ê²° ëª¨ë“œì¸ë° store_idê°€ ë¹„ì–´ìˆìŒ(ê°€ê²Œ ì„ íƒ ë¨¼ì €)");

                    const tableSource = clean(el("fieldTableSource")?.value) || DEFAULT_TABLE_SOURCE;
                    const businessNo = clean(el("fieldBizNo")?.value);
                    const businessName = clean(el("fieldBizName")?.value);

                    fd.append("table_source", tableSource);
                    fd.append("tableSource", tableSource);
                    fd.append("store_id", storeId);
                    fd.append("storeId", storeId);
                    fd.append("business_no", businessNo);
                    fd.append("businessNo", businessNo);
                    fd.append("business_name", businessName);
                    fd.append("businessName", businessName);
                } else {
                    fd.append("table_source", "");
                    fd.append("tableSource", "");
                    fd.append("store_id", "");
                    fd.append("storeId", "");
                    fd.append("business_no", "");
                    fd.append("businessNo", "");
                    fd.append("business_name", "");
                    fd.append("businessName", "");
                }

                await apiUpsertSlot(fd);

                clearModalFields();
                el("adPriority") && (el("adPriority").value = "1");
                state.current.priority = "1";

                setModalStatus("ì €ì¥ ì™„ë£Œ âœ…");
                alert("ì €ì¥ ì™„ë£Œ âœ…");
            } catch (e) {
                setModalStatus(`âŒ ì €ì¥ ì‹¤íŒ¨: ${e.message}`);
                alert(`ì €ì¥ ì‹¤íŒ¨: ${e.message || "ì €ì¥ ì˜¤ë¥˜"}`);
            }
        }

        async function doStoreSearch() {
            const qRaw = clean(el("fieldBizName")?.value);
            const bizRaw = digitsOnly(clean(el("fieldBizNo")?.value));

            const q = qRaw.length ? qRaw : "__all__";
            const bizNo = qRaw ? "" : bizRaw;

            const wrap = el("storeResultsBody");
            if (wrap) wrap.innerHTML = `<div class="text-sm text-slate-500">ê²€ìƒ‰ ì¤‘...</div>`;

            try {
                const stores = await apiSearchStore(q, bizNo);
                if (!Array.isArray(stores) || stores.length === 0) {
                    if (wrap) wrap.innerHTML = `<div class="text-sm text-slate-500">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</div>`;
                    setModalStatus("ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ");
                    return;
                }
                renderStoreResults(stores);
            } catch (e) {
                setModalStatus(`ê²€ìƒ‰ ì˜¤ë¥˜: ${e.message || "error"}`);
                if (wrap) wrap.innerHTML = `<div class="text-sm text-rose-600">ê²€ìƒ‰ ì˜¤ë¥˜: ${e.message || "error"}</div>`;
            }
        }

        function renderStoreResults(stores) {
            const wrap = el("storeResultsBody");
            if (!wrap) return;

            wrap.innerHTML = "";
            stores.forEach((s) => {
                const id = clean(s.id || s.store_id || s.storeId);
                const biz = clean(s.business_no || s.businessNo || s.business_number || "");
                const name = clean(s.business_name || s.businessName || "");
                const tableSource = clean(s.table_source || s.tableSource || DEFAULT_TABLE_SOURCE);

                const row = document.createElement("div");
                row.className = "neo-card p-3 flex gap-3 items-center mb-2";

                const infoDiv = document.createElement("div");
                infoDiv.className = "flex-1 min-w-0";
                infoDiv.innerHTML = `
        <div class="font-extrabold text-slate-800 truncate">${name || "-"}</div>
        <div class="text-xs text-slate-600 mt-0.5 truncate">${biz ? `Â· ${biz}` : ""}</div>
        <div class="text-[11px] text-slate-400 mt-0.5 truncate">${tableSource} Â· id=${id}</div>
      `;

                const btn = document.createElement("button");
                btn.className = "btn-3d shrink-0";
                btn.type = "button";
                btn.textContent = "ì„ íƒ";
                btn.addEventListener("click", () => {
                    if (!id) { alert("ì‹¤ì œ ê°€ê²Œ ê²°ê³¼ê°€ ì•„ë‹™ë‹ˆë‹¤."); return; }
                    el("fieldStoreId") && (el("fieldStoreId").value = id);
                    el("fieldTableSource") && (el("fieldTableSource").value = tableSource);
                    el("fieldBizNo") && (el("fieldBizNo").value = biz);
                    el("fieldBizName") && (el("fieldBizName").value = name);

                    // store ëª¨ë“œë¡œ
                    document.querySelectorAll('input[name="slotMode"]').forEach((r) => (r.checked = (r.value === "store")));
                    applyModeUI("store");

                    // ë§í¬ ìë™
                    el("fieldLinkUrl") && (el("fieldLinkUrl").value = buildStoreLink(tableSource, id));

                    setSelectedSummary({ imageUrl: clean(el("slotModal")?.dataset.currentImage || ""), storeText: name || "" });
                    setModalStatus("ê°€ê²Œ ì—°ê²° ì™„ë£Œ (ì €ì¥ ëˆ„ë¥´ì„¸ìš”)");
                });

                row.appendChild(infoDiv);
                row.appendChild(btn);
                wrap.appendChild(row);
            });
        }

        function bindModalEvents() {
            el("btnCloseModal")?.addEventListener("click", (e) => { e.preventDefault(); closeSlotModal(); });
            el("slotModal")?.querySelector(".modal-backdrop")?.addEventListener("click", () => closeSlotModal());
            document.addEventListener("keydown", (e) => {
                if (e.key !== "Escape") return;
                if (!el("slotModal")?.classList.contains("hidden")) closeSlotModal();
            });

            document.querySelectorAll('input[name="slotMode"]').forEach((r) => {
                r.addEventListener("change", () => applyModeUI(getMode()));
            });

            el("fieldNoEnd")?.addEventListener("change", () => {
                const end = el("fieldEndAt");
                if (end) end.disabled = !!el("fieldNoEnd").checked;
            });

            el("fieldImageFile")?.addEventListener("change", () => {
                const f = el("fieldImageFile").files && el("fieldImageFile").files[0];
                if (!f) return;
                const url = URL.createObjectURL(f);
                const modal = el("slotModal");
                if (modal) modal.dataset.currentImage = url;
                setPreview(url);
                setSelectedSummary({ imageUrl: url, storeText: clean(el("textSelectedStore")?.textContent) });
            });

            el("btnSearchStore")?.addEventListener("click", (e) => { e.preventDefault(); doStoreSearch(); });
            el("btnSaveSlot")?.addEventListener("click", (e) => { e.preventDefault(); saveSlotFromModal(); });

            el("btnResetModal")?.addEventListener("click", async (e) => {
                e.preventDefault();
                const pos = clean(state.current.position);
                const priority = clean(el("adPriority")?.value || "1") || "1";
                if (!pos) return alert("ìŠ¬ë¡¯(position)ì´ ì—†ì–´ ì´ˆê¸°í™”ë¥¼ ì§„í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                const ok = confirm("ì…ë ¥ ì´ˆê¸°í™” ì‹œ, ì´ ìš°ì„ ìˆœìœ„ ë°ì´í„°ê°€ DBì—ì„œ ì‚­ì œë©ë‹ˆë‹¤. ì§„í–‰í• ê¹Œìš”?");
                if (!ok) return;
                await apiDeleteSlot({ page: PAGE, position: pos, priority });
                clearModalFields();
                alert("ì´ˆê¸°í™”(ì‚­ì œ) ì™„ë£Œ âœ…");
            });

            el("btnLoadPriority")?.addEventListener("click", async (e) => { e.preventDefault(); await loadSlotIntoModal(); });

            el("btnDeletePriority")?.addEventListener("click", async (e) => {
                e.preventDefault();
                const ok = confirm("ì •ë§ ì´ ìš°ì„ ìˆœìœ„ë¥¼ ì‚­ì œí• ê¹Œìš”?");
                if (!ok) return;
                const pos = clean(state.current.position);
                const priority = clean(el("adPriority")?.value || "1") || "1";
                await apiDeleteSlot({ page: PAGE, position: pos, priority });
                clearModalFields();
                alert("ì‚­ì œ ì™„ë£Œ âœ…");
                await refreshCandidateList();
            });

            // ì‚¬ìš©ë²• íŒì˜¤ë²„
            const helpBtn = el("adHelpBtn");
            const helpPop = el("adHelpPopover");
            const helpClose = el("adHelpCloseBtn");
            helpBtn?.addEventListener("click", (e) => {
                e.preventDefault();
                helpPop?.classList.toggle("hidden");
                const open = !helpPop?.classList.contains("hidden");
                helpBtn.setAttribute("aria-expanded", open ? "true" : "false");
            });
            helpClose?.addEventListener("click", (e) => {
                e.preventDefault();
                helpPop?.classList.add("hidden");
                helpBtn?.setAttribute("aria-expanded", "false");
            });
        }

        function bindAdminClicks() {
            if (!isManager) return;

            document.addEventListener("click", async (e) => {
                // ëª¨ë‹¬ ë‚´ë¶€ í´ë¦­ ë¬´ì‹œ
                if (e.target.closest("#slotModal")) return;

                const target = e.target.closest("[data-position]");
                if (!target) return;

                e.preventDefault();
                e.stopPropagation();

                const position = target.getAttribute("data-position") || "";
                if (!position) return;

                await openSlotModal(position);
            }, true);
        }

        document.addEventListener("DOMContentLoaded", () => {
            if (!isManager) return;

            bindAdminClicks();
            bindModalEvents();

            // ê´€ë¦¬ì ëª¨ë“œì„ì„ titleì— í‘œì‹œ(ëˆˆì— ê±°ìŠ¬ë¦¬ë©´ ì œê±° ê°€ëŠ¥)
            try { document.title = "ê´€ë¦¬ëª¨ë“œ | " + document.title; } catch (_) { }
        });
    </script>
    </body>

</html>