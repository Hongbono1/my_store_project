<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>subcategorymanager</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body {
            font-family: 'Noto Sans KR', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        .neo-card {
            background: rgba(255, 255, 255, 0.92);
            border: 2px solid rgba(59, 130, 246, 0.16);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 1rem;
            box-shadow:
                10px 10px 22px rgba(0, 0, 0, 0.06),
                -10px -10px 22px rgba(255, 255, 255, 0.9);
            transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
        }

        .neo-card:hover {
            transform: translateY(-3px);
            border-color: rgba(59, 130, 246, 0.28);
            box-shadow:
                8px 8px 18px rgba(0, 0, 0, 0.07),
                -8px -8px 18px rgba(255, 255, 255, 0.9),
                0 12px 28px rgba(59, 130, 246, 0.14);
        }

        .kbd {
            border: 1px solid rgba(0, 0, 0, 0.08);
            border-bottom-width: 2px;
            border-radius: .5rem;
            padding: .15rem .45rem;
            background: rgba(255, 255, 255, 0.9);
            font-size: .75rem;
        }

        .pill {
            display: inline-flex;
            align-items: center;
            gap: .35rem;
            padding: .35rem .6rem;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, .35);
            background: rgba(248, 250, 252, .9);
            font-weight: 800;
            font-size: .75rem;
            color: rgb(51, 65, 85);
        }

        .btn {
            height: 2.75rem;
            border-radius: 0.9rem;
            font-weight: 900;
            border: 1px solid rgba(226, 232, 240, 1);
            background: white;
        }

        .btn:hover {
            background: rgb(248, 250, 252);
        }

        .btn-primary {
            border: none;
            background: rgb(37, 99, 235);
            color: white;
            box-shadow: 0 10px 20px rgba(37, 99, 235, .18);
        }

        .btn-primary:hover {
            background: rgb(29, 78, 216);
        }

        .btn-indigo {
            border: none;
            background: rgb(79, 70, 229);
            color: white;
            box-shadow: 0 10px 20px rgba(79, 70, 229, .18);
        }

        .btn-indigo:hover {
            background: rgb(67, 56, 202);
        }

        .btn-emerald {
            border: none;
            background: rgb(5, 150, 105);
            color: white;
            box-shadow: 0 10px 20px rgba(5, 150, 105, .18);
        }

        .btn-emerald:hover {
            background: rgb(4, 120, 87);
        }

        .btn-amber {
            border: none;
            background: rgb(245, 158, 11);
            color: white;
            box-shadow: 0 10px 20px rgba(245, 158, 11, .18);
        }

        .btn-amber:hover {
            background: rgb(217, 119, 6);
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-800 min-h-screen flex flex-col">
    <div id="header-placeholder"></div>

    <!-- 상단 매니저바 -->
    <section class="sticky top-0 z-40 bg-white/80 backdrop-blur border-b border-slate-200">
        <div class="max-w-7xl mx-auto px-4 py-3">
            <div class="flex flex-col gap-3 lg:flex-row lg:items-center lg:justify-between">
                <!-- 좌: 타이틀 -->
                <div class="flex items-center justify-between gap-3">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-indigo-500 text-white flex items-center justify-center shadow">
                            <span class="font-black">SC</span>
                        </div>
                        <div>
                            <div class="text-lg font-extrabold leading-tight">서브카테고리 매니저</div>
                            <div class="text-xs text-slate-500">푸드/통합 · 베스트/뉴(동시 표시) · 기본 8 / 더보기 +12</div>
                        </div>
                    </div>
                </div>

                <!-- 우: 푸드/통합 토글 + 정렬/검색/초기화 -->
                <div class="flex flex-col sm:flex-row gap-2 sm:items-center">
                    <div class="flex items-center gap-2">
                        <span id="modeBadge"
                            class="text-xs px-2 py-1 rounded-full bg-blue-50 text-blue-700 border border-blue-100 font-bold">푸드</span>
                        <div class="flex items-center bg-slate-100 p-1 rounded-xl border border-slate-200">
                            <button id="btnModeFood"
                                class="px-3 py-1.5 rounded-lg text-sm font-bold bg-white shadow-sm border border-slate-200">푸드</button>
                            <button id="btnModeCombined"
                                class="px-3 py-1.5 rounded-lg text-sm font-bold text-slate-600 hover:text-slate-800">통합</button>
                        </div>
                    </div>

                    <div class="flex items-center gap-2">
                        <label class="text-xs font-bold text-slate-600">정렬</label>
                        <select id="sortSelect"
                            class="h-10 rounded-xl border border-slate-200 bg-white px-3 text-sm font-semibold focus:outline-none focus:ring-2 focus:ring-blue-200">
                            <option value="posAsc">번호(오름차순)</option>
                            <option value="filledFirst">채워진 슬롯 먼저</option>
                            <option value="titleAsc">제목(A→Z)</option>
                        </select>
                    </div>

                    <div class="flex items-center gap-2">
                        <div class="relative">
                            <input id="searchInput" type="text" placeholder="검색(제목/링크/가게)"
                                class="h-10 w-64 max-w-full rounded-xl border border-slate-200 bg-white px-3 pr-10 text-sm font-semibold focus:outline-none focus:ring-2 focus:ring-blue-200" />
                            <button id="btnClearSearch"
                                class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-700"
                                title="검색 지우기">
                                ✕
                            </button>
                        </div>

                        <button id="btnReset"
                            class="h-10 px-4 rounded-xl border border-slate-200 bg-white text-sm font-extrabold hover:bg-slate-50">
                            초기화
                        </button>
                    </div>
                </div>
            </div>

            <div class="mt-2 flex flex-col md:flex-row md:items-center md:justify-between gap-2">
                <div class="text-xs text-slate-500">
                    <span class="font-bold text-slate-700">표시:</span>
                    베스트 <span id="bestVisibleText" class="font-extrabold">8</span>개,
                    New <span id="newVisibleText" class="font-extrabold">8</span>개
                    <span class="mx-2 text-slate-300">|</span>
                    <span class="font-bold text-slate-700">단축키:</span>
                    <span class="kbd">ESC</span> 모달닫기
                </div>
                <div id="topStatus"
                    class="text-xs px-3 py-2 rounded-xl border border-slate-200 bg-white text-slate-600 hidden"></div>
            </div>
        </div>
    </section>

    <main class="max-w-7xl mx-auto w-full px-4 py-6 flex-1 space-y-8">

        <!-- =========================
         베스트 섹션
    ========================== -->
        <section>
            <div class="flex items-center justify-between mb-3">
                <div>
                    <div class="text-base font-extrabold">베스트</div>
                    <div class="text-xs text-slate-500">배너 + 슬롯(기본 8, 더보기 +12)</div>
                </div>
                <button id="btnMoreBest" class="btn btn-emerald px-5">더보기 +12</button>
            </div>

            <!-- 베스트 배너 -->
            <div class="neo-card p-4 mb-4">
                <div class="flex items-start justify-between gap-3">
                    <div>
                        <div class="text-sm font-extrabold">상단 배너 (베스트)</div>
                        <div class="text-xs text-slate-500 mt-1">
                            현재 모드: <span id="bestBannerModeText" class="font-bold">푸드</span>
                            <span class="mx-2 text-slate-300">|</span>
                            position: <span id="bestBannerPosText" class="font-bold">-</span>
                        </div>
                    </div>
                    <button id="btnEditBestBanner" class="btn btn-indigo px-5">배너 편집</button>
                </div>

                <div class="mt-3 grid grid-cols-1 md:grid-cols-3 gap-3 items-stretch">
                    <div class="md:col-span-2 rounded-2xl border border-slate-200 bg-slate-50 overflow-hidden">
                        <img id="bestBannerPreview" src="/uploads/no-image.png" alt="banner"
                            class="w-full h-44 object-cover" onerror="this.src='/uploads/no-image.png';" />
                    </div>

                    <div class="rounded-2xl border border-slate-200 bg-white p-3">
                        <div class="text-xs text-slate-500">배너 정보</div>
                        <div class="mt-2">
                            <div class="text-xs font-bold text-slate-600">제목</div>
                            <div id="bestBannerTitle" class="text-sm font-extrabold text-slate-800 mt-1">-</div>
                        </div>
                        <div class="mt-3">
                            <div class="text-xs font-bold text-slate-600">연결</div>
                            <div class="text-sm font-extrabold text-slate-800 mt-1">
                                <span id="bestBannerLinkType" class="pill">-</span>
                                <span id="bestBannerLinkValue" class="ml-1">-</span>
                            </div>
                        </div>
                        <div class="mt-3 text-xs text-slate-500">
                            * 배너도 저장은 <span class="font-bold">/admin/subcategory/update</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 베스트 슬롯 그리드 -->
            <div id="bestGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div>

            <div class="mt-4 flex justify-center">
                <button id="btnMoreBestBottom" class="btn px-6">더보기 +12</button>
            </div>
        </section>

        <!-- =========================
         NEW registration 섹션
    ========================== -->
        <section>
            <div class="flex items-center justify-between mb-3">
                <div>
                    <div class="text-base font-extrabold">New registration</div>
                    <div class="text-xs text-slate-500">배너 + 슬롯(기본 8, 더보기 +12)</div>
                </div>
                <button id="btnMoreNew" class="btn btn-amber px-5">더보기 +12</button>
            </div>

            <!-- 뉴 배너 -->
            <div class="neo-card p-4 mb-4">
                <div class="flex items-start justify-between gap-3">
                    <div>
                        <div class="text-sm font-extrabold">상단 배너 (New registration)</div>
                        <div class="text-xs text-slate-500 mt-1">
                            현재 모드: <span id="newBannerModeText" class="font-bold">푸드</span>
                            <span class="mx-2 text-slate-300">|</span>
                            position: <span id="newBannerPosText" class="font-bold">-</span>
                        </div>
                    </div>
                    <button id="btnEditNewBanner" class="btn btn-indigo px-5">배너 편집</button>
                </div>

                <div class="mt-3 grid grid-cols-1 md:grid-cols-3 gap-3 items-stretch">
                    <div class="md:col-span-2 rounded-2xl border border-slate-200 bg-slate-50 overflow-hidden">
                        <img id="newBannerPreview" src="/uploads/no-image.png" alt="banner"
                            class="w-full h-44 object-cover" onerror="this.src='/uploads/no-image.png';" />
                    </div>

                    <div class="rounded-2xl border border-slate-200 bg-white p-3">
                        <div class="text-xs text-slate-500">배너 정보</div>
                        <div class="mt-2">
                            <div class="text-xs font-bold text-slate-600">제목</div>
                            <div id="newBannerTitle" class="text-sm font-extrabold text-slate-800 mt-1">-</div>
                        </div>
                        <div class="mt-3">
                            <div class="text-xs font-bold text-slate-600">연결</div>
                            <div class="text-sm font-extrabold text-slate-800 mt-1">
                                <span id="newBannerLinkType" class="pill">-</span>
                                <span id="newBannerLinkValue" class="ml-1">-</span>
                            </div>
                        </div>
                        <div class="mt-3 text-xs text-slate-500">
                            * 배너도 저장은 <span class="font-bold">/admin/subcategory/update</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 뉴 슬롯 그리드 -->
            <div id="newGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div>

            <div class="mt-4 flex justify-center">
                <button id="btnMoreNewBottom" class="btn px-6">더보기 +12</button>
            </div>
        </section>

    </main>

    <!-- =========================
       모달 (ncategory2 스타일 구성)
  ========================== -->
    <div id="modalOverlay" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/45"></div>

        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div class="w-full max-w-3xl neo-card overflow-hidden">
                <!-- 헤더 -->
                <div
                    class="px-5 py-4 border-b border-slate-200 bg-white/70 backdrop-blur flex items-start justify-between">
                    <div class="space-y-1">
                        <div class="text-lg font-extrabold">슬롯 수정</div>
                        <div class="text-xs text-slate-500">
                            page: <span id="modalPageText" class="font-extrabold text-slate-700">subcategory</span>
                            <span class="mx-2 text-slate-300">/</span>
                            position: <span id="modalPosText" class="font-extrabold text-slate-700">-</span>
                        </div>
                    </div>

                    <div class="flex items-center gap-2">
                        <button id="btnModalHelp" class="btn px-4 text-sm">사용법</button>
                        <button id="btnModalClose"
                            class="w-10 h-10 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 font-black">✕</button>
                    </div>
                </div>

                <!-- 사용법 -->
                <div id="modalHelpBox" class="hidden border-b border-slate-200 bg-slate-50">
                    <div class="p-4 text-sm text-slate-700 space-y-2">
                        <div class="font-extrabold">사용법</div>
                        <ul class="list-disc pl-5 space-y-1 text-[13px] text-slate-600">
                            <li>광고 방식(이미지 배너/가게 연결/텍스트 전용)을 선택합니다.</li>
                            <li>가게 연결 시, 검색으로 가게를 선택하면 연결 정보가 “현재 선택 정보”에 표시됩니다.</li>
                            <li>파일을 선택하지 않으면 기존 이미지(또는 가게 연결 시 대표 이미지)를 유지하는 방식으로 서버에서 처리합니다.</li>
                            <li>우선순위(1이 가장 먼저)와 광고 기간(종료 없음 포함)을 설정할 수 있습니다.</li>
                            <li>저장 실패(404 포함) 시 모달 하단 상태 영역에 오류가 표시됩니다.</li>
                        </ul>
                    </div>
                </div>

                <!-- 바디 -->
                <div class="p-5 bg-white space-y-5">

                    <!-- 광고 방식 선택 -->
                    <div class="space-y-2">
                        <div class="text-sm font-extrabold">광고 방식 선택</div>
                        <div class="flex flex-wrap gap-2">
                            <button type="button" data-admode="image" id="btnAdImage" class="btn px-4">이미지 배너</button>
                            <button type="button" data-admode="store" id="btnAdStore" class="btn px-4">가게 연결</button>
                            <button type="button" data-admode="text" id="btnAdText" class="btn px-4">텍스트 전용</button>
                        </div>
                        <div class="text-xs text-slate-500">
                            * 선택에 따라 가게 검색/파일/링크 입력이 달라질 수 있음
                        </div>
                    </div>

                    <!-- 제목 -->
                    <div class="space-y-1">
                        <div class="text-xs font-extrabold text-slate-600">제목</div>
                        <input id="inpTitle" type="text" placeholder="예) 바버라인 / New 오픈 / 추천 업소"
                            class="w-full h-11 rounded-xl border border-slate-200 px-3 text-sm font-semibold focus:outline-none focus:ring-2 focus:ring-blue-200" />
                    </div>

                    <!-- 링크 URL(선택) -->
                    <div class="space-y-1">
                        <div class="text-xs font-extrabold text-slate-600">링크 URL (선택)</div>
                        <input id="inpLinkUrl" type="text" placeholder="/ndetail.html?id=123&type=store 또는 https://..."
                            class="w-full h-11 rounded-xl border border-slate-200 px-3 text-sm font-semibold focus:outline-none focus:ring-2 focus:ring-blue-200" />
                    </div>

                    <!-- 이미지 파일 선택 -->
                    <div class="space-y-2">
                        <div class="text-xs font-extrabold text-slate-600">이미지 파일</div>
                        <input id="inpImageFile" type="file" accept="image/*"
                            class="block w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-xl file:border-0 file:text-sm file:font-extrabold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" />

                        <div class="text-xs text-slate-500">
                            파일을 선택하지 않으면, 기존 이미지(또는 가게 연결 시 가게 대표 이미지)를 유지합니다.
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 items-stretch">
                            <div class="md:col-span-2 space-y-1">
                                <div class="text-xs font-extrabold text-slate-600">이미지 URL</div>
                                <input id="inpImageUrl" type="text" placeholder="/uploads/xxx.jpg 또는 https://..."
                                    class="w-full h-11 rounded-xl border border-slate-200 px-3 text-sm font-semibold focus:outline-none focus:ring-2 focus:ring-blue-200" />
                            </div>

                            <div
                                class="rounded-2xl border border-slate-200 bg-slate-50 overflow-hidden flex items-center justify-center">
                                <img id="imgPreview" src="/uploads/no-image.png" alt="preview"
                                    class="w-full h-full object-cover" />
                            </div>
                        </div>
                    </div>

                    <!-- 가게 연결 -->
                    <div class="space-y-2">
                        <div class="text-sm font-extrabold">가게 연결</div>

                        <div class="flex flex-col md:flex-row gap-2 md:items-center">
                            <input id="inpStoreQuery" type="text" placeholder="가게 검색 (상호/업종/사업자번호 등)"
                                class="flex-1 h-11 rounded-xl border border-slate-200 px-3 text-sm font-semibold focus:outline-none focus:ring-2 focus:ring-blue-200" />
                            <button id="btnStoreSearch" class="btn btn-primary px-5">검색</button>
                        </div>

                        <div id="storeSearchStatus" class="hidden text-sm px-4 py-3 rounded-xl border"></div>

                        <div id="storeResultsBox"
                            class="hidden rounded-2xl border border-slate-200 bg-white overflow-hidden">
                            <div
                                class="px-4 py-2 bg-slate-50 border-b border-slate-200 text-xs font-extrabold text-slate-600">
                                검색 결과
                            </div>
                            <div id="storeResults" class="max-h-60 overflow-auto divide-y"></div>
                        </div>

                        <div class="text-xs text-slate-500">
                            * 서버에 검색 라우터가 없으면 404가 뜰 수 있음(모달 상태에 표시)
                        </div>
                    </div>

                    <!-- 우선순위 + 후보목록 -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="space-y-2">
                            <div class="text-sm font-extrabold">우선순위</div>
                            <input id="inpPriority" type="number" min="1" step="1" value="1"
                                class="w-full h-11 rounded-xl border border-slate-200 px-3 text-sm font-semibold focus:outline-none focus:ring-2 focus:ring-blue-200" />
                            <div class="text-xs text-slate-500">1이 가장 먼저 노출됩니다. (1,2,3… 여러 개 등록 가능)</div>

                            <div class="flex flex-wrap gap-2">
                                <button id="btnLoadPriority" class="btn px-4">이 우선순위 불러오기</button>
                                <button id="btnDeletePriority" class="btn px-4">이 우선순위 삭제</button>
                                <button id="btnShowCandidates" class="btn px-4">등록된 후보 목록 보기 (1~6)</button>
                            </div>

                            <div id="candidatesBox"
                                class="hidden rounded-2xl border border-slate-200 bg-white overflow-hidden">
                                <div
                                    class="px-4 py-2 bg-slate-50 border-b border-slate-200 text-xs font-extrabold text-slate-600">
                                    후보 목록 (priority 1~6)
                                </div>
                                <div id="candidatesList" class="max-h-64 overflow-auto divide-y"></div>
                            </div>
                        </div>

                        <!-- 광고 기간 설정 -->
                        <div class="space-y-2">
                            <div class="text-sm font-extrabold">광고 기간 설정</div>

                            <label class="flex items-center gap-2 text-sm font-semibold text-slate-700">
                                <input id="chkNoEnd" type="checkbox" class="w-4 h-4" />
                                계속 유지 (종료 없음)
                            </label>

                            <div class="grid grid-cols-1 gap-2">
                                <div class="space-y-1">
                                    <div class="text-xs font-extrabold text-slate-600">시작 일시</div>
                                    <input id="inpStartAt" type="datetime-local"
                                        class="w-full h-11 rounded-xl border border-slate-200 px-3 text-sm font-semibold focus:outline-none focus:ring-2 focus:ring-blue-200" />
                                </div>

                                <div class="space-y-1">
                                    <div class="text-xs font-extrabold text-slate-600">종료 일시</div>
                                    <input id="inpEndAt" type="datetime-local"
                                        class="w-full h-11 rounded-xl border border-slate-200 px-3 text-sm font-semibold focus:outline-none focus:ring-2 focus:ring-blue-200" />
                                </div>
                            </div>

                            <div class="text-xs text-slate-500">
                                * 종료 없음 체크 시 종료일시는 서버에서 무시하도록 처리(프론트에서도 비활성)
                            </div>
                        </div>
                    </div>

                    <!-- 현재 선택 정보 -->
                    <div class="neo-card p-4">
                        <div class="text-sm font-extrabold mb-2">현재 선택 정보</div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                            <div class="rounded-2xl border border-slate-200 bg-white p-3">
                                <div class="text-xs font-extrabold text-slate-600">선택 이미지</div>
                                <div id="curSelectedImage" class="mt-1 font-extrabold text-slate-800">없음</div>
                            </div>

                            <div class="rounded-2xl border border-slate-200 bg-white p-3">
                                <div class="text-xs font-extrabold text-slate-600">연결 가게</div>
                                <div id="curConnectedStore" class="mt-1 font-extrabold text-slate-800">없음</div>
                            </div>
                        </div>

                        <div class="mt-3 text-xs text-slate-500">
                            상태: <span id="curStatusText" class="font-extrabold text-slate-700">-</span>
                        </div>
                    </div>

                    <!-- 모달 상태 -->
                    <div id="modalStatus" class="hidden text-sm px-4 py-3 rounded-xl border"></div>

                    <!-- 버튼 -->
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
                        <button id="btnResetInput" class="btn px-5">입력 초기화</button>

                        <div class="flex items-center justify-end gap-2">
                            <button id="btnModalCancel" class="btn px-5">닫기</button>
                            <button id="btnSaveSlot" class="btn btn-primary px-6">슬롯 저장</button>
                        </div>
                    </div>

                </div>
                <!-- /바디 -->
            </div>
        </div>
    </div>

    <script>
        /***********************
         * 요구사항: 기본 8, 더보기 +12
         ***********************/
        const INITIAL_VISIBLE = 8;
        const MORE_STEP = 12;

        /***********************
         * API (요청: 저장은 update만)
         ***********************/
        const UPDATE_API = "/admin/subcategory/update";

        // ✅ 목록/검색/후보 불러오기는 "있으면 쓰고, 없으면 빈칸 유지" 방식
        // 서버 없으면 404 -> 상단/모달 상태에만 표시하고 계속 진행
        const LIST_API = (mode, kind) => `/admin/subcategory/list?mode=${encodeURIComponent(mode)}&kind=${encodeURIComponent(kind)}`;
        const SEARCH_STORE_API = (mode, q) => `/admin/subcategory/search-store?mode=${encodeURIComponent(mode)}&q=${encodeURIComponent(q)}`;
        const CANDIDATES_API = (page, position, mode, kind) =>
            `/admin/subcategory/candidates?page=${encodeURIComponent(page)}&position=${encodeURIComponent(position)}&mode=${encodeURIComponent(mode)}&kind=${encodeURIComponent(kind)}`;

        /***********************
         * 상태
         ***********************/
        const state = {
            page: "subcategory",
            mode: "food", // food | combined

            // 섹션별 표시 개수
            bestVisible: INITIAL_VISIBLE,
            newVisible: INITIAL_VISIBLE,

            // 섹션별 데이터 맵
            bestSlotsMap: new Map(), // position -> data
            newSlotsMap: new Map(),

            // 배너(섹션별)
            bestBanner: null,
            newBanner: null,

            // 검색/정렬
            search: "",
            sort: "posAsc",

            // 모달 타깃
            modalTarget: null, // { kind: "best"|"new", type:"slot"|"banner", index?:number, position:string }
            adMode: "image",   // image|store|text

            // 연결된 가게(모달)
            selectedStore: null // {id,name,type,image_url,link_url}
        };

        /***********************
         * 엘리먼트
         ***********************/
        const $ = (id) => document.getElementById(id);

        const modeBadge = $("modeBadge");
        const btnModeFood = $("btnModeFood");
        const btnModeCombined = $("btnModeCombined");

        const sortSelect = $("sortSelect");
        const searchInput = $("searchInput");
        const btnClearSearch = $("btnClearSearch");
        const btnReset = $("btnReset");

        const bestVisibleText = $("bestVisibleText");
        const newVisibleText = $("newVisibleText");
        const topStatus = $("topStatus");

        // Best section
        const bestGrid = $("bestGrid");
        const btnMoreBest = $("btnMoreBest");
        const btnMoreBestBottom = $("btnMoreBestBottom");
        const bestBannerModeText = $("bestBannerModeText");
        const bestBannerPosText = $("bestBannerPosText");
        const bestBannerPreview = $("bestBannerPreview");
        const bestBannerTitle = $("bestBannerTitle");
        const bestBannerLinkType = $("bestBannerLinkType");
        const bestBannerLinkValue = $("bestBannerLinkValue");
        const btnEditBestBanner = $("btnEditBestBanner");

        // New section
        const newGrid = $("newGrid");
        const btnMoreNew = $("btnMoreNew");
        const btnMoreNewBottom = $("btnMoreNewBottom");
        const newBannerModeText = $("newBannerModeText");
        const newBannerPosText = $("newBannerPosText");
        const newBannerPreview = $("newBannerPreview");
        const newBannerTitle = $("newBannerTitle");
        const newBannerLinkType = $("newBannerLinkType");
        const newBannerLinkValue = $("newBannerLinkValue");
        const btnEditNewBanner = $("btnEditNewBanner");

        // Modal
        const modalOverlay = $("modalOverlay");
        const modalPageText = $("modalPageText");
        const modalPosText = $("modalPosText");

        const btnModalHelp = $("btnModalHelp");
        const modalHelpBox = $("modalHelpBox");
        const btnModalClose = $("btnModalClose");
        const btnModalCancel = $("btnModalCancel");
        const btnSaveSlot = $("btnSaveSlot");

        const btnAdImage = $("btnAdImage");
        const btnAdStore = $("btnAdStore");
        const btnAdText = $("btnAdText");

        const inpTitle = $("inpTitle");
        const inpLinkUrl = $("inpLinkUrl");
        const inpImageFile = $("inpImageFile");
        const inpImageUrl = $("inpImageUrl");
        const imgPreview = $("imgPreview");

        const inpStoreQuery = $("inpStoreQuery");
        const btnStoreSearch = $("btnStoreSearch");
        const storeSearchStatus = $("storeSearchStatus");
        const storeResultsBox = $("storeResultsBox");
        const storeResults = $("storeResults");

        const inpPriority = $("inpPriority");
        const btnLoadPriority = $("btnLoadPriority");
        const btnDeletePriority = $("btnDeletePriority");
        const btnShowCandidates = $("btnShowCandidates");
        const candidatesBox = $("candidatesBox");
        const candidatesList = $("candidatesList");

        const chkNoEnd = $("chkNoEnd");
        const inpStartAt = $("inpStartAt");
        const inpEndAt = $("inpEndAt");

        const curSelectedImage = $("curSelectedImage");
        const curConnectedStore = $("curConnectedStore");
        const curStatusText = $("curStatusText");

        const modalStatus = $("modalStatus");
        const btnResetInput = $("btnResetInput");

        /***********************
         * 유틸
         ***********************/
        function clean(v) {
            if (v === undefined || v === null) return "";
            return String(v).trim();
        }

        function escapeHtml(s) {
            return String(s || "")
                .replaceAll("&", "&amp;")
                .replaceAll("<", "&lt;")
                .replaceAll(">", "&gt;")
                .replaceAll('"', "&quot;")
                .replaceAll("'", "&#039;");
        }

        function safeImg(u) {
            const s = clean(u);
            return s ? s : "/uploads/no-image.png";
        }

        function showTopStatus(msg, type = "info") {
            if (!msg) {
                topStatus.classList.add("hidden");
                topStatus.textContent = "";
                return;
            }
            topStatus.classList.remove("hidden");
            topStatus.textContent = msg;

            topStatus.className = "text-xs px-3 py-2 rounded-xl border";
            if (type === "error") topStatus.classList.add("bg-red-50", "text-red-700", "border-red-200");
            else if (type === "success") topStatus.classList.add("bg-emerald-50", "text-emerald-700", "border-emerald-200");
            else topStatus.classList.add("bg-white", "text-slate-600", "border-slate-200");
        }

        function showModalStatus(msg, type = "info") {
            if (!msg) {
                modalStatus.classList.add("hidden");
                modalStatus.textContent = "";
                return;
            }
            modalStatus.classList.remove("hidden");
            modalStatus.textContent = msg;

            modalStatus.className = "text-sm px-4 py-3 rounded-xl border";
            if (type === "error") modalStatus.classList.add("bg-red-50", "text-red-700", "border-red-200");
            else if (type === "success") modalStatus.classList.add("bg-emerald-50", "text-emerald-700", "border-emerald-200");
            else modalStatus.classList.add("bg-slate-50", "text-slate-700", "border-slate-200");
        }

        function showInlineStatus(el, msg, type = "info") {
            if (!msg) {
                el.classList.add("hidden");
                el.textContent = "";
                return;
            }
            el.classList.remove("hidden");
            el.textContent = msg;

            el.className = "text-sm px-4 py-3 rounded-xl border";
            if (type === "error") el.classList.add("bg-red-50", "text-red-700", "border-red-200");
            else if (type === "success") el.classList.add("bg-emerald-50", "text-emerald-700", "border-emerald-200");
            else el.classList.add("bg-slate-50", "text-slate-700", "border-slate-200");
        }

        function setModeUI() {
            const isFood = state.mode === "food";
            modeBadge.textContent = isFood ? "푸드" : "통합";
            modeBadge.className = isFood
                ? "text-xs px-2 py-1 rounded-full bg-blue-50 text-blue-700 border border-blue-100 font-bold"
                : "text-xs px-2 py-1 rounded-full bg-indigo-50 text-indigo-700 border border-indigo-100 font-bold";

            btnModeFood.className = isFood
                ? "px-3 py-1.5 rounded-lg text-sm font-bold bg-white shadow-sm border border-slate-200"
                : "px-3 py-1.5 rounded-lg text-sm font-bold text-slate-600 hover:text-slate-800";
            btnModeCombined.className = !isFood
                ? "px-3 py-1.5 rounded-lg text-sm font-bold bg-white shadow-sm border border-slate-200"
                : "px-3 py-1.5 rounded-lg text-sm font-bold text-slate-600 hover:text-slate-800";

            bestBannerModeText.textContent = isFood ? "푸드" : "통합";
            newBannerModeText.textContent = isFood ? "푸드" : "통합";
        }

        function updateVisibleUI() {
            bestVisibleText.textContent = String(state.bestVisible);
            newVisibleText.textContent = String(state.newVisible);
        }

        // position 규칙(문자열): subcategory_{mode}_{kind}_{n}
        function slotPosition(kind, index) {
            return `subcategory_${state.mode}_${kind}_${index}`;
        }
        function bannerPosition(kind) {
            return `subcategory_${state.mode}_${kind}_banner`;
        }

        function linkTypeLabel(v) {
            if (v === "store") return "가게연결";
            if (v === "url") return "URL";
            if (v === "text") return "텍스트";
            if (v === "image") return "이미지";
            return v || "-";
        }

        function hasFilled(item) {
            if (!item) return false;
            return !!clean(item.title) ||
                !!clean(item.image_url) ||
                !!clean(item.link_url) ||
                !!clean(item.store_id) ||
                !!clean(item.store_name);
        }

        /***********************
         * 렌더(배너)
         ***********************/
        function renderBanners() {
            const bestPos = bannerPosition("best");
            const newPos = bannerPosition("new");

            bestBannerPosText.textContent = bestPos;
            newBannerPosText.textContent = newPos;

            const b1 = state.bestBanner || {};
            bestBannerPreview.src = safeImg(b1.image_url);
            bestBannerTitle.textContent = clean(b1.title) || "-";
            bestBannerLinkType.textContent = linkTypeLabel(clean(b1.ad_mode) || "image");
            bestBannerLinkValue.textContent = clean(b1.link_url || b1.link_value || "") || "-";

            const b2 = state.newBanner || {};
            newBannerPreview.src = safeImg(b2.image_url);
            newBannerTitle.textContent = clean(b2.title) || "-";
            newBannerLinkType.textContent = linkTypeLabel(clean(b2.ad_mode) || "image");
            newBannerLinkValue.textContent = clean(b2.link_url || b2.link_value || "") || "-";
        }

        /***********************
         * 렌더(슬롯 카드)
         ***********************/
        function applySortAndSearch(list) {
            let arr = [...list];

            const q = clean(state.search).toLowerCase();
            if (q) {
                arr = arr.filter(it => {
                    const t = clean(it.title).toLowerCase();
                    const l = clean(it.link_url).toLowerCase();
                    const sn = clean(it.store_name).toLowerCase();
                    const st = clean(it.store_type).toLowerCase();
                    return t.includes(q) || l.includes(q) || sn.includes(q) || st.includes(q);
                });
            }

            if (state.sort === "posAsc") {
                arr.sort((a, b) => (a.index - b.index));
            } else if (state.sort === "filledFirst") {
                arr.sort((a, b) => {
                    const af = hasFilled(a);
                    const bf = hasFilled(b);
                    if (af === bf) return a.index - b.index;
                    return bf - af;
                });
            } else if (state.sort === "titleAsc") {
                arr.sort((a, b) => clean(a.title).localeCompare(clean(b.title), "ko") || (a.index - b.index));
            }

            return arr;
        }

        function renderGrid(kind) {
            const visible = (kind === "best") ? state.bestVisible : state.newVisible;
            const map = (kind === "best") ? state.bestSlotsMap : state.newSlotsMap;
            const gridEl = (kind === "best") ? bestGrid : newGrid;

            const items = [];
            for (let i = 1; i <= visible; i++) {
                const pos = slotPosition(kind, i);
                const d = map.get(pos) || {};
                items.push({
                    kind,
                    index: i,
                    position: pos,
                    title: clean(d.title),
                    ad_mode: clean(d.ad_mode) || "image",
                    image_url: clean(d.image_url),
                    link_url: clean(d.link_url),
                    store_id: clean(d.store_id),
                    store_name: clean(d.store_name),
                    store_type: clean(d.store_type),
                    priority: d.priority ?? 1,
                    no_end: !!d.no_end,
                    start_at: clean(d.start_at),
                    end_at: clean(d.end_at)
                });
            }

            const display = applySortAndSearch(items);

            gridEl.innerHTML = display.map(it => {
                const filled = hasFilled(it);
                const title = it.title || "빈 슬롯";
                const badge = filled
                    ? `<span class="text-xs px-2 py-1 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-100 font-bold">설정됨</span>`
                    : `<span class="text-xs px-2 py-1 rounded-full bg-slate-100 text-slate-600 border border-slate-200 font-bold">비어있음</span>`;

                const img = safeImg(it.image_url);

                const subLine = (() => {
                    if (it.ad_mode === "store" && it.store_name) return `가게: ${escapeHtml(it.store_name)}${it.store_type ? ` (${escapeHtml(it.store_type)})` : ""}`;
                    if (it.link_url) return `링크: ${escapeHtml(it.link_url)}`;
                    return `방식: ${escapeHtml(it.ad_mode)}`;
                })();

                return `
          <article class="neo-card p-4 relative overflow-hidden">
            <div class="absolute -top-10 -right-10 w-28 h-28 rounded-full ${kind === "best" ? "bg-emerald-500/10" : "bg-amber-500/10"}"></div>

            <div class="flex items-start justify-between gap-3">
              <div class="flex items-center gap-2">
                <div class="w-9 h-9 rounded-xl bg-slate-900 text-white flex items-center justify-center font-black text-sm">
                  ${it.index}
                </div>
                <div>
                  <div class="text-sm font-extrabold leading-tight">${escapeHtml(title)}</div>
                  <div class="text-xs text-slate-500 mt-0.5">${subLine}</div>
                  <div class="mt-1 text-[11px] text-slate-500">
                    priority: <span class="font-extrabold text-slate-700">${Number(it.priority || 1)}</span>
                    <span class="mx-2 text-slate-300">|</span>
                    ${it.no_end ? "종료없음" : (it.start_at || it.end_at ? "기간설정" : "기간없음")}
                  </div>
                </div>
              </div>
              ${badge}
            </div>

            <div class="mt-3 rounded-2xl border border-slate-200 bg-slate-50 overflow-hidden">
              <img src="${escapeHtml(img)}" alt="slot image" class="w-full h-36 object-cover"
                   onerror="this.src='/uploads/no-image.png';" />
            </div>

            <div class="mt-3 flex items-center gap-2">
              <button class="flex-1 h-11 rounded-xl ${kind === "best" ? "bg-emerald-600 hover:bg-emerald-700" : "bg-amber-600 hover:bg-amber-700"} text-white font-extrabold shadow"
                      data-action="open" data-kind="${it.kind}" data-index="${it.index}">
                설정
              </button>
              <button class="h-11 px-4 rounded-xl border border-slate-200 bg-white font-extrabold hover:bg-slate-50"
                      data-action="clearLocal" data-kind="${it.kind}" data-index="${it.index}">
                비우기
              </button>
            </div>

            <div class="mt-2 text-[11px] text-slate-500">
              position: <span class="font-extrabold">${escapeHtml(it.position)}</span>
            </div>
          </article>
        `;
            }).join("");

            gridEl.querySelectorAll("[data-action]").forEach(btn => {
                btn.addEventListener("click", (e) => {
                    const action = e.currentTarget.getAttribute("data-action");
                    const kind = e.currentTarget.getAttribute("data-kind");
                    const index = Number(e.currentTarget.getAttribute("data-index"));

                    if (action === "open") openSlotModal(kind, index);
                    if (action === "clearLocal") {
                        const pos = slotPosition(kind, index);
                        const map = (kind === "best") ? state.bestSlotsMap : state.newSlotsMap;
                        map.set(pos, {
                            title: "",
                            ad_mode: "image",
                            image_url: "",
                            link_url: "",
                            store_id: "",
                            store_name: "",
                            store_type: "",
                            priority: 1,
                            no_end: false,
                            start_at: "",
                            end_at: ""
                        });
                        renderAll();
                        showTopStatus(`${kind === "best" ? "베스트" : "New"} 슬롯 ${index} 로컬 비움(저장은 모달에서 저장)`, "info");
                    }
                });
            });
        }

        function renderAll() {
            setModeUI();
            updateVisibleUI();
            renderBanners();
            renderGrid("best");
            renderGrid("new");
        }

        /***********************
         * 로드(있으면) - 없으면 빈칸 유지
         ***********************/
        async function loadKind(kind) {
            try {
                const res = await fetch(LIST_API(state.mode, kind), { method: "GET" });
                if (!res.ok) {
                    showTopStatus(`목록 API 없음 또는 오류 (${res.status}) → 빈칸 유지`, "error");
                    return;
                }
                const data = await res.json().catch(() => null);
                if (!data || data.success !== true) {
                    showTopStatus("목록 응답 형식이 예상과 다름 → 빈칸 유지", "error");
                    return;
                }

                // banner
                if (data.banner) {
                    if (kind === "best") state.bestBanner = data.banner;
                    else state.newBanner = data.banner;
                }

                // items: {position,...} 또는 {index,...}
                const map = (kind === "best") ? state.bestSlotsMap : state.newSlotsMap;
                if (Array.isArray(data.items)) {
                    for (const it of data.items) {
                        const pos = clean(it.position) || (it.index ? slotPosition(kind, Number(it.index)) : "");
                        if (!pos) continue;
                        map.set(pos, it);
                    }
                }

                showTopStatus("불러오기 완료", "success");
            } catch (err) {
                console.error(err);
                showTopStatus("불러오기 실패 → 빈칸 유지", "error");
            }
        }

        async function loadAll() {
            showTopStatus("", "info");
            await Promise.all([loadKind("best"), loadKind("new")]);
            renderAll();
        }

        /***********************
         * 모달: 광고 모드 UI
         ***********************/
        function setAdMode(mode) {
            state.adMode = mode;

            const activeCls = "btn btn-primary px-4";
            const baseCls = "btn px-4";

            btnAdImage.className = (mode === "image") ? activeCls : baseCls;
            btnAdStore.className = (mode === "store") ? activeCls : baseCls;
            btnAdText.className = (mode === "text") ? activeCls : baseCls;

            // store 모드일 때만 검색영역 강조(숨김은 안 함. ncategory2도 보통 영역은 항상 보이고 동작만 달라짐)
            if (mode === "store") {
                inpStoreQuery.placeholder = "가게 검색 후 선택하세요";
            } else {
                inpStoreQuery.placeholder = "가게 검색 (선택 사항)";
            }

            updateCurrentInfoBox();
        }

        function updateCurrentInfoBox() {
            // 선택 이미지 표시
            const img = clean(inpImageUrl.value);
            curSelectedImage.textContent = img ? img : "없음";

            // 연결 가게 표시
            if (state.selectedStore && clean(state.selectedStore.name)) {
                curConnectedStore.textContent = `${state.selectedStore.name}${state.selectedStore.type ? ` (${state.selectedStore.type})` : ""}`;
            } else {
                curConnectedStore.textContent = "없음";
            }

            // 상태
            curStatusText.textContent = "대기";
        }

        /***********************
         * 모달 오픈/클로즈
         ***********************/
        function openModal(position) {
            modalPageText.textContent = state.page;
            modalPosText.textContent = position;

            modalOverlay.classList.remove("hidden");
            document.body.classList.add("overflow-hidden");
            showModalStatus("", "info");

            setTimeout(() => inpTitle.focus(), 0);
        }

        function closeModal() {
            modalOverlay.classList.add("hidden");
            document.body.classList.remove("overflow-hidden");
            state.modalTarget = null;
            state.selectedStore = null;
            curStatusText.textContent = "-";
            showInlineStatus(storeSearchStatus, "", "info");
            storeResultsBox.classList.add("hidden");
            candidatesBox.classList.add("hidden");
            showModalStatus("", "info");
        }

        function resetModalInputs() {
            inpTitle.value = "";
            inpLinkUrl.value = "";
            inpImageFile.value = "";
            inpImageUrl.value = "";
            imgPreview.src = "/uploads/no-image.png";

            inpStoreQuery.value = "";
            state.selectedStore = null;

            inpPriority.value = "1";

            chkNoEnd.checked = false;
            inpStartAt.value = "";
            inpEndAt.value = "";
            inpEndAt.disabled = false;

            setAdMode("image");
            updateCurrentInfoBox();
            showModalStatus("입력 초기화", "success");
        }

        function openSlotModal(kind, index) {
            const pos = slotPosition(kind, index);
            const map = (kind === "best") ? state.bestSlotsMap : state.newSlotsMap;
            const d = map.get(pos) || {};

            state.modalTarget = { kind, type: "slot", index, position: pos };

            // 값 주입
            inpTitle.value = clean(d.title);
            inpLinkUrl.value = clean(d.link_url);

            inpImageUrl.value = clean(d.image_url);
            imgPreview.src = safeImg(d.image_url);

            // store 연결(있으면)
            if (clean(d.store_id) || clean(d.store_name)) {
                state.selectedStore = {
                    id: clean(d.store_id),
                    name: clean(d.store_name),
                    type: clean(d.store_type),
                    image_url: clean(d.store_image_url || ""),
                    link_url: clean(d.link_url || "")
                };
            } else {
                state.selectedStore = null;
            }

            inpPriority.value = String(d.priority ?? 1);

            chkNoEnd.checked = !!d.no_end;
            inpStartAt.value = clean(d.start_at);
            inpEndAt.value = clean(d.end_at);
            inpEndAt.disabled = chkNoEnd.checked;

            setAdMode(clean(d.ad_mode) || "image");
            updateCurrentInfoBox();
            curStatusText.textContent = "불러오기 완료";

            openModal(pos);
        }

        function openBannerModal(kind) {
            const pos = bannerPosition(kind);
            const d = (kind === "best") ? (state.bestBanner || {}) : (state.newBanner || {});

            state.modalTarget = { kind, type: "banner", position: pos };

            inpTitle.value = clean(d.title);
            inpLinkUrl.value = clean(d.link_url);

            inpImageUrl.value = clean(d.image_url);
            imgPreview.src = safeImg(d.image_url);

            state.selectedStore = null;

            inpPriority.value = String(d.priority ?? 1);

            chkNoEnd.checked = !!d.no_end;
            inpStartAt.value = clean(d.start_at);
            inpEndAt.value = clean(d.end_at);
            inpEndAt.disabled = chkNoEnd.checked;

            setAdMode(clean(d.ad_mode) || "image");
            updateCurrentInfoBox();
            curStatusText.textContent = "불러오기 완료";

            openModal(pos);
        }

        /***********************
         * 가게 검색 (있으면)
         ***********************/
        async function searchStore() {
            const q = clean(inpStoreQuery.value);
            if (!q) {
                showInlineStatus(storeSearchStatus, "검색어를 입력하세요.", "error");
                return;
            }

            showInlineStatus(storeSearchStatus, "검색 중...", "info");
            storeResultsBox.classList.add("hidden");
            storeResults.innerHTML = "";

            try {
                const res = await fetch(SEARCH_STORE_API(state.mode, q), { method: "GET" });
                if (!res.ok) {
                    const txt = await res.text().catch(() => "");
                    showInlineStatus(storeSearchStatus, `검색 실패: HTTP ${res.status}${txt ? " - " + txt.slice(0, 120) : ""}`, "error");
                    return;
                }

                const data = await res.json().catch(() => null);
                if (!data || data.success !== true || !Array.isArray(data.stores)) {
                    showInlineStatus(storeSearchStatus, "검색 응답 형식이 예상과 다름", "error");
                    return;
                }

                if (data.stores.length === 0) {
                    showInlineStatus(storeSearchStatus, "검색 결과 없음", "info");
                    return;
                }

                showInlineStatus(storeSearchStatus, `검색 결과 ${data.stores.length}개`, "success");

                storeResultsBox.classList.remove("hidden");
                storeResults.innerHTML = data.stores.map(s => {
                    const id = clean(s.id || s.store_id || s.business_id || "");
                    const name = clean(s.business_name || s.name || "");
                    const type = clean(s.business_type || s.type || "");
                    const img = safeImg(s.image_url || s.main_image_url || s.store_image_url || "");
                    return `
            <div class="p-3 flex items-center gap-3">
              <div class="w-14 h-10 rounded-xl overflow-hidden border border-slate-200 bg-slate-50">
                <img src="${escapeHtml(img)}" class="w-full h-full object-cover" onerror="this.src='/uploads/no-image.png';" />
              </div>
              <div class="flex-1 min-w-0">
                <div class="font-extrabold text-sm truncate">${escapeHtml(name || "(이름없음)")}</div>
                <div class="text-xs text-slate-500 truncate">id: ${escapeHtml(id || "-")} ${type ? " / " + escapeHtml(type) : ""}</div>
              </div>
              <button class="btn btn-primary px-4" data-pick-store="1"
                data-id="${escapeHtml(id)}"
                data-name="${escapeHtml(name)}"
                data-type="${escapeHtml(type)}"
                data-img="${escapeHtml(img)}">
                선택
              </button>
            </div>
          `;
                }).join("");

                storeResults.querySelectorAll("[data-pick-store]").forEach(btn => {
                    btn.addEventListener("click", (e) => {
                        const el = e.currentTarget;
                        state.selectedStore = {
                            id: el.getAttribute("data-id"),
                            name: el.getAttribute("data-name"),
                            type: el.getAttribute("data-type"),
                            image_url: el.getAttribute("data-img")
                        };

                        // 가게 연결 모드일 때, 링크가 비어있으면 예시 형태로 자동 힌트(강제는 안 함)
                        if (state.adMode === "store" && !clean(inpLinkUrl.value) && state.selectedStore.id) {
                            inpLinkUrl.value = `/ndetail.html?id=${state.selectedStore.id}&type=store`;
                        }

                        curStatusText.textContent = "가게 선택됨";
                        updateCurrentInfoBox();
                        showInlineStatus(storeSearchStatus, `선택됨: ${state.selectedStore.name}`, "success");
                    });
                });

            } catch (err) {
                console.error(err);
                showInlineStatus(storeSearchStatus, `검색 중 오류: ${err?.message || err}`, "error");
            }
        }

        /***********************
         * 후보 목록 보기(1~6) - 있으면
         ***********************/
        async function showCandidates() {
            const t = state.modalTarget;
            if (!t) return;

            candidatesBox.classList.remove("hidden");
            candidatesList.innerHTML = `<div class="p-3 text-sm text-slate-600">불러오는 중...</div>`;

            try {
                const res = await fetch(CANDIDATES_API(state.page, t.position, state.mode, t.kind), { method: "GET" });
                if (!res.ok) {
                    const txt = await res.text().catch(() => "");
                    candidatesList.innerHTML = `<div class="p-3 text-sm text-red-700">후보목록 실패: HTTP ${res.status}${txt ? " - " + txt.slice(0, 160) : ""}</div>`;
                    return;
                }

                const data = await res.json().catch(() => null);
                if (!data || data.success !== true || !Array.isArray(data.items)) {
                    candidatesList.innerHTML = `<div class="p-3 text-sm text-red-700">후보목록 응답 형식이 예상과 다름</div>`;
                    return;
                }

                if (data.items.length === 0) {
                    candidatesList.innerHTML = `<div class="p-3 text-sm text-slate-600">등록된 후보가 없습니다.</div>`;
                    return;
                }

                candidatesList.innerHTML = data.items.map(it => {
                    const pr = Number(it.priority || 1);
                    const title = clean(it.title) || "(제목없음)";
                    const mode = clean(it.ad_mode) || "image";
                    const link = clean(it.link_url) || "";
                    const storeName = clean(it.store_name) || "";
                    return `
            <div class="p-3 flex items-center gap-3">
              <div class="w-10 h-10 rounded-xl bg-slate-900 text-white flex items-center justify-center font-black">${pr}</div>
              <div class="flex-1 min-w-0">
                <div class="font-extrabold text-sm truncate">${escapeHtml(title)}</div>
                <div class="text-xs text-slate-500 truncate">
                  방식: ${escapeHtml(mode)}
                  ${storeName ? ` / 가게: ${escapeHtml(storeName)}` : ""}
                  ${link ? ` / 링크: ${escapeHtml(link)}` : ""}
                </div>
              </div>
              <button class="btn btn-primary px-4" data-load-candidate="1"
                data-json="${escapeHtml(JSON.stringify(it))}">
                불러오기
              </button>
            </div>
          `;
                }).join("");

                candidatesList.querySelectorAll("[data-load-candidate]").forEach(btn => {
                    btn.addEventListener("click", (e) => {
                        const raw = e.currentTarget.getAttribute("data-json") || "{}";
                        let it = {};
                        try { it = JSON.parse(raw); } catch (_) { it = {}; }

                        // 후보 값 모달에 주입
                        inpTitle.value = clean(it.title);
                        inpLinkUrl.value = clean(it.link_url);
                        inpImageUrl.value = clean(it.image_url);
                        imgPreview.src = safeImg(it.image_url);
                        inpPriority.value = String(it.priority ?? 1);

                        chkNoEnd.checked = !!it.no_end;
                        inpStartAt.value = clean(it.start_at);
                        inpEndAt.value = clean(it.end_at);
                        inpEndAt.disabled = chkNoEnd.checked;

                        // store
                        if (clean(it.store_id) || clean(it.store_name)) {
                            state.selectedStore = {
                                id: clean(it.store_id),
                                name: clean(it.store_name),
                                type: clean(it.store_type),
                                image_url: clean(it.store_image_url || "")
                            };
                        } else {
                            state.selectedStore = null;
                        }

                        setAdMode(clean(it.ad_mode) || "image");
                        updateCurrentInfoBox();
                        curStatusText.textContent = "후보 불러오기 완료";
                        showModalStatus("후보 불러오기 완료", "success");
                    });
                });

            } catch (err) {
                console.error(err);
                candidatesList.innerHTML = `<div class="p-3 text-sm text-red-700">후보목록 오류: ${escapeHtml(err?.message || err)}</div>`;
            }
        }

        /***********************
         * 우선순위 불러오기/삭제
         * - 서버가 지원하면: update로 action 전달
         * - 지원 안하면: 404/에러 -> 모달 상태 표시
         ***********************/
        async function actionPriority(action) {
            const t = state.modalTarget;
            if (!t) return;

            const payload = {
                action,                 // "loadPriority" | "deletePriority"
                page: state.page,
                mode: state.mode,
                kind: t.kind,           // best|new
                position: t.position,
                priority: Number(inpPriority.value || 1)
            };

            try {
                showModalStatus(`${action === "loadPriority" ? "불러오는 중..." : "삭제 중..."}`, "info");

                const res = await fetch(UPDATE_API, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) {
                    const txt = await res.text().catch(() => "");
                    showModalStatus(`실패: HTTP ${res.status}${txt ? " - " + txt.slice(0, 200) : ""}`, "error");
                    return;
                }

                const data = await res.json().catch(() => null);
                if (!data || data.success !== true) {
                    showModalStatus("응답 형식이 예상과 다름", "error");
                    return;
                }

                // loadPriority라면 item을 모달에 주입(있을 때)
                if (action === "loadPriority" && data.item) {
                    const it = data.item;

                    inpTitle.value = clean(it.title);
                    inpLinkUrl.value = clean(it.link_url);
                    inpImageUrl.value = clean(it.image_url);
                    imgPreview.src = safeImg(it.image_url);

                    chkNoEnd.checked = !!it.no_end;
                    inpStartAt.value = clean(it.start_at);
                    inpEndAt.value = clean(it.end_at);
                    inpEndAt.disabled = chkNoEnd.checked;

                    if (clean(it.store_id) || clean(it.store_name)) {
                        state.selectedStore = {
                            id: clean(it.store_id),
                            name: clean(it.store_name),
                            type: clean(it.store_type),
                            image_url: clean(it.store_image_url || "")
                        };
                    } else {
                        state.selectedStore = null;
                    }

                    setAdMode(clean(it.ad_mode) || "image");
                    updateCurrentInfoBox();
                    curStatusText.textContent = "불러오기 완료";
                }

                showModalStatus(action === "loadPriority" ? "불러오기 완료" : "삭제 완료", "success");

            } catch (err) {
                console.error(err);
                showModalStatus(`오류: ${err?.message || err}`, "error");
            }
        }

        /***********************
         * 저장: /admin/subcategory/update
         ***********************/
        async function saveSlot() {
            const t = state.modalTarget;
            if (!t) return;

            // 저장 payload (ncategory2 스타일 필드)
            const payload = {
                action: "save",
                page: state.page,
                mode: state.mode,
                kind: t.kind,                 // best|new
                position: t.position,

                ad_mode: state.adMode,        // image|store|text
                title: clean(inpTitle.value),

                link_url: clean(inpLinkUrl.value),

                image_url: clean(inpImageUrl.value),

                store_id: state.selectedStore ? clean(state.selectedStore.id) : "",
                store_name: state.selectedStore ? clean(state.selectedStore.name) : "",
                store_type: state.selectedStore ? clean(state.selectedStore.type) : "",
                store_image_url: state.selectedStore ? clean(state.selectedStore.image_url) : "",

                priority: Number(inpPriority.value || 1),

                no_end: !!chkNoEnd.checked,
                start_at: clean(inpStartAt.value),
                end_at: clean(inpEndAt.value)
            };

            const hasFile = inpImageFile.files && inpImageFile.files[0];

            try {
                showModalStatus("저장 중...", "info");

                let res;
                if (hasFile) {
                    const fd = new FormData();
                    Object.entries(payload).forEach(([k, v]) => fd.append(k, String(v)));
                    fd.append("image", inpImageFile.files[0]); // field name: image
                    res = await fetch(UPDATE_API, { method: "POST", body: fd });
                } else {
                    res = await fetch(UPDATE_API, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(payload)
                    });
                }

                if (!res.ok) {
                    const txt = await res.text().catch(() => "");
                    showModalStatus(`저장 실패: HTTP ${res.status}${txt ? " - " + txt.slice(0, 200) : ""}`, "error");
                    curStatusText.textContent = "저장 실패";
                    return;
                }

                const data = await res.json().catch(() => null);
                if (!data || data.success !== true) {
                    showModalStatus("저장 응답이 예상과 다름(그래도 200 OK)", "error");
                    curStatusText.textContent = "저장 실패";
                    return;
                }

                // 서버가 item을 주면 그걸로 로컬 반영, 아니면 payload로 반영
                const item = data.item || payload;

                // banner vs slot 반영
                if (t.type === "banner") {
                    if (t.kind === "best") state.bestBanner = item;
                    else state.newBanner = item;
                } else {
                    const map = (t.kind === "best") ? state.bestSlotsMap : state.newSlotsMap;
                    map.set(t.position, item);
                }

                renderAll();
                showModalStatus("슬롯 저장 완료 ✅", "success");
                curStatusText.textContent = "저장 완료";
                showTopStatus("슬롯 저장 완료", "success");
            } catch (err) {
                console.error(err);
                showModalStatus(`저장 중 오류: ${err?.message || err}`, "error");
                curStatusText.textContent = "저장 실패";
            }
        }

        /***********************
         * 이벤트
         ***********************/
        btnModeFood.addEventListener("click", async () => {
            if (state.mode === "food") return;
            state.mode = "food";
            // 모드 바뀌면 표시는 8로 리셋
            state.bestVisible = INITIAL_VISIBLE;
            state.newVisible = INITIAL_VISIBLE;
            renderAll();
            await loadAll();
        });

        btnModeCombined.addEventListener("click", async () => {
            if (state.mode === "combined") return;
            state.mode = "combined";
            state.bestVisible = INITIAL_VISIBLE;
            state.newVisible = INITIAL_VISIBLE;
            renderAll();
            await loadAll();
        });

        sortSelect.addEventListener("change", () => {
            state.sort = sortSelect.value;
            renderAll();
        });

        searchInput.addEventListener("input", () => {
            state.search = searchInput.value;
            renderAll();
        });

        btnClearSearch.addEventListener("click", () => {
            searchInput.value = "";
            state.search = "";
            renderAll();
        });

        btnReset.addEventListener("click", async () => {
            state.search = "";
            searchInput.value = "";
            state.sort = "posAsc";
            sortSelect.value = "posAsc";
            state.bestVisible = INITIAL_VISIBLE;
            state.newVisible = INITIAL_VISIBLE;
            renderAll();
            await loadAll();
        });

        // 더보기
        async function more(kind) {
            if (kind === "best") state.bestVisible += MORE_STEP;
            else state.newVisible += MORE_STEP;
            renderAll();
            await loadAll(); // 더 늘어난 구간 데이터가 있을 수도 있으니 재시도
        }
        btnMoreBest.addEventListener("click", () => more("best"));
        btnMoreBestBottom.addEventListener("click", () => more("best"));
        btnMoreNew.addEventListener("click", () => more("new"));
        btnMoreNewBottom.addEventListener("click", () => more("new"));

        // 배너 편집
        btnEditBestBanner.addEventListener("click", () => openBannerModal("best"));
        btnEditNewBanner.addEventListener("click", () => openBannerModal("new"));

        // 모달
        btnModalHelp.addEventListener("click", () => modalHelpBox.classList.toggle("hidden"));
        btnModalClose.addEventListener("click", closeModal);
        btnModalCancel.addEventListener("click", closeModal);
        document.addEventListener("keydown", (e) => {
            if (e.key === "Escape" && !modalOverlay.classList.contains("hidden")) closeModal();
        });

        // 광고 모드 버튼
        btnAdImage.addEventListener("click", () => setAdMode("image"));
        btnAdStore.addEventListener("click", () => setAdMode("store"));
        btnAdText.addEventListener("click", () => setAdMode("text"));

        // 이미지 URL/파일 프리뷰
        inpImageUrl.addEventListener("input", () => {
            imgPreview.src = safeImg(inpImageUrl.value);
            updateCurrentInfoBox();
        });
        inpImageFile.addEventListener("change", () => {
            const f = inpImageFile.files && inpImageFile.files[0];
            if (!f) return;
            const url = URL.createObjectURL(f);
            imgPreview.src = url;
            curSelectedImage.textContent = "(파일 선택됨)";
            curStatusText.textContent = "파일 선택됨";
        });

        // 링크/제목 변경 시 현재 정보 갱신
        inpTitle.addEventListener("input", updateCurrentInfoBox);
        inpLinkUrl.addEventListener("input", updateCurrentInfoBox);

        // 종료 없음
        chkNoEnd.addEventListener("change", () => {
            inpEndAt.disabled = chkNoEnd.checked;
            if (chkNoEnd.checked) inpEndAt.value = "";
        });

        // 가게 검색
        btnStoreSearch.addEventListener("click", searchStore);
        inpStoreQuery.addEventListener("keydown", (e) => {
            if (e.key === "Enter") searchStore();
        });

        // 후보/우선순위
        btnShowCandidates.addEventListener("click", showCandidates);
        btnLoadPriority.addEventListener("click", () => actionPriority("loadPriority"));
        btnDeletePriority.addEventListener("click", () => actionPriority("deletePriority"));

        // 초기화/저장
        btnResetInput.addEventListener("click", resetModalInputs);
        btnSaveSlot.addEventListener("click", saveSlot);

        /***********************
         * 헤더 fetch (선택)
         * 프로젝트에 맞게 필요하면 경로 수정
         ***********************/
        async function loadHeader() {
            const el = $("header-placeholder");
            if (!el) return;
            try {
                const res = await fetch("/components/header.html");
                if (!res.ok) return;
                el.innerHTML = await res.text();
            } catch (_) { }
        }

        /***********************
         * 시작
         ***********************/
        (async function init() {
            setModeUI();
            updateVisibleUI();

            // 모달 기본 상태
            setAdMode("image");
            resetModalInputs();

            // 최초 렌더 (빈칸이어도 8칸 보이게)
            renderAll();

            await loadHeader();
            await loadAll();
        })();
    </script>
</body>

</html>