<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>subcategorymanager</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body {
            font-family: 'Noto Sans KR', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        .neo-card {
            background: rgba(255, 255, 255, 0.92);
            border: 2px solid rgba(59, 130, 246, 0.16);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 1rem;
            box-shadow:
                10px 10px 22px rgba(0, 0, 0, 0.06),
                -10px -10px 22px rgba(255, 255, 255, 0.9);
            transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
        }

        .neo-card:hover {
            transform: translateY(-3px);
            border-color: rgba(59, 130, 246, 0.28);
            box-shadow:
                8px 8px 18px rgba(0, 0, 0, 0.07),
                -8px -8px 18px rgba(255, 255, 255, 0.9),
                0 12px 28px rgba(59, 130, 246, 0.14);
        }

        .kbd {
            border: 1px solid rgba(0, 0, 0, 0.08);
            border-bottom-width: 2px;
            border-radius: .5rem;
            padding: .15rem .45rem;
            background: rgba(255, 255, 255, 0.9);
            font-size: .75rem;
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-800 min-h-screen flex flex-col">
    <!-- 선택: 공용 헤더 쓰면 여기에 fetch로 꽂히게 -->
    <div id="header-placeholder"></div>

    <!-- 상단 매니저바 -->
    <section class="sticky top-0 z-40 bg-white/80 backdrop-blur border-b border-slate-200">
        <div class="max-w-7xl mx-auto px-4 py-3">
            <div class="flex flex-col gap-3 lg:flex-row lg:items-center lg:justify-between">
                <!-- 좌: 타이틀 + 토글 -->
                <div class="flex items-center justify-between gap-3">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-indigo-500 text-white flex items-center justify-center shadow">
                            <span class="font-black">SC</span>
                        </div>
                        <div>
                            <div class="text-lg font-extrabold leading-tight">서브카테고리 매니저</div>
                            <div class="text-xs text-slate-500">푸드/통합 토글 · 더보기(12개씩) · 모달 편집</div>
                        </div>
                    </div>

                    <!-- 토글 -->
                    <div class="flex items-center gap-2">
                        <span id="modeBadge"
                            class="text-xs px-2 py-1 rounded-full bg-blue-50 text-blue-700 border border-blue-100 font-bold">푸드</span>

                        <div class="flex items-center bg-slate-100 p-1 rounded-xl border border-slate-200">
                            <button id="btnModeFood"
                                class="px-3 py-1.5 rounded-lg text-sm font-bold bg-white shadow-sm border border-slate-200">푸드</button>
                            <button id="btnModeCombined"
                                class="px-3 py-1.5 rounded-lg text-sm font-bold text-slate-600 hover:text-slate-800">통합</button>
                        </div>
                    </div>
                </div>

                <!-- 우: 정렬/검색/초기화 -->
                <div class="flex flex-col sm:flex-row gap-2 sm:items-center">
                    <div class="flex items-center gap-2">
                        <label class="text-xs font-bold text-slate-600">정렬</label>
                        <select id="sortSelect"
                            class="h-10 rounded-xl border border-slate-200 bg-white px-3 text-sm font-semibold focus:outline-none focus:ring-2 focus:ring-blue-200">
                            <option value="posAsc">번호(오름차순)</option>
                            <option value="filledFirst">채워진 슬롯 먼저</option>
                            <option value="titleAsc">제목(A→Z)</option>
                        </select>
                    </div>

                    <div class="flex items-center gap-2">
                        <div class="relative">
                            <input id="searchInput" type="text" placeholder="검색(제목/링크값)"
                                class="h-10 w-64 max-w-full rounded-xl border border-slate-200 bg-white px-3 pr-10 text-sm font-semibold focus:outline-none focus:ring-2 focus:ring-blue-200" />
                            <button id="btnClearSearch"
                                class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-700"
                                title="검색 지우기">
                                ✕
                            </button>
                        </div>

                        <button id="btnReset"
                            class="h-10 px-4 rounded-xl border border-slate-200 bg-white text-sm font-extrabold hover:bg-slate-50">
                            초기화
                        </button>
                    </div>
                </div>
            </div>

            <!-- 상단 상태바 -->
            <div class="mt-2 flex flex-col md:flex-row md:items-center md:justify-between gap-2">
                <div class="text-xs text-slate-500">
                    <span class="font-bold text-slate-700">표시 슬롯:</span>
                    <span id="visibleCountText" class="font-extrabold">12</span>개
                    <span class="mx-2 text-slate-300">|</span>
                    <span class="font-bold text-slate-700">단축키:</span>
                    <span class="kbd">ESC</span> 모달닫기
                </div>
                <div id="topStatus"
                    class="text-xs px-3 py-2 rounded-xl border border-slate-200 bg-white text-slate-600 hidden"></div>
            </div>
        </div>
    </section>

    <!-- 컨텐츠 -->
    <main class="max-w-7xl mx-auto w-full px-4 py-6 flex-1">
        <div class="flex items-center justify-between mb-4">
            <div class="text-sm text-slate-600">
                슬롯은 데이터가 없어도 항상 보이게 유지돼.
            </div>
            <button id="btnMore"
                class="px-4 py-2 rounded-xl bg-blue-600 text-white font-extrabold hover:bg-blue-700 shadow">
                더보기 +12
            </button>
        </div>

        <!-- 슬롯 그리드 -->
        <section id="grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
        </section>

        <div class="mt-6 flex justify-center">
            <button id="btnMoreBottom"
                class="px-5 py-2.5 rounded-2xl bg-white border border-slate-200 font-extrabold hover:bg-slate-50 shadow-sm">
                더보기 +12
            </button>
        </div>
    </main>

    <!-- 모달 -->
    <div id="modalOverlay" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/45"></div>

        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div class="w-full max-w-2xl neo-card overflow-hidden">
                <!-- 헤더 -->
                <div
                    class="px-5 py-4 border-b border-slate-200 bg-white/70 backdrop-blur flex items-start justify-between">
                    <div>
                        <div class="text-lg font-extrabold">슬롯 설정</div>
                        <div class="text-xs text-slate-500 mt-1">
                            모드: <span id="modalModeText" class="font-extrabold text-slate-700">푸드</span>
                            <span class="mx-2 text-slate-300">|</span>
                            슬롯번호: <span id="modalPosText" class="font-extrabold text-slate-700">-</span>
                        </div>
                    </div>
                    <button id="btnModalClose"
                        class="w-10 h-10 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 font-black">
                        ✕
                    </button>
                </div>

                <!-- 바디 -->
                <div class="p-5 bg-white">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- 제목 -->
                        <div class="md:col-span-2">
                            <label class="text-xs font-extrabold text-slate-600">제목</label>
                            <input id="inpTitle" type="text" placeholder="예) 바버라인 / 왕돈가스 / 네일아트"
                                class="mt-1 w-full h-11 rounded-xl border border-slate-200 px-3 text-sm font-semibold focus:outline-none focus:ring-2 focus:ring-blue-200" />
                        </div>

                        <!-- 이미지 URL -->
                        <div class="md:col-span-2">
                            <label class="text-xs font-extrabold text-slate-600">이미지 URL</label>
                            <input id="inpImageUrl" type="text" placeholder="/uploads/xxx.jpg 또는 https://..."
                                class="mt-1 w-full h-11 rounded-xl border border-slate-200 px-3 text-sm font-semibold focus:outline-none focus:ring-2 focus:ring-blue-200" />
                            <div class="mt-2 flex items-center gap-3">
                                <div
                                    class="w-20 h-14 rounded-xl border border-slate-200 bg-slate-50 overflow-hidden flex items-center justify-center">
                                    <img id="imgPreview" src="/uploads/no-image.png" alt="preview"
                                        class="w-full h-full object-cover" />
                                </div>
                                <div class="flex-1">
                                    <label class="text-xs font-extrabold text-slate-600">이미지 파일(선택)</label>
                                    <input id="inpImageFile" type="file" accept="image/*"
                                        class="mt-1 block w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-xl file:border-0 file:text-sm file:font-extrabold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" />
                                    <div class="text-xs text-slate-500 mt-1">
                                        파일을 선택하면 저장 시 FormData로 업로드를 시도해.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 연결 방식 -->
                        <div>
                            <label class="text-xs font-extrabold text-slate-600">연결 방식(선택)</label>
                            <select id="selLinkType"
                                class="mt-1 w-full h-11 rounded-xl border border-slate-200 bg-white px-3 text-sm font-semibold focus:outline-none focus:ring-2 focus:ring-blue-200">
                                <option value="store_id">가게 ID</option>
                                <option value="subcategory">서브카테고리(문자)</option>
                                <option value="url">URL</option>
                                <option value="text">직접입력(텍스트)</option>
                            </select>
                        </div>

                        <!-- 연결 값 -->
                        <div>
                            <label class="text-xs font-extrabold text-slate-600">연결 값(직접입력)</label>
                            <input id="inpLinkValue" type="text" placeholder="예) 12 / 미용/이발 / https://..."
                                class="mt-1 w-full h-11 rounded-xl border border-slate-200 px-3 text-sm font-semibold focus:outline-none focus:ring-2 focus:ring-blue-200" />
                            <div id="linkHint" class="text-xs text-slate-500 mt-1">
                                가게 ID는 숫자만 권장.
                            </div>
                        </div>
                    </div>

                    <!-- 모달 상태 -->
                    <div id="modalStatus" class="mt-4 hidden text-sm px-4 py-3 rounded-xl border"></div>

                    <!-- 푸터 버튼 -->
                    <div class="mt-5 flex items-center justify-between gap-2">
                        <button id="btnClearSlot"
                            class="h-11 px-4 rounded-xl border border-slate-200 bg-white font-extrabold hover:bg-slate-50">
                            비우기
                        </button>

                        <div class="flex items-center gap-2">
                            <button id="btnModalCancel"
                                class="h-11 px-4 rounded-xl border border-slate-200 bg-white font-extrabold hover:bg-slate-50">
                                닫기
                            </button>
                            <button id="btnModalSave"
                                class="h-11 px-5 rounded-xl bg-blue-600 text-white font-extrabold hover:bg-blue-700 shadow">
                                저장
                            </button>
                        </div>
                    </div>
                </div>
                <!-- /바디 -->
            </div>
        </div>
    </div>

    <script>
        /***********************
         * 설정
         ***********************/
        const PAGE_SIZE = 12;

        // 목록 불러오기(있으면 사용, 없으면 자동 빈칸)
        const LIST_API = (mode) => `/admin/subcategory/list?mode=${encodeURIComponent(mode)}`;

        // 저장 API(요청사항)
        const UPDATE_API = `/admin/subcategory/update`;

        /***********************
         * 상태
         ***********************/
        const state = {
            mode: "food",                 // food | combined
            visibleCount: PAGE_SIZE,
            slots: [],                    // length = visibleCount (빈칸 포함)
            loadedMap: new Map(),         // position -> slotData (서버에서 받은 값)
            search: "",
            sort: "posAsc",
            activePos: null
        };

        /***********************
         * 엘리먼트
         ***********************/
        const $ = (id) => document.getElementById(id);

        const grid = $("grid");
        const btnMore = $("btnMore");
        const btnMoreBottom = $("btnMoreBottom");

        const btnModeFood = $("btnModeFood");
        const btnModeCombined = $("btnModeCombined");
        const modeBadge = $("modeBadge");

        const sortSelect = $("sortSelect");
        const searchInput = $("searchInput");
        const btnClearSearch = $("btnClearSearch");
        const btnReset = $("btnReset");
        const visibleCountText = $("visibleCountText");
        const topStatus = $("topStatus");

        // Modal
        const modalOverlay = $("modalOverlay");
        const btnModalClose = $("btnModalClose");
        const btnModalCancel = $("btnModalCancel");
        const btnModalSave = $("btnModalSave");
        const btnClearSlot = $("btnClearSlot");

        const modalModeText = $("modalModeText");
        const modalPosText = $("modalPosText");
        const inpTitle = $("inpTitle");
        const inpImageUrl = $("inpImageUrl");
        const inpImageFile = $("inpImageFile");
        const imgPreview = $("imgPreview");
        const selLinkType = $("selLinkType");
        const inpLinkValue = $("inpLinkValue");
        const linkHint = $("linkHint");
        const modalStatus = $("modalStatus");

        /***********************
         * 유틸
         ***********************/
        function clean(v) {
            if (v === undefined || v === null) return "";
            return String(v).trim();
        }

        function showTopStatus(msg, type = "info") {
            if (!msg) {
                topStatus.classList.add("hidden");
                topStatus.textContent = "";
                return;
            }
            topStatus.classList.remove("hidden");
            topStatus.textContent = msg;

            topStatus.className = "text-xs px-3 py-2 rounded-xl border";
            if (type === "error") {
                topStatus.classList.add("bg-red-50", "text-red-700", "border-red-200");
            } else if (type === "success") {
                topStatus.classList.add("bg-emerald-50", "text-emerald-700", "border-emerald-200");
            } else {
                topStatus.classList.add("bg-white", "text-slate-600", "border-slate-200");
            }
        }

        function showModalStatus(msg, type = "info") {
            if (!msg) {
                modalStatus.classList.add("hidden");
                modalStatus.textContent = "";
                return;
            }
            modalStatus.classList.remove("hidden");
            modalStatus.textContent = msg;

            modalStatus.className = "mt-4 text-sm px-4 py-3 rounded-xl border";
            if (type === "error") {
                modalStatus.classList.add("bg-red-50", "text-red-700", "border-red-200");
            } else if (type === "success") {
                modalStatus.classList.add("bg-emerald-50", "text-emerald-700", "border-emerald-200");
            } else {
                modalStatus.classList.add("bg-slate-50", "text-slate-700", "border-slate-200");
            }
        }

        function setModeUI() {
            const isFood = state.mode === "food";
            modeBadge.textContent = isFood ? "푸드" : "통합";
            modeBadge.className = isFood
                ? "text-xs px-2 py-1 rounded-full bg-blue-50 text-blue-700 border border-blue-100 font-bold"
                : "text-xs px-2 py-1 rounded-full bg-indigo-50 text-indigo-700 border border-indigo-100 font-bold";

            if (isFood) {
                btnModeFood.className = "px-3 py-1.5 rounded-lg text-sm font-bold bg-white shadow-sm border border-slate-200";
                btnModeCombined.className = "px-3 py-1.5 rounded-lg text-sm font-bold text-slate-600 hover:text-slate-800";
            } else {
                btnModeCombined.className = "px-3 py-1.5 rounded-lg text-sm font-bold bg-white shadow-sm border border-slate-200";
                btnModeFood.className = "px-3 py-1.5 rounded-lg text-sm font-bold text-slate-600 hover:text-slate-800";
            }
        }

        function updateVisibleCountUI() {
            visibleCountText.textContent = String(state.visibleCount);
        }

        function buildEmptySlot(position) {
            return {
                position,
                title: "",
                image_url: "",
                link_type: "store_id",
                link_value: ""
            };
        }

        function getSlotByPosition(position) {
            // 서버 데이터가 있으면 그걸 기반으로, 없으면 빈칸
            const serverSlot = state.loadedMap.get(position);
            if (!serverSlot) return buildEmptySlot(position);

            return {
                position,
                title: clean(serverSlot.title),
                image_url: clean(serverSlot.image_url),
                link_type: clean(serverSlot.link_type) || "store_id",
                link_value: clean(serverSlot.link_value)
            };
        }

        function ensureSlotsLength() {
            const arr = [];
            for (let pos = 1; pos <= state.visibleCount; pos++) {
                arr.push(getSlotByPosition(pos));
            }
            state.slots = arr;
        }

        function applySortAndSearch(slots) {
            let list = [...slots];

            // 검색
            const q = clean(state.search).toLowerCase();
            if (q) {
                list = list.filter(s => {
                    const t = clean(s.title).toLowerCase();
                    const lv = clean(s.link_value).toLowerCase();
                    return t.includes(q) || lv.includes(q);
                });
            }

            // 정렬
            if (state.sort === "posAsc") {
                list.sort((a, b) => a.position - b.position);
            } else if (state.sort === "filledFirst") {
                list.sort((a, b) => {
                    const af = !!clean(a.title) || !!clean(a.image_url) || !!clean(a.link_value);
                    const bf = !!clean(b.title) || !!clean(b.image_url) || !!clean(b.link_value);
                    if (af === bf) return a.position - b.position;
                    return bf - af;
                });
            } else if (state.sort === "titleAsc") {
                list.sort((a, b) => clean(a.title).localeCompare(clean(b.title), "ko") || (a.position - b.position));
            }

            return list;
        }

        function linkTypeLabel(v) {
            if (v === "store_id") return "가게ID";
            if (v === "subcategory") return "서브카테고리";
            if (v === "url") return "URL";
            if (v === "text") return "텍스트";
            return v || "-";
        }

        function safeImg(url) {
            const u = clean(url);
            if (!u) return "/uploads/no-image.png";
            return u;
        }

        function escapeHtml(s) {
            return String(s || "")
                .replaceAll("&", "&amp;")
                .replaceAll("<", "&lt;")
                .replaceAll(">", "&gt;")
                .replaceAll('"', "&quot;")
                .replaceAll("'", "&#039;");
        }

        /***********************
         * 렌더
         ***********************/
        function render() {
            updateVisibleCountUI();
            setModeUI();

            const displayList = applySortAndSearch(state.slots);

            grid.innerHTML = displayList.map(slot => {
                const hasAny = !!clean(slot.title) || !!clean(slot.image_url) || !!clean(slot.link_value);
                const title = clean(slot.title) || "빈 슬롯";
                const img = safeImg(slot.image_url);
                const lt = linkTypeLabel(slot.link_type);
                const lv = clean(slot.link_value) || "-";

                return `
          <article class="neo-card p-4 relative overflow-hidden">
            <div class="absolute -top-10 -right-10 w-28 h-28 rounded-full bg-blue-500/10"></div>

            <div class="flex items-start justify-between gap-3">
              <div class="flex items-center gap-2">
                <div class="w-9 h-9 rounded-xl bg-slate-900 text-white flex items-center justify-center font-black text-sm">
                  ${slot.position}
                </div>
                <div>
                  <div class="text-sm font-extrabold leading-tight">${escapeHtml(title)}</div>
                  <div class="text-xs text-slate-500 mt-0.5">
                    <span class="inline-flex items-center px-2 py-0.5 rounded-full border border-slate-200 bg-white font-bold">
                      ${escapeHtml(lt)}
                    </span>
                    <span class="ml-1">${escapeHtml(lv)}</span>
                  </div>
                </div>
              </div>

              <span class="${hasAny
                        ? "text-xs px-2 py-1 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-100 font-bold"
                        : "text-xs px-2 py-1 rounded-full bg-slate-100 text-slate-600 border border-slate-200 font-bold"}">
                ${hasAny ? "설정됨" : "비어있음"}
              </span>
            </div>

            <div class="mt-3 rounded-2xl border border-slate-200 bg-slate-50 overflow-hidden">
              <img src="${escapeHtml(img)}" alt="slot image"
                class="w-full h-36 object-cover"
                onerror="this.src='/uploads/no-image.png';" />
            </div>

            <div class="mt-3 flex items-center gap-2">
              <button
                class="flex-1 h-11 rounded-xl bg-blue-600 text-white font-extrabold hover:bg-blue-700 shadow"
                data-action="open"
                data-pos="${slot.position}">
                설정
              </button>

              <button
                class="h-11 px-4 rounded-xl border border-slate-200 bg-white font-extrabold hover:bg-slate-50"
                data-action="clearLocal"
                data-pos="${slot.position}">
                비우기
              </button>
            </div>

            <div class="mt-2 text-[11px] text-slate-500">
              * 데이터가 없어도 슬롯은 유지돼. (더보기로 12개씩 추가)
            </div>
          </article>
        `;
            }).join("");

            // 이벤트 위임
            grid.querySelectorAll("[data-action]").forEach(btn => {
                btn.addEventListener("click", (e) => {
                    const action = e.currentTarget.getAttribute("data-action");
                    const pos = Number(e.currentTarget.getAttribute("data-pos"));

                    if (action === "open") openModal(pos);
                    if (action === "clearLocal") {
                        // 로컬만 비우고(즉시 표시 반영) 저장은 모달에서 하게 유지
                        state.loadedMap.set(pos, { position: pos, title: "", image_url: "", link_type: "store_id", link_value: "" });
                        ensureSlotsLength();
                        render();
                        showTopStatus(`슬롯 ${pos} 로컬 비움(저장은 모달에서 저장 눌러야 반영됨)`, "info");
                    }
                });
            });
        }

        /***********************
         * 데이터 로드(있으면) - 없어도 빈칸 유지
         ***********************/
        async function loadList() {
            showTopStatus("", "info");
            state.loadedMap.clear();

            try {
                const res = await fetch(LIST_API(state.mode), { method: "GET" });
                if (!res.ok) {
                    // 서버 라우터 없으면 여기로
                    showTopStatus(`목록 API 없음 또는 오류 (${res.status}) → 빈 슬롯만 표시`, "error");
                    ensureSlotsLength();
                    render();
                    return;
                }

                const data = await res.json();
                if (!data || data.success !== true || !Array.isArray(data.items)) {
                    showTopStatus("목록 응답 형식이 예상과 달라 빈 슬롯만 표시", "error");
                    ensureSlotsLength();
                    render();
                    return;
                }

                // items: [{position,title,image_url,link_type,link_value}, ...] 가정
                for (const it of data.items) {
                    const pos = Number(it.position);
                    if (!Number.isFinite(pos) || pos <= 0) continue;
                    state.loadedMap.set(pos, {
                        position: pos,
                        title: clean(it.title),
                        image_url: clean(it.image_url),
                        link_type: clean(it.link_type) || "store_id",
                        link_value: clean(it.link_value)
                    });
                }

                ensureSlotsLength();
                render();
                showTopStatus("목록 로드 완료", "success");
            } catch (err) {
                console.error(err);
                showTopStatus("목록 로드 실패 → 빈 슬롯만 표시", "error");
                ensureSlotsLength();
                render();
            }
        }

        /***********************
         * 더보기
         ***********************/
        async function more() {
            state.visibleCount += PAGE_SIZE;
            ensureSlotsLength();
            render();

            // 더보기 후에도 서버에 데이터가 있을 수 있으니 목록 재시도
            await loadList();
        }

        /***********************
         * 모달
         ***********************/
        function openModal(position) {
            state.activePos = position;

            const slot = getSlotByPosition(position);

            modalModeText.textContent = (state.mode === "food") ? "푸드" : "통합";
            modalPosText.textContent = String(position);

            inpTitle.value = clean(slot.title);
            inpImageUrl.value = clean(slot.image_url);
            selLinkType.value = clean(slot.link_type) || "store_id";
            inpLinkValue.value = clean(slot.link_value);

            inpImageFile.value = "";
            imgPreview.src = safeImg(slot.image_url);

            updateLinkHint();
            showModalStatus("", "info");

            modalOverlay.classList.remove("hidden");
            document.body.classList.add("overflow-hidden");
            setTimeout(() => inpTitle.focus(), 0);
        }

        function closeModal() {
            modalOverlay.classList.add("hidden");
            document.body.classList.remove("overflow-hidden");
            state.activePos = null;
            showModalStatus("", "info");
        }

        function updateLinkHint() {
            const t = selLinkType.value;
            if (t === "store_id") linkHint.textContent = "가게 ID는 숫자만 권장.";
            else if (t === "subcategory") linkHint.textContent = "예) 미용/이발, 한식, 카페 등(문자).";
            else if (t === "url") linkHint.textContent = "예) https://www.hongbono1.com/...";
            else if (t === "text") linkHint.textContent = "자유 텍스트(연결이 아니라 표시용일 수도 있음).";
            else linkHint.textContent = "";
        }

        // 이미지 URL 입력 시 프리뷰 갱신
        inpImageUrl.addEventListener("input", () => {
            imgPreview.src = safeImg(inpImageUrl.value);
        });

        // 파일 선택 시 프리뷰 갱신
        inpImageFile.addEventListener("change", () => {
            const f = inpImageFile.files && inpImageFile.files[0];
            if (!f) return;
            const url = URL.createObjectURL(f);
            imgPreview.src = url;
        });

        selLinkType.addEventListener("change", updateLinkHint);

        btnModalClose.addEventListener("click", closeModal);
        btnModalCancel.addEventListener("click", closeModal);

        document.addEventListener("keydown", (e) => {
            if (e.key === "Escape" && !modalOverlay.classList.contains("hidden")) closeModal();
        });

        // 비우기(모달에서 즉시 로컬 반영 + 저장까지는 따로)
        btnClearSlot.addEventListener("click", () => {
            if (!state.activePos) return;
            inpTitle.value = "";
            inpImageUrl.value = "";
            inpLinkValue.value = "";
            selLinkType.value = "store_id";
            inpImageFile.value = "";
            imgPreview.src = "/uploads/no-image.png";
            updateLinkHint();
            showModalStatus("입력값을 비웠어. 저장을 누르면 서버에도 반영돼.", "info");
        });

        /***********************
         * 저장 API 호출
         * - 서버 라우터 없으면 404 → 모달 상태에 에러 표시
         ***********************/
        async function saveActiveSlot() {
            const pos = state.activePos;
            if (!pos) return;

            const payload = {
                mode: state.mode,
                position: pos,
                title: clean(inpTitle.value),
                image_url: clean(inpImageUrl.value),
                link_type: clean(selLinkType.value) || "store_id",
                link_value: clean(inpLinkValue.value)
            };

            // 파일이 있으면 FormData로 전송(서버가 받도록 준비된 경우)
            const hasFile = inpImageFile.files && inpImageFile.files[0];

            try {
                showModalStatus("저장 중...", "info");

                let res;
                if (hasFile) {
                    const fd = new FormData();
                    fd.append("mode", payload.mode);
                    fd.append("position", String(payload.position));
                    fd.append("title", payload.title);
                    fd.append("image_url", payload.image_url);   // 서버가 url/파일 중 택일 처리할 수 있게 같이 보냄
                    fd.append("link_type", payload.link_type);
                    fd.append("link_value", payload.link_value);
                    fd.append("image", inpImageFile.files[0]);   // field name: image (서버에서 맞추면 됨)

                    res = await fetch(UPDATE_API, { method: "POST", body: fd });
                } else {
                    res = await fetch(UPDATE_API, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(payload)
                    });
                }

                if (!res.ok) {
                    const txt = await res.text().catch(() => "");
                    showModalStatus(`저장 실패: HTTP ${res.status} ${txt ? `- ${txt.slice(0, 200)}` : ""}`, "error");
                    return;
                }

                const data = await res.json().catch(() => null);

                // 성공 가정: {success:true, item:{...}} 또는 {success:true}
                if (!data || data.success !== true) {
                    showModalStatus("저장 응답이 예상과 다름(그래도 200 OK)", "error");
                    return;
                }

                // 서버가 최신 item을 주면 반영
                const newItem = data.item || payload;

                // 로컬 반영
                state.loadedMap.set(pos, {
                    position: pos,
                    title: clean(newItem.title),
                    image_url: clean(newItem.image_url),
                    link_type: clean(newItem.link_type) || payload.link_type,
                    link_value: clean(newItem.link_value)
                });

                ensureSlotsLength();
                render();

                showModalStatus("저장 완료 ✅", "success");
                showTopStatus(`슬롯 ${pos} 저장 완료`, "success");

                // 필요하면 자동 닫기(원하면 이 줄 지우면 됨)
                // closeModal();

            } catch (err) {
                console.error(err);
                showModalStatus(`저장 중 오류: ${err?.message || err}`, "error");
            }
        }

        btnModalSave.addEventListener("click", saveActiveSlot);

        /***********************
         * 매니저바 이벤트
         ***********************/
        sortSelect.addEventListener("change", () => {
            state.sort = sortSelect.value;
            render();
        });

        searchInput.addEventListener("input", () => {
            state.search = searchInput.value;
            render();
        });

        btnClearSearch.addEventListener("click", () => {
            searchInput.value = "";
            state.search = "";
            render();
        });

        btnReset.addEventListener("click", async () => {
            // 초기화: 검색/정렬 리셋, 표시 12개로, 현재 모드 목록 다시 로드
            sortSelect.value = "posAsc";
            state.sort = "posAsc";
            searchInput.value = "";
            state.search = "";
            state.visibleCount = PAGE_SIZE;
            ensureSlotsLength();
            render();
            await loadList();
        });

        /***********************
         * 모드 토글
         ***********************/
        async function setMode(mode) {
            if (state.mode === mode) return;
            state.mode = mode;

            // 모드 바뀌면 12개로 리셋
            state.visibleCount = PAGE_SIZE;
            state.search = "";
            searchInput.value = "";
            state.sort = "posAsc";
            sortSelect.value = "posAsc";

            ensureSlotsLength();
            render();
            await loadList();
        }

        btnModeFood.addEventListener("click", () => setMode("food"));
        btnModeCombined.addEventListener("click", () => setMode("combined"));

        /***********************
         * 더보기 버튼
         ***********************/
        btnMore.addEventListener("click", more);
        btnMoreBottom.addEventListener("click", more);

        /***********************
         * 헤더 fetch (선택)
         ***********************/
        async function loadHeader() {
            const el = $("header-placeholder");
            if (!el) return;
            try {
                // 프로젝트에서 쓰는 경로에 맞춰 필요하면 수정
                const res = await fetch("/components/header.html");
                if (!res.ok) return;
                el.innerHTML = await res.text();
            } catch (_) { }
        }

        /***********************
         * 시작
         ***********************/
        (async function init() {
            setModeUI();
            ensureSlotsLength();
            render();
            await loadHeader();
            await loadList();
        })();
    </script>
</body>

</html>