<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>서브카테고리 매니저 (모달 중심)</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif;
        }

        .neo {
            background: rgba(255, 255, 255, .92);
            border: 1px solid rgba(59, 130, 246, .18);
            border-radius: 1rem;
            box-shadow: 10px 10px 24px rgba(0, 0, 0, .08), -10px -10px 24px rgba(255, 255, 255, .7);
            backdrop-filter: blur(12px);
        }

        .soft {
            background: rgba(255, 255, 255, .75);
            border: 1px solid rgba(148, 163, 184, .35);
            border-radius: .9rem;
            backdrop-filter: blur(10px);
        }

        .chip {
            border: 1px solid rgba(59, 130, 246, .25);
            background: rgba(59, 130, 246, .08);
            padding: .25rem .5rem;
            border-radius: 999px;
            font-size: .75rem;
            color: rgb(30 64 175);
            display: inline-flex;
            gap: .35rem;
            align-items: center;
            white-space: nowrap;
        }

        .btn {
            border-radius: .85rem;
            padding: .6rem .85rem;
            font-weight: 700;
            transition: .15s;
        }

        .btn:active {
            transform: translateY(1px);
        }

        .btn-primary {
            background: rgb(37 99 235);
            color: white;
        }

        .btn-primary:hover {
            background: rgb(29 78 216);
        }

        .btn-ghost {
            background: rgba(255, 255, 255, .7);
            border: 1px solid rgba(148, 163, 184, .45);
        }

        .btn-ghost:hover {
            background: rgba(255, 255, 255, .92);
        }

        .btn-danger {
            background: rgb(220 38 38);
            color: white;
        }

        .btn-danger:hover {
            background: rgb(185 28 28);
        }

        .input {
            width: 100%;
            border-radius: .85rem;
            border: 1px solid rgba(148, 163, 184, .5);
            background: rgba(255, 255, 255, .9);
            padding: .65rem .8rem;
            outline: none;
        }

        .input:focus {
            border-color: rgba(37, 99, 235, .8);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, .15);
        }

        .label {
            font-size: .85rem;
            color: rgb(71 85 105);
            margin-bottom: .35rem;
        }

        .hint {
            font-size: .75rem;
            color: rgb(100 116 139);
        }

        .result-item:hover {
            background: rgba(59, 130, 246, .06);
        }

        .ringy {
            box-shadow: 0 0 0 4px rgba(37, 99, 235, .18);
        }

        .banner-box {
            background: linear-gradient(180deg, rgba(37, 99, 235, .08), rgba(255, 255, 255, .0));
            border: 1px solid rgba(37, 99, 235, .18);
            border-radius: 1.2rem;
        }
    </style>
</head>

<body class="min-h-screen bg-slate-50 text-slate-800">
    <div id="header-placeholder"></div>

    <main class="max-w-7xl mx-auto px-4 py-6">
        <!-- =========================
      ✅ 상단 배너(이미지) 영역 (항상 맨 위)
    ========================== -->
        <section class="banner-box p-4 md:p-5">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                <div>
                    <div class="text-lg md:text-xl font-black tracking-tight">서브카테고리 매니저</div>
                    <div class="text-sm text-slate-600 mt-1">
                        모달(편집 UI)이 화면의 주가 되도록 구성. 검색 결과에 “몇 페이지 / 몇 번째 박스” 표시.
                    </div>
                </div>

                <div class="flex flex-wrap items-center gap-2">
                    <span class="chip" id="chipApiBase">API: -</span>
                    <span class="chip" id="chipPosition">position: -</span>
                    <span class="chip" id="chipPriority">priority: 1</span>
                </div>
            </div>

            <div class="mt-4 grid grid-cols-1 lg:grid-cols-12 gap-4">
                <!-- 배너 미리보기 -->
                <div class="lg:col-span-7 neo p-4">
                    <div class="flex items-center justify-between gap-3">
                        <div>
                            <div class="font-extrabold">배너 미리보기</div>
                            <div class="hint mt-1">업로드 이미지가 있으면 우선, 없으면 가게 이미지(연결 시)로 자동 적용 가능</div>
                        </div>
                        <div class="flex items-center gap-2">
                            <button class="btn btn-ghost" id="btnClearImage" type="button">이미지 제거</button>
                        </div>
                    </div>

                    <div class="mt-3 soft p-3">
                        <img id="bannerPreview" src="/uploads/no-image.png" alt="banner"
                            class="w-full h-[220px] md:h-[280px] object-cover rounded-xl bg-white" />
                    </div>

                    <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <div class="label">배너 이미지 업로드</div>
                            <input class="input" id="bannerFile" type="file" accept="image/*" />
                            <div class="hint mt-1">서버 필드명: <b>image</b> (기존 multer single 유지)</div>
                        </div>
                        <div>
                            <div class="label">링크 URL (선택)</div>
                            <input class="input" id="linkUrl" placeholder="https://..." />
                            <div class="hint mt-1">slot_mode가 custom일 때 주로 사용</div>
                        </div>
                    </div>
                </div>

                <!-- 모드/위치/후보 -->
                <div class="lg:col-span-5 neo p-4">
                    <div class="font-extrabold">편집 대상 (All items 기준)</div>
                    <div class="hint mt-1">
                        “몇 페이지 / 몇 번째 박스”로 position을 만들고, priority(1~6)로 후보 슬롯을 관리
                    </div>

                    <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <div class="label">모드</div>
                            <select class="input" id="mode">
                                <option value="combined">통합</option>
                                <option value="food">푸드</option>
                            </select>
                        </div>

                        <div>
                            <div class="label">priority (1~6)</div>
                            <select class="input" id="priority">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                            </select>
                        </div>

                        <div>
                            <div class="label">페이지(12개=1페이지)</div>
                            <input class="input" id="pageNumber" type="number" min="1" value="1" />
                        </div>

                        <div>
                            <div class="label">박스 번호(1~12)</div>
                            <input class="input" id="boxNumber" type="number" min="1" max="12" value="1" />
                        </div>
                    </div>

                    <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-3">
                        <button class="btn btn-ghost" id="btnLoad" type="button">현재 슬롯 불러오기</button>
                        <button class="btn btn-ghost" id="btnLoadCandidates" type="button">후보(1~6) 보기</button>
                    </div>

                    <div class="mt-3 soft p-3">
                        <div class="text-sm font-bold mb-2">후보 상태(1~6)</div>
                        <div id="candidatesBox" class="grid grid-cols-3 gap-2 text-xs text-slate-700"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- =========================
      ✅ 하단: "기존 모달 내용"을 화면에 그대로 표시(폼)
    ========================== -->
        <section class="mt-6 grid grid-cols-1 lg:grid-cols-12 gap-4">
            <!-- 좌측: 검색 -->
            <aside class="lg:col-span-4 neo p-4">
                <div class="flex items-center justify-between">
                    <div class="font-extrabold">가게 검색</div>
                    <button class="btn btn-ghost" id="btnSearchAll" type="button">전체(__all__)</button>
                </div>
                <div class="hint mt-1">검색 결과에 “몇 페이지 / 몇 번째 박스(예: 8번)”가 표기됩니다.</div>

                <div class="mt-3 flex gap-2">
                    <input class="input" id="q" placeholder="사업자번호 / 상호 / 업종" />
                    <button class="btn btn-primary" id="btnSearch" type="button">검색</button>
                </div>

                <div class="mt-3 soft p-3">
                    <div class="text-sm font-bold mb-2">검색 결과</div>
                    <div id="searchResults" class="space-y-2"></div>
                </div>
            </aside>

            <!-- 우측: “가게 박스” + 편집 폼 -->
            <section class="lg:col-span-8 neo p-4">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                    <div>
                        <div class="font-extrabold">편집 폼 (기존 모달 기능 동일)</div>
                        <div class="hint mt-1">선택한 가게를 “가게 박스”에서 클릭하면 가게연결/텍스트/이미지 작업이 가능합니다.</div>
                    </div>

                    <div class="flex flex-wrap gap-2">
                        <button class="btn btn-primary" id="btnSave" type="button">저장</button>
                        <button class="btn btn-danger" id="btnDelete" type="button">삭제</button>
                    </div>
                </div>

                <!-- ✅ 가게 박스 -->
                <div class="mt-4 soft p-3">
                    <div class="flex items-center justify-between gap-3">
                        <div class="font-bold">가게 박스</div>
                        <span class="chip" id="storeLocChip">위치: -</span>
                    </div>

                    <div class="mt-3 grid grid-cols-1 md:grid-cols-12 gap-3 items-center">
                        <div class="md:col-span-4">
                            <img id="storeImage" src="/uploads/no-image.png"
                                class="w-full h-[140px] object-cover rounded-xl bg-white" alt="store" />
                        </div>
                        <div class="md:col-span-8">
                            <div class="text-lg font-black" id="storeName">선택된 가게 없음</div>
                            <div class="text-sm text-slate-600 mt-1" id="storeType">-</div>
                            <div class="text-sm text-slate-500 mt-1" id="storeBiz">-</div>
                            <div class="mt-3 flex flex-wrap gap-2">
                                <button class="btn btn-ghost" id="btnUseStore" type="button">이 가게로 연결</button>
                                <button class="btn btn-ghost" id="btnUseStoreImage" type="button">가게 이미지로 배너</button>
                            </div>
                            <div class="hint mt-2">“이 가게로 연결”을 누르면 slot_mode=store, storeId/상호/업종/이미지가 자동 채워집니다.</div>
                        </div>
                    </div>
                </div>

                <!-- ✅ 기존 모달 필드들(폼) -->
                <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <div class="label">슬롯 타입</div>
                        <select class="input" id="adMode">
                            <option value="banner">banner</option>
                            <option value="text">text</option>
                        </select>
                        <div class="hint mt-1">DB 제약: slot_type은 banner/text</div>
                    </div>

                    <div>
                        <div class="label">슬롯 모드</div>
                        <select class="input" id="slotMode">
                            <option value="store">store</option>
                            <option value="custom">custom</option>
                        </select>
                        <div class="hint mt-1">store=가게 연결 / custom=이미지·텍스트 직접</div>
                    </div>

                    <div>
                        <div class="label">텍스트 제목(선택)</div>
                        <input class="input" id="textTitle" placeholder="제목" />
                    </div>

                    <div>
                        <div class="label">텍스트 설명(선택)</div>
                        <input class="input" id="textDesc" placeholder="설명" />
                    </div>

                    <div>
                        <div class="label">기간 시작(선택)</div>
                        <input class="input" id="startAt" type="datetime-local" />
                    </div>

                    <div>
                        <div class="label">기간 종료(선택)</div>
                        <input class="input" id="endAt" type="datetime-local" />
                    </div>

                    <div class="md:col-span-2">
                        <label class="inline-flex items-center gap-2 select-none">
                            <input id="noEnd" type="checkbox" class="h-4 w-4" />
                            <span class="text-sm text-slate-700 font-semibold">종료 없음(no_end)</span>
                        </label>
                    </div>
                </div>

                <!-- 숨김: 가게 연결 값들(서버로 전송) -->
                <input type="hidden" id="storeId" />
                <input type="hidden" id="storeBusinessNumber" />
                <input type="hidden" id="storeNameHidden" />
                <input type="hidden" id="storeTypeHidden" />
                <input type="hidden" id="storeImageUrl" />

                <div id="toast" class="mt-4 hidden soft p-3 text-sm"></div>
            </section>
        </section>
    </main>

    <div id="footer-placeholder"></div>

    <script>
        // =========================
        // ✅ 환경/유틸
        // =========================
        const PAGE_NAME = "subcategory"; // ✅ admin_ad_slots의 page 값 (너 시스템에 맞게 필요 시 여기만 수정)

        // ✅ 가능한 API 베이스 후보들(자동 탐색)
        const API_BASE_CANDIDATES = [
            "/admin/subcategory",          // 너가 curl로 쓰던 느낌
            "/subcategorymanager/ad",      // 라우터 패턴(예상)
            "/admin/subcategorymanager/ad" // 혹시 있을 경우
        ];

        let API_BASE = null;

        function $(id) { return document.getElementById(id); }

        function toast(msg, ok = true) {
            const t = $("toast");
            t.classList.remove("hidden");
            t.textContent = msg;
            t.style.borderColor = ok ? "rgba(34,197,94,.45)" : "rgba(239,68,68,.45)";
            setTimeout(() => t.classList.add("hidden"), 2200);
        }

        function toIsoLocalInputValue(iso) {
            // ISO -> datetime-local (YYYY-MM-DDTHH:mm)
            if (!iso) return "";
            const d = new Date(iso);
            if (Number.isNaN(d.getTime())) return "";
            const pad = (n) => String(n).padStart(2, "0");
            return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
        }

        function buildPosition(mode, pageNo, boxNo) {
            // ✅ “몇 페이지 / 몇 번째 박스”를 position으로 고정
            // ✅ suffix는 서버 inferTableSourceFromPosition에서 사용하므로 반드시 __combined/__food
            const suffix = mode === "food" ? "__food" : "__combined";
            return `all_items__p${pageNo}__b${boxNo}${suffix}`;
        }

        function getCurrentKey() {
            const mode = $("mode").value;
            const p = Math.max(1, Number($("pageNumber").value || 1));
            const b = Math.min(12, Math.max(1, Number($("boxNumber").value || 1)));
            const position = buildPosition(mode, p, b);
            const priority = Number($("priority").value || 1);
            return { mode, pageNo: p, boxNo: b, position, priority };
        }

        async function tryFetchJson(url, options) {
            const res = await fetch(url, options);
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            return await res.json();
        }

        async function apiFetch(path, options) {
            if (API_BASE) {
                return await tryFetchJson(`${API_BASE}${path}`, options);
            }
            // auto-detect
            for (const base of API_BASE_CANDIDATES) {
                try {
                    const data = await tryFetchJson(`${base}${path}`, options);
                    API_BASE = base;
                    $("chipApiBase").textContent = `API: ${API_BASE}`;
                    return data;
                } catch (e) {
                    // continue
                }
            }
            throw new Error("API_BASE 탐색 실패: 라우터 경로 확인 필요");
        }

        function syncChips() {
            const { position, priority } = getCurrentKey();
            $("chipPosition").textContent = `position: ${position}`;
            $("chipPriority").textContent = `priority: ${priority}`;
        }

        // =========================
        // ✅ 이미지 미리보기(배너)
        // =========================
        function setBannerPreview(src) {
            $("bannerPreview").src = src || "/uploads/no-image.png";
        }

        $("bannerFile").addEventListener("change", (e) => {
            const f = e.target.files?.[0];
            if (!f) return;
            const url = URL.createObjectURL(f);
            setBannerPreview(url);
        });

        $("btnClearImage").addEventListener("click", () => {
            $("bannerFile").value = "";
            // 배너 미리보기는 "현재 슬롯 이미지 or 가게 이미지"로 다시 맞추기
            const storeImg = $("storeImageUrl").value;
            if (storeImg) setBannerPreview(storeImg);
            else setBannerPreview("/uploads/no-image.png");
            toast("이미지 입력 제거(파일)", true);
        });

        // =========================
        // ✅ 슬롯 불러오기 / 후보 불러오기
        // =========================
        async function loadSlot() {
            try {
                syncChips();
                const { position, priority } = getCurrentKey();
                const qs = new URLSearchParams({ page: PAGE_NAME, position, priority: String(priority) }).toString();
                const data = await apiFetch(`/slot?${qs}`);

                const slot = data.slot;
                if (!slot) {
                    toast("슬롯 없음(새로 저장 가능)", true);
                    // 빈값 세팅(기존 입력은 유지)
                    return;
                }

                // slot_type / slot_mode
                $("adMode").value = (slot.slot_type === "text") ? "text" : "banner";
                $("slotMode").value = slot.slot_mode || "store";

                // 링크/텍스트
                $("linkUrl").value = slot.link_url || "";
                $("textTitle").value = slot.text_title || "";
                $("textDesc").value = slot.text_desc || "";

                // 기간
                $("noEnd").checked = !!slot.no_end;
                $("startAt").value = toIsoLocalInputValue(slot.start_at);
                $("endAt").value = toIsoLocalInputValue(slot.end_at);

                // 이미지 미리보기
                if (slot.image_url) setBannerPreview(slot.image_url);

                // 가게 연결 hidden 값 채우기 (있으면)
                $("storeId").value = slot.store_id ?? "";
                $("storeBusinessNumber").value = slot.store_business_number ?? slot.business_number ?? "";
                $("storeNameHidden").value = slot.store_name ?? slot.business_name ?? "";
                $("storeTypeHidden").value = slot.store_type ?? slot.business_type ?? "";
                $("storeImageUrl").value = slot.store_image_url ?? slot.store_image ?? "";

                // 가게 박스 갱신
                if ($("storeNameHidden").value) {
                    $("storeName").textContent = $("storeNameHidden").value;
                    $("storeType").textContent = $("storeTypeHidden").value || "-";
                    $("storeBiz").textContent = $("storeBusinessNumber").value ? `사업자번호: ${$("storeBusinessNumber").value}` : "-";
                    $("storeImage").src = $("storeImageUrl").value || "/uploads/no-image.png";
                }

                toast("슬롯 불러오기 완료", true);
            } catch (e) {
                toast(`불러오기 실패: ${e.message}`, false);
            }
        }

        async function loadCandidates() {
            try {
                syncChips();
                const { position } = getCurrentKey();
                const qs = new URLSearchParams({ page: PAGE_NAME, position }).toString();
                const data = await apiFetch(`/candidates?${qs}`);
                const items = data.items || [];

                const map = new Map();
                for (const it of items) {
                    map.set(Number(it.priority), it);
                }

                const box = $("candidatesBox");
                box.innerHTML = "";
                for (let i = 1; i <= 6; i++) {
                    const it = map.get(i);
                    const div = document.createElement("button");
                    div.type = "button";
                    div.className = "soft p-2 text-left";
                    div.innerHTML = `
            <div class="font-black">#${i}</div>
            <div class="mt-1">${it ? (it.store_name || it.text_title || (it.image_url ? "이미지" : "데이터")) : "비어있음"}</div>
          `;
                    div.addEventListener("click", () => {
                        $("priority").value = String(i);
                        syncChips();
                        loadSlot();
                    });
                    box.appendChild(div);
                }

                toast("후보(1~6) 로드 완료", true);
            } catch (e) {
                toast(`후보 로드 실패: ${e.message}`, false);
            }
        }

        $("btnLoad").addEventListener("click", loadSlot);
        $("btnLoadCandidates").addEventListener("click", loadCandidates);

        $("mode").addEventListener("change", () => {
            // 모드 바꾸면 position도 같이 바뀌어야 함(너가 강조한 부분)
            syncChips();
            loadCandidates();
            loadSlot();
        });

        $("priority").addEventListener("change", () => {
            syncChips();
            loadSlot();
        });

        $("pageNumber").addEventListener("input", syncChips);
        $("boxNumber").addEventListener("input", syncChips);

        // =========================
        // ✅ 저장/삭제 (기능 동일)
        // =========================
        async function saveSlot() {
            try {
                syncChips();

                const { position, priority } = getCurrentKey();

                const fd = new FormData();
                fd.append("page", PAGE_NAME);
                fd.append("position", position);
                fd.append("priority", String(priority));

                fd.append("adMode", $("adMode").value); // banner|text
                fd.append("slotMode", $("slotMode").value); // store|custom

                fd.append("linkUrl", $("linkUrl").value || "");
                fd.append("textTitle", $("textTitle").value || "");
                fd.append("textDesc", $("textDesc").value || "");

                fd.append("noEnd", $("noEnd").checked ? "true" : "false");
                fd.append("startAt", $("startAt").value || "");
                fd.append("endAt", $("endAt").value || "");

                // 가게연결 값(선택)
                if ($("storeId").value) fd.append("storeId", $("storeId").value);
                if ($("storeBusinessNumber").value) fd.append("storeBusinessNumber", $("storeBusinessNumber").value);
                if ($("storeNameHidden").value) fd.append("storeName", $("storeNameHidden").value);
                if ($("storeTypeHidden").value) fd.append("storeType", $("storeTypeHidden").value);
                if ($("storeImageUrl").value) fd.append("storeImageUrl", $("storeImageUrl").value);

                // 업로드 이미지(선택)
                const f = $("bannerFile").files?.[0];
                if (f) fd.append("image", f);

                const data = await apiFetch(`/update`, { method: "POST", body: fd });
                if (!data.success) throw new Error(data.error || "저장 실패");

                // 저장 후 미리보기 갱신(서버가 image_url 채운 결과 반환)
                const slot = data.slot || null;
                if (slot?.image_url) setBannerPreview(slot.image_url);

                $("bannerFile").value = "";
                toast("저장 완료", true);
                loadCandidates();
            } catch (e) {
                toast(`저장 실패: ${e.message}`, false);
            }
        }

        async function deleteSlot() {
            try {
                syncChips();
                const { position, priority } = getCurrentKey();
                const qs = new URLSearchParams({ page: PAGE_NAME, position, priority: String(priority) }).toString();
                const data = await apiFetch(`/delete?${qs}`, { method: "DELETE" });
                if (!data.success) throw new Error(data.error || "삭제 실패");
                toast("삭제 완료", true);
                loadCandidates();
                // 화면 유지(입력은 그대로)
            } catch (e) {
                toast(`삭제 실패: ${e.message}`, false);
            }
        }

        $("btnSave").addEventListener("click", saveSlot);
        $("btnDelete").addEventListener("click", deleteSlot);

        // =========================
        // ✅ 가게 검색 + “몇페이지/몇번째 박스” 표기
        // =========================
        let selectedStore = null;

        function setSelectedStore(store) {
            selectedStore = store;

            if (!store) {
                $("storeName").textContent = "선택된 가게 없음";
                $("storeType").textContent = "-";
                $("storeBiz").textContent = "-";
                $("storeImage").src = "/uploads/no-image.png";
                $("storeLocChip").textContent = "위치: -";
                return;
            }

            $("storeName").textContent = store.business_name || "-";
            $("storeType").textContent = store.business_type || "-";
            $("storeBiz").textContent = store.business_number ? `사업자번호: ${store.business_number}` : "-";
            $("storeImage").src = store.image_url || "/uploads/no-image.png";

            const pageNo = store.page_number || "-";
            const idx = store.index_in_page || "-";
            $("storeLocChip").textContent = `위치: ${pageNo}페이지 / ${idx}번 박스`;
        }

        function renderSearchResults(results) {
            const box = $("searchResults");
            box.innerHTML = "";

            if (!results || results.length === 0) {
                box.innerHTML = `<div class="text-sm text-slate-500">검색 결과 없음</div>`;
                return;
            }

            for (const r of results) {
                const btn = document.createElement("button");
                btn.type = "button";
                btn.className = "result-item w-full text-left soft p-3";
                btn.innerHTML = `
          <div class="flex items-start justify-between gap-2">
            <div>
              <div class="font-black">${r.business_name || ""}</div>
              <div class="text-sm text-slate-600 mt-0.5">${r.business_type || ""}</div>
              <div class="text-xs text-blue-700 mt-1">
                ${r.page_number}페이지 / ${r.index_in_page}번 박스
              </div>
            </div>
            <div class="shrink-0">
              <img src="${r.image_url || "/uploads/no-image.png"}"
                   class="w-12 h-12 rounded-xl object-cover border bg-white" alt="thumb">
            </div>
          </div>
        `;

                btn.addEventListener("click", () => {
                    // ✅ 1) 선택 가게 박스에 표시
                    setSelectedStore(r);

                    // ✅ 2) 편집 대상 위치(페이지/박스)도 자동 세팅
                    $("pageNumber").value = String(r.page_number || 1);
                    $("boxNumber").value = String(r.index_in_page || 1);

                    // ✅ 3) 모드도 서버가 내려준 mode(혹은 현재 모드 유지)
                    if (r.mode) $("mode").value = r.mode;

                    // ✅ 4) 위치가 바뀌었으니 후보/슬롯 로드
                    syncChips();
                    loadCandidates();
                    loadSlot();

                    toast("선택됨: 가게 박스에 표시", true);
                });

                box.appendChild(btn);
            }
        }

        async function doSearch(q) {
            try {
                const mode = $("mode").value;
                const qs = new URLSearchParams({
                    mode,
                    q: q,
                    pageSize: "12" // ✅ All items 12개 기준 위치 계산
                }).toString();

                // ✅ 네 서버는 /search 또는 /search-store 둘 다 가능할 수 있음
                // 먼저 /search를 시도하고, 실패하면 /search-store 시도
                let data;
                try {
                    data = await apiFetch(`/search?${qs}`);
                } catch (_e) {
                    data = await apiFetch(`/search-store?${qs}`);
                }

                if (!data.success) throw new Error(data.error || "검색 실패");
                renderSearchResults(data.results || []);
            } catch (e) {
                toast(`검색 실패: ${e.message}`, false);
            }
        }

        $("btnSearch").addEventListener("click", () => {
            const q = $("q").value.trim();
            if (!q) return toast("검색어를 입력", false);
            doSearch(q);
        });

        $("q").addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
                e.preventDefault();
                $("btnSearch").click();
            }
        });

        $("btnSearchAll").addEventListener("click", () => {
            doSearch("__all__");
        });

        // =========================
        // ✅ 가게 박스 클릭 → 가게연결/배너 적용
        // =========================
        $("btnUseStore").addEventListener("click", () => {
            if (!selectedStore) return toast("가게를 먼저 선택", false);

            // slot_mode store로 전환
            $("slotMode").value = "store";

            // store 연결 값 주입
            $("storeId").value = selectedStore.id || "";
            $("storeBusinessNumber").value = selectedStore.business_number || "";
            $("storeNameHidden").value = selectedStore.business_name || "";
            $("storeTypeHidden").value = selectedStore.business_type || "";
            $("storeImageUrl").value = selectedStore.image_url || "";

            // 파일 업로드가 없으면, 배너 미리보기를 가게 이미지로
            if (!$("bannerFile").files?.length && $("storeImageUrl").value) {
                setBannerPreview($("storeImageUrl").value);
            }

            toast("가게 연결 값 적용됨", true);
        });

        $("btnUseStoreImage").addEventListener("click", () => {
            if (!selectedStore) return toast("가게를 먼저 선택", false);
            if (selectedStore.image_url) {
                $("bannerFile").value = "";
                setBannerPreview(selectedStore.image_url);
                $("storeImageUrl").value = selectedStore.image_url;
                toast("가게 이미지를 배너 미리보기에 적용", true);
            } else {
                toast("가게 이미지가 없음", false);
            }
        });

        // =========================
        // ✅ header/footer fetch (너 프로젝트 방식 유지)
        // =========================
        async function hydrateLayout() {
            try {
                const h = await fetch("/public2/components/header.html").then(r => r.text());
                $("header-placeholder").innerHTML = h;
            } catch (_e) { /* ignore */ }

            try {
                const f = await fetch("/public2/components/footer.html").then(r => r.text());
                $("footer-placeholder").innerHTML = f;
            } catch (_e) { /* ignore */ }
        }

        // =========================
        // ✅ 초기화
        // =========================
        (async function init() {
            hydrateLayout();

            // API_BASE 자동탐색을 위해 가볍게 한 번 호출
            try {
                await doSearch("__all__"); // 여기서 자동 탐색됨
            } catch (_e) {
                // 그래도 화면은 뜨게
            }

            syncChips();
            loadCandidates();
            loadSlot();
            setSelectedStore(null);
            $("chipApiBase").textContent = API_BASE ? `API: ${API_BASE}` : "API: -";
        })();
    </script>
</body>

</html>