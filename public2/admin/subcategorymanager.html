<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>subcategorymanager</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body {
            font-family: 'Noto Sans KR', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        .neo-card {
            background: rgba(255, 255, 255, 0.92);
            border: 2px solid rgba(59, 130, 246, 0.16);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 1rem;
            box-shadow:
                10px 10px 22px rgba(0, 0, 0, 0.06),
                -10px -10px 22px rgba(255, 255, 255, 0.9);
            transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
        }

        .neo-card:hover {
            transform: translateY(-3px);
            border-color: rgba(59, 130, 246, 0.28);
            box-shadow:
                8px 8px 18px rgba(0, 0, 0, 0.07),
                -8px -8px 18px rgba(255, 255, 255, 0.9),
                0 12px 28px rgba(59, 130, 246, 0.14);
        }

        .kbd {
            border: 1px solid rgba(0, 0, 0, 0.08);
            border-bottom-width: 2px;
            border-radius: .5rem;
            padding: .15rem .45rem;
            background: rgba(255, 255, 255, 0.9);
            font-size: .75rem;
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-800 min-h-screen flex flex-col">
    <div id="header-placeholder"></div>

    <!-- 상단 매니저바 -->
    <section class="sticky top-0 z-40 bg-white/80 backdrop-blur border-b border-slate-200">
        <div class="max-w-7xl mx-auto px-4 py-3">
            <div class="flex flex-col gap-3 lg:flex-row lg:items-center lg:justify-between">
                <!-- 좌: 타이틀 -->
                <div class="flex items-center justify-between gap-3">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-indigo-500 text-white flex items-center justify-center shadow">
                            <span class="font-black">SC</span>
                        </div>
                        <div>
                            <div class="text-lg font-extrabold leading-tight">서브카테고리 매니저</div>
                            <div class="text-xs text-slate-500">푸드/통합 · 베스트/뉴 · 기본 8 / 더보기 +12</div>
                        </div>
                    </div>
                </div>

                <!-- 우: 토글 2개 (푸드/통합, 베스트/뉴) -->
                <div class="flex flex-col sm:flex-row gap-2 sm:items-center">
                    <!-- 푸드/통합 -->
                    <div class="flex items-center gap-2">
                        <span id="modeBadge"
                            class="text-xs px-2 py-1 rounded-full bg-blue-50 text-blue-700 border border-blue-100 font-bold">푸드</span>
                        <div class="flex items-center bg-slate-100 p-1 rounded-xl border border-slate-200">
                            <button id="btnModeFood"
                                class="px-3 py-1.5 rounded-lg text-sm font-bold bg-white shadow-sm border border-slate-200">푸드</button>
                            <button id="btnModeCombined"
                                class="px-3 py-1.5 rounded-lg text-sm font-bold text-slate-600 hover:text-slate-800">통합</button>
                        </div>
                    </div>

                    <!-- 베스트/뉴 -->
                    <div class="flex items-center gap-2">
                        <span id="kindBadge"
                            class="text-xs px-2 py-1 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-100 font-bold">베스트</span>
                        <div class="flex items-center bg-slate-100 p-1 rounded-xl border border-slate-200">
                            <button id="btnKindBest"
                                class="px-3 py-1.5 rounded-lg text-sm font-bold bg-white shadow-sm border border-slate-200">베스트</button>
                            <button id="btnKindNew"
                                class="px-3 py-1.5 rounded-lg text-sm font-bold text-slate-600 hover:text-slate-800">뉴</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 정렬/검색/초기화 -->
            <div class="mt-3 flex flex-col lg:flex-row lg:items-center lg:justify-between gap-2">
                <div class="flex flex-col sm:flex-row gap-2 sm:items-center">
                    <div class="flex items-center gap-2">
                        <label class="text-xs font-bold text-slate-600">정렬</label>
                        <select id="sortSelect"
                            class="h-10 rounded-xl border border-slate-200 bg-white px-3 text-sm font-semibold focus:outline-none focus:ring-2 focus:ring-blue-200">
                            <option value="posAsc">번호(오름차순)</option>
                            <option value="filledFirst">채워진 슬롯 먼저</option>
                            <option value="titleAsc">제목(A→Z)</option>
                        </select>
                    </div>

                    <div class="flex items-center gap-2">
                        <div class="relative">
                            <input id="searchInput" type="text" placeholder="검색(제목/링크값)"
                                class="h-10 w-64 max-w-full rounded-xl border border-slate-200 bg-white px-3 pr-10 text-sm font-semibold focus:outline-none focus:ring-2 focus:ring-blue-200" />
                            <button id="btnClearSearch"
                                class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-700"
                                title="검색 지우기">
                                ✕
                            </button>
                        </div>

                        <button id="btnReset"
                            class="h-10 px-4 rounded-xl border border-slate-200 bg-white text-sm font-extrabold hover:bg-slate-50">
                            초기화
                        </button>
                    </div>
                </div>

                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
                    <div class="text-xs text-slate-500">
                        <span class="font-bold text-slate-700">표시 슬롯:</span>
                        <span id="visibleCountText" class="font-extrabold">8</span>개
                        <span class="mx-2 text-slate-300">|</span>
                        <span class="font-bold text-slate-700">단축키:</span>
                        <span class="kbd">ESC</span> 모달닫기
                    </div>
                    <div id="topStatus"
                        class="text-xs px-3 py-2 rounded-xl border border-slate-200 bg-white text-slate-600 hidden">
                    </div>
                </div>
            </div>
        </div>
    </section>

    <main class="max-w-7xl mx-auto w-full px-4 py-6 flex-1">
        <!-- ✅ 배너 업로드/편집 구간 -->
        <section class="neo-card p-4 mb-5">
            <div class="flex items-start justify-between gap-3">
                <div>
                    <div class="text-sm font-extrabold">상단 배너</div>
                    <div class="text-xs text-slate-500 mt-1">
                        현재 모드(<span id="bannerModeText" class="font-bold">푸드</span>) ·
                        타입(<span id="bannerKindText" class="font-bold">베스트</span>) 에 대한 배너
                    </div>
                </div>
                <button id="btnEditBanner"
                    class="h-10 px-4 rounded-xl bg-indigo-600 text-white font-extrabold hover:bg-indigo-700 shadow">
                    배너 편집
                </button>
            </div>

            <div class="mt-3 grid grid-cols-1 md:grid-cols-3 gap-3 items-stretch">
                <div class="md:col-span-2 rounded-2xl border border-slate-200 bg-slate-50 overflow-hidden">
                    <img id="bannerPreview" src="/uploads/no-image.png" alt="banner" class="w-full h-44 object-cover"
                        onerror="this.src='/uploads/no-image.png';" />
                </div>

                <div class="rounded-2xl border border-slate-200 bg-white p-3">
                    <div class="text-xs text-slate-500">배너 정보</div>
                    <div class="mt-2">
                        <div class="text-xs font-bold text-slate-600">제목</div>
                        <div id="bannerTitleText" class="text-sm font-extrabold text-slate-800 mt-1">-</div>
                    </div>
                    <div class="mt-3">
                        <div class="text-xs font-bold text-slate-600">연결</div>
                        <div class="text-sm font-extrabold text-slate-800 mt-1">
                            <span id="bannerLinkTypeText"
                                class="inline-flex items-center px-2 py-0.5 rounded-full border border-slate-200 bg-slate-50 text-slate-700 text-xs font-extrabold">-</span>
                            <span id="bannerLinkValueText" class="ml-1">-</span>
                        </div>
                    </div>
                    <div class="mt-3 text-xs text-slate-500">
                        * 배너도 저장은 <span class="font-bold">/admin/subcategory/update</span>로만 호출해.
                    </div>
                </div>
            </div>
        </section>

        <div class="flex items-center justify-between mb-4">
            <div class="text-sm text-slate-600">
                슬롯은 데이터가 없어도 항상 보이게 유지돼.
            </div>
            <button id="btnMore"
                class="px-4 py-2 rounded-xl bg-blue-600 text-white font-extrabold hover:bg-blue-700 shadow">
                더보기 +12
            </button>
        </div>

        <!-- 슬롯 그리드 -->
        <section id="grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
        </section>

        <div class="mt-6 flex justify-center">
            <button id="btnMoreBottom"
                class="px-5 py-2.5 rounded-2xl bg-white border border-slate-200 font-extrabold hover:bg-slate-50 shadow-sm">
                더보기 +12
            </button>
        </div>
    </main>

    <!-- 모달 (배너/슬롯 공용) -->
    <div id="modalOverlay" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/45"></div>

        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div class="w-full max-w-2xl neo-card overflow-hidden">
                <!-- 헤더 -->
                <div
                    class="px-5 py-4 border-b border-slate-200 bg-white/70 backdrop-blur flex items-start justify-between">
                    <div>
                        <div class="text-lg font-extrabold">설정</div>
                        <div class="text-xs text-slate-500 mt-1">
                            모드: <span id="modalModeText" class="font-extrabold text-slate-700">푸드</span>
                            <span class="mx-2 text-slate-300">|</span>
                            타입: <span id="modalKindText" class="font-extrabold text-slate-700">베스트</span>
                            <span class="mx-2 text-slate-300">|</span>
                            대상: <span id="modalTargetText" class="font-extrabold text-slate-700">슬롯 #</span>
                        </div>
                    </div>
                    <button id="btnModalClose"
                        class="w-10 h-10 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 font-black">
                        ✕
                    </button>
                </div>

                <!-- 바디 -->
                <div class="p-5 bg-white">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- 제목 -->
                        <div class="md:col-span-2">
                            <label class="text-xs font-extrabold text-slate-600">제목</label>
                            <input id="inpTitle" type="text" placeholder="예) 바버라인 / 왕돈가스 / 네일아트"
                                class="mt-1 w-full h-11 rounded-xl border border-slate-200 px-3 text-sm font-semibold focus:outline-none focus:ring-2 focus:ring-blue-200" />
                        </div>

                        <!-- 이미지 URL -->
                        <div class="md:col-span-2">
                            <label class="text-xs font-extrabold text-slate-600">이미지 URL</label>
                            <input id="inpImageUrl" type="text" placeholder="/uploads/xxx.jpg 또는 https://..."
                                class="mt-1 w-full h-11 rounded-xl border border-slate-200 px-3 text-sm font-semibold focus:outline-none focus:ring-2 focus:ring-blue-200" />
                            <div class="mt-2 flex items-center gap-3">
                                <div
                                    class="w-20 h-14 rounded-xl border border-slate-200 bg-slate-50 overflow-hidden flex items-center justify-center">
                                    <img id="imgPreview" src="/uploads/no-image.png" alt="preview"
                                        class="w-full h-full object-cover" />
                                </div>
                                <div class="flex-1">
                                    <label class="text-xs font-extrabold text-slate-600">이미지 파일(선택)</label>
                                    <input id="inpImageFile" type="file" accept="image/*"
                                        class="mt-1 block w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-xl file:border-0 file:text-sm file:font-extrabold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" />
                                    <div class="text-xs text-slate-500 mt-1">
                                        파일 선택 시 저장은 FormData로 전송 (서버가 받으면 업로드 처리)
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 연결 방식 -->
                        <div>
                            <label class="text-xs font-extrabold text-slate-600">연결 방식(선택)</label>
                            <select id="selLinkType"
                                class="mt-1 w-full h-11 rounded-xl border border-slate-200 bg-white px-3 text-sm font-semibold focus:outline-none focus:ring-2 focus:ring-blue-200">
                                <option value="store_id">가게 ID</option>
                                <option value="subcategory">서브카테고리(문자)</option>
                                <option value="url">URL</option>
                                <option value="text">직접입력(텍스트)</option>
                            </select>
                        </div>

                        <!-- 연결 값 -->
                        <div>
                            <label class="text-xs font-extrabold text-slate-600">연결 값(직접입력)</label>
                            <input id="inpLinkValue" type="text" placeholder="예) 12 / 미용/이발 / https://..."
                                class="mt-1 w-full h-11 rounded-xl border border-slate-200 px-3 text-sm font-semibold focus:outline-none focus:ring-2 focus:ring-blue-200" />
                            <div id="linkHint" class="text-xs text-slate-500 mt-1">가게 ID는 숫자만 권장.</div>
                        </div>
                    </div>

                    <!-- 모달 상태 -->
                    <div id="modalStatus" class="mt-4 hidden text-sm px-4 py-3 rounded-xl border"></div>

                    <!-- 푸터 버튼 -->
                    <div class="mt-5 flex items-center justify-between gap-2">
                        <button id="btnClearSlot"
                            class="h-11 px-4 rounded-xl border border-slate-200 bg-white font-extrabold hover:bg-slate-50">
                            비우기
                        </button>

                        <div class="flex items-center gap-2">
                            <button id="btnModalCancel"
                                class="h-11 px-4 rounded-xl border border-slate-200 bg-white font-extrabold hover:bg-slate-50">
                                닫기
                            </button>
                            <button id="btnModalSave"
                                class="h-11 px-5 rounded-xl bg-blue-600 text-white font-extrabold hover:bg-blue-700 shadow">
                                저장
                            </button>
                        </div>
                    </div>
                </div>
                <!-- /바디 -->
            </div>
        </div>
    </div>

    <script>
        /***********************
         * 표시 규칙
         * - 기본 8개
         * - 더보기 누를 때마다 +12
         ***********************/
        const INITIAL_VISIBLE = 8;
        const MORE_STEP = 12;

        // 목록(있으면) 불러오기: 서버 없으면 자동 빈칸 유지
        // (서버가 다르면 여기만 바꾸면 됨)
        const LIST_API = (mode, kind) => `/admin/subcategory/list?mode=${encodeURIComponent(mode)}&kind=${encodeURIComponent(kind)}`;

        // 저장(요청사항)
        const UPDATE_API = `/admin/subcategory/update`;

        /***********************
         * 상태
         ***********************/
        const state = {
            mode: "food",          // food | combined
            kind: "best",          // best | new
            visibleCount: INITIAL_VISIBLE,

            // position->slotData
            loadedMap: new Map(),

            // banner keyed by mode|kind
            bannerMap: new Map(),

            slots: [],
            search: "",
            sort: "posAsc",

            // modal
            activeTarget: "slot",  // slot | banner
            activePos: null
        };

        /***********************
         * 엘리먼트
         ***********************/
        const $ = (id) => document.getElementById(id);

        const grid = $("grid");
        const btnMore = $("btnMore");
        const btnMoreBottom = $("btnMoreBottom");

        const btnModeFood = $("btnModeFood");
        const btnModeCombined = $("btnModeCombined");
        const modeBadge = $("modeBadge");

        const btnKindBest = $("btnKindBest");
        const btnKindNew = $("btnKindNew");
        const kindBadge = $("kindBadge");

        const sortSelect = $("sortSelect");
        const searchInput = $("searchInput");
        const btnClearSearch = $("btnClearSearch");
        const btnReset = $("btnReset");
        const visibleCountText = $("visibleCountText");
        const topStatus = $("topStatus");

        // Banner
        const bannerModeText = $("bannerModeText");
        const bannerKindText = $("bannerKindText");
        const bannerPreview = $("bannerPreview");
        const bannerTitleText = $("bannerTitleText");
        const bannerLinkTypeText = $("bannerLinkTypeText");
        const bannerLinkValueText = $("bannerLinkValueText");
        const btnEditBanner = $("btnEditBanner");

        // Modal
        const modalOverlay = $("modalOverlay");
        const btnModalClose = $("btnModalClose");
        const btnModalCancel = $("btnModalCancel");
        const btnModalSave = $("btnModalSave");
        const btnClearSlot = $("btnClearSlot");

        const modalModeText = $("modalModeText");
        const modalKindText = $("modalKindText");
        const modalTargetText = $("modalTargetText");

        const inpTitle = $("inpTitle");
        const inpImageUrl = $("inpImageUrl");
        const inpImageFile = $("inpImageFile");
        const imgPreview = $("imgPreview");
        const selLinkType = $("selLinkType");
        const inpLinkValue = $("inpLinkValue");
        const linkHint = $("linkHint");
        const modalStatus = $("modalStatus");

        /***********************
         * 유틸
         ***********************/
        function clean(v) {
            if (v === undefined || v === null) return "";
            return String(v).trim();
        }

        function escapeHtml(s) {
            return String(s || "")
                .replaceAll("&", "&amp;")
                .replaceAll("<", "&lt;")
                .replaceAll(">", "&gt;")
                .replaceAll('"', "&quot;")
                .replaceAll("'", "&#039;");
        }

        function showTopStatus(msg, type = "info") {
            if (!msg) {
                topStatus.classList.add("hidden");
                topStatus.textContent = "";
                return;
            }
            topStatus.classList.remove("hidden");
            topStatus.textContent = msg;

            topStatus.className = "text-xs px-3 py-2 rounded-xl border";
            if (type === "error") topStatus.classList.add("bg-red-50", "text-red-700", "border-red-200");
            else if (type === "success") topStatus.classList.add("bg-emerald-50", "text-emerald-700", "border-emerald-200");
            else topStatus.classList.add("bg-white", "text-slate-600", "border-slate-200");
        }

        function showModalStatus(msg, type = "info") {
            if (!msg) {
                modalStatus.classList.add("hidden");
                modalStatus.textContent = "";
                return;
            }
            modalStatus.classList.remove("hidden");
            modalStatus.textContent = msg;

            modalStatus.className = "mt-4 text-sm px-4 py-3 rounded-xl border";
            if (type === "error") modalStatus.classList.add("bg-red-50", "text-red-700", "border-red-200");
            else if (type === "success") modalStatus.classList.add("bg-emerald-50", "text-emerald-700", "border-emerald-200");
            else modalStatus.classList.add("bg-slate-50", "text-slate-700", "border-slate-200");
        }

        function setModeUI() {
            const isFood = state.mode === "food";
            modeBadge.textContent = isFood ? "푸드" : "통합";
            modeBadge.className = isFood
                ? "text-xs px-2 py-1 rounded-full bg-blue-50 text-blue-700 border border-blue-100 font-bold"
                : "text-xs px-2 py-1 rounded-full bg-indigo-50 text-indigo-700 border border-indigo-100 font-bold";

            btnModeFood.className = isFood
                ? "px-3 py-1.5 rounded-lg text-sm font-bold bg-white shadow-sm border border-slate-200"
                : "px-3 py-1.5 rounded-lg text-sm font-bold text-slate-600 hover:text-slate-800";
            btnModeCombined.className = !isFood
                ? "px-3 py-1.5 rounded-lg text-sm font-bold bg-white shadow-sm border border-slate-200"
                : "px-3 py-1.5 rounded-lg text-sm font-bold text-slate-600 hover:text-slate-800";

            bannerModeText.textContent = isFood ? "푸드" : "통합";
        }

        function setKindUI() {
            const isBest = state.kind === "best";
            kindBadge.textContent = isBest ? "베스트" : "뉴";
            kindBadge.className = isBest
                ? "text-xs px-2 py-1 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-100 font-bold"
                : "text-xs px-2 py-1 rounded-full bg-amber-50 text-amber-700 border border-amber-100 font-bold";

            btnKindBest.className = isBest
                ? "px-3 py-1.5 rounded-lg text-sm font-bold bg-white shadow-sm border border-slate-200"
                : "px-3 py-1.5 rounded-lg text-sm font-bold text-slate-600 hover:text-slate-800";
            btnKindNew.className = !isBest
                ? "px-3 py-1.5 rounded-lg text-sm font-bold bg-white shadow-sm border border-slate-200"
                : "px-3 py-1.5 rounded-lg text-sm font-bold text-slate-600 hover:text-slate-800";

            bannerKindText.textContent = isBest ? "베스트" : "뉴";
        }

        function updateVisibleCountUI() {
            visibleCountText.textContent = String(state.visibleCount);
        }

        function safeImg(url) {
            const u = clean(url);
            if (!u) return "/uploads/no-image.png";
            return u;
        }

        function linkTypeLabel(v) {
            if (v === "store_id") return "가게ID";
            if (v === "subcategory") return "서브카테고리";
            if (v === "url") return "URL";
            if (v === "text") return "텍스트";
            return v || "-";
        }

        function keyMK() {
            return `${state.mode}||${state.kind}`;
        }

        /***********************
         * 슬롯/배너 데이터 모델
         ***********************/
        function buildEmptySlot(position) {
            return { position, title: "", image_url: "", link_type: "store_id", link_value: "" };
        }

        function getSlotByPosition(position) {
            const serverSlot = state.loadedMap.get(position);
            if (!serverSlot) return buildEmptySlot(position);

            return {
                position,
                title: clean(serverSlot.title),
                image_url: clean(serverSlot.image_url),
                link_type: clean(serverSlot.link_type) || "store_id",
                link_value: clean(serverSlot.link_value)
            };
        }

        function ensureSlotsLength() {
            const arr = [];
            for (let pos = 1; pos <= state.visibleCount; pos++) {
                arr.push(getSlotByPosition(pos));
            }
            state.slots = arr;
        }

        function getBanner() {
            const b = state.bannerMap.get(keyMK());
            if (!b) return { title: "", image_url: "", link_type: "url", link_value: "" };
            return {
                title: clean(b.title),
                image_url: clean(b.image_url),
                link_type: clean(b.link_type) || "url",
                link_value: clean(b.link_value)
            };
        }

        function setBannerLocal(b) {
            state.bannerMap.set(keyMK(), {
                title: clean(b.title),
                image_url: clean(b.image_url),
                link_type: clean(b.link_type) || "url",
                link_value: clean(b.link_value)
            });
        }

        /***********************
         * 검색/정렬
         ***********************/
        function applySortAndSearch(slots) {
            let list = [...slots];

            const q = clean(state.search).toLowerCase();
            if (q) {
                list = list.filter(s => {
                    const t = clean(s.title).toLowerCase();
                    const lv = clean(s.link_value).toLowerCase();
                    return t.includes(q) || lv.includes(q);
                });
            }

            if (state.sort === "posAsc") {
                list.sort((a, b) => a.position - b.position);
            } else if (state.sort === "filledFirst") {
                list.sort((a, b) => {
                    const af = !!clean(a.title) || !!clean(a.image_url) || !!clean(a.link_value);
                    const bf = !!clean(b.title) || !!clean(b.image_url) || !!clean(b.link_value);
                    if (af === bf) return a.position - b.position;
                    return bf - af;
                });
            } else if (state.sort === "titleAsc") {
                list.sort((a, b) => clean(a.title).localeCompare(clean(b.title), "ko") || (a.position - b.position));
            }

            return list;
        }

        /***********************
         * 렌더
         ***********************/
        function renderBanner() {
            const b = getBanner();
            bannerPreview.src = safeImg(b.image_url);
            bannerTitleText.textContent = clean(b.title) || "-";
            bannerLinkTypeText.textContent = linkTypeLabel(b.link_type) || "-";
            bannerLinkValueText.textContent = clean(b.link_value) || "-";
        }

        function renderGrid() {
            updateVisibleCountUI();
            setModeUI();
            setKindUI();
            renderBanner();

            const displayList = applySortAndSearch(state.slots);

            grid.innerHTML = displayList.map(slot => {
                const hasAny = !!clean(slot.title) || !!clean(slot.image_url) || !!clean(slot.link_value);
                const title = clean(slot.title) || "빈 슬롯";
                const img = safeImg(slot.image_url);
                const lt = linkTypeLabel(slot.link_type);
                const lv = clean(slot.link_value) || "-";

                return `
          <article class="neo-card p-4 relative overflow-hidden">
            <div class="absolute -top-10 -right-10 w-28 h-28 rounded-full bg-blue-500/10"></div>

            <div class="flex items-start justify-between gap-3">
              <div class="flex items-center gap-2">
                <div class="w-9 h-9 rounded-xl bg-slate-900 text-white flex items-center justify-center font-black text-sm">
                  ${slot.position}
                </div>
                <div>
                  <div class="text-sm font-extrabold leading-tight">${escapeHtml(title)}</div>
                  <div class="text-xs text-slate-500 mt-0.5">
                    <span class="inline-flex items-center px-2 py-0.5 rounded-full border border-slate-200 bg-white font-bold">
                      ${escapeHtml(lt)}
                    </span>
                    <span class="ml-1">${escapeHtml(lv)}</span>
                  </div>
                </div>
              </div>

              <span class="${hasAny
                        ? "text-xs px-2 py-1 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-100 font-bold"
                        : "text-xs px-2 py-1 rounded-full bg-slate-100 text-slate-600 border border-slate-200 font-bold"}">
                ${hasAny ? "설정됨" : "비어있음"}
              </span>
            </div>

            <div class="mt-3 rounded-2xl border border-slate-200 bg-slate-50 overflow-hidden">
              <img src="${escapeHtml(img)}" alt="slot image"
                class="w-full h-36 object-cover"
                onerror="this.src='/uploads/no-image.png';" />
            </div>

            <div class="mt-3 flex items-center gap-2">
              <button
                class="flex-1 h-11 rounded-xl bg-blue-600 text-white font-extrabold hover:bg-blue-700 shadow"
                data-action="openSlot"
                data-pos="${slot.position}">
                설정
              </button>

              <button
                class="h-11 px-4 rounded-xl border border-slate-200 bg-white font-extrabold hover:bg-slate-50"
                data-action="clearLocal"
                data-pos="${slot.position}">
                비우기
              </button>
            </div>

            <div class="mt-2 text-[11px] text-slate-500">
              * 기본 8개, 더보기는 +12씩 증가
            </div>
          </article>
        `;
            }).join("");

            grid.querySelectorAll("[data-action]").forEach(btn => {
                btn.addEventListener("click", (e) => {
                    const action = e.currentTarget.getAttribute("data-action");
                    const pos = Number(e.currentTarget.getAttribute("data-pos"));

                    if (action === "openSlot") openModalSlot(pos);

                    if (action === "clearLocal") {
                        state.loadedMap.set(pos, { position: pos, title: "", image_url: "", link_type: "store_id", link_value: "" });
                        ensureSlotsLength();
                        renderGrid();
                        showTopStatus(`슬롯 ${pos} 로컬 비움(저장은 모달에서 저장 눌러야 반영됨)`, "info");
                    }
                });
            });
        }

        /***********************
         * 목록 로드(있으면) - 없으면 빈칸 유지
         ***********************/
        async function loadList() {
            showTopStatus("", "info");
            state.loadedMap.clear();

            try {
                const res = await fetch(LIST_API(state.mode, state.kind), { method: "GET" });
                if (!res.ok) {
                    showTopStatus(`목록 API 없음 또는 오류 (${res.status}) → 빈 슬롯만 표시`, "error");
                    ensureSlotsLength();
                    renderGrid();
                    return;
                }

                const data = await res.json();
                // 기대: {success:true, items:[{position,title,image_url,link_type,link_value}], banner:{...}}
                if (!data || data.success !== true) {
                    showTopStatus("목록 응답 형식이 예상과 달라 빈 슬롯만 표시", "error");
                    ensureSlotsLength();
                    renderGrid();
                    return;
                }

                if (data.banner) {
                    setBannerLocal({
                        title: data.banner.title,
                        image_url: data.banner.image_url,
                        link_type: data.banner.link_type,
                        link_value: data.banner.link_value
                    });
                }

                if (Array.isArray(data.items)) {
                    for (const it of data.items) {
                        const pos = Number(it.position);
                        if (!Number.isFinite(pos) || pos <= 0) continue;
                        state.loadedMap.set(pos, {
                            position: pos,
                            title: clean(it.title),
                            image_url: clean(it.image_url),
                            link_type: clean(it.link_type) || "store_id",
                            link_value: clean(it.link_value)
                        });
                    }
                }

                ensureSlotsLength();
                renderGrid();
                showTopStatus("목록 로드 완료", "success");
            } catch (err) {
                console.error(err);
                showTopStatus("목록 로드 실패 → 빈 슬롯만 표시", "error");
                ensureSlotsLength();
                renderGrid();
            }
        }

        /***********************
         * 더보기: +12
         ***********************/
        async function more() {
            state.visibleCount += MORE_STEP;
            ensureSlotsLength();
            renderGrid();
            await loadList(); // 더 많은 구간에 서버 데이터가 있을 수 있으니 재시도
        }

        /***********************
         * 모달
         ***********************/
        function updateLinkHint() {
            const t = selLinkType.value;
            if (t === "store_id") linkHint.textContent = "가게 ID는 숫자만 권장.";
            else if (t === "subcategory") linkHint.textContent = "예) 미용/이발, 한식, 카페 등(문자).";
            else if (t === "url") linkHint.textContent = "예) https://www.hongbono1.com/...";
            else if (t === "text") linkHint.textContent = "자유 텍스트(표시용).";
            else linkHint.textContent = "";
        }

        function openModalCommon(targetLabel) {
            modalModeText.textContent = (state.mode === "food") ? "푸드" : "통합";
            modalKindText.textContent = (state.kind === "best") ? "베스트" : "뉴";
            modalTargetText.textContent = targetLabel;

            inpImageFile.value = "";
            updateLinkHint();
            showModalStatus("", "info");

            modalOverlay.classList.remove("hidden");
            document.body.classList.add("overflow-hidden");
            setTimeout(() => inpTitle.focus(), 0);
        }

        function openModalSlot(position) {
            state.activeTarget = "slot";
            state.activePos = position;

            const slot = getSlotByPosition(position);

            inpTitle.value = clean(slot.title);
            inpImageUrl.value = clean(slot.image_url);
            selLinkType.value = clean(slot.link_type) || "store_id";
            inpLinkValue.value = clean(slot.link_value);

            imgPreview.src = safeImg(slot.image_url);

            openModalCommon(`슬롯 ${position}`);
        }

        function openModalBanner() {
            state.activeTarget = "banner";
            state.activePos = null;

            const b = getBanner();

            inpTitle.value = clean(b.title);
            inpImageUrl.value = clean(b.image_url);
            selLinkType.value = clean(b.link_type) || "url";
            inpLinkValue.value = clean(b.link_value);

            imgPreview.src = safeImg(b.image_url);

            openModalCommon("배너");
        }

        function closeModal() {
            modalOverlay.classList.add("hidden");
            document.body.classList.remove("overflow-hidden");
            state.activeTarget = "slot";
            state.activePos = null;
            showModalStatus("", "info");
        }

        $("inpImageUrl").addEventListener("input", () => {
            imgPreview.src = safeImg(inpImageUrl.value);
        });

        $("inpImageFile").addEventListener("change", () => {
            const f = inpImageFile.files && inpImageFile.files[0];
            if (!f) return;
            const url = URL.createObjectURL(f);
            imgPreview.src = url;
        });

        selLinkType.addEventListener("change", updateLinkHint);

        btnModalClose.addEventListener("click", closeModal);
        btnModalCancel.addEventListener("click", closeModal);

        document.addEventListener("keydown", (e) => {
            if (e.key === "Escape" && !modalOverlay.classList.contains("hidden")) closeModal();
        });

        btnClearSlot.addEventListener("click", () => {
            inpTitle.value = "";
            inpImageUrl.value = "";
            inpLinkValue.value = "";
            selLinkType.value = (state.activeTarget === "banner") ? "url" : "store_id";
            inpImageFile.value = "";
            imgPreview.src = "/uploads/no-image.png";
            updateLinkHint();
            showModalStatus("입력값을 비웠어. 저장을 누르면 서버에도 반영돼.", "info");
        });

        /***********************
         * 저장: /admin/subcategory/update
         * - banner/slot 공통
         * - 라우터 없으면 404 -> 모달 에러 표시
         ***********************/
        async function saveModal() {
            const target = state.activeTarget; // slot|banner
            const position = (target === "slot") ? state.activePos : null;

            const payload = {
                target,            // "slot" | "banner"
                mode: state.mode,  // "food" | "combined"
                kind: state.kind,  // "best" | "new"
                position,          // slot일 때만
                title: clean(inpTitle.value),
                image_url: clean(inpImageUrl.value),
                link_type: clean(selLinkType.value) || (target === "banner" ? "url" : "store_id"),
                link_value: clean(inpLinkValue.value)
            };

            const hasFile = inpImageFile.files && inpImageFile.files[0];

            try {
                showModalStatus("저장 중...", "info");

                let res;
                if (hasFile) {
                    const fd = new FormData();
                    Object.entries(payload).forEach(([k, v]) => {
                        if (v === null || v === undefined) return;
                        fd.append(k, String(v));
                    });
                    fd.append("image", inpImageFile.files[0]); // field name: image
                    res = await fetch(UPDATE_API, { method: "POST", body: fd });
                } else {
                    res = await fetch(UPDATE_API, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(payload)
                    });
                }

                if (!res.ok) {
                    const txt = await res.text().catch(() => "");
                    showModalStatus(`저장 실패: HTTP ${res.status}${txt ? " - " + txt.slice(0, 200) : ""}`, "error");
                    return;
                }

                const data = await res.json().catch(() => null);
                if (!data || data.success !== true) {
                    showModalStatus("저장 응답이 예상과 다름(그래도 200 OK)", "error");
                    return;
                }

                const item = data.item || payload;

                // 로컬 반영
                if (target === "banner") {
                    setBannerLocal({
                        title: item.title,
                        image_url: item.image_url,
                        link_type: item.link_type,
                        link_value: item.link_value
                    });
                    renderBanner();
                    showTopStatus("배너 저장 완료", "success");
                } else {
                    const pos = Number(item.position || payload.position);
                    state.loadedMap.set(pos, {
                        position: pos,
                        title: clean(item.title),
                        image_url: clean(item.image_url),
                        link_type: clean(item.link_type) || payload.link_type,
                        link_value: clean(item.link_value)
                    });
                    ensureSlotsLength();
                    renderGrid();
                    showTopStatus(`슬롯 ${pos} 저장 완료`, "success");
                }

                showModalStatus("저장 완료 ✅", "success");
            } catch (err) {
                console.error(err);
                showModalStatus(`저장 중 오류: ${err?.message || err}`, "error");
            }
        }

        btnModalSave.addEventListener("click", saveModal);

        /***********************
         * 매니저바 이벤트
         ***********************/
        sortSelect.addEventListener("change", () => {
            state.sort = sortSelect.value;
            renderGrid();
        });

        searchInput.addEventListener("input", () => {
            state.search = searchInput.value;
            renderGrid();
        });

        btnClearSearch.addEventListener("click", () => {
            searchInput.value = "";
            state.search = "";
            renderGrid();
        });

        btnReset.addEventListener("click", async () => {
            sortSelect.value = "posAsc";
            state.sort = "posAsc";
            searchInput.value = "";
            state.search = "";
            state.visibleCount = INITIAL_VISIBLE;

            ensureSlotsLength();
            renderGrid();
            await loadList();
        });

        /***********************
         * 토글 변경 시 공통 리셋
         ***********************/
        async function resetAndReload() {
            state.visibleCount = INITIAL_VISIBLE;
            state.search = "";
            searchInput.value = "";
            state.sort = "posAsc";
            sortSelect.value = "posAsc";

            ensureSlotsLength();
            renderGrid();
            await loadList();
        }

        btnModeFood.addEventListener("click", async () => {
            if (state.mode === "food") return;
            state.mode = "food";
            await resetAndReload();
        });

        btnModeCombined.addEventListener("click", async () => {
            if (state.mode === "combined") return;
            state.mode = "combined";
            await resetAndReload();
        });

        btnKindBest.addEventListener("click", async () => {
            if (state.kind === "best") return;
            state.kind = "best";
            await resetAndReload();
        });

        btnKindNew.addEventListener("click", async () => {
            if (state.kind === "new") return;
            state.kind = "new";
            await resetAndReload();
        });

        /***********************
         * 배너 편집 버튼
         ***********************/
        btnEditBanner.addEventListener("click", () => openModalBanner());

        /***********************
         * 더보기 버튼
         ***********************/
        btnMore.addEventListener("click", more);
        btnMoreBottom.addEventListener("click", more);

        /***********************
         * 헤더 fetch (선택)
         ***********************/
        async function loadHeader() {
            const el = $("header-placeholder");
            if (!el) return;
            try {
                const res = await fetch("/components/header.html");
                if (!res.ok) return;
                el.innerHTML = await res.text();
            } catch (_) { }
        }

        /***********************
         * 시작
         ***********************/
        (async function init() {
            setModeUI();
            setKindUI();

            ensureSlotsLength();
            renderGrid();

            await loadHeader();
            await loadList();
        })();
    </script>
</body>

</html>