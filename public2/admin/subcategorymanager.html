<!-- 파일: public2/admin/subcategorymanager.html -->
<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>서브카테고리 매니저 (subcategorymanager)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", sans-serif;
        }

        .neo-card {
            background: rgba(255, 255, 255, .92);
            border-radius: 1.2rem;
            border: 1px solid rgba(59, 130, 246, .14);
            box-shadow: 10px 10px 24px rgba(0, 0, 0, .06), -10px -10px 24px rgba(255, 255, 255, .9);
            backdrop-filter: blur(14px) saturate(120%);
            transition: all .2s ease;
        }

        .neo-card:hover {
            transform: translateY(-2px);
            box-shadow: 12px 12px 28px rgba(0, 0, 0, .08), -12px -12px 28px rgba(255, 255, 255, .92);
        }

        .btn {
            border-radius: 9999px;
            padding: .55rem .95rem;
            font-weight: 700;
            border: 1px solid rgba(59, 130, 246, .25);
            background: rgba(255, 255, 255, .85);
            transition: all .15s ease;
        }

        .btn:hover {
            transform: translateY(-1px);
        }

        .btn-primary {
            background: rgba(37, 99, 235, .92);
            color: #fff;
            border-color: rgba(37, 99, 235, .45);
            box-shadow: 0 10px 22px rgba(37, 99, 235, .22);
        }

        .btn-danger {
            background: rgba(239, 68, 68, .92);
            color: #fff;
            border-color: rgba(239, 68, 68, .45);
            box-shadow: 0 10px 22px rgba(239, 68, 68, .18);
        }

        .chip {
            display: inline-flex;
            align-items: center;
            gap: .4rem;
            padding: .28rem .7rem;
            border-radius: 9999px;
            border: 1px solid rgba(59, 130, 246, .25);
            background: rgba(255, 255, 255, .8);
            font-weight: 800;
            font-size: .82rem;
        }

        .chip-on {
            background: rgba(37, 99, 235, .92);
            color: #fff;
            border-color: rgba(37, 99, 235, .5);
        }

        .dim {
            opacity: .55;
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-900 min-h-screen flex flex-col">

    <!-- 헤더 -->
    <div id="header-placeholder"></div>

    <main class="w-full max-w-7xl mx-auto px-4 md:px-6 py-6 md:py-10 flex-1">
        <!-- 상단 타이틀 -->
        <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
            <div>
                <h1 class="text-2xl md:text-3xl font-black tracking-tight">서브카테고리 매니저</h1>
                <p class="text-slate-600 mt-1 text-sm md:text-base">
                    슬롯(1~6) + 배너(1) : 검색/가게연결/이미지/텍스트 업로드 + 저장/불러오기/삭제
                </p>
            </div>
            <div class="flex items-center gap-2">
                <span id="modeBadge" class="chip">모드: <b id="modeBadgeText">푸드</b></span>
                <span class="chip">page: <b>subcategorymanager</b></span>
            </div>
        </div>

        <!-- 배너 영역 -->
        <section class="mt-6">
            <div class="neo-card p-4 md:p-5">
                <div class="flex items-center justify-between gap-3">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-12 h-12 rounded-2xl bg-blue-50 border border-blue-100 flex items-center justify-center font-black text-blue-700">
                            B</div>
                        <div>
                            <div class="text-lg font-black">배너 슬롯</div>
                            <div class="text-sm text-slate-500">section=banner / idx=1</div>
                        </div>
                    </div>
                    <button id="bannerEditBtn" class="btn btn-primary">편집</button>
                </div>

                <div id="bannerSlotCard" class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4 cursor-pointer">
                    <div class="md:col-span-1">
                        <div
                            class="aspect-[16/9] rounded-2xl overflow-hidden bg-white border border-slate-200 flex items-center justify-center">
                            <img id="bannerPreviewImg" src="/uploads/no-image.png" alt="배너 미리보기"
                                class="w-full h-full object-cover" />
                        </div>
                    </div>
                    <div class="md:col-span-2">
                        <div class="flex flex-wrap gap-2 mb-2">
                            <span class="chip">position: <b id="bannerPositionText">-</b></span>
                            <span class="chip">type: <b id="bannerTypeText">-</b></span>
                            <span class="chip">mode: <b id="bannerModeText">-</b></span>
                        </div>
                        <div class="text-sm text-slate-700 leading-relaxed">
                            <div class="font-extrabold">제목: <span id="bannerTitleText"
                                    class="font-semibold text-slate-700">-</span></div>
                            <div class="mt-1">설명: <span id="bannerDescText" class="text-slate-600">-</span></div>
                            <div class="mt-1">가게: <span id="bannerStoreText" class="text-slate-600">-</span></div>
                        </div>
                        <div class="mt-3 text-xs text-slate-500">
                            저장/불러오기 기준은 <b>position</b> 입니다. 모달에서 푸드/통합 변경 시 position이 자동으로 바뀝니다.
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 슬롯 1~6 -->
        <section class="mt-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- JS가 채움 -->
                <div id="slotGrid" class="md:col-span-3 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>
        </section>
    </main>

    <!-- 모달 -->
    <div id="slotModal" class="hidden fixed inset-0 z-50">
        <div id="modalBackdrop" class="absolute inset-0 bg-black/40"></div>

        <div class="absolute inset-0 flex items-center justify-center p-3 md:p-6">
            <div class="w-full max-w-5xl neo-card overflow-hidden">
                <!-- 모달 헤더 -->
                <div class="px-4 md:px-6 py-4 border-b border-slate-200 flex items-start justify-between gap-3">
                    <div>
                        <div class="text-xl font-black">슬롯 편집</div>
                        <div class="mt-2 flex flex-wrap gap-2">
                            <span class="chip">page: <b id="modalPageText">subcategorymanager</b></span>
                            <span class="chip">position: <b id="modalPositionText">-</b></span>

                            <!-- ✅ 모달 안에 푸드/통합 토글 -->
                            <button id="modalModeFoodBtn" class="chip chip-on" type="button">푸드</button>
                            <button id="modalModeCombinedBtn" class="chip" type="button">통합</button>

                            <span class="chip">상태: <b id="modalStatus">대기</b></span>
                        </div>
                    </div>
                    <button id="modalCloseBtn" class="btn" type="button">닫기</button>
                </div>

                <!-- 모달 바디(스크롤) -->
                <div class="max-h-[75vh] overflow-y-auto">
                    <div class="px-4 md:px-6 py-5 grid grid-cols-1 lg:grid-cols-5 gap-5">

                        <!-- 좌측: 설정 -->
                        <div class="lg:col-span-2 space-y-4">

                            <!-- 광고 타입 -->
                            <div class="neo-card p-4">
                                <div class="font-black mb-2">표시 타입</div>
                                <div class="flex gap-2 flex-wrap">
                                    <button id="adModeImageBtn" class="btn btn-primary" type="button">이미지</button>
                                    <button id="adModeTextBtn" class="btn" type="button">텍스트</button>
                                </div>
                                <p class="text-xs text-slate-500 mt-2">이미지/텍스트 모드에 따라 저장 데이터가 달라집니다.</p>
                            </div>

                            <!-- 슬롯 모드(가게 연결/커스텀) -->
                            <div class="neo-card p-4">
                                <div class="font-black mb-2">슬롯 모드</div>
                                <div class="flex gap-2 flex-wrap">
                                    <button id="slotModeStoreBtn" class="btn btn-primary" type="button">가게 연결</button>
                                    <button id="slotModeCustomBtn" class="btn" type="button">커스텀</button>
                                </div>
                                <p class="text-xs text-slate-500 mt-2">가게 연결: 가게를 선택해서 연결 / 커스텀: 텍스트/링크만 저장</p>
                            </div>

                            <!-- 이미지 업로드 -->
                            <div id="imageBox" class="neo-card p-4">
                                <div class="font-black mb-2">이미지 업로드</div>
                                <div class="flex items-center gap-3">
                                    <input id="imageFileInput" type="file" accept="image/*"
                                        class="block w-full text-sm" />
                                </div>
                                <div class="mt-2 text-sm text-slate-700">
                                    선택: <b id="selectedImageText">없음</b>
                                </div>
                                <div class="mt-3">
                                    <div
                                        class="aspect-[16/9] rounded-2xl overflow-hidden bg-white border border-slate-200 flex items-center justify-center">
                                        <img id="modalImagePreview" src="/uploads/no-image.png" alt="미리보기"
                                            class="w-full h-full object-cover" />
                                    </div>
                                    <div class="text-xs text-slate-500 mt-2">서버 업로드 필드명: <b>image</b></div>
                                </div>
                            </div>

                            <!-- 텍스트 -->
                            <div id="textBox" class="neo-card p-4 hidden">
                                <div class="font-black mb-2">텍스트 입력</div>
                                <label class="block text-sm font-bold mb-1">제목</label>
                                <input id="customTitle"
                                    class="w-full border border-slate-200 rounded-xl px-3 py-2 bg-white"
                                    placeholder="예) 이벤트 / 안내" />
                                <label class="block text-sm font-bold mt-3 mb-1">설명</label>
                                <textarea id="customDesc"
                                    class="w-full border border-slate-200 rounded-xl px-3 py-2 bg-white min-h-[90px]"
                                    placeholder="간단 설명"></textarea>
                                <label class="block text-sm font-bold mt-3 mb-1">링크</label>
                                <input id="customLink"
                                    class="w-full border border-slate-200 rounded-xl px-3 py-2 bg-white"
                                    placeholder="https://..." />
                            </div>

                            <!-- 저장/삭제 -->
                            <div class="neo-card p-4">
                                <div class="font-black mb-3">저장/삭제</div>
                                <div class="flex gap-2 flex-wrap">
                                    <button id="saveBtn" class="btn btn-primary" type="button">저장</button>
                                    <button id="reloadBtn" class="btn" type="button">불러오기</button>
                                    <button id="deleteBtn" class="btn btn-danger" type="button">삭제</button>
                                </div>
                                <div class="text-xs text-slate-500 mt-3">
                                    저장 키는 <b>position</b> 입니다. (모달에서 푸드/통합 바꾸면 position도 같이 바뀜)
                                </div>
                            </div>
                        </div>

                        <!-- 우측: 검색/선택 -->
                        <div class="lg:col-span-3 space-y-4">

                            <!-- 현재 선택 -->
                            <div class="neo-card p-4">
                                <div class="font-black mb-2">현재 선택</div>
                                <div class="text-sm">
                                    가게: <b id="selectedStoreText">없음</b>
                                </div>
                                <div class="text-xs text-slate-500 mt-2">
                                    DB: public.combined_store_info 컬럼은 <b>business_number</b> 사용 (business_no 없음)
                                </div>
                            </div>

                            <!-- 가게 검색(가게 연결 모드에서만 의미) -->
                            <div id="storeSearchBox" class="neo-card p-4">
                                <div class="font-black mb-2">가게 검색</div>
                                <div class="flex flex-col sm:flex-row gap-2">
                                    <input id="storeSearchInput"
                                        class="flex-1 border border-slate-200 rounded-xl px-3 py-2 bg-white"
                                        placeholder="상호/업종/번호 검색 (빈 값이면 전체)" />
                                    <button id="storeSearchBtn" class="btn btn-primary" type="button">검색</button>
                                    <button id="storeAllBtn" class="btn" type="button">전체</button>
                                </div>
                                <div class="mt-2 text-xs text-slate-500">
                                    API: GET /admin/subcategory/search , GET /admin/subcategory/stores
                                </div>

                                <div class="mt-3 flex items-center justify-between gap-2">
                                    <div class="text-sm text-slate-600">상태: <b id="modalStoreSearchStatus">대기</b></div>
                                    <div class="flex items-center gap-2">
                                        <button id="prevPageBtn" class="btn" type="button">이전</button>
                                        <span class="chip">page <b id="pageText">1</b></span>
                                        <button id="nextPageBtn" class="btn" type="button">다음</button>
                                    </div>
                                </div>

                                <div id="modalStoreResultList" class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
                            </div>

                            <!-- 후보 -->
                            <div class="neo-card p-4">
                                <div class="flex items-center justify-between gap-2">
                                    <div class="font-black">후보 (추천)</div>
                                    <button id="candidatesReloadBtn" class="btn" type="button">후보 새로고침</button>
                                </div>
                                <div class="text-xs text-slate-500 mt-2">API: GET /admin/subcategory/candidates</div>
                                <div id="candidatesList" class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- 모달 푸터 -->
                <div class="px-4 md:px-6 py-4 border-t border-slate-200 flex items-center justify-between gap-3">
                    <div class="text-xs text-slate-500">
                        GET /admin/subcategory/slot · POST /admin/subcategory/update (multipart, field: image) · DELETE
                        /admin/subcategory/delete
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="chip">slot: <b id="slotMetaText">-</b></span>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // =========================
        // 유틸
        // =========================
        const $ = (id) => document.getElementById(id);

        function clean(v) {
            if (v === undefined || v === null) return "";
            return String(v).trim();
        }

        async function safeJson(res) {
            const text = await res.text();
            try { return JSON.parse(text || "{}"); }
            catch { return { success: false, error: "JSON parse failed", raw: text }; }
        }

        async function apiGet(url) {
            const res = await fetch(url, { credentials: "include" });
            const data = await safeJson(res);
            if (!res.ok) throw new Error(data?.error || `HTTP ${res.status}`);
            return data;
        }

        async function apiDelete(url) {
            const res = await fetch(url, { method: "DELETE", credentials: "include" });
            const data = await safeJson(res);
            if (!res.ok) throw new Error(data?.error || `HTTP ${res.status}`);
            return data;
        }

        // =========================
        // 상태
        // =========================
        let __eventsBound = false;

        const state = {
            page: "subcategorymanager",
            mode: "food",            // food | combined
            uiAdMode: "image",       // image | text  (UI용)
            slotMode: "store",       // store | custom
            paging: { page: 1, limit: 12, lastQuery: "" },

            modal: {
                section: "",           // banner | slot
                idx: 0,                // 1~6 (priority)
                position: "",          // page:mode:section
                selectedStore: null,
            }
        };

        // =========================
        // position 규칙 (중요)
        //  - position = page:mode:section
        //  - priority = idx (1~6), banner는 1
        // =========================
        function buildPosition(section) {
            const s = clean(section) || "slot";
            return `${state.page}:${state.mode}:${s}`;
        }

        function applyModeBadge() {
            $("modeBadgeText").textContent = (state.mode === "food") ? "푸드" : "통합";
        }

        function applyModalModeUI() {
            if (state.mode === "food") {
                $("modalModeFoodBtn").classList.add("chip-on");
                $("modalModeCombinedBtn").classList.remove("chip-on");
            } else {
                $("modalModeCombinedBtn").classList.add("chip-on");
                $("modalModeFoodBtn").classList.remove("chip-on");
            }
        }

        // =========================
        // DB 제약 대응: slot_type 체크
        //  - admin_ad_slots_slot_type_check: ['banner','text']
        //  - 이미지 UI = banner 로 저장/표시
        // =========================
        function uiAdModeToDbSlotType(uiMode) {
            return (uiMode === "text") ? "text" : "banner";
        }

        function dbSlotTypeToUiAdMode(slotType) {
            return (clean(slotType) === "text") ? "text" : "image";
        }

        // =========================
        // UI 토글
        // =========================
        function setAdMode(uiMode) {
            state.uiAdMode = uiMode;

            if (uiMode === "image") {
                $("adModeImageBtn").classList.add("btn-primary");
                $("adModeTextBtn").classList.remove("btn-primary");
                $("imageBox").classList.remove("hidden");
                $("textBox").classList.add("hidden");
            } else {
                $("adModeTextBtn").classList.add("btn-primary");
                $("adModeImageBtn").classList.remove("btn-primary");
                $("textBox").classList.remove("hidden");
                $("imageBox").classList.add("hidden");
            }
        }

        function setSlotMode(mode) {
            state.slotMode = mode;

            if (mode === "store") {
                $("slotModeStoreBtn").classList.add("btn-primary");
                $("slotModeCustomBtn").classList.remove("btn-primary");
                $("storeSearchBox").classList.remove("hidden");
                $("storeSearchBox").classList.remove("dim");
            } else {
                $("slotModeCustomBtn").classList.add("btn-primary");
                $("slotModeStoreBtn").classList.remove("btn-primary");
                $("storeSearchBox").classList.add("dim"); // 참고용 유지
            }
        }

        // =========================
        // 모달 공통 초기화
        // =========================
        function resetModalInputs() {
            state.modal.selectedStore = null;
            $("selectedStoreText").textContent = "없음";

            $("modalStoreResultList").innerHTML = "";
            $("modalStoreSearchStatus").textContent = "대기";

            $("imageFileInput").value = "";
            $("selectedImageText").textContent = "없음";
            $("modalImagePreview").src = "/uploads/no-image.png";

            $("customTitle").value = "";
            $("customDesc").value = "";
            $("customLink").value = "";
        }

        function openModal(section, idx) {
            state.modal.section = clean(section);
            state.modal.idx = Number(idx || 0);

            const pos = buildPosition(state.modal.section);
            state.modal.position = pos;

            $("modalPageText").textContent = state.page;
            $("modalPositionText").textContent = pos;
            $("slotMetaText").textContent = `${state.modal.section} / ${state.modal.idx}`;

            applyModeBadge();
            applyModalModeUI();

            // 기본 모달 상태
            setAdMode("image");
            setSlotMode("store");
            resetModalInputs();

            $("modalStatus").textContent = "불러오는 중...";
            $("slotModal").classList.remove("hidden");
            document.body.style.overflow = "hidden";

            // 로드
            loadSlotIntoModal().catch(() => { });
            loadCandidates().catch(() => { });
            loadStorePage(1).catch(() => { });
        }

        function closeModal() {
            $("slotModal").classList.add("hidden");
            document.body.style.overflow = "";
        }

        function refreshModalPositionByMode() {
            const section = clean(state.modal.section);
            const idx = Number(state.modal.idx || 0);
            if (!section || !idx) return;

            const pos = buildPosition(section);
            state.modal.position = pos;
            $("modalPositionText").textContent = pos;

            resetModalInputs();

            $("modalStatus").textContent = "모드 변경됨 → position 재계산 완료";

            // 새 position 기준으로 다시 로드
            loadSlotIntoModal().catch(() => { });
            loadCandidates().catch(() => { });
            loadStorePage(1).catch(() => { });
        }

        // =========================
        // 슬롯 카드 렌더
        // =========================
        function makeSlotCard(section, idx) {
            const el = document.createElement("div");
            el.className = "neo-card p-4 cursor-pointer";
            el.setAttribute("data-slot", "1");
            el.setAttribute("data-section", section);
            el.setAttribute("data-index", String(idx));

            el.innerHTML = `
      <div class="flex items-center justify-between gap-2">
        <div>
          <div class="text-lg font-black">슬롯 ${idx}</div>
          <div class="text-sm text-slate-500">section=${section} / idx=${idx}</div>
        </div>
        <button class="btn btn-primary" type="button">편집</button>
      </div>

      <div class="mt-3 aspect-[16/9] rounded-2xl overflow-hidden bg-white border border-slate-200 flex items-center justify-center">
        <img data-preview-img src="/uploads/no-image.png" class="w-full h-full object-cover" alt="슬롯 미리보기"/>
      </div>

      <div class="mt-3 flex flex-wrap gap-2">
        <span class="chip">position: <b data-pos>-</b></span>
        <span class="chip">type: <b data-type>-</b></span>
        <span class="chip">mode: <b data-mode>-</b></span>
      </div>

      <div class="mt-3 text-sm text-slate-700 leading-relaxed">
        <div class="font-extrabold">제목: <span data-title class="font-semibold">-</span></div>
        <div class="mt-1">설명: <span data-desc class="text-slate-600">-</span></div>
        <div class="mt-1">가게: <span data-store class="text-slate-600">-</span></div>
      </div>
    `;
            return el;
        }

        function renderSlots() {
            const grid = $("slotGrid");
            grid.innerHTML = "";
            for (let i = 1; i <= 6; i++) {
                grid.appendChild(makeSlotCard("slot", i));
            }
        }

        function applySlotCardData(cardEl, section, idx, slotData) {
            const position = buildPosition(section);

            cardEl.querySelector("[data-pos]").textContent = position;
            cardEl.querySelector("[data-mode]").textContent = (state.mode === "food" ? "푸드" : "통합");

            // DB slot_type: banner|text
            const dbType = clean(slotData?.slot_type || slotData?.type || "");
            const uiType = (dbType === "text") ? "text" : (dbType ? "image" : "");
            cardEl.querySelector("[data-type]").textContent = uiType || "-";

            const title = clean(slotData?.title || slotData?.text_title || slotData?.custom_title || "");
            const desc = clean(slotData?.desc || slotData?.custom_desc || "");
            const storeName = clean(slotData?.business_name || slotData?.store_name || "");

            cardEl.querySelector("[data-title]").textContent = title || "-";
            cardEl.querySelector("[data-desc]").textContent = desc || "-";
            cardEl.querySelector("[data-store]").textContent = storeName || "-";

            const img = clean(slotData?.image_url || slotData?.image || slotData?.img_url || "");
            const imgEl = cardEl.querySelector("[data-preview-img]");
            imgEl.src = img || "/uploads/no-image.png";
        }

        function applyBannerData(slotData) {
            const pos = buildPosition("banner");
            $("bannerPositionText").textContent = pos;
            $("bannerModeText").textContent = (state.mode === "food" ? "푸드" : "통합");

            const dbType = clean(slotData?.slot_type || slotData?.type || "");
            const uiType = (dbType === "text") ? "text" : (dbType ? "image" : "");
            $("bannerTypeText").textContent = uiType || "-";

            const title = clean(slotData?.title || slotData?.text_title || "");
            const desc = clean(slotData?.desc || "");
            const storeName = clean(slotData?.business_name || "");

            $("bannerTitleText").textContent = title || "-";
            $("bannerDescText").textContent = desc || "-";
            $("bannerStoreText").textContent = storeName || "-";

            const img = clean(slotData?.image_url || slotData?.image || "");
            $("bannerPreviewImg").src = img || "/uploads/no-image.png";
        }

        async function hydrateAllSlots() {
            try {
                // 배너(priority=1)
                const banner = await getSlot(buildPosition("banner"), 1);
                applyBannerData(banner);

                // 슬롯 1~6
                const cards = [...document.querySelectorAll("[data-slot='1']")];
                for (const card of cards) {
                    const section = card.getAttribute("data-section");
                    const idx = Number(card.getAttribute("data-index") || 0);
                    const slot = await getSlot(buildPosition(section), idx);
                    applySlotCardData(card, section, idx, slot);
                }
            } catch (e) {
                console.error(e);
            }
        }

        // =========================
        // API: slot get/save/delete
        // =========================
        async function getSlot(position, priority) {
            try {
                const url = `/admin/subcategory/slot?page=${encodeURIComponent(state.page)}&position=${encodeURIComponent(position)}&priority=${encodeURIComponent(priority)}`;
                const data = await apiGet(url);
                return data?.slot || {};
            } catch {
                return {};
            }
        }

        async function loadSlotIntoModal() {
            const position = clean(state.modal.position);
            const priority = Number(state.modal.idx || 0);
            if (!position || !priority) return;

            $("modalStatus").textContent = "불러오는 중...";

            const slot = await getSlot(position, priority);

            // DB slot_type → UI adMode 변환
            const uiMode = dbSlotTypeToUiAdMode(slot?.slot_type);
            setAdMode(uiMode);

            // slot_mode
            const slotMode = clean(slot?.slot_mode || "");
            setSlotMode(slotMode === "custom" ? "custom" : "store");

            // 이미지
            const img = clean(slot?.image_url || "");
            if (img) $("modalImagePreview").src = img;

            // 텍스트 (컨트롤러 쪽에 맞춰 title/desc/link_url 사용)
            $("customTitle").value = clean(slot?.title || slot?.text_title || "");
            $("customDesc").value = clean(slot?.desc || "");
            $("customLink").value = clean(slot?.link_url || "");

            // 가게 연결
            const businessNumber = clean(slot?.business_number || slot?.store_business_number || "");
            const businessName = clean(slot?.business_name || slot?.store_name || "");
            const storeId = clean(slot?.store_id || "");

            if (businessNumber || businessName || storeId) {
                state.modal.selectedStore = {
                    id: storeId || "",
                    business_number: businessNumber,
                    business_name: businessName,
                    business_type: clean(slot?.business_type || slot?.store_type || ""),
                    image_url: clean(slot?.store_image_url || ""),
                };
                $("selectedStoreText").textContent =
                    businessName
                        ? `${businessName}${businessNumber ? " (" + businessNumber + ")" : ""}`
                        : (businessNumber || storeId || "없음");
            } else {
                state.modal.selectedStore = null;
                $("selectedStoreText").textContent = "없음";
            }

            $("modalStatus").textContent = "불러오기 완료";
        }

        async function saveSlot() {
            const section = clean(state.modal.section);
            const priority = Number(state.modal.idx || 0);
            const position = buildPosition(section);

            if (!section || !priority || !position) return;

            const fd = new FormData();
            fd.append("page", state.page);
            fd.append("position", position);
            fd.append("priority", String(priority));

            // ✅ DB 제약 대응: 이미지=banner / 텍스트=text 로 저장되게 컨트롤러에서 처리
            // 컨트롤러가 adMode를 받아서 slot_type으로 바꾼다면 adMode를 보내고,
            // 컨트롤러가 slot_type을 직접 받는다면 slot_type을 보내면 됨.
            //
            // 지금 너가 올린 컨트롤러는 req.body.adMode를 읽음.
            fd.append("adMode", state.uiAdMode); // image|text (컨트롤러가 banner|text로 매핑해야 함)
            fd.append("slotMode", state.slotMode);

            // 텍스트/링크
            fd.append("title", clean($("customTitle").value));
            fd.append("desc", clean($("customDesc").value));
            fd.append("linkUrl", clean($("customLink").value)); // 컨트롤러는 linkUrl 읽고 있음

            // 가게 연결
            if (state.slotMode === "store" && state.modal.selectedStore) {
                fd.append("storeId", clean(state.modal.selectedStore.id));
                fd.append("storeBusinessNumber", clean(state.modal.selectedStore.business_number));
                fd.append("storeName", clean(state.modal.selectedStore.business_name));
                fd.append("storeType", clean(state.modal.selectedStore.business_type));
                fd.append("storeImageUrl", clean(state.modal.selectedStore.image_url));
            }

            // 이미지 파일(필드명 image)
            const file = $("imageFileInput").files && $("imageFileInput").files[0];
            if (state.uiAdMode === "image" && file) {
                fd.append("image", file);
            }

            $("modalStatus").textContent = "저장 중...";

            const res = await fetch(`/admin/subcategory/update`, {
                method: "POST",
                body: fd,
                credentials: "include",
            });

            const data = await safeJson(res);
            if (!res.ok) throw new Error(data?.error || `HTTP ${res.status}`);

            $("modalStatus").textContent = "저장 완료";
            await hydrateAllSlots();
        }

        async function deleteSlot() {
            const section = clean(state.modal.section);
            const priority = Number(state.modal.idx || 0);
            const position = buildPosition(section);

            if (!section || !priority || !position) return;

            $("modalStatus").textContent = "삭제 중...";

            const url = `/admin/subcategory/delete?page=${encodeURIComponent(state.page)}&position=${encodeURIComponent(position)}&priority=${encodeURIComponent(priority)}`;
            await apiDelete(url);

            $("modalStatus").textContent = "삭제 완료";
            resetModalInputs();
            await hydrateAllSlots();
        }

        // =========================
        // 후보 (주의: 이 API는 page+position 필수)
        // 현재 컨트롤러(listCandidates)는 admin_ad_slots의 items를 내려줌
        // => "스토어 후보" UI로 보여주려면 컨트롤러가 store list를 내려야 함.
        //
        // 일단: items를 그대로 받아서 화면에 "슬롯 후보(저장된 것)"로 표시(안전)
        // =========================
        function normalizeCandidateItem(item) {
            // admin_ad_slots 레코드 형태
            return {
                id: clean(item?.store_id || ""),
                business_number: clean(item?.business_number || item?.store_business_number || ""),
                business_name: clean(item?.business_name || item?.store_name || ""),
                business_type: clean(item?.business_type || item?.store_type || ""),
                image_url: clean(item?.image_url || item?.store_image_url || ""),
            };
        }

        function makeStoreCard(store, { isCandidate = false } = {}) {
            const el = document.createElement("div");
            el.className = "neo-card p-3";
            el.innerHTML = `
      <div class="flex items-center gap-3">
        <div class="w-12 h-12 rounded-2xl overflow-hidden bg-white border border-slate-200 flex items-center justify-center">
          <img src="${store.image_url || "/uploads/no-image.png"}" class="w-full h-full object-cover" alt="이미지"/>
        </div>
        <div class="min-w-0 flex-1">
          <div class="font-black truncate">${store.business_name || "(상호없음)"}</div>
          <div class="text-xs text-slate-500 truncate">${store.business_type || "-"}</div>
          <div class="text-xs text-slate-500 truncate">사업자: <b>${store.business_number || "-"}</b></div>
        </div>
      </div>
      <div class="mt-3 flex items-center justify-end">
        <button class="btn btn-primary" type="button">${isCandidate ? "후보 선택" : "선택"}</button>
      </div>
    `;

            el.querySelector("button").addEventListener("click", () => {
                state.modal.selectedStore = store;
                $("selectedStoreText").textContent =
                    store.business_name
                        ? `${store.business_name}${store.business_number ? " (" + store.business_number + ")" : ""}`
                        : (store.business_number || store.id || "없음");
                $("modalStatus").textContent = "가게 선택됨";
            });

            return el;
        }

        async function loadCandidates() {
            try {
                const section = clean(state.modal.section);
                const position = buildPosition(section);

                const url = `/admin/subcategory/candidates?page=${encodeURIComponent(state.page)}&position=${encodeURIComponent(position)}`;
                const data = await apiGet(url);

                // 컨트롤러(listCandidates): { success:true, items:[...] }
                const items = data?.items || [];
                const stores = items.map(normalizeCandidateItem);

                const box = $("candidatesList");
                box.innerHTML = "";
                stores.forEach(s => box.appendChild(makeStoreCard(s, { isCandidate: true })));
            } catch (e) {
                console.error(e);
                // page/position 에러는 여기서 대부분 발생했었음.
                // 이제 position 포함했으니 정상이어야 함.
            }
        }

        // =========================
        // 스토어 리스트/검색 (listStores/searchStore)
        // =========================
        function normalizeStoreRow(s) {
            const businessNumber = clean(s?.business_number || s?.business_no || s?.biz_no || "");
            const businessName = clean(s?.business_name || s?.name || "");
            const businessType = clean(s?.business_type || s?.type || "");
            const id = clean(s?.id || s?.store_id || "");
            const img = clean(s?.image_url || s?.main_image_url || s?.img_url || "");
            return { id, business_number: businessNumber, business_name: businessName, business_type: businessType, image_url: img };
        }

        async function loadStorePage(page) {
            if (state.slotMode !== "store") return;

            state.paging.page = Math.max(1, Number(page || 1));
            $("pageText").textContent = String(state.paging.page);
            $("modalStoreSearchStatus").textContent = "불러오는 중...";

            const q = clean(state.paging.lastQuery);

            try {
                // 컨트롤러 listStores는 page/pageSize 사용중
                // 프론트는 page/limit로 보내고 있었으니 여기서 맞춰준다.
                const pageSize = state.paging.limit;

                let url = "";
                if (q) {
                    // searchStore는 results로 내려줌 (현재 컨트롤러 코드)
                    url = `/admin/subcategory/search?mode=${encodeURIComponent(state.mode)}&q=${encodeURIComponent(q)}&pageSize=${pageSize}`;
                    const data = await apiGet(url);
                    const rows = (data?.results || []);
                    // 여기서는 "찾은 결과"만 보여주고, 페이지네이션은 단순하게 유지
                    const stores = rows.slice(0, pageSize).map(normalizeStoreRow);

                    const list = $("modalStoreResultList");
                    list.innerHTML = "";
                    stores.forEach(s => list.appendChild(makeStoreCard(s)));

                    $("modalStoreSearchStatus").textContent = `완료 (${stores.length})`;
                    return;
                }

                url = `/admin/subcategory/stores?mode=${encodeURIComponent(state.mode)}&page=${state.paging.page}&pageSize=${pageSize}`;
                const data = await apiGet(url);
                const rows = (data?.stores || []);
                const stores = rows.map(normalizeStoreRow);

                const list = $("modalStoreResultList");
                list.innerHTML = "";
                stores.forEach(s => list.appendChild(makeStoreCard(s)));

                $("modalStoreSearchStatus").textContent = `완료 (${stores.length})`;
            } catch (e) {
                $("modalStoreSearchStatus").textContent = "실패";
                console.error(e);
            }
        }

        // =========================
        // 헤더 로드
        // =========================
        async function loadHeader() {
            try {
                const res = await fetch("/components/header.html");
                if (!res.ok) throw new Error("header load failed");
                $("header-placeholder").innerHTML = await res.text();
            } catch (e) {
                console.warn(e);
            }
        }

        // =========================
        // 이벤트 바인딩
        // =========================
        function bindEvents() {
            if (__eventsBound) return;
            __eventsBound = true;

            // 배너
            $("bannerEditBtn").addEventListener("click", () => openModal("banner", 1));
            $("bannerSlotCard").addEventListener("click", () => openModal("banner", 1));

            // 슬롯 grid (위임)
            $("slotGrid").addEventListener("click", (e) => {
                const slotEl = e.target.closest("[data-slot='1']");
                if (!slotEl) return;

                const section = slotEl.getAttribute("data-section");
                const idx = Number(slotEl.getAttribute("data-index") || 0);
                openModal(section, idx);
            });

            // 닫기
            $("modalCloseBtn").addEventListener("click", closeModal);
            $("slotModal").addEventListener("click", (e) => {
                if (e.target === $("modalBackdrop")) closeModal();
            });

            // 모드 토글
            $("modalModeFoodBtn").addEventListener("click", () => {
                state.mode = "food";
                applyModeBadge();
                applyModalModeUI();
                refreshModalPositionByMode();
                hydrateAllSlots().catch(() => { });
            });

            $("modalModeCombinedBtn").addEventListener("click", () => {
                state.mode = "combined";
                applyModeBadge();
                applyModalModeUI();
                refreshModalPositionByMode();
                hydrateAllSlots().catch(() => { });
            });

            // UI adMode
            $("adModeImageBtn").addEventListener("click", () => setAdMode("image"));
            $("adModeTextBtn").addEventListener("click", () => setAdMode("text"));

            // slot mode
            $("slotModeStoreBtn").addEventListener("click", () => {
                setSlotMode("store");
                loadStorePage(1).catch(() => { });
            });
            $("slotModeCustomBtn").addEventListener("click", () => setSlotMode("custom"));

            // 이미지 미리보기
            $("imageFileInput").addEventListener("change", () => {
                const f = $("imageFileInput").files && $("imageFileInput").files[0];
                $("selectedImageText").textContent = f ? f.name : "없음";
                if (f) $("modalImagePreview").src = URL.createObjectURL(f);
            });

            // 검색
            $("storeSearchBtn").addEventListener("click", () => {
                state.paging.lastQuery = clean($("storeSearchInput").value);
                loadStorePage(1);
            });

            $("storeAllBtn").addEventListener("click", () => {
                $("storeSearchInput").value = "";
                state.paging.lastQuery = "";
                loadStorePage(1);
            });

            // 페이지 이동
            $("prevPageBtn").addEventListener("click", () => loadStorePage(state.paging.page - 1));
            $("nextPageBtn").addEventListener("click", () => loadStorePage(state.paging.page + 1));

            // 후보 새로고침
            $("candidatesReloadBtn").addEventListener("click", loadCandidates);

            // 저장/불러오기/삭제
            $("saveBtn").addEventListener("click", async () => {
                try {
                    await saveSlot();
                } catch (e) {
                    console.error(e);
                    $("modalStatus").textContent = "저장 실패";
                    alert("저장 실패: " + (e?.message || e));
                }
            });

            $("reloadBtn").addEventListener("click", async () => {
                try {
                    await loadSlotIntoModal();
                } catch (e) {
                    console.error(e);
                    $("modalStatus").textContent = "불러오기 실패";
                    alert("불러오기 실패: " + (e?.message || e));
                }
            });

            $("deleteBtn").addEventListener("click", async () => {
                if (!confirm("정말 삭제할까요?")) return;
                try {
                    await deleteSlot();
                } catch (e) {
                    console.error(e);
                    $("modalStatus").textContent = "삭제 실패";
                    alert("삭제 실패: " + (e?.message || e));
                }
            });
        }

        // =========================
        // init
        // =========================
        async function init() {
            await loadHeader();
            applyModeBadge();
            renderSlots();
            bindEvents();
            await hydrateAllSlots();
        }

        init();
    </script>

</body>

</html>