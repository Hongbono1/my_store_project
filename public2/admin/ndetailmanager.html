<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>NDETAIL 관리자</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif;
        }

        /* 실제 ndetail 느낌 유지용(메뉴 리스트) */
        .menu-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* 클릭 영역 표시(문구는 안 넣고, hover만) */
        .slot-hover {
            cursor: pointer;
        }

        .slot-hover:hover {
            outline: 2px solid rgba(59, 130, 246, .35);
            outline-offset: 2px;
        }

        .slot-badge {
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 9999px;
            background: rgba(59, 130, 246, .10);
            color: rgb(37 99 235);
            border: 1px solid rgba(59, 130, 246, .18);
        }

        .slot-muted {
            color: #94a3b8;
        }

        .input {
            width: 100%;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 10px 12px;
            outline: none;
        }

        .input:focus {
            border-color: rgb(59 130 246);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, .15);
        }

        .btn {
            border-radius: 12px;
            padding: 10px 14px;
            font-weight: 700;
        }

        .btn-blue {
            background: rgb(37 99 235);
            color: white;
        }

        .btn-blue:hover {
            background: rgb(29 78 216);
        }

        .btn-gray {
            background: #f3f4f6;
            color: #111827;
        }

        .btn-gray:hover {
            background: #e5e7eb;
        }

        .btn-red {
            background: #fee2e2;
            color: #b91c1c;
        }

        .btn-red:hover {
            background: #fecaca;
        }

        .chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border-radius: 9999px;
            border: 1px solid #e5e7eb;
            background: white;
            font-size: 13px;
            color: #111827;
        }

        .divider {
            height: 1px;
            background: #e5e7eb;
        }
    </style>
</head>

<body class="bg-gradient-to-br from-blue-50 via-white to-blue-100 min-h-screen">

    <div id="header-placeholder"></div>

    <main class="max-w-7xl mx-auto p-4">
        <!-- 상단 헤더 -->
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-3 mb-4">
            <div>
                <div class="text-2xl font-extrabold text-gray-900">NDETAIL 관리자</div>
                <div class="text-sm text-gray-600">ndetail 레이아웃 + 각 영역 슬롯 설정(이미지/텍스트/가게연결)</div>
            </div>

            <div class="flex flex-wrap gap-2 items-center justify-start lg:justify-end">
                <span class="chip">
                    <span class="text-gray-500 font-bold">가게검색 모드</span>
                    <select id="modeSelect" class="bg-transparent outline-none font-bold">
                        <option value="food">food</option>
                        <option value="combined">combined</option>
                    </select>
                </span>

                <a href="/ndetail.html" target="_blank" rel="noopener" class="chip hover:bg-gray-50 font-bold">사용자
                    ndetail 보기</a>
            </div>
        </div>

        <!-- 실제 ndetail 템플릿 레이아웃 그대로 -->
        <div class="flex flex-col lg:flex-row gap-8 items-stretch">

            <!-- 1) 왼쪽: 이미지/지도/광고 -->
            <section id="leftCol" class="flex-1 flex flex-col gap-6 self-stretch h-full">

                <!-- 대표 이미지(슬라이더) 슬롯 -->
                <div id="slot_images"
                    class="rounded-3xl bg-white shadow-xl p-6 flex flex-col items-center overflow-hidden flex-shrink-0 slot-hover"
                    data-section="images">
                    <div class="w-full flex items-center justify-between mb-2">
                        <div class="text-lg font-extrabold">대표 이미지(슬라이더)</div>
                        <span class="slot-badge" data-badge>미설정</span>
                    </div>

                    <!-- 표시 영역 -->
                    <div class="w-full h-80 rounded-2xl overflow-hidden bg-gray-50 border border-gray-200 flex items-center justify-center"
                        data-body>
                        <div class="text-gray-400 font-bold">이미지 슬롯(클릭해서 설정)</div>
                    </div>

                    <div class="text-center font-bold mt-3 text-gray-700">대표 이미지</div>
                </div>

                <!-- 지도 슬롯 -->
                <div id="slot_map" class="rounded-3xl bg-white shadow-xl p-6 overflow-hidden flex-shrink-0 slot-hover"
                    data-section="map">
                    <div class="w-full flex items-center justify-between mb-2">
                        <div class="text-lg font-extrabold">위치/지도</div>
                        <span class="slot-badge" data-badge>미설정</span>
                    </div>

                    <div class="text-sm text-gray-600 mb-2" data-subtitle>주소/좌표/링크 등을 텍스트로 넣거나, 가게 연결을 사용</div>

                    <div class="w-full h-[244px] rounded-xl overflow-hidden bg-gray-50 border border-gray-200 flex items-center justify-center"
                        data-body>
                        <div class="text-gray-400 font-bold">지도 영역(클릭해서 설정)</div>
                    </div>
                </div>

                <!-- 광고 1 -->
                <div id="slot_ad1" class="rounded-3xl bg-white shadow-xl p-3 overflow-hidden flex-shrink-0 slot-hover"
                    data-section="ad1">
                    <div class="w-full flex items-center justify-between px-3 pt-2 pb-2">
                        <div class="text-lg font-extrabold">광고 1</div>
                        <span class="slot-badge" data-badge>미설정</span>
                    </div>

                    <div class="rounded-xl w-full h-60 bg-gray-50 border border-gray-200 flex items-center justify-center"
                        data-body>
                        <div class="text-gray-400 font-bold">광고 이미지/텍스트(클릭해서 설정)</div>
                    </div>
                </div>

                <!-- 광고 2 -->
                <div id="slot_ad2" class="rounded-3xl bg-white shadow-xl p-3 overflow-hidden flex-shrink-0 slot-hover"
                    data-section="ad2">
                    <div class="w-full flex items-center justify-between px-3 pt-2 pb-2">
                        <div class="text-lg font-extrabold">광고 2</div>
                        <span class="slot-badge" data-badge>미설정</span>
                    </div>

                    <div class="rounded-xl w-full h-60 bg-gray-50 border border-gray-200 flex items-center justify-center"
                        data-body>
                        <div class="text-gray-400 font-bold">광고 이미지/텍스트(클릭해서 설정)</div>
                    </div>
                </div>

            </section>

            <!-- 2) 가운데: 상세정보 -->
            <section id="middleCol" class="flex-[1.1] flex flex-col gap-6">

                <!-- 상호/예약 -->
                <div id="slot_header"
                    class="rounded-3xl bg-white shadow-xl p-6 overflow-hidden flex-shrink-0 slot-hover"
                    data-section="header">
                    <div class="flex items-center justify-between mb-2">
                        <div class="text-lg font-extrabold">상호/상단영역</div>
                        <span class="slot-badge" data-badge>미설정</span>
                    </div>

                    <div class="text-3xl font-bold text-center mb-2" data-title>상호명</div>
                    <div class="flex justify-center mt-2">
                        <button class="bg-blue-500 text-white px-5 py-2 rounded-lg shadow hover:bg-blue-700 transition"
                            type="button" disabled>예약 신청</button>
                    </div>

                    <div class="mt-3 rounded-xl border border-gray-200 bg-gray-50 p-3 text-sm text-gray-600" data-body>
                        상단 텍스트/이미지 또는 가게 연결로 표시
                    </div>
                </div>

                <!-- 기본 정보 -->
                <div id="slot_basic" class="rounded-3xl bg-white shadow-xl p-6 overflow-hidden flex-shrink-0 slot-hover"
                    data-section="basic">
                    <div class="flex items-center justify-between mb-2">
                        <div class="text-lg font-extrabold">기본 정보</div>
                        <span class="slot-badge" data-badge>미설정</span>
                    </div>

                    <div class="divider mb-3"></div>

                    <dl class="grid grid-cols-2 gap-x-3 gap-y-1 text-xl" data-body>
                        <dt class="font-bold text-gray-700">업 종</dt>
                        <dd class="font-bold text-gray-900 slot-muted">-</dd>

                        <dt class="font-bold text-gray-700">카테고리</dt>
                        <dd class="font-bold text-gray-900 slot-muted">-</dd>

                        <dt class="font-bold text-gray-700">배 달</dt>
                        <dd class="font-bold text-gray-900 slot-muted">-</dd>

                        <dt class="font-bold text-gray-700">영업시간</dt>
                        <dd class="font-bold text-gray-900 slot-muted">-</dd>
                    </dl>
                </div>

                <!-- 서비스 내용 -->
                <div id="slot_service"
                    class="rounded-2xl bg-blue-50 shadow p-6 flex flex-col h-48 overflow-hidden slot-hover"
                    data-section="service">
                    <div class="flex items-center justify-between mb-2">
                        <div class="text-lg font-extrabold">서비스 내용</div>
                        <span class="slot-badge" data-badge>미설정</span>
                    </div>

                    <div class="divider mb-2"></div>

                    <div class="flex-1 overflow-auto text-lg text-gray-700" data-body>
                        <div class="slot-muted">-</div>
                    </div>

                    <div class="text-right mt-2">
                        <button class="px-3 py-1 bg-blue-600 text-white rounded text-sm" type="button" disabled>자세히
                            보기</button>
                    </div>
                </div>

                <!-- 이벤트 -->
                <div id="slot_events"
                    class="rounded-2xl bg-yellow-50 shadow p-6 overflow-hidden flex-shrink-0 slot-hover"
                    data-section="events">
                    <div class="flex items-center justify-between mb-2">
                        <div class="text-lg font-extrabold">이벤트</div>
                        <span class="slot-badge" data-badge>미설정</span>
                    </div>

                    <div class="divider mb-2"></div>

                    <ul class="list-disc ml-5 text-lg text-gray-700" data-body>
                        <li class="slot-muted">-</li>
                    </ul>
                </div>

                <!-- 기타 정보 -->
                <div id="slot_etc" class="rounded-2xl bg-gray-50 shadow p-6 overflow-hidden flex-shrink-0 slot-hover"
                    data-section="etc">
                    <div class="flex items-center justify-between mb-2">
                        <div class="text-lg font-extrabold">기타 정보</div>
                        <span class="slot-badge" data-badge>미설정</span>
                    </div>

                    <div class="divider mb-2"></div>

                    <ul class="list-disc pl-5 text-lg text-gray-700" data-body>
                        <li class="slot-muted">-</li>
                    </ul>
                </div>

                <!-- 추가 설명 -->
                <div id="slot_additional"
                    class="rounded-2xl bg-blue-50 shadow p-6 flex flex-col h-48 overflow-hidden slot-hover"
                    data-section="additional">
                    <div class="flex items-center justify-between mb-2">
                        <div class="text-lg font-extrabold">추가 설명</div>
                        <span class="slot-badge" data-badge>미설정</span>
                    </div>

                    <div class="divider mb-2"></div>

                    <div class="flex-1 overflow-auto text-lg text-gray-700" data-body>
                        <div class="slot-muted">-</div>
                    </div>

                    <div class="text-right mt-2">
                        <button class="px-3 py-1 bg-blue-600 text-white rounded text-sm" type="button" disabled>자세히
                            보기</button>
                    </div>
                </div>

                <!-- 연락처 -->
                <div id="slot_contact"
                    class="rounded-2xl bg-gray-50 shadow p-6 lg:pb-10 overflow-hidden flex-shrink-0 slot-hover"
                    data-section="contact">
                    <div class="flex items-center justify-between mb-2">
                        <div class="text-lg font-extrabold">연락처</div>
                        <span class="slot-badge" data-badge>미설정</span>
                    </div>

                    <div class="divider mb-2"></div>

                    <div class="grid grid-cols-2 gap-3 text-lg" data-body>
                        <div class="col-span-2 text-center slot-muted">-</div>
                    </div>
                </div>

            </section>

            <!-- 3) 오른쪽: 메뉴/장바구니 -->
            <section id="rightCol" class="flex-[1.3] flex flex-col gap-6 min-h-0">

                <!-- 메뉴 -->
                <div id="slot_menu"
                    class="rounded-3xl bg-white shadow-xl p-6 overflow-hidden flex flex-col min-h-0 flex-1 slot-hover"
                    data-section="menu">
                    <div class="flex items-center justify-between mb-3">
                        <div class="text-lg font-extrabold">메뉴</div>
                        <span class="slot-badge" data-badge>미설정</span>
                    </div>

                    <div class="divider mb-3"></div>

                    <div class="menu-list flex-1 flex flex-col gap-3 overflow-y-auto pr-1" data-body>
                        <div class="text-center text-gray-500 py-4">메뉴 표시 영역</div>
                    </div>
                </div>

                <!-- 장바구니/결제 -->
                <div id="slot_cart" class="rounded-2xl bg-yellow-50 shadow p-6 overflow-hidden flex-shrink-0 slot-hover"
                    data-section="cart">
                    <div class="flex items-center justify-between mb-2">
                        <div class="text-lg font-extrabold">장바구니/결제창</div>
                        <span class="slot-badge" data-badge>미설정</span>
                    </div>

                    <div class="divider mb-3"></div>

                    <div class="text-gray-700" data-body>
                        <div class="flex justify-between items-center">
                            <span class="font-bold text-gray-800">합계:</span>
                            <span class="text-2xl font-bold text-blue-700">0원</span>
                        </div>
                        <button class="mt-3 w-full bg-blue-600 text-white py-2 rounded-lg shadow" type="button"
                            disabled>결제하기</button>
                    </div>
                </div>

            </section>

        </div>
    </main>

    <div id="footer-placeholder"></div>

    <!-- =========================
       설정 모달
  ========================== -->
    <div id="modal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50 p-4">
        <div class="bg-white w-full max-w-3xl rounded-2xl shadow-2xl overflow-hidden">
            <!-- 헤더 -->
            <div class="px-6 py-4 border-b flex items-center justify-between">
                <div>
                    <div id="modalTitle" class="text-xl font-extrabold">슬롯 설정</div>
                    <div class="text-sm text-gray-600 mt-1">
                        position: <span id="modalPosition" class="font-mono text-gray-900"></span>
                    </div>
                </div>
                <button id="modalClose"
                    class="w-10 h-10 rounded-full bg-gray-100 hover:bg-gray-200 text-xl leading-none"
                    type="button">×</button>
            </div>

            <!-- 본문 -->
            <div class="p-6 space-y-5 max-h-[72vh] overflow-auto">
                <!-- 타입/모드 -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div>
                        <div class="font-bold text-gray-800 mb-2">슬롯 타입</div>
                        <select id="slotType" class="input">
                            <option value="image">image (이미지)</option>
                            <option value="text">text (텍스트)</option>
                        </select>
                    </div>
                    <div>
                        <div class="font-bold text-gray-800 mb-2">표시 모드</div>
                        <select id="slotMode" class="input">
                            <option value="custom">custom (직접 입력)</option>
                            <option value="store">store (가게 연결)</option>
                        </select>
                    </div>
                </div>

                <!-- 이미지 업로드 -->
                <div id="imageBox">
                    <div class="font-bold text-gray-800 mb-2">이미지 업로드</div>
                    <input id="imageFile" type="file" accept="image/*" class="input" />
                    <div class="text-sm text-gray-500 mt-2">업로드하면 기존 이미지는 교체됩니다.</div>

                    <div class="mt-3">
                        <div class="font-bold text-gray-800 mb-2">현재 이미지 미리보기</div>
                        <div id="imagePreview"
                            class="w-full h-52 rounded-xl border bg-gray-50 flex items-center justify-center overflow-hidden">
                            <span class="text-gray-400 font-bold">없음</span>
                        </div>
                    </div>
                </div>

                <!-- 텍스트 -->
                <div id="textBox">
                    <div class="font-bold text-gray-800 mb-2">텍스트</div>
                    <textarea id="textValue" rows="5" class="input" placeholder="표시할 텍스트를 입력"></textarea>
                </div>

                <!-- 링크 -->
                <div>
                    <div class="font-bold text-gray-800 mb-2">링크 URL (선택)</div>
                    <input id="linkUrl" class="input" placeholder="https://..." />
                    <div class="text-sm text-gray-500 mt-2">텍스트/이미지 클릭 시 이동할 링크. (store 모드면 store_id 기반 링크도 가능)</div>
                </div>

                <!-- 가게 연결 -->
                <div id="storeBox" class="rounded-xl border p-4 bg-gray-50">
                    <div class="flex items-center justify-between gap-2">
                        <div class="font-extrabold text-gray-900">가게 연결</div>
                        <div class="text-sm text-gray-600">검색 모드: <span id="modeNow" class="font-bold"></span></div>
                    </div>

                    <div class="mt-3 grid grid-cols-1 md:grid-cols-3 gap-2">
                        <input id="storeQuery" class="input md:col-span-2" placeholder="사업자번호 또는 상호명 입력" />
                        <button id="storeSearchBtn" class="btn btn-blue w-full" type="button">검색</button>
                    </div>

                    <div class="mt-3 text-sm text-gray-600">
                        선택된 가게:
                        <span id="pickedStore" class="font-bold text-gray-900">없음</span>
                    </div>

                    <div id="storeResults" class="mt-3 grid grid-cols-1 gap-2"></div>
                </div>

                <!-- 기간/우선순위 -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <div>
                        <div class="font-bold text-gray-800 mb-2">시작일 (선택)</div>
                        <input id="startDate" type="date" class="input" />
                    </div>
                    <div>
                        <div class="font-bold text-gray-800 mb-2">종료일 (선택)</div>
                        <input id="endDate" type="date" class="input" />
                    </div>
                    <div>
                        <div class="font-bold text-gray-800 mb-2">우선순위</div>
                        <input id="priority" type="number" min="1" value="1" class="input" />
                    </div>
                </div>

                <div class="flex items-center gap-2">
                    <input id="noEnd" type="checkbox" class="w-5 h-5" />
                    <label for="noEnd" class="font-bold text-gray-800">종료 없음(no_end)</label>
                </div>

                <div id="saveMsg" class="text-sm font-bold"></div>
            </div>

            <!-- 하단 버튼 -->
            <div class="px-6 py-4 border-t flex flex-col md:flex-row gap-2 justify-between">
                <button id="deleteBtn" class="btn btn-red hidden" type="button">삭제</button>
                <div class="flex gap-2 justify-end w-full md:w-auto">
                    <button id="cancelBtn" class="btn btn-gray" type="button">닫기</button>
                    <button id="saveBtn" class="btn btn-blue" type="button">저장</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // =========================
        // 헤더/푸터 동적 포함
        // =========================
        async function loadPartial(targetId, url) {
            const el = document.getElementById(targetId);
            if (!el) return;
            try {
                const res = await fetch(url + `?v=${Date.now()}`, { cache: "no-cache" });
                el.innerHTML = await res.text();
                el.querySelectorAll("script").forEach(old => {
                    const s = document.createElement("script");
                    [...old.attributes].forEach(a => s.setAttribute(a.name, a.value));
                    s.textContent = old.textContent || "";
                    old.replaceWith(s);
                });
            } catch (e) {
                console.warn("partial load failed:", url, e);
            }
        }

        await loadPartial("header-placeholder", "/components/header.html");
        await loadPartial("footer-placeholder", "/components/footer.html");
        document.getElementById("header-placeholder")?.style.setProperty("display", "contents");
        document.getElementById("footer-placeholder")?.style.setProperty("display", "contents");

        // =========================
        // 상태
        // =========================
        const state = {
            mode: "food", // store search mode
            modal: {
                section: "",
                position: "",
                slot: null,
                pickedStore: null, // {id,business_number,business_name,...}
            }
        };

        const $ = (id) => document.getElementById(id);

        function escapeHtml(s = "") {
            s = String(s ?? "");
            return s.replace(/[&<>\"']/g, (m) => ({
                "&": "&amp;",
                "<": "&lt;",
                ">": "&gt;",
                '"': "&quot;",
                "'": "&#39;",
            }[m]));
        }

        function normalizeSrc(src) {
            if (!src) return "";
            if (src.startsWith("http") || src.startsWith("/")) return src;
            // 업로드는 /uploads/ 로 접근
            return `/uploads/${src}`;
        }

        function buildPosition(section) {
            return `ndetail|${section}`;
        }

        function setBadge(el, slot) {
            const badge = el.querySelector("[data-badge]");
            if (!badge) return;
            if (!slot) {
                badge.textContent = "미설정";
                badge.classList.remove("bg-emerald-50", "text-emerald-700", "border-emerald-200");
                return;
            }
            badge.textContent = slot.slot_type === "image" ? "이미지" : "텍스트";
        }

        // =========================
        // 슬롯 렌더
        // =========================
        function renderSlot(el, slot) {
            const body = el.querySelector("[data-body]");
            if (!body) return;

            // ✅ 제목은 항상 보이게(요구사항)
            setBadge(el, slot);

            // slot 데이터 없으면 기본 표시 유지
            if (!slot) return;

            const type = String(slot.slot_type || "").toLowerCase();
            const mode = String(slot.slot_mode || "").toLowerCase();

            // 공통: 링크 만들기
            const linkUrl = slot.link_url ? String(slot.link_url) : "";

            // store 연결이면 표시용 라벨
            const storeLabel = mode === "store"
                ? `<div class="mt-2 text-sm text-gray-600">
             <span class="font-bold text-gray-800">가게 연결:</span>
             <span class="font-bold text-gray-900">${escapeHtml(slot.business_name || slot.business_no || slot.store_id || "")}</span>
           </div>`
                : "";

            if (type === "image") {
                const img = normalizeSrc(slot.image_url || "");
                if (!img) return;

                body.innerHTML = `
          <a href="${escapeHtml(linkUrl || "#")}" ${linkUrl ? `target="_blank" rel="noopener"` : ""} class="block w-full h-full">
            <img src="${escapeHtml(img)}" class="w-full h-full object-cover" alt="slot image" />
          </a>
          ${storeLabel}
        `;
                return;
            }

            // text
            const text = (slot.text || "").trim();
            if (!text) return;

            body.innerHTML = `
        <div class="text-gray-800 text-base leading-relaxed whitespace-pre-wrap">${escapeHtml(text)}</div>
        ${linkUrl ? `<div class="mt-2 text-sm"><a class="text-blue-700 font-bold hover:underline" href="${escapeHtml(linkUrl)}" target="_blank" rel="noopener">링크 열기</a></div>` : ""}
        ${storeLabel}
      `;
        }

        async function fetchSlot(position) {
            console.log('[fetchSlot] 요청:', position);
            const res = await fetch(`/ndetailmanager/ad/slot?position=${encodeURIComponent(position)}`, { cache: "no-store" });
            console.log('[fetchSlot] 응답 상태:', res.status);
            if (!res.ok) {
                console.error('[fetchSlot] 실패:', res.status, res.statusText);
                return null;
            }
            const json = await res.json().catch(() => null);
            console.log('[fetchSlot] 응답 데이터:', json);
            return json?.slot || null;
        }

        async function loadSection(section) {
            const position = buildPosition(section);
            const el = document.querySelector(`[data-section="${section}"]`);
            if (!el) return;

            const slot = await fetchSlot(position);
            renderSlot(el, slot);
        }

        async function loadAll() {
            const sections = ["images", "map", "ad1", "ad2", "header", "basic", "service", "events", "etc", "additional", "contact", "menu", "cart"];
            for (const s of sections) await loadSection(s);
        }

        // =========================
        // 모달
        // =========================
        function openModal(section) {
            state.modal.section = section;
            state.modal.position = buildPosition(section);
            state.modal.slot = null;
            state.modal.pickedStore = null;

            $("modalTitle").textContent = `슬롯 설정: ${section}`;
            $("modalPosition").textContent = state.modal.position;
            $("saveMsg").textContent = "";
            $("saveMsg").className = "text-sm font-bold";

            $("imageFile").value = "";
            $("textValue").value = "";
            $("linkUrl").value = "";
            $("startDate").value = "";
            $("endDate").value = "";
            $("noEnd").checked = false;
            $("priority").value = "1";
            $("pickedStore").textContent = "없음";
            $("storeResults").innerHTML = "";
            $("imagePreview").innerHTML = `<span class="text-gray-400 font-bold">없음</span>`;

            $("modeNow").textContent = state.mode;

            // 기본값(섹션에 따라 초기 타입 추천)
            const defaultType = (section === "ad1" || section === "ad2" || section === "images") ? "image" : "text";
            $("slotType").value = defaultType;
            $("slotMode").value = "custom";
            toggleBoxes();

            // 데이터 로드
            (async () => {
                console.log('[openModal] 슬롯 로드 시작:', state.modal.position);
                const slot = await fetchSlot(state.modal.position);
                console.log('[openModal] 로드된 슬롯:', slot);
                state.modal.slot = slot;

                if (slot) {
                    console.log('[openModal] 슬롯 데이터 있음 - UI 업데이트');
                    $("slotType").value = slot.slot_type || defaultType;
                    $("slotMode").value = slot.slot_mode || "custom";
                    $("textValue").value = slot.text || "";
                    $("linkUrl").value = slot.link_url || "";
                    $("startDate").value = slot.start_date ? String(slot.start_date).slice(0, 10) : "";
                    $("endDate").value = slot.end_date ? String(slot.end_date).slice(0, 10) : "";
                    $("noEnd").checked = !!slot.no_end;
                    $("priority").value = slot.priority ?? 1;

                    if (slot.image_url) {
                        const img = normalizeSrc(slot.image_url);
                        $("imagePreview").innerHTML = `<img src="${escapeHtml(img)}" class="w-full h-full object-cover" />`;
                        console.log('[openModal] 이미지 설정:', img);
                    }

                    if (slot.slot_mode === "store" && (slot.store_id || slot.business_no || slot.business_name)) {
                        $("pickedStore").textContent = slot.business_name || slot.business_no || slot.store_id;
                        state.modal.pickedStore = {
                            id: slot.store_id,
                            business_number: slot.business_no,
                            business_name: slot.business_name
                        };
                        console.log('[openModal] 매장 정보 설정:', state.modal.pickedStore);
                    }

                    $("deleteBtn").classList.remove("hidden");
                } else {
                    console.log('[openModal] 슬롯 데이터 없음 - 신규 등록 모드');
                    $("deleteBtn").classList.add("hidden");
                }

                toggleBoxes();
            })();

            $("modal").classList.remove("hidden");
            $("modal").classList.add("flex");
        }

        function closeModal() {
            $("modal").classList.add("hidden");
            $("modal").classList.remove("flex");
        }

        function toggleBoxes() {
            const type = $("slotType").value;
            const mode = $("slotMode").value;

            $("imageBox").style.display = (type === "image") ? "block" : "none";
            $("textBox").style.display = (type === "text") ? "block" : "none";
            $("storeBox").style.display = (mode === "store") ? "block" : "none";

            // 종료없음 체크 시 종료일 비활성화
            $("endDate").disabled = $("noEnd").checked;
            if ($("noEnd").checked) $("endDate").value = "";
        }

        async function saveSlot() {
            $("saveMsg").textContent = "";
            const fd = new FormData();

            fd.append("position", state.modal.position);
            fd.append("slot_type", $("slotType").value);
            fd.append("slot_mode", $("slotMode").value);

            fd.append("text", $("textValue").value || "");
            fd.append("link_url", $("linkUrl").value || "");

            fd.append("start_date", $("startDate").value || "");
            fd.append("end_date", $("endDate").value || "");
            fd.append("no_end", $("noEnd").checked ? "true" : "false");
            fd.append("priority", $("priority").value || "1");

            // store mode
            if ($("slotMode").value === "store" && state.modal.pickedStore) {
                if (state.modal.pickedStore.id != null) fd.append("store_id", String(state.modal.pickedStore.id));
                fd.append("business_no", state.modal.pickedStore.business_number || "");
                fd.append("business_name", state.modal.pickedStore.business_name || "");
            } else {
                fd.append("store_id", "");
                fd.append("business_no", "");
                fd.append("business_name", "");
            }

            // image
            const f = $("imageFile").files?.[0];
            if (f) fd.append("image", f);

            try {
                const res = await fetch("/ndetailmanager/ad/update", {
                    method: "POST",
                    body: fd,
                });
                const json = await res.json().catch(() => null);
                if (!res.ok || !json?.success) throw new Error(json?.message || `HTTP ${res.status}`);

                $("saveMsg").className = "text-sm font-bold text-emerald-700";
                $("saveMsg").textContent = "✅ 저장 완료";

                // 화면 반영
                await loadSection(state.modal.section);
                // 모달 데이터 갱신
                state.modal.slot = json.slot || null;
                $("deleteBtn").classList.remove("hidden");

            } catch (e) {
                console.error(e);
                $("saveMsg").className = "text-sm font-bold text-red-600";
                $("saveMsg").textContent = "❌ 저장 실패: " + (e?.message || "오류");
            }
        }

        async function deleteSlot() {
            if (!confirm("정말 삭제할까요?")) return;

            try {
                const res = await fetch(`/ndetailmanager/ad/delete?position=${encodeURIComponent(state.modal.position)}`, {
                    method: "DELETE",
                });
                const json = await res.json().catch(() => null);
                if (!res.ok || !json?.success) throw new Error(json?.message || `HTTP ${res.status}`);

                $("saveMsg").className = "text-sm font-bold text-emerald-700";
                $("saveMsg").textContent = "✅ 삭제 완료";

                await loadSection(state.modal.section);
                closeModal();
            } catch (e) {
                console.error(e);
                $("saveMsg").className = "text-sm font-bold text-red-600";
                $("saveMsg").textContent = "❌ 삭제 실패: " + (e?.message || "오류");
            }
        }

        async function searchStore() {
            const q = ($("storeQuery").value || "").trim();
            if (!q) return;

            $("storeResults").innerHTML = `<div class="text-sm text-gray-500">검색 중...</div>`;

            try {
                const mode = state.mode;
                const res = await fetch(`/ndetailmanager/ad/search-store?q=${encodeURIComponent(q)}&mode=${encodeURIComponent(mode)}`, { cache: "no-store" });
                const json = await res.json().catch(() => null);
                const results = json?.results || [];

                if (!Array.isArray(results) || results.length === 0) {
                    $("storeResults").innerHTML = `<div class="text-sm text-gray-500">결과 없음</div>`;
                    return;
                }

                $("storeResults").innerHTML = results.map(r => {
                    const img = normalizeSrc(r.image_url || "");
                    return `
            <button type="button"
              class="w-full text-left rounded-xl border bg-white hover:bg-gray-50 p-3 flex gap-3 items-center"
              data-pick='${escapeHtml(JSON.stringify(r))}'>
              <div class="w-16 h-16 rounded-lg bg-gray-100 overflow-hidden flex items-center justify-center">
                ${img ? `<img src="${escapeHtml(img)}" class="w-full h-full object-cover" />` : `<span class="text-xs text-gray-400 font-bold">NO IMG</span>`}
              </div>
              <div class="min-w-0 flex-1">
                <div class="font-extrabold text-gray-900 truncate">${escapeHtml(r.business_name || "-")}</div>
                <div class="text-sm text-gray-600">사업자: ${escapeHtml(r.business_number || "-")}</div>
                <div class="text-sm text-gray-600">업종/카테고리: ${escapeHtml((r.business_type || "") + " / " + (r.business_category || ""))}</div>
              </div>
              <div class="text-blue-700 font-extrabold">선택</div>
            </button>
          `;
                }).join("");

                $("storeResults").querySelectorAll("button[data-pick]").forEach(btn => {
                    btn.addEventListener("click", () => {
                        const r = JSON.parse(btn.getAttribute("data-pick"));
                        state.modal.pickedStore = {
                            id: r.id,
                            business_number: r.business_number,
                            business_name: r.business_name
                        };
                        $("pickedStore").textContent = `${r.business_name} (${r.business_number || "-"})`;
                        $("saveMsg").textContent = "";
                    });
                });

            } catch (e) {
                console.error(e);
                $("storeResults").innerHTML = `<div class="text-sm text-red-600 font-bold">검색 실패</div>`;
            }
        }

        // =========================
        // 이벤트 바인딩
        // =========================
        $("modeSelect").addEventListener("change", (e) => {
            state.mode = e.target.value;
            $("modeNow").textContent = state.mode;
        });

        document.querySelectorAll("[data-section]").forEach(el => {
            el.addEventListener("click", () => {
                const section = el.getAttribute("data-section");
                openModal(section);
            });
        });

        $("slotType").addEventListener("change", toggleBoxes);
        $("slotMode").addEventListener("change", toggleBoxes);
        $("noEnd").addEventListener("change", toggleBoxes);

        $("modalClose").addEventListener("click", closeModal);
        $("cancelBtn").addEventListener("click", closeModal);
        $("saveBtn").addEventListener("click", saveSlot);
        $("deleteBtn").addEventListener("click", deleteSlot);

        $("storeSearchBtn").addEventListener("click", searchStore);
        $("storeQuery").addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
                e.preventDefault();
                searchStore();
            }
        });

        // 모달 바깥 클릭 닫기
        $("modal").addEventListener("click", (e) => {
            if (e.target === $("modal")) closeModal();
        });

        // =========================
        // 초기 로드
        // =========================
        await loadAll();
    </script>

</body>

</html>