<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>NDETAIL ê´€ë¦¬ì</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif;
        }

        /* ì‹¤ì œ ndetail ëŠë‚Œ ìœ ì§€ìš©(ë©”ë‰´ ë¦¬ìŠ¤íŠ¸) */
        .menu-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* í´ë¦­ ì˜ì—­ í‘œì‹œ(ë¬¸êµ¬ëŠ” ì•ˆ ë„£ê³ , hoverë§Œ) */
        .slot-hover {
            cursor: pointer;
        }

        .slot-hover:hover {
            outline: 2px solid rgba(59, 130, 246, .35);
            outline-offset: 2px;
        }

        .slot-badge {
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 9999px;
            background: rgba(59, 130, 246, .10);
            color: rgb(37 99 235);
            border: 1px solid rgba(59, 130, 246, .18);
        }

        .slot-muted {
            color: #94a3b8;
        }

        .input {
            width: 100%;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 10px 12px;
            outline: none;
        }

        .input:focus {
            border-color: rgb(59 130 246);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, .15);
        }

        .btn {
            border-radius: 12px;
            padding: 10px 14px;
            font-weight: 700;
        }

        .btn-blue {
            background: rgb(37 99 235);
            color: white;
        }

        .btn-blue:hover {
            background: rgb(29 78 216);
        }

        .btn-gray {
            background: #f3f4f6;
            color: #111827;
        }

        .btn-gray:hover {
            background: #e5e7eb;
        }

        .btn-red {
            background: #fee2e2;
            color: #b91c1c;
        }

        .btn-red:hover {
            background: #fecaca;
        }

        .chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border-radius: 9999px;
            border: 1px solid #e5e7eb;
            background: white;
            font-size: 13px;
            color: #111827;
        }

        .divider {
            height: 1px;
            background: #e5e7eb;
        }
    </style>
</head>

<body class="bg-gradient-to-br from-blue-50 via-white to-blue-100 min-h-screen">

    <div id="header-placeholder"></div>

    <main class="max-w-7xl mx-auto p-4">
        <!-- ìƒë‹¨ í—¤ë” -->
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-3 mb-4">
            <div>
                <div class="text-2xl font-extrabold text-gray-900">NDETAIL ê´€ë¦¬ì</div>
                <div class="text-sm text-gray-600">ndetail ë ˆì´ì•„ì›ƒ + ê° ì˜ì—­ ìŠ¬ë¡¯ ì„¤ì •(ì´ë¯¸ì§€/í…ìŠ¤íŠ¸/ê°€ê²Œì—°ê²°)</div>
            </div>

            <!-- âœ… ìƒë‹¨ ê°€ê²Œ ê²€ìƒ‰(ì‚¬ì—…ìë²ˆí˜¸/ìƒí˜¸) -->
            <section class="rounded-3xl bg-white shadow-xl p-5 mb-6">
                <div class="flex flex-col lg:flex-row lg:items-center gap-3">
                    <div class="flex-1">
                        <div class="text-lg font-extrabold text-gray-900">ê°€ê²Œ ê²€ìƒ‰</div>
                        <div class="text-sm text-gray-600 mt-1">
                            ì‚¬ì—…ìë²ˆí˜¸ ë˜ëŠ” ìƒí˜¸ëª…ìœ¼ë¡œ ê²€ìƒ‰í•˜ë©´ (food + combined) ëª¨ë‘ ì¡°íšŒí•©ë‹ˆë‹¤.
                        </div>
                    </div>

                    <div class="flex flex-col sm:flex-row gap-2 w-full lg:w-auto lg:min-w-[520px]">
                        <input id="globalStoreQuery" class="input flex-1" placeholder="ì˜ˆ) 0000000003 ë˜ëŠ” ë°”ë²„ë¼ì¸" />
                        <button id="globalStoreSearchBtn" class="btn btn-blue w-full sm:w-auto"
                            type="button">ê²€ìƒ‰</button>
                    </div>
                </div>

                <div class="mt-4">
                    <div class="text-sm text-gray-600">
                        ì„ íƒëœ ê°€ê²Œ:
                        <span id="globalPickedStore" class="font-extrabold text-gray-900">ì—†ìŒ</span>
                        <span id="globalPickedBadge"
                            class="ml-2 inline-flex items-center text-xs font-extrabold px-2 py-1 rounded-full border bg-gray-50 text-gray-700 hidden"></span>
                    </div>

                    <div id="globalStoreResults"
                        class="mt-3 grid grid-cols-1 gap-2 max-h-[320px] overflow-auto pr-1 hidden">
                    </div>
                </div>
            </section>

            <div class="flex flex-wrap gap-2 items-center justify-start lg:justify-end">
                <span class="chip">
                    <span class="text-gray-500 font-bold">ê°€ê²Œê²€ìƒ‰ ëª¨ë“œ</span>
                    <select id="modeSelect" class="bg-transparent outline-none font-bold">
                        <option value="food">food</option>
                        <option value="combined">combined</option>
                    </select>
                </span>

                <a href="/ndetail.html" target="_blank" rel="noopener" class="chip hover:bg-gray-50 font-bold">ì‚¬ìš©ì
                    ndetail ë³´ê¸°</a>
            </div>
        </div>

        <!-- ì‹¤ì œ ndetail í…œí”Œë¦¿ ë ˆì´ì•„ì›ƒ ê·¸ëŒ€ë¡œ -->
        <div class="flex flex-col lg:flex-row gap-8 items-stretch">

            <!-- 1) ì™¼ìª½: ì´ë¯¸ì§€/ì§€ë„/ê´‘ê³  -->
            <section id="leftCol" class="flex-1 flex flex-col gap-6 self-stretch h-full">

                <!-- ëŒ€í‘œ ì´ë¯¸ì§€(ìŠ¬ë¼ì´ë”) ìŠ¬ë¡¯ -->
                <div id="slot_images"
                    class="rounded-3xl bg-white shadow-xl p-6 flex flex-col items-center overflow-hidden flex-shrink-0 slot-hover"
                    data-section="images">
                    <div class="w-full flex items-center justify-between mb-2">
                        <div class="text-lg font-extrabold">ëŒ€í‘œ ì´ë¯¸ì§€(ìŠ¬ë¼ì´ë”)</div>
                        <span class="slot-badge" data-badge>ë¯¸ì„¤ì •</span>
                    </div>

                    <!-- í‘œì‹œ ì˜ì—­ -->
                    <div class="w-full h-80 rounded-2xl overflow-hidden bg-gray-50 border border-gray-200 flex items-center justify-center"
                        data-body>
                        <div class="text-gray-400 font-bold">ì´ë¯¸ì§€ ìŠ¬ë¡¯(í´ë¦­í•´ì„œ ì„¤ì •)</div>
                    </div>

                    <div class="text-center font-bold mt-3 text-gray-700">ëŒ€í‘œ ì´ë¯¸ì§€</div>
                </div>

                <!-- ì§€ë„ ìŠ¬ë¡¯ -->
                <div id="slot_map" class="rounded-3xl bg-white shadow-xl p-6 overflow-hidden flex-shrink-0 slot-hover"
                    data-section="map">
                    <div class="w-full flex items-center justify-between mb-2">
                        <div class="text-lg font-extrabold">ìœ„ì¹˜/ì§€ë„</div>
                        <span class="slot-badge" data-badge>ë¯¸ì„¤ì •</span>
                    </div>

                    <div class="text-sm text-gray-600 mb-2" data-subtitle>
                        ì£¼ì†Œ/ì¢Œí‘œ/ë§í¬ ë“±ì„ í…ìŠ¤íŠ¸ë¡œ ë„£ê±°ë‚˜, ê°€ê²Œ ì—°ê²°ì„ ì‚¬ìš©
                    </div>

                    <div class="w-full h-[244px] rounded-xl overflow-hidden bg-gray-50 border border-gray-200 flex items-center justify-center"
                        data-body>
                        <div class="text-gray-400 font-bold">ì§€ë„ ì˜ì—­(í´ë¦­í•´ì„œ ì„¤ì •)</div>
                    </div>
                </div>

                <!-- ê´‘ê³  1 -->
                <div id="slot_ad1" class="rounded-3xl bg-white shadow-xl p-3 overflow-hidden flex-shrink-0 slot-hover"
                    data-section="ad1">
                    <div class="w-full flex items-center justify-between px-3 pt-2 pb-2">
                        <div class="text-lg font-extrabold">ê´‘ê³  1</div>
                        <span class="slot-badge" data-badge>ë¯¸ì„¤ì •</span>
                    </div>

                    <div class="rounded-xl w-full h-60 bg-gray-50 border border-gray-200 flex items-center justify-center"
                        data-body>
                        <div class="text-gray-400 font-bold">ê´‘ê³  ì´ë¯¸ì§€/í…ìŠ¤íŠ¸(í´ë¦­í•´ì„œ ì„¤ì •)</div>
                    </div>
                </div>

                <!-- ê´‘ê³  2 -->
                <div id="slot_ad2" class="rounded-3xl bg-white shadow-xl p-3 overflow-hidden flex-shrink-0 slot-hover"
                    data-section="ad2">
                    <div class="w-full flex items-center justify-between px-3 pt-2 pb-2">
                        <div class="text-lg font-extrabold">ê´‘ê³  2</div>
                        <span class="slot-badge" data-badge>ë¯¸ì„¤ì •</span>
                    </div>

                    <div class="rounded-xl w-full h-60 bg-gray-50 border border-gray-200 flex items-center justify-center"
                        data-body>
                        <div class="text-gray-400 font-bold">ê´‘ê³  ì´ë¯¸ì§€/í…ìŠ¤íŠ¸(í´ë¦­í•´ì„œ ì„¤ì •)</div>
                    </div>
                </div>

            </section>

            <!-- 2) ê°€ìš´ë°: ìƒì„¸ì •ë³´ -->
            <section id="middleCol" class="flex-[1.1] flex flex-col gap-6">

                <!-- ìƒí˜¸/ì˜ˆì•½ -->
                <div id="slot_header"
                    class="rounded-3xl bg-white shadow-xl p-6 overflow-hidden flex-shrink-0 slot-hover"
                    data-section="header">
                    <div class="flex items-center justify-between mb-2">
                        <div class="text-lg font-extrabold">ìƒí˜¸/ìƒë‹¨ì˜ì—­</div>
                        <span class="slot-badge" data-badge>ë¯¸ì„¤ì •</span>
                    </div>

                    <div class="text-3xl font-bold text-center mb-2" data-title>ìƒí˜¸ëª…</div>
                    <div class="flex justify-center mt-2">
                        <button class="bg-blue-500 text-white px-5 py-2 rounded-lg shadow hover:bg-blue-700 transition"
                            type="button" disabled>ì˜ˆì•½ ì‹ ì²­</button>
                    </div>

                    <div class="mt-3 rounded-xl border border-gray-200 bg-gray-50 p-3 text-sm text-gray-600" data-body>
                        ìƒë‹¨ í…ìŠ¤íŠ¸/ì´ë¯¸ì§€ ë˜ëŠ” ê°€ê²Œ ì—°ê²°ë¡œ í‘œì‹œ
                    </div>
                </div>

                <!-- ê¸°ë³¸ ì •ë³´ -->
                <div id="slot_basic" class="rounded-3xl bg-white shadow-xl p-6 overflow-hidden flex-shrink-0 slot-hover"
                    data-section="basic">
                    <div class="flex items-center justify-between mb-2">
                        <div class="text-lg font-extrabold">ê¸°ë³¸ ì •ë³´</div>
                        <span class="slot-badge" data-badge>ë¯¸ì„¤ì •</span>
                    </div>

                    <div class="divider mb-3"></div>

                    <dl class="grid grid-cols-2 gap-x-3 gap-y-1 text-xl" data-body>
                        <dt class="font-bold text-gray-700">ì—… ì¢…</dt>
                        <dd class="font-bold text-gray-900 slot-muted">-</dd>

                        <dt class="font-bold text-gray-700">ì¹´í…Œê³ ë¦¬</dt>
                        <dd class="font-bold text-gray-900 slot-muted">-</dd>

                        <dt class="font-bold text-gray-700">ë°° ë‹¬</dt>
                        <dd class="font-bold text-gray-900 slot-muted">-</dd>

                        <dt class="font-bold text-gray-700">ì˜ì—…ì‹œê°„</dt>
                        <dd class="font-bold text-gray-900 slot-muted">-</dd>
                    </dl>
                </div>

                <!-- ì„œë¹„ìŠ¤ ë‚´ìš© -->
                <div id="slot_service"
                    class="rounded-2xl bg-blue-50 shadow p-6 flex flex-col h-48 overflow-hidden slot-hover"
                    data-section="service">
                    <div class="flex items-center justify-between mb-2">
                        <div class="text-lg font-extrabold">ì„œë¹„ìŠ¤ ë‚´ìš©</div>
                        <span class="slot-badge" data-badge>ë¯¸ì„¤ì •</span>
                    </div>

                    <div class="divider mb-2"></div>

                    <div class="flex-1 overflow-auto text-lg text-gray-700" data-body>
                        <div class="slot-muted">-</div>
                    </div>

                    <div class="text-right mt-2">
                        <button class="px-3 py-1 bg-blue-600 text-white rounded text-sm" type="button" disabled>ìì„¸íˆ
                            ë³´ê¸°</button>
                    </div>
                </div>

                <!-- ì´ë²¤íŠ¸ -->
                <div id="slot_events"
                    class="rounded-2xl bg-yellow-50 shadow p-6 overflow-hidden flex-shrink-0 slot-hover"
                    data-section="events">
                    <div class="flex items-center justify-between mb-2">
                        <div class="text-lg font-extrabold">ì´ë²¤íŠ¸</div>
                        <span class="slot-badge" data-badge>ë¯¸ì„¤ì •</span>
                    </div>

                    <div class="divider mb-2"></div>

                    <ul class="list-disc ml-5 text-lg text-gray-700" data-body>
                        <li class="slot-muted">-</li>
                    </ul>
                </div>

                <!-- ê¸°íƒ€ ì •ë³´ -->
                <div id="slot_etc" class="rounded-2xl bg-gray-50 shadow p-6 overflow-hidden flex-shrink-0 slot-hover"
                    data-section="etc">
                    <div class="flex items-center justify-between mb-2">
                        <div class="text-lg font-extrabold">ê¸°íƒ€ ì •ë³´</div>
                        <span class="slot-badge" data-badge>ë¯¸ì„¤ì •</span>
                    </div>

                    <div class="divider mb-2"></div>

                    <ul class="list-disc pl-5 text-lg text-gray-700" data-body>
                        <li class="slot-muted">-</li>
                    </ul>
                </div>

                <!-- ì¶”ê°€ ì„¤ëª… -->
                <div id="slot_additional"
                    class="rounded-2xl bg-blue-50 shadow p-6 flex flex-col h-48 overflow-hidden slot-hover"
                    data-section="additional">
                    <div class="flex items-center justify-between mb-2">
                        <div class="text-lg font-extrabold">ì¶”ê°€ ì„¤ëª…</div>
                        <span class="slot-badge" data-badge>ë¯¸ì„¤ì •</span>
                    </div>

                    <div class="divider mb-2"></div>

                    <div class="flex-1 overflow-auto text-lg text-gray-700" data-body>
                        <div class="slot-muted">-</div>
                    </div>

                    <div class="text-right mt-2">
                        <button class="px-3 py-1 bg-blue-600 text-white rounded text-sm" type="button" disabled>ìì„¸íˆ
                            ë³´ê¸°</button>
                    </div>
                </div>

                <!-- ì—°ë½ì²˜ -->
                <div id="slot_contact"
                    class="rounded-2xl bg-gray-50 shadow p-6 lg:pb-10 overflow-hidden flex-shrink-0 slot-hover"
                    data-section="contact">
                    <div class="flex items-center justify-between mb-2">
                        <div class="text-lg font-extrabold">ì—°ë½ì²˜</div>
                        <span class="slot-badge" data-badge>ë¯¸ì„¤ì •</span>
                    </div>

                    <div class="divider mb-2"></div>

                    <div class="grid grid-cols-2 gap-3 text-lg" data-body>
                        <div class="col-span-2 text-center slot-muted">-</div>
                    </div>
                </div>

            </section>

            <!-- 3) ì˜¤ë¥¸ìª½: ë©”ë‰´/ì¥ë°”êµ¬ë‹ˆ -->
            <section id="rightCol" class="flex-[1.3] flex flex-col gap-6 min-h-0">

                <!-- ë©”ë‰´ -->
                <div id="slot_menu"
                    class="rounded-3xl bg-white shadow-xl p-6 overflow-hidden flex flex-col min-h-0 flex-1 slot-hover"
                    data-section="menu">
                    <div class="flex items-center justify-between mb-3">
                        <div class="text-lg font-extrabold">ë©”ë‰´</div>
                        <span class="slot-badge" data-badge>ë¯¸ì„¤ì •</span>
                    </div>

                    <div class="divider mb-3"></div>

                    <div class="menu-list flex-1 flex flex-col gap-3 overflow-y-auto pr-1" data-body>
                        <div class="text-center text-gray-500 py-4">ë©”ë‰´ í‘œì‹œ ì˜ì—­</div>
                    </div>
                </div>

                <!-- ì¥ë°”êµ¬ë‹ˆ/ê²°ì œ -->
                <div id="slot_cart" class="rounded-2xl bg-yellow-50 shadow p-6 overflow-hidden flex-shrink-0 slot-hover"
                    data-section="cart">
                    <div class="flex items-center justify-between mb-2">
                        <div class="text-lg font-extrabold">ì¥ë°”êµ¬ë‹ˆ/ê²°ì œì°½</div>
                        <span class="slot-badge" data-badge>ë¯¸ì„¤ì •</span>
                    </div>

                    <div class="divider mb-3"></div>

                    <div class="text-gray-700" data-body>
                        <div class="flex justify-between items-center">
                            <span class="font-bold text-gray-800">í•©ê³„:</span>
                            <span class="text-2xl font-bold text-blue-700">0ì›</span>
                        </div>
                        <button class="mt-3 w-full bg-blue-600 text-white py-2 rounded-lg shadow" type="button"
                            disabled>ê²°ì œí•˜ê¸°</button>
                    </div>
                </div>

            </section>

        </div>
    </main>

    <div id="footer-placeholder"></div>

    <!-- =========================
       ì„¤ì • ëª¨ë‹¬
    ========================== -->
    <div id="modal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50 p-4">
        <div class="bg-white w-full max-w-3xl rounded-2xl shadow-2xl overflow-hidden">
            <!-- í—¤ë” -->
            <div class="px-6 py-4 border-b flex items-center justify-between">
                <div>
                    <div id="modalTitle" class="text-xl font-extrabold">ìŠ¬ë¡¯ ì„¤ì •</div>
                    <div class="text-sm text-gray-600 mt-1">
                        position: <span id="modalPosition" class="font-mono text-gray-900"></span>
                    </div>
                </div>
                <button id="modalClose"
                    class="w-10 h-10 rounded-full bg-gray-100 hover:bg-gray-200 text-xl leading-none"
                    type="button">Ã—</button>
            </div>

            <!-- ë³¸ë¬¸ -->
            <div class="p-6 space-y-5 max-h-[72vh] overflow-auto">
                <!-- íƒ€ì…/ëª¨ë“œ -->
                <div class="flex flex-wrap gap-2">
                    <button id="tabImage" type="button" class="btn btn-gray">ì´ë¯¸ì§€</button>
                    <button id="tabStore" type="button" class="btn btn-gray">ê°€ê²Œì—°ê²°</button>
                    <button id="tabText" type="button" class="btn btn-gray">í…ìŠ¤íŠ¸</button>
                </div>

                <!-- selectëŠ” ìˆ¨ê¹€(ê¸°ì¡´ ë°±ì—”ë“œ êµ¬ì¡° ì—°ë™ìš©) -->
                <div class="hidden">
                    <select id="slotType">
                        <option value="image">image</option>
                        <option value="text">text</option>
                    </select>
                    <select id="slotMode">
                        <option value="custom">custom</option>
                        <option value="store">store</option>
                    </select>
                </div>

                <!-- ì´ë¯¸ì§€ ì—…ë¡œë“œ -->
                <div id="imageBox">
                    <div class="font-bold text-gray-800 mb-2">ì´ë¯¸ì§€ ì—…ë¡œë“œ</div>
                    <input id="imageFile" type="file" accept="image/*" class="input" />
                    <div class="text-sm text-gray-500 mt-2">ì—…ë¡œë“œí•˜ë©´ ê¸°ì¡´ ì´ë¯¸ì§€ëŠ” êµì²´ë©ë‹ˆë‹¤.</div>

                    <div class="mt-3">
                        <div class="font-bold text-gray-800 mb-2">í˜„ì¬ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°</div>
                        <div id="imagePreview"
                            class="w-full h-52 rounded-xl border bg-gray-50 flex items-center justify-center overflow-hidden">
                            <span class="text-gray-400 font-bold">ì—†ìŒ</span>
                        </div>
                    </div>
                </div>

                <!-- í…ìŠ¤íŠ¸ -->
                <div id="textBox">
                    <div class="font-bold text-gray-800 mb-2">í…ìŠ¤íŠ¸</div>
                    <textarea id="textValue" rows="5" class="input" placeholder="í‘œì‹œí•  í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥"></textarea>
                </div>

                <!-- ë§í¬ -->
                <div>
                    <div class="font-bold text-gray-800 mb-2">ë§í¬ URL (ì„ íƒ)</div>
                    <input id="linkUrl" class="input" placeholder="https://..." />
                    <div class="text-sm text-gray-500 mt-2">
                        í…ìŠ¤íŠ¸/ì´ë¯¸ì§€ í´ë¦­ ì‹œ ì´ë™í•  ë§í¬. (store ëª¨ë“œë©´ store_id ê¸°ë°˜ ë§í¬ë„ ê°€ëŠ¥)
                    </div>
                </div>

                <!-- ê°€ê²Œ ì—°ê²° -->
                <div id="storeBox" class="rounded-xl border p-4 bg-gray-50">
                    <div class="flex items-center justify-between gap-2">
                        <div class="font-extrabold text-gray-900">ê°€ê²Œ ì—°ê²°</div>
                        <div class="text-sm text-gray-600">ê²€ìƒ‰ ëª¨ë“œ: <span id="modeNow" class="font-bold"></span></div>
                    </div>

                    <div class="mt-3 grid grid-cols-1 md:grid-cols-3 gap-2">
                        <input id="storeQuery" class="input md:col-span-2" placeholder="ì‚¬ì—…ìë²ˆí˜¸ ë˜ëŠ” ìƒí˜¸ëª… ì…ë ¥" />
                        <button id="storeSearchBtn" class="btn btn-blue w-full" type="button">ê²€ìƒ‰</button>
                    </div>

                    <div class="mt-3 text-sm text-gray-600">
                        ì„ íƒëœ ê°€ê²Œ:
                        <span id="pickedStore" class="font-bold text-gray-900">ì—†ìŒ</span>
                    </div>

                    <!-- ê°€ê²Œ ë¯¸ë¦¬ë³´ê¸° -->
                    <div id="pickedStorePreview" class="mt-3 rounded-xl border bg-white p-3 hidden"></div>

                    <div id="storeResults" class="mt-3 grid grid-cols-1 gap-2"></div>
                </div>

                <!-- ë©”ë‰´ ë¯¸ë¦¬ë³´ê¸° (menu ì„¹ì…˜ì¼ ë•Œë§Œ) -->
                <div id="menuPreviewBox" class="rounded-xl border p-4 bg-blue-50" style="display:none;">
                    <div class="font-extrabold text-gray-900 mb-3">ğŸ“‹ ë©”ë‰´ ë¯¸ë¦¬ë³´ê¸°</div>
                    <div id="menuPreviewContent" class="space-y-2 max-h-80 overflow-y-auto"></div>
                </div>

                <!-- ê¸°ê°„/ìš°ì„ ìˆœìœ„ -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <div>
                        <div class="font-bold text-gray-800 mb-2">ì‹œì‘ì¼ (ì„ íƒ)</div>
                        <input id="startDate" type="date" class="input" />
                    </div>
                    <div>
                        <div class="font-bold text-gray-800 mb-2">ì¢…ë£Œì¼ (ì„ íƒ)</div>
                        <input id="endDate" type="date" class="input" />
                    </div>
                    <div>
                        <div class="font-bold text-gray-800 mb-2">ìš°ì„ ìˆœìœ„</div>
                        <input id="priority" type="number" min="1" value="1" class="input" />
                    </div>
                </div>

                <div class="flex items-center gap-2">
                    <input id="noEnd" type="checkbox" class="w-5 h-5" />
                    <label for="noEnd" class="font-bold text-gray-800">ì¢…ë£Œ ì—†ìŒ(no_end)</label>
                </div>

                <div id="saveMsg" class="text-sm font-bold"></div>
            </div>

            <!-- í•˜ë‹¨ ë²„íŠ¼ -->
            <div class="px-6 py-4 border-t flex flex-col md:flex-row gap-2 justify-between">
                <button id="deleteBtn" class="btn btn-red hidden" type="button">ì‚­ì œ</button>
                <div class="flex gap-2 justify-end w-full md:w-auto">
                    <button id="cancelBtn" class="btn btn-gray" type="button">ë‹«ê¸°</button>
                    <button id="saveBtn" class="btn btn-blue" type="button">ì €ì¥</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // =========================
        // í—¤ë”/í‘¸í„° ë™ì  í¬í•¨
        // =========================
        async function loadPartial(targetId, url) {
            const el = document.getElementById(targetId);
            if (!el) return;
            try {
                const res = await fetch(url + `?v=${Date.now()}`, { cache: "no-cache" });
                el.innerHTML = await res.text();
                el.querySelectorAll("script").forEach(old => {
                    const s = document.createElement("script");
                    [...old.attributes].forEach(a => s.setAttribute(a.name, a.value));
                    s.textContent = old.textContent || "";
                    old.replaceWith(s);
                });
            } catch (e) {
                console.warn("partial load failed:", url, e);
            }
        }

        await loadPartial("header-placeholder", "/components/header.html");
        await loadPartial("footer-placeholder", "/components/footer.html");
        document.getElementById("header-placeholder")?.style.setProperty("display", "contents");
        document.getElementById("footer-placeholder")?.style.setProperty("display", "contents");

        // =========================
        // ìƒíƒœ & í—¬í¼
        // =========================
        const state = {
            mode: "food",          // ìƒë‹¨ ë“œë¡­ë‹¤ìš´ (food / combined)
            globalPicked: null,    // ìƒë‹¨ì—ì„œ ì„ íƒëœ ê°€ê²Œ
            modal: {
                section: "",
                position: "",
                slot: null,
                pickedStore: null,
            },
        };

        const $ = (id) => document.getElementById(id);

        function escapeHtml(s = "") {
            s = String(s ?? "");
            return s.replace(/[&<>\"']/g, (m) => ({
                "&": "&amp;",
                "<": "&lt;",
                ">": "&gt;",
                '"': "&quot;",
                "'": "&#39;",
            }[m]));
        }

        function normalizeSrc(src) {
            if (!src) return "";
            if (src.startsWith("http") || src.startsWith("/")) return src;
            return `/uploads/${src}`;
        }

        function buildPosition(section) {
            return `ndetail|${section}`;
        }

        function setBadge(el, slot) {
            const badge = el.querySelector("[data-badge]");
            if (!badge) return;
            if (!slot) {
                badge.textContent = "ë¯¸ì„¤ì •";
                badge.classList.remove("bg-emerald-50", "text-emerald-700", "border-emerald-200");
                return;
            }
            badge.textContent = slot.slot_type === "image" ? "ì´ë¯¸ì§€" : "í…ìŠ¤íŠ¸";
        }

        // =========================
        // ìŠ¬ë¡¯ ë Œë”
        // =========================
        function renderSlot(el, slot) {
            const body = el.querySelector("[data-body]");
            if (!body) return;

            // ë°°ì§€ ì²˜ë¦¬
            setBadge(el, slot);

            // ìŠ¬ë¡¯ ì—†ìœ¼ë©´ ê¸°ë³¸ ë¬¸êµ¬ ìœ ì§€
            if (!slot) return;

            const type = String(slot.slot_type || "").toLowerCase();
            const mode = String(slot.slot_mode || "").toLowerCase();
            const linkUrl = slot.link_url ? String(slot.link_url) : "";

            const storeLabel = mode === "store"
                ? `<div class="mt-2 text-sm text-gray-600">
           <span class="font-bold text-gray-800">ê°€ê²Œ ì—°ê²°:</span>
           <span class="font-bold text-gray-900">
             ${escapeHtml(slot.business_name || slot.business_no || slot.store_id || "")}
           </span>
         </div>`
                : "";

            if (type === "image") {
                const img = normalizeSrc(slot.image_url || "");
                body.innerHTML = img
                    ? `
          <a href="${escapeHtml(linkUrl || "#")}" ${linkUrl ? `target="_blank" rel="noopener"` : ""} class="block w-full h-full">
            <img src="${escapeHtml(img)}" class="w-full h-full object-cover" alt="slot image" />
          </a>
          ${storeLabel}
        `
                    : `
          <div class="w-full h-full flex items-center justify-center text-gray-400 font-bold">
            ì´ë¯¸ì§€ ì—†ìŒ${mode === "store" ? " (ê°€ê²Œ ì—°ê²°)" : ""}
          </div>
          ${storeLabel}
        `;
                return;
            }

            // í…ìŠ¤íŠ¸ ìŠ¬ë¡¯
            const text = (slot.text_content || "").trim();
            body.innerHTML = `
      ${text
                    ? `<div class="text-gray-800 text-base leading-relaxed whitespace-pre-wrap">${escapeHtml(text)}</div>`
                    : `<div class="slot-muted">í…ìŠ¤íŠ¸ ì—†ìŒ${mode === "store" ? " (ê°€ê²Œ ì—°ê²°)" : ""}</div>`
                }
      ${linkUrl
                    ? `<div class="mt-2 text-sm">
             <a class="text-blue-700 font-bold hover:underline" href="${escapeHtml(linkUrl)}" target="_blank" rel="noopener">ë§í¬ ì—´ê¸°</a>
           </div>`
                    : ""
                }
      ${storeLabel}
    `;
        }

        async function fetchSlot(position) {
            try {
                const res = await fetch(
                    `/ndetailmanager/ad/slot?position=${encodeURIComponent(position)}`,
                    { cache: "no-store" }
                );
                if (!res.ok) return null;
                const json = await res.json().catch(() => null);
                return json?.slot || null;
            } catch (e) {
                console.error("[fetchSlot] error", e);
                return null;
            }
        }

        async function loadSection(section) {
            const position = buildPosition(section);
            const el = document.querySelector(`[data-section="${section}"]`);
            if (!el) return;

            const slot = await fetchSlot(position);

            // ë©”ë‰´ëŠ” ë³„ë„ ì²˜ë¦¬
            if (section === "menu") {
                const body = el.querySelector("[data-body]");
                if (!body) return;

                if (slot && String(slot.slot_mode || "").toLowerCase() === "store" && slot.store_id) {
                    await renderMenuFromSlot(slot);
                } else if (state.globalPicked) {
                    await renderMenuFromStore(state.globalPicked);
                } else {
                    body.innerHTML = `<div class="text-center text-gray-500 py-4">ë©”ë‰´ í‘œì‹œ ì˜ì—­</div>`;
                }
                setBadge(el, slot);
                return;
            }

            renderSlot(el, slot);
        }

        async function loadAll() {
            const sections = [
                "images", "map", "ad1", "ad2",
                "header", "basic", "service", "events", "etc",
                "additional", "contact", "menu", "cart",
            ];
            for (const s of sections) {
                await loadSection(s);
            }
        }

        // =========================
        // ë©”ë‰´ ë Œë”ë§
        // =========================
        async function callDetailApi(storeId, type) {
            const candidates = [
                `/store/${encodeURIComponent(storeId)}/full?type=${encodeURIComponent(type)}`,
                `/store/${encodeURIComponent(storeId)}/full`,
            ];
            for (const url of candidates) {
                try {
                    const res = await fetch(url, { cache: "no-store" });
                    if (!res.ok) continue;
                    const json = await res.json().catch(() => null);
                    if (json) return json;
                } catch {
                    // ignore
                }
            }
            return null;
        }

        function extractMenus(json) {
            if (!json) return [];
            if (Array.isArray(json.menus)) return json.menus;
            if (Array.isArray(json.menu)) return json.menu;
            if (Array.isArray(json.items)) return json.items;
            return [];
        }

        function renderMenuListTo(body, menus, small = false) {
            if (!menus.length) {
                body.innerHTML = `<div class="text-center text-gray-500 py-4">ë“±ë¡ëœ ë©”ë‰´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
                return;
            }

            body.innerHTML = menus
                .map((m) => {
                    const name = m.menu_name || m.name || m.title || "-";
                    const price = m.menu_price ?? m.price ?? "";
                    const priceText =
                        price === "" || price == null ? "" : `${Number(price).toLocaleString()}ì›`;
                    const img = normalizeSrc(m.image_url || m.menu_image_url || m.image || "");

                    if (small) {
                        return `
            <div class="rounded-xl border bg-white p-3 flex items-center gap-3">
              <div class="w-12 h-12 rounded-lg bg-gray-100 overflow-hidden flex items-center justify-center">
                ${img
                                ? `<img src="${escapeHtml(img)}" class="w-full h-full object-cover" />`
                                : `<span class="text-xs text-gray-400 font-bold">NO IMG</span>`
                            }
              </div>
              <div class="min-w-0 flex-1">
                <div class="font-bold text-gray-900 truncate text-sm">${escapeHtml(name)}</div>
                <div class="text-xs font-bold text-blue-700">${escapeHtml(priceText)}</div>
              </div>
            </div>
          `;
                    }

                    return `
          <div class="rounded-xl border bg-white p-3 flex items-center gap-3">
            <div class="w-16 h-16 rounded-lg bg-gray-100 overflow-hidden flex items-center justify-center">
              ${img
                            ? `<img src="${escapeHtml(img)}" class="w-full h-full object-cover" />`
                            : `<span class="text-xs text-gray-400 font-bold">NO IMG</span>`
                        }
            </div>
            <div class="min-w-0 flex-1">
              <div class="font-extrabold text-gray-900 truncate">${escapeHtml(name)}</div>
              <div class="text-sm font-bold text-blue-700">${escapeHtml(priceText)}</div>
            </div>
          </div>
        `;
                })
                .join("");
        }

        async function renderMenuFromStore(r) {
            const menuEl = document.querySelector('[data-section="menu"]');
            if (!menuEl) return;
            const body = menuEl.querySelector("[data-body]");
            if (!body) return;

            body.innerHTML = `<div class="text-center text-gray-500 py-4">ë©”ë‰´ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>`;

            const type = r.__mode === "combined" ? "combined" : "food";
            const json = await callDetailApi(r.id, type);
            const menus = extractMenus(json);

            renderMenuListTo(body, menus, false);

            const badge = menuEl.querySelector("[data-badge]");
            if (badge) badge.textContent = "ê°€ê²Œì—°ê²°";
        }

        async function renderMenuFromSlot(slot) {
            const menuEl = document.querySelector('[data-section="menu"]');
            if (!menuEl) return;
            const body = menuEl.querySelector("[data-body]");
            if (!body) return;

            body.innerHTML = `<div class="text-center text-gray-500 py-4">ë©”ë‰´ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>`;

            const type =
                slot.table_source === "combined_store_info" || slot.store_type === "combined"
                    ? "combined"
                    : "food";

            const json = await callDetailApi(slot.store_id, type);
            const menus = extractMenus(json);

            renderMenuListTo(body, menus, false);

            const badge = menuEl.querySelector("[data-badge]");
            if (badge) badge.textContent = "ê°€ê²Œì—°ê²°";
        }

        async function renderMenuInModal(r) {
            const box = $("menuPreviewBox");
            const content = $("menuPreviewContent");
            if (!box || !content) return;

            box.style.display = "block";
            content.innerHTML = `<div class="text-center text-gray-500 py-4">ë©”ë‰´ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>`;

            const type = r.__mode === "combined" ? "combined" : "food";
            const json = await callDetailApi(r.id, type);
            const menus = extractMenus(json);

            renderMenuListTo(content, menus, true);
        }

        // =========================
        // ì „ì—­ ì„ íƒ ê°€ê²Œ â†’ í˜ì´ì§€ ë°˜ì˜
        // =========================
        function applyPickedStoreToPage(r) {
            if (!r) return;

            const name = r.business_name || "-";
            const bn = r.business_number || "-";
            const type = r.business_type || "-";
            const cat = r.business_category || "-";
            const img = normalizeSrc(r.image_url || "");

            // ëŒ€í‘œ ì´ë¯¸ì§€
            const imgEl = document.querySelector('[data-section="images"]');
            if (imgEl) {
                const body = imgEl.querySelector("[data-body]");
                if (body) {
                    body.innerHTML = img
                        ? `<img src="${escapeHtml(img)}" class="w-full h-full object-cover" />`
                        : `<div class="text-gray-400 font-bold">NO IMG</div>`;
                }
                const badge = imgEl.querySelector("[data-badge]");
                if (badge) badge.textContent = "ê°€ê²Œì—°ê²°";
            }

            // ìƒë‹¨ í—¤ë”
            const headerEl = document.querySelector('[data-section="header"]');
            if (headerEl) {
                const title = headerEl.querySelector("[data-title]");
                if (title) title.textContent = name;

                const body = headerEl.querySelector("[data-body]");
                if (body) {
                    body.innerHTML = `
          <div class="text-sm text-gray-700">
            <div><b>ì‚¬ì—…ì</b>: ${escapeHtml(bn)}</div>
            <div><b>ì—…ì¢…/ì¹´í…Œê³ ë¦¬</b>: ${escapeHtml(type)} / ${escapeHtml(cat)}</div>
            <div class="mt-2 text-xs text-gray-500">
              â€» ì´ í™”ë©´ì€ â€œì „ì—­ ì„ íƒ ë¯¸ë¦¬ë³´ê¸°â€ì´ë©°, ê° ë°•ìŠ¤ë¥¼ í´ë¦­í•´ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </div>
          </div>
        `;
                }
                const badge = headerEl.querySelector("[data-badge]");
                if (badge) badge.textContent = "ê°€ê²Œì—°ê²°";
            }

            // ê¸°ë³¸ ì •ë³´
            const basicEl = document.querySelector('[data-section="basic"]');
            if (basicEl) {
                const dds = basicEl.querySelectorAll("dd");
                if (dds?.length >= 4) {
                    dds[0].textContent = type;
                    dds[1].textContent = cat;
                    dds[2].textContent = "-";
                    dds[3].textContent = "-";
                    dds.forEach((dd) => dd.classList.remove("slot-muted"));
                }
                const badge = basicEl.querySelector("[data-badge]");
                if (badge) badge.textContent = "ê°€ê²Œì—°ê²°";
            }

            // ê¸°íƒ€ ì˜ì—­ë“¤ â€œê°€ê²Œ ì—°ê²°ë¨â€ í‘œì‹œ
            const sections = [
                "map",
                "ad1",
                "ad2",
                "service",
                "events",
                "etc",
                "additional",
                "contact",
                "cart",
            ];
            for (const sec of sections) {
                const el = document.querySelector(`[data-section="${sec}"]`);
                if (!el) continue;
                const body = el.querySelector("[data-body]");
                if (body) {
                    body.innerHTML = `
          <div class="text-gray-700">
            <div class="font-bold">ê°€ê²Œ ì—°ê²°ë¨</div>
            <div class="text-sm text-gray-600 mt-1">${escapeHtml(name)} (${escapeHtml(
                        bn
                    )})</div>
            <div class="text-sm text-gray-600">${escapeHtml(type)} / ${escapeHtml(
                        cat
                    )}</div>
          </div>
        `;
                }
                const badge = el.querySelector("[data-badge]");
                if (badge) badge.textContent = "ê°€ê²Œì—°ê²°";
            }

            // ë©”ë‰´ë„ ê°™ì´ ê°±ì‹ 
            renderMenuFromStore(r);
        }

        // =========================
        // ëª¨ë‹¬ ê´€ë ¨
        // =========================
        function toggleBoxes() {
            const type = $("slotType").value;
            const mode = $("slotMode").value;

            $("imageBox").style.display = type === "image" ? "block" : "none";
            $("textBox").style.display = type === "text" ? "block" : "none";
            $("storeBox").style.display = mode === "store" ? "block" : "none";

            $("endDate").disabled = $("noEnd").checked;
            if ($("noEnd").checked) $("endDate").value = "";
        }

        function setActiveTab(kind) {
            const btns = [
                ["tabImage", "image"],
                ["tabStore", "store"],
                ["tabText", "text"],
            ];
            btns.forEach(([id, k]) => {
                const b = $(id);
                if (!b) return;
                if (k === kind) {
                    b.classList.remove("btn-gray");
                    b.classList.add("btn-blue");
                } else {
                    b.classList.remove("btn-blue");
                    b.classList.add("btn-gray");
                }
            });

            if (kind === "store") {
                $("slotMode").value = "store";
                const sec = state.modal.section;
                const defaultType =
                    sec === "ad1" || sec === "ad2" || sec === "images" ? "image" : "text";
                if (!$("slotType").value) $("slotType").value = defaultType;
            } else if (kind === "image") {
                $("slotType").value = "image";
                $("slotMode").value = "custom";
            } else {
                $("slotType").value = "text";
                $("slotMode").value = "custom";
            }

            toggleBoxes();
        }

        function renderPickedStorePreview(r) {
            const box = $("pickedStorePreview");
            if (!box) return;

            if (!r) {
                box.classList.add("hidden");
                box.innerHTML = "";
                return;
            }

            const img = normalizeSrc(r.image_url || "");
            const name = r.business_name || "-";
            const bn = r.business_number || "-";
            const type = r.business_type || "-";
            const cat = r.business_category || "-";

            box.classList.remove("hidden");
            box.innerHTML = `
      <div class="flex gap-3 items-center">
        <div class="w-20 h-20 rounded-lg bg-gray-100 overflow-hidden flex items-center justify-center">
          ${img
                    ? `<img src="${escapeHtml(img)}" class="w-full h-full object-cover" />`
                    : `<span class="text-xs text-gray-400 font-bold">NO IMG</span>`
                }
        </div>
        <div class="min-w-0 flex-1">
          <div class="font-extrabold text-gray-900 truncate">${escapeHtml(name)}</div>
          <div class="text-sm text-gray-600">ì‚¬ì—…ì: ${escapeHtml(bn)}</div>
          <div class="text-sm text-gray-600">ì—…ì¢…/ì¹´í…Œê³ ë¦¬: ${escapeHtml(
                    type
                )} / ${escapeHtml(cat)}</div>
        </div>
      </div>
    `;
        }

        async function openModal(section) {
            state.modal.section = section;
            state.modal.position = buildPosition(section);
            state.modal.slot = null;
            state.modal.pickedStore = null;

            $("modalTitle").textContent = `ìŠ¬ë¡¯ ì„¤ì •: ${section}`;
            $("modalPosition").textContent = state.modal.position;
            $("saveMsg").textContent = "";
            $("saveMsg").className = "text-sm font-bold";

            $("imageFile").value = "";
            $("textValue").value = "";
            $("linkUrl").value = "";
            $("startDate").value = "";
            $("endDate").value = "";
            $("noEnd").checked = false;
            $("priority").value = "1";
            $("pickedStore").textContent = "ì—†ìŒ";
            $("storeResults").innerHTML = "";
            $("imagePreview").innerHTML = `<span class="text-gray-400 font-bold">ì—†ìŒ</span>`;
            $("modeNow").textContent = state.mode;

            const defaultType =
                section === "ad1" || section === "ad2" || section === "images" ? "image" : "text";
            $("slotType").value = defaultType;
            $("slotMode").value = "custom";
            setActiveTab(defaultType === "image" ? "image" : "text");

            // ì „ì—­ ì„ íƒëœ ê°€ê²Œ ìˆìœ¼ë©´ store ëª¨ë“œ ê¸°ë³¸ ì„¤ì •
            if (state.globalPicked) {
                const r = state.globalPicked;
                state.modal.pickedStore = {
                    id: r.id,
                    business_number: r.business_number,
                    business_name: r.business_name,
                };
                $("slotMode").value = "store";
                $("pickedStore").textContent = `${r.business_name || "-"} (${r.business_number || "-"
                    })`;
                setActiveTab("store");
                renderPickedStorePreview(r);
            }

            // ê¸°ì¡´ ìŠ¬ë¡¯ ë¶ˆëŸ¬ì˜¤ê¸°
            const slot = await fetchSlot(state.modal.position);
            state.modal.slot = slot;

            if (slot) {
                $("slotType").value = slot.slot_type || defaultType;
                $("slotMode").value = slot.slot_mode || "custom";

                const t = String(slot.slot_type || "").toLowerCase();
                const m = String(slot.slot_mode || "").toLowerCase();
                if (m === "store") setActiveTab("store");
                else if (t === "image") setActiveTab("image");
                else setActiveTab("text");

                $("textValue").value = slot.text_content || "";
                $("linkUrl").value = slot.link_url || "";
                $("startDate").value = slot.start_date
                    ? String(slot.start_date).slice(0, 10)
                    : "";
                $("endDate").value = slot.end_date ? String(slot.end_date).slice(0, 10) : "";
                $("noEnd").checked = !!slot.no_end;
                $("priority").value = slot.priority ?? 1;

                if (slot.image_url) {
                    const img = normalizeSrc(slot.image_url);
                    $("imagePreview").innerHTML = `<img src="${escapeHtml(
                        img
                    )}" class="w-full h-full object-cover" />`;
                }

                if (
                    slot.slot_mode === "store" &&
                    (slot.store_id || slot.business_no || slot.business_name)
                ) {
                    $("pickedStore").textContent =
                        slot.business_name || slot.business_no || slot.store_id;
                    state.modal.pickedStore = {
                        id: slot.store_id,
                        business_number: slot.business_no,
                        business_name: slot.business_name,
                    };

                    const q = (slot.business_no || slot.business_name || "").trim();
                    const mode = slot.store_type || slot.table_source || state.mode || "food";

                    if (q) {
                        try {
                            const res = await fetch(
                                `/ndetailmanager/ad/search-store?q=${encodeURIComponent(
                                    q
                                )}&mode=${encodeURIComponent(mode)}`,
                                { cache: "no-store" }
                            );
                            const js = await res.json().catch(() => null);
                            const r0 = Array.isArray(js?.results) ? js.results[0] : null;
                            if (r0) {
                                renderPickedStorePreview(r0);
                                if (section === "images" && !slot.image_url && r0.image_url) {
                                    const img = normalizeSrc(r0.image_url);
                                    $("imagePreview").innerHTML = `<img src="${escapeHtml(
                                        img
                                    )}" class="w-full h-full object-cover" />`;
                                }
                            }
                        } catch (e) {
                            console.warn("store preview enrich failed", e);
                        }
                    }
                }

                $("deleteBtn").classList.remove("hidden");
            } else {
                $("deleteBtn").classList.add("hidden");
            }

            toggleBoxes();

            if (section === "menu" && state.globalPicked) {
                await renderMenuInModal(state.globalPicked);
            }

            $("modal").classList.remove("hidden");
            $("modal").classList.add("flex");
        }

        function closeModal() {
            $("modal").classList.add("hidden");
            $("modal").classList.remove("flex");

            const box = $("menuPreviewBox");
            if (box) {
                box.style.display = "none";
                $("menuPreviewContent").innerHTML = "";
            }
        }

        async function saveSlot() {
            $("saveMsg").textContent = "";
            const fd = new FormData();

            fd.append("position", state.modal.position);
            fd.append("slot_type", $("slotType").value);
            fd.append("slot_mode", $("slotMode").value);
            fd.append("text_content", $("textValue").value || "");
            fd.append("link_url", $("linkUrl").value || "");
            fd.append("start_date", $("startDate").value || "");
            fd.append("end_date", $("endDate").value || "");
            fd.append("no_end", $("noEnd").checked ? "true" : "false");
            fd.append("priority", $("priority").value || "1");

            if ($("slotMode").value === "store" && state.modal.pickedStore) {
                if (state.modal.pickedStore.id != null) {
                    fd.append("store_id", String(state.modal.pickedStore.id));
                }
                fd.append("business_no", state.modal.pickedStore.business_number || "");
                fd.append("business_name", state.modal.pickedStore.business_name || "");
            } else {
                fd.append("store_id", "");
                fd.append("business_no", "");
                fd.append("business_name", "");
            }

            const f = $("imageFile").files?.[0];
            if (f) fd.append("image", f);

            try {
                const res = await fetch("/ndetailmanager/ad/update", {
                    method: "POST",
                    body: fd,
                });
                const json = await res.json().catch(() => null);
                if (!res.ok || !json?.success) {
                    throw new Error(json?.message || `HTTP ${res.status}`);
                }

                $("saveMsg").className = "text-sm font-bold text-emerald-700";
                $("saveMsg").textContent = "âœ… ì €ì¥ ì™„ë£Œ";

                await loadSection(state.modal.section);
                state.modal.slot = json.slot || null;
                $("deleteBtn").classList.remove("hidden");
            } catch (e) {
                console.error(e);
                $("saveMsg").className = "text-sm font-bold text-red-600";
                $("saveMsg").textContent = "âŒ ì €ì¥ ì‹¤íŒ¨: " + (e?.message || "ì˜¤ë¥˜");
            }
        }

        async function deleteSlot() {
            if (!confirm("ì •ë§ ì‚­ì œí• ê¹Œìš”?")) return;

            try {
                const res = await fetch(
                    `/ndetailmanager/ad/delete?position=${encodeURIComponent(
                        state.modal.position
                    )}`,
                    { method: "DELETE" }
                );
                const json = await res.json().catch(() => null);
                if (!res.ok || !json?.success) {
                    throw new Error(json?.message || `HTTP ${res.status}`);
                }

                $("saveMsg").className = "text-sm font-bold text-emerald-700";
                $("saveMsg").textContent = "âœ… ì‚­ì œ ì™„ë£Œ";

                await loadSection(state.modal.section);
                closeModal();
            } catch (e) {
                console.error(e);
                $("saveMsg").className = "text-sm font-bold text-red-600";
                $("saveMsg").textContent = "âŒ ì‚­ì œ ì‹¤íŒ¨: " + (e?.message || "ì˜¤ë¥˜");
            }
        }

        // =========================
        // ëª¨ë‹¬ ì•ˆ ê°€ê²Œ ê²€ìƒ‰
        // =========================
        async function searchStoreInModal() {
            const q = ($("storeQuery").value || "").trim();

            $("storeResults").innerHTML = `<div class="text-sm text-gray-500">ê²€ìƒ‰ ì¤‘...</div>`;

            try {
                const mode = state.mode;
                const res = await fetch(
                    `/ndetailmanager/ad/search-store?q=${encodeURIComponent(
                        q
                    )}&mode=${encodeURIComponent(mode)}`,
                    { cache: "no-store" }
                );
                const json = await res.json().catch(() => null);
                const results = json?.results || [];

                if (!Array.isArray(results) || results.length === 0) {
                    $("storeResults").innerHTML = `<div class="text-sm text-gray-500">ê²°ê³¼ ì—†ìŒ</div>`;
                    return;
                }

                $("storeResults").innerHTML = results
                    .map((r) => {
                        const img = normalizeSrc(r.image_url || "");
                        return `
            <button type="button"
              class="w-full text-left rounded-xl border bg-white hover:bg-gray-50 p-3 flex gap-3 items-center"
              data-pick='${escapeHtml(JSON.stringify(r))}'>
              <div class="w-16 h-16 rounded-lg bg-gray-100 overflow-hidden flex items-center justify-center">
                ${img
                                ? `<img src="${escapeHtml(
                                    img
                                )}" class="w-full h-full object-cover" />`
                                : `<span class="text-xs text-gray-400 font-bold">NO IMG</span>`
                            }
              </div>
              <div class="min-w-0 flex-1">
                <div class="font-extrabold text-gray-900 truncate">${escapeHtml(
                                r.business_name || "-"
                            )}</div>
                <div class="text-sm text-gray-600">ì‚¬ì—…ì: ${escapeHtml(
                                r.business_number || "-"
                            )}</div>
                <div class="text-sm text-gray-600">
                  ì—…ì¢…/ì¹´í…Œê³ ë¦¬: ${escapeHtml(
                                (r.business_type || "") + " / " + (r.business_category || "")
                            )}
                </div>
              </div>
              <div class="text-blue-700 font-extrabold">ì„ íƒ</div>
            </button>
          `;
                    })
                    .join("");

                $("storeResults")
                    .querySelectorAll("button[data-pick]")
                    .forEach((btn) => {
                        btn.addEventListener("click", () => {
                            const r = JSON.parse(btn.getAttribute("data-pick"));
                            state.modal.pickedStore = {
                                id: r.id,
                                business_number: r.business_number,
                                business_name: r.business_name,
                            };
                            $("pickedStore").textContent = `${r.business_name} (${r.business_number || "-"
                                })`;
                            $("saveMsg").textContent = "";
                            renderPickedStorePreview(r);
                        });
                    });
            } catch (e) {
                console.error(e);
                $("storeResults").innerHTML = `<div class="text-sm text-red-600 font-bold">ê²€ìƒ‰ ì‹¤íŒ¨</div>`;
            }
        }

        // =========================
        // ìƒë‹¨ ì „ì—­ ê°€ê²Œ ê²€ìƒ‰ (food + combined)
        // =========================
        function openGlobalResults() {
            const box = $("globalStoreResults");
            if (!box) return;
            box.classList.remove("hidden");
        }

        function closeGlobalResults() {
            const box = $("globalStoreResults");
            if (!box) return;
            box.innerHTML = "";
            box.classList.add("hidden");
        }

        async function globalSearchStore() {
            const q = ($("globalStoreQuery")?.value || "").trim();

            const resultsBox = $("globalStoreResults");
            if (!resultsBox) return;

            resultsBox.innerHTML = `<div class="text-sm text-gray-500">ê²€ìƒ‰ ì¤‘...</div>`;
            openGlobalResults();

            try {
                const [rf, rc] = await Promise.all([
                    fetch(
                        `/ndetailmanager/ad/search-store?q=${encodeURIComponent(
                            q
                        )}&mode=food`,
                        { cache: "no-store" }
                    ).then((r) => r.json()),
                    fetch(
                        `/ndetailmanager/ad/search-store?q=${encodeURIComponent(
                            q
                        )}&mode=combined`,
                        { cache: "no-store" }
                    ).then((r) => r.json()),
                ]);

                const food = Array.isArray(rf?.results)
                    ? rf.results.map((x) => ({ ...x, __mode: "food" }))
                    : [];
                const combined = Array.isArray(rc?.results)
                    ? rc.results.map((x) => ({ ...x, __mode: "combined" }))
                    : [];
                const merged = [...food, ...combined];

                if (merged.length === 0) {
                    resultsBox.innerHTML = `<div class="text-sm text-gray-500">ê²°ê³¼ ì—†ìŒ</div>`;
                    return;
                }

                resultsBox.innerHTML = merged
                    .map((r) => {
                        const img = normalizeSrc(r.image_url || "");
                        const modeLabel = r.__mode === "combined" ? "COMBINED" : "FOOD";
                        return `
            <button type="button"
              class="w-full text-left rounded-xl border bg-white hover:bg-gray-50 p-3 flex gap-3 items-center"
              data-pick='${escapeHtml(JSON.stringify(r))}'>
              <div class="w-16 h-16 rounded-lg bg-gray-100 overflow-hidden flex items-center justify-center">
                ${img
                                ? `<img src="${escapeHtml(
                                    img
                                )}" class="w-full h-full object-cover" />`
                                : `<span class="text-xs text-gray-400 font-bold">NO IMG</span>`
                            }
              </div>
              <div class="min-w-0 flex-1">
                <div class="flex items-center gap-2">
                  <span class="text-[11px] font-extrabold px-2 py-1 rounded-full border bg-gray-50 text-gray-700">
                    ${modeLabel}
                  </span>
                  <div class="font-extrabold text-gray-900 truncate">${escapeHtml(
                                r.business_name || "-"
                            )}</div>
                </div>
                <div class="text-sm text-gray-600">ì‚¬ì—…ì: ${escapeHtml(
                                r.business_number || "-"
                            )}</div>
                <div class="text-sm text-gray-600">
                  ì—…ì¢…/ì¹´í…Œê³ ë¦¬: ${escapeHtml(
                                (r.business_type || "") + " / " + (r.business_category || "")
                            )}
                </div>
              </div>
              <div class="text-blue-700 font-extrabold">ì„ íƒ</div>
            </button>
          `;
                    })
                    .join("");

                resultsBox
                    .querySelectorAll("button[data-pick]")
                    .forEach((btn) => {
                        btn.addEventListener("click", () => {
                            const r = JSON.parse(btn.getAttribute("data-pick"));

                            state.globalPicked = r;
                            applyPickedStoreToPage(r);

                            state.modal.pickedStore = {
                                id: r.id,
                                business_number: r.business_number,
                                business_name: r.business_name,
                            };

                            const name = r.business_name || "-";
                            const bn = r.business_number || "-";
                            const type = r.business_type || "-";
                            const cat = r.business_category || "-";

                            $("globalPickedStore").textContent =
                                `${name} (ì‚¬ì—…ì: ${bn}) | ${type} / ${cat}`;

                            const badge = $("globalPickedBadge");
                            if (badge) {
                                badge.textContent = r.__mode === "combined" ? "COMBINED" : "FOOD";
                                badge.classList.remove("hidden");
                            }

                            const pickedEl = $("pickedStore");
                            if (pickedEl) pickedEl.textContent = `${name} (${bn})`;

                            renderPickedStorePreview(r);
                            closeGlobalResults();
                        });
                    });
            } catch (e) {
                console.error(e);
                resultsBox.innerHTML = `<div class="text-sm text-red-600 font-bold">ê²€ìƒ‰ ì‹¤íŒ¨</div>`;
            }
        }

        // =========================
        // ì´ë²¤íŠ¸ ë°”ì¸ë”© & ì´ˆê¸°í™”
        // =========================
        // ê¸°ë³¸ í‘œì‹œ
        $("imagePreview").innerHTML = `<span class="text-gray-400 font-bold">ì—†ìŒ</span>`;
        $("modeNow").textContent = state.mode;

        // ìŠ¬ë¡¯ í´ë¦­ â†’ ëª¨ë‹¬
        document.querySelectorAll("[data-section]").forEach((el) => {
            el.addEventListener("click", () => {
                const section = el.getAttribute("data-section");
                openModal(section);
            });
        });

        // íƒ€ì…/ëª¨ë“œ ë³€ê²½
        $("slotType").addEventListener("change", toggleBoxes);
        $("slotMode").addEventListener("change", toggleBoxes);
        $("noEnd").addEventListener("change", toggleBoxes);

        // íƒ­
        $("tabImage")?.addEventListener("click", () => setActiveTab("image"));
        $("tabStore")?.addEventListener("click", () => setActiveTab("store"));
        $("tabText")?.addEventListener("click", () => setActiveTab("text"));

        // ëª¨ë‹¬ ë²„íŠ¼
        $("modalClose").addEventListener("click", closeModal);
        $("cancelBtn").addEventListener("click", closeModal);
        $("saveBtn").addEventListener("click", saveSlot);
        $("deleteBtn").addEventListener("click", deleteSlot);

        // ëª¨ë‹¬ ì•ˆ ê°€ê²Œ ê²€ìƒ‰
        $("storeSearchBtn").addEventListener("click", searchStoreInModal);
        $("storeQuery").addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
                e.preventDefault();
                searchStoreInModal();
            }
        });

        // ìƒë‹¨ í‘¸ë“œ/í†µí•© ëª¨ë“œ
        $("modeSelect")?.addEventListener("change", (e) => {
            state.mode = e.target.value;
            $("modeNow").textContent = state.mode;
        });

        // ìƒë‹¨ ì „ì—­ ê°€ê²Œ ê²€ìƒ‰
        $("globalStoreSearchBtn")?.addEventListener("click", globalSearchStore);
        $("globalStoreQuery")?.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
                e.preventDefault();
                globalSearchStore();
            }
        });

        // ì „ì—­ ê²€ìƒ‰ ê²°ê³¼ ì˜ì—­ ë°– í´ë¦­ ì‹œ ë‹«ê¸°
        $("globalStoreResults")?.addEventListener("click", (e) => e.stopPropagation());
        $("globalStoreQuery")?.addEventListener("click", (e) => e.stopPropagation());
        $("globalStoreSearchBtn")?.addEventListener("click", (e) => e.stopPropagation());
        document.addEventListener("click", () => closeGlobalResults());

        // ëª¨ë‹¬ ë°”ê¹¥ í´ë¦­ â†’ ë‹«ê¸°
        $("modal").addEventListener("click", (e) => {
            if (e.target === $("modal")) closeModal();
        });

        // ì´ˆê¸° ìŠ¬ë¡¯ ë¡œë“œ
        await loadAll();
    </script>
</body>

</html>