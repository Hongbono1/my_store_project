<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ncategory2 매니저</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        .neo-card {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 1.2rem;
            box-shadow: 6px 6px 16px #d9e0ec, -6px -6px 16px #ffffff;
            backdrop-filter: blur(16px) saturate(120%);
            transition: all .25s ease;
        }

        .neo-card:hover {
            transform: translateY(-2px);
            box-shadow: 4px 4px 12px #cfd8e6, -4px -4px 12px #ffffff, 0 8px 24px rgba(80, 130, 255, 0.15);
        }

        .btn-3d {
            background: linear-gradient(90deg, #6dd5fa, #2980b9);
            border-radius: 1rem;
            padding: .55rem 1.1rem;
            font-weight: 800;
            color: white;
            box-shadow: 0 4px 0 #2393b3, 0 8px 16px rgba(0, 64, 128, 0.14);
            transition: all .15s;
        }

        .btn-3d:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #2393b3, 0 4px 10px rgba(0, 64, 128, 0.16);
        }

        .mono {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        }
    </style>
</head>

<body class="bg-gradient-to-br from-blue-50 via-white to-blue-100 min-h-screen text-gray-800">
    <!-- header -->
    <div id="header-placeholder"></div>

    <header class="max-w-7xl mx-auto px-4 pt-8 pb-4">
        <div class="neo-card p-5 flex flex-col gap-2">
            <div class="flex items-center justify-between gap-4">
                <div>
                    <h1 class="text-2xl font-black text-blue-700">ncategory2 매니저</h1>
                    <p class="text-sm text-slate-600 mt-1">
                        page=<span class="mono font-bold">ncategory2</span> / API=<span
                            class="mono font-bold">/ncategory2manager/ad</span>
                    </p>
                </div>
                <button id="btnReload" class="btn-3d">전체 새로고침</button>
            </div>
            <div class="text-xs text-slate-500">
                - 슬롯 하나 = (page, position, priority=1) 1개<br />
                - 이미지 업로드 시 자동으로 <span class="mono">/uploads/ncategory2_ad/파일명</span> 으로 저장됨
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 pb-14 grid grid-cols-12 gap-6">
        <!-- 좌측: 슬롯 메뉴 -->
        <aside class="col-span-3">
            <div class="neo-card p-4 sticky top-4">
                <h2 class="text-lg font-black text-center text-slate-700 mb-3">SLOTS</h2>

                <div class="space-y-3">
                    <div class="neo-card p-3">
                        <div class="font-black text-slate-700 mb-2">사이드바 광고</div>
                        <div id="navSidebar" class="space-y-2"></div>
                    </div>

                    <div class="neo-card p-3">
                        <div class="font-black text-slate-700 mb-2">파워 광고</div>
                        <div class="text-xs text-slate-500 mb-2">power_1 ~ power_12</div>
                        <div id="navPower" class="grid grid-cols-3 gap-2"></div>
                    </div>

                    <div class="neo-card p-3">
                        <div class="font-black text-slate-700 mb-2">MVP / HIGHLIGHT</div>
                        <div id="navMain" class="space-y-2"></div>
                    </div>

                    <div class="neo-card p-3">
                        <div class="font-black text-slate-700 mb-2">최고의 가게</div>
                        <div class="text-xs text-slate-500 mb-2">best_1 ~ best_6</div>
                        <div id="navBest" class="grid grid-cols-3 gap-2"></div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- 우측: 슬롯 카드 -->
        <section class="col-span-9 space-y-6">
            <div class="neo-card p-4">
                <div class="flex items-center justify-between gap-3">
                    <h2 class="text-xl font-black text-slate-800">슬롯 상태</h2>
                    <div class="text-sm text-slate-600">
                        총 <span id="slotCount" class="font-black">0</span>개
                    </div>
                </div>
            </div>

            <div id="slotGrid" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
        </section>
    </main>

    <!-- footer -->
    <div id="footer-placeholder"></div>

    <!-- ==================== MODAL ==================== -->
    <div id="modal" class="fixed inset-0 hidden z-50">
        <div class="absolute inset-0 bg-black/40" id="modalBack"></div>

        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div class="neo-card w-full max-w-3xl p-5 relative">
                <button id="modalClose"
                    class="absolute right-4 top-4 w-10 h-10 rounded-full bg-white shadow flex items-center justify-center text-xl">×</button>

                <div class="mb-3">
                    <div class="text-sm text-slate-500">편집 슬롯</div>
                    <div class="text-xl font-black text-slate-800" id="modalTitle">-</div>
                    <div class="text-xs text-slate-500 mt-1">
                        page=<span class="mono font-bold">ncategory2</span> / priority=<span
                            class="mono font-bold">1</span>
                    </div>
                </div>

                <div class="grid grid-cols-12 gap-4">
                    <!-- 좌: 미리보기 -->
                    <div class="col-span-5">
                        <div class="neo-card p-3">
                            <div class="font-black text-slate-700 mb-2">미리보기</div>
                            <div class="w-full aspect-[4/3] rounded-xl overflow-hidden bg-slate-100">
                                <img id="previewImg" src="/uploads/no-image.png" class="w-full h-full object-cover"
                                    alt="preview">
                            </div>

                            <div class="mt-3 text-sm">
                                <div class="font-black" id="previewName">-</div>
                                <div class="text-slate-600" id="previewCate">-</div>
                                <a id="previewLink" class="text-blue-600 underline break-all text-xs" href="#"
                                    target="_blank">#</a>
                            </div>
                        </div>
                    </div>

                    <!-- 우: 폼 -->
                    <div class="col-span-7 space-y-3">
                        <div class="neo-card p-3">
                            <div class="font-black text-slate-700 mb-2">가게 연결</div>

                            <div class="grid grid-cols-12 gap-2">
                                <input id="q" class="col-span-7 neo-card px-3 py-2" placeholder="가게명 검색 (q)" />
                                <input id="bizNo" class="col-span-5 neo-card px-3 py-2" placeholder="사업자번호(bizNo)" />
                            </div>

                            <div class="mt-2 flex gap-2">
                                <button id="btnSearch" class="btn-3d">검색</button>
                                <button id="btnClearStore"
                                    class="px-4 py-2 rounded-xl bg-slate-100 hover:bg-slate-200 font-bold">가게 연결
                                    해제</button>
                            </div>

                            <div id="searchResults" class="mt-3 space-y-2 max-h-44 overflow-auto pr-1"></div>
                        </div>

                        <div class="neo-card p-3">
                            <div class="font-black text-slate-700 mb-2">콘텐츠</div>

                            <div class="grid grid-cols-12 gap-2">
                                <div class="col-span-12">
                                    <label class="text-xs text-slate-500">상호명</label>
                                    <input id="business_name" class="neo-card w-full px-3 py-2" placeholder="상호명">
                                </div>

                                <div class="col-span-12">
                                    <label class="text-xs text-slate-500">업종(표시용)</label>
                                    <input id="category" class="neo-card w-full px-3 py-2" placeholder="예: 한식, 카페...">
                                </div>

                                <div class="col-span-12">
                                    <label class="text-xs text-slate-500">링크 URL</label>
                                    <input id="link_url" class="neo-card w-full px-3 py-2 mono"
                                        placeholder="/ndetail.html?id=...">
                                </div>

                                <div class="col-span-12">
                                    <label class="text-xs text-slate-500">텍스트(선택)</label>
                                    <textarea id="text_content" class="neo-card w-full px-3 py-2 min-h-[90px]"
                                        placeholder="필요시 텍스트 슬롯에 사용"></textarea>
                                </div>
                            </div>

                            <div class="mt-3">
                                <label class="text-xs text-slate-500">이미지 업로드</label>
                                <input id="slotImage" type="file" accept="image/*"
                                    class="neo-card w-full px-3 py-2 bg-white">
                                <div class="text-xs text-slate-500 mt-1">
                                    업로드하면 저장 경로는 <span class="mono">/uploads/ncategory2_ad/...</span>
                                </div>
                            </div>
                        </div>

                        <div class="neo-card p-3">
                            <div class="font-black text-slate-700 mb-2">기간</div>

                            <div class="grid grid-cols-12 gap-2 items-center">
                                <div class="col-span-6">
                                    <label class="text-xs text-slate-500">시작일</label>
                                    <input id="start_at" type="date" class="neo-card w-full px-3 py-2">
                                </div>
                                <div class="col-span-6">
                                    <label class="text-xs text-slate-500">종료일</label>
                                    <input id="end_at" type="date" class="neo-card w-full px-3 py-2">
                                </div>

                                <label class="col-span-12 flex items-center gap-2 text-sm font-bold mt-1">
                                    <input id="no_end" type="checkbox" class="w-4 h-4">
                                    종료 없음(no_end)
                                </label>
                            </div>
                        </div>

                        <div class="flex gap-2 justify-end">
                            <button id="btnDelete"
                                class="px-4 py-2 rounded-xl bg-red-100 hover:bg-red-200 font-black text-red-700">
                                삭제
                            </button>
                            <button id="btnSave" class="btn-3d">저장</button>
                        </div>
                    </div>
                </div>

                <!-- 숨김 필드(가게 연결 값) -->
                <input type="hidden" id="store_type">
                <input type="hidden" id="store_id">
                <input type="hidden" id="business_no">
                <input type="hidden" id="image_url">
            </div>
        </div>
    </div>

    <!-- toast -->
    <div id="toast" class="fixed left-1/2 -translate-x-1/2 bottom-6 hidden z-50">
        <div class="neo-card px-4 py-3 font-bold text-slate-800"></div>
    </div>

    <script>
        // ✅ header/footer 동적 포함
        fetch("/components/header.html")
            .then(r => r.text())
            .then(d => document.getElementById("header-placeholder").innerHTML = d);

        fetch("/components/footer.html")
            .then(r => r.text())
            .then(d => document.getElementById("footer-placeholder").innerHTML = d);

        // ==================== 설정(고정) ====================
        const API_BASE = "/ncategory2manager/ad";
        const PAGE = "ncategory2";
        const PRIORITY = 1;

        // position 고정 리스트
        const SLOT_DEFS = [
            // sidebar
            { group: "sidebar", label: "사이드 광고 1", position: "ncategory2_sidebar_ad_1" },
            { group: "sidebar", label: "사이드 광고 2", position: "ncategory2_sidebar_ad_2" },
            { group: "sidebar", label: "사이드 광고 3", position: "ncategory2_sidebar_ad_3" },

            // power 1~12
            ...Array.from({ length: 12 }, (_, i) => ({
                group: "power",
                label: `파워 ${i + 1}`,
                position: `ncategory2_power_${i + 1}`,
            })),

            // main
            { group: "main", label: "MVP", position: "ncategory2_mvp" },
            { group: "main", label: "HIGHLIGHT", position: "ncategory2_highlight" },

            // best 1~6
            ...Array.from({ length: 6 }, (_, i) => ({
                group: "best",
                label: `최고의가게 ${i + 1}`,
                position: `ncategory2_best_${i + 1}`,
            })),
        ];

        // ==================== 공통 유틸 ====================
        const $ = (id) => document.getElementById(id);

        function toast(msg) {
            const box = $("toast");
            const inner = box.querySelector("div");
            inner.textContent = msg;
            box.classList.remove("hidden");
            setTimeout(() => box.classList.add("hidden"), 2200);
        }

        function buildStoreLink(store_type, store_id) {
            if (!store_type || !store_id) return "#";
            if (store_type === "food") return `/ndetail.html?id=${store_id}&type=food`;
            if (store_type === "combined") return `/ndetail.html?id=${store_id}&type=combined`;
            if (store_type === "store_info") return `/ndetail.html?id=${store_id}&type=store_info`;
            return "#";
        }

        async function apiGetSlot(position) {
            const url = `${API_BASE}/slot?page=${encodeURIComponent(PAGE)}&position=${encodeURIComponent(position)}&priority=${PRIORITY}`;
            const r = await fetch(url);
            const j = await r.json();
            if (!j?.success) throw new Error(j?.error || "getSlot failed");
            return j.slot;
        }

        async function apiSaveSlot(payload, file) {
            const fd = new FormData();
            fd.append("page", PAGE);
            fd.append("position", payload.position);
            fd.append("priority", String(PRIORITY));

            // 테이블에 있으면 저장되는 값들(없으면 컨트롤러가 자동 무시)
            if (payload.slot_type != null) fd.append("slot_type", payload.slot_type);
            if (payload.slot_mode != null) fd.append("slot_mode", payload.slot_mode);

            if (payload.store_type != null) fd.append("store_type", payload.store_type);
            if (payload.store_id != null) fd.append("store_id", payload.store_id);

            if (payload.business_no != null) fd.append("business_no", payload.business_no);
            if (payload.business_name != null) fd.append("business_name", payload.business_name);
            if (payload.category != null) fd.append("category", payload.category);

            if (payload.link_url != null) fd.append("link_url", payload.link_url);
            if (payload.text_content != null) fd.append("text_content", payload.text_content);

            if (payload.start_at != null) fd.append("start_at", payload.start_at);
            if (payload.end_at != null) fd.append("end_at", payload.end_at);
            if (payload.no_end != null) fd.append("no_end", String(payload.no_end));

            // 이미지: 파일 우선
            if (file) fd.append("slotImage", file);

            const r = await fetch(`${API_BASE}/slot`, { method: "POST", body: fd });
            const j = await r.json();
            if (!j?.success) throw new Error(j?.error || "saveSlot failed");
            return j.slot;
        }

        async function apiDeleteSlot(position) {
            const url = `${API_BASE}/slot?page=${encodeURIComponent(PAGE)}&position=${encodeURIComponent(position)}&priority=${PRIORITY}`;
            const r = await fetch(url, { method: "DELETE" });
            const j = await r.json();
            if (!j?.success) throw new Error(j?.error || "deleteSlot failed");
            return true;
        }

        async function apiSearchStore(q, bizNo) {
            const params = new URLSearchParams();
            if (q) params.set("q", q);
            if (bizNo) params.set("bizNo", bizNo);
            const r = await fetch(`${API_BASE}/store/search?${params.toString()}`);
            const j = await r.json();
            if (!j?.success) throw new Error(j?.error || "searchStore failed");
            return j.stores || [];
        }

        // ==================== 화면 렌더 ====================
        function renderNav() {
            const navSidebar = $("navSidebar");
            const navPower = $("navPower");
            const navMain = $("navMain");
            const navBest = $("navBest");

            navSidebar.innerHTML = "";
            navPower.innerHTML = "";
            navMain.innerHTML = "";
            navBest.innerHTML = "";

            for (const s of SLOT_DEFS) {
                const btn = document.createElement("button");
                btn.className = "neo-card w-full px-3 py-2 text-left font-black hover:bg-white";
                btn.textContent = s.label;
                btn.addEventListener("click", () => openModalFor(s));

                if (s.group === "power" || s.group === "best") {
                    btn.className = "neo-card px-2 py-2 text-center font-black text-sm hover:bg-white";
                }

                if (s.group === "sidebar") navSidebar.appendChild(btn);
                if (s.group === "power") navPower.appendChild(btn);
                if (s.group === "main") navMain.appendChild(btn);
                if (s.group === "best") navBest.appendChild(btn);
            }
        }

        function slotCardHtml(def, slot) {
            const img = slot?.image_url || "/uploads/no-image.png";
            const name = slot?.business_name || "(미설정)";
            const cate = slot?.category ? `업종: ${slot.category}` : "업종: -";
            const link = slot?.link_url || "#";
            const st = slot?.store_type || "-";
            const id = slot?.store_id || "-";

            return `
        <div class="neo-card p-4 flex gap-4">
          <div class="w-36 h-28 rounded-xl overflow-hidden bg-slate-100 shrink-0">
            <img src="${img}" class="w-full h-full object-cover" alt="slot">
          </div>

          <div class="flex-1 min-w-0">
            <div class="flex items-center justify-between gap-2">
              <div>
                <div class="text-sm text-slate-500">${def.label}</div>
                <div class="text-lg font-black truncate">${name}</div>
                <div class="text-sm text-slate-600">${cate}</div>
              </div>
              <div class="text-right text-xs text-slate-500">
                <div class="mono">${def.position}</div>
                <div>store: <span class="mono">${st}</span> / <span class="mono">${id}</span></div>
              </div>
            </div>

            <div class="mt-2 text-xs text-slate-600 break-all">
              <a class="text-blue-600 underline" href="${link}" target="_blank">${link}</a>
            </div>

            <div class="mt-3 flex gap-2 justify-end">
              <button data-act="edit" class="btn-3d">편집</button>
              <button data-act="del" class="px-4 py-2 rounded-xl bg-red-100 hover:bg-red-200 font-black text-red-700">삭제</button>
            </div>
          </div>
        </div>
      `;
        }

        async function loadAllSlots() {
            const grid = $("slotGrid");
            grid.innerHTML = "";
            $("slotCount").textContent = String(SLOT_DEFS.length);

            for (const def of SLOT_DEFS) {
                let slot = null;
                try {
                    slot = await apiGetSlot(def.position);
                } catch (e) {
                    // 슬롯이 없으면 null로 표시
                    slot = null;
                }

                const wrap = document.createElement("div");
                wrap.innerHTML = slotCardHtml(def, slot);

                const editBtn = wrap.querySelector('[data-act="edit"]');
                const delBtn = wrap.querySelector('[data-act="del"]');

                editBtn.addEventListener("click", () => openModalFor(def, slot));
                delBtn.addEventListener("click", async () => {
                    if (!confirm(`${def.label} 삭제할까?`)) return;
                    try {
                        await apiDeleteSlot(def.position);
                        toast("삭제 완료");
                        await refreshOne(def);
                    } catch (e) {
                        alert(e.message);
                    }
                });

                grid.appendChild(wrap.firstElementChild);
            }
        }

        async function refreshOne(def) {
            // 간단하게 전체 새로고침(확실)
            await loadAllSlots();
        }

        // ==================== MODAL 로직 ====================
        let currentDef = null;

        function openModalFor(def, slot = null) {
            currentDef = def;

            $("modalTitle").textContent = `${def.label}  (${def.position})`;

            // 초기화
            $("q").value = "";
            $("bizNo").value = "";
            $("searchResults").innerHTML = "";

            $("store_type").value = slot?.store_type || "";
            $("store_id").value = slot?.store_id || "";
            $("business_no").value = slot?.business_no || "";
            $("business_name").value = slot?.business_name || "";
            $("category").value = slot?.category || "";
            $("link_url").value = slot?.link_url || (buildStoreLink(slot?.store_type, slot?.store_id) || "");
            $("text_content").value = slot?.text_content || "";
            $("image_url").value = slot?.image_url || "";

            $("start_at").value = (slot?.start_at || "").slice(0, 10);
            $("end_at").value = (slot?.end_at || "").slice(0, 10);
            $("no_end").checked = !!slot?.no_end;

            $("slotImage").value = "";

            // preview
            applyPreview();

            $("modal").classList.remove("hidden");
        }

        function closeModal() {
            $("modal").classList.add("hidden");
            currentDef = null;
        }

        function applyPreview() {
            const img = $("image_url").value || "/uploads/no-image.png";
            const name = $("business_name").value || "-";
            const cate = $("category").value ? `업종: ${$("category").value}` : "업종: -";
            const link = $("link_url").value || "#";

            $("previewImg").src = img;
            $("previewName").textContent = name;
            $("previewCate").textContent = cate;
            $("previewLink").textContent = link;
            $("previewLink").href = link;
        }

        $("modalBack").addEventListener("click", closeModal);
        $("modalClose").addEventListener("click", closeModal);

        $("no_end").addEventListener("change", () => {
            $("end_at").disabled = $("no_end").checked;
            if ($("no_end").checked) $("end_at").value = "";
        });

        ["business_name", "category", "link_url", "text_content"].forEach(id => {
            $(id).addEventListener("input", applyPreview);
        });

        $("slotImage").addEventListener("change", () => {
            const f = $("slotImage").files?.[0];
            if (!f) return;
            // 업로드 전 미리보기용 blob 사용(저장 시 컨트롤러는 blob 무시하고 업로드 파일 저장)
            const u = URL.createObjectURL(f);
            $("image_url").value = u;
            applyPreview();
        });

        $("btnSearch").addEventListener("click", async () => {
            try {
                const q = $("q").value.trim();
                const bizNo = $("bizNo").value.trim();
                const stores = await apiSearchStore(q, bizNo);

                const box = $("searchResults");
                box.innerHTML = "";

                if (!stores.length) {
                    box.innerHTML = `<div class="text-sm text-slate-500">검색 결과 없음</div>`;
                    return;
                }

                for (const s of stores) {
                    const b = document.createElement("button");
                    b.className = "neo-card w-full px-3 py-2 text-left hover:bg-white";
                    b.innerHTML = `
            <div class="flex items-center justify-between gap-2">
              <div class="min-w-0">
                <div class="font-black truncate">${s.business_name}</div>
                <div class="text-xs text-slate-600">업종: ${s.category || "-"}</div>
                <div class="text-xs text-slate-500 mono">biz: ${s.business_no || "-"} / ${s.store_type}:${s.id}</div>
              </div>
              <div class="text-blue-600 font-black">선택</div>
            </div>
          `;
                    b.addEventListener("click", () => {
                        $("store_type").value = s.store_type || "";
                        $("store_id").value = s.id || "";
                        $("business_no").value = s.business_no || "";
                        $("business_name").value = s.business_name || "";
                        $("category").value = s.category || "";

                        const link = buildStoreLink(s.store_type, s.id);
                        $("link_url").value = link;

                        applyPreview();
                        toast("가게 연결 완료");
                    });
                    box.appendChild(b);
                }
            } catch (e) {
                alert(e.message);
            }
        });

        $("btnClearStore").addEventListener("click", () => {
            $("store_type").value = "";
            $("store_id").value = "";
            $("business_no").value = "";
            $("business_name").value = "";
            $("category").value = "";
            $("link_url").value = "";
            applyPreview();
            toast("가게 연결 해제");
        });

        $("btnSave").addEventListener("click", async () => {
            if (!currentDef) return;

            try {
                const payload = {
                    position: currentDef.position,
                    slot_type: "image",
                    slot_mode: $("store_id").value ? "store" : "custom",

                    store_type: $("store_type").value || null,
                    store_id: $("store_id").value || null,

                    business_no: $("business_no").value || null,
                    business_name: $("business_name").value || null,
                    category: $("category").value || null,

                    link_url: $("link_url").value || null,
                    text_content: $("text_content").value || null,

                    start_at: $("start_at").value || null,
                    end_at: $("end_at").value || null,
                    no_end: $("no_end").checked,
                };

                const file = $("slotImage").files?.[0] || null;

                await apiSaveSlot(payload, file);
                toast("저장 완료");
                closeModal();
                await refreshOne(currentDef);
            } catch (e) {
                alert(e.message);
            }
        });

        $("btnDelete").addEventListener("click", async () => {
            if (!currentDef) return;
            if (!confirm(`${currentDef.label} 삭제할까?`)) return;

            try {
                await apiDeleteSlot(currentDef.position);
                toast("삭제 완료");
                closeModal();
                await refreshOne(currentDef);
            } catch (e) {
                alert(e.message);
            }
        });

        // ==================== 시작 ====================
        $("btnReload").addEventListener("click", async () => {
            toast("불러오는 중...");
            await loadAllSlots();
            toast("완료");
        });

        document.addEventListener("DOMContentLoaded", async () => {
            renderNav();
            await loadAllSlots();
        });
    </script>
</body>

</html>