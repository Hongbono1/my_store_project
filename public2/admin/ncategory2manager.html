<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ncategory2 매니저</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* ncategory2와 동일 */
        .neo-card {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 1.2rem;
            box-shadow: 6px 6px 16px #d9e0ec, -6px -6px 16px #ffffff;
            backdrop-filter: blur(16px) saturate(120%);
            transition: all .25s ease;
        }

        .neo-card:hover {
            transform: translateY(-4px);
            box-shadow: 4px 4px 12px #cfd8e6, -4px -4px 12px #ffffff, 0 8px 24px rgba(80, 130, 255, 0.15);
        }

        .btn-3d {
            background: linear-gradient(90deg, #6dd5fa, #2980b9);
            border-radius: 1.3rem;
            padding: .5rem 1.5rem;
            font-weight: bold;
            color: white;
            box-shadow: 0 4px 0 #2393b3, 0 8px 16px rgba(0, 64, 128, 0.14);
            transition: all .15s;
            user-select: none;
        }

        .btn-3d:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #2393b3, 0 4px 10px rgba(0, 64, 128, 0.16);
        }

        .scroll-x {
            display: flex;
            gap: 1rem;
            overflow-x: auto;
            scrollbar-width: thin;
        }

        .scroll-x::-webkit-scrollbar {
            height: 6px;
        }

        .scroll-x::-webkit-scrollbar-thumb {
            background: #a3bffa;
            border-radius: 9999px;
        }

        .sidebar-scroll {
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: transparent transparent;
        }

        .sidebar-scroll:hover {
            scrollbar-color: #cbd5e1 transparent;
        }

        .sidebar-scroll::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar-scroll::-webkit-scrollbar-track {
            background: transparent;
        }

        .sidebar-scroll::-webkit-scrollbar-thumb {
            background: transparent;
            border-radius: 9999px;
        }

        .sidebar-scroll:hover::-webkit-scrollbar-thumb {
            background: #cbd5e1;
        }

        .sidebar-scroll::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* 관리자 클릭용(레이아웃은 그대로, 표시만 아주 작게) */
        .admin-slot {
            cursor: pointer;
            position: relative;
        }

        .admin-slot::after {
            content: "관리";
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 12px;
            font-weight: 900;
            padding: 6px 10px;
            border-radius: 9999px;
            background: rgba(255, 255, 255, 0.78);
            border: 1px solid rgba(59, 130, 246, 0.25);
            backdrop-filter: blur(8px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.08);
            color: rgba(30, 64, 175, 0.95);
            pointer-events: none;
        }

        /* ✅ 입력칸(가시성 강화) */
        .input {
            width: 100%;
            padding: .65rem .85rem;
            border-radius: 1rem;
            border: 1px solid rgba(148, 163, 184, .75);
            background: rgba(255, 255, 255, 0.92);
            outline: none;
        }

        .input:focus {
            border-color: rgba(59, 130, 246, .85);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, .18);
        }

        .chip {
            display: inline-flex;
            align-items: center;
            gap: .4rem;
            padding: .35rem .7rem;
            border-radius: 9999px;
            background: rgba(59, 130, 246, .10);
            border: 1px solid rgba(59, 130, 246, .20);
            font-weight: 800;
            font-size: .85rem;
            color: rgba(30, 64, 175, .92);
        }
    </style>
</head>

<body class="bg-gradient-to-br from-blue-50 via-white to-blue-100 min-h-screen text-gray-800">
    <!-- ✅ header.html 불러오기 -->
    <div id="header-placeholder"></div>

    <header class="py-6 text-center">
        <h1 class="text-3xl font-bold text-blue-700">우리동네 가게</h1>
        <p class="text-gray-600 mt-1">ncategory2 매니저(레이아웃 동일) - combined_store_info 연결</p>
    </header>

    <div class="max-w-6xl mx-auto grid grid-cols-12 gap-6 py-6 px-4">
        <!-- 좌측 사이드바 (레이아웃 동일) -->
        <aside class="col-span-3 neo-card p-3 h-full max-h-[1346px] sidebar-scroll">
            <h2 class="font-bold text-2xl mb-4 text-center">CATEGORY</h2>
            <ul class="space-y-3">
                <!-- 병원 -->
                <li class="mb-5">
                    <button
                        class="w-full text-left pl-16 pr-3 py-2 neo-card flex justify-between items-center font-bold text-xl"
                        onclick="toggleSub(this)">
                        병 원 <span>▼</span>
                    </button>
                    <ul class="ml-4 mt-1 space-y-3 hidden">
                        <li><a href="/subcategory.html?type=hospital&category=종합병원"
                                class="block px-5 py-2 neo-card text-center">종합병원</a></li>
                        <li><a href="/subcategory.html?type=hospital&category=내과"
                                class="block px-3 py-2 neo-card text-center">내과</a></li>
                        <li><a href="/subcategory.html?type=hospital&category=치과"
                                class="block px-3 py-2 neo-card text-center">치과</a></li>
                        <li><a href="/subcategory.html?type=hospital&category=소아과"
                                class="block px-3 py-2 neo-card text-center">소아과</a></li>
                        <li><a href="/subcategory.html?type=hospital&category=정형외과"
                                class="block px-3 py-2 neo-card text-center">정형외과</a></li>
                        <li><a href="/subcategory.html?type=hospital&category=산부인과"
                                class="block px-3 py-2 neo-card text-center">산부인과</a></li>
                        <li><a href="/subcategory.html?type=hospital&category=한의원"
                                class="block px-3 py-2 neo-card text-center">한의원</a></li>
                        <li><a href="/subcategory.html?type=hospital&category=기타"
                                class="block px-3 py-2 neo-card text-center">기타</a></li>
                    </ul>
                </li>

                <!-- 약국 -->
                <li class="mb-5">
                    <button
                        class="w-full text-left pl-16 pr-3 py-2 neo-card flex justify-between items-center font-bold text-xl"
                        onclick="toggleSub(this)">
                        약 국 <span>▼</span>
                    </button>
                    <ul class="ml-4 mt-1 space-y-3 hidden">
                        <li><a href="/subcategory.html?type=pharmacy&category=일반약국"
                                class="block px-3 py-2 neo-card text-center">일반약국</a></li>
                        <li><a href="/subcategory.html?type=pharmacy&category=24시약국"
                                class="block px-3 py-2 neo-card text-center">24시약국</a></li>
                        <li><a href="/subcategory.html?type=pharmacy&category=한약방"
                                class="block px-3 py-2 neo-card text-center">한약방</a></li>
                        <li><a href="/subcategory.html?type=pharmacy&category=기타"
                                class="block px-3 py-2 neo-card text-center">기타</a></li>
                    </ul>
                </li>

                <!-- 어린이집 -->
                <li class="mb-5">
                    <button
                        class="w-full text-left pl-12 pr-3 py-2 neo-card flex justify-between items-center font-bold text-xl"
                        onclick="toggleSub(this)">
                        어린이집 <span>▼</span>
                    </button>
                    <ul class="ml-4 mt-1 space-y-1 hidden">
                        <li><a href="/subcategory.html?type=kindergarten&category=국공립"
                                class="block px-3 py-2 neo-card text-center">어린이집 통합</a></li>
                    </ul>
                </li>
            </ul>

            <!-- ✅ 광고 박스 -->
            <div class="neo-card mt-6 p-4 text-center border-2 border-dashed border-blue-300">
                <h3 class="font-bold text-lg mb-2">광고 영역</h3>
                <p class="text-sm text-gray-600">이곳은 광고 배너/이미지가 들어갈 박스입니다.</p>
                <img src="/uploads/sample-ad.jpg" alt="광고 이미지" class="mt-3 w-full h-[30px] object-cover rounded-xl">
            </div>
        </aside>

        <!-- 중앙 메인 (레이아웃 동일) -->
        <main class="col-span-9 space-y-8">
            <!-- 메인 배너(동일) -->
            <section class="relative h-60 neo-card flex items-center justify-center">
                <div class="text-center">
                    <h1 class="text-3xl font-bold mb-2">Premium 카테고리</h1>
                    <p class="text-gray-600 text-sm">카테고리 설명 문구를 여기에 넣습니다.</p>
                </div>
            </section>

            <!-- 파워 광고(동일 구조: 그룹 3개, 그룹당 3개) -->
            <section class="mt-10">
                <h2 class="font-bold text-2xl text-purple-600 text-center mb-4">강력 추천</h2>

                <div id="powerViewport" class="relative overflow-hidden">
                    <div id="powerAdTrack"
                        class="flex transition-transform duration-500 ease-in-out will-change-transform"></div>

                    <button id="prevBtn"
                        class="absolute left-0 top-1/2 -translate-y-1/2 bg-white shadow rounded-full px-3 py-2">‹</button>
                    <button id="nextBtn"
                        class="absolute right-0 top-1/2 -translate-y-1/2 bg-white shadow rounded-full px-3 py-2">›</button>
                </div>
            </section>

            <!-- 최고의 가게 영역(동일 배치: 좌 3칸 + 우 9칸) -->
            <section class="grid grid-cols-12 gap-6 items-stretch">
                <!-- 좌측: MVP + HIGHLIGHT -->
                <div class="col-span-3 h-full">
                    <div class="neo-card p-4 w-full h-full flex flex-col gap-4">
                        <!-- MVP -->
                        <div class="flex-1 flex flex-col">
                            <h2 class="font-bold text-2xl text-blue-600 text-center mb-3">MVP</h2>
                            <a href="#"
                                class="neo-card p-0 overflow-hidden relative rounded-2xl h-full border-2 border-blue-500 admin-slot"
                                data-position="ncategory2_mvp" data-label="MVP">
                                <img data-role="img" src="/uploads/sample-left-top.jpg"
                                    class="w-full h-full object-cover" alt="상호명 Top">
                                <div
                                    class="absolute left-3 right-3 bottom-3 bg-white/70 backdrop-blur-md rounded-xl shadow px-4 py-2 text-center">
                                    <div class="font-bold text-lg leading-tight" data-role="name">상호명 Top</div>
                                    <div class="text-sm text-slate-600" data-role="category">업종: 한식</div>
                                </div>
                            </a>
                        </div>

                        <!-- HIGHLIGHT -->
                        <div class="flex-1 flex flex-col">
                            <h2 class="font-bold text-2xl text-yellow-600 text-center mb-3">HIGHLIGHT</h2>
                            <a href="#"
                                class="neo-card p-0 overflow-hidden relative rounded-2xl h-full border-2 border-yellow-500 admin-slot"
                                data-position="ncategory2_highlight" data-label="HIGHLIGHT">
                                <img data-role="img" src="/uploads/sample-left-bottom.jpg"
                                    class="w-full h-full object-cover" alt="상호명 Bottom">
                                <div
                                    class="absolute left-3 right-3 bottom-3 bg-white/70 backdrop-blur-md rounded-xl shadow px-4 py-2 text-center">
                                    <div class="font-bold text-lg leading-tight" data-role="name">상호명 Bottom</div>
                                    <div class="text-sm text-slate-600" data-role="category">업종: 카페</div>
                                </div>
                            </a>
                        </div>
                    </div>
                </div>

                <!-- 우측: 최고의 가게(동일 그리드) -->
                <div class="col-span-9 flex flex-col gap-6">
                    <div class="neo-card p-5">
                        <h2 class="font-bold mb-3 text-2xl text-center">최고의 가게</h2>
                        <div id="bestGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                    </div>
                </div>
            </section>

            <!-- ✅ 하단 박스 두 개(동일) -->
            <div class="grid grid-cols-2 gap-6">
                <div class="neo-card p-6 text-center">
                    <h3 class="font-bold text-lg mb-2">하단 박스 1</h3>
                    <p class="text-gray-600 text-sm">이곳은 설명 텍스트</p>
                </div>
                <div class="neo-card p-6 text-center">
                    <h3 class="font-bold text-lg mb-2">하단 박스 2</h3>
                    <p class="text-gray-600 text-sm">이곳은 설명 텍스트</p>
                </div>
            </div>
        </main>
    </div>

    <!-- 오른쪽 하단 세로 네비게이션(동일) -->
    <div class="fixed bottom-6 right-6 flex flex-col items-center gap-4 z-50">
        <div class="flex flex-col items-center">
            <button onclick="goBack()"
                class="w-14 h-14 flex items-center justify-center rounded-full bg-gradient-to-br from-gray-100 to-gray-200 text-gray-700 shadow hover:from-gray-200 hover:to-gray-300 transition">
                ←
            </button>
            <span class="text-xs mt-1 text-gray-600 font-semibold">이전</span>
        </div>

        <div class="flex flex-col items-center">
            <button onclick="goNext()"
                class="w-14 h-14 flex items-center justify-center rounded-full bg-gradient-to-br from-gray-100 to-gray-200 text-gray-700 shadow hover:from-gray-200 hover:to-gray-300 transition">
                →
            </button>
            <span class="text-xs mt-1 text-gray-600 font-semibold">다음</span>
        </div>

        <div class="flex flex-col items-center">
            <a href="/index.html"
                class="w-14 h-14 flex items-center justify-center rounded-full bg-gradient-to-br from-blue-500 to-blue-600 text-white shadow hover:from-blue-600 hover:to-blue-700 transition">
                🏠
            </a>
            <span class="text-xs mt-1 text-gray-600 font-semibold">홈</span>
        </div>
    </div>

    <!-- ✅ footer.html 불러오기 -->
    <div id="footer-placeholder"></div>

    <!-- ===================== SLOT MODAL ===================== -->
    <div id="slotModal" class="fixed inset-0 z-[9999] hidden">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" onclick="closeSlotModal()"></div>

        <div class="relative mx-auto mt-10 w-[95vw] max-w-6xl">
            <div class="neo-card overflow-hidden border border-white/60">
                <!-- header -->
                <div class="flex items-center justify-between px-5 py-4 border-b border-slate-200/60">
                    <div>
                        <div class="text-xl font-extrabold text-slate-800">슬롯 설정</div>
                        <div id="slotModalSub" class="text-sm text-slate-500 mt-0.5"></div>
                    </div>
                    <button class="btn-3d" type="button" onclick="closeSlotModal()">닫기</button>
                </div>

                <!-- body: 왼쪽만 스크롤 -->
                <div class="flex gap-0">
                    <!-- LEFT (scroll) -->
                    <div class="w-2/3 p-5 max-h-[78vh] overflow-y-auto">
                        <!-- 기본 정보 -->
                        <div class="neo-card p-4">
                            <div class="font-bold text-lg mb-3">슬롯 기본정보</div>

                            <div class="grid grid-cols-12 gap-3">
                                <div class="col-span-6">
                                    <label class="text-sm font-semibold text-slate-700">page</label>
                                    <input id="m_page" class="mt-1 input" readonly />
                                </div>
                                <div class="col-span-6">
                                    <label class="text-sm font-semibold text-slate-700">position</label>
                                    <input id="m_position" class="mt-1 input" readonly />
                                </div>

                                <div class="col-span-6">
                                    <label class="text-sm font-semibold text-slate-700">priority</label>
                                    <input id="m_priority" class="mt-1 input" readonly />
                                </div>

                                <div class="col-span-6">
                                    <label class="text-sm font-semibold text-slate-700">모드</label>
                                    <div class="mt-1 flex gap-2">
                                        <label class="neo-card px-3 py-2 flex items-center gap-2 cursor-pointer">
                                            <input type="radio" name="m_slotMode" value="banner" checked />
                                            <span class="font-semibold">이미지</span>
                                        </label>
                                        <label class="neo-card px-3 py-2 flex items-center gap-2 cursor-pointer">
                                            <input type="radio" name="m_slotMode" value="store" />
                                            <span class="font-semibold">가게연결</span>
                                        </label>
                                        <label class="neo-card px-3 py-2 flex items-center gap-2 cursor-pointer">
                                            <input type="radio" name="m_slotMode" value="text" />
                                            <span class="font-semibold">텍스트</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 이미지 -->
                        <div class="neo-card p-4 mt-5">
                            <div class="font-bold text-lg mb-3">이미지</div>

                            <div class="grid grid-cols-12 gap-3 items-start">
                                <div class="col-span-7">
                                    <label class="text-sm font-semibold text-slate-700">업로드</label>
                                    <input id="m_imageFile" type="file" accept="image/*" class="mt-1 input" />
                                    <div class="flex gap-3 mt-2 text-sm">
                                        <label class="flex items-center gap-2">
                                            <input id="m_keepImage" type="checkbox" />
                                            <span>기존 이미지 유지</span>
                                        </label>
                                        <label class="flex items-center gap-2">
                                            <input id="m_clearImage" type="checkbox" />
                                            <span class="text-rose-600 font-semibold">이미지/내용 초기화</span>
                                        </label>
                                    </div>
                                </div>

                                <div class="col-span-5">
                                    <div class="text-sm font-semibold text-slate-700">미리보기</div>
                                    <div class="neo-card mt-1 p-2">
                                        <img id="m_previewImg" src="" alt=""
                                            class="w-full h-40 object-cover rounded-xl hidden" />
                                        <div id="m_previewEmpty" class="text-slate-500 text-sm text-center py-10">
                                            미리보기 없음
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-3">
                                <label class="text-sm font-semibold text-slate-700">이미지 URL(선택)</label>
                                <input id="m_imageUrl" class="mt-1 input" placeholder="/uploads/..." />
                            </div>
                        </div>

                        <!-- 가게 연결 정보 (직접입력 금지: readonly) -->
                        <div class="neo-card p-4 mt-5">
                            <div class="font-bold text-lg mb-3">가게 연결 정보 (직접 입력 금지)</div>

                            <div class="grid grid-cols-12 gap-3">
                                <div class="col-span-4">
                                    <label class="text-sm font-semibold text-slate-700">table_source</label>
                                    <input id="m_tableSource" class="mt-1 input" readonly />
                                </div>
                                <div class="col-span-4">
                                    <label class="text-sm font-semibold text-slate-700">store_id</label>
                                    <input id="m_storeId" class="mt-1 input" readonly />
                                </div>
                                <div class="col-span-4">
                                    <label class="text-sm font-semibold text-slate-700">business_no</label>
                                    <input id="m_businessNo" class="mt-1 input" readonly />
                                </div>

                                <div class="col-span-12">
                                    <label class="text-sm font-semibold text-slate-700">business_name</label>
                                    <input id="m_businessName" class="mt-1 input" readonly />
                                </div>

                                <!-- ✅ 업종 표시용(입력 금지) -->
                                <div class="col-span-12">
                                    <label class="text-sm font-semibold text-slate-700">업종(표시용)</label>
                                    <input id="m_categoryView" class="mt-1 input" readonly
                                        placeholder="가게 선택 시 자동 표시" />
                                </div>
                            </div>
                        </div>

                        <!-- 링크 / 텍스트 -->
                        <div class="neo-card p-4 mt-5">
                            <div class="font-bold text-lg mb-3">텍스트 / 링크</div>

                            <div class="grid grid-cols-12 gap-3">
                                <div class="col-span-12">
                                    <label class="text-sm font-semibold text-slate-700">link_url (가게 선택 시 자동)</label>
                                    <input id="m_linkUrl" class="mt-1 input"
                                        placeholder="/ndetail.html?id=...&type=..." />
                                </div>
                                <div class="col-span-12">
                                    <label class="text-sm font-semibold text-slate-700">text_content</label>
                                    <textarea id="m_textContent" rows="3" class="mt-1 input"
                                        placeholder="텍스트 모드일 때 표시될 내용"></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- 저장 버튼 -->
                        <div class="flex gap-3 mt-6">
                            <button class="btn-3d" type="button" onclick="saveSlotFromModal()">저장</button>
                            <button class="neo-card px-5 py-2 font-bold" type="button"
                                onclick="closeSlotModal()">취소</button>
                            <div id="m_status" class="ml-auto text-sm text-slate-600 flex items-center"></div>
                        </div>
                    </div>

                    <!-- RIGHT (fixed 느낌 유지) -->
                    <div class="w-1/3 p-5 border-l border-slate-200/60 max-h-[78vh]">
                        <div class="neo-card p-4">
                            <div class="font-bold text-lg mb-3">가게 검색</div>

                            <div class="grid grid-cols-12 gap-2">
                                <div class="col-span-12">
                                    <label class="text-sm font-semibold text-slate-700">가게명/업종 검색</label>
                                    <input id="storeSearchQ" class="mt-1 input" placeholder="예: 하늘식당" />
                                </div>
                                <div class="col-span-12">
                                    <label class="text-sm font-semibold text-slate-700">사업자번호 검색</label>
                                    <input id="storeSearchBizNo" class="mt-1 input" placeholder="숫자만/일부 가능" />
                                </div>
                                <div class="col-span-12 flex gap-2 mt-2">
                                    <button class="btn-3d w-full" type="button" onclick="doStoreSearch()">검색</button>
                                </div>
                            </div>

                            <div class="mt-4">
                                <div class="text-sm font-semibold text-slate-700 mb-2">검색 결과</div>
                                <div id="storeSearchResults" class="space-y-2 overflow-y-auto max-h-[48vh] pr-1"></div>
                            </div>

                            <div class="mt-4 text-xs text-slate-500">
                                * “선택”하면 store_id/table_source/business_no/link_url 이 자동 입력됩니다.
                            </div>
                        </div>
                    </div>
                </div><!-- /body -->
            </div>
        </div>
    </div>

    <script>
        // ---------- 공통 ----------
        const el = (id) => document.getElementById(id);
        const digitsOnly = (v) => String(v || "").replace(/[^\d]/g, "");

        // header/footer
        fetch("/components/header.html").then(r => r.text()).then(d => el("header-placeholder").innerHTML = d);
        fetch("/components/footer.html").then(r => r.text()).then(d => el("footer-placeholder").innerHTML = d);

        // ✅ 서브카테고리 토글
        function toggleSub(btn) {
            const ul = btn.nextElementSibling;
            if (!ul) return;
            ul.classList.toggle("hidden");
        }

        function goBack() {
            if (document.referrer && document.referrer !== location.href) window.history.back();
            else window.location.href = "/category.html";
        }
        function goNext() { window.history.forward(); }

        // ---------- API ----------
        const API_BASE = "/ncategory2manager/ad";
        const PAGE = "ncategory2";
        const DEFAULT_TABLE_SOURCE = "combined_store_info";

        function buildCombinedLink(id) {
            return `/ndetail.html?id=${encodeURIComponent(String(id))}&type=combined`;
        }

        async function apiListSlots() {
            const r = await fetch(`${API_BASE}/slots?page=${encodeURIComponent(PAGE)}`);
            const data = await r.json().catch(() => ({}));
            if (data && data.success === true) return data.slots || [];
            if (Array.isArray(data?.slots)) return data.slots;
            throw new Error(data?.error || "슬롯 목록 로드 실패");
        }

        async function apiGetSlot({ page, position, priority }) {
            const url = new URL(`${API_BASE}/slot`, window.location.origin);
            if (page) url.searchParams.set("page", page);
            if (position) url.searchParams.set("position", position);
            if (priority !== "" && priority !== null && priority !== undefined) url.searchParams.set("priority", String(priority));

            const r = await fetch(url.toString());
            const data = await r.json().catch(() => ({}));
            if (data && data.success === true) return data.slot || null;
            return null;
        }

        // ✅ 검색 파라미터 호환(서버가 bizNo / businessNo / business_no 중 뭐를 받아도 통과)
        async function apiSearchStore({ q, bizNo }) {
            const url = new URL(`${API_BASE}/store/search`, window.location.origin);
            if (q) url.searchParams.set("q", q);

            if (bizNo) {
                url.searchParams.set("bizNo", bizNo);
                url.searchParams.set("businessNo", bizNo);
                url.searchParams.set("business_no", bizNo);
            }

            const r = await fetch(url.toString());
            const data = await r.json().catch(() => ({}));
            if (data && data.ok === true) return data.stores || [];
            if (data && data.success === true) return data.stores || [];
            throw new Error(data?.error || "검색 실패");
        }

        async function apiUpsertSlot(formData) {
            const r = await fetch(`${API_BASE}/slot`, { method: "POST", body: formData });
            const data = await r.json().catch(() => ({}));
            if (!data || data.success !== true) throw new Error(data?.error || "저장 실패");
            return data.slot || null;
        }

        // ---------- 슬롯 화면 구성 ----------
        const POWER_POS = Array.from({ length: 9 }, (_, i) => `ncategory2_power_${i + 1}`);
        const BEST_POS = Array.from({ length: 9 }, (_, i) => `ncategory2_best_${i + 1}`);

        const state = {
            slots: new Map(),   // position -> row
            currentKey: { page: PAGE, position: "", priority: "" },
            selectedCategory: "", // ✅ 업종 기억
        };

        function makeSlotCard(position, label, imgHClass = "h-60 md:h-64") {
            const wrap = document.createElement("div");
            wrap.className = "neo-card p-0 overflow-hidden relative rounded-2xl border-4 border-yellow-200 admin-slot";
            wrap.setAttribute("data-position", position);
            wrap.setAttribute("data-label", label);
            wrap.innerHTML = `
        <img data-role="img" src="/uploads/sample-1.jpg" alt="${label}" class="w-full ${imgHClass} object-cover">
        <div class="absolute left-3 right-3 bottom-3 bg-white/70 backdrop-blur-md rounded-xl shadow px-4 py-2 text-center">
          <div class="font-bold text-lg" data-role="name">${label}</div>
          <div class="text-sm text-slate-600" data-role="category">업종:</div>
        </div>
      `;
            return wrap;
        }

        function buildPowerSliderDom() {
            const track = el("powerAdTrack");
            track.innerHTML = "";

            for (let g = 0; g < 3; g++) {
                const group = document.createElement("div");
                group.className = "power-group flex basis-full shrink-0";

                for (let i = 0; i < 3; i++) {
                    const idx = g * 3 + i;
                    const pos = POWER_POS[idx];

                    const col = document.createElement("div");
                    col.className = "w-1/3 px-2";

                    const a = document.createElement("a");
                    a.href = "#";
                    a.className = "block";
                    a.appendChild(makeSlotCard(pos, `강력추천 ${idx + 1}`));

                    col.appendChild(a);
                    group.appendChild(col);
                }
                track.appendChild(group);
            }
        }

        function buildBestGridDom() {
            const grid = el("bestGrid");
            grid.innerHTML = "";

            for (let i = 0; i < 9; i++) {
                const pos = BEST_POS[i];

                const a = document.createElement("a");
                a.href = "#";
                a.className = "block";

                const card = document.createElement("div");
                card.className = "neo-card p-0 overflow-hidden relative rounded-2xl transition-transform admin-slot";
                card.setAttribute("data-position", pos);
                card.setAttribute("data-label", `최고의가게 ${i + 1}`);

                card.innerHTML = `
          <div class="w-full h-60">
            <img data-role="img" src="/uploads/sample-1.jpg" alt="상호명" class="w-full h-full object-cover">
          </div>
          <div class="absolute left-3 right-3 bottom-3 bg-white/70 backdrop-blur-md rounded-xl shadow px-4 py-3">
            <div class="font-bold text-lg leading-tight" data-role="name">상호명</div>
            <div class="text-sm text-slate-600" data-role="category">업종:</div>
          </div>
        `;

                a.appendChild(card);
                grid.appendChild(a);
            }
        }

        function pickCategory(obj) {
            return obj?.category
                || obj?.business_category
                || obj?.businessCategory
                || obj?.store_category
                || obj?.storeCategory
                || "";
        }

        function applySlotToEl(slotEl, slot) {
            if (!slotEl) return;

            const img = slotEl.querySelector('[data-role="img"]');
            const name = slotEl.querySelector('[data-role="name"]');
            const category = slotEl.querySelector('[data-role="category"]');

            const fallbackImg = img?.getAttribute("src") || "";
            const imageUrl = slot?.image_url || slot?.imageUrl || fallbackImg;

            const businessName =
                slot?.business_name || slot?.businessName
                || slot?.text_content || slot?.textContent
                || (slotEl.getAttribute("data-label") || "");

            const cat = pickCategory(slot);

            if (img) img.src = imageUrl || fallbackImg;
            if (name) name.textContent = businessName || "";
            if (category) category.textContent = cat ? `업종: ${cat}` : "업종:";

            const a = slotEl.closest("a");
            if (a) a.href = slot?.link_url || slot?.linkUrl || "#";
        }

        function bindAdminClicks() {
            document.querySelectorAll("[data-position]").forEach(target => {
                target.addEventListener("click", (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const position = target.getAttribute("data-position");
                    openSlotModal(position, "");
                });
            });
        }

        async function loadAndRender() {
            const rows = await apiListSlots();
            state.slots.clear();
            rows.forEach(r => state.slots.set(r.position, r));

            document.querySelectorAll("[data-position]").forEach(slotEl => {
                const pos = slotEl.getAttribute("data-position");
                applySlotToEl(slotEl, state.slots.get(pos));
            });
        }

        // ---------- 슬라이더 ----------
        function initPowerSlider() {
            const viewport = el("powerViewport");
            const track = el("powerAdTrack");
            if (!viewport || !track) return;

            const groups = track.querySelectorAll(".power-group").length;
            let index = Math.floor(Math.random() * Math.max(groups, 1));
            let dir = 1;

            function updateSlider() {
                const slideWidth = viewport.clientWidth;
                track.style.transform = `translateX(${-index * slideWidth}px)`;
            }

            function stepAuto() {
                if (groups <= 1) return;
                if (index >= groups - 1) dir = -1;
                else if (index <= 0) dir = 1;
                index = index + dir;
                updateSlider();
            }

            function nextManual() {
                if (groups <= 1) return;
                if (index < groups - 1) index++;
                else { dir = -1; index = groups - 2; }
                updateSlider();
            }

            function prevManual() {
                if (groups <= 1) return;
                if (index > 0) index--;
                else { dir = 1; index = 1; }
                updateSlider();
            }

            const nextBtn = el("nextBtn");
            const prevBtn = el("prevBtn");
            if (nextBtn && prevBtn) {
                nextBtn.addEventListener("click", () => { stopAuto(); nextManual(); startAuto(); });
                prevBtn.addEventListener("click", () => { stopAuto(); prevManual(); startAuto(); });
            }

            window.addEventListener("resize", updateSlider);

            const INTERVAL = 10000;
            let timer = null;
            function startAuto() { if (!timer) timer = setInterval(stepAuto, INTERVAL); }
            function stopAuto() { if (timer) { clearInterval(timer); timer = null; } }

            document.addEventListener("visibilitychange", () => { document.hidden ? stopAuto() : startAuto(); });
            viewport.addEventListener("mouseenter", stopAuto);
            viewport.addEventListener("mouseleave", startAuto);

            updateSlider();
            startAuto();
        }

        // ---------- 모달 ----------
        function setStatus(msg) {
            const s = el("m_status");
            if (s) s.textContent = msg || "";
        }

        function setPreview(url) {
            const img = el("m_previewImg");
            const empty = el("m_previewEmpty");
            if (!img || !empty) return;

            if (url) {
                img.src = url;
                img.classList.remove("hidden");
                empty.classList.add("hidden");
            } else {
                img.src = "";
                img.classList.add("hidden");
                empty.classList.remove("hidden");
            }
        }

        function getMode() {
            return document.querySelector('input[name="m_slotMode"]:checked')?.value || "banner";
        }

        function clearModalFields() {
            setStatus("");
            state.selectedCategory = "";

            el("m_imageFile").value = "";
            el("m_keepImage").checked = false;
            el("m_clearImage").checked = false;

            el("m_imageUrl").value = "";
            setPreview("");

            el("m_tableSource").value = "";
            el("m_storeId").value = "";
            el("m_businessNo").value = "";
            el("m_businessName").value = "";
            el("m_categoryView").value = "";
            el("m_linkUrl").value = "";
            el("m_textContent").value = "";

            el("storeSearchResults").innerHTML = "";
            el("storeSearchQ").value = "";
            el("storeSearchBizNo").value = "";

            document.querySelectorAll('input[name="m_slotMode"]').forEach(r => r.checked = (r.value === "banner"));
        }

        async function openSlotModal(position, priority = "") {
            state.currentKey.page = PAGE;
            state.currentKey.position = position || "";
            state.currentKey.priority = (priority === null || priority === undefined) ? "" : String(priority);

            el("m_page").value = state.currentKey.page;
            el("m_position").value = state.currentKey.position;
            el("m_priority").value = state.currentKey.priority;

            clearModalFields();

            el("slotModal").classList.remove("hidden");
            el("slotModalSub").textContent =
                `page=${state.currentKey.page} / position=${state.currentKey.position}` +
                (state.currentKey.priority ? ` / priority=${state.currentKey.priority}` : " / priority=NULL");

            await loadSlotIntoModal();
        }

        function closeSlotModal() {
            el("slotModal").classList.add("hidden");
        }

        async function loadSlotIntoModal() {
            try {
                setStatus("불러오는 중...");
                const slot = await apiGetSlot(state.currentKey);

                if (!slot) {
                    setStatus("슬롯 없음(신규)");
                    return;
                }

                const mode = (slot.slot_mode || slot.slotMode || "banner");
                document.querySelectorAll('input[name="m_slotMode"]').forEach(r => r.checked = (r.value === mode));

                const img = slot.image_url || slot.imageUrl || "";
                el("m_imageUrl").value = img || "";
                setPreview(img || "");

                el("m_tableSource").value = slot.table_source || slot.tableSource || "";
                el("m_storeId").value = slot.store_id || slot.storeId || "";
                el("m_businessNo").value = slot.business_no || slot.businessNo || "";
                el("m_businessName").value = slot.business_name || slot.businessName || "";

                const cat = pickCategory(slot);
                state.selectedCategory = cat || "";
                el("m_categoryView").value = cat || "";

                el("m_linkUrl").value = slot.link_url || slot.linkUrl || "";
                el("m_textContent").value = slot.text_content || slot.textContent || "";

                setStatus("불러오기 완료");
            } catch (e) {
                console.error(e);
                setStatus("불러오기 실패");
            }
        }

        // ✅ 가게 검색
        async function doStoreSearch() {
            try {
                const q = (el("storeSearchQ").value || "").trim();
                const bizNo = digitsOnly((el("storeSearchBizNo").value || "").trim());

                el("storeSearchResults").innerHTML = `<div class="text-sm text-slate-500">검색 중...</div>`;
                const stores = await apiSearchStore({ q, bizNo });

                renderStoreResults(stores || []);
            } catch (e) {
                console.error(e);
                el("storeSearchResults").innerHTML = `<div class="text-sm text-rose-600">검색 오류</div>`;
            }
        }

        function renderStoreResults(stores) {
            const wrap = el("storeSearchResults");
            wrap.innerHTML = "";

            if (!stores.length) {
                wrap.innerHTML = `<div class="text-sm text-slate-500">검색 결과 없음</div>`;
                return;
            }

            stores.forEach((s) => {
                const id = s.id || "";
                const biz = s.business_no || s.businessNo || s.business_number || "";
                const name = s.business_name || s.businessName || s.business_name_kor || "";
                const cat = pickCategory(s);
                const img = s.image_url || s.imageUrl || s.thumb_url || "";

                const row = document.createElement("div");
                row.className = "neo-card p-3 flex gap-3 items-center";

                row.innerHTML = `
          <div class="w-16 h-12 rounded-xl overflow-hidden bg-white/60 shrink-0">
            ${img ? `<img src="${img}" class="w-full h-full object-cover" />`
                        : `<div class="w-full h-full flex items-center justify-center text-xs text-slate-400">NO IMG</div>`}
          </div>
          <div class="flex-1 min-w-0">
            <div class="font-extrabold text-slate-800 truncate">${name || "-"}</div>
            <div class="text-xs text-slate-600 mt-0.5 truncate">${cat ? `(${cat})` : ""} ${biz ? `· ${biz}` : ""}</div>
            <div class="text-[11px] text-slate-400 mt-0.5 truncate">${DEFAULT_TABLE_SOURCE} · id=${id}</div>
          </div>
          <button class="btn-3d shrink-0" type="button">선택</button>
        `;

                row.querySelector("button").addEventListener("click", () => {
                    applySelectedStore({ id, business_no: biz, business_name: name, category: cat });
                });

                wrap.appendChild(row);
            });
        }

        // ✅ “선택” 시 자동 매핑
        function applySelectedStore(store) {
            const storeId = store.id || "";
            const businessNo = store.business_no || "";
            const businessName = store.business_name || "";
            const category = store.category || "";

            state.selectedCategory = category || "";

            el("m_storeId").value = storeId;
            el("m_tableSource").value = DEFAULT_TABLE_SOURCE;
            el("m_businessNo").value = businessNo;
            el("m_businessName").value = businessName;
            el("m_categoryView").value = category || "";

            document.querySelectorAll('input[name="m_slotMode"]').forEach(r => r.checked = (r.value === "store"));
            el("m_linkUrl").value = buildCombinedLink(storeId);

            setStatus("가게 연결 완료 (저장 누르세요)");
        }

        // ✅ 저장
        async function saveSlotFromModal() {
            try {
                setStatus("저장 중...");

                const page = el("m_page").value;
                const position = el("m_position").value;
                const priority = el("m_priority").value;

                const mode = getMode();
                const fd = new FormData();

                fd.append("page", page);
                fd.append("position", position);
                if (priority !== "") fd.append("priority", priority);

                fd.append("slot_mode", mode);
                fd.append("slotMode", mode);

                fd.append("slot_type", "image");
                fd.append("slotType", "image");

                const linkUrl = (el("m_linkUrl").value || "").trim();
                const textContent = (el("m_textContent").value || "").trim();
                fd.append("link_url", linkUrl);
                fd.append("linkUrl", linkUrl);
                fd.append("text_content", textContent);
                fd.append("textContent", textContent);

                const imageUrl = (el("m_imageUrl").value || "").trim();
                fd.append("image_url", imageUrl);
                fd.append("imageUrl", imageUrl);

                fd.append("keepImage", el("m_keepImage").checked ? "true" : "false");
                fd.append("keep_image", el("m_keepImage").checked ? "true" : "false");

                fd.append("clearImage", el("m_clearImage").checked ? "true" : "false");
                fd.append("clear_image", el("m_clearImage").checked ? "true" : "false");

                const file = el("m_imageFile").files && el("m_imageFile").files[0];
                if (file) fd.append("image", file);

                // ✅ 업종도 같이 보내서(서버가 받으면 저장) 프론트 표시가 끊기지 않게
                const cat = (state.selectedCategory || "").trim();
                fd.append("category", cat);
                fd.append("business_category", cat);
                fd.append("businessCategory", cat);

                if (mode === "store") {
                    const storeId = (el("m_storeId").value || "").trim();
                    if (!storeId) throw new Error("가게연결 모드인데 store_id가 비어있음(가게 선택 먼저)");

                    const tableSource = (el("m_tableSource").value || "").trim() || DEFAULT_TABLE_SOURCE;
                    const businessNo = (el("m_businessNo").value || "").trim();
                    const businessName = (el("m_businessName").value || "").trim();

                    fd.append("table_source", tableSource);
                    fd.append("tableSource", tableSource);

                    fd.append("store_id", storeId);
                    fd.append("storeId", storeId);

                    fd.append("business_no", businessNo);
                    fd.append("businessNo", businessNo);

                    fd.append("business_name", businessName);
                    fd.append("businessName", businessName);
                } else {
                    fd.append("table_source", "");
                    fd.append("tableSource", "");
                    fd.append("store_id", "");
                    fd.append("storeId", "");
                    fd.append("business_no", "");
                    fd.append("businessNo", "");
                    fd.append("business_name", "");
                    fd.append("businessName", "");
                }

                await apiUpsertSlot(fd);

                setStatus("저장 완료");

                await loadAndRender();
                bindAdminClicks();
                await loadSlotIntoModal();
            } catch (e) {
                console.error(e);
                setStatus("");
                alert(e.message || "저장 오류");
            }
        }

        // ---------- init ----------
        document.addEventListener("DOMContentLoaded", async () => {
            buildPowerSliderDom();
            buildBestGridDom();
            bindAdminClicks();

            await loadAndRender();
            initPowerSlider();

            el("m_imageFile").addEventListener("change", () => {
                const f = el("m_imageFile").files && el("m_imageFile").files[0];
                if (!f) return;
                setPreview(URL.createObjectURL(f));
            });
        });
    </script>
</body>

</html>