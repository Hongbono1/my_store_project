<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>ncategory2 매니저</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .neo-card {
            background: rgba(255, 255, 255, .8);
            border-radius: 1.2rem;
            box-shadow: 6px 6px 16px #d9e0ec, -6px -6px 16px #ffffff;
            backdrop-filter: blur(16px) saturate(120%);
            transition: all .25s ease;
        }

        .neo-card:hover {
            transform: translateY(-2px);
            box-shadow: 4px 4px 12px #cfd8e6, -4px -4px 12px #ffffff, 0 8px 24px rgba(80, 130, 255, .12);
        }

        .btn-3d {
            background: linear-gradient(90deg, #6dd5fa, #2980b9);
            border-radius: 1.1rem;
            padding: .45rem 1.1rem;
            font-weight: 700;
            color: #fff;
            box-shadow: 0 4px 0 #2393b3, 0 8px 16px rgba(0, 64, 128, .14);
            transition: all .15s;
        }

        .btn-3d:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #2393b3, 0 4px 10px rgba(0, 64, 128, .16);
        }

        .pill {
            display: inline-flex;
            align-items: center;
            gap: .35rem;
            padding: .25rem .6rem;
            border-radius: 9999px;
            background: rgba(255, 255, 255, .75);
            box-shadow: inset 0 0 0 1px rgba(148, 163, 184, .35);
            font-size: 12px;
            color: #334155;
            white-space: nowrap;
        }

        .muted {
            color: #64748b;
        }
    </style>
</head>

<body class="bg-gradient-to-br from-blue-50 via-white to-blue-100 min-h-screen text-slate-800">
    <div class="max-w-7xl mx-auto px-4 py-8">

        <!-- 상단 타이틀 -->
        <div class="neo-card p-6 mb-6">
            <div class="flex items-start justify-between gap-4 flex-wrap">
                <div>
                    <h1 class="text-2xl font-extrabold text-blue-700">ncategory2 매니저</h1>
                    <p class="text-sm text-slate-600 mt-1">슬롯 카드 클릭 → 모달 편집 → 저장/삭제</p>
                </div>
                <div class="flex items-center gap-2 flex-wrap">
                    <span class="pill">PAGE: <b>ncategory2</b></span>
                    <span class="pill">PRIORITY: <b>1</b></span>
                    <button id="btnReload"
                        class="px-4 py-2 rounded-xl bg-white/70 font-bold hover:bg-white">새로고침</button>
                </div>
            </div>
        </div>

        <!-- ✅ 실제 ncategory2 페이지 섹션 구조에 맞게 -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">

            <!-- 좌측: 사이드 광고 -->
            <aside class="lg:col-span-4 neo-card p-5">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-bold">사이드 광고</h2>
                    <span class="text-xs text-slate-600">여러 개 슬롯</span>
                </div>
                <div id="slots_sidebar" class="space-y-4 mt-4"></div>
            </aside>

            <!-- 우측: 메인 섹션 -->
            <main class="lg:col-span-8 space-y-6">

                <!-- 메인 배너 -->
                <section class="neo-card p-5">
                    <div class="flex items-center justify-between gap-3 flex-wrap">
                        <h2 class="text-xl font-bold">메인 배너</h2>
                        <span class="text-xs text-slate-600">이미지/텍스트/링크</span>
                    </div>
                    <div id="slots_banner" class="mt-4 space-y-4"></div>
                </section>

                <!-- MVP / HIGHLIGHT -->
                <section class="neo-card p-5">
                    <div class="flex items-center justify-between gap-3 flex-wrap">
                        <h2 class="text-xl font-bold">MVP / HIGHLIGHT</h2>
                        <span class="text-xs text-slate-600">고정 박스</span>
                    </div>
                    <div id="slots_fixed" class="mt-4 space-y-4"></div>
                </section>

                <!-- BEST -->
                <section class="neo-card p-5">
                    <div class="flex items-center justify-between gap-3 flex-wrap">
                        <h2 class="text-xl font-bold">최고의 가게 (BEST)</h2>
                        <span class="text-xs text-slate-600">1~6</span>
                    </div>
                    <div id="slots_best" class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
                </section>

                <!-- 파워 광고 -->
                <section class="neo-card p-5">
                    <div class="flex items-center justify-between gap-3 flex-wrap">
                        <h2 class="text-xl font-bold">파워 광고</h2>
                        <span class="text-xs text-slate-600">총 9개 슬롯(1~9)</span>
                    </div>
                    <div id="slots_power" class="mt-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                </section>

                <!-- 하단 박스 -->
                <section class="neo-card p-5">
                    <div class="flex items-center justify-between gap-3 flex-wrap">
                        <h2 class="text-xl font-bold">하단 박스</h2>
                        <span class="text-xs text-slate-600">1~2</span>
                    </div>
                    <div id="slots_bottom" class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
                </section>

            </main>
        </div>
    </div>

    <!-- 모달 -->
    <div id="modal" class="fixed inset-0 hidden items-center justify-center z-50">
        <div id="modalBackdrop" class="absolute inset-0 bg-black/40"></div>

        <div class="relative w-[95vw] max-w-3xl neo-card p-6">
            <div class="flex items-center justify-between">
                <h3 id="modalTitle" class="text-xl font-extrabold">슬롯 편집</h3>
                <button id="modalClose" class="px-3 py-1 rounded-lg bg-white/70 hover:bg-white">✕</button>
            </div>

            <div class="mt-5 grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="neo-card p-4">
                    <div class="text-sm font-bold mb-2">현재 미리보기</div>
                    <img id="previewImg" src="" alt="" class="w-full h-44 object-cover rounded-xl bg-white" />
                    <div class="mt-2 text-xs text-slate-600 break-all" id="previewUrl"></div>
                </div>

                <div class="neo-card p-4">
                    <div class="text-sm font-bold mb-3">기본 정보</div>

                    <input type="hidden" id="f_page" value="ncategory2" />
                    <input type="hidden" id="f_position" />
                    <input type="hidden" id="f_priority" value="1" />

                    <label class="block text-xs font-bold text-slate-700">텍스트</label>
                    <input id="f_text" class="w-full mt-1 px-3 py-2 rounded-xl bg-white/70" placeholder="상호명 등" />

                    <label class="block text-xs font-bold text-slate-700 mt-3">링크 URL</label>
                    <input id="f_link" class="w-full mt-1 px-3 py-2 rounded-xl bg-white/70"
                        placeholder="/ndetail.html?id=1&type=combined" />

                    <label class="block text-xs font-bold text-slate-700 mt-3">이미지 업로드</label>
                    <input id="f_image" type="file" accept="image/*" class="w-full mt-1" />

                    <div class="grid grid-cols-2 gap-3 mt-3">
                        <div>
                            <label class="block text-xs font-bold text-slate-700">시작일</label>
                            <input id="f_start" type="date" class="w-full mt-1 px-3 py-2 rounded-xl bg-white/70" />
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-700">종료일</label>
                            <input id="f_end" type="date" class="w-full mt-1 px-3 py-2 rounded-xl bg-white/70" />
                            <label class="flex items-center gap-2 text-xs mt-2">
                                <input id="f_noend" type="checkbox" />
                                종료 없음(no_end)
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 가게 검색 -->
            <div class="neo-card p-4 mt-4">
                <div class="flex items-end gap-3 flex-wrap">
                    <div>
                        <div class="text-xs font-bold">가게명/업종 검색</div>
                        <input id="s_q" class="mt-1 px-3 py-2 rounded-xl bg-white/70" placeholder="예: 하늘식당" />
                    </div>
                    <div>
                        <div class="text-xs font-bold">사업자번호 검색</div>
                        <input id="s_biz" class="mt-1 px-3 py-2 rounded-xl bg-white/70" placeholder="숫자만/일부 가능" />
                    </div>
                    <button id="btnSearch" class="btn-3d">검색</button>
                    <div class="text-xs text-slate-600">검색 결과에서 “선택”하면 텍스트/링크 자동 채움</div>
                </div>

                <div id="searchResults" class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3"></div>
            </div>

            <div class="mt-5 flex items-center justify-between gap-3">
                <button id="btnDelete"
                    class="px-4 py-2 rounded-xl bg-red-500 text-white font-bold hover:bg-red-600">삭제</button>
                <div class="flex gap-2">
                    <button id="btnCancel" class="px-4 py-2 rounded-xl bg-white/70 font-bold hover:bg-white">취소</button>
                    <button id="btnSave" class="btn-3d">저장</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = "/ncategory2manager/ad";
        const PAGE = "ncategory2";
        const PRIORITY = 1;

        // ✅ ncategory2 실페이지 섹션 구조에 맞춘 슬롯 정의
        const SLOT_DEFS = {
            // 사이드 광고: 2개 → 4개 (원하면 여기만 더 늘리면 됨)
            sidebar: [
                { position: "ncategory2_sidebar_ad_1", title: "사이드 광고 1" },
                { position: "ncategory2_sidebar_ad_2", title: "사이드 광고 2" },
                { position: "ncategory2_sidebar_ad_3", title: "사이드 광고 3" },
                { position: "ncategory2_sidebar_ad_4", title: "사이드 광고 4" },
            ],

            // 메인 배너
            banner: [
                { position: "ncategory2_main_banner", title: "메인 배너" },
            ],

            // MVP / Highlight
            fixed: [
                { position: "ncategory2_mvp", title: "MVP" },
                { position: "ncategory2_highlight", title: "HIGHLIGHT" },
            ],

            // BEST 1~6
            best: [
                { position: "ncategory2_best_1", title: "BEST 1" },
                { position: "ncategory2_best_2", title: "BEST 2" },
                { position: "ncategory2_best_3", title: "BEST 3" },
                { position: "ncategory2_best_4", title: "BEST 4" },
                { position: "ncategory2_best_5", title: "BEST 5" },
                { position: "ncategory2_best_6", title: "BEST 6" },
            ],

            // 파워 광고 1~9
            power: Array.from({ length: 9 }).map((_, i) => ({
                position: `ncategory2_power_${i + 1}`,
                title: `파워 광고 ${i + 1}`,
            })),

            // 하단 박스 1~2
            bottom: [
                { position: "ncategory2_bottom_1", title: "하단 박스 1" },
                { position: "ncategory2_bottom_2", title: "하단 박스 2" },
            ],
        };

        function esc(s) {
            return String(s ?? "").replace(/[&<>"']/g, m => ({
                '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
            }[m]));
        }

        async function apiGetSlot(position) {
            const url = `${API_BASE}/slot?page=${encodeURIComponent(PAGE)}&position=${encodeURIComponent(position)}&priority=${PRIORITY}`;
            const r = await fetch(url);
            return await r.json();
        }

        async function apiSaveSlot(formData) {
            const r = await fetch(`${API_BASE}/slot`, { method: "POST", body: formData });
            return await r.json();
        }

        async function apiDeleteSlot(position) {
            const url = `${API_BASE}/slot?page=${encodeURIComponent(PAGE)}&position=${encodeURIComponent(position)}&priority=${PRIORITY}`;
            const r = await fetch(url, { method: "DELETE" });
            return await r.json();
        }

        async function apiSearchStore(q, bizNo) {
            const url = `${API_BASE}/store/search?q=${encodeURIComponent(q || "")}&bizNo=${encodeURIComponent(bizNo || "")}`;
            const r = await fetch(url);
            return await r.json();
        }

        function slotCardHtml(def, slot) {
            const img = slot?.image_url || "/uploads/no-image.png";
            const text = slot?.text_content || "";
            const link = slot?.link_url || "";
            const has = (slot?.image_url || slot?.text_content || slot?.link_url || slot?.start_at || slot?.end_at || slot?.no_end) ? true : false;

            return `
        <button class="w-full text-left neo-card p-4" data-position="${esc(def.position)}" data-title="${esc(def.title)}">
          <div class="flex gap-3">
            <img src="${esc(img)}" class="w-20 h-20 rounded-xl object-cover bg-white" alt="">
            <div class="flex-1 min-w-0">
              <div class="flex items-center justify-between gap-2">
                <div class="font-extrabold truncate">${esc(def.title)}</div>
                <span class="text-[11px] ${has ? "text-emerald-600" : "text-slate-400"} font-bold">
                  ${has ? "SET" : "EMPTY"}
                </span>
              </div>

              <div class="text-xs text-slate-600 mt-1 line-clamp-2">${esc(text)}</div>
              <div class="text-[11px] text-slate-500 mt-1 break-all line-clamp-2">${esc(link)}</div>

              <div class="mt-2 flex flex-wrap items-center gap-2">
                <span class="px-2 py-1 rounded-lg bg-blue-600 text-white text-xs font-bold">편집</span>
                <span class="text-xs text-slate-500">${esc(def.position)}</span>
              </div>
            </div>
          </div>
        </button>
      `;
        }

        async function renderGroup(defs, rootEl) {
            rootEl.innerHTML = "";
            for (const def of defs) {
                let data;
                try {
                    data = await apiGetSlot(def.position);
                } catch (e) {
                    data = null;
                }
                const slot = data?.slot || null;
                rootEl.insertAdjacentHTML("beforeend", slotCardHtml(def, slot));
            }
        }

        async function renderAll() {
            const sidebarEl = document.getElementById("slots_sidebar");
            const bannerEl = document.getElementById("slots_banner");
            const fixedEl = document.getElementById("slots_fixed");
            const bestEl = document.getElementById("slots_best");
            const powerEl = document.getElementById("slots_power");
            const bottomEl = document.getElementById("slots_bottom");

            await renderGroup(SLOT_DEFS.sidebar, sidebarEl);
            await renderGroup(SLOT_DEFS.banner, bannerEl);
            await renderGroup(SLOT_DEFS.fixed, fixedEl);
            await renderGroup(SLOT_DEFS.best, bestEl);
            await renderGroup(SLOT_DEFS.power, powerEl);
            await renderGroup(SLOT_DEFS.bottom, bottomEl);

            document.querySelectorAll("button[data-position]").forEach(btn => {
                btn.addEventListener("click", async () => {
                    const pos = btn.dataset.position;
                    const title = btn.dataset.title;
                    await openModal(pos, title);
                });
            });
        }

        // ----- 모달 -----
        const modal = document.getElementById("modal");
        const modalTitle = document.getElementById("modalTitle");
        const previewImg = document.getElementById("previewImg");
        const previewUrl = document.getElementById("previewUrl");

        const f_position = document.getElementById("f_position");
        const f_text = document.getElementById("f_text");
        const f_link = document.getElementById("f_link");
        const f_image = document.getElementById("f_image");
        const f_start = document.getElementById("f_start");
        const f_end = document.getElementById("f_end");
        const f_noend = document.getElementById("f_noend");

        let currentPosition = "";
        let currentSlot = null;

        function showModal() { modal.classList.remove("hidden"); modal.classList.add("flex"); }
        function hideModal() { modal.classList.add("hidden"); modal.classList.remove("flex"); }

        async function openModal(position, title) {
            currentPosition = position;
            modalTitle.textContent = `슬롯 편집 - ${title}`;
            f_position.value = position;
            f_image.value = "";

            const data = await apiGetSlot(position);
            currentSlot = data?.slot || null;

            const img = currentSlot?.image_url || "/uploads/no-image.png";
            previewImg.src = img;
            previewUrl.textContent = img;

            f_text.value = currentSlot?.text_content || "";
            f_link.value = currentSlot?.link_url || "";
            f_start.value = (currentSlot?.start_at || "").slice(0, 10);
            f_end.value = (currentSlot?.end_at || "").slice(0, 10);
            f_noend.checked = !!currentSlot?.no_end;

            document.getElementById("searchResults").innerHTML = "";
            showModal();
        }

        // 닫기 이벤트
        document.getElementById("modalClose").addEventListener("click", hideModal);
        document.getElementById("btnCancel").addEventListener("click", hideModal);
        document.getElementById("modalBackdrop").addEventListener("click", hideModal);
        window.addEventListener("keydown", (e) => { if (e.key === "Escape") hideModal(); });

        // 저장
        document.getElementById("btnSave").addEventListener("click", async () => {
            const fd = new FormData();
            fd.append("page", PAGE);
            fd.append("position", currentPosition);
            fd.append("priority", String(PRIORITY));
            fd.append("text_content", f_text.value || "");
            fd.append("link_url", f_link.value || "");
            fd.append("start_at", f_start.value || "");
            fd.append("end_at", f_end.value || "");
            fd.append("no_end", f_noend.checked ? "true" : "false");

            if (f_image.files && f_image.files[0]) {
                fd.append("slotImage", f_image.files[0]);
            }

            const res = await apiSaveSlot(fd);
            if (!res?.ok) {
                alert("저장 실패: " + (res?.message || "unknown"));
                return;
            }

            hideModal();
            await renderAll();
        });

        // 삭제
        document.getElementById("btnDelete").addEventListener("click", async () => {
            if (!confirm("이 슬롯을 삭제할까요? (이미지 파일은 삭제하지 않습니다)")) return;
            const res = await apiDeleteSlot(currentPosition);
            if (!res?.ok) {
                alert("삭제 실패: " + (res?.message || "unknown"));
                return;
            }
            hideModal();
            await renderAll();
        });

        // 가게 검색
        document.getElementById("btnSearch").addEventListener("click", async () => {
            const q = document.getElementById("s_q").value || "";
            const biz = document.getElementById("s_biz").value || "";
            const data = await apiSearchStore(q, biz);

            const root = document.getElementById("searchResults");
            root.innerHTML = "";

            const stores = data?.stores || [];
            if (stores.length === 0) {
                root.innerHTML = `<div class="text-sm text-slate-600">검색 결과 없음</div>`;
                return;
            }

            stores.forEach(s => {
                const link = buildStoreLink(s.store_type, s.id);
                const card = document.createElement("div");
                card.className = "neo-card p-3";
                card.innerHTML = `
          <div class="font-bold">${esc(s.business_name)}</div>
          <div class="text-xs text-slate-600 mt-1">${esc(s.category || "")}</div>
          <div class="text-[11px] text-slate-500 mt-1">사업자: ${esc(s.business_no || "")}</div>
          <div class="text-[11px] text-slate-500 mt-1 break-all">링크: ${esc(link)}</div>
          <button class="mt-2 px-3 py-1 rounded-lg bg-blue-600 text-white text-xs font-bold hover:bg-blue-700">선택</button>
        `;
                card.querySelector("button").addEventListener("click", () => {
                    f_text.value = s.business_name || "";
                    f_link.value = link;
                });
                root.appendChild(card);
            });
        });

        // ✅ 프로젝트 링크 규칙
        function buildStoreLink(store_type, id) {
            if (store_type === "combined") return `/ndetail.html?id=${id}&type=combined`;
            if (store_type === "store_info") return `/ndetail.html?id=${id}&type=store_info`;
            if (store_type === "food") return `/ndetail.html?id=${id}&type=food`;
            return "#";
        }

        // 새로고침 버튼
        document.getElementById("btnReload").addEventListener("click", renderAll);

        // 시작
        renderAll();
    </script>
</body>

</html>