<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ncategory2 매니저</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* ncategory2와 동일 */
        .neo-card {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 1.2rem;
            box-shadow: 6px 6px 16px #d9e0ec, -6px -6px 16px #ffffff;
            backdrop-filter: blur(16px) saturate(120%);
            transition: all .25s ease;
        }

        .neo-card:hover {
            transform: translateY(-4px);
            box-shadow: 4px 4px 12px #cfd8e6, -4px -4px 12px #ffffff, 0 8px 24px rgba(80, 130, 255, 0.15);
        }

        .btn-3d {
            background: linear-gradient(90deg, #6dd5fa, #2980b9);
            border-radius: 1.3rem;
            padding: .5rem 1.5rem;
            font-weight: bold;
            color: white;
            box-shadow: 0 4px 0 #2393b3, 0 8px 16px rgba(0, 64, 128, 0.14);
            transition: all .15s;
            user-select: none;
        }

        .btn-3d:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #2393b3, 0 4px 10px rgba(0, 64, 128, 0.16);
        }

        .sidebar-scroll {
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: transparent transparent;
        }

        .sidebar-scroll:hover {
            scrollbar-color: #cbd5e1 transparent;
        }

        .sidebar-scroll::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar-scroll::-webkit-scrollbar-track {
            background: transparent;
        }

        .sidebar-scroll::-webkit-scrollbar-thumb {
            background: transparent;
            border-radius: 9999px;
        }

        .sidebar-scroll:hover::-webkit-scrollbar-thumb {
            background: #cbd5e1;
        }

        .sidebar-scroll::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* 관리자 클릭용(레이아웃은 그대로, 표시만 아주 작게) */
        .admin-slot {
            cursor: pointer;
            position: relative;
        }

        .admin-slot::after {
            content: "관리";
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 12px;
            font-weight: 900;
            padding: 6px 10px;
            border-radius: 9999px;
            background: rgba(255, 255, 255, 0.78);
            border: 1px solid rgba(59, 130, 246, 0.25);
            backdrop-filter: blur(8px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.08);
            color: rgba(30, 64, 175, 0.95);
            pointer-events: none;
        }

        /* ✅ field/divider (모달 입력 가시성 보장) */
        .field {
            width: 100%;
            padding: .65rem .85rem;
            border-radius: 1rem;
            border: 1px solid rgba(148, 163, 184, .75);
            background: rgba(255, 255, 255, 0.92);
            outline: none;
        }

        .field:focus {
            border-color: rgba(59, 130, 246, .85);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, .18);
        }

        .divider {
            height: 1px;
            background: rgba(148, 163, 184, 0.25);
            margin: 10px 0;
        }

        /* ✅ 모달 스타일 */
        #slotModal {
            position: fixed;
            inset: 0;
            z-index: 9999;
        }

        #slotModal .modal-backdrop {
            position: absolute;
            inset: 0;
            background: rgba(15, 23, 42, .55);
        }

        #slotModal .modal-panel {
            position: relative;
            margin: 0 auto;
            width: min(980px, calc(100% - 36px));
            max-height: 88vh;
            overflow: auto;
            top: 50%;
            transform: translateY(-50%);
        }

        #slotModal .modal-card {
            border-radius: 1.25rem;
            background: rgba(255, 255, 255, .96);
            border: 2px solid rgba(59, 130, 246, .18);
            box-shadow: 0 18px 60px rgba(0, 0, 0, .25);
            backdrop-filter: blur(14px);
            overflow: hidden;
        }
    </style>
</head>

<body class="bg-gradient-to-br from-blue-50 via-white to-blue-100 min-h-screen text-gray-800">
    <div id="header-placeholder"></div>

    <header class="py-6 text-center">
        <h1 class="text-3xl font-bold text-blue-700">우리동네 가게</h1>
        <p class="text-gray-600 mt-1">ncategory2 매니저(레이아웃 동일) - combined_store_info 연결</p>
    </header>

    <div class="max-w-6xl mx-auto grid grid-cols-12 gap-6 py-6 px-4">

        <!-- 좌측 사이드바 (원본 유지) -->
        <aside class="col-span-3 neo-card p-3 h-full max-h-[1346px] sidebar-scroll">
            <h2 class="font-bold text-2xl mb-4 text-center">CATEGORY</h2>
            <ul class="space-y-3">
                <li class="mb-5">
                    <button
                        class="w-full text-left pl-16 pr-3 py-2 neo-card flex justify-between items-center font-bold text-xl"
                        onclick="toggleSub(this)">
                        병 원 <span>▼</span>
                    </button>
                    <ul class="ml-4 mt-1 space-y-3 hidden">
                        <li><a href="/subcategory.html?type=hospital&category=종합병원"
                                class="block px-5 py-2 neo-card text-center">종합병원</a></li>
                        <li><a href="/subcategory.html?type=hospital&category=내과"
                                class="block px-3 py-2 neo-card text-center">내과</a></li>
                        <li><a href="/subcategory.html?type=hospital&category=치과"
                                class="block px-3 py-2 neo-card text-center">치과</a></li>
                        <li><a href="/subcategory.html?type=hospital&category=소아과"
                                class="block px-3 py-2 neo-card text-center">소아과</a></li>
                        <li><a href="/subcategory.html?type=hospital&category=정형외과"
                                class="block px-3 py-2 neo-card text-center">정형외과</a></li>
                        <li><a href="/subcategory.html?type=hospital&category=산부인과"
                                class="block px-3 py-2 neo-card text-center">산부인과</a></li>
                        <li><a href="/subcategory.html?type=hospital&category=한의원"
                                class="block px-3 py-2 neo-card text-center">한의원</a></li>
                        <li><a href="/subcategory.html?type=hospital&category=기타"
                                class="block px-3 py-2 neo-card text-center">기타</a></li>
                    </ul>
                </li>
            </ul>

            <a href="#" class="neo-card mt-6 p-4 text-center border-2 border-dashed border-blue-300 admin-slot block"
                data-position="ncategory2_sidebar_ad" data-label="사이드 광고">
                <h3 class="font-bold text-lg mb-2">광고 영역</h3>
                <p class="text-sm text-gray-600">이곳은 광고 배너/이미지가 들어갈 박스입니다.</p>
                <img data-role="img" src="" alt="광고 이미지"
                    class="mt-3 w-full h-48 sm:h-40 object-cover rounded-xl hidden">
                <div data-role="noimg" class="mt-3 text-xs text-slate-500">NO IMG</div>
            </a>
        </aside>

        <!-- 중앙 메인 -->
        <main class="col-span-9 space-y-8">

            <!-- ✅ Premium 카테고리 박스도 슬롯(클릭→모달)로 변경 -->
            <section class="relative h-60 neo-card overflow-hidden admin-slot" data-position="ncategory2_premium"
                data-label="Premium 카테고리">

                <!-- 슬롯 이미지(있으면 표시) -->
                <img data-role="img" data-default-src="/uploads/no-image.png" src="/uploads/no-image.png"
                    class="absolute inset-0 w-full h-full object-cover" alt="Premium Banner">

                <!-- 오버레이 -->
                <div class="absolute inset-0 bg-white/35 backdrop-blur-[2px]"></div>

                <div class="relative h-full flex items-center justify-center">
                    <div class="text-center neo-card px-6 py-4">
                        <h1 class="text-3xl font-bold mb-2" data-role="name">Premium 카테고리</h1>
                        <p class="text-gray-700 text-sm" data-role="desc">카테고리 설명 문구를 여기에 넣습니다.</p>
                    </div>
                </div>
            </section>

            <!-- 파워 광고 -->
            <section class="mt-10">
                <h2 class="font-bold text-2xl text-purple-600 text-center mb-4">강력 추천</h2>

                <div id="powerViewport" class="relative overflow-hidden">
                    <div id="powerAdTrack"
                        class="flex transition-transform duration-500 ease-in-out will-change-transform"></div>

                    <button id="prevBtn"
                        class="absolute left-0 top-1/2 -translate-y-1/2 bg-white shadow rounded-full px-3 py-2">‹</button>
                    <button id="nextBtn"
                        class="absolute right-0 top-1/2 -translate-y-1/2 bg-white shadow rounded-full px-3 py-2">›</button>
                </div>
            </section>

            <!-- 최고의 가게 영역 -->
            <section class="grid grid-cols-12 gap-6 items-stretch">
                <div class="col-span-3 h-full">
                    <div class="neo-card p-4 w-full h-full flex flex-col gap-4">

                        <div class="flex-1 flex flex-col">
                            <h2 class="font-bold text-2xl text-blue-600 text-center mb-3">MVP</h2>
                            <a href="#"
                                class="neo-card p-0 overflow-hidden relative rounded-2xl h-full border-2 border-blue-500 admin-slot"
                                data-position="ncategory2_mvp" data-label="MVP">
                                <img data-role="img" data-default-src="/uploads/no-image.png"
                                    src="/uploads/no-image.png" class="w-full h-full object-cover" alt="MVP">
                                <div
                                    class="absolute left-3 right-3 bottom-3 bg-white/70 backdrop-blur-md rounded-xl shadow px-4 py-2 text-center">
                                    <div class="font-bold text-lg leading-tight" data-role="name">상호명 Top</div>
                                    <div class="text-sm text-slate-600" data-role="category">업종: 한식</div>
                                </div>
                            </a>
                        </div>

                        <div class="flex-1 flex flex-col">
                            <h2 class="font-bold text-2xl text-yellow-600 text-center mb-3">HIGHLIGHT</h2>
                            <a href="#"
                                class="neo-card p-0 overflow-hidden relative rounded-2xl h-full border-2 border-yellow-500 admin-slot"
                                data-position="ncategory2_highlight" data-label="HIGHLIGHT">
                                <img data-role="img" data-default-src="/uploads/no-image.png"
                                    src="/uploads/no-image.png" class="w-full h-full object-cover" alt="HIGHLIGHT">
                                <div
                                    class="absolute left-3 right-3 bottom-3 bg-white/70 backdrop-blur-md rounded-xl shadow px-4 py-2 text-center">
                                    <div class="font-bold text-lg leading-tight" data-role="name">상호명 Bottom</div>
                                    <div class="text-sm text-slate-600" data-role="category">업종: 카페</div>
                                </div>
                            </a>
                        </div>

                    </div>
                </div>

                <div class="col-span-9 flex flex-col gap-6">
                    <div class="neo-card p-5">
                        <h2 class="font-bold mb-3 text-2xl text-center">최고의 가게</h2>
                        <div id="bestGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                    </div>
                </div>
            </section>

            <section class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- 하단 박스 1 -->
                <a href="#" class="neo-card p-0 overflow-hidden relative rounded-2xl admin-slot block"
                    data-position="ncategory2_bottom_1" data-label="하단 박스 1">
                    <div class="w-full h-44 md:h-52 bg-white/40 flex items-center justify-center">
                        <img data-role="img" src="" class="w-full h-full object-cover hidden" alt="하단1">
                        <div data-role="noimg" class="text-xs text-slate-500">NO IMG</div>
                    </div>

                    <!-- 하단 캡션(기존 스타일과 동일하게) -->
                    <div
                        class="absolute left-3 right-3 bottom-3 bg-white/70 backdrop-blur-md rounded-xl shadow px-4 py-3 text-center">
                        <div class="font-bold text-lg leading-tight" data-role="name">하단 박스 1</div>
                        <div class="text-sm text-slate-600" data-role="category">업종:</div>
                    </div>
                </a>

                <!-- 하단 박스 2 -->
                <a href="#" class="neo-card p-0 overflow-hidden relative rounded-2xl admin-slot block"
                    data-position="ncategory2_bottom_2" data-label="하단 박스 2">
                    <div class="w-full h-44 md:h-52 bg-white/40 flex items-center justify-center">
                        <img data-role="img" src="" class="w-full h-full object-cover hidden" alt="하단2">
                        <div data-role="noimg" class="text-xs text-slate-500">NO IMG</div>
                    </div>

                    <div
                        class="absolute left-3 right-3 bottom-3 bg-white/70 backdrop-blur-md rounded-xl shadow px-4 py-3 text-center">
                        <div class="font-bold text-lg leading-tight" data-role="name">하단 박스 2</div>
                        <div class="text-sm text-slate-600" data-role="category">업종:</div>
                    </div>
                </a>
            </section>

            <!-- 오른쪽 하단 네비 -->
            <div class="fixed bottom-6 right-6 flex flex-col items-center gap-4 z-50">
                <div class="flex flex-col items-center">
                    <button onclick="goBack()"
                        class="w-14 h-14 flex items-center justify-center rounded-full bg-gradient-to-br from-gray-100 to-gray-200 text-gray-700 shadow hover:from-gray-200 hover:to-gray-300 transition">
                        ←
                    </button>
                    <span class="text-xs mt-1 text-gray-600 font-semibold">이전</span>
                </div>

                <div class="flex flex-col items-center">
                    <button onclick="goNext()"
                        class="w-14 h-14 flex items-center justify-center rounded-full bg-gradient-to-br from-gray-100 to-gray-200 text-gray-700 shadow hover:from-gray-200 hover:to-gray-300 transition">
                        →
                    </button>
                    <span class="text-xs mt-1 text-gray-600 font-semibold">다음</span>
                </div>

                <div class="flex flex-col items-center">
                    <a href="/index.html"
                        class="w-14 h-14 flex items-center justify-center rounded-full bg-gradient-to-br from-blue-500 to-blue-600 text-white shadow hover:from-blue-600 hover:to-blue-700 transition">
                        🏠
                    </a>
                    <span class="text-xs mt-1 text-gray-600 font-semibold">홈</span>
                </div>
            </div>

            <div id="footer-placeholder"></div>

            <!-- ✅ 공통 모달 (id를 slotModal로 통일) -->
            <div id="slotModal" class="hidden" data-page="" data-position="" data-current-image="">
                <div class="modal-backdrop"></div>
                <div class="modal-panel">
                    <div class="modal-card">
                        <!-- 헤더 -->
                        <div class="p-6 sticky top-0 bg-white/90 backdrop-blur border-b border-slate-100 z-10">
                            <div class="flex items-start justify-between gap-4">
                                <div>
                                    <h3 id="modalTitle" class="text-xl sm:text-2xl font-extrabold">슬롯 수정</h3>
                                    <p class="text-xs text-gray-500 mt-1">
                                        page: <b>ncategory2</b> /
                                        position: <span id="modalPositionText" class="font-semibold"></span>
                                    </p>
                                </div>

                                <div class="flex items-center gap-2">
                                    <!-- 사용법 -->
                                    <div class="relative">
                                        <button type="button" id="adHelpBtn"
                                            class="inline-flex items-center gap-2 rounded-xl border border-blue-200 bg-white/80 px-3 py-1.5 text-sm font-semibold text-blue-700 shadow-sm hover:bg-white"
                                            aria-expanded="false" aria-controls="adHelpPopover" title="사용법 보기">
                                            <span
                                                class="inline-flex h-5 w-5 items-center justify-center rounded-full bg-blue-600 text-white text-xs leading-none">?</span>
                                            사용법
                                        </button>

                                        <div id="adHelpPopover"
                                            class="hidden absolute right-0 mt-2 w-[min(420px,calc(100vw-2rem))] rounded-2xl border border-blue-200 bg-white/95 p-4 shadow-xl backdrop-blur">
                                            <div class="flex items-start justify-between gap-3">
                                                <div class="font-extrabold text-slate-800">✅ 사용 흐름</div>
                                                <button type="button" id="adHelpCloseBtn"
                                                    class="rounded-lg px-2 py-1 text-xs font-bold text-slate-500 hover:bg-slate-100">닫기</button>
                                            </div>

                                            <ol
                                                class="mt-3 space-y-2 text-sm text-slate-700 leading-relaxed list-decimal pl-5">
                                                <li><b>/admin/ncategory2manager.html</b> 접속</li>
                                                <li>원하는 슬롯 클릭 → <b>모달 열림</b></li>
                                                <li><b>우선순위</b> 입력 → 내용/이미지/기간 입력 → <b>저장</b></li>
                                                <li>같은 슬롯에서 다른 우선순위(2,3…)를 선택해 추가 후보 등록 가능</li>
                                            </ol>

                                            <div class="mt-3 rounded-xl bg-blue-50 px-3 py-2 text-xs text-blue-900">
                                                ※ 실제 노출은 “기간 조건이 맞는 후보 중 우선순위 숫자가 가장 작은 것”이 선택됩니다.
                                            </div>
                                        </div>
                                    </div>

                                    <button id="btnCloseModal"
                                        class="px-3 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-slate-700 text-sm">
                                        닫기
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- 본문 -->
                        <div class="p-6 space-y-6">

                            <!-- 텍스트 전용 슬롯 안내 -->
                            <div id="textOnlyHint" class="hidden rounded-2xl border border-slate-100 bg-slate-50 p-4">
                                <div class="text-sm font-bold text-slate-800">📝 이 슬롯은 텍스트 전용입니다.</div>
                                <div class="mt-1 text-xs text-slate-500">
                                    이미지/가게연결/링크 입력은 숨김 처리됩니다. (글만 작성)
                                </div>
                            </div>

                            <!-- 모드 선택 -->
                            <div id="modeBlock" class="rounded-xl border border-slate-100 bg-slate-50 p-4">
                                <p class="text-sm font-semibold mb-3">광고 방식 선택</p>
                                <div class="flex flex-wrap gap-4">
                                    <label class="flex items-center gap-2 text-sm">
                                        <input type="radio" name="slotMode" value="image" class="accent-blue-600"
                                            checked>
                                        <span>이미지 배너</span>
                                    </label>
                                    <label class="flex items-center gap-2 text-sm">
                                        <input type="radio" name="slotMode" value="store" class="accent-emerald-600">
                                        <span>가게 연결</span>
                                    </label>
                                    <label class="flex items-center gap-2 text-sm">
                                        <input type="radio" name="slotMode" value="text" class="accent-indigo-600">
                                        <span>텍스트 전용</span>
                                    </label>
                                </div>
                            </div>

                            <!-- 텍스트 입력 -->
                            <div id="textBlock" class="hidden space-y-2">
                                <label class="text-sm font-semibold">내용 (텍스트)</label>
                                <textarea id="fieldTextContent" class="field mt-2 min-h-[180px] resize-y"
                                    placeholder="예) 한 줄당 1개씩 입력&#10;첫번째 줄&#10;두번째 줄&#10;세번째 줄"></textarea>
                                <p class="text-xs text-gray-500">
                                    줄바꿈(Enter) 기준으로 표시됩니다.
                                </p>
                            </div>

                            <!-- 링크 -->
                            <div id="linkBlock">
                                <label class="text-sm font-semibold">링크 URL (선택)</label>
                                <input id="fieldLinkUrl" class="field mt-2"
                                    placeholder="/ndetail.html?id=123&type=store 또는 https://..." />
                            </div>

                            <div id="dividerAfterLink" class="divider"></div>

                            <!-- 이미지 블록 -->
                            <div id="imageBlock" class="space-y-4">
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div>
                                        <label class="text-sm font-semibold">이미지 파일</label>
                                        <input id="fieldImageFile" type="file" accept="image/*"
                                            class="field mt-2 bg-white" />
                                        <p class="text-xs text-gray-500 mt-1">
                                            파일을 선택하지 않으면, 기존 이미지(또는 가게 연결 시 가게 대표 이미지)를 유지합니다.
                                        </p>
                                    </div>
                                    <div>
                                        <label class="text-sm font-semibold">현재 이미지 미리보기</label>
                                        <div
                                            class="mt-2 rounded-lg border border-gray-100 bg-gray-50 overflow-hidden aspect-[16/9] flex items-center justify-center">
                                            <img id="currentPreviewImg" src="" alt="preview"
                                                class="w-full h-full object-cover hidden" />
                                            <span id="currentPreviewEmpty" class="text-xs text-gray-400">이미지 없음</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 가게 연결 블록 -->
                            <div id="storeBlock" class="space-y-4 hidden">
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div>
                                        <label class="text-sm font-semibold">사업자번호</label>
                                        <input id="fieldBizNo" class="field mt-2" placeholder="예) 2910802895" />
                                    </div>
                                    <div>
                                        <label class="text-sm font-semibold">상호명</label>
                                        <input id="fieldBizName" class="field mt-2" placeholder="예) 하늘식당" />
                                    </div>
                                </div>

                                <div class="flex items-center gap-2">
                                    <button id="btnSearchStore"
                                        class="px-4 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white text-sm">
                                        가게 검색
                                    </button>
                                    <span id="storeSearchHint" class="text-xs text-gray-500"></span>
                                </div>

                                <div id="storeResults" class="border border-slate-100 rounded-xl overflow-hidden">
                                    <div class="px-4 py-3 bg-slate-50 text-sm font-semibold">검색 결과</div>
                                    <div id="storeResultsBody" class="p-4 text-sm text-gray-500">
                                        검색어를 입력하고 “가게 검색”을 눌러주세요.
                                    </div>
                                </div>

                                <input id="fieldStoreId" type="hidden" />
                                <input id="fieldTableSource" type="hidden" />
                            </div>

                            <div class="divider"></div>

                            <!-- 우선순위 -->
                            <div class="mt-4 p-3 rounded-xl border border-blue-100 bg-white/70">
                                <div class="flex flex-col md:flex-row md:items-end gap-3">
                                    <div class="flex-1">
                                        <label class="text-sm font-semibold text-gray-700">우선순위</label>
                                        <input id="adPriority" type="number" min="1" step="1" value="1"
                                            class="mt-1 w-full rounded-xl border border-gray-200 px-3 py-2 outline-none focus:ring-2 focus:ring-blue-300" />
                                        <p class="mt-1 text-xs text-gray-500">
                                            1이 가장 먼저 노출됩니다. (1,2,3… 여러 개 등록 가능)
                                        </p>
                                    </div>

                                    <button type="button" id="btnLoadPriority"
                                        class="rounded-xl px-4 py-2 border border-blue-200 bg-blue-50 hover:bg-blue-100 text-sm">
                                        이 우선순위 불러오기
                                    </button>

                                    <button type="button" id="btnDeletePriority"
                                        class="rounded-xl px-4 py-2 border border-red-200 bg-red-50 hover:bg-red-100 text-sm">
                                        이 우선순위 삭제
                                    </button>
                                </div>

                                <details class="mt-3">
                                    <summary class="cursor-pointer text-sm text-gray-700">등록된 후보 목록 보기 (1~6)</summary>
                                    <div id="candidateList" class="mt-2 grid gap-2"></div>
                                </details>

                                <div id="prioritySupportHint" class="mt-3 text-xs text-slate-500"></div>
                            </div>

                            <!-- 기간 -->
                            <div class="rounded-xl border border-slate-100 p-4">
                                <div class="flex items-center justify-between">
                                    <p class="text-sm font-semibold">광고 기간 설정</p>
                                    <label class="flex items-center gap-2 text-xs">
                                        <input id="fieldNoEnd" type="checkbox" class="accent-blue-600">
                                        <span class="text-gray-700">계속 유지 (종료 없음)</span>
                                    </label>
                                </div>

                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4">
                                    <div>
                                        <label class="text-xs font-semibold text-gray-600">시작 일시</label>
                                        <input id="fieldStartAt" type="datetime-local" class="field mt-2" />
                                    </div>
                                    <div>
                                        <label class="text-xs font-semibold text-gray-600">종료 일시</label>
                                        <input id="fieldEndAt" type="datetime-local" class="field mt-2" />
                                    </div>
                                </div>
                            </div>

                            <!-- 요약 -->
                            <div class="rounded-xl border border-slate-100 bg-slate-50 p-4">
                                <p class="text-sm font-semibold mb-2">현재 선택 정보</p>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm">
                                    <div class="flex items-center gap-2">
                                        <span class="text-gray-500">선택 이미지:</span>
                                        <span id="textSelectedImage" class="font-semibold text-slate-800">없음</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="text-gray-500">연결 가게:</span>
                                        <span id="textSelectedStore" class="font-semibold text-slate-800">없음</span>
                                    </div>
                                </div>

                                <div id="modalStatus" class="mt-3 text-xs text-slate-600"></div>
                            </div>

                            <!-- 버튼 -->
                            <div class="flex flex-col sm:flex-row gap-2 sm:justify-end">
                                <button id="btnResetModal"
                                    class="px-4 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-slate-700 text-sm">
                                    입력 초기화
                                </button>
                                <button id="btnSaveSlot"
                                    class="px-5 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold">
                                    슬롯 저장
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <script>
                // =========================
                // ✅ 공통 유틸 / 헤더푸터
                // =========================
                const el = (id) => document.getElementById(id);
                const clean = (v) => (v == null ? "" : String(v).trim());
                const digitsOnly = (v) => clean(v).replace(/[^\d]/g, "");

                // header/footer
                (async () => {
                    try {
                        const h = await fetch("/components/header.html").then((r) => r.text());
                        const hp = el("header-placeholder");
                        if (hp) hp.innerHTML = h;
                    } catch (_) { }
                    try {
                        const f = await fetch("/components/footer.html").then((r) => r.text());
                        const fp = el("footer-placeholder");
                        if (fp) fp.innerHTML = f;
                    } catch (_) { }
                })();

                function toggleSub(btn) {
                    const ul = btn?.nextElementSibling;
                    if (!ul) return;
                    ul.classList.toggle("hidden");
                }

                function goBack() {
                    if (document.referrer && document.referrer !== location.href) window.history.back();
                    else window.location.href = "/category.html";
                }
                function goNext() {
                    window.history.forward();
                }

                window.toggleSub = toggleSub;
                window.goBack = goBack;
                window.goNext = goNext;

                // =========================
                // ✅ API 설정
                // =========================
                const API_BASE = "/ncategory2manager/ad";
                const PAGE = "ncategory2";
                const DEFAULT_TABLE_SOURCE = "combined_store_info";

                // ✅ 강제 "가게+이미지 등록" 슬롯 목록
                const FORCE_STORE_IMAGE_POSITIONS = new Set([
                    "ncategory2_bottom_1",
                    "ncategory2_bottom_2",
                ]);

                function buildStoreLink(tableSource, storeId) {
                    const t = clean(tableSource) || DEFAULT_TABLE_SOURCE;
                    const id = clean(storeId);
                    if (!id) return "#";

                    if (t === "combined_store_info" || t === "combined") {
                        return `/ndetail.html?id=${encodeURIComponent(id)}&type=combined`;
                    }
                    if (t === "food_stores" || t === "food") {
                        return `/ndetail.html?id=${encodeURIComponent(id)}&type=food`;
                    }
                    if (t === "store_info") {
                        return `/detail.html?id=${encodeURIComponent(id)}`;
                    }
                    return `/ndetail.html?id=${encodeURIComponent(id)}&type=combined`;
                }

                async function fetchJson(url, opt = {}) {
                    const r = await fetch(url, opt);
                    const data = await r.json().catch(() => ({}));
                    if (!r.ok) throw new Error(data?.error || data?.message || `HTTP ${r.status}`);
                    return data;
                }

                async function apiListSlots() {
                    const data = await fetchJson(`${API_BASE}/slots?page=${encodeURIComponent(PAGE)}`);
                    let rows = [];
                    if (data?.success === true) rows = data.slots || [];
                    else if (Array.isArray(data?.slots)) rows = data.slots;
                    else if (Array.isArray(data)) rows = data;
                    // ✅ priority=1만 화면 반영
                    return rows.filter(r => String(r.priority ?? r.ad_priority ?? "1") === "1");
                }

                async function apiGetSlot({ page, position, priority }) {
                    const url = new URL(`${API_BASE}/slot`, window.location.origin);
                    if (page) url.searchParams.set("page", page);
                    if (position) url.searchParams.set("position", position);
                    if (priority !== "" && priority != null) url.searchParams.set("priority", String(priority));
                    return await fetchJson(url.toString());
                }

                async function apiUpsertSlot(formData) {
                    const data = await fetchJson(`${API_BASE}/slot`, { method: "POST", body: formData });
                    if (!data || data.success !== true) throw new Error(data?.error || "저장 실패");
                    return data.slot || null;
                }

                async function apiDeleteSlot({ page, position, priority }) {
                    const url = new URL(`${API_BASE}/slot`, window.location.origin);
                    if (page) url.searchParams.set("page", page);
                    if (position) url.searchParams.set("position", position);
                    if (priority !== "" && priority != null) url.searchParams.set("priority", String(priority));
                    return await fetchJson(url.toString(), { method: "DELETE" });
                }

                async function apiListSlotItems({ page, position }) {
                    const url = new URL(`${API_BASE}/slot-items`, window.location.origin);
                    if (page) url.searchParams.set("page", page);
                    if (position) url.searchParams.set("position", position);
                    const data = await fetchJson(url.toString());
                    if (data?.success === true) return data.items || [];
                    if (Array.isArray(data?.items)) return data.items;
                    return [];
                }

                async function apiSearchStore(q, bizNo) {
                    const qs = new URLSearchParams();
                    if (q) qs.set("q", q);
                    if (bizNo) qs.set("bizNo", bizNo);

                    const url = `${API_BASE}/search-store?${qs.toString()}`;
                    console.log("✅ apiSearchStore hit:", url);

                    const res = await fetch(url);
                    if (!res.ok) throw new Error(`검색 실패: HTTP ${res.status}`);

                    const data = await res.json();
                    console.log("✅ searchStore version:", data?.version);
                    return data.stores || [];
                }

                // =========================
                // ✅ 슬롯 DOM 생성(파워/베스트)
                // =========================
                const POWER_POS = Array.from({ length: 9 }, (_, i) => `ncategory2_power_${i + 1}`);
                const BEST_POS = Array.from({ length: 9 }, (_, i) => `ncategory2_best_${i + 1}`);

                const state = {
                    slots: new Map(),
                    current: { page: PAGE, position: "", priority: "1" },
                };

                function pickCategory(obj) {
                    return clean(
                        obj?.category ||
                        obj?.business_category ||
                        obj?.businessCategory ||
                        obj?.business_subcategory ||
                        obj?.businessSubcategory ||
                        obj?.business_type ||
                        obj?.businessType ||
                        obj?.store_category ||
                        obj?.storeCategory ||
                        ""
                    );
                }

                function pickThumb(store) {
                    return (
                        store.image_url ||   // 우리가 맞추려는 표준
                        store.url ||         // combined_store_images 실제 컬럼
                        store.thumb_url ||
                        store.imageUrl ||
                        (Array.isArray(store.images) && store.images[0] ? store.images[0] : "") ||
                        "/uploads/no-image.png"
                    );
                }

                function setImg(imgEl, src) {
                    if (!imgEl) return;
                    imgEl.src = src || "/uploads/no-image.png";
                    imgEl.onerror = () => {
                        imgEl.onerror = null;
                        imgEl.src = "/uploads/no-image.png";
                    };
                }

                function makeSlotCard(position, label, imgHClass = "h-60 md:h-64") {
                    const wrap = document.createElement("div");
                    wrap.className = "neo-card p-0 overflow-hidden relative rounded-2xl border-4 border-yellow-200 admin-slot";
                    wrap.setAttribute("data-position", position);
                    wrap.setAttribute("data-label", label);
                    wrap.innerHTML = `
      <div class="w-full ${imgHClass} bg-white/40 flex items-center justify-center">
        <img data-role="img" src="" alt="${label}" class="w-full h-full object-cover hidden">
        <div data-role="noimg" class="text-xs text-slate-500">NO IMG</div>
      </div>
      <div class="absolute left-3 right-3 bottom-3 bg-white/70 backdrop-blur-md rounded-xl shadow px-4 py-2 text-center">
        <div class="font-bold text-lg" data-role="name">${label}</div>
        <div class="text-sm text-slate-600" data-role="category">업종:</div>
      </div>
    `;
                    return wrap;
                }

                function buildPowerSliderDom() {
                    const track = el("powerAdTrack");
                    if (!track) return;
                    track.innerHTML = "";

                    for (let g = 0; g < 3; g++) {
                        const group = document.createElement("div");
                        group.className = "power-group flex basis-full shrink-0";

                        for (let i = 0; i < 3; i++) {
                            const idx = g * 3 + i;
                            const pos = POWER_POS[idx];

                            const col = document.createElement("div");
                            col.className = "w-1/3 px-2";

                            const a = document.createElement("a");
                            a.href = "#";
                            a.className = "block";
                            a.appendChild(makeSlotCard(pos, `강력추천 ${idx + 1}`));

                            col.appendChild(a);
                            group.appendChild(col);
                        }
                        track.appendChild(group);
                    }
                }

                function buildBestGridDom() {
                    const grid = el("bestGrid");
                    if (!grid) return;
                    grid.innerHTML = "";

                    for (let i = 0; i < 9; i++) {
                        const pos = BEST_POS[i];

                        const a = document.createElement("a");
                        a.href = "#";
                        a.className = "block";

                        const card = document.createElement("div");
                        card.className = "neo-card p-0 overflow-hidden relative rounded-2xl transition-transform admin-slot";
                        card.setAttribute("data-position", pos);
                        card.setAttribute("data-label", `최고의가게 ${i + 1}`);

                        card.innerHTML = `
        <div class="w-full h-60 bg-white/40 flex items-center justify-center">
          <img data-role="img" src="" alt="상호명" class="w-full h-full object-cover hidden">
          <div data-role="noimg" class="text-xs text-slate-500">NO IMG</div>
        </div>
        <div class="absolute left-3 right-3 bottom-3 bg-white/70 backdrop-blur-md rounded-xl shadow px-4 py-3">
          <div class="font-bold text-lg leading-tight" data-role="name">상호명</div>
          <div class="text-sm text-slate-600" data-role="category">업종:</div>
        </div>
      `;

                        a.appendChild(card);
                        grid.appendChild(a);
                    }
                }

                function applySlotToEl(slotEl, slot) {
                    if (!slotEl) return;

                    const img = slotEl.querySelector('[data-role="img"]');
                    const noimg = slotEl.querySelector('[data-role="noimg"]');
                    const name = slotEl.querySelector('[data-role="name"]');
                    const category = slotEl.querySelector('[data-role="category"]');
                    const desc = slotEl.querySelector('[data-role="desc"]');

                    const label = clean(slotEl.getAttribute("data-label") || "");
                    const hasSlot = !!slot;

                    const imageUrl = hasSlot ? clean(slot?.image_url || slot?.imageUrl || "") : "";
                    const businessName = hasSlot
                        ? (clean(slot?.business_name || slot?.businessName || "") || label)
                        : label;

                    const cat = hasSlot ? pickCategory(slot) : "";
                    const textContent = hasSlot ? clean(slot?.text_content || slot?.textContent || "") : "";

                    // ✅ 이미지 처리: "현재 src"를 default로 쓰지 말고, data-default-src만 default로 사용
                    if (img) {
                        const defaultSrc = clean(img.getAttribute("data-default-src") || ""); // ✅ 여기만 사용
                        const finalSrc = imageUrl || defaultSrc;

                        if (finalSrc) {
                            img.src = finalSrc;
                            img.classList.remove("hidden");
                            if (noimg) noimg.classList.add("hidden");

                            img.onerror = () => {
                                img.onerror = null;
                                img.src = "/uploads/no-image.png";
                            };
                        } else {
                            img.src = "";
                            img.classList.add("hidden");
                            if (noimg) noimg.classList.remove("hidden");
                        }
                    }

                    if (name) name.textContent = businessName || "";
                    if (category) category.textContent = cat ? `업종: ${cat}` : "업종:";
                    if (desc) desc.textContent = textContent || desc.textContent || "";

                    // ✅ 링크도 삭제 시 즉시 #로 초기화
                    const a = slotEl.closest("a");
                    if (a) {
                        const link = hasSlot ? clean(slot?.link_url || slot?.linkUrl || "") : "";
                        a.href = link || "#";
                    }
                }

                async function loadAndRender() {
                    // ✅ 화면에 실제 존재하는 position들을 기준으로 렌더링 (서버 /slots 묶임/누락 이슈 우회)
                    const els = Array.from(document.querySelectorAll("[data-position]"));
                    const positions = [...new Set(els.map(x => clean(x.getAttribute("data-position"))).filter(Boolean))];

                    // position별로 priority=1을 정확히 가져와서 적용
                    const settled = await Promise.allSettled(
                        positions.map(async (pos) => {
                            try {
                                const data = await apiGetSlot({ page: PAGE, position: pos, priority: 1 });
                                const slot = data?.slot ?? data ?? null;
                                return { pos, slot };
                            } catch (_) {
                                return { pos, slot: null };
                            }
                        })
                    );

                    state.slots.clear();
                    for (const r of settled) {
                        if (r.status === "fulfilled") {
                            const { pos, slot } = r.value;
                            if (slot) state.slots.set(pos, slot);
                        }
                    }

                    // ✅ DOM에 적용
                    els.forEach((slotEl) => {
                        const pos = clean(slotEl.getAttribute("data-position"));
                        applySlotToEl(slotEl, state.slots.get(pos));
                    });
                }

                // =========================
                // ✅ 파워 슬라이더(왕복)
                // =========================
                function initPowerSlider() {
                    const viewport = el("powerViewport");
                    const track = el("powerAdTrack");
                    if (!viewport || !track) return;

                    const groups = track.querySelectorAll(".power-group").length;
                    let index = Math.floor(Math.random() * Math.max(groups, 1));
                    let dir = 1;

                    function updateSlider() {
                        const slideWidth = viewport.clientWidth;
                        track.style.transform = `translateX(${-index * slideWidth}px)`;
                    }

                    function stepAuto() {
                        if (groups <= 1) return;
                        if (index >= groups - 1) dir = -1;
                        else if (index <= 0) dir = 1;
                        index = index + dir;
                        updateSlider();
                    }

                    function nextManual() {
                        if (groups <= 1) return;
                        if (index < groups - 1) index++;
                        else { dir = -1; index = groups - 2; }
                        updateSlider();
                    }

                    function prevManual() {
                        if (groups <= 1) return;
                        if (index > 0) index--;
                        else { dir = 1; index = 1; }
                        updateSlider();
                    }

                    const nextBtn = el("nextBtn");
                    const prevBtn = el("prevBtn");
                    if (nextBtn) nextBtn.addEventListener("click", () => { stopAuto(); nextManual(); startAuto(); });
                    if (prevBtn) prevBtn.addEventListener("click", () => { stopAuto(); prevManual(); startAuto(); });

                    window.addEventListener("resize", updateSlider);

                    const INTERVAL = 10000;
                    let timer = null;
                    function startAuto() { if (!timer) timer = setInterval(stepAuto, INTERVAL); }
                    function stopAuto() { if (timer) { clearInterval(timer); timer = null; } }

                    document.addEventListener("visibilitychange", () => { document.hidden ? stopAuto() : startAuto(); });
                    viewport.addEventListener("mouseenter", stopAuto);
                    viewport.addEventListener("mouseleave", startAuto);

                    updateSlider();
                    startAuto();
                }

                // =========================
                // ✅ 모달 (현재 HTML id들에 맞춤)
                // =========================
                function setModalStatus(msg) {
                    const s = el("modalStatus");
                    if (s) s.textContent = msg || "";
                }

                function setPreview(url) {
                    const img = el("currentPreviewImg");
                    const empty = el("currentPreviewEmpty");
                    if (!img || !empty) return;

                    const u = clean(url);
                    if (u) {
                        img.src = u;
                        img.classList.remove("hidden");
                        empty.classList.add("hidden");
                    } else {
                        img.src = "";
                        img.classList.add("hidden");
                        empty.classList.remove("hidden");
                    }
                }

                function setSelectedSummary({ imageUrl, storeText }) {
                    if (el("textSelectedImage")) el("textSelectedImage").textContent = imageUrl ? "있음" : "없음";
                    if (el("textSelectedStore")) el("textSelectedStore").textContent = storeText || "없음";
                }

                function getMode() {
                    return document.querySelector('input[name="slotMode"]:checked')?.value || "image";
                }

                function applyModeUI(mode) {
                    const textOnlyHint = el("textOnlyHint");
                    const textBlock = el("textBlock");
                    const linkBlock = el("linkBlock");
                    const dividerAfterLink = el("dividerAfterLink");
                    const imageBlock = el("imageBlock");
                    const storeBlock = el("storeBlock");

                    if (mode === "text") {
                        if (textOnlyHint) textOnlyHint.classList.remove("hidden");
                        if (textBlock) textBlock.classList.remove("hidden");
                        if (linkBlock) linkBlock.classList.add("hidden");
                        if (dividerAfterLink) dividerAfterLink.classList.add("hidden");
                        if (imageBlock) imageBlock.classList.add("hidden");
                        if (storeBlock) storeBlock.classList.add("hidden");
                    } else if (mode === "store") {
                        if (textOnlyHint) textOnlyHint.classList.add("hidden");
                        if (textBlock) textBlock.classList.add("hidden");
                        if (linkBlock) linkBlock.classList.remove("hidden");
                        if (dividerAfterLink) dividerAfterLink.classList.remove("hidden");
                        if (imageBlock) imageBlock.classList.remove("hidden");
                        if (storeBlock) storeBlock.classList.remove("hidden");
                    } else {
                        // image
                        if (textOnlyHint) textOnlyHint.classList.add("hidden");
                        if (textBlock) textBlock.classList.add("hidden");
                        if (linkBlock) linkBlock.classList.remove("hidden");
                        if (dividerAfterLink) dividerAfterLink.classList.remove("hidden");
                        if (imageBlock) imageBlock.classList.remove("hidden");
                        if (storeBlock) storeBlock.classList.add("hidden");
                    }
                }

                function clearModalFields(keepKey = true) {
                    setModalStatus("");

                    if (el("fieldTextContent")) el("fieldTextContent").value = "";
                    if (el("fieldLinkUrl")) el("fieldLinkUrl").value = "";
                    if (el("fieldImageFile")) el("fieldImageFile").value = "";

                    if (el("fieldBizNo")) el("fieldBizNo").value = "";
                    if (el("fieldBizName")) el("fieldBizName").value = "";
                    if (el("fieldStoreId")) el("fieldStoreId").value = "";
                    if (el("fieldTableSource")) el("fieldTableSource").value = "";

                    if (el("fieldStartAt")) el("fieldStartAt").value = "";
                    if (el("fieldEndAt")) el("fieldEndAt").value = "";
                    if (el("fieldNoEnd")) el("fieldNoEnd").checked = false;
                    if (el("fieldEndAt")) el("fieldEndAt").disabled = false;

                    // preview/current image
                    const modal = el("slotModal");
                    if (modal) modal.dataset.currentImage = "";
                    setPreview("");

                    // results
                    if (el("storeResultsBody")) {
                        el("storeResultsBody").innerHTML = `검색어를 입력하고 “가게 검색”을 눌러주세요.`;
                    }

                    setSelectedSummary({ imageUrl: "", storeText: "" });

                    if (!keepKey) {
                        const m = el("slotModal");
                        if (m) { m.dataset.page = ""; m.dataset.position = ""; }
                        state.current.page = PAGE;
                        state.current.position = "";
                        state.current.priority = "1";
                    }
                }

                async function refreshCandidateList() {
                    const pos = clean(state.current.position);
                    if (!pos) return;

                    try {
                        const items = await apiListSlotItems({ page: PAGE, position: pos });
                        const list = el("candidateList");
                        if (!list) return;

                        list.innerHTML = "";
                        if (!items.length) {
                            list.innerHTML = `<div class="text-xs text-slate-500">등록된 후보 없음</div>`;
                            return;
                        }

                        // 1~6 안내
                        items
                            .filter(x => x && x.priority != null)
                            .sort((a, b) => Number(a.priority) - Number(b.priority))
                            .slice(0, 12)
                            .forEach((it) => {
                                const p = String(it.priority);
                                const mode = clean(it.slot_mode || it.slotMode || "");
                                const name = clean(it.business_name || it.businessName || "");
                                const cat = pickCategory(it);
                                const hasImg = !!clean(it.image_url || it.imageUrl || "");
                                const span = document.createElement("div");
                                span.className = "neo-card px-3 py-2 flex items-center justify-between gap-2";
                                span.innerHTML = `
              <div class="min-w-0">
                <div class="text-xs font-extrabold text-slate-800 truncate">priority ${p} · ${mode || "-"}</div>
                <div class="text-[11px] text-slate-500 truncate">${name ? `${name} ${cat ? `(${cat})` : ""}` : (hasImg ? "이미지 배너" : "텍스트/링크")}</div>
              </div>
              <button class="btn-3d shrink-0" type="button">불러오기</button>
            `;
                                span.querySelector("button").addEventListener("click", async () => {
                                    el("adPriority").value = p;
                                    state.current.priority = p;
                                    await loadSlotIntoModal();
                                });
                                list.appendChild(span);
                            });

                        if (el("prioritySupportHint")) {
                            el("prioritySupportHint").textContent = "후보는 서버에 등록된 우선순위 목록 기준입니다.";
                        }
                    } catch (e) {
                        // 후보 목록 API가 없을 수도 있으니 조용히 처리
                        const list = el("candidateList");
                        if (list) list.innerHTML = `<div class="text-xs text-slate-500">후보 목록 API 미지원</div>`;
                    }
                }

                async function openSlotModal(position) {
                    const modal = el("slotModal");
                    if (!modal) return;

                    const pos = clean(position);
                    state.current.page = PAGE;
                    state.current.position = pos;
                    state.current.priority = clean(el("adPriority")?.value || "1") || "1";

                    modal.dataset.page = PAGE;
                    modal.dataset.position = pos;

                    if (el("modalPositionText")) el("modalPositionText").textContent = pos;

                    clearModalFields(true);

                    // ✅ 강제 store 모드 슬롯인 경우 자동 설정
                    if (FORCE_STORE_IMAGE_POSITIONS.has(pos)) {
                        document.querySelectorAll('input[name="slotMode"]').forEach(r => r.checked = r.value === "store");
                        applyModeUI("store");
                    } else {
                        // 기본 모드 image
                        document.querySelectorAll('input[name="slotMode"]').forEach(r => r.checked = r.value === "image");
                        applyModeUI("image");
                    }

                    modal.classList.remove("hidden");

                    try {
                        await loadSlotIntoModal();
                    } catch (e) {
                        setModalStatus("슬롯 로드 실패 (신규 입력 가능)");
                    }

                    await refreshCandidateList();
                }

                function closeSlotModal() {
                    const modal = el("slotModal");
                    if (!modal) return;
                    modal.classList.add("hidden");
                }

                function toDatetimeLocal(v) {
                    const s = clean(v);
                    if (!s) return "";
                    // '2025-12-24 12:34:56' or ISO
                    const iso = s.includes("T") ? s : s.replace(" ", "T");
                    return iso.slice(0, 16);
                }

                async function loadSlotIntoModal() {
                    setModalStatus("불러오는 중...");

                    const position = clean(state.current.position);
                    const priority = clean(el("adPriority")?.value || state.current.priority || "1") || "1";
                    state.current.priority = priority;

                    const data = await apiGetSlot({ page: PAGE, position, priority });
                    const slot = data?.slot ?? data; // 서버 형태가 다를 수 있어서

                    if (!slot) {
                        setModalStatus("슬롯 없음(신규)");
                        setPreview("");
                        return;
                    }

                    // mode
                    const mode = clean(slot.slot_mode || slot.slotMode || "image");
                    document.querySelectorAll('input[name="slotMode"]').forEach(r => r.checked = r.value === mode);
                    applyModeUI(mode);

                    // 기간
                    const startAt = clean(slot.start_at || slot.startAt || "");
                    const endAt = clean(slot.end_at || slot.endAt || "");
                    const noEnd = String(slot.no_end ?? slot.noEnd ?? "").toLowerCase() === "true" || slot.no_end === true || slot.noEnd === true;

                    if (el("fieldStartAt")) el("fieldStartAt").value = toDatetimeLocal(startAt);
                    if (el("fieldEndAt")) el("fieldEndAt").value = toDatetimeLocal(endAt);
                    if (el("fieldNoEnd")) el("fieldNoEnd").checked = !!noEnd;
                    if (el("fieldEndAt")) el("fieldEndAt").disabled = !!noEnd;

                    // 텍스트/링크
                    if (el("fieldTextContent")) el("fieldTextContent").value = clean(slot.text_content || slot.textContent || "");
                    if (el("fieldLinkUrl")) el("fieldLinkUrl").value = clean(slot.link_url || slot.linkUrl || "");

                    // 이미지
                    const imageUrl = clean(slot.image_url || slot.imageUrl || "");
                    const modal = el("slotModal");
                    if (modal) modal.dataset.currentImage = imageUrl || "";
                    setPreview(imageUrl);

                    // 가게
                    const storeId = clean(slot.store_id || slot.storeId || "");
                    const tableSource = clean(slot.table_source || slot.tableSource || DEFAULT_TABLE_SOURCE);
                    const bizNo = clean(slot.business_no || slot.businessNo || "");
                    const bizName = clean(slot.business_name || slot.businessName || "");
                    const cat = pickCategory(slot);

                    if (el("fieldStoreId")) el("fieldStoreId").value = storeId;
                    if (el("fieldTableSource")) el("fieldTableSource").value = tableSource;
                    if (el("fieldBizNo")) el("fieldBizNo").value = bizNo;
                    if (el("fieldBizName")) el("fieldBizName").value = bizName;

                    const storeText = bizName ? (cat ? `${bizName} (${cat})` : bizName) : "";
                    setSelectedSummary({ imageUrl: imageUrl, storeText });

                    setModalStatus("불러오기 완료");
                }

                // ✅ 가게 검색
                async function doStoreSearch() {
                    const qRaw = clean(el("fieldBizName")?.value);
                    const bizRaw = digitsOnly(clean(el("fieldBizNo")?.value));

                    // ✅ 빈 검색어면 __all__로 자동 변환 (기본 리스트 10개 요청)
                    const q = qRaw.length ? qRaw : "__all__";
                    const bizNo = qRaw ? "" : bizRaw;

                    const wrap = el("storeResultsBody");
                    if (wrap) wrap.innerHTML = `<div class="text-sm text-slate-500">검색 중...</div>`;

                    try {
                        const stores = await apiSearchStore(q, bizNo);
                        console.log("✅ searchStore 결과:", stores.length, "개");
                        if (!Array.isArray(stores) || stores.length === 0) {
                            // ✅ 기존 화면을 지우지 않고 안내만
                            if (wrap) wrap.innerHTML = `<div class="text-sm text-slate-500">검색 결과 없음</div>`;
                            setModalStatus("검색 결과 없음");
                            return;
                        }
                        renderStoreResults(stores);
                    } catch (e) {
                        console.error("❌ 검색 오류:", e);
                        // ✅ 기존 화면 유지, 오류 메시지만 표시
                        setModalStatus(`검색 오류: ${e.message || "error"}`);
                        if (wrap && !wrap.querySelector(".neo-card")) {
                            // 기존 결과가 없을 때만 오류 표시
                            wrap.innerHTML = `<div class="text-sm text-rose-600">검색 오류: ${e.message || "error"}</div>`;
                        }
                    }
                }

                function renderStoreResults(stores) {
                    const wrap = el("storeResultsBody");
                    if (!wrap) return;

                    wrap.innerHTML = "";
                    if (!stores.length) {
                        wrap.innerHTML = `<div class="text-sm text-slate-500">검색 결과 없음</div>`;
                        return;
                    }

                    stores.forEach((s) => {
                        const id = clean(s.id || s.store_id || s.storeId);
                        const biz = clean(s.business_no || s.businessNo || s.business_number || "");
                        const name = clean(s.business_name || s.businessName || s.business_name_kor || "");
                        const cat = pickCategory(s);
                        const thumb = pickThumb(s);
                        const tableSource = clean(s.table_source || s.tableSource || DEFAULT_TABLE_SOURCE);

                        const row = document.createElement("div");
                        row.className = "neo-card p-3 flex gap-3 items-center mb-2";

                        const imgContainer = document.createElement("div");
                        imgContainer.className = "w-16 h-12 rounded-xl overflow-hidden bg-white/60 shrink-0";

                        if (thumb && thumb !== "/uploads/no-image.png") {
                            const img = document.createElement("img");
                            img.className = "w-full h-full object-cover";
                            setImg(img, thumb);
                            imgContainer.appendChild(img);
                        } else {
                            const noImg = document.createElement("div");
                            noImg.className = "w-full h-full flex items-center justify-center text-xs text-slate-400";
                            noImg.textContent = "NO IMG";
                            imgContainer.appendChild(noImg);
                        }

                        const infoDiv = document.createElement("div");
                        infoDiv.className = "flex-1 min-w-0";
                        infoDiv.innerHTML = `
            <div class="font-extrabold text-slate-800 truncate">${name || "-"}</div>
            <div class="text-xs text-slate-600 mt-0.5 truncate">${cat ? `(${cat})` : ""} ${biz ? `· ${biz}` : ""}</div>
            <div class="text-[11px] text-slate-400 mt-0.5 truncate">${tableSource} · id=${id}</div>
          `;

                        const btn = document.createElement("button");
                        btn.className = "btn-3d shrink-0";
                        btn.type = "button";
                        btn.textContent = "선택";
                        btn.addEventListener("click", () => {
                            if (!id) {
                                alert("실제 가게 결과가 아닙니다.");
                                return;
                            }
                            applySelectedStore({
                                id,
                                business_no: biz,
                                business_name: name,
                                category: cat,
                                image_url: thumb,
                                table_source: tableSource,
                            });
                        });

                        row.appendChild(imgContainer);
                        row.appendChild(infoDiv);
                        row.appendChild(btn);
                        wrap.appendChild(row);
                    });
                }

                // ✅ “선택” 시 자동 매핑
                function applySelectedStore(store) {
                    const storeId = clean(store.id);
                    const businessNo = clean(store.business_no);
                    const businessName = clean(store.business_name);
                    const category = clean(store.category);
                    const imageUrl = clean(store.image_url);
                    const tableSource = clean(store.table_source) || DEFAULT_TABLE_SOURCE;

                    console.log("✅ applySelectedStore - imageUrl:", imageUrl);

                    if (el("fieldStoreId")) el("fieldStoreId").value = storeId;
                    if (el("fieldTableSource")) el("fieldTableSource").value = tableSource;
                    if (el("fieldBizNo")) el("fieldBizNo").value = businessNo;
                    if (el("fieldBizName")) el("fieldBizName").value = businessName;

                    // 모드 store로
                    document.querySelectorAll('input[name="slotMode"]').forEach((r) => (r.checked = r.value === "store"));
                    applyModeUI("store");

                    // 링크 자동
                    if (el("fieldLinkUrl")) el("fieldLinkUrl").value = buildStoreLink(tableSource, storeId);

                    // preview는 "가게 이미지가 있으면" 그걸 current로 설정
                    const modal = el("slotModal");
                    if (modal) {
                        // 가게 이미지가 있으면 우선 사용, 없으면 기존 유지
                        if (imageUrl) {
                            modal.dataset.currentImage = imageUrl;
                        }
                    }
                    setPreview(modal?.dataset.currentImage || "");

                    // summary
                    const storeText = businessName ? (category ? `${businessName} (${category})` : businessName) : "";
                    setSelectedSummary({ imageUrl: modal?.dataset.currentImage || "", storeText });

                    setModalStatus("가게 연결 완료 (저장 누르세요)");
                }

                // ✅ 가게 선택 여부 검증
                function ensureStoreSelectedOrRevert() {
                    const storeId = clean(el("fieldStoreId")?.value);
                    if (storeId) return true;

                    alert("가게 연결은 검색 결과에서 '선택'을 눌러야 저장할 수 있습니다.");

                    // store 모드로 못 가게 이미지 모드로 되돌림
                    document.querySelectorAll('input[name="slotMode"]').forEach(r => {
                        r.checked = (r.value === "image");
                    });
                    applyModeUI("image");

                    // 안내 문구
                    const hint = el("storeSearchHint");
                    if (hint) hint.textContent = "먼저 가게 검색 → '선택' 후 다시 저장하세요.";

                    return false;
                }

                // ✅ 모달 내용이 "완전 비어있는 상태"인지 체크 (저장 대신 삭제 처리용)
                function isModalEmptyForDelete() {
                    const mode = getMode();

                    const textContent = clean(el("fieldTextContent")?.value);
                    const linkUrl = clean(el("fieldLinkUrl")?.value);
                    const storeId = clean(el("fieldStoreId")?.value);

                    const file = el("fieldImageFile")?.files?.[0];
                    const currentImage = clean(el("slotModal")?.dataset.currentImage || "");

                    const startAt = clean(el("fieldStartAt")?.value);
                    const endAt = clean(el("fieldEndAt")?.value);
                    const noEnd = el("fieldNoEnd")?.checked ? true : false;

                    // 완전 빈 상태 정의 (텍스트/링크/가게/이미지/기간 전부 비어있으면)
                    const empty =
                        !textContent &&
                        !linkUrl &&
                        !storeId &&
                        !file &&
                        !currentImage &&
                        !startAt &&
                        !endAt &&
                        !noEnd;

                    // mode 상관없이 "완전 빈 상태"면 삭제 처리
                    return empty;
                }

                // ✅ 입력 초기화 = 즉시 DB에서 삭제 + UI 초기화 + 화면 갱신
                async function resetAndDeleteCurrentSlot() {
                    const position = clean(state.current.position);
                    const priority = clean(el("adPriority")?.value || state.current.priority || "1") || "1";

                    if (!position) {
                        alert("슬롯(position)이 없어 초기화를 진행할 수 없습니다.");
                        return;
                    }

                    const ok = confirm("입력 초기화 시, 이 우선순위 데이터가 DB에서 삭제됩니다. 진행할까요?");
                    if (!ok) return;

                    try {
                        setModalStatus("초기화(삭제) 중...");

                        // ✅ 서버에서 실제 삭제 (없어도 성공/실패는 서버 동작에 따름)
                        await apiDeleteSlot({ page: PAGE, position, priority });

                        // ✅ 모달 UI 초기화 (키는 유지)
                        clearModalFields(true);

                        // ✅ 화면도 즉시 갱신
                        await loadAndRender();
                        await refreshCandidateList();

                        // ✅ 현재 편집 컨텍스트 유지
                        state.current.priority = priority;

                        setModalStatus("초기화(삭제) 완료 ✅ 이제 닫기 누르면 됩니다.");
                        alert("초기화(삭제) 완료 ✅");
                    } catch (e) {
                        console.error(e);
                        setModalStatus(`❌ 초기화(삭제) 실패: ${e.message || e}`);
                        alert(`초기화(삭제) 실패: ${e.message || e}`);
                    }
                }

                // ✅ 저장
                async function saveSlotFromModal() {
                    try {
                        setModalStatus("저장 중...");

                        const position = clean(state.current.position);
                        if (!position) throw new Error("position(슬롯)이 비어있음");

                        // ✅ 완전 빈 상태면 저장이 아니라 "삭제"로 처리 (초기화 후 저장 눌러도 경고 안 뜨게)
                        if (isModalEmptyForDelete()) {
                            const priority = clean(el("adPriority")?.value || "1") || "1";

                            setModalStatus("빈 값 감지 → 삭제 처리 중...");
                            await apiDeleteSlot({ page: PAGE, position, priority });
                            await loadAndRender();
                            await refreshCandidateList();
                            clearModalFields(true);

                            setModalStatus("삭제 완료 ✅");
                            alert("삭제 완료 ✅");
                            return;
                        }

                        const mode = getMode();
                        if (mode === "store") {
                            const ok = ensureStoreSelectedOrRevert();
                            if (!ok) return;
                        }
                        const priority = clean(el("adPriority")?.value || "1") || "1";
                        state.current.priority = priority;

                        const fd = new FormData();
                        fd.append("page", PAGE);
                        fd.append("position", position);
                        fd.append("priority", priority);

                        // mode (호환용으로 둘 다)
                        const slotType = (mode === "text") ? "text" : "banner";
                        fd.append("slot_type", slotType);
                        fd.append("slotType", slotType);
                        fd.append("slot_mode", mode);
                        fd.append("slotMode", mode);

                        // 기간
                        const startAt = clean(el("fieldStartAt")?.value);
                        const endAt = clean(el("fieldEndAt")?.value);
                        const noEnd = el("fieldNoEnd")?.checked ? "true" : "false";
                        fd.append("start_at", startAt);
                        fd.append("startAt", startAt);
                        fd.append("end_at", endAt);
                        fd.append("endAt", endAt);
                        fd.append("no_end", noEnd);
                        fd.append("noEnd", noEnd);

                        // 콘텐츠
                        const linkUrl = clean(el("fieldLinkUrl")?.value);
                        const textContent = clean(el("fieldTextContent")?.value);
                        fd.append("link_url", linkUrl);
                        fd.append("linkUrl", linkUrl);
                        fd.append("text_content", textContent);
                        fd.append("textContent", textContent);

                        // 이미지(파일 우선 / 없으면 currentImage 유지)
                        const modal = el("slotModal");
                        const currentImage = clean(modal?.dataset.currentImage || "");
                        const file = el("fieldImageFile")?.files?.[0];

                        console.log("💾 저장 시 이미지 상태:", { currentImage, hasFile: !!file, mode });

                        if (file) {
                            fd.append("image", file);
                            console.log("✅ 파일 업로드:", file.name);
                            // 서버가 image_url도 같이 받을 수 있어도 문제 없음
                        } else {
                            // 기존 이미지 유지/삭제 판단
                            if (currentImage) {
                                fd.append("image_url", currentImage);
                                fd.append("imageUrl", currentImage);
                                console.log("✅ 기존 이미지 유지:", currentImage);
                                fd.append("keep_image", "true");
                                fd.append("keepImage", "true");
                            } else {
                                fd.append("clear_image", "true");
                                fd.append("clearImage", "true");
                                console.log("⚠️ 이미지 없음 (clear)");
                            }
                        }

                        // store mode 필수값
                        if (mode === "store") {
                            const storeId = clean(el("fieldStoreId")?.value);
                            console.log("🔍 store 모드 저장:", { storeId, fieldStoreIdEl: el("fieldStoreId") });

                            if (!storeId) {
                                console.error("❌ store_id가 비어있음!");
                                throw new Error("가게연결 모드인데 store_id가 비어있음(가게 선택 먼저)");
                            }

                            const tableSource = clean(el("fieldTableSource")?.value) || DEFAULT_TABLE_SOURCE;
                            const businessNo = clean(el("fieldBizNo")?.value);
                            const businessName = clean(el("fieldBizName")?.value);

                            console.log("📝 store 모드 데이터:", { tableSource, storeId, businessNo, businessName });

                            fd.append("table_source", tableSource);
                            fd.append("tableSource", tableSource);

                            fd.append("store_id", storeId);
                            fd.append("storeId", storeId);

                            fd.append("business_no", businessNo);
                            fd.append("businessNo", businessNo);

                            fd.append("business_name", businessName);
                            fd.append("businessName", businessName);

                            // 표시용 카테고리(서버가 무시해도 OK)
                            fd.append("business_category", "");
                            fd.append("businessCategory", "");
                        } else {
                            fd.append("table_source", "");
                            fd.append("tableSource", "");
                            fd.append("store_id", "");
                            fd.append("storeId", "");
                            fd.append("business_no", "");
                            fd.append("businessNo", "");
                            fd.append("business_name", "");
                            fd.append("businessName", "");
                        }

                        await apiUpsertSlot(fd);

                        // ✅ 저장 후 화면 갱신
                        await loadAndRender();
                        await refreshCandidateList();

                        // ✅ 폼 초기화 (저장한 데이터를 다시 불러오지 않음)
                        clearModalFields(true);

                        // priority 1로 리셋
                        el("adPriority").value = "1";
                        state.current.priority = "1";

                        setModalStatus("저장 완료 ✅");
                        alert("저장 완료 ✅");
                    } catch (e) {
                        setModalStatus(`❌ 저장 실패: ${e.message}`);
                        alert(`저장 실패: ${e.message || "저장 오류"}`);
                    }
                }

                // =========================
                // ✅ 클릭 바인딩(슬롯 클릭 → 모달)
                // =========================
                function bindAdminClicks() {
                    document.addEventListener("click", async (e) => {
                        // 모달 내부 클릭은 무시
                        if (e.target.closest("#slotModal")) return;

                        const target = e.target.closest("[data-position]");
                        if (!target) return;

                        e.preventDefault();
                        e.stopPropagation();

                        const position = target.getAttribute("data-position") || "";
                        if (!position) return;

                        await openSlotModal(position);
                    }, true);
                }

                // =========================
                // ✅ 모달 이벤트
                // =========================
                function bindModalEvents() {
                    // 닫기 버튼
                    const closeBtn = el("btnCloseModal");
                    if (closeBtn) closeBtn.addEventListener("click", (e) => { e.preventDefault(); closeSlotModal(); });

                    // 백드롭 클릭 닫기
                    const modal = el("slotModal");
                    if (modal) {
                        modal.querySelector(".modal-backdrop")?.addEventListener("click", () => closeSlotModal());
                    }

                    // ESC 닫기
                    document.addEventListener("keydown", (e) => {
                        if (e.key !== "Escape") return;
                        if (!el("slotModal")?.classList.contains("hidden")) closeSlotModal();
                    });

                    // 모드 변경 UI 반영
                    document.querySelectorAll('input[name="slotMode"]').forEach((r) => {
                        r.addEventListener("change", () => {
                            const mode = getMode();
                            applyModeUI(mode);
                        });
                    });

                    // 종료 없음 체크
                    const noEnd = el("fieldNoEnd");
                    if (noEnd) {
                        noEnd.addEventListener("change", () => {
                            const end = el("fieldEndAt");
                            if (end) end.disabled = !!noEnd.checked;
                        });
                    }

                    // 이미지 파일 미리보기 (선택 시 즉시 preview)
                    const file = el("fieldImageFile");
                    if (file) {
                        file.addEventListener("change", () => {
                            const f = file.files && file.files[0];
                            if (!f) return;
                            const url = URL.createObjectURL(f);
                            const modal = el("slotModal");
                            if (modal) modal.dataset.currentImage = url; // preview용 (저장은 파일이 우선)
                            setPreview(url);
                            setSelectedSummary({ imageUrl: url, storeText: clean(el("textSelectedStore")?.textContent) });
                        });
                    }

                    // 가게 검색
                    const btnSearch = el("btnSearchStore");
                    if (btnSearch) btnSearch.addEventListener("click", (e) => { e.preventDefault(); doStoreSearch(); });

                    // 저장
                    const btnSave = el("btnSaveSlot");
                    if (btnSave) btnSave.addEventListener("click", (e) => { e.preventDefault(); saveSlotFromModal(); });

                    // 초기화(=DB 삭제까지)
                    const btnReset = el("btnResetModal");
                    if (btnReset) btnReset.addEventListener("click", async (e) => {
                        e.preventDefault();
                        await resetAndDeleteCurrentSlot();
                        // 삭제 후 mode UI는 기본값으로 보여주고 싶으면 아래 유지
                        applyModeUI(getMode());
                    });

                    // 우선순위 불러오기
                    const btnLoadP = el("btnLoadPriority");
                    if (btnLoadP) btnLoadP.addEventListener("click", async (e) => {
                        e.preventDefault();
                        await loadSlotIntoModal();
                    });

                    // 우선순위 삭제
                    const btnDelP = el("btnDeletePriority");
                    if (btnDelP) btnDelP.addEventListener("click", async (e) => {
                        e.preventDefault();
                        const ok = confirm("정말 이 우선순위를 삭제할까요?");
                        if (!ok) return;

                        const position = clean(state.current.position);
                        const priority = clean(el("adPriority")?.value || "1") || "1";
                        await apiDeleteSlot({ page: PAGE, position, priority });
                        setModalStatus("삭제 완료");
                        await loadAndRender();
                        clearModalFields(true);
                        await refreshCandidateList();
                    });

                    // ✅ 가게명/사업자번호를 직접 수정하면 "기존 선택(store_id)"은 무효 처리
                    ["fieldBizNo", "fieldBizName"].forEach((fid) => {
                        const input = el(fid);
                        if (!input) return;

                        input.addEventListener("input", () => {
                            // 선택 정보 무효화
                            if (el("fieldStoreId")) el("fieldStoreId").value = "";
                            if (el("fieldTableSource")) el("fieldTableSource").value = "";

                            // store 모드일 때는 이미지/요약도 같이 초기화(헷갈림 방지)
                            const modal = el("slotModal");
                            if (getMode() === "store") {
                                if (modal) modal.dataset.currentImage = "";
                                setPreview("");
                                setSelectedSummary({ imageUrl: "", storeText: "" });
                            }

                            const hint = el("storeSearchHint");
                            if (hint) hint.textContent = "가게 검색 후 검색 결과에서 ‘선택’을 눌러야 저장됩니다.";
                        });
                    });

                    // 사용법 팝오버
                    const helpBtn = el("adHelpBtn");
                    const helpPop = el("adHelpPopover");
                    const helpClose = el("adHelpCloseBtn");
                    if (helpBtn && helpPop) {
                        helpBtn.addEventListener("click", (e) => {
                            e.preventDefault();
                            helpPop.classList.toggle("hidden");
                            const open = !helpPop.classList.contains("hidden");
                            helpBtn.setAttribute("aria-expanded", open ? "true" : "false");
                        });
                    }
                    if (helpClose && helpPop) {
                        helpClose.addEventListener("click", (e) => {
                            e.preventDefault();
                            helpPop.classList.add("hidden");
                            if (helpBtn) helpBtn.setAttribute("aria-expanded", "false");
                        });
                    }
                }

                // =========================
                // ✅ init
                // =========================
                document.addEventListener("DOMContentLoaded", async () => {
                    buildPowerSliderDom();
                    buildBestGridDom();
                    bindAdminClicks();
                    bindModalEvents();

                    await loadAndRender();
                    initPowerSlider();
                });

                // 전역 노출
                window.openSlotModal = openSlotModal;
                window.closeSlotModal = closeSlotModal;
                window.doStoreSearch = doStoreSearch;
                window.saveSlotFromModal = saveSlotFromModal;
            </script>

</body>

</html>