<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ncategory2 매니저</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* ncategory2와 동일 */
        .neo-card {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 1.2rem;
            box-shadow: 6px 6px 16px #d9e0ec, -6px -6px 16px #ffffff;
            backdrop-filter: blur(16px) saturate(120%);
            transition: all .25s ease;
        }

        .neo-card:hover {
            transform: translateY(-4px);
            box-shadow: 4px 4px 12px #cfd8e6, -4px -4px 12px #ffffff, 0 8px 24px rgba(80, 130, 255, 0.15);
        }

        .btn-3d {
            background: linear-gradient(90deg, #6dd5fa, #2980b9);
            border-radius: 1.3rem;
            padding: .5rem 1.5rem;
            font-weight: bold;
            color: white;
            box-shadow: 0 4px 0 #2393b3, 0 8px 16px rgba(0, 64, 128, 0.14);
            transition: all .15s;
            user-select: none;
        }

        .btn-3d:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #2393b3, 0 4px 10px rgba(0, 64, 128, 0.16);
        }

        .sidebar-scroll {
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: transparent transparent;
        }

        .sidebar-scroll:hover {
            scrollbar-color: #cbd5e1 transparent;
        }

        .sidebar-scroll::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar-scroll::-webkit-scrollbar-track {
            background: transparent;
        }

        .sidebar-scroll::-webkit-scrollbar-thumb {
            background: transparent;
            border-radius: 9999px;
        }

        .sidebar-scroll:hover::-webkit-scrollbar-thumb {
            background: #cbd5e1;
        }

        .sidebar-scroll::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* 관리자 클릭용(레이아웃은 그대로, 표시만 아주 작게) */
        .admin-slot {
            cursor: pointer;
            position: relative;
        }

        .admin-slot::after {
            content: "관리";
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 12px;
            font-weight: 900;
            padding: 6px 10px;
            border-radius: 9999px;
            background: rgba(255, 255, 255, 0.78);
            border: 1px solid rgba(59, 130, 246, 0.25);
            backdrop-filter: blur(8px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.08);
            color: rgba(30, 64, 175, 0.95);
            pointer-events: none;
        }

        /* ✅ 입력 가시성 */
        .input {
            width: 100%;
            padding: .65rem .85rem;
            border-radius: 1rem;
            border: 1px solid rgba(148, 163, 184, .75);
            background: rgba(255, 255, 255, 0.92);
            outline: none;
        }

        .input:focus {
            border-color: rgba(59, 130, 246, .85);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, .18);
        }

        /* ✅ 모달 스타일 */
        #slotModal {
            position: fixed;
            inset: 0;
            z-index: 9999;
        }

        #slotModal .modal-backdrop {
            position: absolute;
            inset: 0;
            background: rgba(15, 23, 42, .55);
        }

        #slotModal .modal-panel {
            position: relative;
            margin: 0 auto;
            width: min(980px, calc(100% - 36px));
            max-height: 88vh;
            overflow: auto;
            top: 50%;
            transform: translateY(-50%);
        }

        #slotModal .modal-card {
            border-radius: 1.25rem;
            background: rgba(255, 255, 255, .96);
            border: 2px solid rgba(59, 130, 246, .18);
            box-shadow: 0 18px 60px rgba(0, 0, 0, .25);
            backdrop-filter: blur(14px);
            overflow: hidden;
        }
    </style>
</head>

<body class="bg-gradient-to-br from-blue-50 via-white to-blue-100 min-h-screen text-gray-800">
    <div id="header-placeholder"></div>

    <header class="py-6 text-center">
        <h1 class="text-3xl font-bold text-blue-700">우리동네 가게</h1>
        <p class="text-gray-600 mt-1">ncategory2 매니저(레이아웃 동일) - combined_store_info 연결</p>
    </header>

    <div class="max-w-6xl mx-auto grid grid-cols-12 gap-6 py-6 px-4">

        <!-- 좌측 사이드바 (원본 유지) -->
        <aside class="col-span-3 neo-card p-3 h-full max-h-[1346px] sidebar-scroll">
            <h2 class="font-bold text-2xl mb-4 text-center">CATEGORY</h2>
            <ul class="space-y-3">
                <li class="mb-5">
                    <button
                        class="w-full text-left pl-16 pr-3 py-2 neo-card flex justify-between items-center font-bold text-xl"
                        onclick="toggleSub(this)">
                        병 원 <span>▼</span>
                    </button>
                    <ul class="ml-4 mt-1 space-y-3 hidden">
                        <li><a href="/subcategory.html?type=hospital&category=종합병원"
                                class="block px-5 py-2 neo-card text-center">종합병원</a></li>
                        <li><a href="/subcategory.html?type=hospital&category=내과"
                                class="block px-3 py-2 neo-card text-center">내과</a></li>
                        <li><a href="/subcategory.html?type=hospital&category=치과"
                                class="block px-3 py-2 neo-card text-center">치과</a></li>
                        <li><a href="/subcategory.html?type=hospital&category=소아과"
                                class="block px-3 py-2 neo-card text-center">소아과</a></li>
                        <li><a href="/subcategory.html?type=hospital&category=정형외과"
                                class="block px-3 py-2 neo-card text-center">정형외과</a></li>
                        <li><a href="/subcategory.html?type=hospital&category=산부인과"
                                class="block px-3 py-2 neo-card text-center">산부인과</a></li>
                        <li><a href="/subcategory.html?type=hospital&category=한의원"
                                class="block px-3 py-2 neo-card text-center">한의원</a></li>
                        <li><a href="/subcategory.html?type=hospital&category=기타"
                                class="block px-3 py-2 neo-card text-center">기타</a></li>
                    </ul>
                </li>
            </ul>

            <div class="neo-card mt-6 p-4 text-center border-2 border-dashed border-blue-300">
                <h3 class="font-bold text-lg mb-2">광고 영역</h3>
                <p class="text-sm text-gray-600">이곳은 광고 배너/이미지가 들어갈 박스입니다.</p>
                <img src="/uploads/sample-ad.jpg" alt="광고 이미지" class="mt-3 w-full h-[30px] object-cover rounded-xl">
            </div>
        </aside>

        <!-- 중앙 메인 -->
        <main class="col-span-9 space-y-8">

            <!-- ✅ Premium 카테고리 박스도 슬롯(클릭→모달)로 변경 -->
            <section class="relative h-60 neo-card overflow-hidden admin-slot" data-position="ncategory2_premium"
                data-label="Premium 카테고리">

                <!-- 슬롯 이미지(있으면 표시) -->
                <img data-role="img" src="/uploads/sample-main-banner.jpg"
                    class="absolute inset-0 w-full h-full object-cover" alt="Premium Banner">

                <!-- 오버레이 -->
                <div class="absolute inset-0 bg-white/35 backdrop-blur-[2px]"></div>

                <div class="relative h-full flex items-center justify-center">
                    <div class="text-center neo-card px-6 py-4">
                        <h1 class="text-3xl font-bold mb-2" data-role="name">Premium 카테고리</h1>
                        <p class="text-gray-700 text-sm" data-role="desc">카테고리 설명 문구를 여기에 넣습니다.</p>
                    </div>
                </div>
            </section>

            <!-- 파워 광고 -->
            <section class="mt-10">
                <h2 class="font-bold text-2xl text-purple-600 text-center mb-4">강력 추천</h2>

                <div id="powerViewport" class="relative overflow-hidden">
                    <div id="powerAdTrack"
                        class="flex transition-transform duration-500 ease-in-out will-change-transform"></div>

                    <button id="prevBtn"
                        class="absolute left-0 top-1/2 -translate-y-1/2 bg-white shadow rounded-full px-3 py-2">‹</button>
                    <button id="nextBtn"
                        class="absolute right-0 top-1/2 -translate-y-1/2 bg-white shadow rounded-full px-3 py-2">›</button>
                </div>
            </section>

            <!-- 최고의 가게 영역 -->
            <section class="grid grid-cols-12 gap-6 items-stretch">
                <div class="col-span-3 h-full">
                    <div class="neo-card p-4 w-full h-full flex flex-col gap-4">

                        <div class="flex-1 flex flex-col">
                            <h2 class="font-bold text-2xl text-blue-600 text-center mb-3">MVP</h2>
                            <a href="#"
                                class="neo-card p-0 overflow-hidden relative rounded-2xl h-full border-2 border-blue-500 admin-slot"
                                data-position="ncategory2_mvp" data-label="MVP">
                                <img data-role="img" src="/uploads/sample-left-top.jpg"
                                    class="w-full h-full object-cover" alt="MVP">
                                <div
                                    class="absolute left-3 right-3 bottom-3 bg-white/70 backdrop-blur-md rounded-xl shadow px-4 py-2 text-center">
                                    <div class="font-bold text-lg leading-tight" data-role="name">상호명 Top</div>
                                    <div class="text-sm text-slate-600" data-role="category">업종: 한식</div>
                                </div>
                            </a>
                        </div>

                        <div class="flex-1 flex flex-col">
                            <h2 class="font-bold text-2xl text-yellow-600 text-center mb-3">HIGHLIGHT</h2>
                            <a href="#"
                                class="neo-card p-0 overflow-hidden relative rounded-2xl h-full border-2 border-yellow-500 admin-slot"
                                data-position="ncategory2_highlight" data-label="HIGHLIGHT">
                                <img data-role="img" src="/uploads/sample-left-bottom.jpg"
                                    class="w-full h-full object-cover" alt="HIGHLIGHT">
                                <div
                                    class="absolute left-3 right-3 bottom-3 bg-white/70 backdrop-blur-md rounded-xl shadow px-4 py-2 text-center">
                                    <div class="font-bold text-lg leading-tight" data-role="name">상호명 Bottom</div>
                                    <div class="text-sm text-slate-600" data-role="category">업종: 카페</div>
                                </div>
                            </a>
                        </div>

                    </div>
                </div>

                <div class="col-span-9 flex flex-col gap-6">
                    <div class="neo-card p-5">
                        <h2 class="font-bold mb-3 text-2xl text-center">최고의 가게</h2>
                        <div id="bestGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                    </div>
                </div>
            </section>

            <div class="grid grid-cols-2 gap-6">
                <div class="neo-card p-6 text-center">
                    <h3 class="font-bold text-lg mb-2">하단 박스 1</h3>
                    <p class="text-gray-600 text-sm">이곳은 설명 텍스트</p>
                </div>
                <div class="neo-card p-6 text-center">
                    <h3 class="font-bold text-lg mb-2">하단 박스 2</h3>
                    <p class="text-gray-600 text-sm">이곳은 설명 텍스트</p>
                </div>
            </div>

        </main>
    </div>

    <!-- 오른쪽 하단 네비 -->
    <div class="fixed bottom-6 right-6 flex flex-col items-center gap-4 z-50">
        <div class="flex flex-col items-center">
            <button onclick="goBack()"
                class="w-14 h-14 flex items-center justify-center rounded-full bg-gradient-to-br from-gray-100 to-gray-200 text-gray-700 shadow hover:from-gray-200 hover:to-gray-300 transition">
                ←
            </button>
            <span class="text-xs mt-1 text-gray-600 font-semibold">이전</span>
        </div>

        <div class="flex flex-col items-center">
            <button onclick="goNext()"
                class="w-14 h-14 flex items-center justify-center rounded-full bg-gradient-to-br from-gray-100 to-gray-200 text-gray-700 shadow hover:from-gray-200 hover:to-gray-300 transition">
                →
            </button>
            <span class="text-xs mt-1 text-gray-600 font-semibold">다음</span>
        </div>

        <div class="flex flex-col items-center">
            <a href="/index.html"
                class="w-14 h-14 flex items-center justify-center rounded-full bg-gradient-to-br from-blue-500 to-blue-600 text-white shadow hover:from-blue-600 hover:to-blue-700 transition">
                🏠
            </a>
            <span class="text-xs mt-1 text-gray-600 font-semibold">홈</span>
        </div>
    </div>

    <div id="footer-placeholder"></div>

    <!-- ✅ 공통 모달 (foodcategorymanager 모달 그대로) : </body> 바로 위에 넣기 -->
    <div id="slotModal" class="hidden">
        <div class="modal-backdrop" onclick="closeSlotModal()"></div>

        <div class="modal-panel">
            <div class="modal-card">
                <!-- 헤더 -->
                <div class="p-6 sticky top-0 bg-white/90 backdrop-blur border-b border-slate-100 z-10">
                    <div class="flex items-start justify-between gap-4">
                        <div>
                            <h3 id="modalTitle" class="text-xl sm:text-2xl font-extrabold">슬롯 수정</h3>
                            <p class="text-xs text-gray-500 mt-1">
                                page: <b id="modalPageText"></b> /
                                position: <span id="modalPositionText" class="font-semibold"></span> /
                                priority: <span id="modalPriorityText" class="font-semibold"></span>
                            </p>
                        </div>

                        <div class="flex items-center gap-2">
                            <!-- 사용법 -->
                            <div class="relative">
                                <button type="button" id="adHelpBtn"
                                    class="inline-flex items-center gap-2 rounded-xl border border-blue-200 bg-white/80 px-3 py-1.5 text-sm font-semibold text-blue-700 shadow-sm hover:bg-white"
                                    aria-expanded="false" aria-controls="adHelpPopover" title="사용법 보기">
                                    <span
                                        class="inline-flex h-5 w-5 items-center justify-center rounded-full bg-blue-600 text-white text-xs leading-none">?</span>
                                    사용법
                                </button>

                                <div id="adHelpPopover"
                                    class="hidden absolute right-0 mt-2 w-[min(420px,calc(100vw-2rem))] rounded-2xl border border-blue-200 bg-white/95 p-4 shadow-xl backdrop-blur">
                                    <div class="flex items-start justify-between gap-3">
                                        <div class="font-extrabold text-slate-800">✅ 사용 흐름</div>
                                        <button type="button" id="adHelpCloseBtn"
                                            class="rounded-lg px-2 py-1 text-xs font-bold text-slate-500 hover:bg-slate-100">닫기</button>
                                    </div>

                                    <ol class="mt-3 space-y-2 text-sm text-slate-700 leading-relaxed list-decimal pl-5">
                                        <li><b>/admin/ncategory2manager.html</b> 접속</li>
                                        <li>원하는 슬롯 클릭 → <b>모달 열림</b></li>
                                        <li><b>우선순위</b> 선택(기본 1) → 내용/이미지/기간 입력 → <b>저장</b></li>
                                        <li>같은 슬롯에서 다른 우선순위(2,3…)를 선택해 후보 추가 가능</li>
                                    </ol>

                                    <div class="mt-3 rounded-xl bg-blue-50 px-3 py-2 text-xs text-blue-900">
                                        ※ 실제 노출은 “기간 조건이 맞는 후보 중 우선순위 숫자가 가장 작은 것”이 선택됩니다.
                                    </div>
                                </div>
                            </div>

                            <button id="btnCloseModal" onclick="closeSlotModal()"
                                class="px-3 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-slate-700 text-sm">
                                닫기
                            </button>
                        </div>
                    </div>

                    <!-- 상태 -->
                    <div id="m_status" class="mt-4 text-sm text-slate-700"></div>
                </div>

                <!-- 본문 -->
                <div class="p-6">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-5">
                        <!-- LEFT: 콘텐츠 -->
                        <div class="rounded-2xl border border-slate-200 bg-white/70 p-4">
                            <div class="font-extrabold text-slate-800 mb-3">콘텐츠</div>

                            <!-- 모드 -->
                            <div class="flex flex-wrap gap-3">
                                <label class="flex items-center gap-2 text-sm">
                                    <input type="radio" name="m_slotMode" value="banner" checked />
                                    <span class="font-semibold">배너(이미지/텍스트)</span>
                                </label>
                                <label class="flex items-center gap-2 text-sm">
                                    <input type="radio" name="m_slotMode" value="store" />
                                    <span class="font-semibold">가게 연결</span>
                                </label>
                            </div>

                            <!-- 우선순위 -->
                            <div class="mt-4">
                                <label class="block text-sm font-bold text-slate-700 mb-1">우선순위</label>
                                <select id="m_priority_select"
                                    class="w-full rounded-xl border border-slate-200 bg-white/70 px-3 py-2">
                                    <option value="1" selected>1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                    <option value="5">5</option>
                                </select>
                            </div>

                            <!-- 기간 -->
                            <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-bold text-slate-700 mb-1">시작일</label>
                                    <input id="m_startAt" type="datetime-local"
                                        class="w-full rounded-xl border border-slate-200 bg-white/70 px-3 py-2" />
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-slate-700 mb-1">종료일</label>
                                    <input id="m_endAt" type="datetime-local"
                                        class="w-full rounded-xl border border-slate-200 bg-white/70 px-3 py-2" />
                                </div>
                            </div>

                            <div class="mt-2 flex items-center gap-3 text-sm">
                                <label class="flex items-center gap-2">
                                    <input id="m_noEnd" type="checkbox" />
                                    <span>종료 없음</span>
                                </label>
                            </div>

                            <!-- 이미지 -->
                            <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-bold text-slate-700 mb-1">이미지 업로드</label>
                                    <input id="m_imageFile" type="file" accept="image/*"
                                        class="w-full rounded-xl border border-slate-200 bg-white/70 px-3 py-2" />
                                    <div class="mt-2 flex items-center gap-3 text-sm">
                                        <label class="flex items-center gap-2">
                                            <input id="m_keepImage" type="checkbox" />
                                            <span>기존 이미지 유지</span>
                                        </label>
                                        <label class="flex items-center gap-2">
                                            <input id="m_clearImage" type="checkbox" />
                                            <span>이미지 제거</span>
                                        </label>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-bold text-slate-700 mb-1">이미지 URL(선택)</label>
                                    <input id="m_imageUrl" type="text" placeholder="/uploads/manager_ad/xxx.jpg"
                                        class="w-full rounded-xl border border-slate-200 bg-white/70 px-3 py-2" />
                                </div>
                            </div>

                            <!-- 미리보기 -->
                            <div class="mt-4">
                                <label class="block text-sm font-bold text-slate-700 mb-2">미리보기</label>
                                <div
                                    class="w-full h-48 rounded-2xl bg-white/50 border border-slate-200 overflow-hidden flex items-center justify-center">
                                    <img id="m_previewImg" class="hidden w-full h-full object-cover" alt="preview" />
                                    <div id="m_previewEmpty" class="text-sm text-slate-400">이미지를 선택하거나 URL을 입력하세요</div>
                                </div>
                            </div>

                            <!-- 링크/텍스트 -->
                            <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-bold text-slate-700 mb-1">링크 URL</label>
                                    <input id="m_linkUrl" type="text" placeholder="/ndetail.html?id=1&type=combined"
                                        class="w-full rounded-xl border border-slate-200 bg-white/70 px-3 py-2" />
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-slate-700 mb-1">텍스트(선택)</label>
                                    <input id="m_textContent" type="text" placeholder="홍보 문구"
                                        class="w-full rounded-xl border border-slate-200 bg-white/70 px-3 py-2" />
                                </div>
                            </div>
                        </div>

                        <!-- RIGHT: 가게 검색 -->
                        <div class="rounded-2xl border border-slate-200 bg-white/70 p-4">
                            <div class="font-extrabold text-slate-800 mb-3">가게 검색 / 연결</div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-bold text-slate-700 mb-1">가게명/업종 검색</label>
                                    <input id="storeSearchQ" type="text" placeholder="예: 하늘식당"
                                        class="w-full rounded-xl border border-slate-200 bg-white/70 px-3 py-2" />
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-slate-700 mb-1">사업자번호 검색</label>
                                    <input id="storeSearchBizNo" type="text" inputmode="numeric"
                                        placeholder="예: 2910802895"
                                        class="w-full rounded-xl border border-slate-200 bg-white/70 px-3 py-2" />
                                </div>
                            </div>

                            <div class="mt-3 flex items-center gap-2">
                                <button type="button"
                                    class="px-4 py-2 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-700"
                                    onclick="doStoreSearch()">가게 검색</button>
                                <div class="text-sm text-slate-500">검색 결과에서 <b>선택</b>하면 자동 매핑됩니다.</div>
                            </div>

                            <div class="mt-4">
                                <div class="font-bold text-slate-800">검색 결과</div>
                                <div id="storeSearchResults" class="mt-2 space-y-2">
                                    <div class="text-sm text-slate-500">검색어를 입력하고 “가게 검색”을 눌러주세요.</div>
                                </div>
                            </div>

                            <div class="mt-5 border-t border-slate-200 pt-4">
                                <div class="font-bold text-slate-800 mb-2">선택된 가게 정보(자동 입력)</div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-sm font-bold text-slate-700 mb-1">table_source</label>
                                        <input id="m_tableSource" type="text" readonly
                                            class="w-full rounded-xl border border-slate-200 bg-slate-100 px-3 py-2" />
                                    </div>
                                    <div>
                                        <label class="block text-sm font-bold text-slate-700 mb-1">store_id</label>
                                        <input id="m_storeId" type="text" readonly
                                            class="w-full rounded-xl border border-slate-200 bg-slate-100 px-3 py-2" />
                                    </div>

                                    <div>
                                        <label class="block text-sm font-bold text-slate-700 mb-1">사업자번호</label>
                                        <input id="m_businessNo" type="text" readonly
                                            class="w-full rounded-xl border border-slate-200 bg-slate-100 px-3 py-2" />
                                    </div>
                                    <div>
                                        <label class="block text-sm font-bold text-slate-700 mb-1">상호명</label>
                                        <input id="m_businessName" type="text" readonly
                                            class="w-full rounded-xl border border-slate-200 bg-slate-100 px-3 py-2" />
                                    </div>

                                    <div class="md:col-span-2">
                                        <label class="block text-sm font-bold text-slate-700 mb-1">업종(표시용)</label>
                                        <input id="m_categoryView" type="text" readonly
                                            class="w-full rounded-xl border border-slate-200 bg-slate-100 px-3 py-2" />
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>

                    <!-- 저장 -->
                    <div class="mt-6 flex justify-end gap-2">
                        <button type="button" onclick="saveSlotFromModal()"
                            class="px-5 py-2 rounded-xl bg-blue-600 text-white font-extrabold hover:bg-blue-700">
                            저장
                        </button>
                    </div>

                    <!-- hidden keys -->
                    <input id="m_page" type="hidden" />
                    <input id="m_position" type="hidden" />
                    <input id="m_priority" type="hidden" />
                </div>
            </div>
        </div>
    </div>


    <!-- 본문 -->
    <div class="p-6 space-y-6">
        <!-- 텍스트 전용 슬롯 안내 -->
        <div id="textOnlyHint" class="hidden rounded-2xl border border-slate-100 bg-slate-50 p-4">
            <div class="text-sm font-bold text-slate-800">📝 이 슬롯은 텍스트 전용입니다.</div>
            <div class="mt-1 text-xs text-slate-500">
                이미지/가게연결/링크 입력은 숨김 처리됩니다. (글만 작성)
            </div>
        </div>

        <!-- 모드 선택 -->
        <div id="modeBlock" class="rounded-xl border border-slate-100 bg-slate-50 p-4">
            <p class="text-sm font-semibold mb-3">광고 방식 선택</p>
            <div class="flex flex-wrap gap-4">
                <label class="flex items-center gap-2 text-sm">
                    <input type="radio" name="slotMode" value="image" class="accent-blue-600" checked>
                    <span>이미지 배너</span>
                </label>
                <label class="flex items-center gap-2 text-sm">
                    <input type="radio" name="slotMode" value="store" class="accent-emerald-600">
                    <span>가게 연결</span>
                </label>
                <label class="flex items-center gap-2 text-sm">
                    <input type="radio" name="slotMode" value="text" class="accent-indigo-600">
                    <span>텍스트 전용</span>
                </label>
            </div>
        </div>

        <!-- 텍스트 입력 -->
        <div id="textBlock" class="hidden space-y-2">
            <label class="text-sm font-semibold">내용 (텍스트)</label>
            <textarea id="fieldTextContent" class="field mt-2 min-h-[180px] resize-y"
                placeholder="예) 한 줄당 1개씩 입력&#10;첫번째 줄&#10;두번째 줄&#10;세번째 줄"></textarea>
            <p class="text-xs text-gray-500">
                줄바꿈(Enter) 기준으로 표시됩니다. (사이드 링크 슬롯은 이름|링크 형식)
            </p>
        </div>

        <!-- 링크 -->
        <div id="linkBlock">
            <label class="text-sm font-semibold">링크 URL (선택)</label>
            <input id="fieldLinkUrl" class="field mt-2" placeholder="/ndetail.html?id=123&type=store 또는 https://..." />
        </div>

        <div id="dividerAfterLink" class="divider"></div>

        <!-- 이미지 블록 -->
        <div id="imageBlock" class="space-y-4">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label class="text-sm font-semibold">이미지 파일</label>
                    <input id="fieldImageFile" type="file" accept="image/*" class="field mt-2 bg-white" />
                    <p class="text-xs text-gray-500 mt-1">
                        파일을 선택하지 않으면, 가게 연결 시 가게 대표 이미지를 사용합니다.
                    </p>
                </div>
                <div>
                    <label class="text-sm font-semibold">현재 이미지 미리보기</label>
                    <div
                        class="mt-2 rounded-lg border border-gray-100 bg-gray-50 overflow-hidden aspect-[16/9] flex items-center justify-center">
                        <img id="currentPreviewImg" src="" alt="preview" class="w-full h-full object-cover hidden" />
                        <span id="currentPreviewEmpty" class="text-xs text-gray-400">이미지 없음</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 가게 연결 블록 -->
        <div id="storeBlock" class="space-y-4 hidden">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label class="text-sm font-semibold">사업자번호</label>
                    <input id="fieldBizNo" class="field mt-2" placeholder="예) 2910802895" />
                </div>
                <div>
                    <label class="text-sm font-semibold">상호명</label>
                    <input id="fieldBizName" class="field mt-2" placeholder="예) 하늘식당" />
                </div>
            </div>

            <div class="flex items-center gap-2">
                <button id="btnSearchStore"
                    class="px-4 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white text-sm">
                    가게 검색
                </button>
                <span id="storeSearchHint" class="text-xs text-gray-500"></span>
            </div>

            <div id="storeResults" class="border border-slate-100 rounded-xl overflow-hidden">
                <div class="px-4 py-3 bg-slate-50 text-sm font-semibold">검색 결과</div>
                <div id="storeResultsBody" class="p-4 text-sm text-gray-500">
                    검색어를 입력하고 “가게 검색”을 눌러주세요.
                </div>
            </div>

            <input id="fieldStoreId" type="hidden" />
            <input id="fieldTableSource" type="hidden" />
        </div>

        <div class="divider"></div>

        <!-- 우선순위 -->
        <div class="mt-4 p-3 rounded-xl border border-blue-100 bg-white/70">
            <div class="flex flex-col md:flex-row md:items-end gap-3">
                <div class="flex-1">
                    <label class="text-sm font-semibold text-gray-700">우선순위</label>
                    <input name="priority" id="adPriority" type="number" min="1" step="1" value="1"
                        class="mt-1 w-full rounded-xl border border-gray-200 px-3 py-2 outline-none focus:ring-2 focus:ring-blue-300" />
                    <p class="mt-1 text-xs text-gray-500">
                        1이 가장 먼저 노출됩니다. (1,2,3… 여러 개 등록 가능)
                    </p>
                </div>

                <button type="button" id="btnLoadPriority"
                    class="rounded-xl px-4 py-2 border border-blue-200 bg-blue-50 hover:bg-blue-100 text-sm">
                    이 우선순위 불러오기
                </button>

                <button type="button" id="btnDeletePriority"
                    class="rounded-xl px-4 py-2 border border-red-200 bg-red-50 hover:bg-red-100 text-sm">
                    이 우선순위 삭제
                </button>
            </div>

            <details class="mt-3">
                <summary class="cursor-pointer text-sm text-gray-700">등록된 후보 목록 보기 (1~6)</summary>
                <div id="candidateList" class="mt-2 grid gap-2"></div>
            </details>

            <div id="prioritySupportHint" class="mt-3 text-xs text-slate-500"></div>
        </div>

        <!-- 기간 -->
        <div class="rounded-xl border border-slate-100 p-4">
            <div class="flex items-center justify-between">
                <p class="text-sm font-semibold">광고 기간 설정</p>
                <label class="flex items-center gap-2 text-xs">
                    <input id="fieldNoEnd" type="checkbox" class="accent-blue-600">
                    <span class="text-gray-700">계속 유지 (종료 없음)</span>
                </label>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4">
                <div>
                    <label class="text-xs font-semibold text-gray-600">시작 일시</label>
                    <input id="fieldStartAt" type="datetime-local" class="field mt-2" />
                </div>
                <div>
                    <label class="text-xs font-semibold text-gray-600">종료 일시</label>
                    <input id="fieldEndAt" type="datetime-local" class="field mt-2" />
                </div>
            </div>
        </div>

        <!-- 요약 -->
        <div class="rounded-xl border border-slate-100 bg-slate-50 p-4">
            <p class="text-sm font-semibold mb-2">현재 선택 정보</p>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm">
                <div class="flex items-center gap-2">
                    <span class="text-gray-500">선택 이미지:</span>
                    <span id="textSelectedImage" class="font-semibold text-slate-800">없음</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-gray-500">연결 가게:</span>
                    <span id="textSelectedStore" class="font-semibold text-slate-800">없음</span>
                </div>
            </div>

            <div class="mt-2 text-xs text-slate-500">
                텍스트 전용 슬롯은 “선택 이미지/연결 가게”가 표시되지 않습니다.
            </div>
        </div>

        <!-- 버튼 -->
        <div class="flex flex-col sm:flex-row gap-2 sm:justify-end">
            <button id="btnResetModal"
                class="px-4 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-slate-700 text-sm">
                입력 초기화
            </button>
            <button id="btnSaveSlot"
                class="px-5 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold">
                슬롯 저장
            </button>
        </div>
    </div>
    </div>
    </div>
    </div>

    <script>
        // =========================
        // ✅ 공통 유틸 / 헤더푸터
        // =========================
        const el = (id) => document.getElementById(id);
        const clean = (v) => (v == null ? "" : String(v).trim());
        const digitsOnly = (v) => clean(v).replace(/[^\d]/g, "");

        // header/footer
        (async () => {
            try {
                const h = await fetch("/components/header.html").then((r) => r.text());
                const hp = el("header-placeholder");
                if (hp) hp.innerHTML = h;
            } catch (_) { }
            try {
                const f = await fetch("/components/footer.html").then((r) => r.text());
                const fp = el("footer-placeholder");
                if (fp) fp.innerHTML = f;
            } catch (_) { }
        })();

        function toggleSub(btn) {
            const ul = btn?.nextElementSibling;
            if (!ul) return;
            ul.classList.toggle("hidden");
        }

        function goBack() {
            if (document.referrer && document.referrer !== location.href) window.history.back();
            else window.location.href = "/category.html";
        }
        function goNext() {
            window.history.forward();
        }

        // 전역 노출(HTML onclick)
        window.toggleSub = toggleSub;
        window.goBack = goBack;
        window.goNext = goNext;

        // =========================
        // ✅ API 설정
        // =========================
        const API_BASE = "/ncategory2manager/ad";
        const PAGE = "ncategory2";
        const DEFAULT_TABLE_SOURCE = "combined_store_info";

        function buildStoreLink(tableSource, storeId) {
            const t = clean(tableSource) || DEFAULT_TABLE_SOURCE;
            const id = clean(storeId);
            if (!id) return "#";

            if (t === "combined_store_info" || t === "combined") {
                return `/ndetail.html?id=${encodeURIComponent(id)}&type=combined`;
            }
            if (t === "food_stores" || t === "food") {
                return `/ndetail.html?id=${encodeURIComponent(id)}&type=food`;
            }
            if (t === "store_info") {
                return `/detail.html?id=${encodeURIComponent(id)}`;
            }
            return `/ndetail.html?id=${encodeURIComponent(id)}&type=combined`;
        }

        async function fetchJson(url, opt = {}) {
            const r = await fetch(url, opt);
            const data = await r.json().catch(() => ({}));
            if (!r.ok) throw new Error(data?.error || data?.message || `HTTP ${r.status}`);
            return data;
        }

        async function apiListSlots() {
            const data = await fetchJson(`${API_BASE}/slots?page=${encodeURIComponent(PAGE)}`);
            if (data?.success === true) return data.slots || [];
            if (Array.isArray(data?.slots)) return data.slots;
            return [];
        }

        async function apiGetSlot({ page, position, priority }) {
            const url = new URL(`${API_BASE}/slot`, window.location.origin);
            if (page) url.searchParams.set("page", page);
            if (position) url.searchParams.set("position", position);
            if (priority !== "" && priority != null) url.searchParams.set("priority", String(priority));
            return await fetchJson(url.toString());
        }

        async function apiUpsertSlot(formData) {
            const data = await fetchJson(`${API_BASE}/slot`, { method: "POST", body: formData });
            if (!data || data.success !== true) throw new Error(data?.error || "저장 실패");
            return data.slot || null;
        }

        async function apiSearchStore({ q, bizNo }) {
            const Q = clean(q);
            const B = digitsOnly(bizNo);

            const params = new URLSearchParams();
            if (Q) params.set("q", Q);
            if (B) {
                params.set("bizNo", B);
                params.set("businessNo", B);
                params.set("business_no", B);
            }

            // ✅ 푸드/기존 컨트롤러 경로차이 대비 (fallback)
            const tryUrls = [
                `${API_BASE}/store/search?${params.toString()}`,
                `${API_BASE}/search-store?${params.toString()}`,
                `${API_BASE}/store-search?${params.toString()}`,
                `${API_BASE}/searchStore?${params.toString()}`,
                `${API_BASE}/stores/search?${params.toString()}`,
            ];

            let lastErr = null;
            for (const u of tryUrls) {
                try {
                    const data = await fetchJson(u);
                    if (data?.success === true || data?.ok === true) return data.stores || [];
                    if (Array.isArray(data?.stores)) return data.stores;
                    if (Array.isArray(data?.data)) return data.data;
                    if (Array.isArray(data)) return data;
                    return data?.stores || [];
                } catch (e) {
                    lastErr = e;
                }
            }
            throw lastErr || new Error("검색 실패");
        }

        // =========================
        // ✅ 슬롯 DOM 생성(파워/베스트)
        // =========================
        const POWER_POS = Array.from({ length: 9 }, (_, i) => `ncategory2_power_${i + 1}`);
        const BEST_POS = Array.from({ length: 9 }, (_, i) => `ncategory2_best_${i + 1}`);

        const state = {
            slots: new Map(),
            currentKey: { page: PAGE, position: "", priority: "" },
            selectedCategory: "",
        };

        function pickCategory(obj) {
            return clean(
                obj?.category ||
                obj?.business_category ||
                obj?.businessCategory ||
                obj?.store_category ||
                obj?.storeCategory ||
                ""
            );
        }

        function makeSlotCard(position, label, imgHClass = "h-60 md:h-64") {
            const wrap = document.createElement("div");
            wrap.className = "neo-card p-0 overflow-hidden relative rounded-2xl border-4 border-yellow-200 admin-slot";
            wrap.setAttribute("data-position", position);
            wrap.setAttribute("data-label", label);
            wrap.innerHTML = `
      <div class="w-full ${imgHClass} bg-white/40 flex items-center justify-center">
        <img data-role="img" src="" alt="${label}" class="w-full h-full object-cover hidden">
        <div data-role="noimg" class="text-xs text-slate-500">NO IMG</div>
      </div>
      <div class="absolute left-3 right-3 bottom-3 bg-white/70 backdrop-blur-md rounded-xl shadow px-4 py-2 text-center">
        <div class="font-bold text-lg" data-role="name">${label}</div>
        <div class="text-sm text-slate-600" data-role="category">업종:</div>
      </div>
    `;
            return wrap;
        }

        function buildPowerSliderDom() {
            const track = el("powerAdTrack");
            if (!track) return;
            track.innerHTML = "";

            for (let g = 0; g < 3; g++) {
                const group = document.createElement("div");
                group.className = "power-group flex basis-full shrink-0";

                for (let i = 0; i < 3; i++) {
                    const idx = g * 3 + i;
                    const pos = POWER_POS[idx];

                    const col = document.createElement("div");
                    col.className = "w-1/3 px-2";

                    const a = document.createElement("a");
                    a.href = "#";
                    a.className = "block";
                    a.appendChild(makeSlotCard(pos, `강력추천 ${idx + 1}`));

                    col.appendChild(a);
                    group.appendChild(col);
                }
                track.appendChild(group);
            }
        }

        function buildBestGridDom() {
            const grid = el("bestGrid");
            if (!grid) return;
            grid.innerHTML = "";

            for (let i = 0; i < 9; i++) {
                const pos = BEST_POS[i];

                const a = document.createElement("a");
                a.href = "#";
                a.className = "block";

                const card = document.createElement("div");
                card.className = "neo-card p-0 overflow-hidden relative rounded-2xl transition-transform admin-slot";
                card.setAttribute("data-position", pos);
                card.setAttribute("data-label", `최고의가게 ${i + 1}`);

                card.innerHTML = `
        <div class="w-full h-60 bg-white/40 flex items-center justify-center">
          <img data-role="img" src="" alt="상호명" class="w-full h-full object-cover hidden">
          <div data-role="noimg" class="text-xs text-slate-500">NO IMG</div>
        </div>
        <div class="absolute left-3 right-3 bottom-3 bg-white/70 backdrop-blur-md rounded-xl shadow px-4 py-3">
          <div class="font-bold text-lg leading-tight" data-role="name">상호명</div>
          <div class="text-sm text-slate-600" data-role="category">업종:</div>
        </div>
      `;

                a.appendChild(card);
                grid.appendChild(a);
            }
        }

        function applySlotToEl(slotEl, slot) {
            if (!slotEl) return;

            const img = slotEl.querySelector('[data-role="img"]');
            const noimg = slotEl.querySelector('[data-role="noimg"]');
            const name = slotEl.querySelector('[data-role="name"]');
            const category = slotEl.querySelector('[data-role="category"]');
            const desc = slotEl.querySelector('[data-role="desc"]'); // Premium 설명용

            const imageUrl = clean(slot?.image_url || slot?.imageUrl || "");
            const businessName =
                clean(slot?.business_name || slot?.businessName || "") ||
                clean(slotEl.getAttribute("data-label") || "");

            const cat = pickCategory(slot);
            const textContent = clean(slot?.text_content || slot?.textContent || "");

            if (img) {
                if (imageUrl) {
                    img.src = imageUrl;
                    img.classList.remove("hidden");
                    if (noimg) noimg.classList.add("hidden");
                } else {
                    img.src = "";
                    img.classList.add("hidden");
                    if (noimg) noimg.classList.remove("hidden");
                }
            }

            if (name) name.textContent = businessName || "";
            if (category) category.textContent = cat ? `업종: ${cat}` : "업종:";
            if (desc) desc.textContent = textContent || desc.textContent || "";

            const a = slotEl.closest("a");
            if (a) a.href = clean(slot?.link_url || slot?.linkUrl || "") || "#";
        }

        async function loadAndRender() {
            const rows = await apiListSlots();
            state.slots.clear();
            rows.forEach((r) => state.slots.set(r.position, r));

            document.querySelectorAll("[data-position]").forEach((slotEl) => {
                const pos = slotEl.getAttribute("data-position");
                applySlotToEl(slotEl, state.slots.get(pos));
            });
        }

        // =========================
        // ✅ 파워 슬라이더(2개씩 이동 / 왕복)
        // =========================
        function initPowerSlider() {
            const viewport = el("powerViewport");
            const track = el("powerAdTrack");
            if (!viewport || !track) return;

            const groups = track.querySelectorAll(".power-group").length;
            let index = Math.floor(Math.random() * Math.max(groups, 1));
            let dir = 1;

            function updateSlider() {
                const slideWidth = viewport.clientWidth;
                track.style.transform = `translateX(${-index * slideWidth}px)`;
            }

            function stepAuto() {
                if (groups <= 1) return;
                if (index >= groups - 1) dir = -1;
                else if (index <= 0) dir = 1;
                index = index + dir;
                updateSlider();
            }

            function nextManual() {
                if (groups <= 1) return;
                if (index < groups - 1) index++;
                else { dir = -1; index = groups - 2; }
                updateSlider();
            }

            function prevManual() {
                if (groups <= 1) return;
                if (index > 0) index--;
                else { dir = 1; index = 1; }
                updateSlider();
            }

            const nextBtn = el("nextBtn");
            const prevBtn = el("prevBtn");
            if (nextBtn) nextBtn.addEventListener("click", () => { stopAuto(); nextManual(); startAuto(); });
            if (prevBtn) prevBtn.addEventListener("click", () => { stopAuto(); prevManual(); startAuto(); });

            window.addEventListener("resize", updateSlider);

            const INTERVAL = 10000;
            let timer = null;
            function startAuto() { if (!timer) timer = setInterval(stepAuto, INTERVAL); }
            function stopAuto() { if (timer) { clearInterval(timer); timer = null; } }

            document.addEventListener("visibilitychange", () => { document.hidden ? stopAuto() : startAuto(); });
            viewport.addEventListener("mouseenter", stopAuto);
            viewport.addEventListener("mouseleave", startAuto);

            updateSlider();
            startAuto();
        }

        // =========================
        // ✅ 모달(푸드와 동일 동작)
        // =========================
        function setStatus(msg) {
            const s = el("m_status");
            if (s) s.textContent = msg || "";
        }

        function setPreview(url) {
            const img = el("m_previewImg");
            const empty = el("m_previewEmpty");
            if (!img || !empty) return;

            const u = clean(url);
            if (u) {
                img.src = u;
                img.classList.remove("hidden");
                empty.classList.add("hidden");
            } else {
                img.src = "";
                img.classList.add("hidden");
                empty.classList.remove("hidden");
            }
        }

        function getMode() {
            return document.querySelector('input[name="m_slotMode"]:checked')?.value || "banner";
        }

        function syncPriorityText() {
            const p = clean(el("m_priority")?.value || "");
            const t = el("modalPriorityText");
            if (t) t.textContent = p || "NULL";
        }

        function clearModalFields(keepKeys = true) {
            setStatus("");
            state.selectedCategory = "";

            // 콘텐츠
            if (el("m_imageFile")) el("m_imageFile").value = "";
            if (el("m_keepImage")) el("m_keepImage").checked = false;
            if (el("m_clearImage")) el("m_clearImage").checked = false;

            if (el("m_imageUrl")) el("m_imageUrl").value = "";
            setPreview("");

            if (el("m_linkUrl")) el("m_linkUrl").value = "";
            if (el("m_textContent")) el("m_textContent").value = "";

            // 기간
            if (el("m_startAt")) el("m_startAt").value = "";
            if (el("m_endAt")) el("m_endAt").value = "";
            if (el("m_noEnd")) el("m_noEnd").checked = false;

            // 가게
            if (el("m_tableSource")) el("m_tableSource").value = DEFAULT_TABLE_SOURCE;
            if (el("m_storeId")) el("m_storeId").value = "";
            if (el("m_businessNo")) el("m_businessNo").value = "";
            if (el("m_businessName")) el("m_businessName").value = "";
            if (el("m_categoryView")) el("m_categoryView").value = "";

            if (el("storeSearchResults")) el("storeSearchResults").innerHTML = `<div class="text-sm text-slate-500">검색어를 입력하고 “가게 검색”을 눌러주세요.</div>`;
            if (el("storeSearchQ")) el("storeSearchQ").value = "";
            if (el("storeSearchBizNo")) el("storeSearchBizNo").value = "";

            // 모드 기본 banner
            document.querySelectorAll('input[name="m_slotMode"]').forEach((r) => (r.checked = r.value === "banner"));

            // 우선순위 select 동기화(있으면)
            if (el("m_priority_select")) {
                const cur = clean(el("m_priority")?.value || "1") || "1";
                el("m_priority_select").value = cur;
            }

            if (!keepKeys) {
                if (el("m_page")) el("m_page").value = "";
                if (el("m_position")) el("m_position").value = "";
                if (el("m_priority")) el("m_priority").value = "";
            }
            syncPriorityText();
        }

        async function openSlotModal(position, priority = "") {
            state.currentKey.page = PAGE;
            state.currentKey.position = clean(position);
            state.currentKey.priority = (priority === null || priority === undefined) ? "" : String(priority);

            if (el("m_page")) el("m_page").value = state.currentKey.page;
            if (el("m_position")) el("m_position").value = state.currentKey.position;
            if (el("m_priority")) el("m_priority").value = state.currentKey.priority;

            // 상단 텍스트
            if (el("modalPageText")) el("modalPageText").textContent = state.currentKey.page;
            if (el("modalPositionText")) el("modalPositionText").textContent = state.currentKey.position;
            syncPriorityText();

            clearModalFields(true);

            const modalEl = el("slotModal");
            if (!modalEl) {
                alert("모달 #slotModal이 없습니다. HTML id 확인하세요.");
                return;
            }
            modalEl.classList.remove("hidden");

            // 우선순위 select가 있으면 hidden에 맞춰 세팅
            if (el("m_priority_select")) {
                const p = clean(el("m_priority")?.value || "1") || "1";
                el("m_priority_select").value = p;
            }

            // 로드
            try {
                await loadSlotIntoModal();
            } catch (err) {
                console.warn(err);
                setStatus("슬롯 로드 실패 (신규 입력 가능)");
            }
        }

        function closeSlotModal() {
            const modal = el("slotModal");
            if (!modal) return;
            modal.classList.add("hidden");
        }

        async function loadSlotIntoModal() {
            setStatus("불러오는 중...");

            const page = clean(el("m_page")?.value) || PAGE;
            const position = clean(el("m_position")?.value);
            const priority = clean(el("m_priority")?.value);

            const slot = await apiGetSlot({ page, position, priority });
            if (!slot) {
                setStatus("슬롯 없음(신규)");
                return;
            }

            // mode
            const mode = clean(slot.slot_mode || slot.slotMode || "banner");
            document.querySelectorAll('input[name="m_slotMode"]').forEach((r) => (r.checked = r.value === mode));

            // priority (서버가 내려주면 반영)
            const p = clean(slot.priority ?? priority);
            if (el("m_priority")) el("m_priority").value = p;
            if (el("m_priority_select") && p) el("m_priority_select").value = p;
            syncPriorityText();

            // 기간
            const startAt = clean(slot.start_at || slot.startAt || "");
            const endAt = clean(slot.end_at || slot.endAt || "");
            const noEnd = String(slot.no_end ?? slot.noEnd ?? "").toLowerCase() === "true" || slot.no_end === true || slot.noEnd === true;

            if (el("m_startAt")) el("m_startAt").value = startAt ? startAt.slice(0, 16) : "";
            if (el("m_endAt")) el("m_endAt").value = endAt ? endAt.slice(0, 16) : "";
            if (el("m_noEnd")) el("m_noEnd").checked = !!noEnd;
            if (el("m_endAt")) el("m_endAt").disabled = !!noEnd;

            // 이미지
            const img = clean(slot.image_url || slot.imageUrl || "");
            if (el("m_imageUrl")) el("m_imageUrl").value = img;
            setPreview(img);

            // 가게
            if (el("m_tableSource")) el("m_tableSource").value = clean(slot.table_source || slot.tableSource || DEFAULT_TABLE_SOURCE);
            if (el("m_storeId")) el("m_storeId").value = clean(slot.store_id || slot.storeId || "");
            if (el("m_businessNo")) el("m_businessNo").value = clean(slot.business_no || slot.businessNo || "");
            if (el("m_businessName")) el("m_businessName").value = clean(slot.business_name || slot.businessName || "");

            const cat = pickCategory(slot);
            state.selectedCategory = cat || "";
            if (el("m_categoryView")) el("m_categoryView").value = cat;

            // 링크/텍스트
            if (el("m_linkUrl")) el("m_linkUrl").value = clean(slot.link_url || slot.linkUrl || "");
            if (el("m_textContent")) el("m_textContent").value = clean(slot.text_content || slot.textContent || "");

            setStatus("불러오기 완료");
        }

        // ✅ 가게 검색
        async function doStoreSearch() {
            try {
                const q = clean(el("storeSearchQ")?.value);
                const bizNo = digitsOnly(clean(el("storeSearchBizNo")?.value));

                if (!q && !bizNo) {
                    el("storeSearchResults").innerHTML = `<div class="text-sm text-rose-600">가게명/업종 또는 사업자번호를 입력하세요</div>`;
                    return;
                }

                el("storeSearchResults").innerHTML = `<div class="text-sm text-slate-500">검색 중...</div>`;
                const stores = await apiSearchStore({ q, bizNo });
                renderStoreResults(stores || []);
            } catch (e) {
                console.error(e);
                el("storeSearchResults").innerHTML = `<div class="text-sm text-rose-600">검색 오류: ${e.message || "error"}</div>`;
            }
        }

        function renderStoreResults(stores) {
            const wrap = el("storeSearchResults");
            if (!wrap) return;
            wrap.innerHTML = "";

            if (!stores.length) {
                wrap.innerHTML = `<div class="text-sm text-slate-500">검색 결과 없음</div>`;
                return;
            }

            stores.forEach((s) => {
                const id = clean(s.id);
                const biz = clean(s.business_no || s.businessNo || s.business_number || "");
                const name = clean(s.business_name || s.businessName || s.business_name_kor || "");
                const cat = pickCategory(s);
                const img = clean(s.image_url || s.imageUrl || s.thumb_url || "");
                const tableSource = clean(s.table_source || s.tableSource || DEFAULT_TABLE_SOURCE);

                const row = document.createElement("div");
                row.className = "neo-card p-3 flex gap-3 items-center";

                row.innerHTML = `
        <div class="w-16 h-12 rounded-xl overflow-hidden bg-white/60 shrink-0">
          ${img ? `<img src="${img}" class="w-full h-full object-cover" />`
                        : `<div class="w-full h-full flex items-center justify-center text-xs text-slate-400">NO IMG</div>`}
        </div>
        <div class="flex-1 min-w-0">
          <div class="font-extrabold text-slate-800 truncate">${name || "-"}</div>
          <div class="text-xs text-slate-600 mt-0.5 truncate">${cat ? `(${cat})` : ""} ${biz ? `· ${biz}` : ""}</div>
          <div class="text-[11px] text-slate-400 mt-0.5 truncate">${tableSource} · id=${id}</div>
        </div>
        <button class="btn-3d shrink-0" type="button">선택</button>
      `;

                row.querySelector("button").addEventListener("click", () => {
                    applySelectedStore({
                        id,
                        business_no: biz,
                        business_name: name,
                        category: cat,
                        image_url: img,
                        table_source: tableSource,
                    });
                });

                wrap.appendChild(row);
            });
        }

        // ✅ “선택” 시 자동 매핑
        function applySelectedStore(store) {
            const storeId = clean(store.id);
            const businessNo = clean(store.business_no);
            const businessName = clean(store.business_name);
            const category = clean(store.category);
            const imageUrl = clean(store.image_url);
            const tableSource = clean(store.table_source) || DEFAULT_TABLE_SOURCE;

            state.selectedCategory = category || "";

            if (el("m_storeId")) el("m_storeId").value = storeId;
            if (el("m_tableSource")) el("m_tableSource").value = tableSource;
            if (el("m_businessNo")) el("m_businessNo").value = businessNo;
            if (el("m_businessName")) el("m_businessName").value = businessName;
            if (el("m_categoryView")) el("m_categoryView").value = category || "";

            if (el("m_imageUrl") && imageUrl) el("m_imageUrl").value = imageUrl;
            setPreview(imageUrl || clean(el("m_imageUrl")?.value));

            // 모드 store로
            document.querySelectorAll('input[name="m_slotMode"]').forEach((r) => (r.checked = r.value === "store"));

            // 링크 자동
            if (el("m_linkUrl")) el("m_linkUrl").value = buildStoreLink(tableSource, storeId);

            setStatus("가게 연결 완료 (저장 누르세요)");
        }

        // ✅ 저장
        async function saveSlotFromModal() {
            try {
                setStatus("저장 중...");

                const page = clean(el("m_page")?.value) || PAGE;
                const position = clean(el("m_position")?.value);
                const priority = clean(el("m_priority")?.value);

                if (!position) throw new Error("position(슬롯)이 비어있음");

                const mode = getMode();
                const fd = new FormData();

                // keys
                fd.append("page", page);
                fd.append("position", position);
                if (priority !== "") fd.append("priority", priority);

                // mode/type (호환)
                fd.append("slot_mode", mode);
                fd.append("slotMode", mode);
                fd.append("slot_type", "image");
                fd.append("slotType", "image");

                // 기간
                const startAt = clean(el("m_startAt")?.value);
                const endAt = clean(el("m_endAt")?.value);
                const noEnd = el("m_noEnd")?.checked ? "true" : "false";
                fd.append("start_at", startAt);
                fd.append("startAt", startAt);
                fd.append("end_at", endAt);
                fd.append("endAt", endAt);
                fd.append("no_end", noEnd);
                fd.append("noEnd", noEnd);

                // 콘텐츠
                const linkUrl = clean(el("m_linkUrl")?.value);
                const textContent = clean(el("m_textContent")?.value);
                const imageUrl = clean(el("m_imageUrl")?.value);

                fd.append("link_url", linkUrl);
                fd.append("linkUrl", linkUrl);
                fd.append("text_content", textContent);
                fd.append("textContent", textContent);

                fd.append("image_url", imageUrl);
                fd.append("imageUrl", imageUrl);

                // keep/clear
                const keep = el("m_keepImage")?.checked ? "true" : "false";
                const clear = el("m_clearImage")?.checked ? "true" : "false";
                fd.append("keep_image", keep);
                fd.append("keepImage", keep);
                fd.append("clear_image", clear);
                fd.append("clearImage", clear);

                const file = el("m_imageFile")?.files?.[0];
                if (file) fd.append("image", file);

                // category(표시용) - 서버가 무시해도 OK, 문제되면 이 2줄만 지우면 됨
                const cat = (state.selectedCategory || "").trim();
                fd.append("business_category", cat);
                fd.append("businessCategory", cat);

                // store mode 필수값
                if (mode === "store") {
                    const storeId = clean(el("m_storeId")?.value);
                    if (!storeId) throw new Error("가게연결 모드인데 store_id가 비어있음(가게 선택 먼저)");

                    const tableSource = clean(el("m_tableSource")?.value) || DEFAULT_TABLE_SOURCE;
                    const businessNo = clean(el("m_businessNo")?.value);
                    const businessName = clean(el("m_businessName")?.value);

                    fd.append("table_source", tableSource);
                    fd.append("tableSource", tableSource);

                    fd.append("store_id", storeId);
                    fd.append("storeId", storeId);

                    fd.append("business_no", businessNo);
                    fd.append("businessNo", businessNo);

                    fd.append("business_name", businessName);
                    fd.append("businessName", businessName);
                } else {
                    fd.append("table_source", "");
                    fd.append("tableSource", "");
                    fd.append("store_id", "");
                    fd.append("storeId", "");
                    fd.append("business_no", "");
                    fd.append("businessNo", "");
                    fd.append("business_name", "");
                    fd.append("businessName", "");
                }

                await apiUpsertSlot(fd);

                setStatus("저장 완료");
                await loadAndRender();

                // 저장 후 다시 현재 우선순위 내용 로드
                await loadSlotIntoModal();
            } catch (e) {
                console.error(e);
                setStatus("");
                alert(e.message || "저장 오류");
            }
        }

        // =========================
        // ✅ 클릭 바인딩(슬롯 클릭 → 모달)
        // =========================
        function bindAdminClicks() {
            document.addEventListener("click", async (e) => {
                // 모달 내부 클릭은 무시
                if (e.target.closest("#slotModal")) return;

                const target = e.target.closest("[data-position]");
                if (!target) return;

                e.preventDefault();
                e.stopPropagation();

                const position = target.getAttribute("data-position") || "";
                if (!position) return;

                // 현재 priority는 select 값으로 기본
                const p = clean(el("m_priority_select")?.value || el("m_priority")?.value || "1");
                if (el("m_priority")) el("m_priority").value = p;

                await openSlotModal(position, p);
            }, true);
        }

        // =========================
        // ✅ 모달 이벤트(닫기/ESC/도움말/미리보기/우선순위)
        // =========================
        function bindModalEvents() {
            // 닫기 버튼
            const closeBtn = el("btnCloseModal");
            if (closeBtn) closeBtn.addEventListener("click", (e) => { e.preventDefault(); closeSlotModal(); });

            // ESC
            document.addEventListener("keydown", (e) => {
                if (e.key !== "Escape") return;
                if (!el("slotModal")?.classList.contains("hidden")) closeSlotModal();
            });

            // 우선순위 select -> hidden 동기화 + 로드
            const ps = el("m_priority_select");
            if (ps) {
                ps.addEventListener("change", async () => {
                    const v = clean(ps.value || "1") || "1";
                    if (el("m_priority")) el("m_priority").value = v;
                    syncPriorityText();
                    // 우선순위 바꾸면 그 우선순위 데이터 불러오기
                    try { await loadSlotIntoModal(); } catch (_) { }
                });
            }

            // 종료 없음 체크
            const noEnd = el("m_noEnd");
            if (noEnd) {
                noEnd.addEventListener("change", () => {
                    const end = el("m_endAt");
                    if (end) end.disabled = !!noEnd.checked;
                });
            }

            // 이미지 파일 미리보기
            const file = el("m_imageFile");
            if (file) {
                file.addEventListener("change", () => {
                    const f = file.files && file.files[0];
                    if (!f) return;
                    setPreview(URL.createObjectURL(f));
                });
            }

            // 이미지 URL 입력 미리보기
            const imgUrl = el("m_imageUrl");
            if (imgUrl) {
                imgUrl.addEventListener("input", () => setPreview(clean(imgUrl.value)));
            }

            // 가게 검색 버튼(모달 내부 onclick도 있지만, 안전하게 한번 더)
            const btnSearch = document.querySelector('button[onclick="doStoreSearch()"]');
            if (btnSearch) btnSearch.addEventListener("click", (e) => { e.preventDefault(); doStoreSearch(); });

            // 저장 버튼(모달 내부 onclick도 있지만, 안전하게 한번 더)
            const btnSave = document.querySelector('button[onclick="saveSlotFromModal()"]');
            if (btnSave) btnSave.addEventListener("click", (e) => { e.preventDefault(); saveSlotFromModal(); });

            // 사용법 팝오버
            const helpBtn = el("adHelpBtn");
            const helpPop = el("adHelpPopover");
            const helpClose = el("adHelpCloseBtn");
            if (helpBtn && helpPop) {
                helpBtn.addEventListener("click", (e) => {
                    e.preventDefault();
                    helpPop.classList.toggle("hidden");
                    const open = !helpPop.classList.contains("hidden");
                    helpBtn.setAttribute("aria-expanded", open ? "true" : "false");
                });
            }
            if (helpClose && helpPop) {
                helpClose.addEventListener("click", (e) => {
                    e.preventDefault();
                    helpPop.classList.add("hidden");
                    if (helpBtn) helpBtn.setAttribute("aria-expanded", "false");
                });
            }
        }

        // =========================
        // ✅ init
        // =========================
        document.addEventListener("DOMContentLoaded", async () => {
            buildPowerSliderDom();
            buildBestGridDom();
            bindAdminClicks();
            bindModalEvents();

            await loadAndRender();
            initPowerSlider();
        });

        // 전역 노출(HTML onclick)
        window.openSlotModal = openSlotModal;
        window.closeSlotModal = closeSlotModal;
        window.doStoreSearch = doStoreSearch;
        window.saveSlotFromModal = saveSlotFromModal;
    </script>

</body>

</html>