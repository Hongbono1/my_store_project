<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ncategory2 ë§¤ë‹ˆì €</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* ncategory2ì™€ ë™ì¼ */
        .neo-card {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 1.2rem;
            box-shadow: 6px 6px 16px #d9e0ec, -6px -6px 16px #ffffff;
            backdrop-filter: blur(16px) saturate(120%);
            transition: all .25s ease;
        }

        .neo-card:hover {
            transform: translateY(-4px);
            box-shadow: 4px 4px 12px #cfd8e6, -4px -4px 12px #ffffff, 0 8px 24px rgba(80, 130, 255, 0.15);
        }

        .btn-3d {
            background: linear-gradient(90deg, #6dd5fa, #2980b9);
            border-radius: 1.3rem;
            padding: .5rem 1.5rem;
            font-weight: bold;
            color: white;
            box-shadow: 0 4px 0 #2393b3, 0 8px 16px rgba(0, 64, 128, 0.14);
            transition: all .15s;
            user-select: none;
        }

        .btn-3d:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #2393b3, 0 4px 10px rgba(0, 64, 128, 0.16);
        }

        .scroll-x {
            display: flex;
            gap: 1rem;
            overflow-x: auto;
            scrollbar-width: thin;
        }

        .scroll-x::-webkit-scrollbar {
            height: 6px;
        }

        .scroll-x::-webkit-scrollbar-thumb {
            background: #a3bffa;
            border-radius: 9999px;
        }

        .sidebar-scroll {
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: transparent transparent;
        }

        .sidebar-scroll:hover {
            scrollbar-color: #cbd5e1 transparent;
        }

        .sidebar-scroll::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar-scroll::-webkit-scrollbar-track {
            background: transparent;
        }

        .sidebar-scroll::-webkit-scrollbar-thumb {
            background: transparent;
            border-radius: 9999px;
        }

        .sidebar-scroll:hover::-webkit-scrollbar-thumb {
            background: #cbd5e1;
        }

        .sidebar-scroll::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* ê´€ë¦¬ì í´ë¦­ìš©(ë ˆì´ì•„ì›ƒì€ ê·¸ëŒ€ë¡œ, í‘œì‹œë§Œ ì•„ì£¼ ì‘ê²Œ) */
        .admin-slot {
            cursor: pointer;
            position: relative;
        }

        .admin-slot::after {
            content: "ê´€ë¦¬";
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 12px;
            font-weight: 900;
            padding: 6px 10px;
            border-radius: 9999px;
            background: rgba(255, 255, 255, 0.78);
            border: 1px solid rgba(59, 130, 246, 0.25);
            backdrop-filter: blur(8px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.08);
            color: rgba(30, 64, 175, 0.95);
            pointer-events: none;
        }

        /* ëª¨ë‹¬ */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.45);
            backdrop-filter: blur(6px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: 1rem;
        }

        .modal-panel {
            width: min(980px, 95vw);
            max-height: 90vh;
            overflow: auto;
        }

        .input {
            width: 100%;
            padding: .65rem .85rem;
            border-radius: 1rem;
            border: 1px solid rgba(148, 163, 184, .6);
            background: rgba(255, 255, 255, 0.75);
            outline: none;
        }

        .input:focus {
            border-color: rgba(59, 130, 246, .75);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, .15);
        }

        .chip {
            display: inline-flex;
            align-items: center;
            gap: .4rem;
            padding: .35rem .7rem;
            border-radius: 9999px;
            background: rgba(59, 130, 246, .10);
            border: 1px solid rgba(59, 130, 246, .20);
            font-weight: 800;
            font-size: .85rem;
            color: rgba(30, 64, 175, .92);
        }
    </style>
</head>

<body class="bg-gradient-to-br from-blue-50 via-white to-blue-100 min-h-screen text-gray-800">
    <!-- âœ… header.html ë¶ˆëŸ¬ì˜¤ê¸° -->
    <div id="header-placeholder"></div>

    <header class="py-6 text-center">
        <h1 class="text-3xl font-bold text-blue-700">ìš°ë¦¬ë™ë„¤ ê°€ê²Œ</h1>
        <p class="text-gray-600 mt-1">ncategory2 ë§¤ë‹ˆì €(ë ˆì´ì•„ì›ƒ ë™ì¼) - combined_store_info ì—°ê²°</p>
    </header>

    <div class="max-w-6xl mx-auto grid grid-cols-12 gap-6 py-6 px-4">

        <!-- ì¢Œì¸¡ ì‚¬ì´ë“œë°” (ë ˆì´ì•„ì›ƒ ë™ì¼) -->
        <aside class="col-span-3 neo-card p-3 h-full max-h-[1346px] sidebar-scroll">
            <h2 class="font-bold text-2xl mb-4 text-center">CATEGORY</h2>

            <!-- âœ… ì—¬ê¸° ë¶€ë¶„ì€ ë„¤ ncategory2.htmlì˜ ì¹´í…Œê³ ë¦¬ <ul>ì„ ê·¸ëŒ€ë¡œ ë³µë¶™í•˜ë©´ ì™„ì „ ë™ì¼ -->
            <ul class="space-y-3" id="categoryList">
                <li class="neo-card p-3 text-center font-bold text-slate-600">ì—¬ê¸°ì— ncategory2 ì¹´í…Œê³ ë¦¬ ëª©ë¡ì„ ê·¸ëŒ€ë¡œ ë¶™ì—¬ë„£ê¸°</li>
            </ul>

            <!-- âœ… ì‚¬ì´ë“œ ê´‘ê³  ìŠ¬ë¡¯ 1 (ncategory2 ë™ì¼ ìœ„ì¹˜) -->
            <div class="neo-card mt-6 p-4 text-center border-2 border-dashed border-blue-300 admin-slot"
                data-position="ncategory2_sidebar_ad_1" data-label="ì‚¬ì´ë“œ ê´‘ê³  1">
                <h3 class="font-bold text-lg mb-2" data-role="name">ê´‘ê³  ì˜ì—­</h3>
                <p class="text-sm text-gray-600" data-role="category">ì´ê³³ì€ ê´‘ê³  ë°°ë„ˆ/ì´ë¯¸ì§€ê°€ ë“¤ì–´ê°ˆ ë°•ìŠ¤ì…ë‹ˆë‹¤.</p>
                <img data-role="img" src="/uploads/sample-ad.jpg" alt="ê´‘ê³  ì´ë¯¸ì§€"
                    class="mt-3 w-full h-[30px] object-cover rounded-xl">
            </div>

            <!-- âœ… ì‚¬ì´ë“œ ê´‘ê³  ìŠ¬ë¡¯ 2 (ì¶”ê°€) -->
            <div class="neo-card mt-4 p-4 text-center border-2 border-dashed border-blue-300 admin-slot"
                data-position="ncategory2_sidebar_ad_2" data-label="ì‚¬ì´ë“œ ê´‘ê³  2">
                <h3 class="font-bold text-lg mb-2" data-role="name">ê´‘ê³  ì˜ì—­ 2</h3>
                <p class="text-sm text-gray-600" data-role="category">ì¶”ê°€ ê´‘ê³  ë°•ìŠ¤</p>
                <img data-role="img" src="/uploads/sample-ad.jpg" alt="ê´‘ê³  ì´ë¯¸ì§€"
                    class="mt-3 w-full h-[30px] object-cover rounded-xl">
            </div>
        </aside>

        <!-- ì¤‘ì•™ ë©”ì¸ (ë ˆì´ì•„ì›ƒ ë™ì¼) -->
        <main class="col-span-9 space-y-8">

            <!-- ë©”ì¸ ë°°ë„ˆ(ë™ì¼) -->
            <section class="relative h-60 neo-card flex items-center justify-center">
                <div class="text-center">
                    <h1 class="text-3xl font-bold mb-2">Premium ì¹´í…Œê³ ë¦¬</h1>
                    <p class="text-gray-600 text-sm">ì¹´í…Œê³ ë¦¬ ì„¤ëª… ë¬¸êµ¬ë¥¼ ì—¬ê¸°ì— ë„£ìŠµë‹ˆë‹¤.</p>
                </div>
            </section>

            <!-- íŒŒì›Œ ê´‘ê³ (ë™ì¼ êµ¬ì¡°: ê·¸ë£¹ 3ê°œ, ê·¸ë£¹ë‹¹ 3ê°œ) -->
            <section class="mt-10">
                <h2 class="font-bold text-2xl text-purple-600 text-center mb-4">ê°•ë ¥ ì¶”ì²œ</h2>

                <div id="powerViewport" class="relative overflow-hidden">
                    <div id="powerAdTrack"
                        class="flex transition-transform duration-500 ease-in-out will-change-transform"></div>

                    <button id="prevBtn"
                        class="absolute left-0 top-1/2 -translate-y-1/2 bg-white shadow rounded-full px-3 py-2">â€¹</button>
                    <button id="nextBtn"
                        class="absolute right-0 top-1/2 -translate-y-1/2 bg-white shadow rounded-full px-3 py-2">â€º</button>
                </div>
            </section>

            <!-- ìµœê³ ì˜ ê°€ê²Œ ì˜ì—­(ë™ì¼ ë°°ì¹˜: ì¢Œ 3ì¹¸ + ìš° 9ì¹¸) -->
            <section class="grid grid-cols-12 gap-6 items-stretch">

                <!-- ì¢Œì¸¡: MVP + HIGHLIGHT -->
                <div class="col-span-3 h-full">
                    <div class="neo-card p-4 w-full h-full flex flex-col gap-4">

                        <!-- MVP -->
                        <div class="flex-1 flex flex-col">
                            <h2 class="font-bold text-2xl text-blue-600 text-center mb-3">MVP</h2>
                            <a href="#"
                                class="neo-card p-0 overflow-hidden relative rounded-2xl h-full border-2 border-blue-500 admin-slot"
                                data-position="ncategory2_mvp" data-label="MVP">
                                <img data-role="img" src="/uploads/sample-left-top.jpg"
                                    class="w-full h-full object-cover" alt="ìƒí˜¸ëª… Top">
                                <div
                                    class="absolute left-3 right-3 bottom-3 bg-white/70 backdrop-blur-md rounded-xl shadow px-4 py-2 text-center">
                                    <div class="font-bold text-lg leading-tight" data-role="name">ìƒí˜¸ëª… Top</div>
                                    <div class="text-sm text-slate-600" data-role="category">ì—…ì¢…: í•œì‹</div>
                                </div>
                            </a>
                        </div>

                        <!-- HIGHLIGHT -->
                        <div class="flex-1 flex flex-col">
                            <h2 class="font-bold text-2xl text-yellow-600 text-center mb-3">HIGHLIGHT</h2>
                            <a href="#"
                                class="neo-card p-0 overflow-hidden relative rounded-2xl h-full border-2 border-yellow-500 admin-slot"
                                data-position="ncategory2_highlight" data-label="HIGHLIGHT">
                                <img data-role="img" src="/uploads/sample-left-bottom.jpg"
                                    class="w-full h-full object-cover" alt="ìƒí˜¸ëª… Bottom">
                                <div
                                    class="absolute left-3 right-3 bottom-3 bg-white/70 backdrop-blur-md rounded-xl shadow px-4 py-2 text-center">
                                    <div class="font-bold text-lg leading-tight" data-role="name">ìƒí˜¸ëª… Bottom</div>
                                    <div class="text-sm text-slate-600" data-role="category">ì—…ì¢…: ì¹´í˜</div>
                                </div>
                            </a>
                        </div>

                    </div>
                </div>

                <!-- ìš°ì¸¡: ìµœê³ ì˜ ê°€ê²Œ(ë™ì¼ ê·¸ë¦¬ë“œ) -->
                <div class="col-span-9 flex flex-col gap-6">
                    <div class="neo-card p-5">
                        <h2 class="font-bold mb-3 text-2xl text-center">ìµœê³ ì˜ ê°€ê²Œ</h2>
                        <div id="bestGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                    </div>
                </div>
            </section>

            <!-- âœ… í•˜ë‹¨ ë°•ìŠ¤ ë‘ ê°œ(ë™ì¼) -->
            <div class="grid grid-cols-2 gap-6">
                <div class="neo-card p-6 text-center">
                    <h3 class="font-bold text-lg mb-2">í•˜ë‹¨ ë°•ìŠ¤ 1</h3>
                    <p class="text-gray-600 text-sm">ì´ê³³ì€ ì„¤ëª… í…ìŠ¤íŠ¸</p>
                </div>
                <div class="neo-card p-6 text-center">
                    <h3 class="font-bold text-lg mb-2">í•˜ë‹¨ ë°•ìŠ¤ 2</h3>
                    <p class="text-gray-600 text-sm">ì´ê³³ì€ ì„¤ëª… í…ìŠ¤íŠ¸</p>
                </div>
            </div>

        </main>
    </div>

    <!-- ì˜¤ë¥¸ìª½ í•˜ë‹¨ ì„¸ë¡œ ë„¤ë¹„ê²Œì´ì…˜(ë™ì¼) -->
    <div class="fixed bottom-6 right-6 flex flex-col items-center gap-4 z-50">
        <div class="flex flex-col items-center">
            <button onclick="goBack()"
                class="w-14 h-14 flex items-center justify-center rounded-full bg-gradient-to-br from-gray-100 to-gray-200 text-gray-700 shadow hover:from-gray-200 hover:to-gray-300 transition">
                â†
            </button>
            <span class="text-xs mt-1 text-gray-600 font-semibold">ì´ì „</span>
        </div>

        <div class="flex flex-col items-center">
            <button onclick="goNext()"
                class="w-14 h-14 flex items-center justify-center rounded-full bg-gradient-to-br from-gray-100 to-gray-200 text-gray-700 shadow hover:from-gray-200 hover:to-gray-300 transition">
                â†’
            </button>
            <span class="text-xs mt-1 text-gray-600 font-semibold">ë‹¤ìŒ</span>
        </div>

        <div class="flex flex-col items-center">
            <a href="/index.html"
                class="w-14 h-14 flex items-center justify-center rounded-full bg-gradient-to-br from-blue-500 to-blue-600 text-white shadow hover:from-blue-600 hover:to-blue-700 transition">
                ğŸ 
            </a>
            <span class="text-xs mt-1 text-gray-600 font-semibold">í™ˆ</span>
        </div>
    </div>

    <!-- âœ… footer.html ë¶ˆëŸ¬ì˜¤ê¸° -->
    <div id="footer-placeholder"></div>

    <!-- ===================== ëª¨ë‹¬ ===================== -->
    <div id="modal" class="modal-backdrop">
        <div class="modal-panel neo-card p-5">
            <div class="flex items-start justify-between gap-3">
                <div>
                    <div class="text-sm font-extrabold text-slate-600">ìŠ¬ë¡¯ í¸ì§‘</div>
                    <div id="mTitle" class="text-xl font-black text-blue-700 mt-1">-</div>
                    <div class="mt-2 flex flex-wrap gap-2">
                        <span id="mPositionChip" class="chip"></span>
                    </div>
                </div>
                <button id="mClose" class="px-3 py-2 rounded-xl neo-card font-black">âœ•</button>
            </div>

            <!-- ê²€ìƒ‰ ì˜ì—­(ìŠ¬ë¡¯ ê¸°ë³¸ì •ë³´ ìœ„) -->
            <div class="neo-card p-4 mt-5">
                <div class="font-black text-slate-800">ê°€ê²Œ ê²€ìƒ‰ (combined_store_info)</div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-3">
                    <div>
                        <label class="text-sm font-extrabold text-slate-700">ê°€ê²Œëª…/ì—…ì¢… ê²€ìƒ‰</label>
                        <input id="qName" class="input mt-1" placeholder="ì˜ˆ: í•˜ëŠ˜ì‹ë‹¹ / ë¯¸ìš©" />
                    </div>
                    <div>
                        <label class="text-sm font-extrabold text-slate-700">ì‚¬ì—…ìë²ˆí˜¸ ê²€ìƒ‰</label>
                        <input id="qBiz" class="input mt-1" placeholder="ìˆ«ìë§Œ/ì¼ë¶€ ê°€ëŠ¥" />
                    </div>
                    <div class="flex items-end gap-2">
                        <button id="btnSearch" class="btn-3d w-full">ê²€ìƒ‰</button>
                    </div>
                </div>

                <div id="searchMsg" class="text-sm font-bold text-slate-600 mt-3"></div>
                <div id="searchResults" class="mt-3 space-y-2"></div>
            </div>

            <!-- ìŠ¬ë¡¯ ê¸°ë³¸ì •ë³´ -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-5">
                <div class="neo-card p-4">
                    <div class="font-black text-slate-800">ìŠ¬ë¡¯ ê¸°ë³¸ì •ë³´</div>

                    <div class="mt-3">
                        <label class="text-sm font-extrabold text-slate-700">ìŠ¬ë¡¯ ëª¨ë“œ</label>
                        <div class="mt-2 flex flex-wrap gap-2">
                            <label class="neo-card px-3 py-2 rounded-xl font-extrabold cursor-pointer">
                                <input type="radio" name="slotMode" value="store" checked /> ê°€ê²Œì—°ê²°
                            </label>
                            <label class="neo-card px-3 py-2 rounded-xl font-extrabold cursor-pointer">
                                <input type="radio" name="slotMode" value="custom" /> í…ìŠ¤íŠ¸ì…ë ¥
                            </label>
                        </div>
                    </div>

                    <div class="mt-3">
                        <label class="text-sm font-extrabold text-slate-700">í‘œì‹œ íƒ€ì…</label>
                        <div class="mt-2 flex flex-wrap gap-2">
                            <label class="neo-card px-3 py-2 rounded-xl font-extrabold cursor-pointer">
                                <input type="radio" name="slotType" value="image" checked /> ì´ë¯¸ì§€
                            </label>
                            <label class="neo-card px-3 py-2 rounded-xl font-extrabold cursor-pointer">
                                <input type="radio" name="slotType" value="text" /> í…ìŠ¤íŠ¸
                            </label>
                        </div>
                    </div>

                    <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <label class="text-sm font-extrabold text-slate-700">ìƒí˜¸ëª…</label>
                            <input id="fBusinessName" class="input mt-1" placeholder="ê²€ìƒ‰ í›„ ì„ íƒ ì‹œ ìë™ì…ë ¥" />
                        </div>
                        <div>
                            <label class="text-sm font-extrabold text-slate-700">ì—…ì¢…</label>
                            <input id="fCategory" class="input mt-1" placeholder="ê²€ìƒ‰ í›„ ì„ íƒ ì‹œ ìë™ì…ë ¥" />
                        </div>
                    </div>

                    <div class="mt-3">
                        <label class="text-sm font-extrabold text-slate-700">ì‚¬ì—…ìë²ˆí˜¸</label>
                        <input id="fBizNo" class="input mt-1" placeholder="ê²€ìƒ‰ í›„ ì„ íƒ ì‹œ ìë™ì…ë ¥" />
                    </div>

                    <div class="mt-3">
                        <label class="text-sm font-extrabold text-slate-700">ë§í¬(URL)</label>
                        <input id="fLinkUrl" class="input mt-1" placeholder="ê°€ê²Œ ì„ íƒ ì‹œ ìë™ ìƒì„±" />
                    </div>

                    <div class="mt-3">
                        <label class="text-sm font-extrabold text-slate-700">í…ìŠ¤íŠ¸ ë‚´ìš©(í…ìŠ¤íŠ¸ì…ë ¥ ëª¨ë“œ)</label>
                        <textarea id="fTextContent" class="input mt-1" rows="3"
                            placeholder="í…ìŠ¤íŠ¸ ìŠ¬ë¡¯ì¼ ë•Œ í‘œì‹œë  ë¬¸êµ¬"></textarea>
                    </div>

                    <div class="mt-3 text-sm font-bold text-slate-600">
                        * ê°€ê²Œì—°ê²° ëª¨ë“œì—ì„œëŠ” store_idëŠ” ë‚´ë¶€ë¡œë§Œ ì €ì¥(ì§ì ‘ì…ë ¥ ì—†ìŒ)
                    </div>
                </div>

                <div class="neo-card p-4">
                    <div class="font-black text-slate-800">ì´ë¯¸ì§€ ì—…ë¡œë“œ</div>

                    <div class="mt-3">
                        <input id="fImage" type="file" accept="image/*" class="input" />
                        <div class="text-xs font-bold text-slate-500 mt-2">* ì´ë¯¸ì§€ ìŠ¬ë¡¯ì¼ ë•Œë§Œ ì ìš©</div>
                    </div>

                    <div class="mt-4">
                        <div class="font-extrabold text-slate-700 text-sm">ë¯¸ë¦¬ë³´ê¸°</div>
                        <div class="neo-card mt-2 p-2 overflow-hidden">
                            <img id="imgPreview" src="" alt="preview"
                                class="w-full h-64 object-cover rounded-xl hidden" />
                            <div id="imgEmpty"
                                class="h-64 flex items-center justify-center text-slate-500 font-extrabold">
                                ì´ë¯¸ì§€ ì—†ìŒ
                            </div>
                        </div>
                    </div>

                    <div class="mt-5 flex gap-2">
                        <button id="btnSave" class="btn-3d flex-1">ì €ì¥</button>
                        <button id="btnDelete" class="neo-card px-4 py-2 rounded-xl font-black">ì‚­ì œ</button>
                    </div>

                    <div id="saveMsg" class="mt-3 text-sm font-extrabold text-slate-700"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // header/footer
        fetch("/components/header.html").then(r => r.text()).then(d => document.getElementById("header-placeholder").innerHTML = d);
        fetch("/components/footer.html").then(r => r.text()).then(d => document.getElementById("footer-placeholder").innerHTML = d);

        // âœ… ì„œë¸Œì¹´í…Œê³ ë¦¬ í† ê¸€
        function toggleSub(btn) {
            const ul = btn.nextElementSibling;
            if (!ul) return;
            ul.classList.toggle("hidden");
        }

        function goBack() {
            if (document.referrer && document.referrer !== location.href) window.history.back();
            else window.location.href = "/category.html";
        }
        function goNext() { window.history.forward(); }

        // ===================== ê´€ë¦¬ì ìŠ¬ë¡¯ ë¡œì§ =====================
        const API_BASE = "/manager/ncategory2";
        const $ = (id) => document.getElementById(id);
        const digitsOnly = (v) => String(v || "").replace(/[^\d]/g, "");

        const state = {
            slots: new Map(),           // position -> slot row
            current: null,              // position
            currentLabel: "",
            currentStoreId: null,       // store modeì—ì„œ ë‚´ë¶€ ì €ì¥(ì§ì ‘ì…ë ¥ ê¸ˆì§€)
        };

        // ì´ í˜ì´ì§€ì—ì„œ ì“°ëŠ” ìŠ¬ë¡¯ í¬ì§€ì…˜(í™”ë©´ ë°°ì¹˜ ê·¸ëŒ€ë¡œ)
        const POWER_POS = Array.from({ length: 9 }, (_, i) => `ncategory2_power_${i + 1}`);
        const BEST_POS = Array.from({ length: 6 }, (_, i) => `ncategory2_best_${i + 1}`);

        function buildCombinedLink(id) {
            return `/ndetail.html?id=${encodeURIComponent(String(id))}&type=combined`;
        }

        function setPreview(url) {
            const img = $("imgPreview");
            const empty = $("imgEmpty");
            if (url) {
                img.src = url;
                img.classList.remove("hidden");
                empty.classList.add("hidden");
            } else {
                img.src = "";
                img.classList.add("hidden");
                empty.classList.remove("hidden");
            }
        }

        function getRadio(name) {
            const el = document.querySelector(`input[name="${name}"]:checked`);
            return el ? el.value : "";
        }
        function setRadio(name, value) {
            const el = document.querySelector(`input[name="${name}"][value="${value}"]`);
            if (el) el.checked = true;
        }

        function applyModeUi() {
            const mode = getRadio("slotMode");
            const isStore = mode === "store";
            $("fBusinessName").disabled = isStore;
            $("fCategory").disabled = isStore;
            $("fBizNo").disabled = isStore;
            $("fLinkUrl").disabled = isStore;
            $("fTextContent").disabled = (mode !== "custom");
        }

        document.querySelectorAll('input[name="slotMode"]').forEach(el => el.addEventListener("change", applyModeUi));

        // --------- API ----------
        async function apiGetSlots() {
            const res = await fetch(`${API_BASE}/slots`);
            const data = await res.json();
            if (!data.success) throw new Error(data.error || "slots load failed");
            return data.slots || [];
        }

        async function apiGetSlot(position) {
            const res = await fetch(`${API_BASE}/slot?position=${encodeURIComponent(position)}`);
            const data = await res.json();
            if (!data.success) throw new Error(data.error || "slot load failed");
            return data.slot || null;
        }

        async function apiSearchStore({ q, bizNo }) {
            const qs = new URLSearchParams();
            if (q) qs.set("q", q);
            if (bizNo) qs.set("bizNo", bizNo);
            const res = await fetch(`${API_BASE}/search-store?${qs.toString()}`);
            const data = await res.json();
            if (!data.success) throw new Error(data.error || "search failed");
            return data.stores || [];
        }

        async function apiUpsertSlot(position) {
            const fd = new FormData();

            const slotMode = getRadio("slotMode");
            const slotType = getRadio("slotType");

            fd.set("position", position);
            fd.set("page", "ncategory2");
            fd.set("slot_mode", slotMode);
            fd.set("slot_type", slotType);

            if (slotMode === "store") {
                if (!state.currentStoreId) throw new Error("ê°€ê²Œ ì—°ê²° ëª¨ë“œì¸ë° ì„ íƒëœ ê°€ê²Œê°€ ì—†ìŠµë‹ˆë‹¤.");
                fd.set("store_type", "combined_store_info");
                fd.set("store_id", String(state.currentStoreId));
                fd.set("business_no", digitsOnly($("fBizNo").value));
                fd.set("business_name", $("fBusinessName").value || "");
                fd.set("category", $("fCategory").value || "");
                fd.set("link_url", buildCombinedLink(state.currentStoreId));
                fd.set("text_content", "");
            } else {
                fd.set("store_type", "");
                fd.set("store_id", "");
                fd.set("business_no", digitsOnly($("fBizNo").value));
                fd.set("business_name", $("fBusinessName").value || "");
                fd.set("category", $("fCategory").value || "");
                fd.set("link_url", $("fLinkUrl").value || "");
                fd.set("text_content", $("fTextContent").value || "");
            }

            const file = $("fImage").files && $("fImage").files[0];
            if (file) fd.append("image", file);

            const res = await fetch(`${API_BASE}/slot`, { method: "POST", body: fd });
            const data = await res.json();
            if (!data.success) throw new Error(data.error || "save failed");
            return data.slot || null;
        }

        async function apiDeleteSlot(position) {
            const res = await fetch(`${API_BASE}/slot?position=${encodeURIComponent(position)}`, { method: "DELETE" });
            const data = await res.json();
            if (!data.success) throw new Error(data.error || "delete failed");
            return true;
        }

        // --------- í™”ë©´ ìƒì„±(ë°˜ë³µ DOMì„ JSë¡œ ë§Œë“¤ì–´ì„œ ë ˆì´ì•„ì›ƒì€ ë™ì¼) ----------
        function makeSlotCard(position, label, imgHClass = "h-60 md:h-64") {
            // ncategory2 ì¹´ë“œì™€ ë™ì¼ êµ¬ì¡°(ì˜¤ë²„ë ˆì´ í¬í•¨)
            const wrap = document.createElement("div");
            wrap.className = "neo-card p-0 overflow-hidden relative rounded-2xl border-4 border-yellow-200 admin-slot";
            wrap.setAttribute("data-position", position);
            wrap.setAttribute("data-label", label);

            wrap.innerHTML = `
        <img data-role="img" src="/uploads/sample-1.jpg" alt="${label}" class="w-full ${imgHClass} object-cover">
        <div class="absolute left-3 right-3 bottom-3 bg-white/70 backdrop-blur-md rounded-xl shadow px-4 py-2 text-center">
          <div class="font-bold text-lg" data-role="name">${label}</div>
          <div class="text-sm text-slate-600" data-role="category">ì—…ì¢…:</div>
        </div>
      `;
            return wrap;
        }

        function buildPowerSliderDom() {
            const track = $("powerAdTrack");
            track.innerHTML = "";

            // 3ê·¸ë£¹(ê° 3ê°œ) ë™ì¼
            for (let g = 0; g < 3; g++) {
                const group = document.createElement("div");
                group.className = "power-group flex basis-full shrink-0";

                for (let i = 0; i < 3; i++) {
                    const idx = g * 3 + i; // 0..8
                    const pos = POWER_POS[idx];
                    const col = document.createElement("div");
                    col.className = "w-1/3 px-2";

                    // ë§í¬ëŠ” slotì—ì„œ ì¹˜í™˜(ê´€ë¦¬í˜ì´ì§€ë‹ˆê¹Œ í´ë¦­ì€ ëª¨ë‹¬ë¡œ)
                    const a = document.createElement("a");
                    a.href = "#";
                    a.className = "block";
                    a.appendChild(makeSlotCard(pos, `ê°•ë ¥ì¶”ì²œ ${idx + 1}`));

                    col.appendChild(a);
                    group.appendChild(col);
                }
                track.appendChild(group);
            }
        }

        function buildBestGridDom() {
            const grid = $("bestGrid");
            grid.innerHTML = "";
            for (let i = 0; i < 6; i++) {
                const pos = BEST_POS[i];
                const a = document.createElement("a");
                a.href = "#";
                a.className = "block group";

                const card = document.createElement("div");
                card.className = "neo-card p-0 overflow-hidden relative rounded-2xl transition-transform admin-slot";
                card.setAttribute("data-position", pos);
                card.setAttribute("data-label", `ìµœê³ ì˜ê°€ê²Œ ${i + 1}`);

                card.innerHTML = `
          <div class="w-full h-60">
            <img data-role="img" src="/uploads/sample-1.jpg" alt="ìƒí˜¸ëª…" class="w-full h-full object-cover">
          </div>
          <div class="absolute left-3 right-3 bottom-3 bg-white/70 backdrop-blur-md rounded-xl shadow px-4 py-3">
            <div class="font-bold text-lg leading-tight" data-role="name">ìƒí˜¸ëª…</div>
            <div class="text-sm text-slate-600" data-role="category">ì—…ì¢…:</div>
          </div>
        `;

                a.appendChild(card);
                grid.appendChild(a);
            }
        }

        // --------- ìŠ¬ë¡¯ê°’ì„ í™”ë©´ì— ë°˜ì˜ ----------
        function applySlotToEl(el, slot) {
            if (!el) return;
            const img = el.querySelector('[data-role="img"]');
            const name = el.querySelector('[data-role="name"]');
            const category = el.querySelector('[data-role="category"]');

            const fallbackImg = img?.getAttribute("src") || "";
            const imageUrl = slot?.image_url || fallbackImg;
            const businessName = slot?.business_name || slot?.text_content || (el.getAttribute("data-label") || "");
            const cat = slot?.category || "";

            if (img) img.src = imageUrl || fallbackImg;
            if (name) name.textContent = businessName || "";
            if (category) category.textContent = cat ? `ì—…ì¢…: ${cat}` : "ì—…ì¢…:";

            // ë§í¬ ì¹˜í™˜(ê´€ë¦¬í˜ì´ì§€ì—ì„œëŠ” í´ë¦­ ì‹œ ëª¨ë‹¬ì´ ëœ¨ë¯€ë¡œ, hrefëŠ” ìœ ì§€/ë¯¸ë¦¬ë³´ê¸°ìš©ìœ¼ë¡œë§Œ)
            const a = el.closest("a");
            if (a) a.href = slot?.link_url || "#";
        }

        function bindAdminClicks() {
            document.querySelectorAll("[data-position]").forEach(el => {
                el.addEventListener("click", (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const pos = el.getAttribute("data-position");
                    const label = el.getAttribute("data-label") || pos;
                    openModal(pos, label);
                });
            });
        }

        async function loadAndRender() {
            const rows = await apiGetSlots();
            state.slots.clear();
            rows.forEach(r => state.slots.set(r.position, r));

            // í˜ì´ì§€ ì•ˆì˜ ëª¨ë“  ìŠ¬ë¡¯ ì—˜ë¦¬ë¨¼íŠ¸ì— ë°˜ì˜
            document.querySelectorAll("[data-position]").forEach(el => {
                const pos = el.getAttribute("data-position");
                applySlotToEl(el, state.slots.get(pos));
            });
        }

        // --------- ëª¨ë‹¬ ----------
        function openModal(position, label) {
            state.current = position;
            state.currentLabel = label;
            state.currentStoreId = null;

            $("mTitle").textContent = label;
            $("mPositionChip").textContent = position;

            $("qName").value = "";
            $("qBiz").value = "";
            $("searchMsg").textContent = "";
            $("searchResults").innerHTML = "";
            $("saveMsg").textContent = "";
            $("fImage").value = "";
            setPreview("");

            setRadio("slotMode", "store");
            setRadio("slotType", "image");

            const saved = state.slots.get(position);
            if (saved) {
                if (saved.slot_mode) setRadio("slotMode", saved.slot_mode);
                if (saved.slot_type) setRadio("slotType", saved.slot_type);

                $("fBusinessName").value = saved.business_name || "";
                $("fCategory").value = saved.category || "";
                $("fBizNo").value = saved.business_no || "";
                $("fLinkUrl").value = saved.link_url || "";
                $("fTextContent").value = saved.text_content || "";

                if (saved.store_id) state.currentStoreId = saved.store_id;
                setPreview(saved.image_url || "");
            } else {
                $("fBusinessName").value = "";
                $("fCategory").value = "";
                $("fBizNo").value = "";
                $("fLinkUrl").value = "";
                $("fTextContent").value = "";
            }

            applyModeUi();

            $("modal").style.display = "flex";
            document.body.style.overflow = "hidden";
        }

        function closeModal() {
            $("modal").style.display = "none";
            document.body.style.overflow = "";
        }

        $("mClose").addEventListener("click", closeModal);
        $("modal").addEventListener("click", (e) => { if (e.target === $("modal")) closeModal(); });

        $("fImage").addEventListener("change", () => {
            const f = $("fImage").files && $("fImage").files[0];
            if (!f) return;
            const url = URL.createObjectURL(f);
            setPreview(url);
        });

        $("btnSearch").addEventListener("click", async () => {
            const q = $("qName").value.trim();
            const bizNo = digitsOnly($("qBiz").value.trim());

            $("searchMsg").textContent = "ê²€ìƒ‰ ì¤‘...";
            $("searchResults").innerHTML = "";

            try {
                const stores = await apiSearchStore({ q, bizNo });
                if (!stores.length) {
                    $("searchMsg").textContent = "ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.";
                    return;
                }

                $("searchMsg").textContent = `ê²€ìƒ‰ ê²°ê³¼: ${stores.length}ê±´`;

                stores.forEach(s => {
                    const row = document.createElement("div");
                    row.className = "neo-card p-3 flex items-center justify-between gap-3";
                    row.innerHTML = `
            <div class="min-w-0">
              <div class="font-black text-slate-800 truncate">${s.business_name || "-"}</div>
              <div class="text-sm font-bold text-slate-600 truncate">${s.category ? `ì—…ì¢…: ${s.category}` : ""}</div>
              <div class="text-xs font-extrabold text-slate-500 truncate">biz: ${s.business_no || ""}</div>
            </div>
            <div class="shrink-0">
              <button class="btn-3d">ì„ íƒ</button>
            </div>
          `;
                    row.querySelector("button").addEventListener("click", () => {
                        state.currentStoreId = s.id;

                        $("fBusinessName").value = s.business_name || "";
                        $("fCategory").value = s.category || "";
                        $("fBizNo").value = s.business_no || "";
                        $("fLinkUrl").value = buildCombinedLink(s.id);

                        setRadio("slotMode", "store");
                        applyModeUi();

                        $("saveMsg").textContent = "ê°€ê²Œ ì„ íƒ ì™„ë£Œ. ì €ì¥ì„ ëˆ„ë¥´ì„¸ìš”.";
                    });

                    $("searchResults").appendChild(row);
                });
            } catch (e) {
                $("searchMsg").textContent = "";
                alert(e.message);
            }
        });

        $("btnSave").addEventListener("click", async () => {
            if (!state.current) return;
            $("btnSave").disabled = true;
            $("saveMsg").textContent = "ì €ì¥ ì¤‘...";

            try {
                const saved = await apiUpsertSlot(state.current);
                if (saved) state.slots.set(saved.position, saved);
                else {
                    const s = await apiGetSlot(state.current);
                    if (s) state.slots.set(state.current, s);
                }

                await loadAndRender();
                bindAdminClicks(); // DOMì— ë‹¤ì‹œ ë°”ì¸ë”©(ì•ˆì „)
                $("saveMsg").textContent = "ì €ì¥ ì™„ë£Œ";
            } catch (e) {
                $("saveMsg").textContent = "";
                alert(e.message);
            } finally {
                $("btnSave").disabled = false;
            }
        });

        $("btnDelete").addEventListener("click", async () => {
            if (!state.current) return;
            if (!confirm("ì´ ìŠ¬ë¡¯ì„ ì‚­ì œí• ê¹Œìš”?")) return;

            $("btnDelete").disabled = true;
            try {
                await apiDeleteSlot(state.current);
                state.slots.delete(state.current);

                await loadAndRender();
                bindAdminClicks();
                closeModal();
            } catch (e) {
                alert(e.message);
            } finally {
                $("btnDelete").disabled = false;
            }
        });

        // ===================== íŒŒì›Œ ê´‘ê³  ìŠ¬ë¼ì´ë”(ë„¤ ì½”ë“œ ê·¸ëŒ€ë¡œ) =====================
        function initPowerSlider() {
            const viewport = $("powerViewport");
            const track = $("powerAdTrack");
            if (!viewport || !track) return;

            let groups = track.querySelectorAll(".power-group").length;
            let index = Math.floor(Math.random() * groups);
            let dir = 1;

            function updateSlider() {
                const slideWidth = viewport.clientWidth;
                track.style.transform = `translateX(${-index * slideWidth}px)`;
            }

            function stepAuto() {
                if (groups <= 1) return;
                if (index >= groups - 1) dir = -1;
                else if (index <= 0) dir = 1;
                index = index + dir;
                updateSlider();
            }

            function nextManual() {
                if (groups <= 1) return;
                if (index < groups - 1) index++;
                else { dir = -1; index = groups - 2; }
                updateSlider();
            }

            function prevManual() {
                if (groups <= 1) return;
                if (index > 0) index--;
                else { dir = 1; index = 1; }
                updateSlider();
            }

            const nextBtn = $("nextBtn");
            const prevBtn = $("prevBtn");
            if (nextBtn && prevBtn) {
                nextBtn.addEventListener("click", () => { stopAuto(); nextManual(); startAuto(); });
                prevBtn.addEventListener("click", () => { stopAuto(); prevManual(); startAuto(); });
            }

            window.addEventListener("resize", updateSlider);

            const INTERVAL = 10000;
            let timer = null;
            function startAuto() { if (!timer) timer = setInterval(stepAuto, INTERVAL); }
            function stopAuto() { if (timer) { clearInterval(timer); timer = null; } }

            document.addEventListener("visibilitychange", () => { document.hidden ? stopAuto() : startAuto(); });
            viewport.addEventListener("mouseenter", stopAuto);
            viewport.addEventListener("mouseleave", startAuto);

            updateSlider();
            startAuto();
        }

        // init
        document.addEventListener("DOMContentLoaded", async () => {
            buildPowerSliderDom();   // íŒŒì›Œ(ë ˆì´ì•„ì›ƒ ë™ì¼ êµ¬ì¡° ìƒì„±)
            buildBestGridDom();      // ìµœê³ ì˜ê°€ê²Œ(ë ˆì´ì•„ì›ƒ ë™ì¼ êµ¬ì¡° ìƒì„±)
            bindAdminClicks();       // í´ë¦­ â†’ ëª¨ë‹¬
            await loadAndRender();   // ì„œë²„ê°’ ë°˜ì˜
            initPowerSlider();       // ìŠ¬ë¼ì´ë” ë™ì‘
        });
    </script>
</body>

</html>