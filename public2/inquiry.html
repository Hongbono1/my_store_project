<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>문의 상세 | MALL HANKOOK</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: Pretendard, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif;
            background: #f3f4f6;
            min-height: 100vh;
        }

        .neo-card {
            background: #ffffff;
            border-radius: 1.5rem;
            box-shadow:
                8px 8px 18px rgba(15, 23, 42, 0.08),
                -4px -4px 12px rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(226, 232, 240, 0.9);
        }

        .badge-type {
            border-radius: 999px;
            padding: 0.2rem 0.7rem;
            font-size: 0.7rem;
            font-weight: 500;
            background: #eef2ff;
            color: #4f46e5;
            border: 1px solid rgba(129, 140, 248, 0.5);
        }

        .badge-status-wait {
            border-radius: 999px;
            padding: 0.2rem 0.7rem;
            font-size: 0.7rem;
            font-weight: 500;
            background: #fffbeb;
            color: #ea580c;
            border: 1px solid rgba(251, 191, 36, 0.6);
        }

        .badge-status-done {
            border-radius: 999px;
            padding: 0.2rem 0.7rem;
            font-size: 0.7rem;
            font-weight: 500;
            background: #ecfdf5;
            color: #059669;
            border: 1px solid rgba(52, 211, 153, 0.6);
        }

        .thumb-img {
            transition: transform 0.12s ease, box-shadow 0.12s ease;
        }

        .thumb-img:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(15, 23, 42, 0.15);
        }

        .answer-box {
            border-radius: 1.25rem;
            background: linear-gradient(135deg, #eef2ff, #eff6ff);
            border: 1px solid rgba(191, 219, 254, 0.9);
        }
    </style>
</head>

<body class="py-6 sm:py-10">
    <div class="max-w-4xl mx-auto px-4 sm:px-6">
        <!-- 상단 헤더 -->
        <header class="mb-6 sm:mb-8 flex flex-col sm:flex-row sm:items-end sm:justify-between gap-3">
            <div>
                <button type="button"
                    class="inline-flex items-center gap-1.5 text-xs sm:text-sm text-slate-500 hover:text-slate-700 mb-2"
                    onclick="history.back()">
                    ← 목록으로 돌아가기
                </button>
                <h1 class="text-2xl sm:text-3xl font-extrabold text-slate-900 tracking-tight">
                    문의 상세
                </h1>
                <p class="mt-1 text-sm text-slate-500">
                    작성하신 문의의 상세 내용과 첨부 파일, 답변 내용을 확인할 수 있습니다.
                </p>
            </div>
            <div class="flex items-center gap-2 text-xs sm:text-sm text-slate-500">
                <span id="inquiryIdLabel"></span>
            </div>
        </header>

        <!-- 메인 카드 -->
        <main class="neo-card p-4 sm:p-6 space-y-6 sm:space-y-7">
            <!-- 제목 / 메타 정보 -->
            <section class="border-b border-slate-100 pb-4 sm:pb-5">
                <div class="flex flex-col gap-2">
                    <div class="flex flex-wrap items-center gap-2">
                        <span id="inquiryTypeBadge" class="badge-type hidden"></span>
                        <span id="inquiryStatusBadge" class="badge-status-wait hidden"></span>
                    </div>
                    <h2 id="inquiryTitle" class="text-lg sm:text-xl font-semibold text-slate-900">
                        (제목을 불러오는 중입니다…)
                    </h2>
                    <div class="flex flex-wrap items-center gap-x-4 gap-y-1 text-xs sm:text-sm text-slate-500">
                        <span id="inquiryWriter"></span>
                        <span id="inquiryCreatedAt"></span>
                        <span id="inquiryEmail"></span>
                        <span id="inquiryPhone"></span>
                    </div>
                </div>
            </section>

            <!-- 문의 내용 + 첨부 파일 (좌우 배치) -->
            <section class="grid lg:grid-cols-3 gap-4 sm:gap-6">
                <!-- 왼쪽: 문의 내용 (2/3 폭) -->
                <div class="lg:col-span-2 space-y-3">
                    <h3 class="text-sm font-semibold text-slate-700">문의 내용</h3>
                    <div id="inquiryContent"
                        class="text-sm sm:text-[0.95rem] leading-relaxed text-slate-800 whitespace-pre-wrap bg-slate-50/70 rounded-2xl px-4 py-3 border border-slate-100 min-h-[120px]">
                        내용을 불러오는 중입니다…
                    </div>
                </div>

                <!-- 오른쪽: 첨부 파일 (1/3 폭) -->
                <div id="attachmentSection" class="space-y-3 hidden">
                    <h3 class="text-sm font-semibold text-slate-700 flex items-center gap-2">
                        첨부 파일
                        <span id="attachmentCountBadge"
                            class="inline-flex items-center justify-center px-2.5 py-0.5 rounded-full bg-slate-100 text-[11px] text-slate-500 border border-slate-200"></span>
                    </h3>
                    <div id="attachmentList" class="flex flex-col gap-3">
                        <!-- 첨부 이미지가 세로로 배치됨 -->
                    </div>
                    <p class="text-xs text-slate-400">
                        이미지를 클릭하면 새 탭에서 원본 크기로 열립니다.
                    </p>
                </div>
            </section>

            <!-- 관리자 답변 -->
            <section class="pt-3 border-t border-slate-100">
                <h3 class="text-sm font-semibold text-slate-700 mb-2.5">답변</h3>
                <div id="answerBox" class="answer-box px-4 py-3 text-sm text-slate-800 whitespace-pre-wrap">
                    아직 등록된 답변이 없습니다. 운영자가 확인 후 순차적으로 답변드릴 예정입니다.
                </div>
                <p id="answeredAtText" class="mt-2 text-xs text-slate-400"></p>
            </section>
        </main>
    </div>

    <script>
        function getQueryParam(name) {
            const params = new URLSearchParams(window.location.search);
            return params.get(name);
        }

        function formatDateTime(iso) {
            if (!iso) return "";
            const d = new Date(iso);
            if (Number.isNaN(d.getTime())) return iso;
            return d.toLocaleString("ko-KR", {
                year: "2-digit",
                month: "2-digit",
                day: "2-digit",
                hour: "2-digit",
                minute: "2-digit",
            });
        }

        function buildAttachmentList(item) {
            const section = document.getElementById("attachmentSection");
            const list = document.getElementById("attachmentList");
            const countBadge = document.getElementById("attachmentCountBadge");

            // DB 컬럼 기반으로 첨부 파일 목록 구성
            const candidates = [
                item.image1_path,
                item.image2_path,
                item.image3_path,
                item.image1,
                item.image2,
                item.image3,
            ];

            const files = candidates.filter((v) => v && v.trim());

            if (files.length === 0) {
                // 첨부가 없으면 섹션 숨김
                section.classList.add("hidden");
                return;
            }

            // 첨부가 있으면 섹션 표시
            section.classList.remove("hidden");
            countBadge.textContent = `${files.length}개`;

            files.forEach((url, index) => {
                const a = document.createElement("a");
                a.href = url;
                a.target = "_blank";
                a.rel = "noopener noreferrer";
                a.className =
                    "block w-24 h-24 rounded-2xl overflow-hidden border border-slate-200 bg-slate-50 thumb-img";

                const img = document.createElement("img");
                img.src = url;
                img.alt = `첨부 이미지 ${index + 1}`;
                img.className = "w-full h-full object-cover";

                a.appendChild(img);
                list.appendChild(a);
            });
        }

        async function loadInquiryDetail() {
            const id = getQueryParam("id");
            if (!id) {
                alert("잘못된 접근입니다. id가 없습니다.");
                window.location.href = "/inquiry.html";
                return;
            }

            document.getElementById("inquiryIdLabel").textContent = `문의 번호 #${id}`;

            try {
                const res = await fetch(`/api/inquiry/${id}`);
                if (!res.ok) {
                    throw new Error("서버 응답이 올바르지 않습니다.");
                }
                const data = await res.json();
                if (!data.ok || !data.item) {
                    throw new Error("문의 데이터를 찾을 수 없습니다.");
                }

                const item = data.item;

                // 제목
                document.getElementById("inquiryTitle").textContent =
                    item.title || "(제목 없음)";

                // 작성자/연락처
                const writerName = item.writer_name || item.user_name || "익명";
                document.getElementById(
                    "inquiryWriter"
                ).textContent = `작성자: ${writerName}`;

                if (item.writer_email) {
                    document.getElementById(
                        "inquiryEmail"
                    ).textContent = `이메일: ${item.writer_email}`;
                }
                if (item.writer_phone) {
                    document.getElementById(
                        "inquiryPhone"
                    ).textContent = `연락처: ${item.writer_phone}`;
                }

                // 생성일
                document.getElementById("inquiryCreatedAt").textContent =
                    `작성일: ${formatDateTime(item.created_at)}`;

                // 문의유형 뱃지
                const typeBadge = document.getElementById("inquiryTypeBadge");
                if (item.inquiry_type) {
                    typeBadge.textContent = item.inquiry_type;
                    typeBadge.classList.remove("hidden");
                }

                // 상태 뱃지 (답변 여부)
                const statusBadge = document.getElementById("inquiryStatusBadge");
                if (item.answer && item.answer.trim()) {
                    statusBadge.textContent = "답변완료";
                    statusBadge.classList.remove("hidden");
                    statusBadge.classList.remove("badge-status-wait");
                    statusBadge.classList.add("badge-status-done");
                } else {
                    statusBadge.textContent = "답변대기";
                    statusBadge.classList.remove("hidden");
                    statusBadge.classList.remove("badge-status-done");
                    statusBadge.classList.add("badge-status-wait");
                }

                // 문의 내용
                document.getElementById("inquiryContent").textContent =
                    item.content || "(내용 없음)";

                // ✅ 첨부 파일: 내용 밑에 렌더링
                buildAttachmentList(item);

                // 답변 영역
                const answerBox = document.getElementById("answerBox");
                const answeredAtText = document.getElementById("answeredAtText");

                if (item.answer && item.answer.trim()) {
                    answerBox.textContent = item.answer;
                    answeredAtText.textContent =
                        "답변일: " + formatDateTime(item.answered_at);
                } else {
                    answerBox.textContent =
                        "아직 등록된 답변이 없습니다. 운영자가 확인 후 순차적으로 답변드릴 예정입니다.";
                    answeredAtText.textContent = "";
                }
            } catch (err) {
                console.error("❌ loadInquiryDetail ERROR:", err);
                alert("문의 상세 정보를 불러오는 중 오류가 발생했습니다.");
                window.location.href = "/inquiry.html";
            }
        }

        document.addEventListener("DOMContentLoaded", loadInquiryDetail);
    </script>
</body>

</html>