<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>전통시장 상세보기</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script
        src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=6286d4d9bc1d503495b03f46622b5dc8&libraries=services"></script>
</head>

<body class="bg-gray-100">

    <div class="max-w-3xl mx-auto bg-white p-6 mt-10 mb-20 rounded-xl shadow">

        <!-- 시장명 -->
        <h1 id="market_name" class="text-3xl font-bold text-gray-800 mb-6"></h1>

        <!-- 대표 이미지 -->
        <div class="w-full h-64 mb-6 rounded-xl overflow-hidden border">
            <img id="main_img" class="w-full h-full object-cover">
        </div>

        <!-- 기본 정보 -->
        <div class="space-y-4 mb-10">
            <p><strong>시장명:</strong> <span id="market_name_2"></span></p>
            <p><strong>주소:</strong> <span id="address"></span></p>
            <p><strong>전화번호:</strong> <span id="phone"></span></p>
            <p><strong>운영 시간:</strong> <span id="opening_hours"></span></p>
            <p><strong>주요 품목:</strong> <span id="main_products"></span></p>
        </div>

        <!-- 지도 -->
        <div class="mb-10">
            <h2 class="text-xl font-bold mb-2">지도</h2>
            <div id="map" class="w-full h-64 rounded-xl border"></div>
        </div>

        <!-- 이벤트 -->
        <div class="mb-10">
            <h2 class="text-xl font-bold mb-2">이벤트 / 축제</h2>
            <p id="event_info" class="whitespace-pre-line leading-relaxed"></p>
        </div>

        <!-- 편의시설 -->
        <div class="mb-10">
            <h2 class="text-xl font-bold mb-2">편의시설</h2>
            <p id="facilities" class="whitespace-pre-line leading-relaxed"></p>
        </div>

        <!-- 주차 정보 -->
        <div class="mb-10">
            <h2 class="text-xl font-bold mb-2">주차 정보</h2>
            <p><strong>유무:</strong> <span id="parking_available"></span></p>

            <div id="parking_img_wrap" class="hidden mt-4">
                <img id="parking_img" class="w-full max-h-60 object-cover rounded-lg border">
            </div>
        </div>

        <!-- 대중교통 -->
        <div class="mb-10">
            <h2 class="text-xl font-bold mb-2">대중교통 안내</h2>
            <p id="transport_info" class="whitespace-pre-line leading-relaxed"></p>

            <div id="transport_img_wrap" class="hidden mt-4">
                <img id="transport_img" class="w-full max-h-60 object-cover rounded-lg border">
            </div>
        </div>

        <!-- Q&A -->
        <div class="mb-10">
            <h2 class="text-xl font-bold mb-4">Q&A</h2>
            <div id="qa_list" class="space-y-6"></div>
        </div>

        <!-- 운영자 한마디 -->
        <div class="mb-10">
            <h2 class="text-xl font-bold mb-2">운영자 한마디</h2>
            <p id="free_pr" class="whitespace-pre-line leading-relaxed text-gray-700 break-words"></p>
        </div>

    </div>


    <script>
        const params = new URLSearchParams(location.search);
        const id = params.get("id");

        if (!id) {
            alert("잘못된 접근입니다. ID가 필요합니다.");
            location.href = "/";
        }

        async function loadDetail() {
            try {
                const res = await fetch(`/api/market/${id}`);
                const json = await res.json();
                
                if (!json.success || !json.data) {
                    alert("데이터를 불러올 수 없습니다.");
                    return;
                }

                const data = json.data;

                // 기본 정보
                market_name.textContent = data.market_name;
                market_name_2.textContent = data.market_name;
                address.textContent = data.address;
                phone.textContent = data.phone || "-";
                opening_hours.textContent = data.opening_hours || "";
                main_products.textContent = data.main_products || "";

                // 대표 이미지
                if (data.main_img) main_img.src = data.main_img;

                // 텍스트 정보
                event_info.textContent = data.event_info || "";
                facilities.textContent = data.facilities || "";
                parking_available.textContent = data.parking_available || "";
                transport_info.textContent = data.transport_info || "";

                // 주차 이미지
                if (data.parking_img) {
                    parking_img_wrap.classList.remove("hidden");
                    parking_img.src = data.parking_img;
                }

                // 교통 이미지
                if (data.transport_img) {
                    transport_img_wrap.classList.remove("hidden");
                    transport_img.src = data.transport_img;
                }

                // 운영자 한마디
                free_pr.textContent = data.free_pr || "";

                // Q&A - 안전한 파싱
                let qaList = [];
                try {
                    if (data.qa_list) {
                        qaList = typeof data.qa_list === 'string' ? JSON.parse(data.qa_list) : data.qa_list;
                    }
                } catch (e) {
                    console.error("Q&A 파싱 오류:", e);
                }
                renderQA(qaList);

                // 지도 - 좌표가 있을 때만
                if (data.lat && data.lng) {
                    drawMap(data.lat, data.lng);
                } else if (data.address) {
                    // 좌표가 없으면 주소로 검색
                    drawMapByAddress(data.address);
                } else {
                    document.getElementById("map").innerHTML = '<p class="text-gray-500 text-center py-10">지도 정보가 없습니다.</p>';
                }
            } catch (err) {
                console.error("데이터 로드 오류:", err);
                alert("데이터를 불러오는 중 오류가 발생했습니다.");
            }
        }

        function renderQA(list) {
            const wrap = qa_list;

            if (!list.length) {
                wrap.innerHTML = "<p class='text-gray-500'>등록된 Q&A가 없습니다.</p>";
                return;
            }

            wrap.innerHTML = list.map(item => `
                <div class="border rounded-lg p-4 bg-gray-50">
                    <p class="font-bold mb-2">Q. ${item.q}</p>
                    <p class="whitespace-pre-line leading-relaxed">${item.a}</p>
                    ${item.img ? `<img src="${item.img}" class="mt-3 rounded-lg w-full max-h-96 object-cover border">` : ""}
                </div>
            `).join("");
        }

        function drawMap(lat, lng) {
            kakao.maps.load(() => {
                const map = new kakao.maps.Map(document.getElementById("map"), {
                    center: new kakao.maps.LatLng(lat, lng),
                    level: 3,
                });
                new kakao.maps.Marker({
                    map,
                    position: new kakao.maps.LatLng(lat, lng),
                });
            });
        }

        function drawMapByAddress(address) {
            kakao.maps.load(() => {
                const geocoder = new kakao.maps.services.Geocoder();
                geocoder.addressSearch(address, (result, status) => {
                    if (status === kakao.maps.services.Status.OK) {
                        const lat = parseFloat(result[0].y);
                        const lng = parseFloat(result[0].x);
                        drawMap(lat, lng);
                    } else {
                        document.getElementById("map").innerHTML = '<p class="text-gray-500 text-center py-10">주소로 지도를 찾을 수 없습니다.</p>';
                    }
                });
            });
        }

        loadDetail();
    </script>

</body>

</html>