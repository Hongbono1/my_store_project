<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>서브카테고리1 (푸드 전용)</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif;
        }

        .neo {
            background: rgba(255, 255, 255, .92);
            border: 1px solid rgba(59, 130, 246, .18);
            border-radius: 1rem;
            box-shadow: 10px 10px 24px rgba(0, 0, 0, .08), -10px -10px 24px rgba(255, 255, 255, .7);
            backdrop-filter: blur(12px);
        }

        .neo-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 1.2rem;
            box-shadow: 6px 6px 16px rgba(0, 0, 0, .08), -6px -6px 16px rgba(255, 255, 255, .7);
            border: 1px solid rgba(59, 130, 246, .10);
            backdrop-filter: blur(12px);
            transition: transform .18s ease, box-shadow .18s ease;
        }

        .neo-card:hover {
            transform: translateY(-3px);
            box-shadow: 10px 10px 20px rgba(0, 0, 0, .10), -10px -10px 20px rgba(255, 255, 255, .75);
        }

        .pill {
            border: 1px solid rgba(59, 130, 246, .18);
            background: rgba(255, 255, 255, .75);
            border-radius: 9999px;
        }

        .pill-active {
            border-color: rgba(59, 130, 246, .55);
            background: rgba(59, 130, 246, .10);
        }
    </style>
</head>

<body class="min-h-screen bg-white text-gray-800 flex flex-col">
    <!-- ✅ header -->
    <div id="header-placeholder"></div>

    <main class="flex-1">
        <!-- 상단 배너 -->
        <section class="px-4 md:px-8 pt-6">
            <div class="neo p-5 md:p-7">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                    <div>
                        <div class="text-xs text-blue-600 font-semibold tracking-wide">SUBCATEGORY 1</div>
                        <h1 class="text-2xl md:text-3xl font-extrabold mt-1">
                            <span id="pageTitle">푸드 서브카테고리</span>
                        </h1>
                        <p class="text-sm text-gray-600 mt-2">
                            이 페이지는 <span class="font-semibold text-gray-800">푸드(FOOD) 전용</span>입니다.
                        </p>
                    </div>

                    <div class="flex items-center gap-2">
                        <span class="text-xs text-gray-500">카테고리:</span>
                        <span id="categoryBadge" class="pill px-3 py-1 text-sm font-semibold text-gray-800">-</span>
                    </div>
                </div>

                <!-- 서브카테고리 버튼 바 -->
                <div class="mt-5 flex flex-wrap items-center gap-2">
                    <button class="pill px-4 py-2 text-sm font-semibold hover:opacity-90" data-sub="__all__">
                        전체
                    </button>
                    <!-- ✅ 필요하면 여기에 자주 쓰는 서브카테고리 버튼을 미리 고정해도 됨 -->
                    <button class="pill px-4 py-2 text-sm font-semibold hover:opacity-90" data-sub="한식">한식</button>
                    <button class="pill px-4 py-2 text-sm font-semibold hover:opacity-90" data-sub="분식">분식</button>
                    <button class="pill px-4 py-2 text-sm font-semibold hover:opacity-90" data-sub="카페">카페</button>
                    <button class="pill px-4 py-2 text-sm font-semibold hover:opacity-90" data-sub="기타">기타</button>
                </div>

                <div class="mt-4 text-xs text-gray-500">
                    현재 서브카테고리: <span id="activeSubLabel" class="font-semibold text-gray-800">전체</span>
                </div>
            </div>
        </section>

        <!-- 아이템 영역 -->
        <section class="px-4 md:px-8 py-6">
            <div class="neo p-5 md:p-7">
                <div class="flex items-center justify-between gap-3">
                    <h2 class="text-lg md:text-xl font-extrabold">가게 목록</h2>
                    <div class="text-sm text-gray-500">
                        <span id="countLabel">0</span>개
                    </div>
                </div>

                <!-- 상태/에러 -->
                <div id="statusBox" class="mt-4 hidden rounded-xl border border-blue-100 bg-blue-50 px-4 py-3 text-sm">
                    <span id="statusText" class="text-blue-700"></span>
                </div>

                <!-- grid -->
                <div id="grid" class="mt-5 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>

                <!-- 더보기 -->
                <div class="mt-6 flex items-center justify-center">
                    <button id="moreBtn"
                        class="pill px-6 py-3 text-sm font-extrabold hover:opacity-90 disabled:opacity-50 disabled:cursor-not-allowed">
                        더보기 (12개)
                    </button>
                </div>
            </div>
        </section>
    </main>

    <!-- ✅ footer -->
    <div id="footer-placeholder"></div>

    <script>
        // =========================
        // ✅ 이 페이지는 "푸드 전용"
        // =========================
        const GRID_ENDPOINT = "/subcategorymanager_food/ad/grid"; // ✅ 푸드 전용 엔드포인트
        const PAGE_SIZE = 12;

        const state = {
            category: "",
            subcategory: "__all__",
            pageNo: 1,
            loading: false,
            hasMore: true,
            totalCount: 0,
        };

        function qs(sel) { return document.querySelector(sel); }
        function clean(v) { return (v ?? "").toString().trim(); }
        function setStatus(msg, isError = false) {
            const box = qs("#statusBox");
            const text = qs("#statusText");
            if (!msg) {
                box.classList.add("hidden");
                text.textContent = "";
                return;
            }
            box.classList.remove("hidden");
            box.classList.toggle("border-red-200", isError);
            box.classList.toggle("bg-red-50", isError);
            box.classList.toggle("border-blue-100", !isError);
            box.classList.toggle("bg-blue-50", !isError);
            text.classList.toggle("text-red-700", isError);
            text.classList.toggle("text-blue-700", !isError);
            text.textContent = msg;
        }

        function setActiveSubUI() {
            qs("#activeSubLabel").textContent = state.subcategory === "__all__" ? "전체" : state.subcategory;
            document.querySelectorAll("[data-sub]").forEach(btn => {
                const sub = btn.getAttribute("data-sub");
                btn.classList.toggle("pill-active", sub === state.subcategory);
            });
        }

        function getQuery() {
            const u = new URL(location.href);
            const category = clean(u.searchParams.get("category"));
            const sub = clean(u.searchParams.get("subcategory") || u.searchParams.get("sub") || "__all__");
            return { category, sub };
        }

        function buildUrl(pageNo) {
            const params = new URLSearchParams();
            params.set("page", "subcategory");
            params.set("section", "all_items");
            params.set("pageNo", String(pageNo));
            params.set("category", state.category);
            if (state.subcategory && state.subcategory !== "__all__") params.set("subcategory", state.subcategory);

            // ✅ mode는 서버에서 고정(푸드)될 예정이라 여기서는 넣지 않음
            return `${GRID_ENDPOINT}?${params.toString()}`;
        }

        function normalizeItems(data) {
            const items = data?.items || data?.rows || data?.list || data?.results || [];
            return Array.isArray(items) ? items : [];
        }

        function renderCard(item) {
            const name = clean(item.business_name || item.store_name || item.name || "-");
            const type = clean(item.business_type || item.type || "");
            const sub = clean(item.detail_category || item.business_subcategory || item.subcategory || "");
            const img = clean(item.image_url || item.main_image_url || item.image || "");

            const el = document.createElement("div");
            el.className = "neo-card overflow-hidden";
            el.innerHTML = `
        <div class="aspect-[4/3] bg-gray-50 overflow-hidden">
          ${img
                    ? `<img src="${img}" alt="${name}" class="w-full h-full object-cover">`
                    : `<div class="w-full h-full flex items-center justify-center text-gray-400 text-sm">NO IMAGE</div>`
                }
        </div>
        <div class="p-3">
          <div class="text-base font-extrabold leading-tight">${name}</div>
          <div class="mt-1 text-xs text-gray-600">
            ${type ? `<span class="mr-2">업종: <span class="font-semibold text-gray-800">${type}</span></span>` : ""}
            ${sub ? `<span>서브: <span class="font-semibold text-gray-800">${sub}</span></span>` : ""}
          </div>
        </div>
      `;
            return el;
        }

        function appendItems(items) {
            const grid = qs("#grid");
            items.forEach(it => grid.appendChild(renderCard(it)));
        }

        async function fetchManagerGrid(pageNo, reset = false) {
            if (state.loading) return;
            state.loading = true;
            qs("#moreBtn").disabled = true;

            if (reset) {
                qs("#grid").innerHTML = "";
                state.pageNo = 1;
                state.hasMore = true;
                state.totalCount = 0;
            }

            setStatus("불러오는 중...");

            try {
                const url = buildUrl(pageNo);
                const res = await fetch(url, { headers: { "Accept": "application/json" } });
                if (!res.ok) throw new Error(`grid fetch 실패: ${res.status}`);

                const data = await res.json();
                if (!data?.success) throw new Error(data?.error || "grid 응답 실패");

                const items = normalizeItems(data);

                // ✅ 서버가 total/hasMore를 주면 사용, 아니면 items 개수로 추정
                const total = Number(data.total || data.count || data.totalCount || 0);
                if (Number.isFinite(total) && total > 0) state.totalCount = total;

                appendItems(items);

                // 더보기 가능 여부
                if (typeof data.hasMore === "boolean") {
                    state.hasMore = data.hasMore;
                } else {
                    // 페이지당 12개 미만이면 더 없음으로 간주
                    state.hasMore = items.length >= PAGE_SIZE;
                }

                qs("#countLabel").textContent = String(state.totalCount || document.querySelectorAll("#grid > div").length);
                setStatus("");

            } catch (err) {
                console.error(err);
                setStatus(err?.message || "오류 발생", true);
            } finally {
                state.loading = false;
                qs("#moreBtn").disabled = !state.hasMore;
            }
        }

        function wireSubButtons() {
            document.querySelectorAll("[data-sub]").forEach(btn => {
                btn.addEventListener("click", async () => {
                    const sub = btn.getAttribute("data-sub") || "__all__";
                    state.subcategory = sub;
                    setActiveSubUI();
                    await fetchManagerGrid(1, true);
                });
            });

            qs("#moreBtn").addEventListener("click", async () => {
                if (!state.hasMore) return;
                state.pageNo += 1;
                await fetchManagerGrid(state.pageNo, false);
            });
        }

        async function includeLayout() {
            // 헤더/푸터 fetch (네 구조에 맞춰 경로만 유지)
            try {
                const h = await fetch("/components/header.html");
                if (h.ok) qs("#header-placeholder").innerHTML = await h.text();
            } catch { }
            try {
                const f = await fetch("/components/footer.html");
                if (f.ok) qs("#footer-placeholder").innerHTML = await f.text();
            } catch { }
        }

        (async function init() {
            await includeLayout();

            const { category, sub } = getQuery();
            state.category = category || "";
            state.subcategory = sub || "__all__";

            qs("#categoryBadge").textContent = state.category || "-";
            setActiveSubUI();
            wireSubButtons();

            await fetchManagerGrid(1, true);
        })();
    </script>
</body>

</html>