<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>?쒕툕 移댄뀒怨좊━ ?섏씠吏</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-white text-gray-800 min-h-screen flex flex-col">
    <div id="header-placeholder"></div>

    <section class="relative h-[70vh] max-h-[400px] flex items-center justify-between px-8 bg-gray-50">
        <div class="flex-1 flex justify-center">
            <img id="heroImage" src="/uploads/no-image.png" alt="諛곕꼫" class="h-[280px] object-contain">
        </div>
        <div class="flex-1 text-left">
            <h1 id="heroTitle" class="text-3xl md:text-4xl font-bold mb-4">移댄뀒怨좊━ ?쒕ぉ</h1>
            <p id="heroSubtitle" class="text-gray-600 mb-6">移댄뀒怨좊━ ?ㅻ챸</p>
            <button id="btnMoreHero" class="px-5 py-2.5 bg-black text-white font-semibold rounded-lg">MORE VIEW</button>
        </div>
    </section>

    <!-- All of the items -->
    <section id="aboutSection" class="max-w-6xl mx-auto py-12 px-4 w-full">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl md:text-2xl font-bold">All of the items</h2>
            <button id="btnMoreItems"
                class="px-4 py-2 rounded-lg bg-gray-900 text-white text-sm font-semibold">?붾낫湲?/button>
        </div>
        <div id="filterContainer" class="flex justify-center flex-wrap gap-3 mb-8"></div>
        <div id="lineGrid" class="grid grid-cols-1 gap-4"></div>

        <div id="itemsPager" class="mt-8 flex justify-center items-center gap-3 hidden">
            <button id="itemsPrev" class="px-3 py-2 rounded bg-gray-200 hover:bg-gray-300 text-sm">?댁쟾</button>
            <div id="itemsPageInfo" class="text-sm font-semibold text-gray-700"></div>
            <button id="itemsNext" class="px-3 py-2 rounded bg-gray-200 hover:bg-gray-300 text-sm">?ㅼ쓬</button>
        </div>
    </section>

    <!-- Best Seller -->
    <section class="max-w-6xl mx-auto py-12 px-4 w-full">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl md:text-2xl font-bold">Best Seller</h2>
            <button id="btnMoreBest"
                class="px-4 py-2 rounded-lg bg-gray-900 text-white text-sm font-semibold">?붾낫湲?/button>
        </div>
        <div id="bestGrid" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>

        <div id="bestPager" class="mt-8 flex justify-center items-center gap-3 hidden">
            <button id="bestPrev" class="px-3 py-2 rounded bg-gray-200 hover:bg-gray-300 text-sm">?댁쟾</button>
            <div id="bestPageInfo" class="text-sm font-semibold text-gray-700"></div>
            <button id="bestNext" class="px-3 py-2 rounded bg-gray-200 hover:bg-gray-300 text-sm">?ㅼ쓬</button>
        </div>
    </section>

    <!-- New registration -->
    <section class="max-w-6xl mx-auto py-12 px-4 w-full">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl md:text-2xl font-bold">New registration</h2>
            <button id="btnMoreNew"
                class="px-4 py-2 rounded-lg bg-gray-900 text-white text-sm font-semibold">?붾낫湲?/button>
        </div>
        <div id="newGrid" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>

        <div id="newPager" class="mt-8 flex justify-center items-center gap-3 hidden">
            <button id="newPrev" class="px-3 py-2 rounded bg-gray-200 hover:bg-gray-300 text-sm">?댁쟾</button>
            <div id="newPageInfo" class="text-sm font-semibold text-gray-700"></div>
            <button id="newNext" class="px-3 py-2 rounded bg-gray-200 hover:bg-gray-300 text-sm">?ㅼ쓬</button>
        </div>
    </section>

    <div id="footer-placeholder"></div>

    <div class="fixed bottom-6 right-6 flex flex-col items-center gap-4 z-50">
        <div class="flex flex-col items-center">
            <button onclick="goBack()"
                class="w-14 h-14 flex items-center justify-center rounded-full bg-gradient-to-br from-gray-100 to-gray-200 text-gray-700 shadow hover:from-gray-200 hover:to-gray-300 transition">??/button>
            <span class="text-xs mt-1 text-gray-600 font-semibold">?댁쟾</span>
        </div>

        <div class="flex flex-col items-center">
            <button onclick="goNext()"
                class="w-14 h-14 flex items-center justify-center rounded-full bg-gradient-to-br from-gray-100 to-gray-200 text-gray-700 shadow hover:from-gray-200 hover:to-gray-300 transition">??/button>
            <span class="text-xs mt-1 text-gray-600 font-semibold">?ㅼ쓬</span>
        </div>

        <div class="flex flex-col items-center">
            <a href="/index.html"
                class="w-14 h-14 flex items-center justify-center rounded-full bg-gradient-to-br from-blue-500 to-blue-600 text-white shadow hover:from-blue-600 hover:to-blue-700 transition">?룧</a>
            <span class="text-xs mt-1 text-gray-600 font-semibold">??/span>
        </div>
    </div>

    <script>
        fetch("/components/header.html").then(r => r.text()).then(d => (document.getElementById("header-placeholder").innerHTML = d));
        fetch("/components/footer.html").then(r => r.text()).then(d => (document.getElementById("footer-placeholder").innerHTML = d));

        const params = new URLSearchParams(window.location.search);
        const TYPE = (params.get("type") || "food").toLowerCase();

        const RAW_CATEGORY = (params.get("category") || "").trim();
        // ??subcategory留??쎄린 (sub???ъ슜?섏? ?딆쓬)
        const RAW_SUB = (params.get("subcategory") || "").trim();

        let CATEGORY = RAW_CATEGORY;
        let SUB = RAW_SUB;

        const HANSIK_SUBS = ["諛?, "李뚭컻??, "怨좉린援ъ씠", "?앹꽑", "議깅컻蹂댁뙂", "援?갈", "諛섏갔", "湲고??쒖떇"];
        const BEAUTY_TYPE_FILTERS = ["誘몄슜", "?대컻", "湲고?"];

        let ALL_STORES = [];
        let CURRENT_SUB = SUB;

        const DEFAULT_DATA = {
            hero: { title: "?섑뵆 移댄뀒怨좊━", subtitle: "湲곕낯 ?ㅻ챸 ?띿뒪??, image: "/uploads/no-image.png" },
            filters: [],
            stores: [],
            best: [],
            new: []
        };
        let DATA = { ...DEFAULT_DATA };

        const COLLAPSED_COUNT = 8;
        const PAGE_SIZE = 12;

        const sectionState = {
            items: { expanded: false, page: 1 },
            best: { expanded: false, page: 1 },
            newly: { expanded: false, page: 1 }
        };

        function escapeHtml(input) {
            const s = input == null ? "" : String(input);
            return s.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;").replace(/'/g, "&#39;");
        }

        function normalizeSrc(src) {
            if (!src) return "/uploads/no-image.png";
            if (/^https?:\/\//i.test(src)) return src;
            return src.startsWith("/") ? src : "/" + src;
        }

        function pickImage(store) {
            const cand = store.main_image_url || store.image_url || store.image || store.url || "";
            return normalizeSrc(cand);
        }

        function getDetailCategory(store) {
            const raw = (store.detail_category ?? store.detailCategory ?? "").toString().trim();
            return raw ? raw : "湲고??쒖떇";
        }

        function getCombinedSubcategory(store) {
            return (store.business_subcategory ?? store.businessSubcategory ?? "").toString().trim();
        }

        function getBeautyType(store) {
            const t = (store.business_type ?? store.businessType ?? "").toString().trim();
            if (t === "誘몄슜") return "誘몄슜";
            if (t === "?대컻") return "?대컻";
            return "湲고?";
        }

        function setHero(title, subtitle) {
            DATA.hero = {
                title: title || "移댄뀒怨좊━",
                subtitle: subtitle || "移댄뀒怨좊━蹂?媛寃뚮? ?뺤씤?섏꽭??",
                image: "/uploads/no-image.png"
            };
        }

        function setHansikHero(subVal) {
            const titleBase = "?쒖떇";
            const subLabel = subVal ? ` 쨌 ${subVal}` : "";
            DATA.hero = {
                title: `${titleBase}${subLabel}`,
                subtitle:
                    subVal === "諛? ? "鍮꾨퉼諛?쨌 ??갈 쨌 諛깅컲 ???좊뱺??????紐⑥쓬"
                        : subVal === "李뚭컻?? ? "?곕걟??李뚭컻? ?쇳겙?????붾━瑜?紐⑥븯?댁슂"
                            : subVal === "怨좉린援ъ씠" ? "?쇨껸?? 媛덈퉬, ??텋援ъ씠 ??怨좉린 醫뗭븘?섎뒗 ?좎뿉 ??"
                                : subVal === "?앹꽑" ? "援ъ씠 쨌 議곕┝ 쨌 ?????ㅼ뼇???앹꽑 ?붾━"
                                    : subVal === "議깅컻蹂댁뙂" ? "議깅컻 쨌 蹂댁뙂 쨌 ?섏쑁源뚯? ?몄쭚?섍쾶"
                                        : subVal === "援?갈" ? "?⑤걟??援?갈 ??洹몃쫯?쇰줈 ?좊뱺?섍쾶"
                                            : subVal === "諛섏갔" ? "吏묐갈 ?먮굦 ?섎뒗 諛섏갔/?꾩떆??媛寃?紐⑥쓬"
                                                : subVal === "湲고??쒖떇" ? "?쒖떇 遺꾨쪟???ㅼ뼱媛吏 ?딅뒗 ?ㅼ뼇??硫붾돱 紐⑥쓬"
                                                    : "?곕━?숇꽕 ?쒖떇 留쏆쭛?ㅼ쓣 紐⑥븯?듬땲??",
                image: "/uploads/no-image.png"
            };
        }

        async function fetchJson(url) {
            const res = await fetch(url);
            const json = await res.json();
            if (!res.ok) {
                console.error("??fetchJson not ok:", res.status, url, json);
            }
            return json;
        }

        const GRID_API_BASE = "/subcategorymanager/ad";

        async function fetchManagerGrid(section, pageNo) {
            const params = new URLSearchParams();
            params.set("page", "subcategory");
            params.set("section", section);
            params.set("mode", TYPE);
            params.set("pageNo", String(pageNo || 1));

            if (CATEGORY) params.set("category", CATEGORY);
            
            // ??subcategory媛 ?덉쑝硫?臾댁“嫄?遺숈씠湲?(議곌굔 ?쒓굅)
            if (CURRENT_SUB) {
                params.set("subcategory", CURRENT_SUB);
            }

            const url = `/subcategorymanager_food/ad/grid?${params.toString()}`;
            const res = await fetch(url, { cache: "no-store" });
            if (!res.ok) throw new Error(`grid fetch ?ㅽ뙣: ${res.status}`);
            return await res.json();
        }

        function gridItemsToStores(items, limit) {
            const stores = (items || [])
                .filter((it) => it && it.occupied)
                .map((it) => ({
                    id: it.store_id,
                    business_number: it.business_no || "",
                    business_name: it.business_name || "",
                    business_type: it.store_type || "",
                    image_url: it.image_url || "",
                    _source: it.source,
                    _position: it.position,
                }));

            return typeof limit === "number" ? stores.slice(0, limit) : stores;
        }

        function buildDynamicFiltersFromStores(stores) {
            const set = new Set();
            (stores || []).forEach(s => {
                const sub = getCombinedSubcategory(s);
                if (sub) set.add(sub);
            });
            const list = Array.from(set);
            list.sort((a, b) => a.localeCompare(b, "ko"));
            return list;
        }

        function buildBestFromStores(stores) {
            const arr = (stores || []).slice();
            arr.sort((a, b) => {
                const av = Number(a.view_count ?? a.viewCount ?? 0);
                const bv = Number(b.view_count ?? b.viewCount ?? 0);
                return bv - av;
            });
            return arr;
        }

        function buildNewFromStores(stores) {
            const now = Date.now();
            const limitMs = 60 * 24 * 60 * 60 * 1000;

            const arr = (stores || []).filter(s => {
                const t = Date.parse(s.created_at ?? s.createdAt ?? "");
                if (!Number.isFinite(t)) return false;
                return (now - t) <= limitMs;
            });

            arr.sort((a, b) => {
                const at = Date.parse(a.created_at ?? a.createdAt ?? "") || 0;
                const bt = Date.parse(b.created_at ?? b.createdAt ?? "") || 0;
                return bt - at;
            });

            return arr;
        }

        function resetPagingAll() {
            sectionState.items.page = 1;
            sectionState.best.page = 1;
            sectionState.newly.page = 1;
        }

        function applySubFilter(subVal, updateHistory = true) {
            const sub = (subVal || "").trim();
            CURRENT_SUB = sub;

            if (TYPE === "food" && CATEGORY === "?쒖떇") {
                if (!sub) {
                    DATA.stores = ALL_STORES.slice();
                    setHansikHero("");
                    if (updateHistory) {
                        const q = new URLSearchParams(location.search);
                        q.delete("sub");
                        q.delete("subcategory");
                        history.replaceState(null, "", `${location.pathname}?${q.toString()}`);
                    }
                    return;
                }

                DATA.stores = ALL_STORES.filter(s => getDetailCategory(s) === sub);
                setHansikHero(sub);

                if (updateHistory) {
                    const q = new URLSearchParams(location.search);
                    q.set("subcategory", sub);
                    q.delete("sub");
                    history.replaceState(null, "", `${location.pathname}?${q.toString()}`);
                }
                return;
            }

            if (TYPE === "combined" && CATEGORY === "誘몄슜/?대컻") {
                if (!sub) {
                    DATA.stores = ALL_STORES.slice();
                    setHero("誘몄슜/?대컻", "誘몄슜/?대컻 移댄뀒怨좊━ 媛寃뚮? ?뺤씤?섏꽭??");
                    if (updateHistory) {
                        const q = new URLSearchParams(location.search);
                        q.delete("sub");
                        q.delete("subcategory");
                        history.replaceState(null, "", `${location.pathname}?${q.toString()}`);
                    }
                    return;
                }

                DATA.stores = ALL_STORES.filter(s => getBeautyType(s) === sub);
                setHero(`誘몄슜/?대컻 쨌 ${sub}`, "?좏깮??遺꾨쪟??媛寃뚮? ?뺤씤?섏꽭??");

                if (updateHistory) {
                    const q = new URLSearchParams(location.search);
                    q.set("category", "誘몄슜/?대컻");
                    q.set("subcategory", sub);
                    q.delete("sub");
                    history.replaceState(null, "", `${location.pathname}?${q.toString()}`);
                }
                return;
            }

            if (TYPE === "combined" && DATA.filters && DATA.filters.length) {
                if (!sub) {
                    DATA.stores = ALL_STORES.slice();
                    setHero(CATEGORY, "移댄뀒怨좊━蹂?媛寃뚮? ?뺤씤?섏꽭??");
                    if (updateHistory) {
                        const q = new URLSearchParams(location.search);
                        q.delete("sub");
                        q.delete("subcategory");
                        history.replaceState(null, "", `${location.pathname}?${q.toString()}`);
                    }
                    return;
                }

                DATA.stores = ALL_STORES.filter(s => getCombinedSubcategory(s) === sub);
                setHero(`${CATEGORY} 쨌 ${sub}`, "?좏깮???쒕툕移댄뀒怨좊━??媛寃뚮? ?뺤씤?섏꽭??");

                if (updateHistory) {
                    const q = new URLSearchParams(location.search);
                    q.set("subcategory", sub);
                    q.delete("sub");
                    history.replaceState(null, "", `${location.pathname}?${q.toString()}`);
                }
                return;
            }

            DATA.stores = ALL_STORES.slice();
            setHero(CATEGORY, "移댄뀒怨좊━蹂?媛寃뚮? ?뺤씤?섏꽭??");
        }

        function renderStoresGrid(stores, gridEl) {
            gridEl.innerHTML = "";

            if (!stores || !stores.length) {
                gridEl.innerHTML = `
          <div class="col-span-full flex justify-center items-center py-16">
            <div class="p-8 text-center max-w-md">
              <h3 class="text-lg font-semibold text-gray-700 mb-2">?깅줉??媛寃뚭? ?놁뒿?덈떎</h3>
              <p class="text-sm text-gray-500">鍮좊Ⅸ ?쒖씪 ?댁뿉 ?덈줈??媛寃뚭? 異붽????덉젙?낅땲??</p>
            </div>
          </div>`;
                return;
            }

            const wrapper = document.createElement("div");
            wrapper.className = "col-span-full grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6";

            stores.forEach(store => {
                const card = document.createElement("div");
                card.className = "rounded-2xl cursor-pointer hover:shadow-lg transition overflow-hidden flex flex-col h-auto bg-white";
                
                // ??data attribute濡?store ?뺣낫 紐낆떆
                card.dataset.storeId = store.id || "";
                card.dataset.storeType = TYPE;

                const dispName = store.business_name ?? store.name ?? store.businessName ?? store.title ?? "-";
                const dispType = (store.business_type ?? store.businessType ?? "").toString().trim();
                const dispCategory = (store.business_category ?? store.category ?? store.businessCategory ?? "").toString().trim();
                const imgNorm = pickImage(store);

                card.innerHTML = `
          <div class="relative h-[260px]">
            <img src="${imgNorm}" alt="${escapeHtml(dispName)}" class="w-full h-full object-cover rounded-t-2xl">
            <div class="absolute left-0 right-0 bottom-0 bg-white/90 backdrop-blur px-4 py-2 text-center rounded-b-2xl">
              <div class="font-bold text-lg text-gray-800 leading-tight truncate">${escapeHtml(dispName)}</div>

              <!-- ???낆쥌 ?쒖떆 -->
              <div class="text-sm text-gray-700 truncate">${escapeHtml(dispType ? `?낆쥌: ${dispType}` : "?낆쥌: -")}</div>

              <!-- ??移댄뀒怨좊━???덉쑝硫??쒖떆(?놁쑝硫?'-' ) -->
              <div class="text-xs text-gray-600 truncate">${escapeHtml(dispCategory ? `移댄뀒怨좊━: ${dispCategory}` : "移댄뀒怨좊━: -")}</div>
            </div>
          </div>`;

                card.addEventListener("click", () => {
                    // ??data attribute?먯꽌 ?뺥솗??store_id瑜?媛?몄????대룞
                    const storeId = card.dataset.storeId;
                    const storeType = card.dataset.storeType;
                    window.location.href = `/ndetail.html?id=${encodeURIComponent(storeId)}&type=${encodeURIComponent(storeType)}`;
                });

                wrapper.appendChild(card);
            });

            gridEl.appendChild(wrapper);
        }

        function renderSmallGrid(gridId, items) {
            const grid = document.getElementById(gridId);
            grid.innerHTML = "";

            if (!items || !items.length) {
                grid.innerHTML = `<div class="col-span-full text-center text-gray-500">?깅줉??媛寃뚭? ?놁뒿?덈떎.</div>`;
                return;
            }

            items.forEach(item => {
                const name = item.business_name ?? item.name ?? "-";
                const img = pickImage(item);

                const card = document.createElement("div");
                card.className = "block rounded-2xl overflow-hidden bg-white hover:shadow-lg transition cursor-pointer";
                
                // ??data attribute濡?store ?뺣낫 紐낆떆
                card.dataset.storeId = item.id || "";
                card.dataset.storeType = TYPE;
                
                card.innerHTML = `
          <div class="h-40">
            <img src="${img}" alt="${escapeHtml(name)}" class="w-full h-full object-cover">
          </div>
          <div class="p-3 text-sm font-semibold truncate">${escapeHtml(name)}</div>
        `;
                
                card.addEventListener("click", () => {
                    const storeId = card.dataset.storeId;
                    const storeType = card.dataset.storeType;
                    window.location.href = `/ndetail.html?id=${encodeURIComponent(storeId)}&type=${encodeURIComponent(storeType)}`;
                });
                
                grid.appendChild(card);
            });
        }

        function bindHero() {
            document.getElementById("heroTitle").innerHTML = (DATA.hero?.title || "").replace(/\n/g, "<br>");
            document.getElementById("heroSubtitle").textContent = DATA.hero?.subtitle || "";
            document.getElementById("heroImage").src = DATA.hero?.image || "/uploads/no-image.png";
        }

        function makeFilterBtn(label, tagVal) {
            const btn = document.createElement("button");
            btn.type = "button";

            const isActive = (CURRENT_SUB || "") === (tagVal || "");
            btn.className = isActive
                ? "px-3 py-1.5 rounded-full bg-black text-white text-sm"
                : "px-3 py-1.5 rounded-full bg-gray-200 hover:bg-gray-300 text-sm";

            btn.textContent = label;

            btn.onclick = async () => {
                resetPagingAll();
                applySubFilter(tagVal || "", true);
                bindHero();
                renderFilters();
                await renderItemsSection();
                renderBestSection();
                renderNewSection();
            };
            return btn;
        }

        function renderFilters() {
            const wrap = document.getElementById("filterContainer");
            wrap.innerHTML = "";

            if (TYPE === "food" && CATEGORY === "?쒖떇") {
                wrap.appendChild(makeFilterBtn("All", ""));
                HANSIK_SUBS.forEach(tag => wrap.appendChild(makeFilterBtn(tag, tag)));
                return;
            }

            if (TYPE === "combined" && CATEGORY === "誘몄슜/?대컻") {
                wrap.appendChild(makeFilterBtn("All", ""));
                BEAUTY_TYPE_FILTERS.forEach(tag => wrap.appendChild(makeFilterBtn(tag, tag)));
                return;
            }

            if (TYPE === "combined" && DATA.filters && DATA.filters.length) {
                wrap.appendChild(makeFilterBtn("All", ""));
                DATA.filters.forEach(tag => wrap.appendChild(makeFilterBtn(tag, tag)));
                return;
            }
        }

        async function renderItemsSection() {
            const grid = document.getElementById("lineGrid");
            const pager = document.getElementById("itemsPager");
            const prev = document.getElementById("itemsPrev");
            const next = document.getElementById("itemsNext");
            const info = document.getElementById("itemsPageInfo");

            const pageNo = sectionState.items.expanded ? sectionState.items.page : 1;

            const json = await fetchManagerGrid("all_items", pageNo);

            const stores = gridItemsToStores(
                json.items,
                sectionState.items.expanded ? undefined : 4
            );

            renderStoresGrid(stores, grid);

            const totalPages = json.totalPages || 1;

            if (!sectionState.items.expanded || totalPages <= 1) {
                pager.classList.add("hidden");
            } else {
                pager.classList.remove("hidden");
                info.textContent = `${sectionState.items.page} / ${totalPages}`;
                prev.disabled = sectionState.items.page <= 1;
                next.disabled = sectionState.items.page >= totalPages;
            }
        }

        async function renderBestSection() {
            const pager = document.getElementById("bestPager");
            const prev = document.getElementById("bestPrev");
            const next = document.getElementById("bestNext");
            const info = document.getElementById("bestPageInfo");

            const pageNo = sectionState.best.expanded ? sectionState.best.page : 1;
            const json = await fetchManagerGrid("best_seller", pageNo);
            const items = gridItemsToStores(json.items, sectionState.best.expanded ? undefined : 8);

            renderSmallGrid("bestGrid", items);

            const totalPages = json.totalPages || 1;
            if (!sectionState.best.expanded || totalPages <= 1) {
                pager.classList.add("hidden");
            } else {
                pager.classList.remove("hidden");
                info.textContent = `${sectionState.best.page} / ${totalPages}`;
                prev.disabled = sectionState.best.page <= 1;
                next.disabled = sectionState.best.page >= totalPages;
            }
        }

        async function renderNewSection() {
            const pager = document.getElementById("newPager");
            const prev = document.getElementById("newPrev");
            const next = document.getElementById("newNext");
            const info = document.getElementById("newPageInfo");

            const pageNo = sectionState.newly.expanded ? sectionState.newly.page : 1;
            const json = await fetchManagerGrid("new_registration", pageNo);
            const items = gridItemsToStores(json.items, sectionState.newly.expanded ? undefined : 8);

            renderSmallGrid("newGrid", items);

            const totalPages = json.totalPages || 1;
            if (!sectionState.newly.expanded || totalPages <= 1) {
                pager.classList.add("hidden");
            } else {
                pager.classList.remove("hidden");
                info.textContent = `${sectionState.newly.page} / ${totalPages}`;
                prev.disabled = sectionState.newly.page <= 1;
                next.disabled = sectionState.newly.page >= totalPages;
            }
        }

        function syncMoreButtonLabels() {
            document.getElementById("btnMoreItems").textContent = sectionState.items.expanded ? "?묎린" : "?붾낫湲?;
            document.getElementById("btnMoreBest").textContent = sectionState.best.expanded ? "?묎린" : "?붾낫湲?;
            document.getElementById("btnMoreNew").textContent = sectionState.newly.expanded ? "?묎린" : "?붾낫湲?;
            document.getElementById("btnMoreHero").textContent = sectionState.items.expanded ? "CLOSE VIEW" : "MORE VIEW";
        }

        function bindMoreAndPagerEvents() {
            document.getElementById("btnMoreItems").onclick = () => {
                sectionState.items.expanded = !sectionState.items.expanded;
                sectionState.items.page = 1;
                syncMoreButtonLabels();
                renderItemsSection();
            };
            document.getElementById("btnMoreHero").onclick = () => {
                document.getElementById("btnMoreItems").click();
            };
            document.getElementById("itemsPrev").onclick = () => {
                sectionState.items.page = Math.max(1, sectionState.items.page - 1);
                renderItemsSection();
            };
            document.getElementById("itemsNext").onclick = () => {
                sectionState.items.page += 1;
                renderItemsSection();
            };

            document.getElementById("btnMoreBest").onclick = async (e) => {
                e?.preventDefault?.();
                const keepY = window.scrollY;

                sectionState.best.expanded = !sectionState.best.expanded;
                sectionState.best.page = 1;
                syncMoreButtonLabels();
                await renderBestSection();

                requestAnimationFrame(() => window.scrollTo({ top: keepY, behavior: "auto" }));
            };
            document.getElementById("bestPrev").onclick = () => {
                sectionState.best.page = Math.max(1, sectionState.best.page - 1);
                renderBestSection();
            };
            document.getElementById("bestNext").onclick = () => {
                sectionState.best.page += 1;
                renderBestSection();
            };

            document.getElementById("btnMoreNew").onclick = async (e) => {
                e?.preventDefault?.();
                const keepY = window.scrollY;

                sectionState.newly.expanded = !sectionState.newly.expanded;
                sectionState.newly.page = 1;
                syncMoreButtonLabels();
                await renderNewSection();

                requestAnimationFrame(() => window.scrollTo({ top: keepY, behavior: "auto" }));
            };
            document.getElementById("newPrev").onclick = () => {
                sectionState.newly.page = Math.max(1, sectionState.newly.page - 1);
                renderNewSection();
            };
            document.getElementById("newNext").onclick = () => {
                sectionState.newly.page += 1;
                renderNewSection();
            };
        }

        async function loadData() {
            try {
                DATA = { ...DEFAULT_DATA };
                ALL_STORES = [];

                sectionState.items.expanded = false; sectionState.items.page = 1;
                sectionState.best.expanded = false; sectionState.best.page = 1;
                sectionState.newly.expanded = false; sectionState.newly.page = 1;

                if (TYPE === "food") {
                    const q = new URLSearchParams();
                    q.set("category", CATEGORY);
                    // ??subcategory媛 ?덉쑝硫?異붽?
                    if (CURRENT_SUB) q.set("subcategory", CURRENT_SUB);

                    const json = await fetchJson(`/api/subcategory/food?${q.toString()}`);
                    ALL_STORES = json.stores || [];

                    if (CATEGORY === "?쒖떇") {
                        DATA.filters = HANSIK_SUBS.slice();
                        applySubFilter(CURRENT_SUB, false);
                    } else {
                        DATA.filters = [];
                        setHero(CATEGORY, "移댄뀒怨좊━蹂?媛寃뚮? ?뺤씤?섏꽭??");
                        DATA.stores = ALL_STORES.slice();
                    }

                    try {
                        const best = await fetchJson(`/api/subcategory/food/best`);
                        DATA.best = best.stores || [];
                    } catch (_) { }
                    try {
                        const nw = await fetchJson(`/api/subcategory/food/new`);
                        DATA.new = nw.stores || [];
                    } catch (_) { }

                } else if (TYPE === "combined") {
                    const q = new URLSearchParams();
                    q.set("category", CATEGORY);
                    // ??subcategory媛 ?덉쑝硫?異붽?
                    if (CURRENT_SUB) q.set("subcategory", CURRENT_SUB);
                    
                    const json = await fetchJson(`/api/subcategory/combined?${q.toString()}`);
                    ALL_STORES = json.stores || [];

                    if (CATEGORY === "誘몄슜/?대컻") {
                        DATA.filters = BEAUTY_TYPE_FILTERS.slice();
                        applySubFilter(CURRENT_SUB, false);
                    } else {
                        DATA.filters = buildDynamicFiltersFromStores(ALL_STORES);
                        applySubFilter(CURRENT_SUB, false);
                        if (!CURRENT_SUB) setHero(CATEGORY, "移댄뀒怨좊━蹂?媛寃뚮? ?뺤씤?섏꽭??");
                    }

                    DATA.best = buildBestFromStores(ALL_STORES);
                    DATA.new = buildNewFromStores(ALL_STORES);
                } else {
                    ALL_STORES = [];
                    DATA = { ...DEFAULT_DATA };
                }

            } catch (e) {
                console.error("?곗씠??遺덈윭?ㅺ린 ?ㅽ뙣:", e);
                ALL_STORES = [];
                DATA = { ...DEFAULT_DATA };
            }

            await init();
        }

        async function init() {
            bindHero();
            renderFilters();
            syncMoreButtonLabels();
            bindMoreAndPagerEvents();

            await renderItemsSection();
            await renderBestSection();
            await renderNewSection();
        }

        document.addEventListener("DOMContentLoaded", loadData);

        function goBack() {
            if (document.referrer && document.referrer !== location.href) window.history.back();
            else window.location.href = "/category.html";
        }
        function goNext() { window.history.forward(); }
    </script>
</body>

</html>

