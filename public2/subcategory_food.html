<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì„œë¸Œ ì¹´í…Œê³ ë¦¬ (í‘¸ë“œ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-white text-gray-800 min-h-screen flex flex-col">
    <div id="header-placeholder"></div>

    <!-- HERO -->
    <section class="relative h-[70vh] max-h-[400px] flex items-center justify-between px-8 bg-gray-50">
        <div class="flex-1 flex justify-center">
            <a id="heroLink" href="#">
                <img id="heroImage" src="/uploads/sample-banner-product.png" alt="ë°°ë„ˆ" class="h-[280px] object-contain">
            </a>
        </div>
        <div class="flex-1 text-left">
            <!-- âœ… setHero ì—ì„œ heroTitle, heroSubtitle ë¥¼ ì°¾ì„ ìˆ˜ ìˆê²Œ id ë¶€ì—¬ -->
            <h1 id="heroTitle" class="text-3xl md:text-4xl font-bold mb-4">ì¹´í…Œê³ ë¦¬ ì œëª©</h1>
            <p id="heroSubtitle" class="text-slate-600 text-sm md:text-base mt-2">
                ì„¤ëª… í…ìŠ¤íŠ¸...
            </p>
        </div>
    </section>

    <!-- All of the items -->
    <section id="aboutSection" class="max-w-6xl mx-auto py-12 px-4 w-full">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl md:text-2xl font-bold">All of the items</h2>
            <button id="btnMoreItems"
                class="px-4 py-2 rounded-lg bg-gray-900 text-white text-sm font-semibold">ë”ë³´ê¸°</button>
        </div>

        <!-- âœ… í•œì‹ì¼ ë•Œë§Œ í‘œì‹œë˜ëŠ” ì„œë¸Œí•„í„° -->
        <div id="filterWrap" class="mb-8 hidden">
            <div id="filterContainer" class="flex justify-center flex-wrap gap-3"></div>
        </div>

        <div id="lineGrid" class="grid grid-cols-1 gap-4"></div>

        <!-- pagination -->
        <div id="itemsPager" class="mt-8 flex justify-center items-center gap-3 hidden">
            <button id="itemsPrev" class="px-3 py-2 rounded bg-gray-200 hover:bg-gray-300 text-sm">ì´ì „</button>
            <div id="itemsPageInfo" class="text-sm font-semibold text-gray-700"></div>
            <button id="itemsNext" class="px-3 py-2 rounded bg-gray-200 hover:bg-gray-300 text-sm">ë‹¤ìŒ</button>
        </div>
    </section>

    <!-- Best Seller -->
    <section class="max-w-6xl mx-auto py-12 px-4 w-full">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl md:text-2xl font-bold">Best Seller</h2>
            <button id="btnMoreBest"
                class="px-4 py-2 rounded-lg bg-gray-900 text-white text-sm font-semibold">ë”ë³´ê¸°</button>
        </div>

        <div id="bestGrid" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>

        <div id="bestPager" class="mt-8 flex justify-center items-center gap-3 hidden">
            <button id="bestPrev" class="px-3 py-2 rounded bg-gray-200 hover:bg-gray-300 text-sm">ì´ì „</button>
            <div id="bestPageInfo" class="text-sm font-semibold text-gray-700"></div>
            <button id="bestNext" class="px-3 py-2 rounded bg-gray-200 hover:bg-gray-300 text-sm">ë‹¤ìŒ</button>
        </div>
    </section>

    <!-- New registration -->
    <section class="max-w-6xl mx-auto py-12 px-4 w-full">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl md:text-2xl font-bold">New registration</h2>
            <button id="btnMoreNew"
                class="px-4 py-2 rounded-lg bg-gray-900 text-white text-sm font-semibold">ë”ë³´ê¸°</button>
        </div>

        <div id="newGrid" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>

        <div id="newPager" class="mt-8 flex justify-center items-center gap-3 hidden">
            <button id="newPrev" class="px-3 py-2 rounded bg-gray-200 hover:bg-gray-300 text-sm">ì´ì „</button>
            <div id="newPageInfo" class="text-sm font-semibold text-gray-700"></div>
            <button id="newNext" class="px-3 py-2 rounded bg-gray-200 hover:bg-gray-300 text-sm">ë‹¤ìŒ</button>
        </div>
    </section>

    <div id="footer-placeholder"></div>

    <!-- ìš°ì¸¡ ê³ ì • ë²„íŠ¼ -->
    <div class="fixed bottom-6 right-6 flex flex-col items-center gap-4 z-50">
        <div class="flex flex-col items-center">
            <button onclick="goBack()"
                class="w-14 h-14 flex items-center justify-center rounded-full bg-gradient-to-br from-gray-100 to-gray-200 text-gray-700 shadow hover:from-gray-200 hover:to-gray-300 transition">â†</button>
            <span class="text-xs mt-1 text-gray-600 font-semibold">ì´ì „</span>
        </div>
        <div class="flex flex-col items-center">
            <button onclick="goNext()"
                class="w-14 h-14 flex items-center justify-center rounded-full bg-gradient-to-br from-gray-100 to-gray-200 text-gray-700 shadow hover:from-gray-200 hover:to-gray-300 transition">â†’</button>
            <span class="text-xs mt-1 text-gray-600 font-semibold">ë‹¤ìŒ</span>
        </div>
        <div class="flex flex-col items-center">
            <a href="/index.html"
                class="w-14 h-14 flex items-center justify-center rounded-full bg-gradient-to-br from-blue-500 to-blue-600 text-white shadow hover:from-blue-600 hover:to-blue-700 transition">ğŸ </a>
            <span class="text-xs mt-1 text-gray-600 font-semibold">í™ˆ</span>
        </div>
    </div>

    <script>
        // ==========================================
        // âœ… FOOD ì „ìš©: manager grid endpoint
        // ==========================================
        const GRID_ENDPOINT = "/subcategorymanager/ad/grid";

        // All items: ì ‘í˜ 4ê°œ / í¼ì¹¨ 12ê°œ + í˜ì´ì§€ë„¤ì´ì…˜
        const ITEMS_COLLAPSED_COUNT = 4;
        const ITEMS_PAGE_SIZE = 12;

        // Best/New: í•­ìƒ 9ê°œì”© (í¼ì¹¨ë„ 9ê°œ/í˜ì´ì§€ + í˜ì´ì§€ë„¤ì´ì…˜)
        const SMALL_PAGE_SIZE = 9;
        const SMALL_COLLAPSED_COUNT = 9;

        // í•œì‹ ì„œë¸Œ(ê³ ì •)
        const HANSIK_SUBS = ["ë°¥", "ì°Œê°œíƒ•", "ê³ ê¸°êµ¬ì´", "ìƒì„ ", "ì¡±ë°œë³´ìŒˆ", "êµ­ë°¥", "ë°˜ì°¬", "ê¸°íƒ€í•œì‹"];

        const state = {
            category: "",
            subcategory: "",        // "" = ì „ì²´ / í•œì‹ì¼ ë• HANSIK_SUBS ì¤‘ í•˜ë‚˜
            cacheAllFirstPage: [],  // fallbackìš©
            sectionState: {
                items: { expanded: false, page: 1, totalPages: 1 },
                best: { expanded: false, page: 1, totalPages: 1 },
                newly: { expanded: false, page: 1, totalPages: 1 },
            }
        };

        function qs(sel) { return document.querySelector(sel); }
        function clean(v) { return (v ?? "").toString().trim(); }

        // âœ… ë°°ì—´ ëœë¤ ì„ê¸° (Fisher-Yates)
        function shuffleInPlace(arr) {
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        function escapeHtml(input) {
            const s = input == null ? "" : String(input);
            return s.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;").replace(/'/g, "&#39;");
        }

        function normalizeSrc(src) {
            const v = clean(src);
            if (!v) return "/uploads/no-image.png";
            if (/^https?:\/\//i.test(v)) return v;
            return v.startsWith("/") ? v : "/" + v;
        }

        function pickImage(store) {
            const cand = store.image_url || store.main_image_url || store.image || store.url || "";
            return normalizeSrc(cand);
        }

        function pickCategory(store) {
            return clean(store.business_category || store.category || store.businessCategory || "");
        }

        function formatFoodCategory(item) {
            const cat = String(item?.business_category || "").trim();
            const sub = String(
                item?.business_subcategory || item?.detail_category || item?.subcategory || ""
            ).trim();

            if (!cat) return sub || "";
            if (cat === "í•œì‹" && sub && sub !== cat) return `${cat}(${sub})`;
            return cat;
        }

        // âœ… ëª¨ë“  ì„¹ì…˜ì— category/subcategory ì „ì†¡
        function buildUrl(section, pageNo, pageSize) {
            const params = new URLSearchParams();
            params.set("page", "subcategory");
            params.set("section", section); // all_items | best_seller | new_registration
            params.set("pageNo", String(pageNo || 1));
            params.set("pageSize", String(pageSize || ITEMS_PAGE_SIZE));

            // âœ… FOOD ëª¨ë“œ ê³ ì •
            params.set("mode", "food");

            // âœ… ëª¨ë“  ì„¹ì…˜ì— category ì¶”ê°€
            params.set("category", state.category);

            // âœ… í•œì‹ì¼ ë•Œë§Œ subcategory ì¶”ê°€
            if (state.category === "í•œì‹" && clean(state.subcategory)) {
                params.set("subcategory", state.subcategory);
            }

            return `${GRID_ENDPOINT}?${params.toString()}`;
        }

        function normalizeItems(data) {
            const items = data?.items || data?.rows || data?.list || data?.results || [];
            return Array.isArray(items) ? items : [];
        }

        function mapItemsToStores(items) {
            return (items || [])
                .filter(it => it && (it.occupied === undefined ? true : !!it.occupied))
                .map(it => ({
                    id: it.store_id ?? it.id ?? it.storeId ?? "",
                    business_name: it.business_name ?? it.store_name ?? it.name ?? "",
                    business_type: it.store_type ?? it.business_type ?? it.type ?? "",
                    business_category: it.business_category ?? it.category ?? "",
                    // âœ… APIê°€ ì£¼ëŠ” business_subcategory(=êµ­ë°¥)ë¥¼ ìµœìš°ì„ ìœ¼ë¡œ ì‚´ë¦°ë‹¤
                    business_subcategory: it.business_subcategory ?? it.detail_category ?? it.subcategory ?? "",
                    // âœ… ê¸°ì¡´ detail_categoryë„ ê°™ì´ ìœ ì§€ (ì¹´ë“œ ë¡œì§ì´ ë‘˜ ë‹¤ ë³´ë‹ˆê¹Œ)
                    detail_category: it.business_subcategory ?? it.detail_category ?? it.subcategory ?? "",
                    image_url: it.image_url ?? it.main_image_url ?? it.image ?? "",
                    _raw: it
                }));
        }

        async function fetchGrid(section, pageNo, pageSize) {
            const url = buildUrl(section, pageNo, pageSize);
            const res = await fetch(url, { cache: "no-store", headers: { "Accept": "application/json" } });

            let json = null;
            try { json = await res.json(); } catch (_) { }

            if (!res.ok) {
                const msg = json?.error || `grid fetch ì‹¤íŒ¨: ${res.status}`;
                throw new Error(msg);
            }
            if (!json?.success) {
                throw new Error(json?.error || "grid ì‘ë‹µ ì‹¤íŒ¨");
            }
            return json;
        }

        function renderStoresGrid(stores, gridEl) {
            gridEl.innerHTML = "";

            if (!stores || !stores.length) {
                gridEl.innerHTML = `
          <div class="col-span-full flex justify-center items-center py-16">
            <div class="p-8 text-center max-w-md">
              <h3 class="text-lg font-semibold text-gray-700 mb-2">ë“±ë¡ëœ ê°€ê²Œê°€ ì—†ìŠµë‹ˆë‹¤</h3>
              <p class="text-sm text-gray-500">ë¹ ë¥¸ ì‹œì¼ ë‚´ì— ìƒˆë¡œìš´ ê°€ê²Œê°€ ì¶”ê°€ë  ì˜ˆì •ì…ë‹ˆë‹¤.</p>
            </div>
          </div>`;
                return;
            }

            const wrapper = document.createElement("div");
            wrapper.className = "col-span-full grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6";

            stores.forEach(store => {
                console.log("[CARD ITEM]", store); // âœ… ë””ë²„ê¹…: business_subcategory í™•ì¸

                const dispName = clean(store.business_name) || "-";

                // âœ… ì¹´ë“œì— í‘œì‹œí•  ì¹´í…Œê³ ë¦¬ í…ìŠ¤íŠ¸
                let catText = (store.business_category || store.store_type || store.business_type || "").trim();

                // âœ… í•œì‹ì´ë©´ ê´„í˜¸ë¡œ í•˜ìœ„ì¹´í…Œê³ ë¦¬(êµ­ë°¥ ë“±) ë¶™ì´ê¸°
                if (catText === "í•œì‹") {
                    const sub = (store.business_subcategory || store.detail_category || "").trim();
                    if (sub) catText = `í•œì‹(${sub})`;
                }

                const imgNorm = pickImage(store);

                const card = document.createElement("div");
                card.className = "rounded-2xl cursor-pointer hover:shadow-lg transition overflow-hidden flex flex-col bg-white";
                card.innerHTML = `
          <div class="relative h-[260px]">
            <img src="${imgNorm}" alt="${escapeHtml(dispName)}" class="w-full h-full object-cover rounded-t-2xl">
            <div class="absolute left-0 right-0 bottom-0 bg-white/90 backdrop-blur px-4 py-2 text-center rounded-b-2xl">
              <!-- âœ… ìƒí˜¸ í¬ê²Œ -->
              <div class="font-extrabold text-xl text-gray-900 leading-tight truncate">${escapeHtml(dispName)}</div>
              <!-- âœ… ì—…ì¢…/ì¹´í…Œê³ ë¦¬ í¬ê²Œ -->
              <div class="text-base font-semibold text-gray-700">${escapeHtml(catText)}</div>
            </div>
          </div>
        `;

                card.addEventListener("click", () => {
                    const id = store.id;
                    if (!id) return;
                    window.location.href = `/ndetail.html?id=${encodeURIComponent(id)}&type=food`;
                });

                wrapper.appendChild(card);
            });

            gridEl.appendChild(wrapper);
        }

        function renderSmallGrid(gridId, stores) {
            const grid = qs(`#${gridId}`);
            grid.innerHTML = "";

            if (!stores || !stores.length) {
                grid.innerHTML = `<div class="col-span-full text-center text-gray-500">ë“±ë¡ëœ ê°€ê²Œê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
                return;
            }

            stores.forEach(store => {
                console.log("[CARD ITEM]", store); // âœ… ë””ë²„ê¹…: business_subcategory í™•ì¸

                const name = clean(store.business_name) || "-";

                // âœ… ì¹´ë“œì— í‘œì‹œí•  ì¹´í…Œê³ ë¦¬ í…ìŠ¤íŠ¸
                let catText = (store.business_category || store.store_type || store.business_type || "").trim();

                // âœ… í•œì‹ì´ë©´ ê´„í˜¸ë¡œ í•˜ìœ„ì¹´í…Œê³ ë¦¬(êµ­ë°¥ ë“±) ë¶™ì´ê¸°
                if (catText === "í•œì‹") {
                    const sub = (store.business_subcategory || store.detail_category || "").trim();
                    if (sub) catText = `í•œì‹(${sub})`;
                }

                const img = pickImage(store);

                const card = document.createElement("a");
                card.href = "javascript:void(0)";
                card.className = "block rounded-2xl overflow-hidden bg-white hover:shadow-lg transition";
                card.innerHTML = `
          <div class="h-40">
            <img src="${img}" alt="${escapeHtml(name)}" class="w-full h-full object-cover">
          </div>
          <div class="p-3">
            <div class="text-base font-extrabold truncate">${escapeHtml(name)}</div>
            <div class="text-sm font-semibold text-gray-600 truncate">${escapeHtml(catText)}</div>
          </div>
        `;

                card.addEventListener("click", (e) => {
                    e.preventDefault();
                    const id = store.id;
                    if (!id) return;
                    window.location.href = `/ndetail.html?id=${encodeURIComponent(id)}&type=food`;
                });

                grid.appendChild(card);
            });
        }

        function setHero(title, subtitle, imageUrl, linkUrl) {
            const titleEl = document.getElementById("heroTitle");
            const subtitleEl = document.getElementById("heroSubtitle");
            const imgEl = document.getElementById("heroImage");
            const linkEl = document.getElementById("heroLink");

            if (titleEl && typeof title === "string") {
                titleEl.textContent = title;
            } else if (titleEl) {
                titleEl.textContent = "ì¹´í…Œê³ ë¦¬";
            }

            if (subtitleEl && typeof subtitle === "string") {
                subtitleEl.textContent = subtitle;
            } else if (subtitleEl) {
                subtitleEl.textContent = "ì¹´í…Œê³ ë¦¬ë³„ ê°€ê²Œë¥¼ í™•ì¸í•˜ì„¸ìš”.";
            }

            if (imgEl && typeof imageUrl === "string" && imageUrl) {
                imgEl.src = normalizeSrc(imageUrl);
            } else if (imgEl) {
                imgEl.src = normalizeSrc("/uploads/no-image.png");
            }

            if (linkEl) {
                if (typeof linkUrl === "string" && linkUrl) {
                    linkEl.href = linkUrl;
                } else {
                    linkEl.removeAttribute("href");
                }
            }
        }

        function syncMoreButtonLabels() {
            const btnItems = qs("#btnMoreItems");
            const btnBest = qs("#btnMoreBest");
            const btnNew = qs("#btnMoreNew");
            const btnHero = qs("#btnMoreHero"); // ì—†ì„ ìˆ˜ë„ ìˆìŒ

            if (btnItems) {
                btnItems.textContent = state.sectionState.items.expanded ? "ì ‘ê¸°" : "ë”ë³´ê¸°";
            }
            if (btnBest) {
                btnBest.textContent = state.sectionState.best.expanded ? "ì ‘ê¸°" : "ë”ë³´ê¸°";
            }
            if (btnNew) {
                btnNew.textContent = state.sectionState.newly.expanded ? "ì ‘ê¸°" : "ë”ë³´ê¸°";
            }
            if (btnHero) {
                btnHero.textContent = state.sectionState.items.expanded ? "CLOSE VIEW" : "MORE VIEW";
            }
        }

        function resetAllPages() {
            state.sectionState.items.page = 1;
            state.sectionState.best.page = 1;
            state.sectionState.newly.page = 1;
        }

        function updateUrlSubcategory(sub) {
            const q = new URLSearchParams(location.search);
            if (sub) q.set("subcategory", sub);
            else { q.delete("subcategory"); q.delete("sub"); }
            history.replaceState(null, "", `${location.pathname}?${q.toString()}`);
        }

        function makeFilterBtn(label, value) {
            const btn = document.createElement("button");
            btn.type = "button";
            const active = clean(state.subcategory) === clean(value);
            btn.className = active
                ? "px-3 py-1.5 rounded-full bg-black text-white text-sm"
                : "px-3 py-1.5 rounded-full bg-gray-200 hover:bg-gray-300 text-sm";
            btn.textContent = label;

            btn.onclick = async () => {
                state.subcategory = clean(value);
                resetAllPages();

                if (state.category === "í•œì‹") updateUrlSubcategory(state.subcategory);
                else updateUrlSubcategory("");

                await loadAllSections(true);
            };

            return btn;
        }

        function renderFilters() {
            const wrap = qs("#filterWrap");
            const container = qs("#filterContainer");
            container.innerHTML = "";

            if (state.category !== "í•œì‹") {
                wrap.classList.add("hidden");
                state.subcategory = "";
                return;
            }

            wrap.classList.remove("hidden");
            container.appendChild(makeFilterBtn("All", ""));
            HANSIK_SUBS.forEach(s => container.appendChild(makeFilterBtn(s, s)));
        }

        async function renderItemsSection() {
            const grid = qs("#lineGrid");
            const pager = qs("#itemsPager");
            const prev = qs("#itemsPrev");
            const next = qs("#itemsNext");
            const info = qs("#itemsPageInfo");

            const st = state.sectionState.items;
            const pageNo = st.expanded ? st.page : 1;

            const json = await fetchGrid("all_items", pageNo, ITEMS_PAGE_SIZE);
            const stores = mapItemsToStores(normalizeItems(json));

            if (pageNo === 1) state.cacheAllFirstPage = stores.slice();

            const visible = st.expanded ? stores : stores.slice(0, ITEMS_COLLAPSED_COUNT);

            // ğŸ”¥ ì´ ë¶€ë¶„ì„ ì œê±°í•´ì„œ, ë°°ë„ˆ ì´ë¯¸ì§€ë¥¼ ê°€ê²Œ ì´ë¯¸ì§€ë¡œ ë®ì–´ì“°ì§€ ì•Šë„ë¡ í•¨
            // const firstImg = visible?.[0]?.image_url || stores?.[0]?.image_url || "";
            // if (firstImg) qs("#heroImage").src = normalizeSrc(firstImg);

            // ì¹´ë“œë§Œ ë Œë”ë§
            renderStoresGrid(visible, grid);

            const totalPages = Number(json.totalPages || 1);
            st.totalPages = Number.isFinite(totalPages) && totalPages > 0 ? totalPages : 1;

            if (!st.expanded || st.totalPages <= 1) {
                pager.classList.add("hidden");
            } else {
                pager.classList.remove("hidden");
                info.textContent = `${st.page} / ${st.totalPages}`;
                prev.disabled = st.page <= 1;
                next.disabled = st.page >= st.totalPages;
            }
        }

        // âœ… Best: ì¹´í…Œê³ ë¦¬ ë¬´ì‹œ + 9ê°œ/í˜ì´ì§€
        async function renderBestSection() {
            const st = state.sectionState.best;
            const pager = qs("#bestPager");
            const prev = qs("#bestPrev");
            const next = qs("#bestNext");
            const info = qs("#bestPageInfo");

            const pageNo = st.expanded ? st.page : 1;

            try {
                const json = await fetchGrid("best_seller", pageNo, SMALL_PAGE_SIZE);
                const stores = mapItemsToStores(normalizeItems(json));

                // âœ… ìƒˆë¡œê³ ì¹¨/ì²« ì§„ì…ë§ˆë‹¤ ëœë¤
                shuffleInPlace(stores);

                const visible = st.expanded ? stores : stores.slice(0, SMALL_COLLAPSED_COUNT);

                renderSmallGrid("bestGrid", visible);

                const totalPages = Number(json.totalPages || 1);
                st.totalPages = Number.isFinite(totalPages) && totalPages > 0 ? totalPages : 1;

                if (!st.expanded || st.totalPages <= 1) pager.classList.add("hidden");
                else {
                    pager.classList.remove("hidden");
                    info.textContent = `${st.page} / ${st.totalPages}`;
                    prev.disabled = st.page <= 1;
                    next.disabled = st.page >= st.totalPages;
                }
            } catch (e) {
                const base = state.cacheAllFirstPage || [];
                const fallback = base.slice(ITEMS_COLLAPSED_COUNT, ITEMS_COLLAPSED_COUNT + 60);
                const visible = st.expanded
                    ? fallback.slice((st.page - 1) * SMALL_PAGE_SIZE, st.page * SMALL_PAGE_SIZE)
                    : fallback.slice(0, SMALL_COLLAPSED_COUNT);

                renderSmallGrid("bestGrid", visible);

                st.totalPages = Math.max(1, Math.ceil(fallback.length / SMALL_PAGE_SIZE));
                if (!st.expanded || st.totalPages <= 1) pager.classList.add("hidden");
                else {
                    pager.classList.remove("hidden");
                    info.textContent = `${st.page} / ${st.totalPages}`;
                    prev.disabled = st.page <= 1;
                    next.disabled = st.page >= st.totalPages;
                }
            }
        }

        // âœ… New: ì¹´í…Œê³ ë¦¬ ë¬´ì‹œ + 9ê°œ/í˜ì´ì§€
        async function renderNewSection() {
            const st = state.sectionState.newly;
            const pager = qs("#newPager");
            const prev = qs("#newPrev");
            const next = qs("#newNext");
            const info = qs("#newPageInfo");

            const pageNo = st.expanded ? st.page : 1;

            try {
                const json = await fetchGrid("new_registration", pageNo, SMALL_PAGE_SIZE);
                const stores = mapItemsToStores(normalizeItems(json));

                // âœ… ìƒˆë¡œê³ ì¹¨/ì²« ì§„ì…ë§ˆë‹¤ ëœë¤
                shuffleInPlace(stores);

                const visible = st.expanded ? stores : stores.slice(0, SMALL_COLLAPSED_COUNT);

                renderSmallGrid("newGrid", visible);

                const totalPages = Number(json.totalPages || 1);
                st.totalPages = Number.isFinite(totalPages) && totalPages > 0 ? totalPages : 1;

                if (!st.expanded || st.totalPages <= 1) pager.classList.add("hidden");
                else {
                    pager.classList.remove("hidden");
                    info.textContent = `${st.page} / ${st.totalPages}`;
                    prev.disabled = st.page <= 1;
                    next.disabled = st.page >= st.totalPages;
                }
            } catch (e) {
                const base = state.cacheAllFirstPage || [];
                const fallback = base.slice(ITEMS_COLLAPSED_COUNT + 60);
                const visible = st.expanded
                    ? fallback.slice((st.page - 1) * SMALL_PAGE_SIZE, st.page * SMALL_PAGE_SIZE)
                    : fallback.slice(0, SMALL_COLLAPSED_COUNT);

                renderSmallGrid("newGrid", visible);

                st.totalPages = Math.max(1, Math.ceil(fallback.length / SMALL_PAGE_SIZE));
                if (!st.expanded || st.totalPages <= 1) pager.classList.add("hidden");
                else {
                    pager.classList.remove("hidden");
                    info.textContent = `${st.page} / ${st.totalPages}`;
                    prev.disabled = st.page <= 1;
                    next.disabled = st.page >= st.totalPages;
                }
            }
        }

        async function loadAllSections(keepScroll) {
            const keepY = keepScroll ? window.scrollY : null;

            const title = state.category ? state.category : "í‘¸ë“œ";
            const subLabel = (state.category === "í•œì‹" && clean(state.subcategory)) ? ` Â· ${state.subcategory}` : "";
            setHero(`${title}${subLabel}`, "í‘¸ë“œ(store_info)ì—ì„œë§Œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.", qs("#heroImage").src);

            renderFilters();
            syncMoreButtonLabels();

            await renderItemsSection();
            await renderBestSection();
            await renderNewSection();

            if (keepY != null) {
                requestAnimationFrame(() => window.scrollTo({ top: keepY, behavior: "auto" }));
            }
        }

        function bindEvents() {
            const btnMoreItems = qs("#btnMoreItems");
            const btnMoreBest = qs("#btnMoreBest");
            const btnMoreNew = qs("#btnMoreNew");
            const bestPrev = qs("#bestPrev");
            const bestNext = qs("#bestNext");
            const newPrev = qs("#newPrev");
            const newNext = qs("#newNext");
            const itemsPrev = qs("#itemsPrev");
            const itemsNext = qs("#itemsNext");
            const btnHero = qs("#btnMoreHero"); // ì—†ì„ ìˆ˜ë„ ìˆìŒ

            if (btnMoreItems) {
                btnMoreItems.onclick = async () => {
                    const st = state.sectionState.items;
                    st.expanded = !st.expanded;
                    st.page = 1;
                    syncMoreButtonLabels();
                    await renderItemsSection();
                };
            }

            // hero ë²„íŠ¼ì€ ìˆìœ¼ë©´ë§Œ â†’ ì‚¬ì‹¤ ì§€ê¸ˆì€ ì—†ìŒ
            if (btnHero && btnMoreItems) {
                btnHero.onclick = () => btnMoreItems.click();
            }

            if (itemsPrev) {
                itemsPrev.onclick = async () => {
                    const st = state.sectionState.items;
                    st.page = Math.max(1, st.page - 1);
                    await renderItemsSection();
                };
            }
            if (itemsNext) {
                itemsNext.onclick = async () => {
                    const st = state.sectionState.items;
                    st.page = Math.min(st.totalPages || 1, st.page + 1);
                    await renderItemsSection();
                };
            }

            if (btnMoreBest) {
                btnMoreBest.onclick = async (e) => {
                    e?.preventDefault?.();
                    const st = state.sectionState.best;
                    st.expanded = !st.expanded;
                    st.page = 1;
                    syncMoreButtonLabels();
                    await renderBestSection();
                };
            }
            if (bestPrev) {
                bestPrev.onclick = async () => {
                    const st = state.sectionState.best;
                    st.page = Math.max(1, st.page - 1);
                    await renderBestSection();
                };
            }
            if (bestNext) {
                bestNext.onclick = async () => {
                    const st = state.sectionState.best;
                    st.page = Math.min(st.totalPages || 1, st.page + 1);
                    await renderBestSection();
                };
            }

            if (btnMoreNew) {
                btnMoreNew.onclick = async (e) => {
                    e?.preventDefault?.();
                    const st = state.sectionState.newly;
                    st.expanded = !st.expanded;
                    st.page = 1;
                    syncMoreButtonLabels();
                    await renderNewSection();
                };
            }
            if (newPrev) {
                newPrev.onclick = async () => {
                    const st = state.sectionState.newly;
                    st.page = Math.max(1, st.page - 1);
                    await renderNewSection();
                };
            }
            if (newNext) {
                newNext.onclick = async () => {
                    const st = state.sectionState.newly;
                    st.page = Math.min(st.totalPages || 1, st.page + 1);
                    await renderNewSection();
                };
            }
        }

        async function includeHeaderFooter() {
            fetch("/components/header.html")
                .then(r => r.text())
                .then(d => (qs("#header-placeholder").innerHTML = d))
                .catch(() => { });

            fetch("/components/footer.html")
                .then(r => r.text())
                .then(d => (qs("#footer-placeholder").innerHTML = d))
                .catch(() => { });
        }

        function readQuery() {
            const u = new URL(location.href);
            const category = clean(u.searchParams.get("category"));
            const sub = clean(u.searchParams.get("subcategory") || u.searchParams.get("sub"));
            return { category, sub };
        }

        document.addEventListener("DOMContentLoaded", async () => {
            await includeHeaderFooter();

            const { category, sub } = readQuery();
            state.category = category || "";
            state.subcategory = (state.category === "í•œì‹") ? clean(sub) : "";

            state.sectionState.items.expanded = false;
            state.sectionState.items.page = 1;
            state.sectionState.best.expanded = false;
            state.sectionState.best.page = 1;
            state.sectionState.newly.expanded = false;
            state.sectionState.newly.page = 1;

            const title = state.category ? state.category : "í‘¸ë“œ";
            const subLabel = (state.category === "í•œì‹" && clean(state.subcategory)) ? ` Â· ${state.subcategory}` : "";
            setHero(`${title}${subLabel}`, "í‘¸ë“œ(store_info)ì—ì„œë§Œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.", "/uploads/no-image.png");

            bindEvents();
            await loadAllSections(false);
        });

        function goBack() {
            if (document.referrer && document.referrer !== location.href) window.history.back();
            else window.location.href = "/category.html";
        }
        function goNext() {
            window.history.forward();
        }

        (async function () {
            const PAGE_NAME = "subcategory";

            // ? URL ì¿¼ë¦¬ì—ì„œ type=combined ì´ë©´ í†µí•©, ì•„ë‹ˆë©´ ê¸°ë³¸ food ë¡œ ì²˜ë¦¬
            const params = new URLSearchParams(window.location.search);
            const type = params.get("type");
            const mode = (type === "combined") ? "combined" : "food";

            // ? managerì—ì„œ ì‚¬ìš©í•˜ëŠ” position ê·œì¹™ê³¼ ë§ì¶”ê¸°
            function buildBannerPosition(mode) {
                const suffix = mode === "food" ? "__food" : "__combined";
                return `subcategory_top${suffix}`;
            }
            function buildBannerLegacyPosition(mode) {
                const suffix = mode === "food" ? "__food" : "__combined";
                return `subcategory_top_banner${suffix}`;
            }

            const posCandidates = [
                buildBannerPosition(mode),        // ìƒˆ í‚¤: subcategory_top__food / __combined
                buildBannerLegacyPosition(mode),  // ì˜› í‚¤: subcategory_top_banner__food / __combined
            ];

            async function tryFetchJson(url) {
                const res = await fetch(url);
                let data = null;
                try {
                    data = await res.json();
                } catch (e) {
                    // JSON íŒŒì‹± ì‹¤íŒ¨ â†’ ê·¸ëƒ¥ null
                }
                if (!res.ok) {
                    const msg = (data && (data.error || data.message)) || `HTTP ${res.status}`;
                    throw new Error(msg);
                }
                return data;
            }

            // ? ì‹¤ì œ ì‚´ì•„ ìˆëŠ” API base ìë™ íƒìƒ‰
            const API_BASE_CANDIDATES = [
                "/subcategorymanager/ad",
                "/subcategorymanager_food/ad",
                "/admin/subcategory"
            ];
            let API_BASE = API_BASE_CANDIDATES[0];

            async function detectApiBaseForFront() {
                const testQs = new URLSearchParams({
                    page: PAGE_NAME,
                    position: posCandidates[0],
                    priority: "1",
                }).toString();

                for (const base of API_BASE_CANDIDATES) {
                    try {
                        const res = await fetch(`${base}/slot?${testQs}`, { method: "GET" });
                        if (res.status !== 404) {
                            API_BASE = base;
                            return;
                        }
                    } catch (e) {
                        // ì‹¤íŒ¨ â†’ ë‹¤ìŒ í›„ë³´
                    }
                }
                // ì „ë¶€ ì‹¤íŒ¨í•˜ë©´ ê¸°ë³¸ê°’ ê·¸ëŒ€ë¡œ (ê·¸ëƒ¥ ì¡°ìš©íˆ íŒ¨ìŠ¤)
            }

            try {
                // 1) ì–´ë–¤ ë¼ìš°í„°ê°€ ì‚´ì•„ ìˆëŠ”ì§€ ë¨¼ì € í™•ì¸
                await detectApiBaseForFront();

                // 2) ìƒˆ í‚¤ â†’ ì—†ë‹¤ë©´ ì˜› í‚¤ ìˆœì„œë¡œ slot ì¡°íšŒ
                let foundSlot = null;
                for (const pos of posCandidates) {
                    const qs = new URLSearchParams({
                        page: PAGE_NAME,
                        position: pos,
                        priority: "1",
                    }).toString();

                    try {
                        const data = await tryFetchJson(`${API_BASE}/slot?${qs}`);
                        if (data && data.slot) {
                            foundSlot = data.slot;
                            break;
                        }
                    } catch (e) {
                        // ì´ í‚¤ì—ì„œëŠ” slot ì—†ìŒ â†’ ë‹¤ìŒ í‚¤ ì‹œë„
                    }
                }

                if (!foundSlot) {
                    // ì €ì¥ëœ ë°°ë„ˆê°€ ì—†ìœ¼ë©´ ê·¸ëƒ¥ ê¸°ë³¸ ì´ë¯¸ì§€/ì œëª© ìœ ì§€
                    return;
                }

                const imgEl = document.getElementById("heroImage");
                const linkEl = document.getElementById("heroLink");
                const titleEl = document.getElementById("heroTitle");

                // image_url ì´ ìˆìœ¼ë©´ ë°°ë„ˆ ì´ë¯¸ì§€ êµì²´
                if (imgEl && foundSlot.image_url) {
                    imgEl.src = foundSlot.image_url;
                }

                // text_title ì´ ìˆìœ¼ë©´ ì˜¤ë¥¸ìª½ ì œëª©ë„ ë°”ê¿”ì¤Œ
                if (titleEl && foundSlot.text_title) {
                    titleEl.textContent = foundSlot.text_title;
                }

                // link_url ì´ ìˆìœ¼ë©´ í´ë¦­ ì‹œ ì´ë™
                if (linkEl && foundSlot.link_url) {
                    linkEl.href = foundSlot.link_url;
                } else if (linkEl) {
                    // ë§í¬ ì—†ìœ¼ë©´ í´ë¦­ ë§‰ê¸° (href ì œê±°)
                    linkEl.removeAttribute("href");
                }

            } catch (e) {
                // ì—ëŸ¬ ë‚˜ë„ í˜ì´ì§€ ì „ì²´ ì£½ì„ í•„ìš”ëŠ” ì—†ìŒ â†’ ì½˜ì†”ë§Œ
                console.error("[subcategory banner hydrate] ì‹¤íŒ¨:", e.message || e);
            }
        })();
    </script>
</body>

</html>