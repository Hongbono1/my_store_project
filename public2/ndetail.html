<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>í†µí•© ì •ë³´ ìƒì„¸</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- ì¹´ì¹´ì˜¤ ì•±í‚¤ë¥¼ ì—¬ê¸°ì— ë„£ìœ¼ì„¸ìš” -->
    <meta name="kakao-appkey" content="6286d4d9bc1d503495b03f46622b5dc8">
    <script id="kakao-sdk"
        src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=6286d4d9bc1d503495b03f46622b5dc8&autoload=false&libraries=services"
        defer></script>
</head>

<body class="bg-gradient-to-br from-blue-50 via-white to-blue-100 min-h-screen">
    <main class="flex flex-col lg:flex-row gap-8 max-w-7xl mx-auto p-4">
        <!-- 1. ì™¼ìª½: ì´ë¯¸ì§€/ì§€ë„/ê´‘ê³  -->
        <section id="leftCol" class="flex-1 flex flex-col gap-6">
            <div class="rounded-3xl bg-white shadow-xl p-6 flex flex-col items-center">
                <div class="w-full relative">
                    <div id="sliderWrapper" class="relative w-full h-80 rounded-2xl overflow-hidden shadow">
                        <div id="sliderImages" class="flex transition-transform duration-500 ease-in-out h-full"></div>
                        <button id="prevBtn"
                            class="absolute left-2 top-1/2 -translate-y-1/2 bg-black/70 text-white rounded-full px-3 py-1 opacity-80 hover:opacity-100 z-10">â€¹</button>
                        <button id="nextBtn"
                            class="absolute right-2 top-1/2 -translate-y-1/2 bg-black/70 text-white rounded-full px-3 py-1 opacity-80 hover:opacity-100 z-10">â€º</button>
                    </div>
                    <div id="thumbBox" class="flex gap-2 justify-center mt-3"></div>
                </div>
                <div class="text-center font-bold mt-2">ëŒ€í‘œ ì´ë¯¸ì§€</div>
            </div>

            <div class="rounded-3xl bg-white shadow-xl p-6">
                <div class="text-lg font-bold mb-2">ìœ„ì¹˜/ì§€ë„</div>
                <div id="addressText" class="mb-2 text-base"></div>
                <div id="map" class="w-full h-48 bg-gray-100 rounded-xl"></div>
            </div>

            <div class="flex flex-col gap-4">
                <div class="rounded-3xl bg-white shadow-xl p-3">
                    <img src="/images/ad-1.jpg" alt="ê´‘ê³ 1" class="rounded-xl w-full h-28 object-cover" />
                </div>
                <div class="rounded-3xl bg-white shadow-xl p-3">
                    <img src="/images/ad-2.jpg" alt="ê´‘ê³ 2" class="rounded-xl w-full h-28 object-cover" />
                </div>
            </div>
        </section>

        <!-- 2. ê°€ìš´ë°: ëª¨ë“  ê°€ê²Œ ìƒì„¸ì •ë³´ (ëª¨ë“  í•„ë“œ ì¶œë ¥) -->
        <section id="middleCol" class="flex-[1.1] flex flex-col gap-6">
            <div class="rounded-3xl bg-white shadow-xl p-6">
                <h2 id="businessNameHeader" class="text-3xl font-bold text-center mb-2"></h2>
                <div class="flex justify-center mt-2">
                    <button id="reserveBtn"
                        class="bg-blue-500 text-white px-5 py-2 rounded-lg shadow hover:bg-blue-700 transition">ì˜ˆì•½
                        ì‹ ì²­</button>
                </div>
                <div class="flex flex-col gap-1 text-center text-base font-semibold">
                    <div id="businessType"></div>
                    <div id="businessCategory"></div>
                    <div id="deliveryOption"></div>
                    <div id="businessHours"></div>
                </div>
            </div>

            <div class="rounded-2xl bg-blue-50 shadow p-6 grow-card h-full flex flex-col">
                <div class="font-semibold mb-1">ì„œë¹„ìŠ¤ ë‚´ìš©</div>
                <div id="serviceDetails" class="scroll-area flex-1"></div>
            </div>

            <div class="rounded-2xl bg-yellow-50 shadow p-6">
                <div class="font-semibold mb-1">ì´ë²¤íŠ¸</div>
                <ul id="eventsList" class="list-disc ml-5"></ul>
            </div>

            <div class="rounded-2xl bg-gray-50 shadow p-6">
                <div class="font-semibold mb-1">ê¸°íƒ€ ì •ë³´</div>
                <ul id="infoEtcList" class="list-disc pl-5"></ul>
            </div>

            <div class="rounded-2xl bg-blue-50 shadow p-6 grow-card h-full flex flex-col">
                <div class="font-semibold mb-1">ì¶”ê°€ ì„¤ëª…</div>
                <div id="additionalDesc" class="scroll-area flex-1"></div>
            </div>

            <div class="rounded-2xl bg-gray-50 shadow p-6">
                <div class="font-semibold mb-1">ì—°ë½ì²˜</div>
                <div id="contactPhone"></div>
                <div id="contactHomepage"></div>
                <div id="contactInstagram"></div>
                <div id="contactFacebook"></div>
            </div>
        </section>

        <!-- 3. ì˜¤ë¥¸ìª½: ë©”ë‰´/ì¥ë°”êµ¬ë‹ˆ -->
        <section id="rightCol" class="flex-1 flex flex-col gap-6">
            <div class="rounded-3xl bg-white shadow-xl p-6">
                <div class="text-xl font-bold mb-4 text-center">ë©”ë‰´</div>
                <div id="menuList" class="flex flex-col gap-3"></div>
            </div>
            <div class="rounded-2xl bg-yellow-50 shadow p-6">
                <div class="font-bold mb-2">ì¥ë°”êµ¬ë‹ˆ</div>
                <ul id="cartItems" class="space-y-2 text-base"></ul>
                <div class="flex justify-between items-center mt-4">
                    <span class="font-bold text-gray-800">í•©ê³„:</span>
                    <span id="cartTotal" class="text-2xl font-bold text-blue-700">0ì›</span>
                </div>
                <button class="mt-3 w-full bg-blue-600 text-white py-2 rounded-lg shadow">ê²°ì œí•˜ê¸°</button>
            </div>
        </section>
    </main>

    <!-- ì´ë¯¸ì§€ ëª¨ë‹¬ -->
    <div id="imageModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="relative">
            <img id="modalImage" class="w-[600px] h-[400px] object-contain rounded shadow-xl" />
            <button id="closeModal"
                class="absolute -top-4 -right-4 bg-white text-black rounded-full text-3xl w-10 h-10 flex items-center justify-center z-60 hover:bg-gray-200">Ã—</button>
        </div>
    </div>

    <script type="module">
        // grow-card ë‘ ë°•ìŠ¤ì˜ ìµœì†Œ/ìµœëŒ€ ë†’ì´ (ë‚´ìš© ê°€ë…ì„± ë³´ì¥ìš©)
        const MIN_GROW_PX = 160;
        const MAX_GROW_PX = 520;  // í•„ìš”í•˜ë©´ ìˆ«ìë§Œ ì¡°ì •

        let layoutFrozen = false;
        let rafA = 0, rafB = 0;

        // DOM ì—…ë°ì´íŠ¸ê°€ ë‹¤ ëë‚œ ë‹¤ìŒ í”„ë ˆì„ì—ì„œ ë ˆì´ì•„ì›ƒ ê³„ì‚°
        function scheduleLayout(force = false) {
            if (layoutFrozen && !force) return;
            cancelAnimationFrame(rafA); cancelAnimationFrame(rafB);
            rafA = requestAnimationFrame(() => {
                rafB = requestAnimationFrame(() => {
                    syncLockToLeft();
                });
            });
        }

        // ë” ì´ìƒ ìë™ í”ë“¤ë¦¼ì´ ì—†ë„ë¡ ì ê¸ˆ
        function freezeLayout() {
            layoutFrozen = true;
        }

        // ========== ìœ í‹¸ ==========
        const $ = id => document.getElementById(id);

        function normalizeSrc(src) {
            if (!src) return "";
            if (src.startsWith("http") || src.startsWith("/")) return src;
            return `/uploads/${src}`;
        }

        function escapeHtml(s = "") {
            return s.replace(/[&<>"']/g, m => ({
                "&": "&amp;",
                "<": "&lt;",
                ">": "&gt;",
                '"': "&quot;",
                "'": "&#39;",
            }[m]));
        }
        const nl2br = (s = "") => escapeHtml(String(s)).replace(/\r?\n/g, "<br>");

        // ì•ˆì „í•œ storeId ì¶”ì¶œ
        const q = new URLSearchParams(location.search);
        const storeId = Number(q.get("id"));
        if (!Number.isSafeInteger(storeId)) {
            alert("ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤. (id í•„ìš”)");
            // í•„ìš”ì‹œ ë©”ì¸ìœ¼ë¡œ ì´ë™
            // location.replace('/');
        }

        // ========== ì´ë¯¸ì§€ ëª¨ë‹¬ ==========
        function openModal(src) { $("modalImage").src = src; $("imageModal").classList.remove("hidden"); }
        function closeModal() { $("imageModal").classList.add("hidden"); }
        (function enableModalKeys() {
            const modal = $("imageModal");
            modal.addEventListener("click", (e) => { if (e.target === modal) closeModal(); });
            window.addEventListener("keydown", (e) => {
                if (modal.classList.contains("hidden")) return;
                if (e.key === "Escape") closeModal();
                if (e.key === "ArrowLeft") { slider.move(-1); $("modalImage").src = slider.imgs[slider.idx]; }
                if (e.key === "ArrowRight") { slider.move(1); $("modalImage").src = slider.imgs[slider.idx]; }
            });
            $("closeModal").addEventListener('click', closeModal);
        })();

        // ========== ìŠ¬ë¼ì´ë” ==========
        const slider = {
            imgs: [],
            idx: 0,
            init(arr) {
                this.imgs = (arr || [])
                    .filter(s => typeof s === "string" && s.trim() !== "")
                    .map(s => normalizeSrc(s.trim()));

                // ê° ìŠ¬ë¼ì´ë“œê°€ ê°€ë¡œ 100% í­ì„ ê°–ë„ë¡ min-w-full ë˜í¼ ì‚¬ìš©
                $("sliderImages").innerHTML = this.imgs.map((u, i) => {
                    const n = normalizeSrc(u);
                    return `
            <div class="min-w-full h-full">
              <img src="${n}" data-index="${i}" class="w-full h-full object-cover cursor-pointer select-none" />
            </div>`;
                }).join('');

                $("sliderImages").onclick = (e) => {
                    const img = e.target.closest("img[data-index]");
                    if (img) {
                        this.idx = Number(img.dataset.index);
                        this.update();
                        openModal(this.imgs[this.idx]);
                    }
                };

                this.renderThumbs();
                this.update();

                $("prevBtn").onclick = () => this.move(-1);
                $("nextBtn").onclick = () => this.move(1);

                const firstImg = $("sliderImages").querySelector('img');
                if (firstImg) {
                    firstImg.onload = () => scheduleLayout();
                    if (firstImg.complete) scheduleLayout();
                } else {
                    scheduleLayout();
                }
            },
            renderThumbs() {
                const box = $("thumbBox");
                box.innerHTML = "";
                this.imgs.forEach((src, i) => {
                    const t = document.createElement("img");
                    t.src = src;
                    t.alt = `ì´ë¯¸ì§€ ${i + 1}`;
                    t.className = "w-14 h-14 object-cover rounded cursor-pointer border hover:opacity-80";
                    t.addEventListener("click", () => {
                        this.idx = i; this.update(); openModal(src);
                    });
                    box.appendChild(t);
                });
            },
            move(step) {
                if (!this.imgs.length) return;
                this.idx = (this.idx + step + this.imgs.length) % this.imgs.length;
                this.update();
            },
            update() {
                const hasImg = this.imgs.length > 0;
                $("sliderImages").style.transform = `translateX(${-this.idx * 100}%)`;
                [...$("thumbBox").children].forEach((el, i) => {
                    el.classList.toggle("ring-2", i === this.idx);
                    el.classList.toggle("ring-blue-300", i === this.idx);
                });
                $("prevBtn").classList.toggle("hidden", !hasImg);
                $("nextBtn").classList.toggle("hidden", !hasImg);
                $("thumbBox").classList.toggle("hidden", !hasImg);
            }
        };

        function _getGapPx(sec) {
            const cs = getComputedStyle(sec);
            const g = parseFloat(cs.rowGap || cs.gap || '0');
            return isNaN(g) ? 0 : g;
        }
        function _sumHeights(els) {
            return els.reduce((sum, el) => sum + el.getBoundingClientRect().height, 0);
        }

        /**
         * ì¢Œì¸¡(#leftCol) ë†’ì´ë¥¼ ê¸°ì¤€ìœ¼ë¡œ:
         * - ìš°ì¸¡(#rightCol) = ê°™ì€ ë†’ì´ ê³ ì • + ë‚´ë¶€ ìŠ¤í¬ë¡¤
         * - ê°€ìš´ë°ì˜ .grow-card 2ê°œê°€ ë‚¨ëŠ” ë†’ì´ë¥¼ 1:1ë¡œ "ê³ ì • ë†’ì´" ë°°ë¶„
         *   ë‚´ìš©ì´ ë§ìœ¼ë©´ ê° ì¹´ë“œ ë‚´ë¶€(.scroll-area)ì—ì„œë§Œ ìŠ¤í¬ë¡¤
         */
        function syncLockToLeft() {
            const left = document.getElementById('leftCol');
            const mid = document.getElementById('middleCol');
            const right = document.getElementById('rightCol');
            if (!left || !mid) return;

            const isDesktop = window.matchMedia('(min-width: 1024px)').matches; // lg ì´ìƒ
            const leftH = left.getBoundingClientRect().height;                  // ê¸°ì¤€(ê²€ì •ì„ ) ë†’ì´

            // ìš°ì¸¡: ì¢Œì¸¡ê³¼ ë™ì¼ ë†’ì´ + ë‚´ë¶€ ìŠ¤í¬ë¡¤ (í•­ìƒ ë³´ì´ê²Œ)
            if (right) {
                right.style.height = isDesktop ? `${leftH}px` : '';
                right.style.maxHeight = isDesktop ? `${leftH}px` : '';
                right.style.overflow = isDesktop ? 'auto' : '';
            }

            // ê°€ìš´ë°: grow-card(ì„œë¹„ìŠ¤/ì¶”ê°€ ì„¤ëª…) ë‘ ê°œì— ë‚¨ì€ ë†’ì´ë¥¼ "ë™ì¼í•˜ê²Œ" ë°°ë¶„
            const kids = Array.from(mid.children);
            const cs = getComputedStyle(mid);
            const gapPx = parseFloat(cs.rowGap || cs.gap || '0') || 0;
            const gaps = Math.max(0, kids.length - 1);

            const growTargets = kids.filter(el => el.classList.contains('grow-card'));
            const staticEls = kids.filter(el => !el.classList.contains('grow-card'));

            // ë¦¬ì…‹
            growTargets.forEach(el => { el.style.height = ''; el.style.maxHeight = ''; });

            if (!isDesktop || growTargets.length === 0) {
                // ëª¨ë°”ì¼/ì¢ì€ í™”ë©´: ìë™ ë†’ì´ë¡œ í’€ì–´ ë¹ˆê³µê°„/ì˜ë¦¼ ë°©ì§€
                growTargets.forEach(el => {
                    const sc = el.querySelector('.scroll-area');
                    if (sc) { sc.style.maxHeight = ''; sc.style.overflow = ''; }
                });
                return;
            }

            // ê°€ìš´ë° ì»¬ëŸ¼ì—ì„œ grow-card ì™¸ ìš”ì†Œ(=í—¤ë”/ì´ë²¤íŠ¸/ê¸°íƒ€/ì—°ë½ì²˜ ë“±) ì´ ë†’ì´ + ê°­
            const usedStatic = staticEls.reduce((sum, el) => sum + el.getBoundingClientRect().height, 0);
            const used = usedStatic + gaps * gapPx;

            // ì¢Œì¸¡(=ê¸°ì¤€ì„ ) ë†’ì´ì— ë§ì¶”ê¸° ìœ„í•´ grow-cardë“¤ì´ ì±„ì›Œì•¼ í•  ë‚¨ì€ ë†’ì´
            let remain = leftH - used;
            if (remain < 0) remain = 0;

            // ë‘ ë°•ìŠ¤ë¥¼ ë™ì¼í•˜ê²Œ ì¤„ì—¬ ë°°ë¶„ (ìµœì†Œ/ìµœëŒ€ ë†’ì´ë¡œ í´ë¨í”„)
            let share = growTargets.length ? Math.floor(remain / growTargets.length) : 0;
            share = Math.max(MIN_GROW_PX, Math.min(MAX_GROW_PX, share));

            // ì ìš© + ë‚´ë¶€ ìŠ¤í¬ë¡¤
            growTargets.forEach(el => {
                el.style.height = `${share}px`;
                el.style.maxHeight = `${share}px`;
                const sc = el.querySelector('.scroll-area');
                if (sc) { sc.style.maxHeight = '100%'; sc.style.overflow = 'auto'; }
            });
        }


        // ê¸°ì¡´ syncToAdEnd êµì²´
        function syncToAdEnd() {
            // ì´ë¯¸ì§€/ì§€ë„/ë°ì´í„° ë°˜ì˜ í›„ ë ˆì´ì•„ì›ƒ ì ê¸ˆ
            syncLockToLeft();
        }

        // ========== ì¥ë°”êµ¬ë‹ˆ ==========
        const cart = [];
        function addToCart(item) {
            const found = cart.find(c => c.name === item.name);
            if (found) found.quantity += item.quantity; else cart.push({ ...item });
            renderCart();
        }
        function renderCart() {
            const ul = $("cartItems"); if (!ul) return;
            ul.innerHTML = "";
            let sum = 0;
            cart.forEach((item, index) => {
                const price = Number(item.price) || 0;
                const qty = Number(item.quantity) || 1;
                const total = price * qty; sum += total;
                const li = document.createElement("li");
                li.className = "flex justify-between items-center text-lg py-2";
                li.innerHTML = `
          <span>${item.name} Ã— ${qty}</span>
          <span class="text-xl font-bold">${total.toLocaleString()}ì›</span>
          <button class="removeBtn bg-red-100 text-red-600 px-2 py-1 rounded text-sm ml-2" data-index="${index}">ì‚­ì œ</button>`;
                ul.appendChild(li);
            });
            ul.querySelectorAll(".removeBtn").forEach(btn => {
                btn.onclick = () => { cart.splice(btn.dataset.index, 1); renderCart(); };
            });
            $("cartTotal").textContent = sum.toLocaleString() + "ì›";
        }

        // ========== Kakao ì§€ë„ ==========

        // ì§€ë„ ì•¡ì…˜ ë²„íŠ¼(ì¹´ì¹´ì˜¤ë§µ ì—´ê¸° / ê¸¸ì°¾ê¸°)
        function renderMapActions(lat, lng, name, address) {
            const parent = $("map").parentElement;
            let box = document.getElementById("mapActions");
            if (!box) {
                box = document.createElement("div");
                box.id = "mapActions";
                box.className = "mt-3 flex gap-2";
                parent.appendChild(box);
            } else {
                box.innerHTML = "";
            }

            const place = name || "ëª©ì ì§€";

            const openBtn = document.createElement("button");
            openBtn.className = "px-3 py-1 rounded bg-blue-600 text-white text-sm";
            openBtn.textContent = "ì¹´ì¹´ì˜¤ë§µ ì—´ê¸°";
            openBtn.onclick = () => {
                const url = (lat && lng)
                    ? `https://map.kakao.com/link/map/${encodeURIComponent(place)},${lat},${lng}`
                    : `https://map.kakao.com/link/search/${encodeURIComponent(address || place)}`;
                window.open(url, "_blank", "noopener");
            };

            const dirBtn = document.createElement("button");
            dirBtn.className = "px-3 py-1 rounded bg-emerald-600 text-white text-sm";
            dirBtn.textContent = "ê¸¸ì°¾ê¸°";
            dirBtn.onclick = () => {
                const url = (lat && lng)
                    ? `https://map.kakao.com/link/to/${encodeURIComponent(place)},${lat},${lng}`
                    : `https://map.kakao.com/link/search/${encodeURIComponent(address || place)}`;
                window.open(url, "_blank", "noopener");
            };

            box.append(openBtn, dirBtn);
        }

        // â˜… ì´ initMap í•˜ë‚˜ë§Œ ë‚¨ê¸°ì„¸ìš” (ì¤‘ë³µ ì„ ì–¸ ê¸ˆì§€)
        async function initMap(address, name = "") {
            if (!address) {
                $("addressText").textContent = "ğŸ“ -";
                $("map").innerHTML = "";
                renderMapActions(null, null, name, address);
                return;
            }
            $("addressText").textContent = `ğŸ“ ${address}`;

            // SDK ì¤€ë¹„ (ì •ì  íƒœê·¸ + autoload=false)
            if (!window.kakao || !window.kakao.maps) {
                console.error("Kakao SDK tag missing");
                renderMapActions(null, null, name, address);
                return;
            }
            await new Promise((resolve) => kakao.maps.load(resolve));

            const geocoder = new kakao.maps.services.Geocoder();
            const cleaned = address.replace(/^\d{5}\s*/, "").trim();

            geocoder.addressSearch(cleaned, (result, status) => {
                // ì§€ì˜¤ì½”ë”© ì‹¤íŒ¨ ì‹œ: ê²€ìƒ‰ ë§í¬ë¡œ ëŒ€ì²´
                if (status !== kakao.maps.services.Status.OK || !result?.length) {
                    const searchUrl = `https://map.kakao.com/link/search/${encodeURIComponent(address)}`;
                    $("map").style.cursor = "pointer";
                    $("map").title = "ì¹´ì¹´ì˜¤ë§µì—ì„œ ì—´ê¸°";
                    $("map").onclick = () => window.open(searchUrl, "_blank", "noopener");
                    renderMapActions(null, null, name, address);
                    return;
                }

                const lat = Number(result[0].y);
                const lng = Number(result[0].x);
                const coords = new kakao.maps.LatLng(lat, lng);
                const map = new kakao.maps.Map($("map"), { center: coords, level: 3 });
                const marker = new kakao.maps.Marker({ map, position: coords });

                // ì§€ë„/ë§ˆì»¤ í´ë¦­ ì‹œ ì¹´ì¹´ì˜¤ë§µ ì—´ê¸°
                const place = name || "ëª©ì ì§€";
                const openKakaoMap = () => {
                    const url = `https://map.kakao.com/link/map/${encodeURIComponent(place)},${lat},${lng}`;
                    window.open(url, "_blank", "noopener");
                };
                $("map").style.cursor = "pointer";
                $("map").title = "ì¹´ì¹´ì˜¤ë§µì—ì„œ ì—´ê¸°";
                $("map").onclick = openKakaoMap;
                kakao.maps.event.addListener(map, "click", openKakaoMap);
                kakao.maps.event.addListener(marker, "click", openKakaoMap);

                renderMapActions(lat, lng, place, address);
            });
        }

        // ========== ìƒì„¸ ë°ì´í„° ë¡œë”© ==========
        (async () => {
            try {
                const res = await fetch(`/foodregister/${encodeURIComponent(storeId)}/full`);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const json = await res.json();

                const store = json.store || {};
                const images = json.images?.map(i => i.url || i.image_url || "") || [];
                const menus = json.menus || [];

                // 1) ìŠ¬ë¼ì´ë”
                slider.init(images);

                // 2) ì¤‘ì•™ í•„ë“œ
                $("businessNameHeader").textContent = store.business_name || store.name || "ìƒí˜¸ëª… ì—†ìŒ";
                $("businessType").textContent = "ì—…ì¢…: " + (store.business_type ?? "-");
                $("businessCategory").textContent = "ì¹´í…Œê³ ë¦¬: " + (store.business_category ?? store.category ?? "-");
                $("deliveryOption").textContent = "ë°°ë‹¬: " + (store.delivery_option ?? "-");
                $("businessHours").textContent = "ì˜ì—…ì‹œê°„: " + (store.business_hours ?? "-");

                // ì„œë¹„ìŠ¤/ì´ë²¤íŠ¸
                $("serviceDetails").innerHTML = store.service_details ? nl2br(store.service_details) : "-";
                $("additionalDesc").innerHTML = store.additional_desc ? nl2br(store.additional_desc) : "-";

                const events = (json.events || []).map(escapeHtml);
                $("eventsList").innerHTML = events.length
                    ? events.map(e => `<li>${e}</li>`).join("")
                    : `<li>-</li>`;

                // ê¸°íƒ€ ì •ë³´
                $("infoEtcList").innerHTML = `
  <li>ì¥ì• ì¸ í¸ì˜ì‹œì„¤: ${escapeHtml(store.facilities ?? "-")}</li>
  <li>ë°˜ë ¤ë™ë¬¼ ì¶œì…: ${store.pets_allowed === true ? "ê°€ëŠ¥" : store.pets_allowed === false ? "ë¶ˆê°€" : "-"}</li>
  <li>ì£¼ì°¨ ì •ë³´: ${escapeHtml(store.parking ?? "-")}</li>
`;

                // ì—°ë½ì²˜(í´ë¦­ ê°€ëŠ¥ ë§í¬)
                const phoneNum = store.phone || "";
                $("contactPhone").innerHTML = phoneNum
                    ? `<a href="tel:${phoneNum.replace(/[^0-9]/g, "")}" class="text-blue-600 underline text-lg">${escapeHtml(phoneNum)}</a>`
                    : "-";

                function linkOrDash(url, label) {
                    if (!url) return "-";
                    const u = /^https?:\/\//i.test(url) ? url : ("http://" + url);
                    return `<a href="${u}" target="_blank" rel="noopener" class="text-blue-600 underline">${escapeHtml(label || url)}</a>`;
                }
                $("contactHomepage").innerHTML = linkOrDash(store.homepage, "í™ˆí˜ì´ì§€ ì—´ê¸°");
                $("contactInstagram").innerHTML = linkOrDash(store.instagram, "ì¸ìŠ¤íƒ€ê·¸ë¨");
                $("contactFacebook").innerHTML = linkOrDash(store.facebook, "í˜ì´ìŠ¤ë¶");


                // 3) ì§€ë„
                await initMap(store.address || "", store.business_name || store.name || "");

                // 4) ë©”ë‰´
                const section = $("rightCol");
                section.style.display = ""; // í•­ìƒ ë³´ì´ê²Œ

                const menuList = $("menuList");
                menuList.innerHTML = "";

                if (!menus.length) {
                    menuList.innerHTML = `<div class="text-center text-gray-500 py-4">ë©”ë‰´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
                } else {
                    const menuByCategory = {};
                    menus.forEach(it => {
                        const cat = (it.category || "").toString().trim() || "ê¸°íƒ€";
                        (menuByCategory[cat] ||= []).push(it);
                    });
                    Object.entries(menuByCategory).forEach(([cat, items]) => {
                        const group = document.createElement("div");
                        const title = document.createElement("h3");
                        title.textContent = "ğŸ± " + cat;
                        title.className = "text-xl font-bold mt-6 mb-2 text-gray-800";
                        group.appendChild(title);

                        items.forEach(it => {
                            const box = document.createElement("div");
                            box.className = "flex items-center gap-4 p-4 bg-white rounded-lg shadow-sm border";
                            const imgSrc = normalizeSrc(it.image_url || it.imageUrl || "");
                            box.innerHTML = `
                <img src="${imgSrc}" class="w-24 h-24 object-cover rounded-md" />
                <div class="flex-1">
                  <div class="text-lg font-bold mb-1 truncate">${it.name}</div>
                  <div class="text-base font-medium text-gray-700">${Number(it.price).toLocaleString()}ì›</div>
                </div>
                <div class="flex flex-col items-center gap-1 shrink-0">
                  <div class="flex items-center gap-1">
                    <button class="decrease px-2 py-1 bg-gray-200 rounded">ï¼</button>
                    <span class="quantity w-6 text-center">1</span>
                    <button class="increase px-2 py-1 bg-gray-200 rounded">ï¼‹</button>
                  </div>
                  <button class="addBtn px-3 py-1 bg-blue-600 text-white text-sm rounded">ë‹´ê¸°</button>
                </div>`;
                            let qty = 1;
                            const qtySpan = box.querySelector(".quantity");
                            box.querySelector(".decrease").onclick = () => { if (qty > 1) qtySpan.textContent = --qty; };
                            box.querySelector(".increase").onclick = () => { qtySpan.textContent = ++qty; };
                            box.querySelector(".addBtn").onclick = () =>
                                addToCart({ name: it.name, price: it.price, quantity: qty });
                            group.appendChild(box);
                        });

                        menuList.appendChild(group);
                    });
                }

                // ì˜ˆì•½ ë²„íŠ¼
                const reserveBtn = $("reserveBtn");
                if (reserveBtn) reserveBtn.onclick = () => alert("ì˜ˆì•½ ì‹ ì²­ ê¸°ëŠ¥ì€ ê³§ ì œê³µë©ë‹ˆë‹¤! (ì—¬ê¸°ì— í¼/ëª¨ë‹¬ ì—°ê²°)");

                scheduleLayout(true);  // ìµœì¢… ì •ë ¬ 1íšŒ
                freezeLayout();        // ì´í›„ ë®ì–´ì“°ê¸° ë°©ì§€

                syncToAdEnd();
            } catch (err) {
                console.error("ìƒì„¸ ë¡œë”© ì‹¤íŒ¨:", err);
                $("businessNameHeader").textContent = "ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.";
                syncToAdEnd();
            }
        })();

        // í•„ìš”ì‹œ ë ˆì´ì•„ì›ƒ ë™ê¸°í™” í›…
        window.addEventListener("DOMContentLoaded", () => scheduleLayout());
        window.addEventListener("resize", () => {
            layoutFrozen = false;   // ì°½ í¬ê¸° ë°”ë€Œë©´ ë‹¤ì‹œ ê³„ì‚° í—ˆìš©
            scheduleLayout(true);
        });
    </script>
</body>

</html>