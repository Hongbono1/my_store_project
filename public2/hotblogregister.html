<!-- public2/hotblog.html -->
<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>홍보 블로그 작성</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .hidden {
            display: none
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-800">
    <div class="max-w-2xl mx-auto bg-white rounded-2xl shadow-xl border mt-10 mb-20 p-8">
        <h1 class="text-3xl font-bold text-center mb-8 text-blue-700">✍️ 홍보 블로그 작성</h1>

        <!-- ✨ 폼은 이 한 개만 존재해야 합니다 -->
        <form id="blogForm" enctype="multipart/form-data" class="space-y-6 bg-white p-6 rounded shadow">

            <!-- 작성 방식 (폼 안) -->
            <div class="mb-6 space-x-4 flex justify-center">
                <label><input type="radio" name="qa_mode" value="theme" checked> 오늘의 테마 추천</label>
                <label><input type="radio" name="qa_mode" value="random"> 오늘의 랜덤 추천</label>
                <label><input type="radio" name="qa_mode" value="self"> 내가 묻고 내가 답하는 방식</label>
            </div>

            <!-- self 서브 옵션 (폼 안) -->
            <div id="selfSubOptions" class="hidden mb-6">
                <div class="border rounded-lg p-4 bg-gray-50 shadow text-center">
                    <p class="font-bold mb-3 text-lg">📌 어디에 올리실건가요?</p>
                    <div class="flex justify-center space-x-6">
                        <label class="flex items-center space-x-2">
                            <input type="radio" name="selfTarget" value="theme" checked>
                            <span>오늘의 테마 추천</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="radio" name="selfTarget" value="random">
                            <span>오늘의 랜덤 추천</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- 제목 -->
            <div>
                <label class="block mb-2 font-semibold">제목</label>
                <input type="text" name="title" class="w-full border rounded p-2" required>
            </div>

            <!-- 대표 이미지 -->
            <div>
                <label class="block mb-2 font-semibold">대표 이미지 (1장)</label>
                <input type="file" name="coverImage" accept="image/*" class="w-full border rounded p-2">
                <p class="text-xs text-gray-500 mt-1">한 장만 등록 가능합니다.</p>
            </div>

            <!-- 가게명/업종/전화/URL -->
            <div>
                <label class="block mb-2 font-semibold">가게명</label>
                <input type="text" name="store_name" class="w-full border rounded p-2" required>
            </div>
            <div>
                <label class="block mb-2 font-semibold">업종</label>
                <input type="text" name="category" class="w-full border rounded p-2" required>
            </div>
            <div>
                <label class="block mb-2 font-semibold">전화번호</label>
                <input type="text" name="phone" class="w-full border rounded p-2">
            </div>
            <div>
                <label class="block mb-2 font-semibold">홈페이지 URL</label>
                <input type="url" name="url" class="w-full border rounded p-2">
            </div>

            <!-- 질문/답변 영역 -->
            <div id="qaSection" class="space-y-4"></div>

            <!-- 저장 버튼 -->
            <div class="flex justify-center mb-6">
                <button type="submit" class="bg-blue-600 text-white px-8 py-2 rounded-lg shadow hover:bg-blue-700">
                    저장하기
                </button>
            </div>
        </form>

        <!-- ✅ 우측 하단 고정 네비게이션 버튼 -->
        <div class="fixed bottom-6 right-6 flex flex-col items-center space-y-3 z-50">

            <!-- 이전 -->
            <button onclick="history.back()"
                class="w-12 h-12 rounded-full bg-gradient-to-br from-gray-200 to-gray-400 shadow-lg flex items-center justify-center hover:scale-105 transition">
                ←
            </button>

            <!-- 다음 -->
            <button onclick="history.forward()"
                class="w-12 h-12 rounded-full bg-gradient-to-br from-green-400 to-blue-500 text-white shadow-lg flex items-center justify-center hover:scale-105 transition">
                →
            </button>

            <!-- 홈 -->
            <a href="/index.html"
                class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-500 to-purple-500 text-white shadow-lg flex items-center justify-center hover:scale-105 transition">
                🏠
            </a>

        </div>


        <script>
            const themeQuestions = [
                "오늘의 테마와 가게가 잘 맞는 이유는 무엇인가요?",
                "이 테마와 어울리는 대표 메뉴(또는 서비스)는 무엇인가요?",
                "계절·날씨·상황과 잘 어울리는 부분은 무엇인가요?",
                "이 테마에서 손님들이 가장 좋아하는 점은 무엇인가요?",
                "테마와 관련된 특별 이벤트나 혜택이 있나요?",
                "테마와 어울리는 공간(분위기/인테리어)이 있다면 소개해주세요.",
                "손님들에게 이 테마를 꼭 추천하고 싶은 이유는 무엇인가요?",
                "사장님이 생각하는 ‘오늘의 테마’와 가게의 핵심 매력은 무엇인가요?"
            ];

            const randomQuestions = [
                "가게의 대표 메뉴(또는 서비스)는 무엇인가요?",
                "단골손님들이 가장 많이 찾는 이유는 무엇인가요?",
                "처음 방문하는 손님들에게 꼭 추천하고 싶은 것은 무엇인가요?",
                "가게 운영에 있어 가장 중요하게 생각하는 가치는 무엇인가요?",
                "우리 가게만의 특별한 서비스나 자랑거리는 무엇인가요?",
                "손님들에게 가장 많이 듣는 칭찬은 무엇인가요?",
                "앞으로 손님들에게 어떤 가게로 기억되고 싶으신가요?",
                "사장님이 생각하는 우리 가게의 가장 큰 매력은 무엇인가요?"
            ];

            const qaSection = document.getElementById("qaSection");
            const selfSubOptions = document.getElementById("selfSubOptions");
            const modeRadios = document.querySelectorAll("input[name='qa_mode']");

            function makeQaCards(list, type) {
                return list.map((q, i) => `
        <div class="border rounded-xl p-4 shadow bg-gray-50 mb-4">
          <label class="block font-bold mb-1">Q${i + 1}. ${q}</label>
          <textarea name="${type}_q${i + 1}_answer" rows="3" maxlength="300" class="w-full border rounded px-3 py-2 mb-2" placeholder="답변을 입력해주세요"></textarea>
          <label class="block font-bold mb-1">사진 (선택)</label>
          <input type="file" name="${type}_q${i + 1}_image" accept="image/*" class="border rounded px-3 py-2 w-full">
        </div>
      `).join('');
            }

            let customQaList = [{ question: "", answer: "" }];

            function renderCustomQa() {
                qaSection.innerHTML = customQaList.map((item, i) => `
        <div class="border rounded-xl p-4 shadow bg-gray-50 mb-4 relative">
          <label class="block font-bold mb-1">질문 ${i + 1}</label>
          <input type="text" name="custom_q${i + 1}_question" class="w-full border rounded px-3 py-2 mb-2" maxlength="100" placeholder="질문을 입력하세요" value="${item.question}">
          <label class="block font-bold mb-1">답변</label>
          <textarea name="custom_q${i + 1}_answer" rows="3" maxlength="500" class="w-full border rounded px-3 py-2 mb-2" placeholder="답변을 입력하세요">${item.answer}</textarea>
          <label class="block font-bold mb-1">사진 (선택)</label>
          <input type="file" name="custom_q${i + 1}_image" accept="image/*" class="border rounded px-3 py-2 w-full">
          ${i > 0 ? `<button type="button" onclick="removeCustomQa(${i})" class="absolute top-2 right-2 text-red-400 hover:text-red-600 text-2xl font-bold">×</button>` : ""}
        </div>
      `).join('') + `
        <div class="flex justify-center mt-4">
          <button type="button" onclick="addCustomQa()" class="bg-green-500 text-white px-4 py-2 rounded shadow hover:bg-green-600">+ 질문/답변 추가</button>
        </div>
      `;
            }

            window.addCustomQa = function () {
                if (customQaList.length >= 8) return alert("최대 8개까지만 작성할 수 있습니다!");
                customQaList.push({ question: "", answer: "" });
                renderCustomQa();
            };
            window.removeCustomQa = function (i) {
                customQaList.splice(i, 1);
                renderCustomQa();
            };

            function toggleSelfOptions(mode) {
                selfSubOptions.classList.toggle("hidden", mode !== "self");
            }

            function setMode(mode) {
                if (mode === "theme") {
                    qaSection.innerHTML = makeQaCards(themeQuestions, "theme");
                } else if (mode === "random") {
                    qaSection.innerHTML = makeQaCards(randomQuestions, "random");
                } else {
                    customQaList = [{ question: "", answer: "" }];
                    renderCustomQa();
                }
            }

            modeRadios.forEach(r => {
                r.addEventListener("change", (e) => {
                    const mode = e.target.value;
                    toggleSelfOptions(mode);
                    setMode(mode);
                });
            });

            // 초기 진입
            (function init() {
                const checked = document.querySelector("input[name='qa_mode']:checked");
                const initMode = checked ? checked.value : "theme";
                toggleSelfOptions(initMode);
                setMode(initMode);
            })();

            // 제출
            document.getElementById("blogForm").addEventListener("submit", async (e) => {
                e.preventDefault();
                const form = e.target;
                const formData = new FormData(form);

                const mode = formData.get("qa_mode");
                if (mode === "self") {
                    const selfTarget = formData.get("selfTarget");
                    formData.set("target", selfTarget);
                } else {
                    formData.set("target", mode);
                }

                // qa JSON을 클라이언트에서도 한 번 구성 (서버는 재검증/보정)
                let qa = [];
                if (mode === "theme" || mode === "random") {
                    const base = mode === "theme" ? themeQuestions : randomQuestions;
                    qa = base.map((q, i) => ({
                        q,
                        a: formData.get(`${mode}_q${i + 1}_answer`) || ""
                    }));
                } else {
                    // self는 DOM에서 그대로 읽음
                    qa = [];
                    for (let i = 1; i <= 8; i++) {
                        const q = formData.get(`custom_q${i}_question`);
                        const a = formData.get(`custom_q${i}_answer`);
                        if (!q && !a) continue;
                        qa.push({ q: q || "", a: a || "" });
                    }
                }
                formData.set("qa", JSON.stringify(qa));

                try {
                    // public2/hotblog.html 제출부
                    const res = await fetch("/api/hotblog/register", { method: "POST", body: formData });
                    const data = await res.json();
                    if (data.success) {
                        alert("등록 완료!");
                        location.href = `/hotblogdetail.html?id=${data.id}`;
                    } else {
                        alert(`등록 실패: ${data.error || "다시 시도해주세요"}${data.detail ? "\n\nDETAIL: " + data.detail : ""}`);
                    }


                } catch {
                    alert("서버 연결 실패");
                }

                function goBack() {
                    history.back();
                }

                function goHome() {
                    window.location.href = "/";
                }

                function goNext() {
                    // 다음 등록 페이지로 이동
                    if (window.location.pathname.includes("foodregister")) {
                        window.location.href = "/public2/ncombinedregister.html";
                    } else if (window.location.pathname.includes("ncombinedregister")) {
                        window.location.href = "/public2/hotblogregister.html";
                    } else {
                        window.location.href = "/public2/foodregister.html";
                    }
                }

                
            });
        </script>
</body>

</html>