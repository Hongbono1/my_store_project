<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ë‚´ ë™ë„¤ ì„¤ì •</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=6286d4d9bc1d503495b03f46622b5dc8&libraries=services"></script>
</head>

<body class="bg-gray-100">

<div id="header"></div>

<div class="max-w-2xl mx-auto bg-white mt-10 p-8 rounded-2xl shadow-lg">

<h1 class="text-3xl font-bold mb-6">ğŸ“ ë‚´ ë™ë„¤ ì„¤ì •</h1>

<div class="mb-6 p-4 bg-blue-50 rounded-lg">
  <p class="font-bold text-blue-900 mb-2">í˜„ì¬ ìœ„ì¹˜</p>
  <p id="currentLocation" class="text-gray-700">ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...</p>
  <p class="text-xs text-gray-500 mt-2">â€» í˜„ì¬ ìœ„ì¹˜ì—ì„œ 10km ì´ë‚´ ì§€ì—­ë§Œ ì„ íƒ ê°€ëŠ¥í•©ë‹ˆë‹¤</p>
</div>

<div class="mb-6">
  <label class="block font-bold mb-2">ë‚´ ë™ë„¤ ì„ íƒ</label>
  <select id="regionSelect" class="w-full border p-3 rounded-lg">
    <option value="">ì§€ì—­ì„ ì„ íƒí•˜ì„¸ìš”</option>
  </select>
  <p id="distanceInfo" class="text-sm text-gray-500 mt-2"></p>
</div>

<button onclick="saveMyRegion()" class="w-full px-4 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-bold">
  ë‚´ ë™ë„¤ë¡œ ì„¤ì •
</button>

<div class="mt-6 p-4 bg-gray-50 rounded-lg">
  <p class="font-bold text-gray-800 mb-2">í˜„ì¬ ì„¤ì •ëœ ë‚´ ë™ë„¤</p>
  <p id="savedRegion" class="text-2xl font-bold text-indigo-600">-</p>
</div>

</div>

<div id="footer"></div>

<script>
fetch('components/header.html').then(r => r.text()).then(h => header.innerHTML = h);
fetch('components/footer.html').then(r => r.text()).then(f => footer.innerHTML = f);

// ì§€ì—­ ì¢Œí‘œ ë°ì´í„°
const regionCoords = {
  'ì˜ì •ë¶€': { lat: 37.7381, lng: 127.0475 },
  'í˜¸ì›ë™': { lat: 37.7578, lng: 127.0475 },
  'ë¯¼ë½ë™': { lat: 37.7443, lng: 127.0647 },
  'ê°€ëŠ¥ë™': { lat: 37.7373, lng: 127.0819 },
  'ì˜ì •ë¶€1ë™': { lat: 37.7398, lng: 127.0335 },
  'ì˜ì •ë¶€2ë™': { lat: 37.7387, lng: 127.0475 },
  'ë…¹ì–‘ë™': { lat: 37.7525, lng: 127.0595 },
  'ì†¡ì‚°ë™': { lat: 37.7231, lng: 127.0335 },
};

let currentLat = null;
let currentLng = null;

// ê±°ë¦¬ ê³„ì‚° í•¨ìˆ˜
function getDistance(lat1, lng1, lat2, lng2) {
    const R = 6371e3;
    const toRad = deg => deg * Math.PI / 180;

    const Ï†1 = toRad(lat1);
    const Ï†2 = toRad(lat2);
    const Î”Ï† = toRad(lat2 - lat1);
    const Î”Î» = toRad(lng2 - lng1);

    const a =
        Math.sin(Î”Ï† / 2) ** 2 +
        Math.cos(Ï†1) * Math.cos(Ï†2) *
        Math.sin(Î”Î» / 2) ** 2;

    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

// í˜„ì¬ ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸°
async function getCurrentLocation() {
  return new Promise((resolve, reject) => {
    if (!navigator.geolocation) {
      reject(new Error('ë¸Œë¼ìš°ì €ê°€ ìœ„ì¹˜ ì„œë¹„ìŠ¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤'));
      return;
    }

    navigator.geolocation.getCurrentPosition(
      position => {
        currentLat = position.coords.latitude;
        currentLng = position.coords.longitude;
        resolve({ lat: currentLat, lng: currentLng });
      },
      error => {
        reject(error);
      }
    );
  });
}

// 10km ì´ë‚´ ì§€ì—­ë§Œ í‘œì‹œ
function loadAvailableRegions() {
  const regionSelect = document.getElementById('regionSelect');
  
  if (!currentLat || !currentLng) {
    regionSelect.innerHTML = '<option>ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</option>';
    return;
  }

  const availableRegions = Object.entries(regionCoords)
    .map(([name, coords]) => {
      const distance = getDistance(currentLat, currentLng, coords.lat, coords.lng);
      return { name, coords, distance };
    })
    .filter(region => region.distance <= 10000) // 10km ì´ë‚´
    .sort((a, b) => a.distance - b.distance); // ê°€ê¹Œìš´ ìˆœ ì •ë ¬

  if (availableRegions.length === 0) {
    regionSelect.innerHTML = '<option>10km ì´ë‚´ì— ë“±ë¡ ê°€ëŠ¥í•œ ì§€ì—­ì´ ì—†ìŠµë‹ˆë‹¤</option>';
    return;
  }

  regionSelect.innerHTML = '<option value="">ì§€ì—­ì„ ì„ íƒí•˜ì„¸ìš”</option>' +
    availableRegions.map(region => {
      const distanceKm = (region.distance / 1000).toFixed(1);
      return `<option value="${region.name}">${region.name} (${distanceKm}km)</option>`;
    }).join('');
}

// ì§€ì—­ ì„ íƒ ì‹œ ê±°ë¦¬ í‘œì‹œ
document.getElementById('regionSelect').addEventListener('change', function() {
  const selectedRegion = this.value;
  const distanceInfo = document.getElementById('distanceInfo');
  
  if (!selectedRegion) {
    distanceInfo.textContent = '';
    return;
  }

  const coords = regionCoords[selectedRegion];
  if (coords && currentLat && currentLng) {
    const distance = getDistance(currentLat, currentLng, coords.lat, coords.lng);
    const distanceKm = (distance / 1000).toFixed(1);
    distanceInfo.textContent = `í˜„ì¬ ìœ„ì¹˜ì—ì„œ ${distanceKm}km ë–¨ì–´ì ¸ ìˆìŠµë‹ˆë‹¤`;
  }
});

// ë‚´ ë™ë„¤ ì €ì¥
function saveMyRegion() {
  const selectedRegion = document.getElementById('regionSelect').value;
  
  if (!selectedRegion) {
    alert('ì§€ì—­ì„ ì„ íƒí•´ì£¼ì„¸ìš”');
    return;
  }

  localStorage.setItem('myRegion', selectedRegion);
  document.getElementById('savedRegion').textContent = selectedRegion;
  alert(`'${selectedRegion}'ì´(ê°€) ë‚´ ë™ë„¤ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤!`);
}

// ì´ˆê¸°í™”
async function init() {
  try {
    // ì €ì¥ëœ ë‚´ ë™ë„¤ í‘œì‹œ
    const savedRegion = localStorage.getItem('myRegion');
    if (savedRegion) {
      document.getElementById('savedRegion').textContent = savedRegion;
    }

    // í˜„ì¬ ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸°
    const location = await getCurrentLocation();
    document.getElementById('currentLocation').textContent = 
      `ìœ„ë„: ${location.lat.toFixed(4)}, ê²½ë„: ${location.lng.toFixed(4)}`;
    
    // 10km ì´ë‚´ ì§€ì—­ ë¡œë“œ
    loadAvailableRegions();

  } catch (error) {
    console.error('ìœ„ì¹˜ ì •ë³´ ì˜¤ë¥˜:', error);
    document.getElementById('currentLocation').textContent = 'ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤';
    alert('ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\në¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.');
  }
}

init();
</script>

</body>
</html>
