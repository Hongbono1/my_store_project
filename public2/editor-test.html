<!doctype html>
<html lang="ko">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>에디터 최소 테스트</title>
    <style>
        body {
            font-family: system-ui, -apple-system, Pretendard, Segoe UI, Roboto, 'Noto Sans KR', sans-serif;
            background: #f6f7fb;
            margin: 0;
            padding: 24px
        }

        .wrap {
            max-width: 900px;
            margin: 0 auto
        }

        .toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 10px;
            margin-bottom: 12px
        }

        .toolbar button,
        .toolbar select {
            background: #fff;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            padding: 8px 10px;
            cursor: pointer
        }

        .toolbar button.active {
            background: #e0e7ff;
            border-color: #6366f1
        }

        .chip {
            width: 22px;
            height: 22px;
            border-radius: 4px;
            border: 1px solid #aaa;
            cursor: pointer
        }

        #editor {
            min-height: 240px;
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 12px;
            line-height: 1.7;
            outline: none
        }
    </style>
</head>

<body>
    <div class="wrap">
        <!-- 툴바 -->
        <div id="toolbar" class="toolbar">
            <button type="button" data-act="bold"><b>굵게</b></button>
            <button type="button" data-act="italic"><i>기울임</i></button>
            <button type="button" data-act="underline"><u>밑줄</u></button>

            <span style="margin-left:8px">색상:</span>
            <button type="button" class="chip" data-color="#111" style="background:#111"></button>
            <button type="button" class="chip" data-color="#e11d48" style="background:#e11d48"></button>
            <button type="button" class="chip" data-color="#2563eb" style="background:#2563eb"></button>
            <button type="button" class="chip" data-color="#16a34a" style="background:#16a34a"></button>
            <button type="button" data-color="reset">기본</button>

            <span style="margin-left:8px">크기:</span>
            <select id="size">
                <option value="16px">16</option>
                <option value="18px">18</option>
                <option value="20px">20</option>
                <option value="24px">24</option>
                <option value="28px">28</option>
            </select>
        </div>

        <!-- 에디터 -->
        <div id="editor" contenteditable="true" spellcheck="false"></div>

        <!-- 출력 확인 -->
        <div style="margin-top:12px">
            <button id="dump" type="button">HTML 보기</button>
            <pre id="out"
                style="white-space:pre-wrap;background:#0b1020;color:#e6eaff;border-radius:8px;padding:10px;display:none"></pre>
        </div>
    </div>

    <script>
        (function () {
            'use strict';

            const editor = document.getElementById('editor');
            const toolbar = document.getElementById('toolbar');
            const sizeSel = document.getElementById('size');
            const dumpBtn = document.getElementById('dump');
            const out = document.getElementById('out');

            if (!editor || !toolbar) { alert('DOM 미로딩'); return; }

            // 현재 스타일 상태
            const state = { bold: false, italic: false, underline: false, color: '#111', size: '16px' };

            // 유틸
            const ZWSP = '\u200B', BOM = '\uFEFF';
            const sel = () => window.getSelection();
            const rng = () => document.createRange();

            function placeCaretAfter(node) {
                const s = sel(); if (!s) return;
                const r = rng(); r.setStartAfter(node); r.collapse(true);
                s.removeAllRanges(); s.addRange(r); editor.focus();
            }

            function ensureCaret() {
                const s = sel(); if (s && s.rangeCount) return;
                const r = rng(); r.selectNodeContents(editor); r.collapse(false);
                s.removeAllRanges(); s.addRange(r);
            }

            function insertMarker(id) {
                ensureCaret();
                const s = sel(), r = s.getRangeAt(0);
                const m = document.createElement('span');
                m.dataset.kmarker = id;
                m.style.display = 'inline-block'; m.style.width = '0'; m.style.height = '0';
                m.appendChild(document.createTextNode(BOM));
                r.insertNode(m);
                r.setStartAfter(m); r.collapse(true);
                s.removeAllRanges(); s.addRange(r);
                return m;
            }

            function wrapBetween() {
                const start = editor.querySelector('span[data-kmarker="s"]');
                const end = editor.querySelector('span[data-kmarker="e"]');
                if (!start || !end) return;

                const r = rng();
                r.setStartAfter(start);
                r.setEndBefore(end);
                const frag = r.extractContents();

                start.remove(); end.remove();

                // 빈 입력이면 처리하지 않음(예: 방향키)
                if (!frag || !frag.hasChildNodes()) return;

                const span = document.createElement('span');
                if (state.bold) span.style.fontWeight = '700';
                if (state.italic) span.style.fontStyle = 'italic';
                if (state.underline) span.style.textDecoration = 'underline';
                if (state.color) span.style.color = state.color;
                if (state.size) span.style.fontSize = state.size;

                // 제로폭 제거
                (function stripZWSP(n) {
                    if (n.nodeType === 3) { n.nodeValue = n.nodeValue.replace(/\u200B|\uFEFF/g, ''); return; }
                    n.childNodes && [...n.childNodes].forEach(stripZWSP);
                })(frag);

                span.appendChild(frag);
                // 뒤에 빈 텍스트 하나 두어 한글 조합 후 커서가 자연스럽게 이어지도록
                span.appendChild(document.createTextNode(''));
                // 삽입
                const s = sel(), r2 = rng();
                r2.selectNodeContents(editor); r2.collapse(false);
                s.removeAllRanges(); s.addRange(r2);
                editor.insertBefore(span, r2.endContainer.nextSibling);
                placeCaretAfter(span);
            }

            // 툴바 동작
            toolbar.addEventListener('mousedown', (e) => {
                const t = e.target;
                if (!t) return;
                if (t.tagName === 'BUTTON' || t.tagName === 'SELECT') {
                    e.preventDefault(); editor.focus();
                }
            });

            toolbar.addEventListener('click', (e) => {
                const t = e.target;
                if (!t) return;
                const act = t.getAttribute('data-act');
                const color = t.getAttribute('data-color');

                if (act) {
                    state[act] = !state[act];
                    t.classList.toggle('active', state[act]);
                    editor.focus();
                    return;
                }
                if (color) {
                    state.color = (color === 'reset') ? '#111' : color;
                    // 칩 하이라이트
                    toolbar.querySelectorAll('.chip').forEach(c => c.style.outline = 'none');
                    if (t.classList.contains('chip')) t.style.outline = '2px solid #6366f1';
                    editor.focus();
                    return;
                }
            });

            sizeSel.addEventListener('change', () => {
                state.size = sizeSel.value || '16px';
                editor.focus();
            });

            // 핵심: 입력 전/후 마커-래핑
            editor.addEventListener('beforeinput', (e) => {
                // 삭제 관련은 건너뜀(스타일 래핑 불필요)
                if (e.inputType && e.inputType.startsWith('delete')) return;
                insertMarker('s');
            });

            editor.addEventListener('input', () => {
                insertMarker('e');
                wrapBetween();
            });

            // (선택 적용: 선택 영역 있을 때 버튼 누르면 즉시 래핑)
            toolbar.addEventListener('click', (e) => {
                const t = e.target;
                if (!t) return;
                const s = sel();
                if (!s || s.rangeCount === 0) return;
                if (s.isCollapsed) return; // 선택 없으면 평소 로직(타이핑시 적용)

                // 선택이 있을 때는 즉시 스타일 적용
                const r = s.getRangeAt(0);
                const span = document.createElement('span');
                if (state.bold) span.style.fontWeight = '700';
                if (state.italic) span.style.fontStyle = 'italic';
                if (state.underline) span.style.textDecoration = 'underline';
                if (state.color) span.style.color = state.color;
                if (state.size) span.style.fontSize = state.size;

                try { r.surroundContents(span); }
                catch {
                    const frag = r.extractContents();
                    span.appendChild(frag);
                    r.insertNode(span);
                }
                s.removeAllRanges();
                const r2 = rng(); r2.setStartAfter(span); r2.collapse(true);
                s.addRange(r2);
            });

            // 디버그: HTML 보기
            dumpBtn.addEventListener('click', () => {
                out.style.display = 'block';
                out.textContent = editor.innerHTML.replace(/\u200B|\uFEFF/g, '');
            });

        })();
    </script>
</body>

</html>