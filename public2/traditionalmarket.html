<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ìš°ë¦¬ë™ë„¤ ì „í†µì‹œì¥</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gradient-to-r from-blue-50 to-blue-100">
  <!-- í—¤ë” (ì™¸ë¶€ íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°) -->
  <div id="header"></div>

  <!-- ë©”ì¸ ì»¨í…ì¸  -->
  <main class="max-w-7xl mx-auto px-4 py-12">
    <!-- ë©”ì¸ ì†Œê°œ ì„¹ì…˜ -->
    <section class="flex flex-col items-center md:items-start text-center md:text-left">
      <div class="md:w-full flex flex-col">
        <h2 class="text-5xl font-bold text-gray-900 leading-tight tracking-wide">
          ì „í†µì„ í’ˆì€ ì‹œì¥, <span class="text-blue-600">ê·¸ ê°€ì¹˜ë¥¼ ì‡ë‹¤</span>
        </h2>
        <p class="text-xl text-gray-700 mt-3">
          ì˜¤ëœ ì—­ì‚¬ë¥¼ ìë‘í•˜ëŠ” ì „í†µì‹œì¥ì—ì„œ í˜„ëŒ€ì˜ ê°ê°ì„ ë”í•´, íŠ¹ë³„í•œ ê²½í—˜ì„ ì„ ì‚¬í•©ë‹ˆë‹¤.
        </p>
      </div>
    </section>

    <!-- ì „í†µì‹œì¥ ì„¹ì…˜ -->
    <section class="mt-16 bg-white shadow-2xl p-8 rounded-2xl border-2 border-gray-400">
      <div class="flex items-center justify-between mb-8">
        <h3 class="text-3xl font-bold text-gray-900 text-center tracking-wider">
          ìš°ë¦¬ë™ë„¤ <span class="text-indigo-600">ì „í†µì‹œì¥</span>
        </h3>
        <!-- ë“±ë¡í•˜ê¸° ë²„íŠ¼ -->
        <a href="/traditionalmarketregister.html"
          class="ml-2 bg-gradient-to-r from-blue-500 to-indigo-500 text-white font-semibold py-2 px-6 rounded-full shadow hover:scale-105 hover:bg-blue-600 transition-all whitespace-nowrap">
          ë“±ë¡í•˜ê¸°
        </a>
      </div>
      <!-- ì „í†µì‹œì¥ ì¹´ë“œë“¤ì´ ë“¤ì–´ê°ˆ ì˜ì—­ -->
      <div id="market-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-2 lg:grid-cols-2 gap-8"></div>
      <!-- ë” ë³´ê¸° ë²„íŠ¼ -->
      <div class="text-center mt-8">
        <button id="loadMoreBtn"
          class="bg-gradient-to-r from-blue-500 to-indigo-500 text-white text-lg font-semibold py-3 px-8 rounded-full shadow-md hover:scale-105 transition-all">
          ë” ë³´ê¸°
        </button>
      </div>
    </section>

  </main>

  <!-- í‘¸í„° (ì™¸ë¶€ íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°) -->
  <div id="footer"></div>

  <!-- JavaScript -->
  <script>
    // í—¤ë” & í‘¸í„° ë¡œë“œ (SSR)
    fetch('components/header.html')
      .then(response => response.text())
      .then(data => { document.getElementById('header').innerHTML = data; })
      .catch(error => console.error('í—¤ë” ë¡œë”© ì‹¤íŒ¨:', error));

    fetch('components/footer.html')
      .then(response => response.text())
      .then(data => { document.getElementById('footer').innerHTML = data; })
      .catch(error => console.error('í‘¸í„° ë¡œë”© ì‹¤íŒ¨:', error));

    // ì‹¤ì œ ì„œë²„ ë°ì´í„°ë¡œ ì¹´ë“œ ë Œë”
    let traditionalMarkets = [];
    let currentIndex = 4; // ìµœì´ˆ 4ê°œë§Œ ë³´ì—¬ì¤Œ

    // ì„œë²„ì—ì„œ ì‹œì¥ ë¦¬ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸° (GET /api/market)
    async function fetchMarkets() {
      try {
        const res = await fetch('/api/market');
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}`);
        }
        const data = await res.json();

        console.log("ğŸ” ì„œë²„ì—ì„œ ë°›ì€ ì›ë³¸ ë°ì´í„°:", data); // ë””ë²„ê¹…ìš©

        // DBì˜ ì»¬ëŸ¼ëª…ì— ë§ê²Œ ê°€ê³µ
        traditionalMarkets = data.map((m) => {
          console.log("ğŸ” main_img ì›ë³¸ê°’:", m.main_img); // ë””ë²„ê¹…ìš©

          // ê¸°ë³¸ê°’: ê¸°ë³¸ ì´ë¯¸ì§€
          let imgPath = "/uploads/traditionalmarket/default.jpg";

          if (m.main_img) {
            let raw = String(m.main_img).trim();

            // 1) ì ˆëŒ€ URL(https://...)ì´ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©
            if (raw.startsWith("http://") || raw.startsWith("https://")) {
              imgPath = raw;
            }
            // 2) ì´ë¯¸ /uploads ë¡œ ì‹œì‘í•˜ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš© (ì¤‘ë³µ ë°©ì§€)
            else if (raw.startsWith("/uploads")) {
              imgPath = raw;
            }
            // 3) /uploads/traditionalmarket/ ë¡œ ì‹œì‘í•˜ë©´ ê·¸ëŒ€ë¡œ (ì´ì¤‘ ì²´í¬)
            else if (raw.includes("/uploads/traditionalmarket/")) {
              imgPath = raw;
            }
            // 4) ê·¸ ì™¸(íŒŒì¼ëª…ë§Œ ìˆëŠ” ê²½ìš°) â†’ /uploads/traditionalmarket/ ë¶™ì´ê¸°
            else {
              imgPath = `/uploads/traditionalmarket/${raw}`;
            }
          }

          console.log("ğŸ” ìµœì¢… ì´ë¯¸ì§€ ê²½ë¡œ:", imgPath); // ë””ë²„ê¹…ìš©

          return {
            id: m.id,
            name: m.market_name,
            address: m.address,
            phone: m.phone || "",
            img: imgPath,
            event: m.event_info || "",
            accessibility: m.facilities || "",
            parking: m.parking_available || ""
          };
        });

        renderTraditionalMarkets(currentIndex);
      } catch (e) {
        console.error("ì‹œì¥ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜:", e);
        alert("ì‹œì¥ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
      }
    }

    function renderTraditionalMarkets(limit) {
      const container = document.getElementById("market-container");
      container.innerHTML = "";
      traditionalMarkets.slice(0, limit).forEach((market) => {
        const card = document.createElement("div");
        card.className =
          "bg-gradient-to-br from-white to-gray-100 border-2 border-gray-400 shadow-xl rounded-xl overflow-hidden p-6 transform transition-all hover:scale-105 hover:shadow-2xl";
        card.innerHTML = `
      <img class="h-48 w-full object-cover rounded-lg" src="${market.img}" alt="${market.name}">
      <div class="mt-4 text-center">
        <h4 class="text-2xl font-bold text-gray-900">${market.name}</h4>
        <p class="text-gray-700 mt-2">${market.address}</p>
        <p class="text-gray-500 mt-1 font-semibold">â˜ ${market.phone}</p>
        <a href="/traditionalmarketdetail.html?id=${market.id}" class="mt-4 inline-block bg-gradient-to-r from-blue-500 to-indigo-500 text-white py-2 px-5 rounded-lg shadow-md hover:scale-105 transition">
          ìì„¸íˆ ë³´ê¸°
        </a>
      </div>
    `;
        container.appendChild(card);
      });

      // ëª¨ë“  ë°ì´í„°ê°€ ë Œë”ë§ë˜ë©´ "ë” ë³´ê¸°" ë²„íŠ¼ ìˆ¨ê¸°ê¸°
      if (limit >= traditionalMarkets.length) {
        document.getElementById("loadMoreBtn").style.display = "none";
      } else {
        document.getElementById("loadMoreBtn").style.display = "";
      }
    }

    // ì´ˆê¸° ë Œë”ë§
    document.addEventListener("DOMContentLoaded", fetchMarkets);

    // "ë” ë³´ê¸°" ë²„íŠ¼ ì´ë²¤íŠ¸
    document.getElementById("loadMoreBtn").addEventListener("click", () => {
      currentIndex += 2;
      renderTraditionalMarkets(currentIndex);
    });


  </script>
</body>

</html>