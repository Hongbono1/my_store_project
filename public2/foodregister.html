<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>음식점 정보 등록</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Daum 우편번호 -->
    <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

    <style>
        /* 네오모피즘+글래스+3D 효과 박스 (ncombinedregister 기준) */
        .neo-glass-3d {
            background: rgba(255, 255, 255, 0.85);
            border-radius: 2rem;
            box-shadow:
                8px 8px 32px #e5e8f0,
                -8px -8px 32px #fff,
                0 4px 32px 0 rgba(80, 130, 255, .07);
            backdrop-filter: blur(18px) saturate(120%);
            -webkit-backdrop-filter: blur(18px) saturate(120%);
            border: 1.5px solid rgba(180, 200, 255, .10);
            transition: box-shadow .23s, border-color .2s;
        }

        .neo-glass-3d:focus-within,
        .neo-glass-3d:hover {
            box-shadow:
                4px 4px 18px #dae3f6,
                -4px -4px 18px #fff,
                0 8px 48px 0 rgba(80, 130, 255, .10);
            border-color: #60a5fa55;
        }

        /* 3D 버튼 (ncombinedregister 기준) */
        .btn-3d {
            background: linear-gradient(90deg, #6dd5fa 0%, #2980b9 100%);
            box-shadow: 0 4px 0 #2393b3, 0 8px 18px rgba(0, 64, 128, .14);
            color: #fff;
            font-weight: 700;
            border-radius: 1.3rem;
            padding: .75rem 2.5rem;
            font-size: 1.1rem;
            border: none;
            outline: none;
            transition: all .15s cubic-bezier(.21, .82, .69, .98);
        }

        .btn-3d:active {
            box-shadow: 0 1.5px 0 #2393b3, 0 2px 6px rgba(0, 64, 128, .16);
            transform: translateY(2px) scale(.98);
        }

        /* 입체 입력 (ncombinedregister 기준) */
        .input-neo {
            background: #f6f9fd;
            border-radius: .8rem;
            box-shadow: 1.5px 1.5px 6px #e4e9f2, -1.5px -1.5px 6px #ffffff;
            border: 1px solid #d3e4f7;
            transition: box-shadow .14s, border-color .13s;
            font-size: 1.06rem;
        }

        .input-neo:focus {
            border-color: #60a5fa;
            box-shadow: 0 0 0 1.5px #60a5fa44, 1.5px 1.5px 6px #e4e9f2, -1.5px -1.5px 6px #ffffff;
            outline: none;
        }

        /* 섹션 타이틀 (ncombinedregister 기준) */
        .section-label {
            background: linear-gradient(90deg, #bae6fd 0%, #f0f7ff 100%);
            color: #2b445c;
            box-shadow: 0 2px 12px 2px #f3f9ff, 0 0px 0 #bae6fd;
            border-radius: 1.2rem 1.2rem 0 0;
            padding: 1.1rem 2.2rem .9rem 2.2rem;
            font-size: 1.16rem;
            font-weight: 800;
            letter-spacing: .05em;
            border-bottom: 2px solid #cde3fa;
            margin-bottom: 2.1rem;
            text-shadow: 0 1.5px 0 #b2e4ff38;
        }
    </style>
</head>

<body class="bg-white flex flex-col min-h-screen">
    <!-- 헤더 -->
    <div id="header-placeholder"></div>

    <!-- 메인 -->
    <main class="flex-grow container mx-auto px-2 py-8">
        <div class="neo-glass-3d max-w-2xl mx-auto p-5 sm:p-8">
            <h2 class="text-3xl font-bold text-center mb-8 drop-shadow">음식점 정보 등록</h2>

            <form id="businessForm" class="space-y-7" enctype="multipart/form-data" autocomplete="off">
                <input type="hidden" id="storeId" name="storeId" />
                <input type="hidden" id="deliveryOption" name="deliveryOption" value="불가능" />

                <!-- 1) 사업자 등록 인증 -->
                <section class="rounded-2xl p-5 bg-yellow-50/80 mb-5 shadow-inner">
                    <div class="section-label">사업자 등록 인증</div>

                    <div class="flex flex-col md:flex-row gap-4">
                        <label class="w-36 font-medium flex items-center justify-center">사업자 번호</label>
                        <div class="flex flex-nowrap items-center gap-2 w-full">
                            <input id="bizNumber1" maxlength="4" class="w-[90px] input-neo px-2 py-2" placeholder="123"
                                inputmode="numeric">
                            <span>-</span>
                            <input id="bizNumber2" maxlength="2" class="w-[60px] input-neo px-2 py-2" placeholder="45"
                                inputmode="numeric">
                            <span>-</span>
                            <input id="bizNumber3" maxlength="5" class="w-[100px] input-neo px-2 py-2"
                                placeholder="67890" inputmode="numeric">
                            <button type="button" class="btn-3d ml-2" onclick="verifyBizNumber()">인증</button>
                        </div>
                    </div>

                    <div class="flex flex-col md:flex-row md:items-center gap-2 mt-3">
                        <label class="w-32 font-medium shrink-0" for="businessCertImage">등록증 이미지</label>
                        <input type="file" id="businessCertImage" name="businessCertImage"
                            accept="image/*,application/pdf" class="flex-1 input-neo px-3 py-2">
                    </div>

                    <p class="text-sm text-center mt-2">*사업자 등록증은 <span class="text-red-600">3개월 이내</span> 발급분만 인정</p>
                    <p id="bizVerifyResult" class="text-sm text-center"></p>
                </section>

                <!-- 2) 대표 정보 -->
                <section class="rounded-2xl p-5 bg-indigo-50/80 mb-5 shadow-inner">
                    <div class="section-label">대표 정보</div>

                    <div class="flex flex-col md:flex-row md:items-center gap-2 mb-3">
                        <label class="w-32 font-medium" for="ownerName">성함</label>
                        <input id="ownerName" name="ownerName" class="flex-1 input-neo px-3 py-2" required>
                    </div>

                    <div class="flex flex-col md:flex-row md:items-center gap-2 mb-3">
                        <label class="w-32 font-medium" for="birthDate">생년월일</label>
                        <input type="date" id="birthDate" name="birthDate" class="flex-1 input-neo px-3 py-2">
                    </div>

                    <!-- 이메일 -->
                    <div class="flex flex-col md:flex-row md:items-center gap-2 mb-3">
                        <label class="w-32 font-medium" for="emailId">이메일</label>
                        <div class="flex flex-wrap items-center gap-2 flex-1 min-w-0">
                            <input id="emailId" placeholder="아이디" oninput="updateEmail()"
                                class="flex-1 min-w-0 input-neo px-3 py-2">
                            <span>@</span>
                            <select id="emailDomainSelect" onchange="handleDomainChange(this)"
                                class="flex-1 min-w-0 input-neo px-3 py-2">
                                <option value="">선택</option>
                                <option value="naver.com">naver.com</option>
                                <option value="gmail.com">gmail.com</option>
                                <option value="daum.net">daum.net</option>
                                <option value="custom">직접입력</option>
                            </select>
                            <input id="customDomainInput" placeholder="도메인" oninput="updateEmail()"
                                class="hidden flex-1 min-w-0 input-neo px-3 py-2">
                        </div>
                        <input type="hidden" id="ownerEmail" name="ownerEmail">
                    </div>

                    <!-- 주소 + 상세주소 -->
                    <div class="flex flex-col md:flex-row md:items-center gap-2 mb-3">
                        <label class="w-32 font-medium" for="ownerAddress">주소</label>
                        <div class="flex flex-1 gap-2">
                            <input id="ownerAddress" name="ownerAddress" class="flex-1 input-neo px-3 py-2" readonly>
                            <button type="button" class="btn-3d min-w-[120px]" onclick="searchAddress()">주소 검색</button>
                        </div>
                    </div>
                    <div class="flex flex-col md:flex-row md:items-center gap-2 mb-3">
                        <label class="w-32 font-medium" for="ownerAddressDetail">상세 주소</label>
                        <input id="ownerAddressDetail" name="ownerAddressDetail" class="flex-1 input-neo px-3 py-2"
                            placeholder="동·호수 / 건물명 등">
                    </div>

                    <!-- 휴대폰 인증(더미) -->
                    <div class="flex flex-col md:flex-row md:items-center gap-2 mb-3">
                        <label class="w-32 font-medium" for="ownerPhone">휴대폰</label>
                        <input id="ownerPhone" name="ownerPhone" class="flex-1 input-neo px-3 py-2" required>
                        <button type="button" id="verifyPhoneButton" class="btn-3d min-w-[120px] w-auto">인증번호
                            요청</button>
                    </div>
                    <div class="flex flex-col md:flex-row gap-2 mt-2">
                        <label class="w-32 font-medium" for="phoneAuth">인증번호</label>
                        <input id="phoneAuth" class="flex-1 input-neo px-3 py-2">
                    </div>
                    <p id="phoneVerifyResult" class="text-sm text-center"></p>
                </section>

                <!-- 3) 업종/카테고리 (식당 전용) -->
                <section class="rounded-2xl p-5 bg-gray-50/90 mb-5 shadow-inner">
                    <div class="section-label">업종(카테고리) 선택</div>

                    <div class="flex flex-col md:flex-row gap-2 mb-2">
                        <label class="w-32 font-medium">카테고리</label>
                        <input id="mainCategory" name="mainCategory" class="flex-1 input-neo px-3 py-2 bg-gray-100"
                            value="식당" readonly>
                    </div>

                    <div class="flex flex-col md:flex-row gap-2">
                        <label class="w-32 font-medium">서브카테고리</label>
                        <select id="subCategory" name="subCategory" class="flex-1 input-neo px-3 py-2"
                            required></select>
                    </div>
                </section>

                <!-- 4) 기본 정보 -->
                <section class="rounded-2xl p-5 bg-white/90 mb-5 shadow-inner">
                    <div class="section-label">기본 정보</div>

                    <div class="flex flex-col md:flex-row md:items-center gap-2 mb-3">
                        <label class="w-32 font-medium" for="businessName">상호</label>
                        <input id="businessName" name="businessName" class="flex-1 input-neo px-3 py-2" required>
                    </div>

                    <div class="flex flex-col md:flex-row md:items-center gap-2 mb-3">
                        <label class="w-32 font-medium" for="businessHours">영업시간</label>
                        <input id="businessHours" name="businessHours" class="flex-1 input-neo px-3 py-2"
                            placeholder="예: 11:00 ~ 22:00 (브레이크 15:00~17:00)">
                    </div>
                </section>

                <!-- 5) 서비스/이벤트/기타 -->
                <section class="rounded-2xl p-5 bg-white/90 mb-5 shadow-inner">
                    <div class="section-label">서비스 내용</div>
                    <textarea id="serviceDetails" name="serviceDetails" class="input-neo w-full min-h-[90px] px-3 py-2"
                        placeholder="대표 메뉴, 예약/포장/배달 안내 등"></textarea>
                </section>

                <section class="rounded-2xl p-5 bg-white/90 mb-5 shadow-inner">
                    <div class="section-label">고객 이벤트</div>
                    <div class="flex flex-col gap-3">
                        <input id="event1" name="event1" class="input-neo px-3 py-2"
                            placeholder="이벤트 내용 1 (예: 점심세트 10% 할인)">
                        <input id="event2" name="event2" class="input-neo px-3 py-2" placeholder="이벤트 내용 2 (예: 디저트 무료)">
                    </div>
                </section>

                <section class="rounded-2xl p-5 bg-white/90 mb-5 shadow-inner">
                    <div class="section-label">기타 정보</div>
                    <div class="flex flex-col gap-3">
                        <input id="facility" name="facility" class="input-neo px-3 py-2"
                            placeholder="장애인 편의시설 (예: 있음/없음)">
                        <input id="pets" name="pets" class="input-neo px-3 py-2" placeholder="반려동물 출입 (예: 가능/불가능)">
                        <input id="parking" name="parking" class="input-neo px-3 py-2" placeholder="주차 정보 (예: 전용/유료)">
                    </div>
                </section>

                <!-- 6) 연락처/링크 -->
                <section class="rounded-2xl p-5 bg-white/90 mb-5 shadow-inner">
                    <div class="section-label">연락처</div>
                    <div class="flex flex-col gap-3">
                        <input id="phoneNumber" name="phoneNumber" class="input-neo px-3 py-2"
                            placeholder="대표전화 (예: 02-123-4567)">
                        <input id="homepage" name="homepage" class="input-neo px-3 py-2" placeholder="홈페이지 (URL)">
                        <input id="instagram" name="instagram" class="input-neo px-3 py-2" placeholder="Instagram URL">
                        <input id="facebook" name="facebook" class="input-neo px-3 py-2" placeholder="Facebook URL">
                    </div>
                </section>

                <!-- 7) 대표 이미지 (최대 3장) -->
                <section class="rounded-2xl p-5 bg-white/90 mb-5 shadow-inner">
                    <div class="section-label">이미지 등록 (최대 3장)</div>
                    <input type="file" id="imagesInput" name="images[]" multiple accept="image/*"
                        class="input-neo px-3 py-2 w-full mb-3">
                    <div id="imagesPreview" class="flex gap-3"></div>
                </section>

                <!-- 등록 버튼 -->
                <div class="text-center space-x-4 mt-8">
                    <button type="submit" class="btn-3d">입력 완료</button>
                </div>
            </form>
        </div>
    </main>

    <!-- 푸터 -->
    <div id="footer-placeholder"></div>

    <script>
        /* =============================
           헤더/푸터 (public2는 /new 경로)
        ==============================*/
        fetch("/new/components/header.html").then(r => r.text()).then(t => { document.getElementById("header-placeholder").innerHTML = t; });
        fetch("/new/components/footer.html").then(r => r.text()).then(t => { document.getElementById("footer-placeholder").innerHTML = t; });

        /* =============================
           이메일 유틸 (ncombinedregister 스타일)
        ==============================*/
        function updateEmail() {
            const id = document.getElementById('emailId').value.trim();
            const sel = document.getElementById('emailDomainSelect').value;
            const custom = document.getElementById('customDomainInput').value.trim();
            const domain = (sel === 'custom') ? custom : sel;
            document.getElementById('ownerEmail').value = (id && domain) ? `${id}@${domain}` : '';
        }
        function handleDomainChange(el) {
            const custom = document.getElementById('customDomainInput');
            if (el.value === 'custom') { custom.classList.remove('hidden'); custom.focus(); }
            else { custom.classList.add('hidden'); updateEmail(); }
        }

        /* =============================
           주소 검색 (Daum Postcode)
        ==============================*/
        function searchAddress() {
            new daum.Postcode({
                oncomplete: function (data) {
                    var fullAddr = data.roadAddress ? data.roadAddress : data.jibunAddress;
                    document.getElementById('ownerAddress').value = fullAddr;
                    document.getElementById('ownerAddressDetail').focus();
                }
            }).open();
        }

        /* =============================
           서브카테고리(식당 전용)
        ==============================*/
        const foodSubcats = ["한식", "중식", "양식", "일식", "분식", "치킨", "피자", "족발/보쌈", "야식", "디저트", "패스트푸드", "카페", "기타"];
        const subSel = document.getElementById('subCategory');
        subSel.innerHTML = '<option value="">서브카테고리 선택</option>' + foodSubcats.map(s => `<option value="${s}">${s}</option>`).join('');

        /* =============================
           이미지 미리보기 (최대 3장)
        ==============================*/
        const imagesInput = document.getElementById('imagesInput');
        const imagesPreview = document.getElementById('imagesPreview');
        if (imagesInput && imagesPreview) {
            imagesInput.addEventListener('change', () => {
                imagesPreview.innerHTML = '';
                const files = Array.from(imagesInput.files || []).slice(0, 3);
                files.forEach(f => {
                    const url = URL.createObjectURL(f);
                    const img = document.createElement('img');
                    img.src = url; img.alt = 'preview';
                    img.className = 'w-28 h-28 object-cover rounded-xl shadow';
                    imagesPreview.appendChild(img);
                });
            });
        }

        /* =============================
           사업자번호 인증 (/verify-biz 연동)
        ==============================*/
        async function verifyBizNumber() {
            const b1 = document.getElementById('bizNumber1').value.trim();
            const b2 = document.getElementById('bizNumber2').value.trim();
            const b3 = document.getElementById('bizNumber3').value.trim();
            const biz = `${b1}${b2}${b3}`;
            const out = document.getElementById('bizVerifyResult');

            if (!/^\d{10}$/.test(biz)) {
                out.textContent = '올바른 사업자번호를 입력하세요 (총 10자리 숫자)';
                out.className = 'text-sm text-red-600 text-center';
                return;
            }

            out.textContent = '인증 중...';
            out.className = 'text-sm text-gray-600 text-center';

            try {
                const r = await fetch('/verify-biz', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ b_no: [biz] })
                });
                const d = await r.json();
                const info = d?.data?.[0];
                if (info && info.b_stt_cd === '01') {
                    out.textContent = '✅ 인증 완료(계속사업자)';
                    out.className = 'text-sm text-green-600 text-center';
                    if (info.b_nm) { document.getElementById('businessName').value = info.b_nm; }
                } else {
                    out.textContent = '❌ 등록되지 않았거나 폐업된 사업자입니다.';
                    out.className = 'text-sm text-red-600 text-center';
                }
            } catch (e) {
                out.textContent = '서버 오류로 인증에 실패했습니다.';
                out.className = 'text-sm text-red-600 text-center';
            }
        }

        /* =============================
           휴대폰 인증 (더미)
        ==============================*/
        document.getElementById('verifyPhoneButton').addEventListener('click', () => {
            const phone = document.getElementById('ownerPhone').value.trim();
            const resEl = document.getElementById('phoneVerifyResult');
            if (!phone) {
                resEl.textContent = '휴대폰 번호를 입력하세요.';
                resEl.className = 'text-sm text-red-600 text-center';
                return;
            }
            resEl.textContent = '인증번호가 발송되었습니다. (예: 123456)';
            resEl.className = 'text-sm text-green-600 text-center';
        });
        document.getElementById('phoneAuth').addEventListener('blur', function () {
            const code = this.value.trim();
            const resEl = document.getElementById('phoneVerifyResult');
            if (code === '123456') {
                resEl.textContent = '휴대전화 인증 성공!';
                resEl.className = 'text-sm text-green-600 text-center';
            } else if (code) {
                resEl.textContent = '인증번호가 일치하지 않습니다.';
                resEl.className = 'text-sm text-red-600 text-center';
            } else {
                resEl.textContent = '';
                resEl.className = 'text-sm text-center';
            }
        });

        /* =============================
           폼 제출 → /store 저장 → N디테일 이동
        ==============================*/
        document.getElementById('businessForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                // 필수값 간단 체크 (ncombined 스타일 유지)
                const requiredIds = ['ownerName', 'ownerPhone', 'businessName', 'subCategory'];
                for (const id of requiredIds) {
                    const v = document.getElementById(id)?.value?.trim();
                    if (!v) { alert('필수 정보를 모두 입력하세요.'); return; }
                }

                const fd = new FormData(e.target);

                // 사업자번호 합쳐 넣기(서버에서 쓰면)
                const b1 = document.getElementById('bizNumber1').value.trim();
                const b2 = document.getElementById('bizNumber2').value.trim();
                const b3 = document.getElementById('bizNumber3').value.trim();
                if (b1 || b2 || b3) { fd.set('bizNumber', `${b1}-${b2}-${b3}`); }

                // 이메일 최종 반영
                const emailHidden = document.getElementById('ownerEmail').value;
                if (!emailHidden) {
                    // 비워져 있으면 즉시 갱신
                    const id = document.getElementById('emailId').value.trim();
                    const sel = document.getElementById('emailDomainSelect').value;
                    const custom = document.getElementById('customDomainInput').value.trim();
                    const domain = (sel === 'custom') ? custom : sel;
                    if (id && domain) fd.set('ownerEmail', `${id}@${domain}`);
                }

                // 파일들(FormData로 자동 수집) + businessCertImage 포함

                const res = await fetch('/store', { method: 'POST', body: fd });
                if (!res.ok) throw new Error('서버 오류');

                const data = await res.json();
                const newId = data?.id || data?.storeId;
                if (!newId) throw new Error('ID 응답 누락');

                location.href = `/ndetail.html?id=${encodeURIComponent(newId)}`;
            } catch (err) {
                console.error(err);
                alert('저장 중 오류가 발생했습니다.');
            }
        });
    </script>
</body>

</html>